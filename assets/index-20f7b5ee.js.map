{"version":3,"file":"index-20f7b5ee.js","sources":["../../src/utils/path.ts","../../src/utils/index.ts","../../src/store/id.ts","../../src/utils/lps.ts","../../src/store/tools/types.ts","../../src/types/layout.ts","../../src/io/state-file/schema.ts","../../src/io/import/dataSource.ts","../../src/store/datasets-files.ts","../../src/io/state-file/utils.ts","../../src/store/datasets-images.ts","../../src/store/datasets-dicom.ts","../../src/store/datasets-models.ts","../../src/store/messages.ts","../../src/composables/useErrorMessage.ts","../../src/store/datasets.ts","../../src/utils/loggers.ts","../../src/core/pipeline.ts","../../src/io/import/processors/handleDicomFile.ts","../../src/utils/fetch.ts","../../src/io/import/processors/downloadUrl.ts","../../src/io/zip.ts","../../src/io/mimeTypes.ts","../../src/io/import/common.ts","../../src/io/import/processors/extractArchive.ts","../../src/io/import/processors/extractArchiveTarget.ts","../../src/io/amazonS3.ts","../../src/io/import/processors/handleAmazonS3.ts","../../src/io/googleCloudStorage.ts","../../src/io/import/processors/handleGoogleCloudStorage.ts","../../src/io/magic.ts","../../src/io/io.ts","../../src/io/index.ts","../../src/io/import/processors/importSingleFile.ts","../../src/io/manifest.ts","../../src/io/import/processors/remoteManifest.ts","../../src/vtk/LabelMap/index.js","../../src/assets/samples/MRI-Cardiac.jpg","../../src/config.ts","../../src/utils/promise-worker.ts","../../src/io/vtk/async.ts","../../src/store/datasets-labelmaps.ts","../../src/io/resample/itkWasmUtils.js","../../src/io/resample/resample.ts","../../src/store/datasets-layers.ts","../../src/composables/useCurrentImage.ts","../../src/store/tools/crop.ts","../../src/vtk/CrosshairsWidget/state.ts","../../src/vtk/CrosshairsWidget/behavior.ts","../../src/vtk/CrosshairsWidget/index.js","../../src/utils/doubleKeyRecord.ts","../../src/store/view-configs/common.ts","../../src/store/view-configs/slicing.ts","../../src/store/view-configs/windowing.ts","../../src/utils/vtk-helpers.ts","../../src/vtk/ColorMaps.ts","../../src/store/view-configs/layers.ts","../../src/store/view-configs/camera.ts","../../src/store/view-configs/volume-coloring.ts","../../src/store/view-configs.ts","../../src/store/views.ts","../../src/store/tools/crosshairs.ts","../../src/store/tools/paint.ts","../../src/utils/frameOfReference.ts","../../src/store/tools/useLabels.ts","../../src/store/tools/useAnnotationTool.ts","../../src/store/tools/rulers.ts","../../src/store/tools/rectangles.ts","../../src/core/contours/referencePlane.ts","../../src/store/tools/contours.ts","../../src/store/tools/index.ts","../../src/io/state-file/index.ts","../../src/io/import/processors/doneWithDataSource.ts","../../src/io/import/processors/updateFileMimeType.ts","../../src/io/import/processors/restoreStateFile.ts","../../src/io/import/processors/handleConfig.ts","../../src/io/import/importDataSources.ts","../../src/components/ToolButton.vue","../../src/composables/manageVTKSubscription.ts","../../src/composables/useResizeToFit.ts","../../src/components/SliceSlider.vue","../../src/components/ViewOverlayGrid.vue","../../src/composables/useResizeObserver.ts","../../src/composables/useVTKCallback.ts","../../src/composables/useOrientationLabels.ts","../../src/composables/useCameraOrientation.ts","../../src/components/tools/WindowLevelTool.vue","../../src/components/tools/SliceScrollTool.vue","../../src/components/tools/MouseManipulatorTool.vue","../../src/components/tools/PanTool.vue","../../src/components/tools/ZoomTool.vue","../../src/vtk/RulerWidget/behavior.ts","../../src/vtk/RulerWidget/pointState.js","../../src/vtk/RulerWidget/state.ts","../../src/vtk/RulerWidget/index.js","../../src/utils/manipulators.ts","../../src/components/tools/ruler/RulerSVG2D.vue","../../src/components/tools/ruler/RulerSVG2D.vue","../../src/components/tools/ruler/RulerWidget2D.vue","../../src/components/tools/ruler/RulerWidget2D.vue","../../src/components/tools/RulerTool.vue","../../src/components/tools/RulerTool.vue","../../src/vtk/RectangleWidget/index.js","../../src/components/tools/rectangle/RectangleSVG2D.vue","../../src/components/tools/rectangle/RectangleSVG2D.vue","../../src/components/tools/rectangle/RectangleWidget2D.vue","../../src/components/tools/rectangle/RectangleWidget2D.vue","../../src/components/tools/RectangleTool.vue","../../src/components/tools/RectangleTool.vue","../../src/vtk/ContourWidget/representation.js","../../src/vtk/ContourWidget/behavior/common.ts","../../src/vtk/ContourWidget/interpolation.ts","../../src/vtk/ContourWidget/behavior/freehand.ts","../../src/vtk/ContourWidget/behavior/select.ts","../../src/core/contours/nudge.ts","../../src/vtk/ContourWidget/behavior/nudge.ts","../../src/vtk/ContourWidget/behavior/pointPlacing.ts","../../src/vtk/ImageMarchingSquares/index.js","../../src/core/contours/threshold.ts","../../src/vtk/ContourLoopExtraction/index.ts","../../src/vtk/TransformPolyDataToPlane/index.ts","../../src/vtk/ContourWidget/behavior/threshold.ts","../../src/vtk/ContourWidget/behavior.ts","../../src/utils/color.ts","../../src/vtk/ContourWidget/state.js","../../src/vtk/ContourWidget/index.js","../../src/components/tools/contour/ContourWidget2D.vue","../../src/components/tools/ContourTool.vue","../../src/components/tools/ContourTool.vue","../../src/components/tools/paint/PaintWidget2D.vue","../../src/components/tools/PaintTool.vue","../../src/components/tools/PaintTool.vue","../../src/composables/useSceneBuilder.ts","../../src/composables/usePersistCameraConfig.ts","../../src/components/tools/crosshairs/CrosshairsWidget2D.vue","../../src/components/tools/crosshairs/CrosshairSVG2D.vue","../../src/components/tools/crosshairs/CrosshairSVG2D.vue","../../src/components/tools/CrosshairsTool.vue","../../src/components/tools/CrosshairsTool.vue","../../src/core/proxies.ts","../../src/composables/useViewProxy.ts","../../src/composables/useWidgetManager.ts","../../src/composables/useCurrentSlice.ts","../../src/composables/useVTKWorldToDisplay.ts","../../src/components/tools/crop/Crop2DLineHandle.vue","../../src/components/tools/crop/Crop2DLineHandle.vue","../../src/components/tools/crop/Crop2D.vue","../../src/components/tools/crop/Crop2D.vue","../../src/components/tools/crop/Crop3D.vue","../../src/components/tools/CropTool.vue","../../src/components/tools/CropTool.vue","../../src/composables/proxyManager.ts","../../src/components/VtkTwoView.vue","../../src/components/VtkTwoView.vue","../../src/composables/isViewAnimating.ts","../../src/components/VtkThreeView.vue","../../src/components/VtkThreeView.vue","../../src/components/LayoutGrid.vue","../../src/components/LayoutGrid.vue","../../src/components/PersistentOverlay.vue","../../src/components/ImageListCard.vue","../../src/components/ImageListCard.vue","../../src/components/SampleDataBrowser.vue","../../src/components/SampleDataBrowser.vue","../../src/store/dicom-web/dicom-meta-store.ts","../../src/core/dicom-web-api.ts","../../src/store/dicom-web/dicom-web-store.ts","../../src/components/ItemGroup.vue","../../src/components/GroupableItem.vue","../../src/core/thumbnailers/index.ts","../../src/core/thumbnailers/vtk-image.ts","../../src/composables/useMultiSelection.ts","../../src/components/ImageDataBrowser.vue","../../src/components/ImageDataBrowser.vue","../../src/components/PatientStudyVolumeBrowser.vue","../../src/components/PatientStudyVolumeBrowser.vue","../../src/components/PatientBrowser.vue","../../src/components/PatientBrowser.vue","../../src/components/dicom-web/StudyVolumeDicomWeb.vue","../../src/components/dicom-web/StudyVolumeDicomWeb.vue","../../src/components/dicom-web/PatientDetails.vue","../../src/components/dicom-web/PatientDetails.vue","../../src/components/dicom-web/PatientList.vue","../../src/components/dicom-web/PatientList.vue","../../src/components/DataBrowser.vue","../../src/components/DataBrowser.vue","../../src/components/MeasurementsRulerList.vue","../../src/components/MeasurementsRulerList.vue","../../src/components/MeasurementsRectangleList.vue","../../src/components/MeasurementsRectangleList.vue","../../src/components/LabelmapList.vue","../../src/components/LabelmapList.vue","../../src/components/LabelEditor.vue","../../src/components/LabelControls.vue","../../src/components/RectangleControls.vue","../../src/components/RulerControls.vue","../../src/components/tools/contour/ContourControls.vue","../../src/components/ToolControls.vue","../../src/components/AnnotationsModule.vue","../../src/components/AnnotationsModule.vue","../../src/components/ModulePanel.vue","../../src/components/ModulePanel.vue","../../src/components/DragAndDrop.vue","../../src/components/icons/VolViewFullLogo.vue","../../src/assets/KitwareHeadAndNeck.jpg","../../src/components/AboutBox.vue","../../src/components/PaintControls.vue","../../src/components/PaintControls.vue","../../src/components/MenuToolButton.vue","../../src/components/MenuToolButton.vue","../../src/components/tools/crop/CropControls.vue","../../src/components/tools/crop/CropControls.vue","../../src/components/ToolStrip.vue","../../src/components/ToolStrip.vue","../../src/components/MessageItem.vue","../../src/components/MessageItem.vue","../../src/components/MessageCenter.vue","../../src/components/MessageCenter.vue","../../src/composables/useToast.js","../../src/components/MessageNotificationContent.vue","../../src/components/MessageNotificationContent.vue","../../src/components/MessageNotifications.vue","../../src/components/dicom-web/DicomWebSettings.vue","../../src/components/dicom-web/DicomWebSettings.vue","../../src/utils/errorReporting.ts","../../src/components/Settings.vue","../../src/components/Settings.vue","../../src/components/icons/VolViewLogo.vue","../../src/components/SaveSession.vue","../../src/components/SaveSession.vue","../../src/composables/useGlobalErrorHook.ts","../../src/composables/onProxyManagerEvent.ts","../../src/composables/useWebGLWatchdog.ts","../../src/composables/useAppLoadingNotifications.ts","../../src/composables/useKeyboardShortcuts.ts","../../src/components/LayoutGridDemo.vue","../../src/components/App.vue","../../src/components/App.vue","../../src/io/dicom.ts","../../src/io/readers.ts","../../src/vtk/LPSView3DProxy/index.js","../../src/vtk/LPSView2DProxy/index.js","../../src/vtk/IJKSliceRepresentationProxy/index.js","../../src/vtk/LabelMapSliceRepProxy/index.js","../../src/vtk/proxy.js","../../src/vtk/PaintBrushContextRepresentation/index.js","../../src/vtk/PaintWidget/behavior.ts","../../src/vtk/PaintWidget/state.ts","../../src/vtk/PaintWidget/index.js","../../src/core/tools/paint/ellipse-brush.ts","../../src/core/tools/paint/index.ts","../../src/core/provider.ts","../../src/utils/hacks.ts","../../src/main.js"],"sourcesContent":["/**\n * Returns the parent directory of a path.\n * @param path\n * @returns\n */\nexport function dirname(path: string) {\n  const p = path.split(/\\/+/g);\n  p.splice(-1, 1);\n  return p.join('/');\n}\n\n/**\n * Returns the base name of a path.\n * @param path\n * @returns\n */\nexport function basename(path: string) {\n  return path.split(/\\/+/g).at(-1) ?? path;\n}\n\n/**\n * Normalizes a string.\n *\n * \"a//b\" and \"a/b/\" become \"a/b\".\n * @param path\n * @returns\n */\nexport function normalize(path: string) {\n  return path.replace(/\\/+/g, '/').replace(/\\/$/, '');\n}\n\n/**\n * Joins path segments with / and normalizes the result.\n * @param segments\n */\nexport function join(...segments: string[]) {\n  return normalize(segments.join('/'));\n}\n","import { URL } from 'whatwg-url';\nimport { TypedArray } from 'itk-wasm';\nimport { EPSILON } from '../constants';\nimport { Maybe } from '../types';\n\nexport function identity<T>(arg: T) {\n  return arg;\n}\n\n/**\n * Percent is in [0, 1]. If it's Infinity, then the progress is indeterminate.\n */\nexport type ProgressCallback = (percent: number) => void;\n\nexport async function fetchFileWithProgress(\n  url: string,\n  name: string,\n  progress: ProgressCallback,\n  options: RequestInit | undefined\n): Promise<File | null> {\n  const response = await fetch(url, options);\n  const contentLength = Number(response.headers.get('content-length')) || 0;\n\n  if (contentLength <= 0) {\n    progress(Infinity);\n\n    const blob = await response.blob();\n    return new File([blob], name);\n  }\n\n  const reader = response.body?.getReader();\n  if (!reader) {\n    return null;\n  }\n\n  const bytes = new Uint8Array(contentLength);\n  let recv = 0;\n  let done = false;\n  do {\n    // eslint-disable-next-line no-await-in-loop\n    const readData = await reader.read();\n    done = readData.done;\n    if (readData.value && !done) {\n      bytes.set(readData.value, recv);\n      recv += readData.value.length;\n      progress(recv / contentLength);\n    }\n  } while (!done);\n\n  return new File([bytes], name);\n}\n\nexport const isFulfilled = <T>(\n  input: PromiseSettledResult<T>\n): input is PromiseFulfilledResult<T> => input.status === 'fulfilled';\n\ntype PromiseResolveFunction<T> = (value: T) => void;\ntype PromiseRejectFunction = (reason?: Error) => void;\nexport interface Deferred<T> {\n  promise: Promise<T>;\n  resolve: PromiseResolveFunction<T>;\n  reject: PromiseRejectFunction;\n}\n\nexport function defer<T>(): Deferred<T> {\n  let innerResolve: PromiseResolveFunction<T> | null = null;\n  let innerReject: PromiseRejectFunction | null = null;\n\n  const resolve = (value: T) => {\n    if (innerResolve) innerResolve(value);\n  };\n  const reject = (reason?: Error) => {\n    if (innerReject) innerReject(reason);\n  };\n\n  const promise = new Promise<T>((res, rej) => {\n    innerResolve = res;\n    innerReject = rej;\n  });\n\n  return { promise, resolve, reject };\n}\n\nexport function removeFromArray<T>(arr: Array<T>, el: T) {\n  const idx = arr.indexOf(el);\n  if (idx > -1) {\n    arr.splice(idx, 1);\n  }\n}\n\nexport function clampValue(value: number, min: number, max: number) {\n  return Math.min(max, Math.max(min, value));\n}\n\nexport function pick<T, K extends keyof T>(obj: T, ...keys: K[]): Pick<T, K> {\n  return keys.reduce((o, k) => ({ ...o, [k]: obj[k] }), {} as Pick<T, K>);\n}\n\nexport const pluck =\n  <T, K extends keyof T>(key: K) =>\n  (obj: T): T[K] =>\n    obj[key];\n\n/**\n * Takes a predicate and a list of values and returns a a tuple (2-item array),\n *  with each item containing the subset of the list that matches the predicate\n *  and the complement of the predicate respectively\n *\n * @sig (T -> Boolean, T[]) -> [T[], T[]]\n *\n * @param {Function} predicate A predicate to determine which side the element belongs to.\n * @param {Array} arr The list to partition\n *\n * Inspired by the Ramda function of the same name\n * @see https://ramdajs.com/docs/#partition\n *\n * @example\n *\n *     const isNegative: (n: number) => boolean = n => n < 0\n *     const numbers = [1, 2, -4, -7, 4, 22]\n *     partition(isNegative, numbers)\n *     // => [ [-4, -7], [1, 2, 4, 22] ]\n *\n * Source https://gist.github.com/zachlysobey/71ac85046d0d533287ed85e1caa64660\n */\nexport function partition<T>(\n  predicate: (val: T) => boolean,\n  arr: Array<T>\n): [Array<T>, Array<T>] {\n  const partitioned: [Array<T>, Array<T>] = [[], []];\n  arr.forEach((val: T) => {\n    const partitionIndex: 0 | 1 = predicate(val) ? 0 : 1;\n    partitioned[partitionIndex].push(val);\n  });\n  return partitioned;\n}\n\nexport const chunk = <T>(arr: T[], size: number) =>\n  Array.from({ length: Math.ceil(arr.length / size) }, (_: any, i: number) =>\n    arr.slice(i * size, i * size + size)\n  );\n\nexport function plural(n: number, word: string, pluralWord?: string) {\n  return n > 1 ? pluralWord ?? `${word}s` : word;\n}\n\nexport const ensureDefault = <T>(\n  key: string,\n  records: Record<string, T>,\n  default_: T\n) => {\n  if (!(key in records)) {\n    // eslint-disable-next-line no-param-reassign\n    records[key] = default_;\n  }\n\n  return records[key];\n};\n\ntype ArrayLike<T> = T extends unknown[] ? T : T extends TypedArray ? T : never;\nexport function arrayEquals<T>(a: ArrayLike<T>, b: ArrayLike<T>) {\n  if (a.length !== b.length) return false;\n  for (let i = 0; i < a.length; i++) {\n    if (a[i] !== b[i]) return false;\n  }\n  return true;\n}\n\ntype ComparatorFunction<T> = (a: T, b: T) => boolean;\nexport function arrayEqualsWithComparator<T>(\n  a: T[],\n  b: T[],\n  cmp: ComparatorFunction<T>\n) {\n  if (a.length !== b.length) return false;\n  for (let i = 0; i < a.length; i++) {\n    if (!cmp(a[i], b[i])) return false;\n  }\n  return true;\n}\n\n/**\n * Wraps non-arrays in an array.\n * @param maybeArray\n */\nexport function wrapInArray<T>(maybeArray: T | T[]): T[] {\n  return Array.isArray(maybeArray) ? maybeArray : [maybeArray];\n}\n\n/**\n * Extracts the basename from a URL.\n */\nexport function getURLBasename(url: string) {\n  return new URL(url, window.location.href).pathname.split('/').at(-1) ?? '';\n}\n\n// from https://stackoverflow.com/a/18650828\nexport function formatBytes(bytes: number, decimals = 2) {\n  if (!+bytes) return '0 Bytes';\n\n  const k = 1024;\n  const dm = decimals < 0 ? 0 : decimals;\n  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];\n\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n\n  return `${parseFloat((bytes / k ** i).toFixed(dm))} ${sizes[i]}`;\n}\n\nexport function roundIfCloseToInteger(value: number, eps = EPSILON) {\n  const rounded = Math.round(value);\n  if (Math.abs(rounded - value) <= eps) {\n    return rounded;\n  }\n  return value;\n}\n\nexport function hasKey<O extends Object>(\n  obj: O,\n  key: PropertyKey\n): key is keyof O {\n  return key in obj;\n}\n\nexport function remapKeys<O extends Object, K extends keyof O>(\n  obj: O,\n  keyMap: Record<K, K>\n) {\n  return Object.fromEntries(\n    Object.entries(obj).map(([key, value]) => {\n      if (hasKey(keyMap, key)) return [keyMap[key], value];\n      throw new Error(`Key ${key} not found in keyMap`);\n    })\n  );\n}\n\n// return object without the given keys\nexport const omit = <T extends Record<string, unknown>, K extends keyof T>(\n  obj: T,\n  keys: K[] | K\n) =>\n  Object.fromEntries(\n    Object.entries(obj).filter(([key]) => !wrapInArray(keys).includes(key as K))\n  ) as Omit<T, K>;\n\nexport function ensureError(e: unknown) {\n  return e instanceof Error ? e : new Error(JSON.stringify(e));\n}\n\n// remove undefined properties\nexport function cleanUndefined(obj: Object) {\n  return Object.entries(obj).reduce(\n    (cleaned, [key, value]) =>\n      value === undefined ? cleaned : { ...cleaned, [key]: value },\n    {}\n  );\n}\n\n// converts named colors (red, antiquewhite, etc) to hex\nexport function standardizeColor(color: Maybe<string>) {\n  if (!color) return '#ffffff';\n  const ctx = document.createElement('canvas').getContext('2d');\n  if (!ctx) throw new Error('Could not create canvas context');\n  ctx.fillStyle = color;\n  return ctx.fillStyle;\n}\n","import { defineStore } from 'pinia';\n\nconst START_ID = 0;\n\nexport const useIdStore = defineStore('id', () => {\n  let id: number = START_ID;\n  return {\n    nextId() {\n      return String(++id);\n    },\n    reset() {\n      id = START_ID;\n    },\n  };\n});\n","import type { Bounds } from '@kitware/vtk.js/types';\nimport { vec3, mat3 } from 'gl-matrix';\nimport {\n  LPSAxis,\n  LPSAxisDir,\n  LPSBounds,\n  LPSDirections,\n  LPSPoint,\n} from '../types/lps';\n\nexport const LPSAxes: LPSAxis[] = ['Sagittal', 'Coronal', 'Axial'];\n\nexport function createLPSPoint(): LPSPoint {\n  return {\n    Sagittal: 0,\n    Coronal: 0,\n    Axial: 0,\n  };\n}\n\nexport function createLPSBounds(): LPSBounds {\n  return {\n    Sagittal: [0, 0],\n    Coronal: [0, 0],\n    Axial: [0, 0],\n  };\n}\n\nexport function getAxisBounds(\n  bounds: Bounds,\n  axis: LPSAxis,\n  directions: LPSDirections\n) {\n  const index = 2 * directions[axis];\n  return bounds.slice(index, index + 2) as [number, number];\n}\n\nexport function getLPSAxisFromDir(dir: LPSAxisDir): LPSAxis {\n  switch (dir) {\n    case 'Superior':\n    case 'Inferior':\n      return 'Axial';\n    case 'Left':\n    case 'Right':\n      return 'Sagittal';\n    case 'Posterior':\n    case 'Anterior':\n      return 'Coronal';\n    default:\n      throw new Error(`Invalid LPS direction: ${dir}`);\n  }\n}\n\nexport const defaultLPSDirections = () => ({\n  Left: vec3.fromValues(1, 0, 0),\n  Right: vec3.fromValues(-1, 0, 0),\n  Posterior: vec3.fromValues(0, 1, 0),\n  Anterior: vec3.fromValues(0, -1, 0),\n  Superior: vec3.fromValues(0, 0, 1),\n  Inferior: vec3.fromValues(0, 0, -1),\n\n  Sagittal: 0 as const,\n  Coronal: 1 as const,\n  Axial: 2 as const,\n});\n\n/**\n * Associates the column vectors of a 3x3 matrix with the LPS axes.\n *\n * For each of the LPS axes, this function returns the associated column index (0, 1, 2)\n * in the provided 3x3 column-major matrix.\n *\n * Approach:\n *   - find the max of the direction matrix, ignoring columns and rows marked as done\n *   - assign the column vector of that max value to the row axis\n *   - mark that row and column as done\n *   - continue until all rows and columns are done\n */\nexport function getLPSDirections(direction: mat3): LPSDirections {\n  // Track the rows and columns that have yet to be assigned.\n  const availableCols = [0, 1, 2];\n  const availableRows = [0, 1, 2];\n  const lpsDirs: LPSDirections = defaultLPSDirections();\n\n  for (let i = 0; i < 3; i++) {\n    let bestValue = 0;\n    let bestValueLoc = [0, 0]; // col, row\n    let removeIndices = [0, 0]; // indices into availableCols/Rows for deletion\n\n    availableCols.forEach((col, colIdx) => {\n      availableRows.forEach((row, rowIdx) => {\n        const value = direction[col * 3 + row];\n        if (Math.abs(value) > Math.abs(bestValue)) {\n          bestValue = value;\n          bestValueLoc = [col, row];\n          removeIndices = [colIdx, rowIdx];\n        }\n      });\n    });\n\n    // the row index corresponds to the index of the LPS axis\n    const [col, axis] = bestValueLoc;\n    const axisVector = direction.slice(col * 3, (col + 1) * 3);\n    const vecSign = Math.sign(bestValue);\n    const posVector = axisVector.map((c) => c * vecSign) as vec3;\n    const negVector = axisVector.map((c) => c * -vecSign) as vec3;\n    if (axis === 0) {\n      // Sagittal\n      lpsDirs.Left = posVector;\n      lpsDirs.Right = negVector;\n      lpsDirs.Sagittal = col as 0 | 1 | 2;\n    } else if (axis === 1) {\n      // Coronal\n      lpsDirs.Posterior = posVector;\n      lpsDirs.Anterior = negVector;\n      lpsDirs.Coronal = col as 0 | 1 | 2;\n    } else if (axis === 2) {\n      // Axial\n      lpsDirs.Superior = posVector;\n      lpsDirs.Inferior = negVector;\n      lpsDirs.Axial = col as 0 | 1 | 2;\n    }\n\n    availableCols.splice(removeIndices[0], 1);\n    availableRows.splice(removeIndices[1], 1);\n  }\n\n  return lpsDirs;\n}\n","export enum Tools {\n  WindowLevel = 'WindowLevel',\n  Pan = 'Pan',\n  Zoom = 'Zoom',\n  Ruler = 'Ruler',\n  Paint = 'Paint',\n  Rectangle = 'Rectangle',\n  Crosshairs = 'Crosshairs',\n  Crop = 'Crop',\n  Contour = 'Contour',\n}\n","export enum LayoutDirection {\n  V = 'V',\n  H = 'H',\n}\n\nexport type Layout = {\n  direction: LayoutDirection;\n  items: Array<Layout | string>;\n  name?: string;\n};\n","import JSZip from 'jszip';\nimport { z } from 'zod';\nimport type { Vector3 } from '@kitware/vtk.js/types';\nimport vtkPiecewiseFunctionProxy, {\n  PiecewiseGaussian,\n  PiecewiseNode,\n} from '@kitware/vtk.js/Proxy/Core/PiecewiseFunctionProxy';\n\nimport { Tools as ToolsEnum } from '@/src/store/tools/types';\nimport { Ruler } from '@/src/types/ruler';\nimport { Rectangle } from '@/src/types/rectangle';\nimport { LPSCroppingPlanes } from '@/src/types/crop';\nimport { FrameOfReference } from '@/src/utils/frameOfReference';\nimport { Optional } from '@/src/types';\nimport { AnnotationTool } from '@/src/types/annotationTool';\n\nimport {\n  CameraConfig,\n  SliceConfig,\n  WindowLevelConfig,\n  LayersConfig,\n  VolumeColorConfig,\n} from '../../store/view-configs/types';\nimport { LPSAxisDir, LPSAxis } from '../../types/lps';\nimport { LayoutDirection } from '../../types/layout';\nimport {\n  ViewType,\n  ColorBy,\n  ColorTransferFunction,\n  OpacityFunction,\n  OpacityGaussians,\n  OpacityPoints,\n  OpacityNodes,\n  ColoringConfig,\n  CVRConfig,\n  BlendConfig,\n} from '../../types/views';\n\nexport enum DatasetType {\n  DICOM = 'dicom',\n  IMAGE = 'image',\n}\n\nconst DatasetTypeNative = z.nativeEnum(DatasetType);\n\nconst LPSAxisDir = z.union([\n  z.literal('Left'),\n  z.literal('Right'),\n  z.literal('Posterior'),\n  z.literal('Anterior'),\n  z.literal('Superior'),\n  z.literal('Inferior'),\n]) satisfies z.ZodType<LPSAxisDir>;\n\nconst Dataset = z.object({\n  id: z.string(),\n  path: z.string(),\n  type: DatasetTypeNative,\n});\nexport type Dataset = z.infer<typeof Dataset>;\n\nconst baseRemoteFileSchema = z.object({\n  archiveSrc: z.object({ path: z.string() }).optional(),\n  uriSrc: z.object({ uri: z.string(), name: z.string() }).optional(),\n});\n\ntype RemoteFileType = z.infer<typeof baseRemoteFileSchema> & {\n  parent?: RemoteFileType;\n};\n\n// This is a serialized DataSource that has a UriSource ancestor.\nconst RemoteFile: z.ZodType<RemoteFileType> = baseRemoteFileSchema.extend({\n  parent: z.lazy(() => RemoteFile.optional()),\n});\nexport type RemoteFile = z.infer<typeof RemoteFile>;\n\nconst LayoutDirectionNative = z.nativeEnum(LayoutDirection);\n\nexport interface Layout {\n  name?: string;\n  direction: LayoutDirection;\n  items: Array<Layout | string>;\n}\n\nconst Layout: z.ZodType<Layout> = z.lazy(() =>\n  z.object({\n    name: z.string().optional(),\n    direction: LayoutDirectionNative,\n    items: z.array(z.union([Layout, z.string()])),\n  })\n);\n\nconst Vector3 = z.tuple([\n  z.number(),\n  z.number(),\n  z.number(),\n]) satisfies z.ZodType<Vector3>;\n\nconst WindowLevelConfig = z.object({\n  width: z.number(),\n  level: z.number(),\n  min: z.number(),\n  max: z.number(),\n}) satisfies z.ZodType<WindowLevelConfig>;\n\nconst SliceConfig = z.object({\n  slice: z.number(),\n  min: z.number(),\n  max: z.number(),\n  axisDirection: LPSAxisDir,\n}) satisfies z.ZodType<SliceConfig>;\n\nconst CameraConfig = z.object({\n  parallelScale: z.number().optional(),\n  position: Vector3.optional(),\n  focalPoint: Vector3.optional(),\n  directionOfProjection: Vector3.optional(),\n  viewUp: Vector3.optional(),\n}) satisfies z.ZodType<CameraConfig>;\n\nconst ColorBy = z.object({\n  arrayName: z.string(),\n  location: z.string(),\n}) satisfies z.ZodType<ColorBy>;\n\nconst PiecewiseGaussian = z.object({\n  position: z.number(),\n  height: z.number(),\n  width: z.number(),\n  xBias: z.number(),\n  yBias: z.number(),\n}) satisfies z.ZodType<PiecewiseGaussian>;\n\nconst PiecewiseNode = z.object({\n  x: z.number(),\n  y: z.number(),\n  midpoint: z.number(),\n  sharpness: z.number(),\n}) as z.ZodType<PiecewiseNode>;\n\nconst OpacityGaussians = z.object({\n  mode: z.literal(vtkPiecewiseFunctionProxy.Mode.Gaussians),\n  gaussians: PiecewiseGaussian.array(),\n  mappingRange: z.tuple([z.number(), z.number()]),\n}) satisfies z.ZodType<OpacityGaussians>;\n\nconst OpacityPoints = z.object({\n  mode: z.literal(vtkPiecewiseFunctionProxy.Mode.Points),\n  preset: z.string(),\n  shift: z.number(),\n  mappingRange: z.tuple([z.number(), z.number()]),\n}) satisfies z.ZodType<OpacityPoints>;\n\nconst OpacityNodes = z.object({\n  mode: z.literal(vtkPiecewiseFunctionProxy.Mode.Nodes),\n  nodes: PiecewiseNode.array(),\n  mappingRange: z.tuple([z.number(), z.number()]),\n}) satisfies z.ZodType<OpacityNodes>;\n\nconst OpacityFunction = z.union([\n  OpacityGaussians,\n  OpacityPoints,\n  OpacityNodes,\n]);\n\nconst ColorTransferFunction = z.object({\n  preset: z.string(),\n  mappingRange: z.tuple([z.number(), z.number()]),\n}) satisfies z.ZodType<ColorTransferFunction>;\n\nconst ColoringConfig = z.object({\n  colorBy: ColorBy,\n  transferFunction: ColorTransferFunction,\n  opacityFunction: OpacityFunction,\n}) satisfies z.ZodType<ColoringConfig>;\n\nconst CVRConfig = z.object({\n  enabled: z.boolean(),\n  lightFollowsCamera: z.boolean(),\n  volumeQuality: z.number(),\n  useVolumetricScatteringBlending: z.boolean(),\n  volumetricScatteringBlending: z.number(),\n  useLocalAmbientOcclusion: z.boolean(),\n  laoKernelSize: z.number(),\n  laoKernelRadius: z.number(),\n  ambient: z.number(),\n  diffuse: z.number(),\n  specular: z.number(),\n}) satisfies z.ZodType<CVRConfig>;\n\nconst VolumeColorConfig = z.object({\n  colorBy: ColorBy,\n  transferFunction: ColorTransferFunction,\n  opacityFunction: OpacityFunction,\n  cvr: CVRConfig,\n}) satisfies z.ZodType<VolumeColorConfig>;\n\nconst BlendConfig = z.object({\n  opacity: z.number(),\n}) satisfies z.ZodType<BlendConfig>;\n\nconst LayersConfig = z.object({\n  colorBy: ColorBy,\n  transferFunction: ColorTransferFunction,\n  opacityFunction: OpacityFunction,\n  blendConfig: BlendConfig,\n}) satisfies z.ZodType<LayersConfig>;\n\nconst ViewConfig = z.object({\n  window: WindowLevelConfig.optional(),\n  slice: SliceConfig.optional(),\n  layers: LayersConfig.optional(),\n  camera: CameraConfig.optional(),\n  volumeColorConfig: VolumeColorConfig.optional(),\n});\n\nconst ViewType = z.union([\n  z.literal('2D'),\n  z.literal('3D'),\n]) satisfies z.ZodType<ViewType>;\n\nexport type ViewConfig = z.infer<typeof ViewConfig>;\n\nconst View = z.object({\n  id: z.string(),\n  type: ViewType,\n  props: z.record(z.any()),\n  config: z.record(ViewConfig),\n});\n\nexport type View = z.infer<typeof View>;\n\nexport const LabelMap = z.object({\n  id: z.string(),\n  parent: z.string(),\n  path: z.string(),\n});\n\nexport type LabelMap = z.infer<typeof LabelMap>;\n\nconst LPSAxis = z.union([\n  z.literal('Axial'),\n  z.literal('Sagittal'),\n  z.literal('Coronal'),\n]) satisfies z.ZodType<LPSAxis>;\n\nconst FrameOfReference = z.object({\n  planeOrigin: Vector3,\n  planeNormal: Vector3,\n}) satisfies z.ZodType<FrameOfReference>;\n\nconst AnnotationTool = z.object({\n  imageID: z.string(),\n  frameOfReference: FrameOfReference,\n  slice: z.number(),\n  id: z.string(),\n  name: z.string(),\n  color: z.string(),\n  label: z.string().optional(),\n  labelName: z.string().optional(),\n}) satisfies z.ZodType<AnnotationTool>;\n\nconst makeToolEntry = <T extends z.ZodRawShape>(tool: z.ZodObject<T>) =>\n  z.object({ tools: z.array(tool), labels: z.record(tool.partial()) });\n\nconst Ruler = AnnotationTool.extend({\n  firstPoint: Vector3,\n  secondPoint: Vector3,\n}) satisfies z.ZodType<Ruler>;\n\nconst Rulers = makeToolEntry(Ruler);\n\nconst Rectangle = Ruler.extend({\n  id: z.string() as unknown as z.ZodType<Rectangle['id']>,\n  fillColor: z.string().optional(),\n}) satisfies z.ZodType<Optional<Rectangle, 'fillColor'>>;\n\nconst Rectangles = makeToolEntry(Rectangle);\n\nconst Crosshairs = z.object({\n  position: Vector3,\n});\n\nexport type Crosshairs = z.infer<typeof Crosshairs>;\n\nconst ToolsEnumNative = z.nativeEnum(ToolsEnum);\n\nconst Paint = z.object({\n  activeLabelmapID: z.string().nullable(),\n  brushSize: z.number(),\n  brushValue: z.number(),\n  labelmapOpacity: z.number(),\n});\n\nconst LPSCroppingPlanes = z.object({\n  Sagittal: z.tuple([z.number(), z.number()]),\n  Coronal: z.tuple([z.number(), z.number()]),\n  Axial: z.tuple([z.number(), z.number()]),\n}) satisfies z.ZodType<LPSCroppingPlanes>;\n\nconst Cropping = z.record(LPSCroppingPlanes);\n\nconst Tools = z.object({\n  rulers: Rulers.optional(),\n  rectangles: Rectangles.optional(),\n  crosshairs: Crosshairs,\n  paint: Paint,\n  crop: Cropping,\n  current: ToolsEnumNative,\n});\n\nexport type Tools = z.infer<typeof Tools>;\n\nexport const ParentToLayers = z\n  .object({\n    selectionKey: z.string(),\n    sourceSelectionKeys: z.string().array(),\n  })\n  .array();\n\nexport type ParentToLayers = z.infer<typeof ParentToLayers>;\n\nexport const ManifestSchema = z.object({\n  version: z.string(),\n  datasets: Dataset.array(),\n  remoteFiles: z.record(RemoteFile.array()),\n  labelMaps: LabelMap.array(),\n  tools: Tools,\n  views: View.array(),\n  primarySelection: z.string().optional(),\n  layout: Layout,\n  parentToLayers: ParentToLayers,\n});\n\nexport type Manifest = z.infer<typeof ManifestSchema>;\n\nexport interface StateFile {\n  zip: JSZip;\n  manifest: Manifest;\n}\n","import { Maybe } from '@/src/types';\n\n/**\n * Represents a URI source with a file name for the downloaded resource.\n *\n * This can optionally be paired with a FileSource, indicating that the\n * FileSource is a remote FileSource.\n */\nexport interface UriSource {\n  uri: string;\n  name: string;\n}\n\n/**\n * Represents a user-specified file.\n *\n * This can optionally be paired with an ArchiveSource.\n */\nexport interface FileSource {\n  file: File;\n  fileType: string;\n}\n\n/**\n * If an archive source is specified, then it is assumed that the data source\n * has a FileSource (representing the file inside the archive), and a parent\n * data source with a FileSource that refers to the archive.\n */\nexport interface ArchiveSource {\n  // Full path + filename inside the archive\n  path: string;\n}\n\n/**\n * Used to collect DICOM file data sources.\n *\n * This is currently used for consolidating multiple DICOM files into one\n * DataSource for error stack trace purposes.\n */\nexport interface DicomSource {\n  // eslint-disable-next-line no-use-before-define\n  sources: DataSource[];\n}\n\n/**\n * Represents a source of data.\n *\n * If the parent property is set, it represents the DataSource from which this\n * DataSource was derived.\n *\n * Examples:\n * - { uriSrc }: a file that has yet to be downloaded.\n * - { fileSrc, parent: { uriSrc } }: a file with URI provenance info.\n * - { fileSrc, archiveSrc, parent }: a file originating from an archive.\n * - { dicomSrc }: a list of dicom data sources.\n */\nexport interface DataSource {\n  fileSrc?: FileSource;\n  uriSrc?: UriSource;\n  archiveSrc?: ArchiveSource;\n  dicomSrc?: DicomSource;\n  parent?: DataSource;\n}\n\nexport type DataSourceWithFile = DataSource & { fileSrc: FileSource };\n\n/**\n * Creates a DataSource from a single file.\n * @param file\n * @returns\n */\nexport const fileToDataSource = (file: File): DataSource => ({\n  fileSrc: {\n    file,\n    fileType: file.type,\n  },\n});\n\n/**\n * Creates a DataSource from a URI.\n * @param uri\n * @returns\n */\nexport const uriToDataSource = (uri: string, name: string): DataSource => ({\n  uriSrc: {\n    uri,\n    name,\n  },\n});\n\n/**\n * Creates a DataSource from a file downloaded from a URI.\n * @param uri\n * @returns\n */\nexport const remoteFileToDataSource = (\n  file: File,\n  uri: string\n): DataSource => ({\n  ...fileToDataSource(file),\n  ...uriToDataSource(uri, file.name),\n});\n\n/**\n * Determines if a data source has remote provenance.\n * @param ds\n * @returns\n */\nexport function isRemoteDataSource(ds: DataSource): boolean {\n  return !!ds.uriSrc || (!!ds.parent && isRemoteDataSource(ds.parent));\n}\n\n/**\n * Flattens a data source hierarchy, ordered by descendant first.\n *\n * For a given data source `ds`, `ds` is the descendant and `ds.parent` is the\n * ancestor.\n *\n * @param ds\n * @returns\n */\nexport function flattenDataSourceHierarchy(ds: DataSource): DataSource[] {\n  const sources: DataSource[] = [];\n  let cur: Maybe<DataSource> = ds;\n  while (cur) {\n    sources.push(cur);\n    cur = cur.parent;\n  }\n  return sources;\n}\n\n/**\n * Gets the name associated with a data source, if any.\n * @param ds\n */\nexport function getDataSourceName(ds: Maybe<DataSource>): Maybe<string> {\n  if (ds?.fileSrc) {\n    return ds.fileSrc.file.name;\n  }\n\n  if (ds?.uriSrc) {\n    return ds.uriSrc.name;\n  }\n\n  if (ds?.dicomSrc?.sources.length) {\n    const { sources } = ds.dicomSrc;\n    const [first] = sources;\n    const more = sources.length > 1 ? ` (+${sources.length - 1} more)` : '';\n    return `${getDataSourceName(first)}${more}`;\n  }\n\n  return null;\n}\n\n/**\n * Serializes a data source into a JSON formattable object.\n *\n * FileSources are stripped, as they cannot be properly serialized. This\n * includes the fileType property, which should be inferred when retyping the\n * file.\n * @param ds\n */\nexport function serializeDataSource(ds: DataSource) {\n  const output = { ...ds };\n  delete output.fileSrc;\n  if (output.parent) {\n    output.parent = serializeDataSource(output.parent);\n  }\n  return output;\n}\n","import { defineStore } from 'pinia';\nimport { DataSourceWithFile } from '@/src/io/import/dataSource';\n\ninterface State {\n  byDataID: Record<string, DataSourceWithFile[]>;\n}\n\n/**\n * Store the File objects associated with a given dataset.\n */\nexport const useFileStore = defineStore('files', {\n  state: (): State => ({\n    byDataID: {},\n  }),\n\n  getters: {\n    // Returns DataSource[] used to build a dataID\n    getDataSources: (state) => (dataID: string) => state.byDataID[dataID] ?? [],\n\n    // Returns [File] used to build a dataID\n    getFiles: (state) => (dataID: string) =>\n      (state.byDataID[dataID] ?? []).map((ds) => ds.fileSrc.file),\n  },\n\n  actions: {\n    remove(dataID: string) {\n      if (dataID in this.byDataID) {\n        delete this.byDataID[dataID];\n      }\n    },\n\n    add(dataID: string, files: DataSourceWithFile[]) {\n      this.byDataID[dataID] = files;\n    },\n  },\n});\n","import { partition } from '@/src/utils';\nimport {\n  isRemoteDataSource,\n  serializeDataSource,\n} from '@/src/io/import/dataSource';\nimport { StateFile, DatasetType } from './schema';\nimport { useFileStore } from '../../store/datasets-files';\n\nexport async function serializeData(\n  stateFile: StateFile,\n  dataIDs: string[],\n  dataType: DatasetType\n) {\n  const fileStore = useFileStore();\n  const { zip } = stateFile;\n  const {\n    manifest: { datasets, remoteFiles },\n  } = stateFile;\n\n  dataIDs.forEach((id) => {\n    const sources = fileStore.getDataSources(id);\n    if (!sources.length) {\n      throw new Error(`No files for dataID: ${id}`);\n    }\n\n    const [remotes, toZip] = partition(isRemoteDataSource, sources);\n\n    remoteFiles[id] = remotes.map(serializeDataSource);\n\n    const dataPath = `data/${id}/`;\n\n    toZip.forEach((ds) => {\n      const { file } = ds.fileSrc;\n      const filePath = `${dataPath}/${file.name}`;\n      zip.file(filePath, file);\n    });\n\n    datasets.push({\n      id,\n      path: dataPath,\n      type: dataType,\n    });\n  });\n}\n","import { defineStore } from 'pinia';\nimport { vec3, mat3, mat4 } from 'gl-matrix';\nimport { vtkImageData } from '@kitware/vtk.js/Common/DataModel/ImageData';\nimport type { Bounds } from '@kitware/vtk.js/types';\n\nimport { useIdStore } from '@/src/store/id';\nimport { defaultLPSDirections, getLPSDirections } from '../utils/lps';\nimport { removeFromArray } from '../utils';\nimport { StateFile, DatasetType } from '../io/state-file/schema';\nimport { serializeData } from '../io/state-file/utils';\nimport { useFileStore } from './datasets-files';\nimport { ImageMetadata } from '../types/image';\n\nexport const defaultImageMetadata = () => ({\n  name: '(none)',\n  orientation: mat3.create(),\n  lpsOrientation: defaultLPSDirections(),\n  spacing: vec3.fromValues(1, 1, 1),\n  origin: vec3.create(),\n  dimensions: vec3.fromValues(1, 1, 1),\n  worldBounds: [0, 1, 0, 1, 0, 1] as Bounds,\n  worldToIndex: mat4.create(),\n  indexToWorld: mat4.create(),\n});\n\ninterface State {\n  idList: string[]; // list of IDs\n  dataIndex: Record<string, vtkImageData>; // ID -> VTK object\n  metadata: Record<string, ImageMetadata>; // ID -> metadata\n}\n\nexport const useImageStore = defineStore('images', {\n  state: (): State => ({\n    idList: [],\n    dataIndex: Object.create(null),\n    metadata: Object.create(null),\n  }),\n  actions: {\n    addVTKImageData(name: string, imageData: vtkImageData) {\n      const id = useIdStore().nextId();\n\n      this.idList.push(id);\n      this.dataIndex[id] = imageData;\n\n      this.$proxies.addData(id, imageData);\n\n      this.metadata[id] = { ...defaultImageMetadata(), name };\n      this.updateData(id, imageData);\n      return id;\n    },\n\n    updateData(id: string, imageData: vtkImageData) {\n      if (id in this.metadata) {\n        const metadata: ImageMetadata = {\n          name: this.metadata[id].name,\n          dimensions: imageData.getDimensions() as vec3,\n          spacing: imageData.getSpacing() as vec3,\n          origin: imageData.getOrigin() as vec3,\n          orientation: imageData.getDirection(),\n          lpsOrientation: getLPSDirections(imageData.getDirection()),\n          worldBounds: imageData.getBounds(),\n          worldToIndex: imageData.getWorldToIndex(),\n          indexToWorld: imageData.getIndexToWorld(),\n        };\n\n        this.metadata[id] = metadata;\n      }\n      this.$proxies.updateData(id, imageData);\n      this.dataIndex[id] = imageData;\n    },\n\n    deleteData(id: string) {\n      if (id in this.dataIndex) {\n        delete this.dataIndex[id];\n        delete this.metadata[id];\n        removeFromArray(this.idList, id);\n      }\n    },\n\n    async serialize(stateFile: StateFile) {\n      const fileStore = useFileStore();\n      // We want to filter out volume images (which are generated and don't have\n      // input files in fileStore with matching imageID.)\n      const dataIDs = this.idList.filter((id) => id in fileStore.byDataID);\n\n      await serializeData(stateFile, dataIDs, DatasetType.IMAGE);\n    },\n  },\n});\n","import vtkITKHelper from '@kitware/vtk.js/Common/DataModel/ITKHelper';\nimport { defineStore } from 'pinia';\nimport { Image } from 'itk-wasm';\nimport { DataSourceWithFile } from '@/src/io/import/dataSource';\nimport { pick, removeFromArray } from '../utils';\nimport { useImageStore } from './datasets-images';\nimport { useFileStore } from './datasets-files';\nimport { StateFile, DatasetType } from '../io/state-file/schema';\nimport { serializeData } from '../io/state-file/utils';\nimport { DICOMIO } from '../io/dicom';\n\nexport const ANONYMOUS_PATIENT = 'Anonymous';\nexport const ANONYMOUS_PATIENT_ID = 'ANONYMOUS';\n\nexport function imageCacheMultiKey(offset: number, asThumbnail: boolean) {\n  return `${offset}!!${asThumbnail}`;\n}\n\nexport interface VolumeKeys {\n  patientKey: string;\n  studyKey: string;\n  volumeKey: string;\n}\n\nexport interface PatientInfo {\n  PatientID: string;\n  PatientName: string;\n  PatientBirthDate: string;\n  PatientSex: string;\n}\n\nexport interface StudyInfo {\n  StudyID: string;\n  StudyInstanceUID: string;\n  StudyDate: string;\n  StudyTime: string;\n  AccessionNumber: string;\n  StudyDescription: string;\n}\n\nexport interface VolumeInfo {\n  NumberOfSlices: number;\n  VolumeID: string;\n  Modality: string;\n  SeriesInstanceUID: string;\n  SeriesNumber: string;\n  SeriesDescription: string;\n}\n\ninterface State {\n  // volumeKey -> imageCacheMultiKey -> ITKImage\n  sliceData: Record<string, Record<string, Image>>;\n\n  // volumeKey -> imageID\n  volumeToImageID: Record<string, string | undefined>;\n  // imageID -> volumeKey\n  imageIDToVolumeKey: Record<string, string>;\n\n  // volume invalidation information\n  needsRebuild: Record<string, boolean>;\n\n  // patientKey -> patient info\n  patientInfo: Record<string, PatientInfo>;\n  // patientKey -> array of studyKeys\n  patientStudies: Record<string, string[]>;\n\n  // studyKey -> study info\n  studyInfo: Record<string, StudyInfo>;\n  // studyKey -> array of volumeKeys\n  studyVolumes: Record<string, string[]>;\n\n  // volumeKey -> volume info\n  volumeInfo: Record<string, VolumeInfo>;\n\n  // parent pointers\n  // volumeKey -> studyKey\n  volumeStudy: Record<string, string>;\n  // studyKey -> patientKey\n  studyPatient: Record<string, string>;\n}\n\nconst readDicomTags = (dicomIO: DICOMIO, file: File) =>\n  dicomIO.readTags(file, [\n    { name: 'PatientName', tag: '0010|0010', strconv: true },\n    { name: 'PatientID', tag: '0010|0020', strconv: true },\n    { name: 'PatientBirthDate', tag: '0010|0030' },\n    { name: 'PatientSex', tag: '0010|0040' },\n    { name: 'StudyInstanceUID', tag: '0020|000d' },\n    { name: 'StudyDate', tag: '0008|0020' },\n    { name: 'StudyTime', tag: '0008|0030' },\n    { name: 'StudyID', tag: '0020|0010', strconv: true },\n    { name: 'AccessionNumber', tag: '0008|0050' },\n    { name: 'StudyDescription', tag: '0008|1030', strconv: true },\n    { name: 'Modality', tag: '0008|0060' },\n    { name: 'SeriesInstanceUID', tag: '0020|000e' },\n    { name: 'SeriesNumber', tag: '0020|0011' },\n    { name: 'SeriesDescription', tag: '0008|103e', strconv: true },\n  ]);\n\nexport const useDICOMStore = defineStore('dicom', {\n  state: (): State => ({\n    sliceData: {},\n    volumeToImageID: {},\n    imageIDToVolumeKey: {},\n    patientInfo: {},\n    patientStudies: {},\n    studyInfo: {},\n    studyVolumes: {},\n    volumeInfo: {},\n    volumeStudy: {},\n    studyPatient: {},\n    needsRebuild: {},\n  }),\n  actions: {\n    async importFiles(datasets: DataSourceWithFile[]) {\n      if (!datasets.length) return [];\n\n      const dicomIO = this.$dicomIO;\n\n      const fileToDataSource = new Map(\n        datasets.map((ds) => [ds.fileSrc.file, ds])\n      );\n      const allFiles = [...fileToDataSource.keys()];\n\n      const volumeToFiles = await dicomIO.categorizeFiles(allFiles);\n\n      const fileStore = useFileStore();\n\n      // Link VolumeKey and DatasetFiles in fileStore\n      Object.entries(volumeToFiles).forEach(([volumeKey, files]) => {\n        const volumeDatasetFiles = files.map((file) => {\n          const source = fileToDataSource.get(file);\n          if (!source)\n            throw new Error('Did not match File with source DataSource');\n          return source;\n        });\n        fileStore.add(volumeKey, volumeDatasetFiles);\n      });\n\n      await Promise.all(\n        Object.entries(volumeToFiles).map(async ([volumeKey, files]) => {\n          // Read tags of first file\n          if (!(volumeKey in this.volumeInfo)) {\n            const tags = await readDicomTags(dicomIO, files[0]);\n            // TODO parse the raw string values\n            const patient = {\n              PatientID: tags.PatientID || ANONYMOUS_PATIENT_ID,\n              PatientName: tags.PatientName || ANONYMOUS_PATIENT,\n              PatientBirthDate: tags.PatientBirthDate || '',\n              PatientSex: tags.PatientSex || '',\n            };\n\n            const study = pick(\n              tags,\n              'StudyID',\n              'StudyInstanceUID',\n              'StudyDate',\n              'StudyTime',\n              'AccessionNumber',\n              'StudyDescription'\n            );\n\n            const volumeInfo = {\n              ...pick(\n                tags,\n                'Modality',\n                'SeriesInstanceUID',\n                'SeriesNumber',\n                'SeriesDescription'\n              ),\n              NumberOfSlices: files.length,\n              VolumeID: volumeKey,\n            };\n\n            this._updateDatabase(patient, study, volumeInfo);\n          }\n\n          // invalidate any existing volume\n          if (volumeKey in this.volumeToImageID) {\n            // buildVolume requestor uses this as a rebuild hint\n            this.needsRebuild[volumeKey] = true;\n          }\n        })\n      );\n\n      return Object.keys(volumeToFiles);\n    },\n\n    _updateDatabase(\n      patient: PatientInfo,\n      study: StudyInfo,\n      volume: VolumeInfo\n    ) {\n      const patientKey = patient.PatientID;\n      const studyKey = study.StudyInstanceUID;\n      const volumeKey = volume.VolumeID;\n\n      if (!(patientKey in this.patientInfo)) {\n        this.patientInfo[patientKey] = patient;\n        this.patientStudies[patientKey] = [];\n      }\n\n      if (!(studyKey in this.studyInfo)) {\n        this.studyInfo[studyKey] = study;\n        this.studyVolumes[studyKey] = [];\n        this.studyPatient[studyKey] = patientKey;\n        this.patientStudies[patientKey].push(studyKey);\n      }\n\n      if (!(volumeKey in this.volumeInfo)) {\n        this.volumeInfo[volumeKey] = volume;\n        this.volumeStudy[volumeKey] = studyKey;\n        this.sliceData[volumeKey] = {};\n        this.studyVolumes[studyKey].push(volumeKey);\n      }\n    },\n\n    deleteVolume(volumeKey: string) {\n      const imageStore = useImageStore();\n      if (volumeKey in this.volumeInfo) {\n        const studyKey = this.volumeStudy[volumeKey];\n        delete this.volumeInfo[volumeKey];\n        delete this.sliceData[volumeKey];\n        delete this.volumeStudy[volumeKey];\n\n        if (volumeKey in this.volumeToImageID) {\n          const imageID = this.volumeToImageID[volumeKey]!;\n          imageStore.deleteData(imageID!);\n          delete this.volumeToImageID[volumeKey];\n          delete this.imageIDToVolumeKey[imageID];\n        }\n\n        removeFromArray(this.studyVolumes[studyKey], volumeKey);\n        if (this.studyVolumes[studyKey].length === 0) {\n          this.deleteStudy(studyKey);\n        }\n      }\n    },\n\n    deleteStudy(studyKey: string) {\n      if (studyKey in this.studyInfo) {\n        const patientKey = this.studyPatient[studyKey];\n        delete this.studyInfo[studyKey];\n        delete this.studyPatient[studyKey];\n\n        [...this.studyVolumes[studyKey]].forEach((volumeKey) =>\n          this.deleteVolume(volumeKey)\n        );\n        delete this.studyVolumes[studyKey];\n\n        removeFromArray(this.patientStudies[patientKey], studyKey);\n        if (this.patientStudies[patientKey].length === 0) {\n          this.deletePatient(patientKey);\n        }\n      }\n    },\n\n    deletePatient(patientKey: string) {\n      if (patientKey in this.patientInfo) {\n        delete this.patientInfo[patientKey];\n\n        [...this.patientStudies[patientKey]].forEach((studyKey) =>\n          this.deleteStudy(studyKey)\n        );\n        delete this.patientStudies[patientKey];\n      }\n    },\n\n    async serialize(stateFile: StateFile) {\n      const dataIDs = Object.keys(this.volumeInfo);\n      await serializeData(stateFile, dataIDs, DatasetType.DICOM);\n    },\n\n    async deserialize(files: DataSourceWithFile[]) {\n      return this.importFiles(files).then((volumeKeys) => {\n        if (volumeKeys.length !== 1) {\n          // Volumes are store individually so we should get one back.\n          throw new Error('Invalid state file.');\n        }\n\n        return volumeKeys[0];\n      });\n    },\n\n    // returns an ITK image object\n    async getVolumeSlice(\n      volumeKey: string,\n      sliceIndex: number,\n      asThumbnail = false\n    ) {\n      const dicomIO = this.$dicomIO;\n      const fileStore = useFileStore();\n\n      const cacheKey = imageCacheMultiKey(sliceIndex, asThumbnail);\n      if (\n        volumeKey in this.sliceData &&\n        cacheKey in this.sliceData[volumeKey]\n      ) {\n        return this.sliceData[volumeKey][cacheKey];\n      }\n\n      if (!(volumeKey in this.volumeInfo)) {\n        throw new Error(`Cannot find given volume key: ${volumeKey}`);\n      }\n      const volumeInfo = this.volumeInfo[volumeKey];\n      const numSlices = volumeInfo.NumberOfSlices;\n\n      if (sliceIndex < 1 || sliceIndex > numSlices) {\n        throw new Error(`Slice ${sliceIndex} is out of bounds`);\n      }\n\n      const volumeFiles = fileStore.getFiles(volumeKey);\n\n      if (!volumeFiles) {\n        throw new Error(`No files found for volume key: ${volumeKey}`);\n      }\n\n      const sliceFile = volumeFiles[sliceIndex - 1];\n\n      const itkImage = await dicomIO.getVolumeSlice(sliceFile, asThumbnail);\n\n      this.sliceData[volumeKey][cacheKey] = itkImage;\n      return itkImage;\n    },\n\n    // returns an ITK image object\n    async getVolumeThumbnail(volumeKey: string) {\n      const { NumberOfSlices } = this.volumeInfo[volumeKey];\n      const middleSlice = Math.ceil(NumberOfSlices / 2);\n      return this.getVolumeSlice(volumeKey, middleSlice, true);\n    },\n\n    async buildVolume(volumeKey: string, forceRebuild: boolean = false) {\n      const imageStore = useImageStore();\n      const dicomIO = this.$dicomIO;\n\n      const rebuild = forceRebuild || this.needsRebuild[volumeKey];\n\n      if (!rebuild && this.volumeToImageID[volumeKey]) {\n        const imageID = this.volumeToImageID[volumeKey]!;\n        return imageStore.dataIndex[imageID];\n      }\n\n      const fileStore = useFileStore();\n      const files = fileStore.getFiles(volumeKey);\n      if (!files) throw new Error('No files for volume key');\n      const image = vtkITKHelper.convertItkToVtkImage(\n        await dicomIO.buildImage(files)\n      );\n\n      const existingImageID = this.volumeToImageID[volumeKey];\n      if (existingImageID) {\n        imageStore.updateData(existingImageID, image);\n      } else {\n        const name = this.volumeInfo[volumeKey].SeriesInstanceUID;\n        const imageID = imageStore.addVTKImageData(name, image);\n        this.imageIDToVolumeKey[imageID] = volumeKey;\n        this.volumeToImageID[volumeKey] = imageID;\n      }\n\n      delete this.needsRebuild[volumeKey];\n\n      return image;\n    },\n  },\n});\n","import { defineStore } from 'pinia';\nimport vtkPolyData from '@kitware/vtk.js/Common/DataModel/PolyData';\nimport { useIdStore } from '@/src/store/id';\n\ninterface State {\n  idList: string[]; // list of IDs\n  dataIndex: Record<string, vtkPolyData>; // ID -> VTK object\n  metadata: Record<string, {}>; // ID -> metadata\n}\nexport const useModelStore = defineStore('models', {\n  state: (): State => ({\n    idList: [],\n    dataIndex: {},\n    metadata: {},\n  }),\n  actions: {\n    addVTKPolyData(name: string, polyData: vtkPolyData) {\n      const id = useIdStore().nextId();\n      this.idList.push(id);\n      this.dataIndex[id] = polyData;\n      this.$proxies.addData(id, polyData);\n      return id;\n    },\n  },\n});\n","import { defineStore } from 'pinia';\nimport { removeFromArray } from '../utils';\n\nexport enum MessageType {\n  Error,\n  Warning,\n  Info,\n  Success,\n}\n\nexport type MessageOptions = {\n  details?: string;\n  persist?: boolean;\n};\n\nexport interface Message {\n  id: string;\n  type: MessageType;\n  title: string;\n  options: MessageOptions;\n}\n\nexport type UpdateProgressFunction = (progress: number) => void;\nexport type TaskFunction = (updateProgress?: UpdateProgressFunction) => any;\ninterface State {\n  _nextID: number;\n  byID: Record<string, Message>;\n  msgList: string[];\n}\n\nexport const useMessageStore = defineStore('message', {\n  state: (): State => ({\n    _nextID: 1,\n    byID: {},\n    msgList: [],\n  }),\n  getters: {\n    messages(): Array<Message> {\n      return this.msgList.map((id: string) => this.byID[id]);\n    },\n    // only info, error, warn\n    importantMessages(): Array<Message> {\n      return this.messages.filter((msg) => msg.type !== MessageType.Success);\n    },\n  },\n  actions: {\n    /**\n     * Adds an error message.\n     * @param title message title\n     * @param opts an Error, a string containing details, or a MessageOptions\n     */\n    addError(title: string, opts?: Error | string | MessageOptions) {\n      if (opts instanceof Error) {\n        return this._addMessage(\n          {\n            type: MessageType.Error,\n            title,\n          },\n          {\n            details: String(opts),\n            persist: false,\n          }\n        );\n      }\n      return this._addMessage(\n        {\n          type: MessageType.Error,\n          title,\n        },\n        opts\n      );\n    },\n    /**\n     * Adds a warning message.\n     * @param title message title\n     * @param opts a string containing details or a MessageOptions\n     */\n    addWarning(title: string, details?: string | MessageOptions) {\n      return this._addMessage(\n        {\n          type: MessageType.Warning,\n          title,\n        },\n        details\n      );\n    },\n    /**\n     * Adds a success message.\n     * @param title message title\n     * @param opts a string containing details or a MessageOptions\n     */\n    addInfo(title: string, details?: string | MessageOptions) {\n      return this._addMessage(\n        {\n          type: MessageType.Info,\n          title,\n        },\n        details\n      );\n    },\n    /**\n     * Adds a success message.\n     * @param title message title\n     * @param opts a string containing details or a MessageOptions\n     */\n    addSuccess(title: string, details?: string | MessageOptions) {\n      return this._addMessage(\n        {\n          type: MessageType.Success,\n          title,\n        },\n        details\n      );\n    },\n    clearOne(id: string) {\n      if (id in this.byID) {\n        removeFromArray(this.msgList, id);\n        delete this.byID[id];\n      }\n    },\n    clearAll() {\n      this.byID = {};\n      this.msgList = [];\n    },\n    _addMessage(\n      msg: Omit<Message, 'id' | 'options'>,\n      details?: string | MessageOptions\n    ) {\n      const id = String(this._nextID++);\n      const options: MessageOptions = {\n        persist: false,\n        ...(typeof details === 'string' ? { details } : details),\n      };\n      this.byID[id] = {\n        ...msg,\n        options,\n        id,\n      };\n      this.msgList.push(id);\n      return id;\n    },\n  },\n});\n","import { useMessageStore } from '../store/messages';\n\nexport async function useErrorMessage(message: string, task: Function) {\n  try {\n    return await task();\n  } catch (err) {\n    if (err instanceof Error) {\n      const messageStore = useMessageStore();\n      messageStore.addError(message, {\n        details: `${err}. More details can be found in the developer's console.`,\n      });\n    }\n    console.error(err);\n  }\n  return undefined;\n}\n","import vtkImageData from '@kitware/vtk.js/Common/DataModel/ImageData';\nimport { vtkObject } from '@kitware/vtk.js/interfaces';\nimport { defineStore } from 'pinia';\nimport { computed, ref } from 'vue';\nimport { useDICOMStore } from './datasets-dicom';\nimport { useImageStore } from './datasets-images';\nimport { useModelStore } from './datasets-models';\nimport { useFileStore } from './datasets-files';\nimport { StateFile } from '../io/state-file/schema';\nimport { useErrorMessage } from '../composables/useErrorMessage';\n\nexport const DataType = {\n  Image: 'Image',\n  Model: 'Model',\n};\n\nexport const makeDICOMSelection = (volumeKey: string) =>\n  ({\n    type: 'dicom',\n    volumeKey,\n  } as const);\n\nexport type DICOMSelection = ReturnType<typeof makeDICOMSelection>;\n\nexport const makeImageSelection = (imageID: string) =>\n  ({\n    type: 'image',\n    dataID: imageID,\n  } as const);\n\nexport type ImageSelection = ReturnType<typeof makeImageSelection>;\n\nexport type DataSelection = DICOMSelection | ImageSelection;\n\nexport const getImageID = (selection: DataSelection) => {\n  if (selection.type === 'image') return selection.dataID;\n  if (selection.type === 'dicom')\n    return useDICOMStore().volumeToImageID[selection.volumeKey]; // volume selected, but image may not have been made yet\n\n  const _exhaustiveCheck: never = selection;\n  throw new Error(`invalid selection type ${_exhaustiveCheck}`);\n};\n\nexport const getImage = async (selection: DataSelection) => {\n  const images = useImageStore();\n  const dicoms = useDICOMStore();\n  if (selection.type === 'dicom') {\n    // ensure image data exists\n    await useErrorMessage('Failed to build volume', () =>\n      dicoms.buildVolume(selection.volumeKey)\n    );\n    return images.dataIndex[getImageID(selection)!];\n  }\n  // just an image that should be in dataIndex\n  return images.dataIndex[selection.dataID];\n};\n\n// Converts imageID to VolumeKey if exists, else return input imageID\nexport const getDataID = (imageID: string) => {\n  const dicomStore = useDICOMStore();\n  return dicomStore.imageIDToVolumeKey[imageID] ?? imageID;\n};\n\n// Pass VolumeKey or ImageID and get ImageID\nexport const findImageID = (dataID: string) => {\n  const dicomStore = useDICOMStore();\n  return dicomStore.volumeToImageID[dataID] ?? dataID;\n};\n\nexport function selectionEquals(s1: DataSelection, s2: DataSelection) {\n  if (s1.type === 'dicom' && s2.type === 'dicom') {\n    return s1.volumeKey === s2.volumeKey;\n  }\n  if (s1.type === 'image' && s2.type === 'image') {\n    return s1.dataID === s2.dataID;\n  }\n  return false;\n}\n\nexport const useDatasetStore = defineStore('dataset', () => {\n  type _This = ReturnType<typeof useDatasetStore>;\n\n  const imageStore = useImageStore();\n  const modelStore = useModelStore();\n  const dicomStore = useDICOMStore();\n  const fileStore = useFileStore();\n\n  // --- state --- //\n\n  const primarySelection = ref<DataSelection | null>(null);\n\n  // --- getters --- //\n\n  const primaryImageID = computed(() => {\n    if (primarySelection.value) return getImageID(primarySelection.value);\n    return undefined;\n  });\n\n  const primaryDataset = computed<vtkImageData | null>(() => {\n    const { dataIndex } = imageStore;\n    return (primaryImageID.value && dataIndex[primaryImageID.value]) || null;\n  });\n\n  const allDataIDs = computed(() => {\n    return [...imageStore.idList, ...modelStore.idList];\n  });\n\n  function getDataProxyByID<T extends vtkObject>(this: _This, id: string) {\n    return this.$proxies.getData<T>(id);\n  }\n\n  // --- actions --- //\n\n  function setPrimarySelection(sel: DataSelection | null) {\n    primarySelection.value = sel;\n\n    if (sel === null) {\n      return;\n    }\n\n    // if selection is dicom, call buildVolume\n    if (sel.type === 'dicom') {\n      useErrorMessage('Failed to build volume', () =>\n        dicomStore.buildVolume(sel.volumeKey)\n      );\n    }\n  }\n\n  async function serialize(stateFile: StateFile) {\n    await dicomStore.serialize(stateFile);\n    await imageStore.serialize(stateFile);\n\n    if (primarySelection.value !== null) {\n      let id = null;\n      if (primarySelection.value.type === 'dicom') {\n        id = primarySelection.value.volumeKey;\n      } else {\n        id = primarySelection.value.dataID;\n      }\n\n      const { manifest } = stateFile;\n      manifest.primarySelection = id;\n    }\n  }\n\n  // --- watch for deletion --- //\n\n  imageStore.$onAction(({ name, args, after }) => {\n    if (name !== 'deleteData') {\n      return;\n    }\n    after(() => {\n      const [id] = args;\n      const sel = primarySelection.value;\n      if (sel?.type === 'image' && sel.dataID === id) {\n        primarySelection.value = null;\n      }\n      // remove file store entry\n      fileStore.remove(id);\n    });\n  });\n\n  dicomStore.$onAction(({ name, args, after }) => {\n    if (name !== 'deleteVolume') {\n      return;\n    }\n\n    after(() => {\n      const [volumeKey] = args;\n      const sel = primarySelection.value;\n      if (sel?.type === 'dicom' && volumeKey === sel.volumeKey) {\n        primarySelection.value = null;\n      }\n\n      fileStore.remove(volumeKey);\n    });\n  });\n\n  return {\n    primarySelection,\n    primaryDataset,\n    allDataIDs,\n    getDataProxyByID,\n    setPrimarySelection,\n    serialize,\n  };\n});\n","export function logError(error: unknown) {\n  let cur = error;\n  while (cur) {\n    if (cur !== error) {\n      console.error('The above error was caused by:', cur);\n    } else {\n      console.error(cur);\n    }\n\n    if (cur instanceof Error) {\n      cur = cur.cause;\n    } else {\n      cur = null;\n    }\n  }\n}\n","import { Awaitable } from '@vueuse/core';\nimport { Maybe } from '@/src/types';\nimport { defer, partition } from '../utils';\n\n/**\n * Represents a pipeline error.\n *\n * The inputDataStackTrace property provides the inputs that caused the error.\n * It is ordered by nested level, starting with the inner most execution context\n * input.\n *\n * The cause property refers to the original thrown object that resulted in the\n * error.\n */\nexport interface PipelineError<DataType> {\n  message: string;\n  inputDataStackTrace: DataType[];\n  cause: unknown;\n}\n\n/**\n * Represents a pipeline's execution result.\n *\n * The data property holds any return values from handlers.\n *\n * The errors property holds any errors reported from (potentially nested)\n * executions.\n */\nexport interface PipelineResult<DataType, ResultType> {\n  ok: boolean;\n  data: ResultType[];\n  errors: PipelineError<DataType>[];\n}\n\nfunction createPipelineError<DataType>(\n  message: string,\n  input: DataType,\n  cause: unknown\n) {\n  return {\n    message,\n    inputDataStackTrace: [input],\n    cause,\n  };\n}\n\nexport interface IPipeline<DataType, ResultType> {\n  /**\n   * Runs a given input through a middleware pipeline.\n   * @param input\n   */\n  execute(input: DataType): Promise<PipelineResult<DataType, ResultType>>;\n}\n\nconst DoneSentinel: symbol = Symbol('DoneSentinel');\ntype DoneSentinelType = symbol;\nexport type Done<Out> = (out?: Out) => DoneSentinelType;\n\nexport interface PipelineContext<DataType, ResultType, ExtraContext> {\n  /**\n   * Terminate the pipeline with an optional pipeline return value.\n   * @param pipelineReturn\n   */\n  done: Done<ResultType>;\n  /**\n   * Execute the pipeline with the given input.\n   * @param input\n   */\n  execute(\n    input: DataType,\n    extra?: ExtraContext\n  ): Promise<PipelineResult<DataType, ResultType>>;\n  /**\n   * Any extra user-supplied data.\n   */\n  extra?: ExtraContext;\n}\n\n/**\n * Represents an element/step of a pipeline.\n *\n * Handlers have three pipeline operations availble to them:\n * - process input and produce output for the rest of the pipeline\n * - terminate the pipeline and optionally produce a result\n * - start a nested execution of the pipeline with new data\n *\n * Handlers receive input data via the `input` parameter and pass data down the\n * pipeline by returning. Pipeline execution will await asynchronous handlers if\n * they return a Promise that resolves to the output data.\n *\n * The second argument to a handler is a context object containing an\n * `execute()` method and a `done()` method.\n *\n * A handler is free to start new pipeline executions by calling\n * `execute(input)`.  The handler does not need to await the `execute` call, as\n * the top-level pipeline will track all nested executions.\n *\n * If a handler wishes to terminate the pipeline, it must call `done()`. This\n * will signal the pipeline to terminate after the handler returns.  An optional\n * pipeline result value can be passed as the single argument to `done(output)`.\n * If `done()` is signalled, then the handler's return value is ignored.\n *\n * To facilitate typing and to avoid accidentally forgetting to return a value\n * in a handler, handlers are typed to return either the DataType or the return\n * value of done().\n */\nexport type Handler<\n  DataType,\n  ResultType = undefined,\n  ExtraContext = undefined\n> = (\n  input: DataType,\n  context: PipelineContext<DataType, ResultType, ExtraContext>\n) => Awaitable<DataType | DoneSentinelType>;\n\n/**\n * Represents an executable pipeline.\n *\n * Features supported:\n * - Execution of a pipeline in the given order of the provided handlers\n * - Handlers can run nested executions of the same pipeline\n * - Handlers can optionally transform data for downstream use\n * - Early termination\n * - Reporting errors. This includes un-nesting errors from nested executions.\n * - Reporting data returned from terminating handlers, if any.\n */\nexport default class Pipeline<\n  DataType,\n  ResultType = undefined,\n  ExtraContext = undefined\n> implements IPipeline<DataType, ResultType>\n{\n  private handlers: Handler<DataType, ResultType, ExtraContext>[];\n\n  constructor(handlers?: Handler<DataType, ResultType, ExtraContext>[]) {\n    this.handlers = Array.from(handlers ?? []);\n  }\n\n  /**\n   * Executes the pipeline with a given input.\n   *\n   * This method will resolve once this execution context and all\n   * nested execution contexts have finished, allowing for aggregate\n   * error reporting.\n   *\n   * Extra context data can be passed to all handlers via the `.extra` property.\n   * In nested execution scenarios, handlers may choose to pass their own extra\n   * context data into `execute(arg, extra)`. If none is supplied, the extra\n   * context data from the outermost `execute()` call is used.\n   *\n   * @param input\n   * @param extraContext\n   * @returns {PipelineResult}\n   */\n  async execute(input: DataType, extraContext?: ExtraContext) {\n    return this.startExecutionContext(input, extraContext);\n  }\n\n  private async startExecutionContext(\n    input: DataType,\n    extraContext?: ExtraContext\n  ) {\n    const handlers = [...this.handlers];\n    const nestedExecutions: Array<\n      Promise<PipelineResult<DataType, ResultType>>\n    > = [];\n    const execution = defer<Maybe<ResultType>>();\n\n    const terminate = (result: Maybe<ResultType>, error?: Error) => {\n      if (error) {\n        execution.reject(error);\n      } else {\n        execution.resolve(result);\n      }\n    };\n\n    const invokeHandler = async (data: DataType, index: number) => {\n      let doneInvoked = false;\n      // eslint-disable-next-line no-undef-init\n      let pipelineResult: ResultType | undefined = undefined;\n      const endOfPipeline = index >= handlers.length;\n\n      const context: PipelineContext<DataType, ResultType, ExtraContext> = {\n        done: (out?: ResultType): DoneSentinelType => {\n          if (doneInvoked) {\n            throw new Error('done() called twice!');\n          }\n\n          doneInvoked = true;\n          pipelineResult = out;\n          return DoneSentinel;\n        },\n        execute: async (arg: DataType, innerExtra?: ExtraContext) => {\n          const promise = this.execute(arg, innerExtra ?? extraContext);\n          nestedExecutions.push(promise);\n          return promise;\n        },\n        extra: extraContext,\n      };\n\n      let output: DataType | DoneSentinelType;\n\n      if (endOfPipeline) {\n        output = DoneSentinel;\n      }\n\n      try {\n        if (endOfPipeline) {\n          output = DoneSentinel;\n        } else {\n          const handler = handlers[index];\n          output = await handler(data, context);\n        }\n      } catch (thrown) {\n        const error =\n          thrown instanceof Error\n            ? thrown\n            : new Error(thrown ? String(thrown) : 'Unknown error occurred');\n        terminate(undefined, error);\n        return;\n      }\n\n      if (doneInvoked || endOfPipeline) {\n        terminate(pipelineResult);\n        return;\n      }\n\n      invokeHandler(output as DataType, index + 1);\n    };\n\n    const result: PipelineResult<DataType, ResultType> = {\n      ok: true,\n      data: [],\n      errors: [],\n    };\n\n    try {\n      await invokeHandler(input, 0);\n      const ret = await execution.promise;\n      if (ret != null) {\n        result.data.push(ret);\n      }\n    } catch (err) {\n      const message = err instanceof Error ? err.message : String(err);\n      result.ok = false;\n      result.errors.push(createPipelineError(message, input, err));\n    }\n\n    const innerResults = await Promise.all(nestedExecutions);\n    const [succeededInner, failedInner] = partition(\n      (res) => res.ok,\n      innerResults\n    );\n\n    if (failedInner.length > 0) {\n      result.ok = false;\n    }\n\n    succeededInner.forEach((okResult) => {\n      result.data.push(...okResult.data);\n    });\n\n    failedInner.forEach((failedResult) => {\n      const { errors } = failedResult;\n\n      // add current input to the input stack trace\n      errors.forEach((err) => {\n        err.inputDataStackTrace.push(input);\n      });\n\n      result.errors.push(...errors);\n    });\n\n    return result;\n  }\n}\n","import { ImportHandler } from '@/src/io/import/common';\n\n/**\n * Adds DICOM files to the extra context.\n * @param dataSource\n * @returns\n */\nconst handleDicomFile: ImportHandler = (dataSource, { extra, done }) => {\n  const { fileSrc } = dataSource;\n  if (extra?.dicomDataSources && fileSrc?.fileType === 'application/dicom') {\n    extra.dicomDataSources.push(dataSource);\n    return done();\n  }\n  return dataSource;\n};\n\nexport default handleDicomFile;\n","import { Awaitable } from '@vueuse/core';\nimport { URL } from 'whatwg-url';\n\n/**\n * Percent is in [0, 1]. If it's Infinity, then the progress is indeterminate.\n */\nexport type ProgressCallback = (percent: number) => void;\n\nexport interface FetchCache<T> extends Map<string, Awaitable<T>> {}\n\nexport interface FetchOptions<T> {\n  progress?: ProgressCallback;\n  cache?: FetchCache<T>;\n}\n\ninterface URLHandler {\n  testURL(url: string): boolean;\n  fetchURL(url: string, options?: FetchOptions<unknown>): Promise<Blob | null>;\n}\n\n/**\n * Handles HTTP(S) connections.\n *\n * Progress is approximate, given that data can be sent over gzipped.\n */\nconst HTTPHandler: URLHandler = {\n  testURL: (url) => {\n    const { protocol } = new URL(url, window.location.href);\n    return protocol === 'http:' || protocol === 'https:';\n  },\n  fetchURL: async (url, options = {}) => {\n    const { progress } = options;\n\n    const response = await fetch(url);\n    if (response.status !== 200) {\n      throw new Error(\n        `Fetching resource failed (HTTP code ${response.status})`\n      );\n    }\n\n    if (!progress) {\n      return response.blob();\n    }\n\n    const contentLength = Number(response.headers.get('content-length')) ?? -1;\n    if (contentLength < 0) {\n      progress(Infinity);\n      return response.blob();\n    }\n\n    const reader = response.body?.getReader();\n    if (!reader) {\n      return null;\n    }\n\n    const bytes = new Uint8Array(contentLength);\n    let recv = 0;\n    let done = false;\n    do {\n      // eslint-disable-next-line no-await-in-loop\n      const readData = await reader.read();\n      done = readData.done;\n      if (readData.value && !done) {\n        bytes.set(readData.value, recv);\n        recv += readData.value.length;\n        progress(recv / contentLength);\n      }\n    } while (!done);\n\n    return new Blob([bytes]);\n  },\n};\n\nconst HANDLERS = [HTTPHandler];\n\nexport function canFetchUrl(url: string) {\n  return !!HANDLERS.find((h) => h.testURL(url));\n}\n\n/**\n * Fetches a file.\n * @returns a File instance.\n */\nexport async function fetchFile(\n  url: string,\n  name: string,\n  options?: FetchOptions<File>\n) {\n  const handler = HANDLERS.find((h) => h.testURL(url));\n  if (!handler) {\n    throw new Error(`Cannot find a handler for URL: ${url}`);\n  }\n\n  const cache = options?.cache;\n  if (cache?.has(url)) {\n    return cache.get(url)!;\n  }\n\n  const promise = handler.fetchURL(url, options).then((blob) => {\n    if (!blob) {\n      throw new Error(`Failed to download ${url}`);\n    }\n    return new File([blob], name);\n  });\n\n  // allow trying again on the off-chance the error is transient\n  promise.catch(() => {\n    cache?.delete(url);\n  });\n\n  cache?.set(url, promise);\n  return promise;\n}\n\n/**\n * Fetches json.\n * @returns json data\n */\nexport async function fetchJSON<T>(url: string, options?: FetchOptions<T>) {\n  const handler = HANDLERS.find((h) => h.testURL(url));\n  if (!handler) {\n    throw new Error(`Cannot find a handler for URL: ${url}`);\n  }\n\n  const blob = await handler.fetchURL(url, options);\n  if (!blob) {\n    throw new Error(`Failed to download ${url}`);\n  }\n\n  const buffer = await blob.arrayBuffer();\n  const decoder = new TextDecoder();\n  return JSON.parse(decoder.decode(new Uint8Array(buffer))) as T;\n}\n","import { canFetchUrl, fetchFile } from '@/src/utils/fetch';\nimport { ImportHandler } from '@/src/io/import/common';\n\n/**\n * Downloads a URL to a file DataSource.\n *\n * Input: { uriSrc }\n * Output: { fileSrc, uriSrc }\n *\n * Provides optional caching if the execution context provides a cache.\n * @param dataSource\n * @returns\n */\nconst downloadUrl: ImportHandler = async (\n  dataSource,\n  { execute, done, extra }\n) => {\n  const { fileSrc, uriSrc } = dataSource;\n  if (!fileSrc && uriSrc && canFetchUrl(uriSrc.uri)) {\n    try {\n      const file = await fetchFile(uriSrc.uri, uriSrc.name, {\n        cache: extra?.fetchFileCache,\n      });\n      execute({\n        ...dataSource,\n        fileSrc: {\n          file,\n          fileType: '',\n        },\n      });\n      return done();\n    } catch (err) {\n      throw new Error(`Could not download URL ${uriSrc.uri}`, {\n        cause: err instanceof Error ? err : undefined,\n      });\n    }\n  }\n  return dataSource;\n};\n\nexport default downloadUrl;\n","import JSZip from 'jszip';\nimport { basename, dirname } from '@/src/utils/path';\nimport { FileEntry } from './types';\n\nexport async function extractFilesFromZip(zipFile: File): Promise<FileEntry[]> {\n  const zip = await JSZip.loadAsync(zipFile);\n  const promises: Promise<File>[] = [];\n  const paths: string[] = [];\n  zip.forEach((relPath, file) => {\n    if (!file.dir) {\n      const fileName = basename(file.name);\n      const path = dirname(file.name);\n      const fileEntry = zip.file(file.name);\n      if (fileEntry) {\n        promises.push(\n          fileEntry.async('blob').then((blob) => new File([blob], fileName))\n        );\n        paths.push(path);\n      }\n    }\n  });\n\n  return Promise.all(promises).then((files) => {\n    return files.map((file, index) => {\n      return {\n        file,\n        archivePath: paths[index],\n      };\n    });\n  });\n}\n","/**\n * application/vnd.unknown is used as a collective namespace for the purpose\n * of this application only.\n */\nexport const FILE_EXT_TO_MIME: Record<string, string> = {\n  vti: 'application/vnd.unknown.vti',\n  vtp: 'application/vnd.unknown.vtp',\n\n  stl: 'model/stl',\n\n  dcm: 'application/dicom',\n\n  zip: 'application/zip',\n\n  json: 'application/json',\n\n  // itk-wasm supported formats (from extensionToImageIO)\n\n  gipl: 'application/vnd.unknown.gipl',\n  'gipl.gz': 'application/vnd.unknown.gipl',\n\n  hdf5: 'application/x-hdf5',\n\n  jpg: 'image/jpeg',\n  jpeg: 'image/jpeg',\n\n  lsm: 'application/vnd.unknown.lsm',\n\n  mnc: 'application/vnd.unknown.minc',\n  'mnc.gz': 'application/vnd.unknown.minc',\n  mnc2: 'application/vnd.unknown.minc',\n\n  mgh: 'application/vnd.unknown.mgh',\n  mgz: 'application/vnd.unknown.mgh',\n  'mgh.gz': 'application/vnd.unknown.mgh',\n\n  mha: 'application/vnd.unknown.metaimage',\n  mhd: 'application/vnd.unknown.metaimage',\n\n  mrc: 'application/vnd.unknown.mrc',\n\n  nia: 'application/vnd.unknown.nifti-1',\n  nii: 'application/vnd.unknown.nifti-1',\n  'nii.gz': 'application/vnd.unknown.nifti-1',\n  hdr: 'application/vnd.unknown.nifti-1',\n\n  nrrd: 'application/vnd.unknown.nrrd',\n  nhdr: 'application/vnd.unknown.nrrd',\n\n  png: 'image/png',\n\n  pic: 'application/vnd.unknown.biorad',\n\n  tif: 'image/tiff',\n  tiff: 'image/tiff',\n\n  vtk: 'application/vnd.unknown.vtk',\n\n  isq: 'application/vnd.unknown.scanco',\n\n  fdf: 'application/vnd.unknown.fdf',\n};\n\nexport const FILE_EXTENSIONS = new Set(Object.keys(FILE_EXT_TO_MIME));\nexport const MIME_TYPES = new Set(Object.values(FILE_EXT_TO_MIME));\n\n/**\n * Supported archives\n */\nexport const ARCHIVE_FILE_TYPES = new Set(['application/zip']);\n","import { FetchCache } from '@/src/utils/fetch';\nimport { DataSource, FileSource } from '@/src/io/import/dataSource';\nimport { Handler } from '@/src/core/pipeline';\nimport { ARCHIVE_FILE_TYPES } from '@/src/io/mimeTypes';\nimport { Awaitable } from '@vueuse/core';\n\nexport interface ImportResult {\n  dataSource: DataSource;\n  dataID?: string;\n  dataType?: 'image' | 'dicom' | 'model';\n}\n\nexport type ArchiveContents = Record<string, File>;\nexport type ArchiveCache = Map<File, Awaitable<ArchiveContents>>;\n\nexport interface ImportContext {\n  // Caches URL responses\n  fetchFileCache?: FetchCache<File>;\n  // Caches archives. ArchiveFile -> { [archivePath]: File }\n  archiveCache?: ArchiveCache;\n  // Records dicom files\n  dicomDataSources?: DataSource[];\n}\n\nexport type ImportHandler = Handler<DataSource, ImportResult, ImportContext>;\n\nexport function isArchive(\n  ds: DataSource\n): ds is DataSource & { fileSrc: FileSource } {\n  return !!ds.fileSrc && ARCHIVE_FILE_TYPES.has(ds.fileSrc.fileType);\n}\n","import { extractFilesFromZip } from '@/src/io/zip';\nimport { ImportHandler, isArchive } from '@/src/io/import/common';\n\n/**\n * Extracts all files from an archive.\n * @param dataSource\n */\nconst extractArchive: ImportHandler = async (dataSource, { execute, done }) => {\n  if (isArchive(dataSource)) {\n    const files = await extractFilesFromZip(dataSource.fileSrc.file);\n    files.forEach((entry) => {\n      execute({\n        fileSrc: {\n          file: entry.file,\n          fileType: '',\n        },\n        archiveSrc: {\n          path: `${entry.archivePath}/${entry.file.name}`,\n        },\n        parent: dataSource,\n      });\n    });\n    return done();\n  }\n  return dataSource;\n};\n\nexport default extractArchive;\n","import {\n  ArchiveCache,\n  ArchiveContents,\n  ImportHandler,\n  isArchive,\n} from '@/src/io/import/common';\nimport { extractFilesFromZip } from '@/src/io/zip';\nimport { Maybe } from '@/src/types';\nimport * as path from '@/src/utils/path';\nimport { Awaitable } from '@vueuse/core';\n\nasync function extractArchiveContents(archiveFile: File, cache?: ArchiveCache) {\n  let contentsPromise: Maybe<Awaitable<ArchiveContents>> =\n    cache?.get(archiveFile);\n  if (contentsPromise) {\n    return contentsPromise;\n  }\n\n  contentsPromise = extractFilesFromZip(archiveFile).then((files) => {\n    return files.reduce((mapping, fileEntry) => {\n      const fullPath = path.join(fileEntry.archivePath, fileEntry.file.name);\n      return Object.assign(mapping, {\n        [fullPath]: fileEntry.file,\n      });\n    }, {} as ArchiveContents);\n  });\n\n  if (cache) {\n    cache.set(archiveFile, contentsPromise);\n  }\n\n  return contentsPromise;\n}\n\n/**\n * Extracts a single target file from an archive.\n *\n * If the fileSrc already exists, nothing is done. Otherwise, attempt to\n * extract the file from the parent archive.\n *\n * Input data source must be of the following form:\n * { archiveSrc, parent: DataSource with a fileSrc }\n * @param dataSource\n * @returns\n */\nconst extractArchiveTarget: ImportHandler = async (\n  dataSource,\n  { extra, execute, done }\n) => {\n  const { fileSrc, archiveSrc, parent } = dataSource;\n  const { archiveCache } = extra ?? {};\n\n  if (!fileSrc && archiveSrc && parent) {\n    if (!parent?.fileSrc) {\n      throw new Error(\n        'Cannot extract an archive target with an unresolved parent'\n      );\n    }\n\n    if (!isArchive(parent)) {\n      throw new Error('Parent is not a supported archive file');\n    }\n\n    const archiveContents = await extractArchiveContents(\n      parent.fileSrc.file,\n      archiveCache\n    );\n\n    const targetName = path.normalize(archiveSrc.path);\n    const targetFile = archiveContents[targetName];\n    if (!targetFile) {\n      throw new Error(`Failed to find archive member ${targetName}`);\n    }\n\n    execute({\n      ...dataSource,\n      fileSrc: {\n        file: targetFile,\n        fileType: '',\n      },\n    });\n    return done();\n  }\n\n  return dataSource;\n};\n\nexport default extractArchiveTarget;\n","import { S3Client, ListObjectsV2Command } from '@aws-sdk/client-s3';\nimport { URL } from 'whatwg-url';\n\n/**\n * Detects `s3://` uri.\n * @param uri\n * @returns\n */\nexport const isAmazonS3Uri = (uri: string) => new URL(uri).protocol === 's3:';\n\nexport type ObjectAvailableCallback = (url: string, name: string) => void;\n\nfunction getObjectPublicUrl(bucket: string, key: string) {\n  return `https://${bucket}.s3.amazonaws.com/${key}`;\n}\n\nasync function fetchObjectsWithPagination(\n  bucket: string,\n  prefix: string,\n  onObjectAvailable: ObjectAvailableCallback = () => {}\n) {\n  const client = new S3Client({\n    region: 'us-east-1',\n    // workaround for sdk's inability to specify anonymous credentials\n    signer: { sign: async (request) => request },\n  });\n\n  const paginate = async (continuationToken?: string) => {\n    const listObjectsCmd = new ListObjectsV2Command({\n      Bucket: bucket,\n      Prefix: prefix,\n      ContinuationToken: continuationToken,\n      MaxKeys: 1000,\n    });\n\n    let result;\n    try {\n      result = await client.send(listObjectsCmd);\n    } catch (err) {\n      console.error(err);\n      throw err;\n    }\n\n    if (!result.Contents) {\n      throw new Error('S3 returned no objects');\n    }\n\n    result.Contents.forEach((obj) => {\n      if (!obj.Key) return;\n      const name = obj.Key;\n      const url = getObjectPublicUrl(bucket, obj.Key);\n      onObjectAvailable(name, url);\n    });\n\n    if (result.IsTruncated && result.NextContinuationToken) {\n      await paginate(result.NextContinuationToken);\n    }\n  };\n\n  await paginate();\n}\n\n/**\n * Extracts bucket and prefix from `s3://` URIs\n * @param uri\n * @returns\n */\nexport const extractBucketAndPrefixFromS3Uri = (uri: string) => {\n  const { hostname: bucket, pathname } = new URL(uri);\n  // drop the leading forward slash\n  const objectName = pathname.replace(/^\\//, '');\n  return [bucket, objectName] as const;\n};\n\n/**\n * Gets all objects from an s3:// URI.\n *\n * Signed/credentialed requests are currently not supported.\n *\n * @param s3Uri\n */\nexport const getObjectsFromS3 = async (\n  s3Uri: string,\n  onObjectAvailable: ObjectAvailableCallback = () => {}\n) => {\n  const [bucket, objPrefix] = extractBucketAndPrefixFromS3Uri(s3Uri);\n  await fetchObjectsWithPagination(bucket, objPrefix, onObjectAvailable);\n};\n","import { getObjectsFromS3, isAmazonS3Uri } from '@/src/io/amazonS3';\nimport { ImportHandler } from '@/src/io/import/common';\n\nconst handleAmazonS3: ImportHandler = async (dataSource, { execute, done }) => {\n  const { uriSrc } = dataSource;\n  if (uriSrc && isAmazonS3Uri(uriSrc.uri)) {\n    try {\n      await getObjectsFromS3(uriSrc.uri, (name, url) => {\n        execute({\n          uriSrc: {\n            uri: url,\n            name,\n          },\n          parent: dataSource,\n        });\n      });\n      return done();\n    } catch (err) {\n      throw new Error(`Could not download S3 URI ${uriSrc.uri}`, {\n        cause: err instanceof Error ? err : undefined,\n      });\n    }\n  }\n  return dataSource;\n};\n\nexport default handleAmazonS3;\n","import { URL } from 'whatwg-url';\nimport { fetchJSON } from '../utils/fetch';\n\nexport interface GcsObject {\n  kind: string;\n  id: string;\n  selfLink: string;\n  mediaLink: string;\n  name: string;\n  bucket: string;\n  size: string;\n}\n\ninterface GcsObjectListResult {\n  kind: string;\n  nextPageToken?: string;\n  items: GcsObject[];\n}\n\n/**\n * Detects `gs://` uri.\n * @param uri\n * @returns\n */\nexport const isGoogleCloudStorageUri = (uri: string) =>\n  new URL(uri).protocol === 'gs:';\n\n/**\n * Extracts bucket and prefix from `gs://` URIs\n * @param uri\n * @returns\n */\nexport const extractBucketAndPrefixFromGsUri = (uri: string) => {\n  const { hostname: bucket, pathname } = new URL(uri);\n  // drop the leading forward slash\n  const objectName = pathname.replace(/^\\//, '');\n  return [bucket, objectName] as const;\n};\n\nexport type ObjectAvailableCallback = (object: GcsObject) => void;\n\nconst getObjectEndpoint = (bucket: string) =>\n  `https://storage.googleapis.com/storage/v1/b/${bucket}/o`;\n\nasync function fetchObjectsWithPagination(\n  bucket: string,\n  prefix: string,\n  onObjectAvailable: ObjectAvailableCallback = () => {}\n) {\n  const objects: GcsObject[] = [];\n\n  const paginate = async (nextToken?: string) => {\n    const url = new URL(getObjectEndpoint(bucket));\n    url.searchParams.append('prefix', prefix);\n    url.searchParams.append('maxResults', '1000');\n    if (nextToken) {\n      url.searchParams.append('pageToken', nextToken);\n    }\n\n    const page = await fetchJSON<GcsObjectListResult>(url.toString());\n    if (page.kind !== 'storage#objects') {\n      throw new Error('GCS did not return a list of objects!');\n    }\n\n    objects.push(...page.items);\n    page.items.forEach((obj) => onObjectAvailable(obj));\n\n    if (page.nextPageToken) {\n      await paginate(page.nextPageToken);\n    }\n  };\n\n  await paginate();\n  return objects;\n}\n\n/**\n * Gets all objects from a given gs:// URI.\n *\n * Signed/credentialed requests are currently not supported.\n *\n * This is a simplified entrypoint for GCS. We're not using\n * @google-cloud/storage due to node dependencies. As such, this will most\n * definitely be incomplete (slight API missteps, no retries, etc.) For the\n * purpose of just downloading datasets, it should work just fine.\n *\n * @param gsUri\n * @param onObjectAvailable\n * @returns\n */\nexport const getObjectsFromGsUri = async (\n  gsUri: string,\n  onObjectAvailable: ObjectAvailableCallback = () => {}\n) => {\n  const [bucketName, objPrefix] = extractBucketAndPrefixFromGsUri(gsUri);\n  return fetchObjectsWithPagination(bucketName, objPrefix, onObjectAvailable);\n};\n","import {\n  getObjectsFromGsUri,\n  isGoogleCloudStorageUri,\n} from '@/src/io/googleCloudStorage';\nimport { ImportHandler } from '@/src/io/import/common';\n\nconst handleGoogleCloudStorage: ImportHandler = async (\n  dataSource,\n  { execute, done }\n) => {\n  const { uriSrc } = dataSource;\n  if (uriSrc && isGoogleCloudStorageUri(uriSrc.uri)) {\n    try {\n      await getObjectsFromGsUri(uriSrc.uri, (object) => {\n        execute({\n          uriSrc: {\n            uri: object.mediaLink,\n            name: object.name,\n          },\n          parent: dataSource,\n        });\n      });\n      return done();\n    } catch (err) {\n      throw new Error(`Could not download GCS URI ${uriSrc.uri}`, {\n        cause: err instanceof Error ? err : undefined,\n      });\n    }\n  }\n  return dataSource;\n};\n\nexport default handleGoogleCloudStorage;\n","import { Maybe } from '../types';\n\ninterface MagicDatabase {\n  mime: string;\n  header: number[];\n  skip?: number;\n}\n\n/**\n * file magic database\n * Used to handle certain cases where files have no extension\n */\nconst FILE_MAGIC_DB: MagicDatabase[] = [\n  {\n    mime: 'application/dicom',\n    skip: 128,\n    header: Array.from('DICM').map((c) => c.charCodeAt(0)),\n  },\n];\n\n// How much data to read when extracting file magic.\n// This should be generous enough for most files.\nconst HEAD_CHUNK = 512;\n\nfunction prefixEquals(target: Uint8Array, prefix: number[] | Uint8Array) {\n  if (prefix.length > target.length) {\n    return false;\n  }\n  for (let i = 0; i < prefix.length; i += 1) {\n    if (prefix[i] !== target[i]) {\n      return false;\n    }\n  }\n  return true;\n}\n\nexport async function getFileMimeFromMagic(file: File): Promise<Maybe<string>> {\n  return new Promise((resolve) => {\n    const head = file.slice(0, HEAD_CHUNK);\n    const reader = new FileReader();\n    reader.onload = () => {\n      const chunk = new Uint8Array(reader.result! as ArrayBuffer);\n      for (let i = 0; i < FILE_MAGIC_DB.length; i += 1) {\n        const { mime, header, skip = 0 } = FILE_MAGIC_DB[i];\n        if (prefixEquals(chunk.slice(skip), header)) {\n          resolve(mime);\n          return;\n        }\n      }\n      resolve(null);\n    };\n    reader.readAsArrayBuffer(head);\n  });\n}\n","import { FILE_EXTENSIONS, FILE_EXT_TO_MIME, MIME_TYPES } from './mimeTypes';\nimport { Maybe } from '../types';\nimport { getFileMimeFromMagic } from './magic';\n\n/**\n * Determines the file's mime type.\n *\n * Returns the file's mime type for supported mime types.\n */\nexport async function getFileMimeType(file: File): Promise<Maybe<string>> {\n  const fileType = file.type.toLowerCase();\n  if (MIME_TYPES.has(fileType)) {\n    return fileType;\n  }\n\n  if (FILE_EXTENSIONS.has(fileType)) {\n    return FILE_EXT_TO_MIME[fileType];\n  }\n\n  const supportedExt = [...FILE_EXTENSIONS].find((ext) =>\n    file.name.toLowerCase().endsWith(`.${ext}`)\n  );\n  if (supportedExt) {\n    return FILE_EXT_TO_MIME[supportedExt];\n  }\n\n  const mimeFromMagic = await getFileMimeFromMagic(file);\n  if (mimeFromMagic && MIME_TYPES.has(mimeFromMagic)) {\n    return mimeFromMagic;\n  }\n\n  return null;\n}\n\n/**\n * Retypes a given File.\n *\n * Handy for when a file object has no type given.\n * Type is inferred from extension or magic.\n *\n * If type is not supported, file.type will be \"\".\n * @param file\n */\nexport async function retypeFile(file: File): Promise<File> {\n  const type = (await getFileMimeType(file)) ?? '';\n  return new File([file], file.name, { type: type.toLowerCase() });\n}\n\nexport type ReadAsType = 'ArrayBuffer' | 'Text';\n\nasync function readFileAs<T extends ArrayBuffer | string>(\n  file: File,\n  type: ReadAsType\n): Promise<T> {\n  return new Promise((resolve) => {\n    const fio = new globalThis.FileReader();\n    fio.onload = () => resolve(fio.result as T);\n    if (type === 'ArrayBuffer') {\n      fio.readAsArrayBuffer(file);\n    } else if (type === 'Text') {\n      fio.readAsText(file);\n    } else {\n      throw new TypeError(`readAs${type} is not a function`);\n    }\n  });\n}\n\n/**\n * Reads a file and returns an ArrayBuffer\n * @async\n * @param {File} file\n */\nexport async function readFileAsArrayBuffer(file: File) {\n  return readFileAs<ArrayBuffer>(file, 'ArrayBuffer');\n}\n\n/**\n * Reads a file and returns UTF-8 text\n * @async\n * @param {File} file\n */\nexport async function readFileAsUTF8Text(file: File) {\n  return readFileAs<string>(file, 'Text');\n}\n","import type { vtkObject } from '@kitware/vtk.js/interfaces';\n\nexport * from './io';\n\nexport type ReaderType = (file: File) => vtkObject | Promise<vtkObject>;\nexport type FileReaderMap = Map<string, ReaderType>;\n\n/**\n * A map of the currently registered file readers.\n *\n * Maps mime type to reader.\n */\nexport const FILE_READERS: FileReaderMap = new Map();\n","import vtkImageData from '@kitware/vtk.js/Common/DataModel/ImageData';\nimport vtkPolyData from '@kitware/vtk.js/Common/DataModel/PolyData';\nimport { useFileStore } from '@/src/store/datasets-files';\nimport { useImageStore } from '@/src/store/datasets-images';\nimport { useModelStore } from '@/src/store/datasets-models';\nimport { FILE_READERS } from '@/src/io';\nimport { ImportHandler } from '@/src/io/import/common';\nimport { DataSourceWithFile } from '@/src/io/import/dataSource';\n\n/**\n * Reads and imports a file DataSource.\n * @param dataSource\n * @returns\n */\nconst importSingleFile: ImportHandler = async (dataSource, { done }) => {\n  if (!dataSource.fileSrc) {\n    return dataSource;\n  }\n\n  const { fileSrc } = dataSource;\n  if (!FILE_READERS.has(fileSrc.fileType)) {\n    return dataSource;\n  }\n\n  const reader = FILE_READERS.get(fileSrc.fileType)!;\n  const dataObject = await reader(fileSrc.file);\n\n  const fileStore = useFileStore();\n\n  if (dataObject.isA('vtkImageData')) {\n    const dataID = useImageStore().addVTKImageData(\n      fileSrc.file.name,\n      dataObject as vtkImageData\n    );\n    fileStore.add(dataID, [dataSource as DataSourceWithFile]);\n\n    return done({\n      dataID,\n      dataSource,\n      dataType: 'image',\n    });\n  }\n\n  if (dataObject.isA('vtkPolyData')) {\n    const dataID = useModelStore().addVTKPolyData(\n      fileSrc.file.name,\n      dataObject as vtkPolyData\n    );\n    fileStore.add(dataID, [dataSource as DataSourceWithFile]);\n\n    return done({\n      dataID,\n      dataSource,\n      dataType: 'model',\n    });\n  }\n\n  throw new Error('Data reader did not produce a valid dataset');\n};\n\nexport default importSingleFile;\n","import { z } from 'zod';\n\nconst RemoteResource = z.object({\n  url: z.string(),\n  name: z.optional(z.string()),\n});\n\nexport const RemoteDataManifest = z.object({\n  resources: z.array(RemoteResource),\n});\n\nexport async function readRemoteManifestFile(manifestFile: File) {\n  const decoder = new TextDecoder();\n  const ab = await manifestFile.arrayBuffer();\n  const text = decoder.decode(new Uint8Array(ab));\n  const manifest = RemoteDataManifest.parse(JSON.parse(text));\n  return manifest;\n}\n","import { DataSource } from '@/src/io/import/dataSource';\nimport { ImportHandler } from '@/src/io/import/common';\nimport { readRemoteManifestFile } from '@src/io/manifest';\n\n/**\n * Reads a JSON file that conforms to the remote manifest spec.\n * @param dataSource\n * @returns\n */\nconst handleRemoteManifest: ImportHandler = async (\n  dataSource,\n  { done, execute }\n) => {\n  const { fileSrc } = dataSource;\n  if (fileSrc?.fileType === 'application/json') {\n    const remotes: DataSource[] = [];\n    try {\n      const manifest = await readRemoteManifestFile(fileSrc.file);\n      manifest.resources.forEach((res) => {\n        remotes.push({\n          uriSrc: {\n            uri: res.url,\n            name: res.name ?? new URL(res.url).pathname,\n          },\n          parent: dataSource,\n        });\n      });\n    } catch (err) {\n      return dataSource;\n    }\n\n    remotes.forEach((remote) => {\n      execute(remote);\n    });\n    return done();\n  }\n  return dataSource;\n};\n\nexport default handleRemoteManifest;\n","import macro from '@kitware/vtk.js/macro';\nimport vtkImageData from '@kitware/vtk.js/Common/DataModel/ImageData';\n\n// ----------------------------------------------------------------------------\n// vtkLabelMap methods\n// ----------------------------------------------------------------------------\n\nfunction vtkLabelMap(publicAPI, model) {\n  // Set our className\n  model.classHierarchy.push('vtkLabelMap');\n\n  if (model.colorMap === null) {\n    // default colormap\n    model.colorMap = {\n      0: [0, 0, 0, 0],\n      1: [0, 0, 0, 255],\n    };\n  }\n}\n\n// ----------------------------------------------------------------------------\n// Object factory\n// ----------------------------------------------------------------------------\n\nconst DEFAULT_VALUES = {\n  // default opacity map uses 0 as the transparent pixel\n  colorMap: null,\n};\n\n// ----------------------------------------------------------------------------\n\nexport function extend(publicAPI, model, initialValues = {}) {\n  Object.assign(model, DEFAULT_VALUES, initialValues);\n\n  vtkImageData.extend(publicAPI, model, initialValues);\n\n  macro.setGet(publicAPI, model, ['colorMap']);\n\n  // Object specific methods\n  vtkLabelMap(publicAPI, model);\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(extend, 'vtkLabelMap');\n\n// ----------------------------------------------------------------------------\n\nexport default { newInstance, extend };\n","export default \"data:image/jpeg;base64,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\"","import MRICardiacThumbnail from '@/src/assets/samples/MRI-Cardiac.jpg';\nimport MRIPROSTATExThumbnail from '@/src/assets/samples/MRI-PROSTATEx.jpg';\nimport MRAHeadThumbnail from '@/src/assets/samples/MRA-Head_and_Neck.jpg';\nimport CTAHeadThumbnail from '@/src/assets/samples/CTA-Head_and_Neck.jpg';\nimport USFetusThumbnail from '@/src/assets/samples/3DUS-Fetus.jpg';\nimport { Layout, LayoutDirection } from './types/layout';\nimport { ViewSpec } from './types/views';\nimport { SampleDataset } from './types';\n\n/**\n * These are the initial view IDs.\n */\nexport const InitViewIDs: Record<string, string> = {\n  Coronal: 'Coronal',\n  Sagittal: 'Sagittal',\n  Axial: 'Axial',\n  Three: '3D',\n};\n\n/**\n * View spec for the initial view IDs.\n */\nexport const InitViewSpecs: Record<string, ViewSpec> = {\n  [InitViewIDs.Coronal]: {\n    viewType: '2D',\n    props: {\n      viewDirection: 'Right',\n      viewUp: 'Superior',\n    },\n  },\n  [InitViewIDs.Sagittal]: {\n    viewType: '2D',\n    props: {\n      viewDirection: 'Posterior',\n      viewUp: 'Superior',\n    },\n  },\n  [InitViewIDs.Axial]: {\n    viewType: '2D',\n    props: {\n      viewDirection: 'Superior',\n      viewUp: 'Anterior',\n    },\n  },\n  [InitViewIDs.Three]: {\n    viewType: '3D',\n    props: {\n      viewDirection: 'Posterior',\n      viewUp: 'Superior',\n    },\n  },\n};\n\n/**\n * The default view spec.\n */\nexport const DefaultViewSpec = InitViewSpecs[InitViewIDs.Axial];\n\n/**\n * Defines the default layouts.\n */\nexport const Layouts: Record<string, Layout> = [\n  {\n    name: 'Axial Only',\n    direction: LayoutDirection.H,\n    items: [InitViewIDs.Axial],\n  },\n  {\n    name: 'Axial Primary',\n    direction: LayoutDirection.V,\n    items: [\n      InitViewIDs.Axial,\n      {\n        direction: LayoutDirection.H,\n        items: [InitViewIDs.Three, InitViewIDs.Coronal, InitViewIDs.Sagittal],\n      },\n    ],\n  },\n  {\n    name: '3D Primary',\n    direction: LayoutDirection.V,\n    items: [\n      InitViewIDs.Three,\n      {\n        direction: LayoutDirection.H,\n        items: [InitViewIDs.Coronal, InitViewIDs.Sagittal, InitViewIDs.Axial],\n      },\n    ],\n  },\n  {\n    name: 'Quad View',\n    direction: LayoutDirection.H,\n    items: [\n      {\n        direction: LayoutDirection.V,\n        items: [InitViewIDs.Coronal, InitViewIDs.Three],\n      },\n      {\n        direction: LayoutDirection.V,\n        items: [InitViewIDs.Sagittal, InitViewIDs.Axial],\n      },\n    ],\n  },\n  {\n    name: '3D Only',\n    direction: LayoutDirection.H,\n    items: [InitViewIDs.Three],\n  },\n].reduce((layouts, layout) => {\n  return { ...layouts, [layout.name]: layout };\n}, {});\n\nexport const LABELMAP_PALETTE = {\n  0: [0, 0, 0, 0], // eraser\n  1: [153, 153, 0, 255],\n  2: [76, 76, 0, 255],\n  3: [255, 255, 0, 255],\n  4: [0, 76, 0, 255],\n  5: [0, 153, 0, 255],\n  6: [0, 255, 0, 255],\n  7: [76, 0, 0, 255],\n  8: [153, 0, 0, 255],\n  9: [255, 0, 0, 255],\n  10: [0, 76, 76, 255],\n  11: [0, 153, 153, 255],\n  12: [0, 255, 255, 255],\n  13: [0, 0, 76, 255],\n  14: [0, 0, 153, 255],\n} as Record<number, number[]>;\n\nexport const SAMPLE_DATA: SampleDataset[] = [\n  // {\n  //   name: 'CTA Head and Neck',\n  //   filename: 'CTA-Head_and_Neck.zip',\n  //   description:\n  //     'CTA head and neck scan of elderly patient with tumor. (80 MB)',\n  //   url: 'https://data.kitware.com/api/v1/item/6347159711dab81428208e24/download',\n  //   image: CTAHeadThumbnail,\n  // },\n  // {\n  //   name: 'MRA Head and Neck',\n  //   filename: 'MRA-Head_and_Neck.zip',\n  //   description:\n  //     'MRA from Patient Contributed Image Repository. Click application help icon \"(?)\" for more info. (15 MB)',\n  //   url: 'https://data.kitware.com/api/v1/item/6352a2b311dab8142820a33b/download',\n  //   image: MRAHeadThumbnail,\n  // },\n  {\n    name: 'MRI Cardiac 3D and Cine',\n    filename: 'MRI-Cardiac-3D_and_Cine.zip',\n    description:\n      'MRI scan with two series: 3D axial non-gated and 2 chamber cine. (4 MB)',\n    url: 'https://data.kitware.com/api/v1/item/6350b28f11dab8142820949d/download',\n    image: MRICardiacThumbnail,\n  },\n  // {\n  //   name: 'MRI PROSTATEx',\n  //   filename: 'MRI-PROSTATEx-0004.zip',\n  //   description:\n  //     'MRI from the SPIE-AAPM-NCI PROSTATEx challenge. Click application help \"(?)\" icon for more info. (3 MB)',\n  //   url: 'https://data.kitware.com/api/v1/item/63527c7311dab8142820a338/download',\n  //   image: MRIPROSTATExThumbnail,\n  // },\n  // {\n  //   name: '3D US Fetus',\n  //   filename: '3DUS-Fetus.mha',\n  //   description:\n  //     '3D ultrasound of a baby. Downloaded from tomovision.com.(8 MB)',\n  //   url: 'https://data.kitware.com/api/v1/item/635679c311dab8142820a4f4/download',\n  //   image: USFetusThumbnail,\n  // },\n];\n\nexport const TOOL_COLORS = [\n  '#58f24c',\n  '#8de4d3',\n  '#f0a4b1',\n  '#a3c9fe',\n  '#c8f251',\n  '#fea53b',\n];\n\nexport const RULER_LABEL_DEFAULTS = {\n  red: { color: 'red' },\n  green: { color: '#00ff00' },\n  white: { color: '#ffffff' },\n};\n\nexport const RECTANGLE_LABEL_DEFAULTS = {\n  artifact: { color: '#888888', fillColor: '#ffbf0040' },\n  innocuous: { color: '#00ff00', fillColor: '#00ff0020' },\n  lesion: { color: 'red', fillColor: 'transparent' },\n};\n\nexport const DECREMENT_LABEL_KEY = 'q';\nexport const INCREMENT_LABEL_KEY = 'w';\n\nexport const DEFAULT_PRESET_BY_MODALITY: Record<string, string> = {\n  CT: 'CT-AAA',\n  MR: 'CT-Coronary-Arteries-2',\n  US: 'US-Fetal',\n};\n","/* eslint-disable */\nimport { defer, Deferred } from './index';\n\n// to be used to instantiate a worker\nexport default class PromiseWorker {\n  private msgID: number;\n  private worker: Worker;\n  private waiting: Record<string, Deferred<any>>;\n\n  constructor(worker: Worker) {\n    this.msgID = 0;\n    this.worker = worker;\n    this.waiting = {};\n\n    this.worker.onmessage = this.handleMessage.bind(this);\n  }\n\n  postMessage(message: any, transferables: any[] = []) {\n    const wrappedMsg = {\n      id: this.msgID,\n      message,\n    };\n\n    const deferred = defer();\n    this.waiting[wrappedMsg.id] = deferred;\n\n    this.worker.postMessage(wrappedMsg, transferables);\n\n    this.msgID += 1;\n    return deferred.promise;\n  }\n\n  handleMessage(ev: any) {\n    const { id, error, message } = ev.data;\n    if (id in this.waiting) {\n      const deferred = this.waiting[id];\n      delete this.waiting[id];\n      if (error) {\n        deferred.reject(new Error(error));\n      } else {\n        deferred.resolve(message);\n      }\n    }\n  }\n}\n","import vtk from '@kitware/vtk.js/vtk';\n\nimport PromiseWorker from '@/src/utils/promise-worker';\nimport vtkDataSet from '@kitware/vtk.js/Common/DataModel/DataSet';\nimport { vtkObject } from '@kitware/vtk.js/interfaces';\nimport { StateObject } from './common';\n\ninterface SuccessReadResult {\n  status: 'success';\n  obj: StateObject;\n}\n\ninterface FailResult {\n  status: 'fail';\n  error: Error;\n}\n\ntype ReadResult = SuccessReadResult | FailResult;\n\nexport const runAsyncVTKReader = (readerName: string) => async (file: File) => {\n  const worker = new PromiseWorker(\n    new Worker(new URL('./async.reader.worker.ts', import.meta.url), {\n      type: 'module',\n    })\n  );\n  const data = (await worker.postMessage({\n    file,\n    readerName,\n  })) as ReadResult;\n  if (data.status === 'success') {\n    return vtk(data.obj) as vtkObject;\n  }\n  throw data.error;\n};\n\ninterface SuccessWriteResult {\n  status: 'success';\n  data: string;\n}\ntype WriteResult = SuccessWriteResult | FailResult;\n\nexport const runAsyncVTKWriter =\n  (writerName: string) => async (dataSet: vtkDataSet) => {\n    const worker = new PromiseWorker(\n      new Worker(new URL('./async.writer.worker.ts', import.meta.url), {\n        type: 'module',\n      })\n    );\n    const result = (await worker.postMessage({\n      obj: dataSet.getState(),\n      writerName,\n    })) as WriteResult;\n    if (result.status === 'success') {\n      return result.data;\n    }\n    throw result.error;\n  };\n\nexport const stlReader = runAsyncVTKReader('stl');\nexport const vtiReader = runAsyncVTKReader('vti');\nexport const vtpReader = runAsyncVTKReader('vtp');\nexport const vtiWriter = runAsyncVTKWriter('vti');\n","import vtkDataArray from '@kitware/vtk.js/Common/Core/DataArray';\nimport vtkImageData from '@kitware/vtk.js/Common/DataModel/ImageData';\nimport { defineStore } from 'pinia';\nimport { useImageStore } from '@/src/store/datasets-images';\nimport { join, normalize } from '@/src/utils/path';\nimport { useIdStore } from '@/src/store/id';\nimport vtkLabelMap from '../vtk/LabelMap';\nimport { LABELMAP_PALETTE } from '../config';\nimport { StateFile, Manifest } from '../io/state-file/schema';\nimport { vtiReader, vtiWriter } from '../io/vtk/async';\nimport { FileEntry } from '../io/types';\nimport { findImageID, getDataID } from './datasets';\n\nconst LabelmapArrayType = Uint8Array;\nexport type LabelmapArrayType = Uint8Array;\n\ninterface State {\n  idList: string[];\n  labelmaps: Record<string, vtkLabelMap>;\n  parentImage: Record<string, string>;\n}\n\nfunction createLabelmapFromImage(imageData: vtkImageData) {\n  const points = new LabelmapArrayType(imageData.getNumberOfPoints());\n  const labelmap = vtkLabelMap.newInstance(\n    imageData.get('spacing', 'origin', 'direction')\n  );\n  labelmap.getPointData().setScalars(\n    vtkDataArray.newInstance({\n      numberOfComponents: 1,\n      values: points,\n    })\n  );\n  labelmap.setDimensions(imageData.getDimensions());\n  labelmap.computeTransforms();\n  labelmap.setColorMap(LABELMAP_PALETTE);\n\n  return labelmap;\n}\n\nfunction toLabelMap(imageData: vtkImageData) {\n  const labelmap = vtkLabelMap.newInstance(\n    imageData.get(\n      'spacing',\n      'origin',\n      'direction',\n      'indexToWorld',\n      'worldToIndex',\n      'dataDescription',\n      'pointData'\n    )\n  );\n  labelmap.setDimensions(imageData.getDimensions());\n  labelmap.computeTransforms();\n  labelmap.setColorMap(LABELMAP_PALETTE);\n\n  return labelmap;\n}\n\nexport const useLabelmapStore = defineStore('labelmap', {\n  state: (): State => ({\n    idList: [],\n    labelmaps: Object.create(null),\n    parentImage: Object.create(null),\n  }),\n  actions: {\n    newLabelmapFromImage(imageID: string) {\n      const imageStore = useImageStore();\n      const imageData = imageStore.dataIndex[imageID];\n      if (!imageData) {\n        return null;\n      }\n\n      const id = useIdStore().nextId();\n      const labelmap = createLabelmapFromImage(imageData);\n\n      this.idList.push(id);\n      this.parentImage[id] = imageID;\n      this.labelmaps[id] = labelmap;\n\n      this.$proxies.addData(id, labelmap);\n\n      return id;\n    },\n    async serialize(state: StateFile) {\n      const { labelMaps } = state.manifest;\n      const { zip } = state;\n\n      await Promise.all(\n        Object.entries(this.labelmaps).map(async ([id, labelMap]) => {\n          const labelPath = `labels/${id}.vti`;\n          const parent = getDataID(this.parentImage[id]);\n          labelMaps.push({\n            id,\n            parent,\n            path: labelPath,\n          });\n\n          const serializedData = await vtiWriter(labelMap);\n          zip.file(labelPath, serializedData);\n        })\n      );\n    },\n    async deserialize(\n      manifest: Manifest,\n      stateFiles: FileEntry[],\n      dataIDMap: Record<string, string>\n    ) {\n      const { labelMaps } = manifest;\n\n      const labelmapIDMap: Record<string, string> = {};\n\n      labelMaps.forEach(async (labelMap) => {\n        const [file] = stateFiles\n          .filter(\n            (entry) =>\n              join(entry.archivePath, entry.file.name) ===\n              normalize(labelMap.path)\n          )\n          .map((entry) => entry.file);\n\n        // map parent id to new id\n        // eslint-disable-next-line no-param-reassign\n        labelMap.parent = dataIDMap[labelMap.parent];\n\n        const { parent } = labelMap;\n        const id = useIdStore().nextId();\n        labelmapIDMap[labelMap.id] = id;\n\n        const imageData = await vtiReader(file);\n        const labelMapObj = toLabelMap(imageData as vtkImageData);\n        this.idList.push(id);\n        this.parentImage[id] = findImageID(parent);\n        this.labelmaps[id] = labelMapObj;\n        this.$proxies.addData(id, labelMapObj);\n      });\n\n      return labelmapIDMap;\n    },\n  },\n});\n","import {\n  runPipeline,\n  InterfaceTypes,\n  imageSharedBufferOrCopy,\n  WorkerPool,\n  stackImages,\n} from 'itk-wasm';\nimport { join } from '@/src/utils/path';\n\nexport async function runWasm(\n  pipeline,\n  args,\n  images,\n  outputs = [{ type: InterfaceTypes.Image }]\n) {\n  const numberOfWorkers = navigator.hardwareConcurrency\n    ? navigator.hardwareConcurrency\n    : 6;\n\n  const aImage = images[0];\n  const splits = Math.min(\n    parseInt(numberOfWorkers / 2, 10),\n    Math.max(aImage.size[aImage.size.length - 1], 1),\n    4 // avoid out of memory errors with larger images\n  );\n\n  const splitsArg = splits.toString();\n  const tasks = [...Array(splits).keys()].map((split) => {\n    const taskArgs = [\n      ...[...Array(images.length).keys()].map((num) => num.toString()),\n      '0', // input image space\n      ...args,\n      '--max-total-splits',\n      splitsArg,\n      '--split',\n      split.toString(),\n      '--number-of-splits',\n      splitsArg,\n      '--memory-io',\n    ];\n\n    const inputs = images.map((image) => ({\n      type: InterfaceTypes.Image,\n      data: imageSharedBufferOrCopy(image),\n    }));\n\n    return [pipeline, taskArgs, outputs, inputs, join(import.meta.env.BASE_URL, '/itk/pipelines'),\n      join(import.meta.env.BASE_URL, '/itk/pipeline.worker.js')];\n  });\n\n  const workerPool = new WorkerPool(numberOfWorkers, runPipeline);\n  const results = await workerPool.runTasks(tasks).promise;\n  workerPool.terminateWorkers();\n  const validResults = results.filter((r) => r.returnValue === 0);\n  const imageSplits = validResults.map(\n    ({ outputs: pipelineOutput }) => pipelineOutput[0].data\n  );\n\n  return stackImages(imageSplits);\n}\n","import { arrayEquals } from '@/src/utils';\nimport { Image } from 'itk-wasm';\nimport { runWasm } from './itkWasmUtils';\n\n\nconst compareProps = ['size', 'direction', 'origin', 'spacing'] as const;\n\nexport function compareImageSpaces(imageA: Image, imageB: Image) {\n  const equalKeys = compareProps.map((key) =>\n    arrayEquals(imageA[key], imageB[key])\n  );\n  return equalKeys.every((b) => b);\n}\n\nexport async function resample(fixed: Image, moving: Image) {\n  if (compareImageSpaces(fixed, moving)) return moving; // same space, just return\n\n  const { size, spacing, origin, direction } = fixed;\n  const args = [\n    '--size',\n    size.join(','),\n    '--spacing',\n    spacing.join(','),\n    '--origin',\n    origin.join(','),\n    '--direction',\n    direction.join(','),\n  ];\n\n  return runWasm('resample', args, [moving]);\n}\n","import { ref } from 'vue';\nimport vtkITKHelper from '@kitware/vtk.js/Common/DataModel/ITKHelper';\nimport vtkImageData from '@kitware/vtk.js/Common/DataModel/ImageData';\nimport vtkBoundingBox from '@kitware/vtk.js/Common/DataModel/BoundingBox';\nimport { defineStore } from 'pinia';\nimport { useImageStore } from '@/src/store/datasets-images';\nimport { resample } from '../io/resample/resample';\nimport { useDICOMStore } from './datasets-dicom';\nimport {\n  DataSelection,\n  makeDICOMSelection,\n  makeImageSelection,\n  selectionEquals,\n  getImage,\n} from './datasets';\nimport { useErrorMessage } from '../composables/useErrorMessage';\nimport { Manifest, StateFile } from '../io/state-file/schema';\n\n// differ from Image/Volume IDs with a branded type\ntype DataSelectionKey = string & { __type: 'DataSelectionKey' };\nexport type LayerID = string & { __type: 'LayerID' };\n\nexport type Layer = {\n  selection: DataSelection;\n  id: LayerID;\n};\n\nconst assertNeverDataSelection = (selection: never): never => {\n  throw new Error(`Unknown DataSelection: ${selection}`);\n};\n\nconst getID = (selection: DataSelection) => {\n  if (selection.type === 'dicom') return selection.volumeKey;\n  if (selection.type === 'image') return selection.dataID;\n  return assertNeverDataSelection(selection);\n};\n\nconst toDataSelectionKey = (selection: DataSelection) => {\n  const id = getID(selection);\n  return `${selection.type}::${id}` as DataSelectionKey;\n};\n\nconst toDataSelectionFromKey = (key: DataSelectionKey) => {\n  const [type, id] = key.split('::') as [DataSelection['type'], string];\n\n  if (type === 'dicom') return makeDICOMSelection(id);\n  if (type === 'image') return makeImageSelection(id);\n\n  return assertNeverDataSelection(type);\n};\n\nexport const useLayersStore = defineStore('layer', () => {\n  type _This = ReturnType<typeof useLayersStore>;\n\n  const parentToLayers = ref<Record<DataSelectionKey, Layer[]>>({});\n  const layerImages = ref<Record<LayerID, vtkImageData>>({});\n\n  async function _addLayer(\n    this: _This,\n    parent: DataSelection,\n    source: DataSelection\n  ) {\n    if (!parent) {\n      throw new Error('Tried to addLayer without parent data selection');\n    }\n\n    const parentKey = toDataSelectionKey(parent);\n    const id = `${parentKey}::${toDataSelectionKey(source)}` as LayerID;\n    this.parentToLayers[parentKey] = [\n      ...(this.parentToLayers[parentKey] ?? []),\n      { selection: source, id } as Layer,\n    ];\n\n    const [parentImage, sourceImage] = await Promise.all(\n      [parent, source].map(getImage)\n    );\n\n    if (\n      !vtkBoundingBox.intersects(\n        parentImage.getBounds(),\n        sourceImage.getBounds()\n      )\n    ) {\n      this.deleteLayer(parent, source);\n      throw new Error(\n        'Image bounds do not intersect, so no overlap in physical space'\n      );\n    }\n\n    const itkImage = await resample(\n      vtkITKHelper.convertVtkToItkImage(parentImage),\n      vtkITKHelper.convertVtkToItkImage(sourceImage)\n    );\n    const image = vtkITKHelper.convertItkToVtkImage(itkImage);\n\n    this.$proxies.addData(id, image);\n\n    // calling after adding data to proxy manager delays enabling deletion, thus avoiding error\n    this.layerImages[id] = image;\n  }\n\n  async function addLayer(\n    this: _This,\n    parent: DataSelection,\n    source: DataSelection\n  ) {\n    return useErrorMessage('Failed to build layer', () =>\n      this._addLayer(parent, source)\n    );\n  }\n\n  function deleteLayer(\n    this: _This,\n    parent: DataSelection,\n    source: DataSelection\n  ) {\n    if (!parent) {\n      throw new Error('Tried to deleteLayer without parent data selection');\n    }\n\n    const parentKey = toDataSelectionKey(parent);\n    const layers = this.parentToLayers[parentKey] ?? [];\n\n    const layerToDelete = layers.find(({ selection }) =>\n      selectionEquals(selection, source)\n    );\n    if (!layerToDelete) return;\n\n    this.parentToLayers[parentKey] = layers.filter(\n      (layer) => layer !== layerToDelete\n    );\n\n    delete this.layerImages[layerToDelete.id];\n\n    // May have errored creating data, so check before delete\n    if (this.$proxies.getData(layerToDelete.id))\n      this.$proxies.deleteData(layerToDelete.id);\n  }\n\n  function getLayers(key: DataSelection | null | undefined) {\n    if (!key) return [];\n    const dataKey = toDataSelectionKey(key);\n    return parentToLayers.value[dataKey] ?? [];\n  }\n\n  const getLayer = (layerID: LayerID) =>\n    Object.values(parentToLayers.value)\n      .flat()\n      .flat()\n      .find(({ id }) => id === layerID);\n\n  // --- watch for deletion --- //\n\n  const deleteSelection = (deleteKey: DataSelection) => {\n    const layerStore = useLayersStore();\n    // delete as parent\n    layerStore\n      .getLayers(deleteKey)\n      .forEach(({ selection }) => layerStore.deleteLayer(deleteKey, selection));\n    // delete from layer lists\n    Object.keys(layerStore.parentToLayers)\n      .map((key) => toDataSelectionFromKey(key as DataSelectionKey))\n      .forEach((parent) => layerStore.deleteLayer(parent, deleteKey));\n  };\n\n  const imageStore = useImageStore();\n  imageStore.$onAction(({ name, args }) => {\n    if (name !== 'deleteData') {\n      return;\n    }\n    const [id] = args;\n    const selection = makeImageSelection(id);\n    deleteSelection(selection);\n  });\n\n  const dicomStore = useDICOMStore();\n  dicomStore.$onAction(({ name, args }) => {\n    if (name !== 'deleteVolume') {\n      return;\n    }\n    const [volumeKey] = args;\n    const selection = makeDICOMSelection(volumeKey);\n    deleteSelection(selection);\n  });\n\n  function serialize(this: _This, state: StateFile) {\n    state.manifest.parentToLayers = Object.entries(this.parentToLayers).map(\n      ([selectionKey, layers]) => ({\n        selectionKey,\n        sourceSelectionKeys: layers.map(({ selection }) =>\n          toDataSelectionKey(selection)\n        ),\n      })\n    );\n  }\n\n  function deserialize(\n    this: _This,\n    manifest: Manifest,\n    dataIDMap: Record<string, string>\n  ) {\n    const remapSelection = (selection: DataSelection) => {\n      if (selection.type === 'dicom')\n        return makeDICOMSelection(dataIDMap[selection.volumeKey]);\n      if (selection.type === 'image')\n        return makeImageSelection(dataIDMap[selection.dataID]);\n\n      const _exhaustiveCheck: never = selection;\n      throw new Error(`invalid selection type ${_exhaustiveCheck}`);\n    };\n\n    const { parentToLayers: parentToLayersSerialized } = manifest;\n    parentToLayersSerialized.forEach(\n      ({ selectionKey, sourceSelectionKeys }) => {\n        const parent = remapSelection(\n          toDataSelectionFromKey(selectionKey as DataSelectionKey)\n        );\n        sourceSelectionKeys.forEach((sourceKey) => {\n          const source = remapSelection(\n            toDataSelectionFromKey(sourceKey as DataSelectionKey)\n          );\n          this.addLayer(parent, source);\n        });\n      }\n    );\n  }\n\n  return {\n    parentToLayers,\n    layerImages,\n    _addLayer,\n    addLayer,\n    deleteLayer,\n    getLayers,\n    getLayer,\n    serialize,\n    deserialize,\n  };\n});\n","import { computed } from 'vue';\nimport { useDatasetStore } from '../store/datasets';\nimport { useDICOMStore } from '../store/datasets-dicom';\nimport { defaultImageMetadata, useImageStore } from '../store/datasets-images';\nimport { useLayersStore } from '../store/datasets-layers';\nimport { createLPSBounds, getAxisBounds } from '../utils/lps';\n\n// Returns a spatially inflated image extent\nexport function getImageSpatialExtent(imageID: string | null) {\n  const imageStore = useImageStore();\n\n  if (imageID && imageID in imageStore.metadata) {\n    const { lpsOrientation } = imageStore.metadata[imageID];\n    const image = imageStore.dataIndex[imageID];\n    if (image) {\n      const extent = image.getSpatialExtent();\n      return {\n        Sagittal: getAxisBounds(extent, 'Sagittal', lpsOrientation),\n        Coronal: getAxisBounds(extent, 'Coronal', lpsOrientation),\n        Axial: getAxisBounds(extent, 'Axial', lpsOrientation),\n      };\n    }\n  }\n  return createLPSBounds();\n}\n\nexport function useCurrentImage() {\n  const dataStore = useDatasetStore();\n  const dicomStore = useDICOMStore();\n  const imageStore = useImageStore();\n  const layersStore = useLayersStore();\n\n  const currentImageID = computed(() => {\n    const { primarySelection } = dataStore;\n    const { volumeToImageID } = dicomStore;\n\n    if (primarySelection?.type === 'image') {\n      return primarySelection.dataID;\n    }\n    if (primarySelection?.type === 'dicom') {\n      return volumeToImageID[primarySelection.volumeKey] || null;\n    }\n    return null;\n  });\n\n  const currentImageMetadata = computed(() => {\n    const { metadata } = imageStore;\n    const imageID = currentImageID.value;\n\n    if (imageID) {\n      return metadata[imageID];\n    }\n    return defaultImageMetadata();\n  });\n\n  const currentImageData = computed(() => {\n    if (currentImageID.value)\n      // assumed to be only images for now\n      return imageStore.dataIndex[currentImageID.value];\n    return undefined;\n  });\n\n  const currentImageExtent = computed(() =>\n    getImageSpatialExtent(currentImageID.value)\n  );\n\n  const isImageLoading = computed(() => {\n    return !!dataStore.primarySelection && !dataStore.primaryDataset;\n  });\n\n  const currentLayers = computed(() =>\n    layersStore\n      .getLayers(dataStore.primarySelection)\n      .filter(({ id }) => id in layersStore.layerImages)\n  );\n\n  return {\n    currentImageData,\n    currentImageID,\n    currentImageMetadata,\n    currentImageExtent,\n    isImageLoading,\n    currentLayers,\n  };\n}\n","import { getImageSpatialExtent } from '@/src/composables/useCurrentImage';\nimport { LPSAxis } from '@/src/types/lps';\nimport { getAxisBounds } from '@/src/utils/lps';\nimport vtkPlane from '@kitware/vtk.js/Common/DataModel/Plane';\nimport type { Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport { computed, reactive, readonly, unref } from 'vue';\nimport { MaybeRef } from '@vueuse/core';\nimport { vec3 } from 'gl-matrix';\nimport { defineStore } from 'pinia';\nimport { arrayEqualsWithComparator } from '@/src/utils';\nimport { useImageStore } from '../datasets-images';\nimport { LPSCroppingPlanes } from '../../types/crop';\nimport { ImageMetadata } from '../../types/image';\nimport { StateFile, Manifest } from '../../io/state-file/schema';\n\nfunction clampRangeToBounds(range: Vector2, bounds: Vector2) {\n  return [\n    Math.max(bounds[0], Math.min(bounds[1], range[0])),\n    Math.max(bounds[0], Math.min(bounds[1], range[1])),\n  ] as Vector2;\n}\n\nfunction convertCropBoundsToVTKPlane(\n  cropBounds: LPSCroppingPlanes,\n  metadata: ImageMetadata,\n  axis: LPSAxis,\n  lowerUpper: 0 | 1\n) {\n  const { indexToWorld, orientation, lpsOrientation: lpsDirs } = metadata;\n\n  const origin = [0, 0, 0] as Vector3;\n  const axisIndex = lpsDirs[axis];\n  origin[axisIndex] = cropBounds[axis][lowerUpper];\n  vec3.transformMat4(origin, origin, indexToWorld);\n\n  // The lower bound normal is the associated column in the\n  // image orientation matrix. The upper bound normal is the\n  // lower bound normal, but negated.\n  const neg = -(lowerUpper * 2 - 1);\n  const normal = [\n    ...orientation.slice(axisIndex * 3, axisIndex * 3 + 3).map((c) => c * neg),\n  ] as Vector3;\n\n  return vtkPlane.newInstance({ origin, normal });\n}\n\nexport function croppingPlanesEqual(a1: vtkPlane[], a2: vtkPlane[]) {\n  return arrayEqualsWithComparator<vtkPlane>(a1, a2, (p1, p2) => {\n    return (\n      vec3.equals(p1.getOrigin(), p2.getOrigin()) &&\n      vec3.equals(p1.getNormal(), p2.getNormal())\n    );\n  });\n}\n\nexport const useCropStore = defineStore('crop', () => {\n  const imageStore = useImageStore();\n\n  const state = reactive({\n    croppingByImageID: {} as Record<string, LPSCroppingPlanes>,\n  });\n\n  const getComputedVTKPlanes = (imageID: MaybeRef<string | null>) =>\n    computed(() => {\n      const id = unref(imageID);\n      if (id && id in state.croppingByImageID && id in imageStore.metadata) {\n        const cropBounds = state.croppingByImageID[id];\n        const metadata = imageStore.metadata[id];\n        return [\n          convertCropBoundsToVTKPlane(cropBounds, metadata, 'Sagittal', 0),\n          convertCropBoundsToVTKPlane(cropBounds, metadata, 'Sagittal', 1),\n          convertCropBoundsToVTKPlane(cropBounds, metadata, 'Coronal', 0),\n          convertCropBoundsToVTKPlane(cropBounds, metadata, 'Coronal', 1),\n          convertCropBoundsToVTKPlane(cropBounds, metadata, 'Axial', 0),\n          convertCropBoundsToVTKPlane(cropBounds, metadata, 'Axial', 1),\n        ];\n      }\n      return null;\n    });\n\n  const clampCroppingPlanes = (\n    imageID: string,\n    planes: LPSCroppingPlanes\n  ): LPSCroppingPlanes => {\n    const lpsBounds = getImageSpatialExtent(imageID);\n    // if perf becomes an issue, change this to modify the planes arg\n    return {\n      Sagittal: clampRangeToBounds(planes.Sagittal, lpsBounds.Sagittal),\n      Coronal: clampRangeToBounds(planes.Coronal, lpsBounds.Coronal),\n      Axial: clampRangeToBounds(planes.Axial, lpsBounds.Axial),\n    };\n  };\n\n  const setCropping = (imageID: string, planes: LPSCroppingPlanes) => {\n    state.croppingByImageID[imageID] = clampCroppingPlanes(imageID, planes);\n  };\n\n  const setCroppingForAxis = (\n    imageID: string,\n    axis: LPSAxis,\n    planes: Vector2\n  ) => {\n    if (imageID in state.croppingByImageID) {\n      setCropping(imageID, {\n        ...state.croppingByImageID[imageID],\n        [axis]: planes,\n      });\n    }\n  };\n\n  const resetCropping = (imageID: string) => {\n    const image = imageStore.dataIndex[imageID];\n    if (!image) return;\n\n    const { lpsOrientation } = imageStore.metadata[imageID];\n    const extent = image.getSpatialExtent();\n    setCropping(imageID, {\n      Sagittal: getAxisBounds(extent, 'Sagittal', lpsOrientation),\n      Coronal: getAxisBounds(extent, 'Coronal', lpsOrientation),\n      Axial: getAxisBounds(extent, 'Axial', lpsOrientation),\n    });\n  };\n\n  function serialize(stateFile: StateFile) {\n    const { tools } = stateFile.manifest;\n    tools.crop = state.croppingByImageID;\n  }\n\n  function deserialize(manifest: Manifest, dataIDMap: Record<string, string>) {\n    const cropping = manifest.tools.crop;\n\n    Object.entries(cropping).forEach(([imageID, planes]) => {\n      const newImageID = dataIDMap[imageID];\n      setCropping(newImageID, planes);\n    });\n  }\n\n  return {\n    croppingByImageID: readonly(state.croppingByImageID),\n    getComputedVTKPlanes,\n    setCropping,\n    setCroppingForAxis,\n    resetCropping,\n    serialize,\n    deserialize,\n  };\n});\n","import type { Bounds, Vector3 } from '@kitware/vtk.js/types';\nimport vtkStateBuilder from '@kitware/vtk.js/Widgets/Core/StateBuilder';\nimport vtkWidgetState from '@kitware/vtk.js/Widgets/Core/WidgetState';\nimport { mat4 } from 'gl-matrix';\n\nexport interface CrosshairsHandleWidgetState extends vtkWidgetState {\n  setOrigin(origin: Vector3 | null): boolean;\n  getOrigin(): Vector3 | null;\n  setScale1(scale: number): boolean;\n  getScale1(): number;\n  setVisible(visible: boolean): boolean;\n  getVisible(): boolean;\n  setBounds(bounds: Bounds): boolean;\n  getBounds(): Bounds;\n}\n\nexport interface CrosshairsWidgetState extends vtkWidgetState {\n  setPlaced(placed: boolean): boolean;\n  getPlaced(): boolean;\n  setIndexToWorld(indexToWorld: mat4): boolean;\n  getIndexToWorld(): mat4;\n  setWorldToIndex(worldToIndex: mat4): boolean;\n  getWorldToIndex(): mat4;\n  getHandle(): CrosshairsHandleWidgetState;\n}\n\nexport default function generateState() {\n  return vtkStateBuilder\n    .createBuilder()\n    .addField({\n      name: 'placed',\n      initialValue: false,\n    })\n    .addField({\n      name: 'indexToWorld',\n      initialValue: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n    })\n    .addField({\n      name: 'worldToIndex',\n      initialValue: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n    })\n    .addStateFromMixin({\n      labels: ['handle'],\n      mixins: ['origin', 'bounds'],\n      name: 'handle',\n      initialValues: {\n        origin: null,\n      },\n    })\n    .build();\n}\n","import macro from '@kitware/vtk.js/macro';\nimport type { Bounds } from '@kitware/vtk.js/types';\nimport { vec3 } from 'gl-matrix';\n\nfunction clampPointToBounds(bounds: Bounds, point: vec3) {\n  return point.map((p, i) =>\n    Math.max(bounds[i * 2], Math.min(bounds[i * 2 + 1], p))\n  ) as vec3;\n}\n\nexport default function widgetBehavior(publicAPI: any, model: any) {\n  model.classHierarchy.push('vtkCrosshairsWidgetProp');\n  let isDragging = false;\n\n  // support setting per-view widget manipulators\n  macro.setGet(publicAPI, model, ['manipulator']);\n\n  // --------------------------------------------------------------------------\n  // Interactor events\n  // --------------------------------------------------------------------------\n\n  function ignoreKey(e: any) {\n    return e.altKey || e.controlKey || e.shiftKey;\n  }\n\n  // --------------------------------------------------------------------------\n  // Left press: Select handle to drag\n  // --------------------------------------------------------------------------\n\n  publicAPI.handleLeftButtonPress = (e: any) => {\n    if (!model.pickable || ignoreKey(e)) {\n      return macro.VOID;\n    }\n\n    model.widgetState.setPlaced(true);\n    isDragging = true;\n    model._interactor.requestAnimation(publicAPI);\n    model._apiSpecificRenderWindow.setCursor('crosshairs');\n    publicAPI.invokeStartInteractionEvent();\n    publicAPI.handleMouseMove(e);\n    return macro.EVENT_ABORT;\n  };\n\n  // --------------------------------------------------------------------------\n  // Mouse move: Drag selected handle / Handle follow the mouse\n  // --------------------------------------------------------------------------\n\n  publicAPI.handleMouseMove = (callData: any) => {\n    // technically need to call requestAnimation during\n    // the initial phase of placing the crosshairs,\n    // but that's not needed since no VTK object\n    // is actually being rendered.\n\n    if (\n      (!model.widgetState.getPlaced() || isDragging) &&\n      model.pickable &&\n      model.manipulator &&\n      !ignoreKey(callData)\n    ) {\n      const worldCoordsOfPointer = model.manipulator.handleEvent(\n        callData,\n        model._apiSpecificRenderWindow\n      );\n\n      const handle = model.widgetState.getHandle();\n      const worldToIndex = model.widgetState.getWorldToIndex();\n      const indexToWorld = model.widgetState.getIndexToWorld();\n      if (worldToIndex.length && indexToWorld.length) {\n        const indexCoordsOfPointer = vec3.create();\n        const worldOrigin = vec3.create();\n        const bounds = handle.getBounds();\n\n        vec3.transformMat4(\n          indexCoordsOfPointer,\n          worldCoordsOfPointer,\n          worldToIndex\n        );\n        const indexOrigin = clampPointToBounds(bounds, indexCoordsOfPointer);\n        vec3.transformMat4(worldOrigin, indexOrigin, indexToWorld);\n\n        handle.setOrigin(worldOrigin);\n        publicAPI.invokeInteractionEvent();\n        return macro.EVENT_ABORT;\n      }\n    }\n\n    return macro.VOID;\n  };\n\n  // --------------------------------------------------------------------------\n  // Left release: Finish drag / Create new handle\n  // --------------------------------------------------------------------------\n\n  publicAPI.handleLeftButtonRelease = () => {\n    if (isDragging && model.pickable) {\n      model._interactor.cancelAnimation(publicAPI);\n      model._apiSpecificRenderWindow.setCursor('default');\n      publicAPI.invokeEndInteractionEvent();\n    }\n    isDragging = false;\n  };\n\n  // --------------------------------------------------------------------------\n  // Focus API - modeHandle follow mouse when widget has focus\n  // --------------------------------------------------------------------------\n\n  publicAPI.grabFocus = () => {};\n\n  // --------------------------------------------------------------------------\n\n  publicAPI.loseFocus = () => {};\n}\n","import macro from '@kitware/vtk.js/macro';\nimport vtkAbstractWidgetFactory from '@kitware/vtk.js/Widgets/Core/AbstractWidgetFactory';\nimport vtkPlanePointManipulator from '@kitware/vtk.js/Widgets/Manipulators/PlaneManipulator';\n\nimport { ViewTypes } from '@kitware/vtk.js/Widgets/Core/WidgetManager/Constants';\n\nimport stateGenerator from './state';\nimport widgetBehavior from './behavior';\n\n// ----------------------------------------------------------------------------\n// Factory\n// ----------------------------------------------------------------------------\n\nfunction vtkCrosshairsWidget(publicAPI, model) {\n  model.classHierarchy.push('vtkCrosshairsWidget');\n\n  // --- Widget Requirement ---------------------------------------------------\n\n  model.behavior = widgetBehavior;\n  model.widgetState = stateGenerator();\n\n  publicAPI.getRepresentationsForViewType = (viewType) => {\n    switch (viewType) {\n      case ViewTypes.DEFAULT:\n      case ViewTypes.GEOMETRY:\n      case ViewTypes.SLICE:\n      case ViewTypes.VOLUME:\n      default:\n        return [];\n    }\n  };\n\n  // --------------------------------------------------------------------------\n  // initialization\n  // --------------------------------------------------------------------------\n\n  model.widgetState.onBoundsChange((bounds) => {\n    const center = [\n      (bounds[0] + bounds[1]) * 0.5,\n      (bounds[2] + bounds[3]) * 0.5,\n      (bounds[4] + bounds[5]) * 0.5,\n    ];\n    model.widgetState.getHandle().setOrigin(center);\n  });\n\n  // Default manipulator\n  model.manipulator = vtkPlanePointManipulator.newInstance();\n}\n\n// ----------------------------------------------------------------------------\n\nconst DEFAULT_VALUES = {\n  // manipulator: null,\n};\n\n// ----------------------------------------------------------------------------\n\nexport function extend(publicAPI, model, initialValues = {}) {\n  Object.assign(model, DEFAULT_VALUES, initialValues);\n\n  vtkAbstractWidgetFactory.extend(publicAPI, model, initialValues);\n  macro.setGet(publicAPI, model, ['manipulator']);\n\n  vtkCrosshairsWidget(publicAPI, model);\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(extend, 'vtkCrosshairsWidget');\n\n// ----------------------------------------------------------------------------\n\nexport default { newInstance, extend };\n","import { Maybe } from '../types';\n\nexport type DoubleKeyRecord<V> = Record<string, Record<string, V>>;\n\n/* eslint-disable no-param-reassign */\n\nexport function patchDoubleKeyRecord<V>(\n  record: DoubleKeyRecord<V>,\n  k1: string,\n  k2: string,\n  patch: Partial<V>\n) {\n  if (!(k1 in record)) {\n    record[k1] = {};\n  }\n\n  // triggers shallow record[k1][k2] watchers\n  record[k1][k2] = {\n    ...record[k1][k2],\n    ...patch,\n  };\n}\n\nexport function deleteSecondKey<V>(record: DoubleKeyRecord<V>, k2: string) {\n  Object.keys(record).forEach((k1) => {\n    delete record[k1][k2];\n  });\n}\n\n/* eslint-enable no-param-reassign */\n\nexport function getDoubleKeyRecord<V>(\n  record: DoubleKeyRecord<V>,\n  k1: Maybe<string>,\n  k2: Maybe<string>\n): Maybe<V> {\n  if (k1 == null || k2 == null) return null;\n  return record[k1]?.[k2];\n}\n","import { DoubleKeyRecord } from '@/src/utils/doubleKeyRecord';\nimport { StateFile, ViewConfig } from '../../io/state-file/schema';\nimport {\n  CameraConfig,\n  LayersConfig,\n  SliceConfig,\n  VolumeColorConfig,\n  WindowLevelConfig,\n} from './types';\nimport { ensureDefault } from '../../utils';\n\ntype SubViewConfig =\n  | CameraConfig\n  | SliceConfig\n  | VolumeColorConfig\n  | WindowLevelConfig\n  | LayersConfig;\n\ntype ViewConfigGetter = (\n  viewID: string,\n  dataID: string\n) => SubViewConfig | undefined;\n\ntype ViewConfigStateKey = keyof ViewConfig;\n\nexport const serializeViewConfig = <K extends ViewConfigStateKey>(\n  stateFile: StateFile,\n  configGetter: ViewConfigGetter,\n  viewConfigStateKey: K\n) => {\n  const dataIDs = stateFile.manifest.datasets.map((dataset) => dataset.id);\n  const { views } = stateFile.manifest;\n\n  views.forEach((view) => {\n    dataIDs.forEach((dataID) => {\n      const { config } = view;\n\n      const viewConfig = configGetter(view.id, dataID);\n      if (viewConfig !== undefined) {\n        const configForData = ensureDefault(dataID, config, {} as ViewConfig);\n\n        configForData[viewConfigStateKey] = viewConfig as ViewConfig[K];\n      }\n    });\n  });\n};\n\nexport const serializeViewConfigV2 = <\n  K extends ViewConfigStateKey,\n  V extends ViewConfig[K]\n>(\n  stateFile: StateFile,\n  viewConfigs: DoubleKeyRecord<V>,\n  viewConfigStateKey: K\n) => {\n  const dataIDs = stateFile.manifest.datasets.map((dataset) => dataset.id);\n  const { views } = stateFile.manifest;\n\n  views.forEach((view) => {\n    dataIDs.forEach((dataID) => {\n      const { config } = view;\n\n      const viewConfig = viewConfigs[view.id]?.[dataID];\n      if (viewConfig !== undefined) {\n        const configForData = ensureDefault(dataID, config, {} as ViewConfig);\n\n        configForData[viewConfigStateKey] = viewConfig as ViewConfig[K];\n      }\n    });\n  });\n};\n\n/**\n * @param viewConfigs Expected to be a DoubleKeyRecord. Index is ordered as (ViewID, DataID)\n * @param viewConfigStateKey\n * @returns\n */\nexport const createViewConfigSerializer = <\n  K extends ViewConfigStateKey,\n  V extends ViewConfig[K]\n>(\n  viewConfigs: DoubleKeyRecord<V>,\n  viewConfigStateKey: K\n) => {\n  return (stateFile: StateFile) => {\n    serializeViewConfigV2(stateFile, viewConfigs, viewConfigStateKey);\n  };\n};\n","import { clampValue } from '@/src/utils';\nimport { defineStore } from 'pinia';\nimport { reactive } from 'vue';\nimport {\n  DoubleKeyRecord,\n  deleteSecondKey,\n  getDoubleKeyRecord,\n  patchDoubleKeyRecord,\n} from '@/src/utils/doubleKeyRecord';\nimport { Maybe } from '@/src/types';\nimport { createViewConfigSerializer } from './common';\nimport { ViewConfig } from '../../io/state-file/schema';\nimport { SliceConfig } from './types';\n\nexport const defaultSliceConfig = (): SliceConfig => ({\n  slice: 0,\n  min: 0,\n  max: 1,\n  axisDirection: 'Inferior',\n});\n\nexport const useViewSliceStore = defineStore('viewSlice', () => {\n  const configs = reactive<DoubleKeyRecord<SliceConfig>>({});\n\n  const getConfig = (viewID: Maybe<string>, dataID: Maybe<string>) =>\n    getDoubleKeyRecord(configs, viewID, dataID);\n\n  const updateConfig = (\n    viewID: string,\n    dataID: string,\n    patch: Partial<SliceConfig>\n  ) => {\n    const config = {\n      ...defaultSliceConfig(),\n      ...getConfig(viewID, dataID),\n      ...patch,\n    };\n\n    config.slice = clampValue(config.slice, config.min, config.max);\n    patchDoubleKeyRecord(configs, viewID, dataID, config);\n  };\n\n  const resetSlice = (viewID: string, dataID: string) => {\n    const config = getConfig(viewID, dataID);\n    if (!config) return;\n\n    // Setting this to floor() will affect images where the\n    // middle slice is fractional.\n    // This is consistent with vtkImageMapper and SliceRepresentationProxy.\n    updateConfig(viewID, dataID, {\n      slice: Math.ceil((config.min + config.max) / 2),\n    });\n  };\n\n  const removeView = (viewID: string) => {\n    delete configs[viewID];\n  };\n\n  const removeData = (dataID: string, viewID?: string) => {\n    if (viewID) {\n      delete configs[viewID]?.[dataID];\n    } else {\n      deleteSecondKey(configs, dataID);\n    }\n  };\n\n  const serialize = createViewConfigSerializer(configs, 'slice');\n\n  const deserialize = (viewID: string, config: Record<string, ViewConfig>) => {\n    Object.entries(config).forEach(([dataID, viewConfig]) => {\n      if (viewConfig.slice) {\n        updateConfig(viewID, dataID, viewConfig.slice);\n      }\n    });\n  };\n\n  return {\n    configs,\n    getConfig,\n    updateConfig,\n    resetSlice,\n    removeView,\n    removeData,\n    serialize,\n    deserialize,\n  };\n});\n\nexport default useViewSliceStore;\n","import { defineStore } from 'pinia';\nimport { reactive, ref } from 'vue';\nimport {\n  DoubleKeyRecord,\n  deleteSecondKey,\n  getDoubleKeyRecord,\n  patchDoubleKeyRecord,\n} from '@/src/utils/doubleKeyRecord';\nimport { Maybe } from '@/src/types';\nimport { createViewConfigSerializer } from './common';\nimport { ViewConfig } from '../../io/state-file/schema';\nimport { WindowLevelConfig } from './types';\n\nexport const defaultWindowLevelConfig = (): WindowLevelConfig => ({\n  width: 1,\n  level: 0.5,\n  min: 0,\n  max: 1,\n});\n\nconst useWindowingStore = defineStore('windowing', () => {\n  const configs = reactive<DoubleKeyRecord<WindowLevelConfig>>({});\n  const syncAcrossViews = ref(true);\n\n  const setSyncAcrossViews = (yn: boolean) => {\n    syncAcrossViews.value = yn;\n  };\n\n  const getConfig = (viewID: Maybe<string>, dataID: Maybe<string>) =>\n    getDoubleKeyRecord(configs, viewID, dataID);\n\n  /**\n   * Syncs the window/level/min/max params of (srcViewID, srcDataID) across all views sharing the dataset.\n   * @param srcViewID\n   * @param srcDataID\n   */\n  const syncWindowLevel = (srcViewID: string, srcDataID: string) => {\n    if (!syncAcrossViews.value) return;\n\n    const config = configs[srcViewID]?.[srcDataID];\n    if (!config) return;\n\n    Object.keys(configs)\n      .filter((viewID) => viewID !== srcViewID)\n      .forEach((viewID) => {\n        patchDoubleKeyRecord(configs, viewID, srcDataID, config);\n      });\n  };\n\n  const updateConfig = (\n    viewID: string,\n    dataID: string,\n    patch: Partial<WindowLevelConfig>\n  ) => {\n    patchDoubleKeyRecord(configs, viewID, dataID, {\n      ...defaultWindowLevelConfig(),\n      ...configs[viewID]?.[dataID],\n      ...patch,\n    });\n\n    if (syncAcrossViews.value) {\n      syncWindowLevel(viewID, dataID);\n    }\n  };\n\n  const resetWindowLevel = (viewID: string, dataID: string) => {\n    const config = configs[viewID]?.[dataID];\n    if (config == null) return;\n\n    const width = config.max - config.min;\n    const level = (config.max + config.min) / 2;\n    updateConfig(viewID, dataID, { width, level });\n  };\n\n  const removeView = (viewID: string) => {\n    delete configs[viewID];\n  };\n\n  const removeData = (dataID: string, viewID?: string) => {\n    if (viewID) {\n      delete configs[viewID]?.[dataID];\n    } else {\n      deleteSecondKey(configs, dataID);\n    }\n  };\n\n  const serialize = createViewConfigSerializer(configs, 'window');\n\n  const deserialize = (viewID: string, config: Record<string, ViewConfig>) => {\n    Object.entries(config).forEach(([dataID, viewConfig]) => {\n      if (viewConfig.window) {\n        updateConfig(viewID, dataID, viewConfig.window);\n      }\n    });\n  };\n\n  return {\n    configs,\n    getConfig,\n    setSyncAcrossViews,\n    updateConfig,\n    resetWindowLevel,\n    removeView,\n    removeData,\n    serialize,\n    deserialize,\n  };\n});\n\nexport default useWindowingStore;\n","import vtkPiecewiseFunctionProxy from '@kitware/vtk.js/Proxy/Core/PiecewiseFunctionProxy';\nimport vtkColorMaps from '@kitware/vtk.js/Rendering/Core/ColorTransferFunction/ColorMaps';\nimport vtkRenderer from '@kitware/vtk.js/Rendering/Core/Renderer';\nimport vtkOpenGLRenderWindow from '@kitware/vtk.js/Rendering/OpenGL/RenderWindow';\nimport type { Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport { intersectDisplayWithPlane } from '@kitware/vtk.js/Widgets/Manipulators/PlaneManipulator';\nimport { OpacityFunction } from '../types/views';\n\nexport function computeWorldToDisplay(\n  xyz: Vector3,\n  renderer: vtkRenderer\n): Vector2 | null {\n  const view = renderer.getRenderWindow()?.getViews()?.[0];\n  if (view) {\n    const [x, y, z] = xyz;\n    return view.worldToDisplay(x, y, z, renderer);\n  }\n  return null;\n}\n\nexport function computeDisplayToWorld(\n  xy: Vector2,\n  renderer: vtkRenderer\n): Vector3 | null {\n  const view = renderer.getRenderWindow()?.getViews()?.[0];\n  if (view) {\n    const [x, y] = xy;\n    return view.displayToWorld(x, y, 0, renderer);\n  }\n  return null;\n}\n\nexport function normalizeMouseEventPosition(\n  ev: MouseEvent,\n  view: vtkOpenGLRenderWindow\n) {\n  const canvas = view.getCanvas();\n  if (!canvas) return null;\n\n  const bounds = canvas.getBoundingClientRect();\n  const scaleX = canvas.width / bounds.width;\n  const scaleY = canvas.height / bounds.height;\n  return [\n    scaleX * (ev.clientX - bounds.left),\n    scaleY * (bounds.height - ev.clientY + bounds.top),\n  ] as Vector2;\n}\n\nexport function intersectMouseEventWithPlane(\n  ev: MouseEvent,\n  renderer: vtkRenderer,\n  origin: Vector3,\n  normal: Vector3\n) {\n  const view = renderer\n    .getRenderWindow()\n    ?.getViews()[0] as vtkOpenGLRenderWindow;\n  if (!view) return null;\n\n  const position = normalizeMouseEventPosition(ev, view);\n  if (!position) return null;\n\n  return intersectDisplayWithPlane(\n    position[0],\n    position[1],\n    origin,\n    normal,\n    renderer,\n    view\n  );\n}\n\n/**\n * Converts world coordinates to SVG-friendly coordinates.\n *\n * Assumes that the SVG layer is the same size as the renderer.\n * TODO verify this is the case.\n */\nexport function worldToSVG(xyz: Vector3, renderer: vtkRenderer) {\n  const coords = computeWorldToDisplay(xyz, renderer);\n  const view = renderer.getRenderWindow()?.getViews()?.[0];\n  if (coords && view) {\n    const [, height] = view.getViewportSize(renderer);\n    // convert from canvas space to svg space\n    return [\n      coords[0] / devicePixelRatio,\n      (height - coords[1]) / devicePixelRatio,\n    ] as Vector2;\n  }\n  return null;\n}\n\n/**\n * Gets the CSS coordinates for a vtk.js mouse event.\n */\nexport function getCSSCoordinatesFromEvent(eventData: any) {\n  const { pokedRenderer }: { pokedRenderer: vtkRenderer } = eventData;\n  const view = pokedRenderer?.getRenderWindow()?.getViews()?.[0] as\n    | vtkOpenGLRenderWindow\n    | undefined;\n  const bbox = view?.getContainer()?.getBoundingClientRect();\n\n  if (!('position' in eventData) || !bbox) {\n    return null;\n  }\n\n  return [\n    bbox.left + eventData.position.x / devicePixelRatio,\n    bbox.top + bbox.height - eventData.position.y / devicePixelRatio,\n  ] as Vector2;\n}\n\n/**\n * Shifts the opacity points from a preset.\n */\nexport function getShiftedOpacityFromPreset(\n  presetName: string,\n  effectiveRange: [number, number],\n  shift: number\n) {\n  const preset = vtkColorMaps.getPresetByName(presetName);\n  if (preset.OpacityPoints) {\n    const OpacityPoints = preset.OpacityPoints as number[];\n    const points = [];\n    for (let i = 0; i < OpacityPoints.length; i += 2) {\n      points.push([OpacityPoints[i], OpacityPoints[i + 1]]);\n    }\n\n    const [xmin, xmax] = effectiveRange;\n    const width = xmax - xmin;\n    return points.map(([x, y]) => [(x - xmin) / width + shift, y]);\n  }\n  return null;\n}\n\n/**\n * Retrieves an OpacityFunction from a preset.\n */\nexport function getOpacityFunctionFromPreset(\n  presetName: string\n): Partial<OpacityFunction> {\n  const preset = vtkColorMaps.getPresetByName(presetName);\n\n  if (preset.OpacityPoints) {\n    return {\n      mode: vtkPiecewiseFunctionProxy.Mode.Points,\n      preset: presetName,\n      shift: 0,\n    };\n  }\n  return {\n    mode: vtkPiecewiseFunctionProxy.Mode.Gaussians,\n    // deep-copy necessary\n    gaussians: JSON.parse(\n      JSON.stringify(vtkPiecewiseFunctionProxy.Defaults.Gaussians)\n    ),\n  };\n}\n\n/**\n * Inflate an axis bounds defined as [min, max] by some delta.\n *\n * @param bounds Must be [number, number]. (Typed number[] for convenience.)\n * @param delta\n * @returns\n */\nexport function inflateAxisBounds(bounds: number[], delta: number) {\n  return [bounds[0] + delta, bounds[1] + delta];\n}\n\n/**\n * Retrieves the color function range, if any.\n *\n * Will only return the color function range if the preset\n * has AbsoluteRange specified as true. For medical presets,\n * the range is defined by the transfer function point range,\n * rather than the dataset data range.\n * @param presetName\n * @returns\n */\nexport function getColorFunctionRangeFromPreset(\n  presetName: string\n): [number, number] | null {\n  const preset = vtkColorMaps.getPresetByName(presetName);\n  if (!preset) return null;\n\n  const { AbsoluteRange, RGBPoints } = preset;\n  if (AbsoluteRange && RGBPoints) {\n    let min = Infinity;\n    let max = -Infinity;\n    for (let i = 0; i < RGBPoints.length; i += 4) {\n      min = Math.min(min, RGBPoints[i]);\n      max = Math.max(max, RGBPoints[i]);\n    }\n    return [min, max];\n  }\n  return null;\n}\n\n/**\n * Retrieves the effective opacity mapping range, if any.\n *\n * Presets may specify an effective range for the scalar opacity\n * mapping range.\n * @param presetName\n * @returns\n */\nexport function getOpacityRangeFromPreset(presetName: string) {\n  const preset = vtkColorMaps.getPresetByName(presetName);\n  if (preset.EffectiveRange) {\n    return [...preset.EffectiveRange] as [number, number];\n  }\n  return null;\n}\n","import vtkColorMaps from '@kitware/vtk.js/Rendering/Core/ColorTransferFunction/ColorMaps';\nimport MedicalPresets from '@/src/vtk/MedicalColorPresets.json';\n\nfunction registerPresets(presets: typeof MedicalPresets) {\n  for (let i = 0; i < presets.length; i += 1) {\n    vtkColorMaps.addPreset(presets[i]);\n  }\n}\n\nregisterPresets(MedicalPresets);\n\n/* prettier-ignore */\nconst GroupedPresets = [\n  {\n    group: 'CT',\n    presets: [\n      'CT-AAA',\n      'CT-AAA2',\n      'CT-Bone',\n      'CT-Bones',\n      'CT-Cardiac',\n      'CT-Cardiac2',\n      'CT-Cardiac3',\n      'CT-Chest-Contrast-Enhanced',\n      'CT-Chest-Vessels',\n      'CT-Coronary-Arteries',\n      'CT-Coronary-Arteries-2',\n      'CT-Coronary-Arteries-3',\n      'CT-Cropped-Volume-Bone',\n      'CT-Fat',\n      'CT-Liver-Vasculature',\n      'CT-Lung',\n      'CT-MIP',\n      'CT-Muscle',\n      'CT-Pulmonary-Arteries',\n      'CT-Soft-Tissue',\n      'CT-Air',\n      'CT-X-ray',\n    ],\n  },\n  {\n    group: 'MR',\n    presets: [\n      'MR-Default',\n      'MR-Angio',\n      'MR-MIP',\n      'MR-T2-Brain',\n    ],\n  },\n  {\n    group: 'DTI',\n    presets: [\n      'DTI-FA-Brain',\n    ],\n  },\n  {\n    group: 'US',\n    presets: [\n      'US-Fetal',\n    ],\n  },\n];\n\nexport const DEFAULT_PRESET = 'CT-AAA';\nexport const PresetNameList = GroupedPresets.flatMap((group) => group.presets);\nexport default GroupedPresets;\n","import vtkImageData from '@kitware/vtk.js/Common/DataModel/ImageData';\nimport vtkPiecewiseFunctionProxy from '@kitware/vtk.js/Proxy/Core/PiecewiseFunctionProxy';\nimport {\n  getColorFunctionRangeFromPreset,\n  getOpacityFunctionFromPreset,\n} from '@/src/utils/vtk-helpers';\nimport { ColorTransferFunction } from '@/src/types/views';\nimport { defineStore } from 'pinia';\nimport { reactive } from 'vue';\nimport {\n  DoubleKeyRecord,\n  deleteSecondKey,\n  getDoubleKeyRecord,\n  patchDoubleKeyRecord,\n} from '@/src/utils/doubleKeyRecord';\nimport { Maybe } from '@/src/types';\nimport { identity } from '@/src/utils';\nimport { createViewConfigSerializer } from './common';\nimport { DEFAULT_PRESET } from '../../vtk/ColorMaps';\nimport { ViewConfig } from '../../io/state-file/schema';\nimport { LayersConfig } from './types';\nimport { LayerID, useLayersStore } from '../datasets-layers';\nimport { useDICOMStore } from '../datasets-dicom';\n\nexport const MODALITY_TO_PRESET: Record<string, string> = {\n  PT: '2hot',\n};\n\nfunction getPreset(id: LayerID) {\n  const layersStore = useLayersStore();\n  const layer = layersStore.getLayer(id);\n  if (layer) {\n    if (layer.selection.type === 'dicom') {\n      const dicomStore = useDICOMStore();\n      const { Modality = undefined } =\n        dicomStore.volumeInfo[layer.selection.volumeKey];\n      return (Modality && MODALITY_TO_PRESET[Modality]) || DEFAULT_PRESET;\n    }\n  }\n  return DEFAULT_PRESET;\n}\n\nexport const defaultLayersConfig = (): LayersConfig => ({\n  colorBy: {\n    arrayName: '',\n    location: 'pointData',\n  },\n  transferFunction: {\n    preset: '',\n    mappingRange: [0, 1],\n  },\n  opacityFunction: {\n    mode: vtkPiecewiseFunctionProxy.Mode.Gaussians,\n    gaussians: [],\n    mappingRange: [0, 1],\n  },\n  blendConfig: { opacity: 0.6 },\n});\n\nexport const useLayerColoringStore = defineStore('layerColoring', () => {\n  const configs = reactive<DoubleKeyRecord<LayersConfig>>({});\n\n  const getConfig = (viewID: Maybe<string>, dataID: Maybe<string>) =>\n    getDoubleKeyRecord(configs, viewID, dataID);\n\n  const updateConfig = (\n    viewID: string,\n    dataID: string,\n    patch: Partial<LayersConfig>\n  ) => {\n    const config = {\n      ...defaultLayersConfig(),\n      ...getConfig(viewID, dataID),\n      ...patch,\n    };\n\n    patchDoubleKeyRecord(configs, viewID, dataID, config);\n  };\n\n  const createUpdateFunc = <K extends keyof LayersConfig>(\n    key: K,\n    transform: (config: LayersConfig[K]) => LayersConfig[K] = identity\n  ) => {\n    return (\n      viewID: string,\n      dataID: LayerID,\n      update: Partial<LayersConfig[K]>\n    ) => {\n      const config = getConfig(viewID, dataID) ?? defaultLayersConfig();\n      const updatedConfig = transform({\n        ...config[key],\n        ...update,\n      });\n      updateConfig(viewID, dataID, { [key]: updatedConfig });\n    };\n  };\n\n  const updateColorBy = createUpdateFunc('colorBy');\n  const updateColorTransferFunction = createUpdateFunc('transferFunction');\n  const updateOpacityFunction = createUpdateFunc('opacityFunction');\n  const updateBlendConfig = createUpdateFunc('blendConfig');\n\n  const setColorPreset = (viewID: string, layerID: LayerID, preset: string) => {\n    const layersStore = useLayersStore();\n    const image = layersStore.layerImages[layerID];\n    if (!image) return;\n    const imageDataRange = image.getPointData().getScalars().getRange();\n\n    const ctRange = getColorFunctionRangeFromPreset(preset);\n    const ctFunc: Partial<ColorTransferFunction> = {\n      preset,\n      mappingRange: ctRange || imageDataRange,\n    };\n    updateColorTransferFunction(viewID, layerID, ctFunc);\n\n    const opFunc = getOpacityFunctionFromPreset(preset);\n    opFunc.mappingRange = imageDataRange;\n    updateOpacityFunction(viewID, layerID, opFunc);\n  };\n\n  const resetToDefault = (\n    viewID: string,\n    dataID: LayerID,\n    image: vtkImageData\n  ) => {\n    const scalars = image.getPointData().getScalars();\n\n    updateColorBy(viewID, dataID, {\n      arrayName: scalars.getName() + dataID,\n      location: 'pointData',\n    });\n    setColorPreset(viewID, dataID, getPreset(dataID));\n  };\n\n  const removeView = (viewID: string) => {\n    delete configs[viewID];\n  };\n\n  const removeData = (dataID: string, viewID?: string) => {\n    if (viewID) {\n      delete configs[viewID]?.[dataID];\n    } else {\n      deleteSecondKey(configs, dataID);\n    }\n  };\n\n  const serialize = createViewConfigSerializer(configs, 'layers');\n\n  const deserialize = (viewID: string, config: Record<string, ViewConfig>) => {\n    Object.entries(config).forEach(([dataID, viewConfig]) => {\n      if (viewConfig.layers) {\n        updateConfig(viewID, dataID, viewConfig.layers);\n      }\n    });\n  };\n\n  return {\n    configs,\n    getConfig,\n    updateConfig,\n    updateColorBy,\n    updateColorTransferFunction,\n    updateOpacityFunction,\n    updateBlendConfig,\n    resetToDefault,\n    setColorPreset,\n    removeView,\n    removeData,\n    serialize,\n    deserialize,\n  };\n});\n\nexport default useLayerColoringStore;\n","import { defineStore } from 'pinia';\nimport {\n  DoubleKeyRecord,\n  deleteSecondKey,\n  getDoubleKeyRecord,\n  patchDoubleKeyRecord,\n} from '@/src/utils/doubleKeyRecord';\nimport { reactive } from 'vue';\nimport { Maybe } from '@/src/types';\nimport { createViewConfigSerializer } from './common';\nimport { ViewConfig } from '../../io/state-file/schema';\nimport { CameraConfig } from './types';\n\nexport const useViewCameraStore = defineStore('viewCamera', () => {\n  const configs = reactive<DoubleKeyRecord<CameraConfig>>({});\n\n  const getConfig = (viewID: Maybe<string>, dataID: Maybe<string>) =>\n    getDoubleKeyRecord(configs, viewID, dataID);\n\n  const updateConfig = (\n    viewID: string,\n    dataID: string,\n    patch: Partial<CameraConfig>\n  ) => {\n    const config = {\n      ...getConfig(viewID, dataID),\n      ...patch,\n    };\n\n    patchDoubleKeyRecord(configs, viewID, dataID, config);\n  };\n\n  const removeView = (viewID: string) => {\n    delete configs[viewID];\n  };\n\n  const removeData = (dataID: string, viewID?: string) => {\n    if (viewID) {\n      delete configs[viewID]?.[dataID];\n    } else {\n      deleteSecondKey(configs, dataID);\n    }\n  };\n\n  const serialize = createViewConfigSerializer(configs, 'camera');\n\n  const deserialize = (viewID: string, config: Record<string, ViewConfig>) => {\n    Object.entries(config).forEach(([dataID, viewConfig]) => {\n      if (viewConfig.camera) {\n        updateConfig(viewID, dataID, viewConfig.camera);\n      }\n    });\n  };\n\n  return {\n    configs,\n    getConfig,\n    updateConfig,\n    removeView,\n    removeData,\n    serialize,\n    deserialize,\n  };\n});\n\nexport default useViewCameraStore;\n","import vtkImageData from '@kitware/vtk.js/Common/DataModel/ImageData';\nimport vtkPiecewiseFunctionProxy from '@kitware/vtk.js/Proxy/Core/PiecewiseFunctionProxy';\nimport {\n  getColorFunctionRangeFromPreset,\n  getOpacityFunctionFromPreset,\n} from '@/src/utils/vtk-helpers';\nimport { DEFAULT_PRESET_BY_MODALITY } from '@/src/config';\nimport { ColorTransferFunction } from '@/src/types/views';\nimport { defineStore } from 'pinia';\nimport { reactive } from 'vue';\nimport {\n  DoubleKeyRecord,\n  deleteSecondKey,\n  getDoubleKeyRecord,\n  patchDoubleKeyRecord,\n} from '@/src/utils/doubleKeyRecord';\nimport { Maybe } from '@/src/types';\nimport { identity } from '@/src/utils';\nimport { createViewConfigSerializer } from './common';\nimport { DEFAULT_PRESET } from '../../vtk/ColorMaps';\nimport { ViewConfig } from '../../io/state-file/schema';\nimport { VolumeColorConfig } from './types';\nimport { useDICOMStore } from '../datasets-dicom';\nimport { useImageStore } from '../datasets-images';\n\nexport const DEFAULT_AMBIENT = 0.2;\nexport const DEFAULT_DIFFUSE = 0.7;\nexport const DEFAULT_SPECULAR = 0.3;\n\nfunction getPresetFromImageModality(imageID: string) {\n  const dicomStore = useDICOMStore();\n  if (imageID in dicomStore.imageIDToVolumeKey) {\n    const volKey = dicomStore.imageIDToVolumeKey[imageID];\n    const { Modality } = dicomStore.volumeInfo[volKey];\n    if (Modality in DEFAULT_PRESET_BY_MODALITY) {\n      return DEFAULT_PRESET_BY_MODALITY[Modality];\n    }\n  }\n  return DEFAULT_PRESET;\n}\n\nexport const defaultVolumeColorConfig = (): VolumeColorConfig => ({\n  colorBy: {\n    arrayName: '',\n    location: 'pointData',\n  },\n  transferFunction: {\n    preset: '',\n    mappingRange: [0, 1],\n  },\n  opacityFunction: {\n    mode: vtkPiecewiseFunctionProxy.Mode.Gaussians,\n    gaussians: [],\n    mappingRange: [0, 1],\n  },\n  cvr: {\n    enabled: true,\n    lightFollowsCamera: true,\n    volumeQuality: 2,\n    useVolumetricScatteringBlending: true,\n    volumetricScatteringBlending: 0.5,\n    useLocalAmbientOcclusion: true,\n    laoKernelRadius: 5,\n    laoKernelSize: 15,\n    ambient: DEFAULT_AMBIENT,\n    diffuse: DEFAULT_DIFFUSE,\n    specular: DEFAULT_SPECULAR,\n  },\n});\n\nexport const useVolumeColoringStore = defineStore('volumeColoring', () => {\n  const configs = reactive<DoubleKeyRecord<VolumeColorConfig>>({});\n\n  const getConfig = (viewID: Maybe<string>, dataID: Maybe<string>) =>\n    getDoubleKeyRecord(configs, viewID, dataID);\n\n  const updateConfig = (\n    viewID: string,\n    dataID: string,\n    patch: Partial<VolumeColorConfig>\n  ) => {\n    const config = {\n      ...defaultVolumeColorConfig(),\n      ...getConfig(viewID, dataID),\n      ...patch,\n    };\n\n    patchDoubleKeyRecord(configs, viewID, dataID, config);\n  };\n\n  const createUpdateFunc = <K extends keyof VolumeColorConfig>(\n    key: K,\n    transform: (config: VolumeColorConfig[K]) => VolumeColorConfig[K] = identity\n  ) => {\n    return (\n      viewID: string,\n      dataID: string,\n      update: Partial<VolumeColorConfig[K]>\n    ) => {\n      const config = getConfig(viewID, dataID) ?? defaultVolumeColorConfig();\n      const updatedConfig = transform({\n        ...config[key],\n        ...update,\n      });\n      updateConfig(viewID, dataID, { [key]: updatedConfig });\n    };\n  };\n\n  const updateColorBy = createUpdateFunc('colorBy');\n  const updateColorTransferFunction = createUpdateFunc('transferFunction');\n  const updateOpacityFunction = createUpdateFunc('opacityFunction');\n  const updateCVRParameters = createUpdateFunc('cvr');\n\n  const setColorPreset = (viewID: string, imageID: string, preset: string) => {\n    const imageStore = useImageStore();\n    const image = imageStore.dataIndex[imageID];\n    if (!image) return;\n    const imageDataRange = image.getPointData().getScalars().getRange();\n\n    const ctRange = getColorFunctionRangeFromPreset(preset);\n    const ctFunc: Partial<ColorTransferFunction> = {\n      preset,\n      mappingRange: ctRange || imageDataRange,\n    };\n    updateColorTransferFunction(viewID, imageID, ctFunc);\n\n    const opFunc = getOpacityFunctionFromPreset(preset);\n    opFunc.mappingRange = imageDataRange;\n    updateOpacityFunction(viewID, imageID, opFunc);\n  };\n\n  const resetToDefaultColoring = (\n    viewID: string,\n    dataID: string,\n    image: vtkImageData\n  ) => {\n    const scalars = image.getPointData().getScalars();\n\n    updateColorBy(viewID, dataID, {\n      arrayName: scalars.getName(),\n      location: 'pointData',\n    });\n    setColorPreset(viewID, dataID, getPresetFromImageModality(dataID));\n  };\n\n  const removeView = (viewID: string) => {\n    delete configs[viewID];\n  };\n\n  const removeData = (dataID: string, viewID?: string) => {\n    if (viewID) {\n      delete configs[viewID]?.[dataID];\n    } else {\n      deleteSecondKey(configs, dataID);\n    }\n  };\n\n  const serialize = createViewConfigSerializer(configs, 'volumeColorConfig');\n\n  const deserialize = (viewID: string, config: Record<string, ViewConfig>) => {\n    Object.entries(config).forEach(([dataID, viewConfig]) => {\n      if (viewConfig.volumeColorConfig) {\n        updateConfig(viewID, dataID, viewConfig.volumeColorConfig);\n      }\n    });\n  };\n\n  return {\n    configs,\n    getConfig,\n    updateConfig,\n    updateColorBy,\n    updateColorTransferFunction,\n    updateOpacityFunction,\n    updateCVRParameters,\n    resetToDefaultColoring,\n    setColorPreset,\n    removeView,\n    removeData,\n    serialize,\n    deserialize,\n  };\n});\n\nexport default useVolumeColoringStore;\n","import { defineStore } from 'pinia';\n\nimport useViewSliceStore from './view-configs/slicing';\nimport useWindowingStore from './view-configs/windowing';\nimport useLayerColoringStore from './view-configs/layers';\nimport useViewCameraStore from './view-configs/camera';\nimport useVolumeColoringStore from './view-configs/volume-coloring';\nimport { StateFile, ViewConfig } from '../io/state-file/schema';\nimport { useImageStore } from './datasets-images';\n\n/**\n * This store saves view configuration that is associated with a specific\n * view. The key is a synthetic id generated from the view ID and data ID.\n */\nexport const useViewConfigStore = defineStore('viewConfig', () => {\n  const viewSliceStore = useViewSliceStore();\n  const windowingStore = useWindowingStore();\n  const layerColoringStore = useLayerColoringStore();\n  const viewCameraStore = useViewCameraStore();\n  const volumeColoringStore = useVolumeColoringStore();\n\n  const removeView = (viewID: string) => {\n    viewSliceStore.removeView(viewID);\n    windowingStore.removeView(viewID);\n    layerColoringStore.removeView(viewID);\n    viewCameraStore.removeView(viewID);\n    volumeColoringStore.removeView(viewID);\n  };\n\n  const removeData = (dataID: string, viewID?: string) => {\n    viewSliceStore.removeData(dataID, viewID);\n    windowingStore.removeData(dataID, viewID);\n    layerColoringStore.removeData(dataID, viewID);\n    viewCameraStore.removeData(dataID, viewID);\n    volumeColoringStore.removeData(dataID, viewID);\n  };\n\n  const serialize = (stateFile: StateFile) => {\n    viewSliceStore.serialize(stateFile);\n    windowingStore.serialize(stateFile);\n    layerColoringStore.serialize(stateFile);\n    viewCameraStore.serialize(stateFile);\n    volumeColoringStore.serialize(stateFile);\n  };\n\n  const deserialize = (\n    viewID: string,\n    config: Record<string, ViewConfig>,\n    dataIDMap: Record<string, string>\n  ) => {\n    // First update the view config map to use the new dataIDs\n    const updatedConfig: Record<string, ViewConfig> = {};\n    Object.entries(config).forEach(([dataID, viewConfig]) => {\n      const newDataID = dataIDMap[dataID];\n      updatedConfig[newDataID] = viewConfig;\n    });\n\n    viewSliceStore.deserialize(viewID, updatedConfig);\n    windowingStore.deserialize(viewID, updatedConfig);\n    layerColoringStore.deserialize(viewID, updatedConfig);\n    viewCameraStore.deserialize(viewID, updatedConfig);\n    volumeColoringStore.deserialize(viewID, updatedConfig);\n  };\n\n  // delete hook\n  const imageStore = useImageStore();\n  imageStore.$onAction(({ name, args }) => {\n    if (name === 'deleteData') {\n      const [id] = args;\n      removeData(id);\n    }\n  });\n\n  return {\n    removeView,\n    removeData,\n    serialize,\n    deserialize,\n  };\n});\n","import vtkAbstractRepresentationProxy from '@kitware/vtk.js/Proxy/Core/AbstractRepresentationProxy';\nimport vtkViewProxy from '@kitware/vtk.js/Proxy/Core/ViewProxy';\nimport { defineStore } from 'pinia';\nimport { DefaultViewSpec, InitViewSpecs } from '../config';\nimport { ViewProxyType } from '../core/proxies';\nimport { Layout, LayoutDirection } from '../types/layout';\nimport { useViewConfigStore } from './view-configs';\nimport { ViewSpec } from '../types/views';\nimport {\n  StateFile,\n  Layout as StateFileLayout,\n  View,\n} from '../io/state-file/schema';\n\ninterface State {\n  layout: Layout;\n  viewSpecs: Record<string, ViewSpec>;\n}\n\nexport const useViewStore = defineStore('view', {\n  state: (): State => ({\n    layout: {\n      direction: LayoutDirection.V,\n      items: [],\n    },\n    viewSpecs: structuredClone(InitViewSpecs),\n  }),\n  getters: {\n    viewIDs(state) {\n      return Object.keys(state.viewSpecs);\n    },\n    getViewProxy() {\n      return <T extends vtkViewProxy>(id: string) => {\n        return this.$proxies.getView<T>(id);\n      };\n    },\n    getDataRepresentationForView() {\n      return <T extends vtkAbstractRepresentationProxy>(\n        dataID: string,\n        viewID: string\n      ) => {\n        return <T | null>(\n          this.$proxies.getDataRepresentationForView(dataID, viewID)\n        );\n      };\n    },\n  },\n  actions: {\n    createOrGetViewProxy<T extends vtkViewProxy = vtkViewProxy>(\n      id: string,\n      type: ViewProxyType\n    ) {\n      return (\n        this.$proxies.getView<T>(id) ?? <T>this.$proxies.createView(id, type)\n      );\n    },\n    addView(id: string) {\n      if (!(id in this.viewSpecs)) {\n        this.viewSpecs[id] = structuredClone(DefaultViewSpec);\n      }\n    },\n    removeView(id: string) {\n      if (id in this.viewSpecs) {\n        delete this.viewSpecs[id];\n        this.$proxies.removeView(id);\n      }\n    },\n    setLayout(layout: Layout) {\n      this.layout = layout;\n\n      const layoutsToProcess = [layout];\n      while (layoutsToProcess.length) {\n        const ly = layoutsToProcess.shift()!;\n        ly.items.forEach((item) => {\n          if (typeof item === 'string') {\n            // item is a view ID\n            this.addView(item);\n          } else {\n            layoutsToProcess.push(item);\n          }\n        });\n      }\n    },\n    serialize(stateFile: StateFile) {\n      const viewConfigStore = useViewConfigStore();\n      const { manifest } = stateFile;\n      const { views } = manifest;\n\n      manifest.layout = this.layout as StateFileLayout;\n\n      // Serialize the view specs\n      Object.entries(this.viewSpecs).forEach(([id, spec]) => {\n        const type = spec.viewType;\n        const { props } = spec;\n        const config = {};\n\n        const view = {\n          id,\n          type,\n          props,\n          config,\n        };\n\n        views.push(view);\n      });\n\n      // Serialize the view config\n      viewConfigStore.serialize(stateFile);\n    },\n    deserialize(views: View[], dataIDMap: Record<string, string>) {\n      const viewConfigStore = useViewConfigStore();\n\n      views.forEach((view) => {\n        const viewID = view.id;\n\n        const viewSpec = {\n          viewType: view.type,\n          props: view.props,\n        };\n\n        this.viewSpecs[viewID] = viewSpec;\n\n        // Now delegate the deserialization of the view config\n        const { config } = view;\n        viewConfigStore.deserialize(viewID, config, dataIDMap);\n      });\n    },\n  },\n});\n","import { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport vtkCrosshairsWidget from '@/src/vtk/CrosshairsWidget';\nimport type { Bounds, Vector3 } from '@kitware/vtk.js/types';\nimport { inflate } from '@kitware/vtk.js/Common/DataModel/BoundingBox';\nimport { computed, ref, unref, watch } from 'vue';\nimport { vec3 } from 'gl-matrix';\nimport { defineStore } from 'pinia';\nimport { getLPSAxisFromDir } from '@/src/utils/lps';\nimport { Manifest, StateFile } from '@/src/io/state-file/schema';\nimport { useViewStore } from '../views';\nimport useViewSliceStore from '../view-configs/slicing';\n\nexport const useCrosshairsToolStore = defineStore('crosshairs', () => {\n  type _This = ReturnType<typeof useCrosshairsToolStore>;\n\n  const factory = vtkCrosshairsWidget.newInstance();\n  const widgetState = factory.getWidgetState();\n  const handle = widgetState.getHandle();\n\n  const active = ref(false);\n  const { currentImageID, currentImageMetadata } = useCurrentImage();\n\n  // world-space\n  const position = ref<Vector3>([0, 0, 0]);\n  // image space\n  const imagePosition = computed(() => {\n    const out = vec3.create();\n    vec3.transformMat4(\n      out,\n      position.value,\n      currentImageMetadata.value.worldToIndex\n    );\n    return out as Vector3;\n  });\n\n  const viewSliceStore = useViewSliceStore();\n  const viewStore = useViewStore();\n\n  // only gets views that have a slicing config\n  const currentViewIDs = computed(() => {\n    const imageID = unref(currentImageID);\n    if (imageID) {\n      return viewStore.viewIDs.filter(\n        (viewID) => !!viewSliceStore.getConfig(viewID, imageID)\n      );\n    }\n    return [];\n  });\n\n  function getWidgetFactory(this: _This) {\n    return factory;\n  }\n\n  function setPosition(pos: Vector3) {\n    position.value = pos;\n  }\n\n  // update the slicing\n  watch(imagePosition, (indexPos) => {\n    if (active.value) {\n      const imageID = unref(currentImageID);\n      const { lpsOrientation } = unref(currentImageMetadata);\n\n      if (!imageID) {\n        return;\n      }\n\n      currentViewIDs.value.forEach((viewID) => {\n        const sliceConfig = viewSliceStore.getConfig(viewID, imageID);\n        const axis = getLPSAxisFromDir(sliceConfig!.axisDirection);\n        const index = lpsOrientation[axis];\n        const slice = Math.round(indexPos[index]);\n        viewSliceStore.updateConfig(viewID, imageID, { slice });\n      });\n    }\n  });\n\n  // update widget state based on current image\n  watch(\n    currentImageMetadata,\n    (metadata) => {\n      widgetState.setIndexToWorld(metadata.indexToWorld);\n      widgetState.setWorldToIndex(metadata.worldToIndex);\n      const [xDim, yDim, zDim] = metadata.dimensions;\n      const imageBounds: Bounds = [0, xDim - 1, 0, yDim - 1, 0, zDim - 1];\n      // inflate by 0.5, since the image slice rendering is inflated\n      // by 0.5.\n      handle.setBounds(inflate(imageBounds, 0.5));\n    },\n    { immediate: true }\n  );\n\n  // update the position\n  handle.onModified(() => {\n    const origin = handle.getOrigin();\n    if (origin) {\n      position.value = origin;\n    }\n  });\n\n  function activateTool() {\n    widgetState.setPlaced(false);\n    active.value = true;\n    return true;\n  }\n\n  function deactivateTool() {\n    active.value = false;\n  }\n\n  function serialize(state: StateFile) {\n    const { crosshairs } = state.manifest.tools;\n    crosshairs.position = position.value;\n  }\n\n  function deserialize(manifest: Manifest) {\n    const { crosshairs } = manifest.tools;\n    position.value = crosshairs.position;\n  }\n\n  return {\n    getWidgetFactory,\n    setPosition,\n    position,\n    imagePosition,\n    activateTool,\n    deactivateTool,\n    serialize,\n    deserialize,\n  };\n});\n","import type { Vector2 } from '@kitware/vtk.js/types';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { Manifest, StateFile } from '@/src/io/state-file/schema';\nimport { computed, ref, watch } from 'vue';\nimport { vec3 } from 'gl-matrix';\nimport { defineStore } from 'pinia';\nimport { Tools } from './types';\nimport { useLabelmapStore } from '../datasets-labelmaps';\n\nconst DEFAULT_BRUSH_SIZE = 4;\nconst DEFAULT_BRUSH_VALUE = 1;\n\nexport const usePaintToolStore = defineStore('paint', () => {\n  type _This = ReturnType<typeof usePaintToolStore>;\n\n  const activeLabelmapID = ref<string | null>(null);\n  const brushSize = ref(DEFAULT_BRUSH_SIZE);\n  const brushValue = ref(DEFAULT_BRUSH_VALUE);\n  const strokePoints = ref<vec3[]>([]);\n  const labelmapOpacity = ref(1);\n  const isActive = ref(false);\n\n  const { currentImageID } = useCurrentImage();\n\n  function getWidgetFactory(this: _This) {\n    return this.$paint.factory;\n  }\n\n  const activeLabelmap = computed(() => {\n    if (!activeLabelmapID.value) return null;\n    const labelmapStore = useLabelmapStore();\n    return labelmapStore.labelmaps[activeLabelmapID.value] ?? null;\n  });\n\n  // --- actions --- //\n\n  function selectOrCreateLabelmap(imageID: string | null) {\n    if (!imageID) {\n      activeLabelmapID.value = null;\n      return;\n    }\n\n    const labelmapStore = useLabelmapStore();\n    const found = Object.entries(labelmapStore.parentImage).find(\n      ([, parentID]) => imageID === parentID\n    );\n    if (found) {\n      [activeLabelmapID.value] = found;\n    } else {\n      activeLabelmapID.value = labelmapStore.newLabelmapFromImage(imageID);\n    }\n  }\n\n  function setBrushSize(this: _This, size: number) {\n    brushSize.value = Math.round(size);\n    this.$paint.setBrushSize(size);\n  }\n\n  function setBrushValue(this: _This, value: number) {\n    brushValue.value = value;\n    this.$paint.setBrushValue(value);\n  }\n\n  function setLabelmapOpacity(opacity: number) {\n    labelmapOpacity.value = Math.min(1, Math.max(0, opacity));\n  }\n\n  function doPaintStroke(this: _This, axisIndex: 0 | 1 | 2) {\n    if (!activeLabelmap.value) {\n      return;\n    }\n\n    const lastIndex = strokePoints.value.length - 1;\n    if (lastIndex >= 0) {\n      const lastPoint = strokePoints.value[lastIndex];\n      const prevPoint =\n        lastIndex >= 1 ? strokePoints.value[lastIndex - 1] : undefined;\n      this.$paint.paintLabelmap(\n        activeLabelmap.value,\n        axisIndex,\n        lastPoint,\n        prevPoint\n      );\n    }\n  }\n\n  function setSliceAxis(this: _This, axisIndex: 0 | 1 | 2) {\n    if (!activeLabelmap.value) return;\n    const spacing = activeLabelmap.value.getSpacing();\n    spacing.splice(axisIndex, 1);\n    const scale: Vector2 = [1 / spacing[0], 1 / spacing[1]];\n    this.$paint.setBrushScale(scale);\n  }\n\n  function startStroke(this: _This, indexPoint: vec3, axisIndex: 0 | 1 | 2) {\n    strokePoints.value = [vec3.clone(indexPoint)];\n    doPaintStroke.call(this, axisIndex);\n  }\n\n  function placeStrokePoint(\n    this: _This,\n    indexPoint: vec3,\n    axisIndex: 0 | 1 | 2\n  ) {\n    strokePoints.value.push(indexPoint);\n    doPaintStroke.call(this, axisIndex);\n  }\n\n  function endStroke(this: _This, indexPoint: vec3, axisIndex: 0 | 1 | 2) {\n    strokePoints.value.push(indexPoint);\n    doPaintStroke.call(this, axisIndex);\n  }\n\n  // --- setup and teardown --- //\n\n  function activateTool(this: _This) {\n    const imageID = currentImageID.value;\n    if (!imageID) {\n      return false;\n    }\n    selectOrCreateLabelmap(imageID);\n    this.$paint.setBrushSize(this.brushSize);\n\n    isActive.value = true;\n    return true;\n  }\n\n  function deactivateTool() {\n    activeLabelmapID.value = null;\n    isActive.value = false;\n  }\n\n  function serialize(state: StateFile) {\n    const { paint } = state.manifest.tools;\n\n    paint.activeLabelmapID = activeLabelmapID.value;\n    paint.brushSize = brushSize.value;\n    paint.brushValue = brushValue.value;\n    paint.labelmapOpacity = labelmapOpacity.value;\n  }\n\n  function deserialize(\n    this: _This,\n    manifest: Manifest,\n    labelmapIDMap: Record<string, string>\n  ) {\n    const { paint } = manifest.tools;\n    this.setBrushSize(paint.brushSize);\n    this.setBrushValue(paint.brushValue);\n    this.setLabelmapOpacity(paint.labelmapOpacity);\n    isActive.value = manifest.tools.current === Tools.Paint;\n\n    if (paint.activeLabelmapID !== null) {\n      activeLabelmapID.value = labelmapIDMap[paint.activeLabelmapID];\n    }\n  }\n\n  // --- change labelmap if paint is active --- //\n\n  watch(currentImageID, (imageID) => {\n    if (isActive.value) {\n      selectOrCreateLabelmap(imageID);\n    }\n  });\n\n  return {\n    // state\n    activeLabelmapID,\n    brushSize,\n    brushValue,\n    strokePoints,\n    labelmapOpacity,\n    isActive,\n\n    getWidgetFactory,\n\n    activateTool,\n    deactivateTool,\n\n    selectOrCreateLabelmap,\n    setBrushSize,\n    setBrushValue,\n    setLabelmapOpacity,\n    setSliceAxis,\n    startStroke,\n    placeStrokePoint,\n    endStroke,\n    serialize,\n    deserialize,\n  };\n});\n","import { vec3 } from 'gl-matrix';\nimport type { Vector3 } from '@kitware/vtk.js/types';\nimport { LPSAxis } from '../types/lps';\nimport { EPSILON } from '../constants';\nimport { roundIfCloseToInteger } from '.';\nimport { ImageMetadata } from '../types/image';\n\nconst tmp = vec3.create();\n\n/**\n * Defines a 2D plane used for locating annotations.\n */\nexport interface FrameOfReference {\n  planeNormal: Vector3;\n  planeOrigin: Vector3;\n}\n\nexport interface FrameOfReferenceToImageSliceAndAxisOptions {\n  epsilon?: number;\n  allowNonIntegralSlice?: boolean;\n  allowOutOfBoundsSlice?: boolean;\n}\n\n/**\n * Returns the image slice and LPS axis for a given frame of reference.\n *\n * If the frame of reference is not aligned to the image metadata, then null is returned.\n * @param {FrameOfReference} frame\n * @param {ImageMetadata} metadata\n * @param {FrameOfReferenceToImageSliceAndAxisOptions?} options\n */\nexport function frameOfReferenceToImageSliceAndAxis(\n  frame: FrameOfReference,\n  metadata: ImageMetadata,\n  options?: FrameOfReferenceToImageSliceAndAxisOptions\n): { axis: LPSAxis; slice: number } | null {\n  const epsilon = options?.epsilon ?? EPSILON;\n  const allowNonIntegralSlice = options?.allowNonIntegralSlice ?? false;\n  const allowOutOfBoundsSlice = options?.allowOutOfBoundsSlice ?? false;\n\n  const { planeNormal, planeOrigin } = frame;\n  const { dimensions, lpsOrientation, worldToIndex } = metadata;\n\n  let axis: LPSAxis | null = null;\n  const { Left, Right, Posterior, Anterior, Superior, Inferior } =\n    lpsOrientation;\n  if (vec3.equals(Left, planeNormal) || vec3.equals(Right, planeNormal)) {\n    axis = 'Sagittal';\n  } else if (\n    vec3.equals(Posterior, planeNormal) ||\n    vec3.equals(Anterior, planeNormal)\n  ) {\n    axis = 'Coronal';\n  } else if (\n    vec3.equals(Superior, planeNormal) ||\n    vec3.equals(Inferior, planeNormal)\n  ) {\n    axis = 'Axial';\n  }\n\n  if (!axis) {\n    return null;\n  }\n\n  vec3.transformMat4(tmp, planeOrigin, worldToIndex);\n  const index = lpsOrientation[axis];\n  const slice = roundIfCloseToInteger(tmp[index], epsilon);\n\n  if (!allowNonIntegralSlice && !Number.isInteger(slice)) {\n    return null;\n  }\n\n  if (!allowOutOfBoundsSlice && (slice < 0 || slice >= dimensions[index])) {\n    return null;\n  }\n\n  return { axis, slice };\n}\n","import { Maybe } from '@/src/types';\nimport { ref } from 'vue';\nimport { StoreActions, StoreState } from 'pinia';\nimport { useIdStore } from '../id';\n\nexport type Label<Props> = Partial<Props & { labelName: string }>;\nexport type Labels<Props> = Record<string, Label<Props>>;\n\ntype LabelID = string;\n\nconst labelDefault = { labelName: 'New Label' };\n\n// param newLabelDefault should contain all label controlled props\n// of the tool so placing tool does hold any last active label props.\nexport const useLabels = <Props>(newLabelDefault: Label<Props>) => {\n  type ToolLabel = Label<Props>;\n\n  const labels = ref<Labels<Props>>({});\n\n  const activeLabel = ref<string | undefined>();\n  const setActiveLabel = (id: string) => {\n    activeLabel.value = id;\n  };\n\n  const addLabel = (label: ToolLabel = {}) => {\n    const id = useIdStore().nextId();\n    labels.value[id] = {\n      ...labelDefault,\n      ...newLabelDefault,\n      ...label,\n    };\n\n    setActiveLabel(id);\n    return id;\n  };\n\n  const deleteLabel = (id: LabelID) => {\n    if (!(id in labels.value)) throw new Error('Label does not exist');\n\n    delete labels.value[id];\n    labels.value = { ...labels.value }; // trigger reactive update for measurement list\n\n    // pick another active label if deleted was active\n    if (id === activeLabel.value) {\n      const labelIDs = Object.keys(labels.value);\n      if (labelIDs.length !== 0) setActiveLabel(labelIDs[0]);\n      else setActiveLabel('');\n    }\n  };\n\n  const updateLabel = (id: LabelID, patch: ToolLabel) => {\n    if (!(id in labels.value)) throw new Error('Label does not exist');\n\n    labels.value = { ...labels.value, [id]: { ...labels.value[id], ...patch } };\n  };\n\n  // Flag to indicate if should clear existing labels\n  const defaultLabels = ref(true);\n\n  const clearDefaultLabels = () => {\n    if (defaultLabels.value) labels.value = {};\n    defaultLabels.value = false;\n  };\n\n  /*\n   * If new label have the same name as existing label, overwrite existing label.\n   *\n   * param label: label to merge\n   * param clearDefault: if true, clear initial labels, do nothing if initial labels already cleared\n   */\n  const mergeLabel = (label: ToolLabel, clearDefault: boolean = true) => {\n    if (clearDefault) clearDefaultLabels();\n\n    const { labelName } = label;\n    const sameLabelName = Object.entries(labels.value).find(\n      ([, { labelName: existingName }]) => existingName === labelName\n    );\n\n    if (sameLabelName) {\n      const [existingID] = sameLabelName;\n      updateLabel(existingID, label);\n      return existingID;\n    }\n\n    return addLabel(label);\n  };\n\n  /*\n   * If new label have the same name as existing label, overwrite existing label.\n   *\n   * param newLabels: each key is the label name\n   * param clearDefault: if true, clear initial labels, do nothing if initial labels already cleared\n   */\n  const mergeLabels = (\n    newLabels: Maybe<Labels<Props>>,\n    clearDefault: boolean = true\n  ) => {\n    Object.entries(newLabels ?? {}).forEach(([labelName, props]) =>\n      mergeLabel({ ...props, labelName }, clearDefault)\n    );\n  };\n\n  return {\n    labels,\n    activeLabel,\n    setActiveLabel,\n    addLabel,\n    deleteLabel,\n    updateLabel,\n    mergeLabel,\n    mergeLabels,\n  };\n};\n\ntype UseLabels<Tool> = ReturnType<typeof useLabels<Tool>>;\n\nexport type LabelsStore<Tool> = StoreState<UseLabels<Tool>> &\n  StoreActions<UseLabels<Tool>>;\n","import { Ref, computed, ref, watch } from 'vue';\nimport { Store } from 'pinia';\n\nimport { Maybe, PartialWithRequired } from '@/src/types';\nimport { TOOL_COLORS } from '@/src/config';\nimport { removeFromArray } from '@/src/utils';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { frameOfReferenceToImageSliceAndAxis } from '@/src/utils/frameOfReference';\nimport { useViewStore } from '@/src/store/views';\nimport { getLPSAxisFromDir } from '@/src/utils/lps';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport { AnnotationTool } from '@/src/types/annotationTool';\nimport { findImageID, getDataID } from '@/src/store/datasets';\nimport { useIdStore } from '@/src/store/id';\nimport useViewSliceStore from '../view-configs/slicing';\nimport { useLabels, Labels, Label } from './useLabels';\n\nconst makeAnnotationToolDefaults = () => ({\n  frameOfReference: {\n    planeOrigin: [0, 0, 0],\n    planeNormal: [1, 0, 0],\n  },\n  slice: -1,\n  imageID: '',\n  placing: false,\n  color: TOOL_COLORS[0],\n  name: 'baseAnnotationTool',\n});\n\n// Must return addTool in consuming Pinia store.\nexport const useAnnotationTool = <\n  MakeToolDefaults extends (...args: any) => any,\n  LabelProps\n>({\n  toolDefaults,\n  initialLabels,\n  newLabelDefault,\n}: {\n  toolDefaults: MakeToolDefaults;\n  initialLabels: Labels<LabelProps>;\n  newLabelDefault: Label<LabelProps>;\n}) => {\n  type ToolDefaults = ReturnType<MakeToolDefaults>;\n  type Tool = ToolDefaults & AnnotationTool;\n  type ToolPatch = Partial<Omit<Tool, 'id'>>;\n  type ToolID = Tool['id'];\n\n  // cast to Ref<ToolID[]> needed. https://github.com/vuejs/core/issues/2136#issuecomment-693524663\n  const toolIDs = ref<ToolID[]>([]) as Ref<ToolID[]>;\n  const toolByID = ref<Record<ToolID, Tool>>(Object.create(null)) as Ref<\n    Record<ToolID, Tool>\n  >;\n\n  const tools = computed(() => {\n    const byID = toolByID.value;\n    return toolIDs.value.map((id) => byID[id]);\n  });\n\n  const labels = useLabels<LabelProps>(newLabelDefault);\n  labels.mergeLabels(initialLabels, false);\n\n  function makePropsFromLabel(label: string | undefined) {\n    if (!label) return { labelName: '' };\n\n    const labelProps = labels.labels.value[label];\n    if (labelProps) return labelProps;\n\n    // if label deleted, remove label name from tool\n    return { labelName: '' };\n  }\n\n  function addTool(this: Store, tool: ToolPatch): ToolID {\n    const id = useIdStore().nextId() as ToolID;\n    if (id in toolByID.value) {\n      throw new Error('Cannot add tool with conflicting ID');\n    }\n\n    toolByID.value[id] = {\n      ...makeAnnotationToolDefaults(),\n      ...toolDefaults(),\n      label: labels.activeLabel.value,\n      ...tool,\n      // updates label props if changed between sessions\n      ...makePropsFromLabel(tool.label),\n      id,\n    };\n\n    toolIDs.value.push(id);\n    return id;\n  }\n\n  function removeTool(id: ToolID) {\n    if (!(id in toolByID.value)) return;\n\n    removeFromArray(toolIDs.value, id);\n    delete toolByID.value[id];\n  }\n\n  function updateTool(id: ToolID, patch: ToolPatch) {\n    if (!(id in toolByID.value)) return;\n\n    toolByID.value[id] = { ...toolByID.value[id], ...patch, id };\n  }\n\n  // updates props controlled by labels\n  watch(labels.labels, () => {\n    toolIDs.value.forEach((id) => {\n      const tool = toolByID.value[id];\n      const propsFromLabel = makePropsFromLabel(tool.label);\n      updateTool(id, { ...tool, ...propsFromLabel });\n    });\n  });\n\n  function jumpToTool(toolID: ToolID) {\n    const tool = toolByID.value[toolID];\n    const { currentImageID, currentImageMetadata } = useCurrentImage();\n\n    const imageID = currentImageID.value;\n    if (!imageID || tool.imageID !== imageID) return;\n\n    const toolImageFrame = frameOfReferenceToImageSliceAndAxis(\n      tool.frameOfReference,\n      currentImageMetadata.value\n    );\n\n    if (!toolImageFrame) return;\n\n    const viewStore = useViewStore();\n    const relevantViewIDs = viewStore.viewIDs.filter((viewID) => {\n      const viewSpec = viewStore.viewSpecs[viewID];\n      const viewDir = viewSpec.props.viewDirection as LPSAxisDir | undefined;\n      return viewDir && getLPSAxisFromDir(viewDir) === toolImageFrame.axis;\n    });\n\n    const viewSliceStore = useViewSliceStore();\n    relevantViewIDs.forEach((viewID) => {\n      viewSliceStore.updateConfig(viewID, imageID, {\n        slice: tool.slice!,\n      });\n    });\n  }\n\n  const activateTool = () => true;\n  const deactivateTool = () => {};\n\n  const serialize = () => {\n    const toolsSerialized = toolIDs.value\n      .map((toolID) => toolByID.value[toolID])\n      .filter((tool) => !tool.placing)\n      .map(({ imageID, ...rest }) => ({\n        // If parent image is DICOM, save VolumeKey\n        imageID: getDataID(imageID),\n        ...rest,\n      }));\n\n    return {\n      tools: toolsSerialized,\n      labels: labels.labels.value,\n    };\n  };\n\n  type Serialized = {\n    tools: PartialWithRequired<Tool, 'imageID'>[];\n    labels: Labels<Tool>;\n  };\n  function deserialize(\n    this: Store,\n    serialized: Maybe<Serialized>,\n    dataIDMap: Record<string, string>\n  ) {\n    const labelIDMap = Object.fromEntries(\n      Object.entries(serialized?.labels ?? {}).map(([id, label]) => {\n        const newID = labels.mergeLabel(label); // side effect\n        return [id, newID];\n      })\n    );\n\n    serialized?.tools\n      .map(\n        ({ imageID, label, ...rest }) =>\n          ({\n            ...rest,\n            imageID: findImageID(dataIDMap[imageID]),\n            label: (label && labelIDMap[label]) || '',\n          } as ToolPatch)\n      )\n      .forEach((tool) => addTool.call(this, tool));\n  }\n\n  return {\n    ...labels,\n    toolIDs,\n    toolByID,\n    tools,\n    addTool,\n    removeTool,\n    updateTool,\n    jumpToTool,\n    activateTool,\n    deactivateTool,\n    serialize,\n    deserialize,\n  };\n};\n","import { computed } from 'vue';\nimport { defineStore } from 'pinia';\nimport type { Vector3 } from '@kitware/vtk.js/types';\nimport { distance2BetweenPoints } from '@kitware/vtk.js/Common/Core/Math';\n\nimport { RULER_LABEL_DEFAULTS } from '@/src/config';\nimport { Manifest, StateFile } from '@/src/io/state-file/schema';\n\nimport { useAnnotationTool } from './useAnnotationTool';\n\nconst rulerDefaults = () => ({\n  firstPoint: [0, 0, 0] as Vector3,\n  secondPoint: [0, 0, 0] as Vector3,\n  id: '',\n  name: 'Ruler',\n});\n\nconst newLabelDefault = {\n  color: '#ffffff',\n};\n\nexport const useRulerStore = defineStore('ruler', () => {\n  type _This = ReturnType<typeof useRulerStore>;\n\n  const {\n    toolIDs: rulerIDs,\n    toolByID: rulerByID,\n    tools: rulers,\n    addTool: addRuler,\n    updateTool: updateRuler,\n    removeTool: removeRuler,\n    jumpToTool: jumpToRuler,\n    serialize: serializeTool,\n    deserialize: deserializeTool,\n    activateTool,\n    deactivateTool,\n    ...rest // label tools\n  } = useAnnotationTool({\n    toolDefaults: rulerDefaults,\n    initialLabels: RULER_LABEL_DEFAULTS,\n    newLabelDefault,\n  });\n\n  const lengthByID = computed<Record<string, number>>(() => {\n    const byID = rulerByID.value;\n    return rulerIDs.value.reduce((lengths, id) => {\n      const { firstPoint, secondPoint } = byID[id];\n      return Object.assign(lengths, {\n        [id]: Math.sqrt(distance2BetweenPoints(firstPoint, secondPoint)),\n      });\n    }, {});\n  });\n\n  // --- serialization --- //\n\n  function serialize(state: StateFile) {\n    state.manifest.tools.rulers = serializeTool();\n  }\n\n  function deserialize(\n    this: _This,\n    manifest: Manifest,\n    dataIDMap: Record<string, string>\n  ) {\n    deserializeTool.call(this, manifest.tools.rulers, dataIDMap);\n  }\n\n  return {\n    ...rest,\n    rulerIDs,\n    rulerByID,\n    rulers,\n    lengthByID,\n    addRuler,\n    updateRuler,\n    removeRuler,\n    jumpToRuler,\n    serialize,\n    deserialize,\n    activateTool,\n    deactivateTool,\n  };\n});\n","import { defineStore } from 'pinia';\nimport type { Vector3 } from '@kitware/vtk.js/types';\nimport { Manifest, StateFile } from '@/src/io/state-file/schema';\nimport { RECTANGLE_LABEL_DEFAULTS } from '@/src/config';\nimport { RectangleID } from '@/src/types/rectangle';\n\nimport { useAnnotationTool } from './useAnnotationTool';\n\nconst rectangleDefaults = () => ({\n  firstPoint: [0, 0, 0] as Vector3,\n  secondPoint: [0, 0, 0] as Vector3,\n  id: '' as RectangleID,\n  name: 'Rectangle',\n  fillColor: 'transparent',\n});\n\nconst newLabelDefault = {\n  color: '#ffffff',\n  fillColor: 'transparent',\n};\n\nexport const useRectangleStore = defineStore('rectangles', () => {\n  type _This = ReturnType<typeof useRectangleStore>;\n\n  const {\n    serialize: serializeTool,\n    deserialize: deserializeTool,\n    ...toolStoreProps\n  } = useAnnotationTool({\n    toolDefaults: rectangleDefaults,\n    initialLabels: RECTANGLE_LABEL_DEFAULTS,\n    newLabelDefault,\n  });\n\n  // --- serialization --- //\n\n  function serialize(state: StateFile) {\n    state.manifest.tools.rectangles = serializeTool();\n  }\n\n  function deserialize(\n    this: _This,\n    manifest: Manifest,\n    dataIDMap: Record<string, string>\n  ) {\n    deserializeTool.call(this, manifest.tools.rectangles, dataIDMap);\n  }\n\n  return {\n    ...toolStoreProps,\n    serialize,\n    deserialize,\n  };\n});\n","import { Maybe } from '@/src/types';\nimport { FrameOfReference } from '@/src/utils/frameOfReference';\nimport { Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport { mat3, mat4, vec2, vec3 } from 'gl-matrix';\n\n/**\n * Reference frame from a 2D (x,y[,0]) coord to 3D coord.\n *\n * Represents a transform from an IJ slice (K=0) to an XYZ slice.\n *\n * See the implementation of getReferencePlaneFromSlice for construction.\n */\nexport interface ReferencePlane {\n  /**\n   * The transform from 2D to 3D\n   */\n  t: mat4;\n  /**\n   * Internal cache of the inverse of t.\n   */\n  _tInv: Maybe<mat4>;\n}\n\nexport function createReferencePlane(): ReferencePlane {\n  return {\n    t: mat4.create(),\n    _tInv: null,\n  };\n}\n\nconst tmp3d = vec3.create();\nconst tmpMat3 = mat3.create();\n\nexport function transform2dTo3d(\n  pt2d: Vector2,\n  refPlane: ReferencePlane,\n  out?: Vector3\n): Vector3 {\n  const _out = out ?? vec3.create();\n  vec3.set(tmp3d, pt2d[0], pt2d[1], 0);\n  vec3.transformMat4(_out, tmp3d, refPlane.t);\n  return _out as Vector3;\n}\n\nfunction invertMat4(m: mat4): mat4 {\n  const minv = mat4.create();\n  mat4.invert(minv, m);\n  return minv;\n}\n\nexport function getInverse(refPlane: ReferencePlane): mat4 {\n  // eslint-disable-next-line no-param-reassign\n  refPlane._tInv = refPlane._tInv ?? invertMat4(refPlane.t);\n  return refPlane._tInv;\n}\n\nexport function transform3dTo2d(\n  pt3d: Vector3,\n  refPlane: ReferencePlane,\n  out?: Vector2\n): Vector2 {\n  const _out = out ?? vec2.create();\n  const inv = getInverse(refPlane);\n  vec3.transformMat4(tmp3d, pt3d, inv);\n  vec2.set(_out, tmp3d[0], tmp3d[1]);\n  return _out as Vector2;\n}\n\nexport function referencePlaneToFrame(\n  refPlane: ReferencePlane\n): FrameOfReference {\n  // the reference plane is implicitly defined\n  // as centered at 0,0,0 with a +Z normal\n  const origin: Vector3 = [0, 0, 0];\n  vec3.transformMat4(origin, origin, refPlane.t);\n\n  const normal: Vector3 = [0, 0, 1];\n  // extract just rotation\n  mat3.fromMat4(tmpMat3, refPlane.t);\n  vec3.transformMat3(normal, normal, tmpMat3);\n  vec3.normalize(normal, normal);\n\n  return {\n    planeNormal: normal,\n    planeOrigin: origin,\n  };\n}\n\nconst SliceAxisTransforms: Record<0 | 1 | 2, mat4> = {\n  0: mat4.fromValues(0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1),\n  1: mat4.fromValues(1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1),\n  2: mat4.create(),\n};\n\nexport function getReferencePlaneFromSlice(\n  indexToWorld: mat4,\n  slice: number,\n  sliceAxis: 0 | 1 | 2\n): ReferencePlane {\n  const t = mat4.create();\n  // z=0 to z=slice\n  mat4.fromTranslation(t, [0, 0, slice]);\n  // rotate to correct slice axis\n  mat4.mul(t, SliceAxisTransforms[sliceAxis], t);\n  mat4.mul(t, indexToWorld, t);\n  const a = {\n    t,\n    _tInv: invertMat4(t),\n  };\n\n  return a;\n}\n","import { createReferencePlane } from '@/src/core/contours/referencePlane';\nimport { Maybe } from '@/src/types';\nimport { defineStore } from 'pinia';\nimport { ContourID } from '@/src/types/contour';\nimport { ref } from 'vue';\nimport { useAnnotationTool } from './useAnnotationTool';\n\nexport enum ContourToolMode {\n  Select = 'Select',\n  FreehandDraw = 'FreehandDraw',\n  CircleNudge = 'CircleNudge',\n  PointPlacing = 'PointPlacing',\n  Threshold = 'Threshold',\n}\n\nconst makeContourDefaults = () => ({\n  id: '' as ContourID,\n  name: 'Contour',\n  polyLine: [] as number[],\n  // TODO this likely will share a ref\n  referencePlane: createReferencePlane(),\n});\n\nconst useContourStore = defineStore('contour', () => {\n  // type This = ReturnType<typeof contourStore>;\n\n  const selectedContourID = ref<Maybe<ContourID>>();\n  const mode = ref<ContourToolMode>(ContourToolMode.FreehandDraw);\n\n  // ignore serialize/deserialize fow now\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  const { serialize, deserialize, ...toolStoreProps } = useAnnotationTool({\n    toolDefaults: makeContourDefaults,\n    initialLabels: {\n      'Default label': { color: '#ff0000' },\n    },\n    newLabelDefault: { color: '#ff0000' },\n  });\n\n  function selectContour(id: Maybe<ContourID>) {\n    selectedContourID.value = id;\n  }\n\n  // extend removeTool to handle selectedContourID case\n  function removeTool(id: ContourID) {\n    if (selectedContourID.value === id) {\n      selectedContourID.value = null;\n    }\n    return toolStoreProps.removeTool(id);\n  }\n\n  function setMode(toolMode: ContourToolMode) {\n    mode.value = toolMode;\n  }\n\n  return {\n    ...toolStoreProps,\n    removeTool,\n    // do not support serialization for now\n    serialize: () => {},\n    deserialize: () => {},\n    selectedContourID,\n    mode,\n    selectContour,\n    setMode,\n  };\n});\n\nexport default useContourStore;\n","import { Manifest, StateFile } from '@/src/io/state-file/schema';\nimport { defineStore } from 'pinia';\nimport { useCropStore } from './crop';\nimport { useCrosshairsToolStore } from './crosshairs';\nimport { usePaintToolStore } from './paint';\nimport { useRulerStore } from './rulers';\nimport { useRectangleStore } from './rectangles';\nimport { Tools } from './types';\nimport useContourStore from './contours';\n\ninterface State {\n  currentTool: Tools;\n}\n\nexport interface IToolStore {\n  activateTool: () => boolean;\n  deactivateTool: () => void;\n}\n\nfunction getStore(tool: Tools): IToolStore | null {\n  if (tool === Tools.Ruler) {\n    return useRulerStore();\n  }\n  if (tool === Tools.Rectangle) {\n    return useRectangleStore();\n  }\n  if (tool === Tools.Paint) {\n    return usePaintToolStore();\n  }\n  if (tool === Tools.Crosshairs) {\n    return useCrosshairsToolStore();\n  }\n  if (tool === Tools.Contour) {\n    return useContourStore();\n  }\n  return null;\n}\n\n/**\n * Returns true if the tool is ready to be\n * activated. By default, a tool without a\n * store setup() will be activated.\n */\nfunction setupTool(tool: Tools) {\n  const store = getStore(tool);\n  if (store) {\n    return store.activateTool();\n  }\n  return true;\n}\n\nfunction teardownTool(tool: Tools) {\n  const store = getStore(tool);\n  if (store) {\n    store.deactivateTool();\n  }\n}\n\nexport const useToolStore = defineStore('tool', {\n  state: (): State => ({\n    currentTool: Tools.WindowLevel,\n  }),\n  actions: {\n    setCurrentTool(tool: Tools) {\n      if (!setupTool(tool)) {\n        return;\n      }\n      teardownTool(this.currentTool);\n      this.currentTool = tool;\n    },\n    serialize(state: StateFile) {\n      const { tools } = state.manifest;\n      const rulerStore = useRulerStore();\n      const rectangleStore = useRectangleStore();\n      const crosshairsStore = useCrosshairsToolStore();\n      const paintStore = usePaintToolStore();\n      const cropStore = useCropStore();\n\n      rulerStore.serialize(state);\n      rectangleStore.serialize(state);\n      crosshairsStore.serialize(state);\n      paintStore.serialize(state);\n      cropStore.serialize(state);\n\n      tools.current = this.currentTool;\n    },\n    deserialize(\n      manifest: Manifest,\n      labelmapIDMap: Record<string, string>,\n      dataIDMap: Record<string, string>\n    ) {\n      const { tools } = manifest;\n      const rulerStore = useRulerStore();\n      const rectangleStore = useRectangleStore();\n      const crosshairsStore = useCrosshairsToolStore();\n      const paintStore = usePaintToolStore();\n      const cropStore = useCropStore();\n\n      rulerStore.deserialize(manifest, dataIDMap);\n      rectangleStore.deserialize(manifest, dataIDMap);\n      crosshairsStore.deserialize(manifest);\n      paintStore.deserialize(manifest, labelmapIDMap);\n      cropStore.deserialize(manifest, dataIDMap);\n      this.currentTool = tools.current;\n    },\n  },\n});\n","import JSZip from 'jszip';\nimport { useDatasetStore } from '@/src/store/datasets';\nimport { useLabelmapStore } from '@/src/store/datasets-labelmaps';\nimport { useLayersStore } from '@/src/store/datasets-layers';\nimport { useToolStore } from '@/src/store/tools';\nimport { Tools } from '@/src/store/tools/types';\nimport { useViewStore } from '@/src/store/views';\nimport { LayoutDirection } from '@/src/types/layout';\nimport { Manifest } from './schema';\n\nimport { retypeFile } from '../io';\nimport { ARCHIVE_FILE_TYPES } from '../mimeTypes';\n\nexport const MANIFEST = 'manifest.json';\nexport const MANIFEST_VERSION = '2.1.0';\n\nexport async function serialize() {\n  const datasetStore = useDatasetStore();\n  const viewStore = useViewStore();\n  const labelStore = useLabelmapStore();\n  const toolStore = useToolStore();\n  const layersStore = useLayersStore();\n\n  const zip = new JSZip();\n  const manifest: Manifest = {\n    version: MANIFEST_VERSION,\n    datasets: [],\n    remoteFiles: {},\n    labelMaps: [],\n    tools: {\n      crosshairs: {\n        position: [0, 0, 0],\n      },\n      paint: {\n        activeLabelmapID: null,\n        brushSize: 8,\n        brushValue: 1,\n        labelmapOpacity: 1,\n      },\n      crop: {},\n      current: Tools.WindowLevel,\n    },\n    layout: {\n      direction: LayoutDirection.H,\n      items: [],\n    },\n    views: [],\n    parentToLayers: [],\n  };\n\n  const stateFile = {\n    zip,\n    manifest,\n  };\n\n  await datasetStore.serialize(stateFile);\n  viewStore.serialize(stateFile);\n  await labelStore.serialize(stateFile);\n  toolStore.serialize(stateFile);\n  await layersStore.serialize(stateFile);\n\n  zip.file(MANIFEST, JSON.stringify(manifest));\n\n  return zip.generateAsync({ type: 'blob' });\n}\n\nexport async function isStateFile(file: File) {\n  const typedFile = await retypeFile(file);\n  if (ARCHIVE_FILE_TYPES.has(typedFile.type)) {\n    const zip = await JSZip.loadAsync(typedFile);\n\n    return zip.file(MANIFEST) !== null;\n  }\n\n  return false;\n}\n","import { ImportHandler } from '@/src/io/import/common';\n\n/**\n * Ends a pipeline execution, returning the final data source.\n * @param dataSource\n * @returns\n */\nconst doneWithDataSource: ImportHandler = (dataSource, { done }) => {\n  return done({ dataSource });\n};\n\nexport default doneWithDataSource;\n","import { getFileMimeType } from '@/src/io';\nimport { ImportHandler } from '@/src/io/import/common';\n\n/**\n * Transforms a file data source to have a mime type\n * @param dataSource\n */\nconst updateFileMimeType: ImportHandler = async (dataSource) => {\n  let src = dataSource;\n  const { fileSrc } = src;\n  if (fileSrc && fileSrc.fileType === '') {\n    const mime = await getFileMimeType(fileSrc.file);\n    if (mime) {\n      src = {\n        ...src,\n        fileSrc: {\n          ...fileSrc,\n          fileType: mime,\n        },\n      };\n    }\n  }\n  return src;\n};\n\nexport default updateFileMimeType;\n","import { Dataset, Manifest, ManifestSchema } from '@/src/io/state-file/schema';\nimport { FileEntry } from '@/src/io/types';\nimport * as path from '@/src/utils/path';\nimport {\n  ArchiveContents,\n  ImportContext,\n  ImportHandler,\n  ImportResult,\n} from '@/src/io/import/common';\nimport {\n  DataSource,\n  DataSourceWithFile,\n  fileToDataSource,\n} from '@/src/io/import/dataSource';\nimport { MANIFEST, isStateFile } from '@/src/io/state-file';\nimport { ensureError, partition } from '@/src/utils';\nimport Pipeline, { PipelineContext } from '@/src/core/pipeline';\nimport { Awaitable } from '@vueuse/core';\nimport doneWithDataSource from '@/src/io/import/processors/doneWithDataSource';\nimport { useDICOMStore } from '@/src/store/datasets-dicom';\nimport { useViewStore } from '@/src/store/views';\nimport {\n  DataSelection,\n  makeDICOMSelection,\n  makeImageSelection,\n  useDatasetStore,\n} from '@/src/store/datasets';\nimport { useLabelmapStore } from '@/src/store/datasets-labelmaps';\nimport { useToolStore } from '@/src/store/tools';\nimport { useLayersStore } from '@/src/store/datasets-layers';\nimport { extractFilesFromZip } from '@/src/io/zip';\nimport downloadUrl from '@/src/io/import/processors/downloadUrl';\nimport updateFileMimeType from '@/src/io/import/processors/updateFileMimeType';\nimport extractArchiveTarget from '@/src/io/import/processors/extractArchiveTarget';\n\nconst resolveUriSource: ImportHandler = async (dataSource, { extra, done }) => {\n  const { uriSrc } = dataSource;\n\n  if (uriSrc) {\n    const result = await new Pipeline([\n      downloadUrl,\n      updateFileMimeType,\n      doneWithDataSource,\n    ]).execute(dataSource, extra);\n    if (!result.ok) {\n      throw result.errors[0].cause;\n    }\n    // downloadUrl returns the fully resolved data source.\n    // We call done here since we've resolved the UriSource\n    // and no more processing is needed.\n    return done({\n      dataSource: result.data[0].dataSource,\n    });\n  }\n\n  return dataSource;\n};\n\nconst processParentIfNoFile: ImportHandler = async (\n  dataSource,\n  { execute }\n) => {\n  const { fileSrc, parent } = dataSource;\n  if (!fileSrc && parent) {\n    const result = await execute(parent);\n    if (!result.ok) {\n      throw new Error('Could not process parent', {\n        cause: ensureError(result.errors[0].cause),\n      });\n    }\n    // update the parent\n    return {\n      ...dataSource,\n      parent: result.data[0].dataSource,\n    };\n  }\n  return dataSource;\n};\n\nconst resolveArchiveMember: ImportHandler = async (\n  dataSource,\n  { extra, done }\n) => {\n  if (dataSource.archiveSrc) {\n    const pipeline = new Pipeline([\n      extractArchiveTarget,\n      updateFileMimeType,\n      doneWithDataSource,\n    ]);\n    const result = await pipeline.execute(dataSource, extra);\n    if (!result.ok) {\n      throw result.errors[0].cause;\n    }\n    // extractArchiveTarget returns the fully resolved data source.\n    return done({\n      dataSource: result.data[0].dataSource,\n    });\n  }\n  return dataSource;\n};\n\nfunction getDataSourcesForDataset(\n  dataset: Dataset,\n  manifest: Manifest,\n  stateFileContents: FileEntry[]\n) {\n  const inStateFile = stateFileContents\n    .filter(\n      (entry) =>\n        path.normalize(entry.archivePath) === path.normalize(dataset.path)\n    )\n    .map((entry) => fileToDataSource(entry.file));\n  const remotes = manifest.remoteFiles[dataset.id] ?? [];\n  return [...inStateFile, ...remotes];\n}\n\nasync function restoreDatasets(\n  manifest: Manifest,\n  datasetFiles: FileEntry[],\n  { extra, execute }: PipelineContext<DataSource, ImportResult, ImportContext>\n) {\n  const archiveCache = new Map<File, Awaitable<ArchiveContents>>();\n\n  // normalize archive paths for comparison\n  const stateDatasetFiles = datasetFiles.map((datasetFile) => {\n    return {\n      ...datasetFile,\n      archivePath: path.normalize(datasetFile.archivePath),\n    };\n  });\n\n  const { datasets } = manifest;\n  // Mapping of the state file ID => new store ID\n  const stateIDToStoreID: Record<string, string> = {};\n\n  // This pipeline resolves data sources that have remote provenance.\n  const resolvePipeline = new Pipeline([\n    updateFileMimeType,\n    resolveUriSource,\n    // process parent after resolving the uri source, so we don't\n    // unnecessarily download ancestor UriSources.\n    processParentIfNoFile,\n    resolveArchiveMember,\n    doneWithDataSource,\n  ]);\n\n  await Promise.all(\n    datasets.map(async (dataset) => {\n      let datasetDataSources = getDataSourcesForDataset(\n        dataset,\n        manifest,\n        stateDatasetFiles\n      );\n\n      // resolve any remote data sources or archive members\n      datasetDataSources = await Promise.all(\n        datasetDataSources.map(async (source) => {\n          const result = await resolvePipeline.execute(source, {\n            ...extra,\n            archiveCache,\n          });\n          if (!result.ok) {\n            throw result.errors[0].cause;\n          }\n          return result.data[0].dataSource;\n        })\n      );\n\n      // do the import\n      const dicomSources: DataSourceWithFile[] = [];\n      const importResults = await Promise.all(\n        datasetDataSources.map((source) =>\n          execute(source, {\n            ...extra,\n            archiveCache,\n            dicomDataSources: dicomSources,\n          })\n        )\n      );\n\n      if (dicomSources.length) {\n        const dicomStore = useDICOMStore();\n        const volumeKeys = await dicomStore.importFiles(dicomSources);\n        if (volumeKeys.length !== 1) {\n          throw new Error('Obtained more than one volume from DICOM import');\n        }\n\n        const [key] = volumeKeys;\n        // generate imageID so rulers and labelmaps can use stateIDToStoreID to setup there internal imageStore imageID references\n        await dicomStore.buildVolume(key);\n        stateIDToStoreID[dataset.id] = key;\n      } else if (importResults.length === 1) {\n        if (!importResults[0].ok) {\n          throw importResults[0].errors[0].cause;\n        }\n\n        const [result] = importResults;\n        if (result.data.length !== 1) {\n          throw new Error(\n            'Import encountered multiple volumes for a single dataset'\n          );\n        }\n\n        const { dataID } = result.data[0];\n        if (!dataID) {\n          throw new Error('Failed to import dataset');\n        }\n\n        stateIDToStoreID[dataset.id] = dataID;\n      } else {\n        throw new Error('Could not load any data from the session');\n      }\n    })\n  );\n\n  return stateIDToStoreID;\n}\n\nconst restoreStateFile: ImportHandler = async (\n  dataSource,\n  { done, extra, execute }\n) => {\n  const { fileSrc } = dataSource;\n  if (fileSrc && (await isStateFile(fileSrc.file))) {\n    const stateFileContents = await extractFilesFromZip(fileSrc.file);\n\n    const [manifests, restOfStateFile] = partition(\n      (dataFile) => dataFile.file.name === MANIFEST,\n      stateFileContents\n    );\n\n    if (manifests.length !== 1) {\n      throw new Error('State file does not have exactly 1 manifest');\n    }\n\n    const manifest = ManifestSchema.parse(\n      JSON.parse(await manifests[0].file.text())\n    );\n\n    // We restore the view first, so that the appropriate watchers are triggered\n    // in the views as the data is loaded\n    useViewStore().setLayout(manifest.layout);\n\n    const stateIDToStoreID = await restoreDatasets(manifest, restOfStateFile, {\n      extra,\n      execute,\n      done,\n    });\n\n    // Restore the primary selection\n    if (manifest.primarySelection !== undefined) {\n      const selectedID = stateIDToStoreID[manifest.primarySelection];\n      let dataSelection: DataSelection | undefined;\n\n      if (selectedID in useDICOMStore().volumeInfo) {\n        dataSelection = makeDICOMSelection(selectedID);\n      } else {\n        dataSelection = makeImageSelection(selectedID);\n      }\n\n      useDatasetStore().setPrimarySelection(dataSelection);\n    }\n\n    // Restore the views\n    useViewStore().deserialize(manifest.views, stateIDToStoreID);\n\n    // Restore the labelmaps\n    const labelmapIDMap = await useLabelmapStore().deserialize(\n      manifest,\n      restOfStateFile,\n      stateIDToStoreID\n    );\n\n    // Restore the tools\n    useToolStore().deserialize(manifest, labelmapIDMap, stateIDToStoreID);\n\n    useLayersStore().deserialize(manifest, stateIDToStoreID);\n\n    return done();\n  }\n  return dataSource;\n};\n\nexport default restoreStateFile;\n","import { z } from 'zod';\n\nimport { ImportHandler } from '@/src/io/import/common';\nimport { useRectangleStore } from '@/src/store/tools/rectangles';\nimport { useRulerStore } from '@/src/store/tools/rulers';\n\nconst Color = z.string();\n\nconst Label = z.object({\n  color: Color,\n});\n\nconst RulerLabel = Label;\n\nconst RectangleLabel = z.intersection(\n  Label,\n  z.object({\n    fillColor: Color,\n  })\n);\n\nconst Config = z.object({\n  labels: z.record(Label).or(z.null()).optional(),\n  rulerLabels: z.record(RulerLabel).or(z.null()).optional(),\n  rectangleLabels: z.record(RectangleLabel).or(z.null()).optional(),\n});\n\nconst readConfigFile = async (configFile: File) => {\n  const decoder = new TextDecoder();\n  const ab = await configFile.arrayBuffer();\n  const text = decoder.decode(new Uint8Array(ab));\n  return Config.parse(JSON.parse(text));\n};\n\nconst applyConfig = (manifest: z.infer<typeof Config>) => {\n  // pass through null labels, use fallback labels if undefined\n  const labelsIfUndefined = (toolLabels: typeof manifest.labels) => {\n    if (toolLabels === undefined) return manifest.labels;\n    return toolLabels;\n  };\n  useRulerStore().mergeLabels(labelsIfUndefined(manifest.rulerLabels));\n  useRectangleStore().mergeLabels(labelsIfUndefined(manifest.rectangleLabels));\n};\n\n/**\n * Reads a JSON file with label config and updates stores.\n * @param dataSource\n * @returns\n */\nconst handleConfig: ImportHandler = async (dataSource, { done }) => {\n  const { fileSrc } = dataSource;\n  if (fileSrc?.fileType === 'application/json') {\n    try {\n      const manifest = await readConfigFile(fileSrc.file);\n      applyConfig(manifest);\n    } catch (err) {\n      return dataSource;\n    }\n    return done();\n  }\n  return dataSource;\n};\n\nexport default handleConfig;\n","import Pipeline, { PipelineResult } from '@/src/core/pipeline';\nimport { ImportHandler, ImportResult } from '@/src/io/import/common';\nimport { DataSource, DataSourceWithFile } from '@/src/io/import/dataSource';\nimport handleDicomFile from '@/src/io/import/processors/handleDicomFile';\nimport downloadUrl from '@/src/io/import/processors/downloadUrl';\nimport extractArchive from '@/src/io/import/processors/extractArchive';\nimport extractArchiveTargetFromCache from '@/src/io/import/processors/extractArchiveTarget';\nimport handleAmazonS3 from '@/src/io/import/processors/handleAmazonS3';\nimport handleGoogleCloudStorage from '@/src/io/import/processors/handleGoogleCloudStorage';\nimport importSingleFile from '@/src/io/import/processors/importSingleFile';\nimport handleRemoteManifest from '@/src/io/import/processors/remoteManifest';\nimport restoreStateFile from '@/src/io/import/processors/restoreStateFile';\nimport updateFileMimeType from '@/src/io/import/processors/updateFileMimeType';\nimport handleConfig from '@/src/io/import/processors/handleConfig';\nimport { useDICOMStore } from '@/src/store/datasets-dicom';\nimport { makeDICOMSelection, makeImageSelection } from '@/src/store/datasets';\n\nexport type ImportDataSourcesResult = PipelineResult<DataSource, ImportResult>;\n\nexport function convertSuccessResultToDataSelection(\n  result: ImportDataSourcesResult\n) {\n  if (result.data.length === 0) {\n    return null;\n  }\n\n  const { dataID, dataType } = result.data[0];\n  if (!dataID) {\n    return null;\n  }\n\n  if (dataType === 'dicom') {\n    return makeDICOMSelection(dataID);\n  }\n\n  if (dataType === 'image') {\n    return makeImageSelection(dataID);\n  }\n\n  return null;\n}\n\n/**\n * Tries to turn a thrown object into a meaningful error string.\n * @param error\n * @returns\n */\nfunction toMeaningfulErrorString(thrown: unknown) {\n  const strThrown = String(thrown);\n  if (!strThrown || strThrown === '[object Object]') {\n    return 'Unknown error. More details in the dev console.';\n  }\n  return strThrown;\n}\n\nconst unhandledResource: ImportHandler = () => {\n  throw new Error('Failed to handle resource');\n};\n\nexport async function importDataSources(dataSources: DataSource[]) {\n  const middleware: Array<ImportHandler> = [\n    // updating the file type should be first in the pipeline\n    updateFileMimeType,\n    // handleConfig must before restoreStateFile for label props to be applied to deserialized tools\n    handleConfig,\n    restoreStateFile,\n    handleRemoteManifest,\n    handleGoogleCloudStorage,\n    handleAmazonS3,\n    downloadUrl,\n    extractArchiveTargetFromCache,\n    extractArchive,\n    // should be before importSingleFile, since DICOM is more specific\n    handleDicomFile,\n    importSingleFile,\n    // catch any unhandled resource\n    unhandledResource,\n  ];\n\n  const importContext = {\n    fetchFileCache: new Map<string, File>(),\n    dicomDataSources: [] as DataSourceWithFile[],\n  };\n\n  const pipeline = new Pipeline(middleware);\n  const results = await Promise.all(\n    dataSources.map((r) => pipeline.execute(r, importContext))\n  );\n\n  if (!importContext.dicomDataSources.length) {\n    return results;\n  }\n\n  // handle DICOM loading\n\n  const dicomDataSource: DataSource = {\n    dicomSrc: {\n      sources: importContext.dicomDataSources,\n    },\n  };\n  const dicomResult: PipelineResult<DataSource, ImportResult> = {\n    ok: true,\n    data: [],\n    errors: [],\n  };\n\n  try {\n    const volumeKeys = await useDICOMStore().importFiles(\n      importContext.dicomDataSources\n    );\n    dicomResult.data.push(\n      ...volumeKeys.map((key) => ({\n        dataID: key,\n        dataType: 'dicom' as const,\n        dataSource: dicomDataSource,\n      }))\n    );\n  } catch (err) {\n    dicomResult.ok = false;\n    dicomResult.errors.push({\n      message: toMeaningfulErrorString(err),\n      cause: err,\n      inputDataStackTrace: [dicomDataSource],\n    });\n  }\n\n  // remove all results that have no result data\n  return [...results.filter((result) => result.data.length), dicomResult];\n}\n","<template>\n  <v-btn\n    variant=\"text\"\n    :rounded=\"0\"\n    dark\n    :height=\"sizeV\"\n    :width=\"sizeV\"\n    :min-width=\"sizeV\"\n    :max-width=\"sizeV\"\n    :class=\"classV\"\n    v-bind=\"$attrs\"\n  >\n    <v-icon :size=\"iconSize\">{{ icon }}</v-icon>\n    <v-tooltip\n      :location=\"tooltipLocation\"\n      activator=\"parent\"\n      transition=\"slide-x-transition\"\n    >\n      <span>{{ name }}</span>\n    </v-tooltip>\n    <slot />\n  </v-btn>\n</template>\n\n<script>\nexport default {\n  name: 'ToolButton',\n  props: {\n    icon: { type: String, required: true },\n    name: { type: String, required: true },\n    size: { type: [Number, String], default: 40 },\n    buttonClass: [String, Array, Object],\n    tooltipLocation: { type: String, default: 'right' },\n  },\n\n  computed: {\n    sizeV() {\n      return Number(this.size);\n    },\n    iconSize() {\n      return Math.floor(0.6 * this.sizeV);\n    },\n    classV() {\n      const classSpec = this.buttonClass;\n      if (typeof classSpec === 'string') {\n        return classSpec;\n      }\n      if (Array.isArray(classSpec)) {\n        return classSpec.join(' ');\n      }\n      if (classSpec && Object.keys(classSpec).length) {\n        return Object.keys(this.buttonClass)\n          .filter((key) => this.buttonClass[key])\n          .join(' ');\n      }\n      return '';\n    },\n  },\n};\n</script>\n","import { onUnmounted } from 'vue';\nimport type { vtkSubscription } from '@kitware/vtk.js/interfaces';\n\nexport function manageVTKSubscription(subscription: vtkSubscription) {\n  onUnmounted(() => subscription.unsubscribe());\n}\n","import { ref } from 'vue';\nimport vtkCamera from '@kitware/vtk.js/Rendering/Core/Camera';\nimport { manageVTKSubscription } from '@src/composables/manageVTKSubscription';\nimport { vec3 } from 'gl-matrix';\n\nexport function useResizeToFit(\n  camera: vtkCamera,\n  initialValue: boolean = false\n) {\n  const resizeToFit = ref(initialValue);\n\n  let trackResizeToFit = true;\n  const cachedCameraInfo = {\n    position: [0, 0, 0] as vec3,\n    parallelScale: 0,\n  };\n\n  manageVTKSubscription(\n    camera.onModified(() => {\n      if (trackResizeToFit && resizeToFit.value) {\n        const position = camera.getPosition();\n        const parallelScale = camera.getParallelScale();\n        if (\n          !vec3.equals(position, cachedCameraInfo.position) ||\n          parallelScale !== cachedCameraInfo.parallelScale\n        ) {\n          resizeToFit.value = false;\n        }\n      }\n    })\n  );\n\n  function ignoreResizeToFitTracking(cb: () => void) {\n    if (trackResizeToFit) {\n      trackResizeToFit = false;\n      try {\n        cb();\n      } finally {\n        trackResizeToFit = true;\n      }\n    }\n  }\n\n  function resetResizeToFitTracking() {\n    cachedCameraInfo.position = camera.getPosition();\n    cachedCameraInfo.parallelScale = camera.getParallelScale();\n  }\n\n  return { resizeToFit, ignoreResizeToFitTracking, resetResizeToFitTracking };\n}\n","<template>\n  <div\n    class=\"slice-slider\"\n    ref=\"handleContainer\"\n    @pointerdown=\"onDragStart\"\n    @pointermove=\"onDragMove\"\n    @pointerup=\"onDragEnd\"\n    @pointercancel=\"onDragEnd\"\n    @contextmenu=\"$event.preventDefault()\"\n  >\n    <div class=\"slice-slider-track\" />\n    <div\n      class=\"slice-slider-handle\"\n      ref=\"handle\"\n      :style=\"{\n        height: `${handleHeight}px`,\n        transform: `translate3d(0, ${handlePosition}px, 0)`,\n      }\"\n    />\n  </div>\n</template>\n\n<script>\nfunction getYOffsetFromTransform(matStr) {\n  if (!matStr || matStr === 'none') {\n    return 0;\n  }\n  const values = matStr\n    .match(/matrix(?:3d)?\\((.+)\\)/)[1]\n    .split(',')\n    .map((v) => Number(v));\n  const is3D = matStr.includes('3d');\n  return is3D ? values[13] : values[5];\n}\n\nexport default {\n  props: {\n    slice: {\n      type: Number,\n      default: 0,\n    },\n    min: {\n      type: Number,\n      required: true,\n    },\n    max: {\n      type: Number,\n      required: true,\n    },\n    step: {\n      type: Number,\n      required: true,\n    },\n    handleHeight: {\n      type: Number,\n      default: 20,\n    },\n  },\n\n  data() {\n    return {\n      maxHandlePos: 0,\n      dragging: false,\n      initialHandlePos: 0,\n      initialMousePosY: 0,\n      yOffset: 0,\n    };\n  },\n\n  computed: {\n    handlePosition() {\n      const range = this.max - this.min <= 0 ? 1 : this.max - this.min;\n      const pos = this.maxHandlePos * ((this.slice - this.min) / range);\n      return this.dragging ? this.draggingHandlePos : pos;\n    },\n    draggingHandlePos() {\n      return Math.min(\n        Math.max(0, this.initialHandlePos + this.yOffset),\n        this.maxHandlePos\n      );\n    },\n  },\n\n  mounted() {\n    this.updateMaxHandlePos();\n    this.resizeObserver = new ResizeObserver((entries) => {\n      if (entries.length === 1) {\n        this.updateMaxHandlePos();\n      }\n    });\n    this.resizeObserver.observe(this.$refs.handleContainer);\n  },\n\n  beforeUnmount() {\n    this.resizeObserver.disconnect();\n  },\n\n  methods: {\n    updateMaxHandlePos() {\n      this.maxHandlePos =\n        this.$refs.handleContainer.clientHeight - this.handleHeight;\n    },\n\n    onDragStart(ev) {\n      ev.preventDefault();\n\n      this.dragging = true;\n      this.initialMousePosY = ev.pageY;\n\n      if (ev.target === this.$refs.handle) {\n        const handleStyles = window.getComputedStyle(this.$refs.handle);\n        this.initialHandlePos = getYOffsetFromTransform(handleStyles.transform);\n      } else {\n        // move handle to mouse pos\n        const { y } = this.$refs.handleContainer.getBoundingClientRect();\n        this.initialHandlePos = Math.max(\n          0,\n          Math.min(this.maxHandlePos, ev.pageY - y - this.handleHeight / 2)\n        );\n        const newSlice = this.getNearestSlice(this.initialHandlePos);\n        this.$emit('input', newSlice);\n      }\n\n      this.yOffset = 0;\n\n      this.$refs.handleContainer.setPointerCapture(ev.pointerId);\n    },\n\n    onDragMove(ev) {\n      if (!this.$refs.handleContainer.hasPointerCapture(ev.pointerId)) return;\n      ev.preventDefault();\n\n      this.yOffset = ev.pageY - this.initialMousePosY;\n      const slice = this.getNearestSlice(this.handlePosition);\n      this.$emit('input', slice);\n    },\n\n    onDragEnd(ev) {\n      if (!this.$refs.handleContainer.hasPointerCapture(ev.pointerId)) return;\n      ev.preventDefault();\n      this.$refs.handleContainer.releasePointerCapture(ev.pointerId);\n\n      this.dragging = false;\n      const slice = this.getNearestSlice(this.handlePosition);\n      this.$emit('input', slice);\n    },\n\n    getNearestSlice(pos) {\n      const sliceEstimate = pos / this.maxHandlePos;\n      const frac = sliceEstimate * (this.max - this.min) + this.min;\n      return Math.round(frac / this.step) * this.step;\n    },\n  },\n};\n</script>\n\n<style scoped>\n.slice-slider {\n  touch-action: none;\n}\n\n.slice-slider-handle {\n  position: relative;\n  width: 100%;\n  background: #ccc;\n  box-sizing: border-box;\n  border-radius: 3px;\n  border: 1px solid #999;\n}\n\n.slice-slider-track {\n  position: absolute;\n  margin: 0 auto;\n  top: 8px;\n  left: 0;\n  right: 0;\n  bottom: 8px;\n  width: 1px;\n  border: 1px solid #888;\n  border-radius: 2px;\n}\n</style>\n","<template>\n  <div :class=\"$style.gridRoot\">\n    <div :class=\"[$style.top, $style.row]\">\n      <div :class=\"[$style.left, $style.cell]\">\n        <slot name=\"top-left\" />\n      </div>\n      <div :class=\"[$style.center, $style.cell]\">\n        <slot name=\"top-center\" />\n      </div>\n      <div :class=\"[$style.right, $style.cell]\">\n        <slot name=\"top-right\" />\n      </div>\n    </div>\n    <div :class=\"[$style.middle, $style.row]\">\n      <div :class=\"[$style.left, $style.cell]\">\n        <slot name=\"middle-left\" />\n      </div>\n      <div :class=\"[$style.center, $style.cell]\">\n        <slot name=\"middle-center\" />\n      </div>\n      <div :class=\"[$style.right, $style.cell]\">\n        <slot name=\"middle-right\" />\n      </div>\n    </div>\n    <div :class=\"[$style.bottom, $style.row]\">\n      <div :class=\"[$style.left, $style.cell]\">\n        <slot name=\"bottom-left\" />\n      </div>\n      <div :class=\"[$style.center, $style.cell]\">\n        <slot name=\"bottom-center\" />\n      </div>\n      <div :class=\"[$style.right, $style.cell]\">\n        <slot name=\"bottom-right\" />\n      </div>\n    </div>\n  </div>\n</template>\n\n<style module>\n.gridRoot {\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  align-items: stretch;\n}\n\n.row {\n  flex: 1;\n  display: flex;\n  flex-direction: row;\n  align-items: stretch;\n}\n\n.cell {\n  flex: 1;\n}\n\n.top,\n.left {\n  align-items: flex-start;\n}\n\n.center,\n.middle {\n  align-items: center;\n}\n\n.bottom,\n.right {\n  align-items: flex-end;\n}\n\n.left {\n  text-align: left;\n}\n\n.center {\n  text-align: center;\n}\n\n.right {\n  text-align: right;\n}\n</style>\n","import { onBeforeUnmount, Ref, unref, watch } from 'vue';\n\n/**\n * Invokes a callback whenever an element is resized.\n */\nexport function useResizeObserver(\n  targetElRef: Ref<Element | null | undefined>,\n  callback: (entry: ResizeObserverEntry) => void\n) {\n  const observer = new ResizeObserver((entries) => {\n    if (entries.length === 1) {\n      callback(entries[0]);\n    }\n  });\n\n  watch(\n    targetElRef,\n    (targetEl, prevTarget) => {\n      if (prevTarget) {\n        observer.unobserve(prevTarget);\n      }\n      if (targetEl) {\n        observer.observe(targetEl);\n      }\n    },\n    { immediate: true }\n  );\n\n  onBeforeUnmount(() => {\n    const targetEl = unref(targetElRef);\n    if (targetEl) {\n      observer.unobserve(targetEl);\n    }\n  });\n\n  return observer;\n}\n","import type { vtkSubscription } from '@kitware/vtk.js/interfaces';\nimport { isRef, onUnmounted, watchEffect } from 'vue';\nimport { MaybeRef } from '@vueuse/core';\n\ntype Listener = (obj: any) => void;\ntype VTKCallback = (listener: Listener) => vtkSubscription;\n\nexport function useVTKCallback(\n  callback: MaybeRef<VTKCallback | null | undefined>\n) {\n  const handleListener = (listener: Listener) => {\n    let subscription: vtkSubscription | null = null;\n\n    const cleanup = () => {\n      subscription?.unsubscribe();\n      subscription = null;\n    };\n    onUnmounted(cleanup);\n\n    if (isRef(callback)) {\n      watchEffect(() => {\n        cleanup();\n        if (callback.value) {\n          subscription = callback.value(listener);\n        }\n      });\n    } else if (callback) {\n      subscription = callback(listener);\n    }\n  };\n\n  return handleListener;\n}\n","import { computed, Ref, ref } from 'vue';\nimport { vec3 } from 'gl-matrix';\nimport type { Vector3 } from '@kitware/vtk.js/types';\nimport vtkViewProxy from '@kitware/vtk.js/Proxy/Core/ViewProxy';\nimport { EPSILON } from '../constants';\nimport { useVTKCallback } from './useVTKCallback';\n\nexport function toOrderedLabels(vec: Vector3) {\n  return (\n    vec\n      .map((v, i) => ({ value: v, axis: i }))\n      // remove components close to zero, since we won't show those labels\n      .filter(({ value }) => Math.abs(value) > EPSILON)\n      // sort from largest to smallest component\n      .sort((a, b) => Math.abs(b.value) - Math.abs(a.value))\n      // apply labels\n      .map(({ value, axis }) => (Math.sign(value) === 1 ? 'LPS' : 'RAI')[axis])\n      .join('')\n  );\n}\n\n/**\n * Computes orientation labels for a given view.\n *\n * Labels are with respect to the current camera orientation.\n *\n * vtk.js coordinate coordinate is implied to be LPS, so orientation labels\n * are determined solely from the camera' direction and view-up.\n */\nexport function useOrientationLabels(view: Ref<vtkViewProxy>) {\n  const camera = computed(() => view.value.getCamera());\n\n  const top = ref('');\n  const left = ref('');\n  const bottom = ref('');\n  const right = ref('');\n\n  function updateAxes() {\n    const vup = camera.value.getViewUp();\n    const vdir = camera.value.getDirectionOfProjection();\n    const vright = [0, 0, 0] as Vector3;\n\n    // vup and vdir should not be parallel for cameras\n    vec3.cross(vright, vdir, vup);\n\n    const vbottom = vup.map((c) => c * -1) as Vector3;\n    const vleft = vright.map((c) => c * -1) as Vector3;\n\n    top.value = toOrderedLabels(vup);\n    right.value = toOrderedLabels(vright);\n    bottom.value = toOrderedLabels(vbottom);\n    left.value = toOrderedLabels(vleft);\n  }\n\n  const cameraOnModified = useVTKCallback(\n    computed(() => camera.value.onModified)\n  );\n  cameraOnModified(updateAxes);\n  updateAxes();\n\n  return { top, right, bottom, left };\n}\n","import { computed, Ref, unref } from 'vue';\nimport { MaybeRef } from '@vueuse/core';\nimport { mat3 } from 'gl-matrix';\nimport { ImageMetadata } from '../types/image';\nimport { LPSAxisDir } from '../types/lps';\nimport { getLPSDirections } from '../utils/lps';\n\n/**\n *\n * @param {Ref<LPSAxisDir>} viewDirection an LPS view look-direction\n * @param {Ref<LPSAxisDir>} viewUp an LPS view up-direction\n * @param {Ref<ImageMetadata>} imageMetadataRef image metadata\n */\nexport function useCameraOrientation(\n  viewDirection: MaybeRef<LPSAxisDir>,\n  viewUp: MaybeRef<LPSAxisDir>,\n  imageMetadataRef: Ref<ImageMetadata>\n) {\n  const orientationMatrix = computed(\n    () => imageMetadataRef.value.orientation as mat3\n  );\n  const lpsDirections = computed(() =>\n    getLPSDirections(orientationMatrix.value)\n  );\n  const cameraDirVec = computed(\n    () => lpsDirections.value[unref(viewDirection)]\n  );\n  const cameraUpVec = computed(() => lpsDirections.value[unref(viewUp)]);\n\n  return {\n    cameraDirVec,\n    cameraUpVec,\n  };\n}\n","<script lang=\"ts\">\nimport {\n  computed,\n  defineComponent,\n  onBeforeUnmount,\n  toRefs,\n  watch,\n  h,\n} from 'vue';\nimport vtkLPSView2DProxy from '@/src/vtk/LPSView2DProxy';\nimport { useToolStore } from '@/src/store/tools';\nimport { Tools } from '@/src/store/tools/types';\nimport useWindowingStore, {\n  defaultWindowLevelConfig,\n} from '@/src/store/view-configs/windowing';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport vtkMouseRangeManipulator from '@kitware/vtk.js/Interaction/Manipulators/MouseRangeManipulator';\nimport { useViewStore } from '@/src/store/views';\n\nfunction computeStep(min: number, max: number) {\n  return Math.min(max - min, 1) / 256;\n}\n\ninterface Props {\n  viewId: string;\n}\n\nconst WindowLevelToolComponent = defineComponent({\n  name: 'WindowLevelTool',\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n  },\n  setup(props) {\n    const { viewId: viewID } = toRefs(props);\n    const windowingStore = useWindowingStore();\n    const viewStore = useViewStore();\n    const { currentImageID } = useCurrentImage();\n\n    const viewProxy = computed(\n      () => viewStore.getViewProxy<vtkLPSView2DProxy>(viewID.value)!\n    );\n\n    const windowConfigDefaults = defaultWindowLevelConfig();\n    const wlConfig = computed(() =>\n      windowingStore.getConfig(viewID.value, currentImageID.value)\n    );\n\n    const wwRange = computed(() => ({\n      min: 1e-12, // ensure we don't hit zero and jump to white\n      max:\n        wlConfig.value != null\n          ? wlConfig.value.max - wlConfig.value.min\n          : windowConfigDefaults.max,\n      step:\n        wlConfig.value != null\n          ? computeStep(wlConfig.value.min, wlConfig.value.max)\n          : computeStep(windowConfigDefaults.min, windowConfigDefaults.max),\n    }));\n    const wlRange = computed(() => ({\n      min:\n        wlConfig.value != null ? wlConfig.value.min : windowConfigDefaults.min,\n      max:\n        wlConfig.value != null ? wlConfig.value.max : windowConfigDefaults.max,\n      step:\n        wlConfig.value != null\n          ? computeStep(wlConfig.value.min, wlConfig.value.max)\n          : computeStep(windowConfigDefaults.min, windowConfigDefaults.max),\n    }));\n\n    const vertVal = computed(() =>\n      wlConfig.value != null ? wlConfig.value.width : windowConfigDefaults.width\n    );\n\n    const horizVal = computed(() =>\n      wlConfig.value != null ? wlConfig.value.level : windowConfigDefaults.level\n    );\n\n    const rangeManipulator = vtkMouseRangeManipulator.newInstance({\n      button: 1,\n      scrollEnabled: false,\n    });\n\n    watch(\n      viewProxy,\n      (curViewProxy, oldViewProxy) => {\n        if (oldViewProxy) {\n          const istyle = oldViewProxy.getInteractorStyle2D();\n          istyle.removeMouseManipulator(rangeManipulator);\n        }\n\n        if (curViewProxy) {\n          // assumed to be vtkInteractorStyleManipulator\n          const istyle = viewProxy.value.getInteractorStyle2D();\n          istyle.addMouseManipulator(rangeManipulator);\n        }\n      },\n      { immediate: true }\n    );\n\n    onBeforeUnmount(() => {\n      // for some reason, VtkTwoView.onBeforeUnmount is being\n      // invoked before this onBeforeUnmount during HMR.\n      if (!viewProxy.value.isDeleted()) {\n        const istyle = viewProxy.value.getInteractorStyle2D();\n        istyle.removeMouseManipulator(rangeManipulator);\n      }\n    });\n\n    function updateManipulator() {\n      rangeManipulator.removeAllListeners();\n      const vertRange = wwRange.value;\n      const horizRange = wlRange.value;\n\n      rangeManipulator.setVerticalListener(\n        vertRange.min,\n        vertRange.max,\n        vertRange.step,\n        () => vertVal.value,\n        (v) => {\n          if (currentImageID.value != null) {\n            windowingStore.updateConfig(viewID.value, currentImageID.value, {\n              width: v,\n            });\n          }\n        }\n      );\n\n      rangeManipulator.setHorizontalListener(\n        horizRange.min,\n        horizRange.max,\n        horizRange.step,\n        () => horizVal.value,\n        (v) => {\n          if (currentImageID.value != null) {\n            windowingStore.updateConfig(viewID.value, currentImageID.value, {\n              level: v,\n            });\n          }\n        }\n      );\n    }\n\n    watch(\n      // Computed wwRange and wlRange are new objects with every mouse movement.\n      // So only updateManipulator() if min/max/step change by comparing with deep equals.\n      () => JSON.stringify({ w: wwRange.value, l: wlRange.value }),\n      updateManipulator,\n      { immediate: true }\n    );\n\n    return () => null;\n  },\n});\n\nexport default function WindowLevelTool(props: Props) {\n  const toolStore = useToolStore();\n  const active = computed(() => toolStore.currentTool === Tools.WindowLevel);\n  return active.value ? h(WindowLevelToolComponent, props) : [];\n}\n</script>\n","<script lang=\"ts\">\nimport {\n  computed,\n  defineComponent,\n  onBeforeUnmount,\n  ref,\n  toRefs,\n  watch,\n} from 'vue';\nimport vtkLPSView2DProxy from '@/src/vtk/LPSView2DProxy';\nimport vtkMouseRangeManipulator from '@kitware/vtk.js/Interaction/Manipulators/MouseRangeManipulator';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useViewStore } from '@/src/store/views';\nimport useViewSliceStore, {\n  defaultSliceConfig,\n} from '@/src/store/view-configs/slicing';\n\nexport default defineComponent({\n  name: 'SliceScrollTool',\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n  },\n  setup(props) {\n    const { viewId: viewID } = toRefs(props);\n    const viewSliceStore = useViewSliceStore();\n    const viewStore = useViewStore();\n    const { currentImageID } = useCurrentImage();\n\n    const viewProxy = computed(\n      () => viewStore.getViewProxy<vtkLPSView2DProxy>(viewID.value)!\n    );\n\n    const sliceConfigDefault = defaultSliceConfig();\n    const sliceConfig = computed(() =>\n      viewSliceStore.getConfig(viewID.value, currentImageID.value)\n    );\n    const sliceRange = computed(() => ({\n      min:\n        sliceConfig.value != null\n          ? sliceConfig.value.min\n          : sliceConfigDefault.min,\n      max:\n        sliceConfig.value != null\n          ? sliceConfig.value.max\n          : sliceConfigDefault.max,\n      step: 1,\n      default:\n        sliceConfig.value != null\n          ? sliceConfig.value.slice\n          : sliceConfigDefault.slice,\n    }));\n\n    const scrollVal = ref(0);\n\n    const rangeManipulator = vtkMouseRangeManipulator.newInstance({\n      button: -1, // don't bind to any buttons\n      scrollEnabled: true,\n    });\n\n    watch(\n      viewProxy,\n      (curViewProxy, oldViewProxy) => {\n        if (oldViewProxy) {\n          const istyle = oldViewProxy.getInteractorStyle2D();\n          istyle.removeMouseManipulator(rangeManipulator);\n        }\n\n        if (curViewProxy) {\n          // assumed to be vtkInteractorStyleManipulator\n          const istyle = viewProxy.value.getInteractorStyle2D();\n          istyle.addMouseManipulator(rangeManipulator);\n        }\n      },\n      { immediate: true }\n    );\n\n    onBeforeUnmount(() => {\n      // for some reason, VtkTwoView.onBeforeUnmount is being\n      // invoked before this onBeforeUnmount during HMR.\n      if (!viewProxy.value.isDeleted()) {\n        const istyle = viewProxy.value.getInteractorStyle2D();\n        istyle.removeMouseManipulator(rangeManipulator);\n      }\n    });\n\n    function updateManipulator() {\n      rangeManipulator.removeAllListeners();\n      const range = sliceRange.value;\n\n      rangeManipulator.setScrollListener(\n        range.min,\n        range.max,\n        range.step,\n        () => scrollVal.value,\n        (slice) => {\n          if (currentImageID.value !== null) {\n            viewSliceStore.updateConfig(viewID.value, currentImageID.value, {\n              slice,\n            });\n          }\n        }\n      );\n    }\n\n    watch(\n      sliceRange,\n      (range) => {\n        scrollVal.value = range.default;\n        updateManipulator();\n      },\n      { immediate: true }\n    );\n\n    return () => null;\n  },\n});\n</script>\n","<script lang=\"ts\">\nimport {\n  computed,\n  defineComponent,\n  PropType,\n  onBeforeUnmount,\n  toRefs,\n  watch,\n} from 'vue';\nimport { useViewStore } from '@/src/store/views';\nimport { vtkLPSViewProxy } from '@/src/types/vtk-types';\n\nexport default defineComponent({\n  name: 'MouseManipulatorTool',\n  props: {\n    // only useful for determining the kind of manipulator\n    name: String,\n    viewId: {\n      type: String,\n      required: true,\n    },\n    manipulatorClass: {\n      type: Object,\n      required: true,\n    },\n    options: {\n      type: Array as PropType<Array<any>>,\n      default: () => [],\n    },\n  },\n  setup(props) {\n    const { viewId: viewID, options } = toRefs(props);\n\n    const viewStore = useViewStore();\n    const viewProxy = computed(\n      () => viewStore.getViewProxy<vtkLPSViewProxy>(viewID.value)!\n    );\n\n    const intStyle = computed(() => {\n      return viewProxy.value.isA('vtkView2DProxy')\n        ? viewProxy.value.getInteractorStyle2D()\n        : viewProxy.value.getInteractorStyle3D();\n    });\n\n    const manipulators: any[] = [];\n\n    function updateStyle(\n      style: any,\n      newManipulators: any[],\n      oldManipulators: any[]\n    ) {\n      if (style !== null) {\n        oldManipulators.forEach((m) => style.removeMouseManipulator(m));\n        newManipulators.forEach((m) => style.addMouseManipulator(m));\n      }\n    }\n\n    watch(\n      options,\n      (newOptions) => {\n        // Maintain the size of manipulators array equal to options array.\n        while (manipulators.length > newOptions.length) {\n          const m = manipulators.pop();\n          intStyle.value.removeMouseManipulator(m);\n          m.delete();\n        }\n\n        const oldManipulators = Array.from(manipulators);\n\n        for (let i = manipulators.length; i < newOptions.length; ++i) {\n          manipulators.push(props.manipulatorClass.newInstance(newOptions[i]));\n        }\n\n        newOptions.forEach((opt, idx) => {\n          if ('button' in opt) {\n            manipulators[idx].setButton(opt.button);\n          }\n          manipulators[idx].setShift(!!opt.shift);\n          manipulators[idx].setControl(!!opt.control);\n        });\n\n        updateStyle(intStyle.value, manipulators, oldManipulators);\n      },\n      { immediate: true }\n    );\n\n    watch(\n      intStyle,\n      (curIntStyle, oldIntStyle) => {\n        manipulators.forEach((m) => {\n          if (oldIntStyle) {\n            oldIntStyle.removeMouseManipulator(m);\n          }\n          if (curIntStyle) {\n            curIntStyle.addMouseManipulator(m);\n          }\n        });\n      },\n      { immediate: true }\n    );\n\n    onBeforeUnmount(() => {\n      if (!viewProxy.value.isDeleted()) {\n        manipulators.forEach((m) => intStyle.value.removeMouseManipulator(m));\n      }\n    });\n\n    return () => null;\n  },\n});\n</script>\n","<script lang=\"ts\">\nimport { h } from 'vue';\nimport vtkMouseCameraTrackballPanManipulator from '@kitware/vtk.js/Interaction/Manipulators/MouseCameraTrackballPanManipulator';\nimport { useToolStore } from '@/src/store/tools';\nimport { Tools } from '@/src/store/tools/types';\nimport MouseManipulatorTool from './MouseManipulatorTool.vue';\n\ninterface Props {\n  viewId: string;\n}\n\nexport default function PanTool(props: Props) {\n  const toolStore = useToolStore();\n  const toolOptions = [];\n  toolOptions.push({ button: 2 });\n  toolOptions.push({ button: 1, shift: true });\n  if (toolStore.currentTool === Tools.Pan) {\n    // Additionally enable left-button-only action if Pan tool is active\n    toolOptions.push({ button: 1 });\n  }\n\n  return h(MouseManipulatorTool, {\n    ...props,\n    name: 'PanTool',\n    manipulatorClass: vtkMouseCameraTrackballPanManipulator,\n    options: toolOptions,\n  });\n}\n</script>\n","<script lang=\"ts\">\nimport { h } from 'vue';\nimport vtkMouseCameraTrackballZoomToMouseManipulator from '@kitware/vtk.js/Interaction/Manipulators/MouseCameraTrackballZoomToMouseManipulator';\nimport { useToolStore } from '@/src/store/tools';\nimport { Tools } from '@/src/store/tools/types';\nimport MouseManipulatorTool from './MouseManipulatorTool.vue';\n\ninterface Props {\n  viewId: string;\n}\n\nexport default function ZoomTool(props: Props) {\n  const toolStore = useToolStore();\n  const toolOptions = [];\n  toolOptions.push({ button: 3, flipDirection: true });\n  toolOptions.push({ button: 1, control: true, flipDirection: true });\n  if (toolStore.currentTool === Tools.Zoom) {\n    // Additionally enable left-button-only action if Zoom tool is active\n    toolOptions.push({ button: 1, flipDirection: true });\n  }\n\n  return h(MouseManipulatorTool, {\n    ...props,\n    name: 'ZoomTool',\n    manipulatorClass: vtkMouseCameraTrackballZoomToMouseManipulator,\n    options: toolOptions,\n  });\n}\n</script>\n","import macro from '@kitware/vtk.js/macro';\nimport type { Vector3 } from '@kitware/vtk.js/types';\n\nexport enum InteractionState {\n  PlacingFirst = 'PlacingFirst',\n  PlacingSecond = 'PlacingSecond',\n  Select = 'Select',\n  Dragging = 'Dragging',\n}\n\nexport function shouldIgnoreEvent(e: any) {\n  return e.altKey || e.controlKey || e.shiftKey;\n}\n\nexport default function widgetBehavior(publicAPI: any, model: any) {\n  model.classHierarchy.push('vtkRulerWidgetProp');\n\n  model.interactionState = InteractionState.Select;\n  let draggingState: any = null;\n\n  macro.setGet(publicAPI, model, ['interactionState']);\n  // support setting per-view widget manipulators\n  macro.setGet(publicAPI, model, ['manipulator']);\n  // support forwarding events\n  macro.event(publicAPI, model, 'RightClickEvent');\n  macro.event(publicAPI, model, 'PlacedEvent');\n\n  publicAPI.deactivateAllHandles = () => {\n    model.widgetState.deactivate();\n    model.activeState = null;\n  };\n\n  publicAPI.setFirstPoint = (coord: Vector3) => {\n    const point = model.widgetState.getFirstPoint();\n    point.setOrigin(coord);\n  };\n\n  publicAPI.setSecondPoint = (coord: Vector3) => {\n    const point = model.widgetState.getSecondPoint();\n    point.setOrigin(coord);\n  };\n\n  const originalSetInteractionState = publicAPI.setInteractionState;\n  publicAPI.setInteractionState = (state: InteractionState) => {\n    const changed = originalSetInteractionState(state);\n    if (changed && state === InteractionState.PlacingFirst) {\n      model.widgetState.setIsPlaced(false);\n      model.widgetState.getFirstPoint().setVisible(false);\n      model.widgetState.getSecondPoint().setVisible(false);\n    }\n    return changed;\n  };\n\n  publicAPI.resetInteractions = () => {\n    model._interactor.cancelAnimation(publicAPI, true);\n  };\n\n  /**\n   * Places or drags a point.\n   */\n  publicAPI.handleLeftButtonPress = (eventData: any) => {\n    if (!model.manipulator || shouldIgnoreEvent(eventData)) {\n      return macro.VOID;\n    }\n\n    // This ruler widget is passive, so if another widget\n    // is active, we don't do anything.\n    const activeWidget = model._widgetManager.getActiveWidget();\n    if (activeWidget && activeWidget !== publicAPI) {\n      return macro.VOID;\n    }\n\n    const worldCoords = model.manipulator.handleEvent(\n      eventData,\n      model._apiSpecificRenderWindow\n    );\n    if (!worldCoords.length) {\n      return macro.VOID;\n    }\n\n    const intState = publicAPI.getInteractionState();\n\n    if (intState === InteractionState.PlacingFirst) {\n      publicAPI.setFirstPoint(worldCoords);\n      publicAPI.setSecondPoint(worldCoords);\n      model.widgetState.getFirstPoint().setVisible(true);\n      model.widgetState.getSecondPoint().setVisible(true);\n\n      model._interactor.requestAnimation(publicAPI);\n      publicAPI.invokeStartInteractionEvent();\n      publicAPI.setInteractionState(InteractionState.PlacingSecond);\n      return macro.EVENT_ABORT;\n    }\n\n    if (intState === InteractionState.PlacingSecond) {\n      publicAPI.setSecondPoint(worldCoords);\n      model.widgetState.setIsPlaced(true);\n\n      publicAPI.setInteractionState(InteractionState.Select);\n      publicAPI.invokeEndInteractionEvent();\n      publicAPI.invokePlacedEvent();\n\n      model._interactor.cancelAnimation(publicAPI);\n      return macro.EVENT_ABORT;\n    }\n\n    // dragging\n    if (model.activeState?.getActive() && model.pickable) {\n      draggingState = model.activeState;\n      publicAPI.setInteractionState(InteractionState.Dragging);\n      model._apiSpecificRenderWindow.setCursor('grabbing');\n      model._interactor.requestAnimation(publicAPI);\n      publicAPI.invokeStartInteractionEvent();\n      return macro.EVENT_ABORT;\n    }\n\n    return macro.VOID;\n  };\n\n  /**\n   * Moves a point around.\n   */\n  publicAPI.handleMouseMove = (eventData: any) => {\n    const worldCoords = model.manipulator.handleEvent(\n      eventData,\n      model._apiSpecificRenderWindow\n    );\n    if (!worldCoords.length) {\n      return macro.VOID;\n    }\n\n    const intState = publicAPI.getInteractionState();\n\n    if (intState === InteractionState.PlacingSecond) {\n      model.widgetState.getSecondPoint().setOrigin(worldCoords);\n      // show second point during placement\n      model.widgetState.getSecondPoint().setVisible(true);\n      publicAPI.invokeInteractionEvent();\n      return macro.EVENT_ABORT;\n    }\n\n    if (\n      publicAPI.getInteractionState() === InteractionState.Dragging &&\n      draggingState\n    ) {\n      draggingState.setOrigin(worldCoords);\n      publicAPI.invokeInteractionEvent();\n      return macro.EVENT_ABORT;\n    }\n\n    return macro.VOID;\n  };\n\n  /**\n   * Finishes dragging\n   */\n  publicAPI.handleLeftButtonRelease = (eventData: any) => {\n    if (draggingState) {\n      const worldCoords = model.manipulator.handleEvent(\n        eventData,\n        model._apiSpecificRenderWindow\n      );\n      if (worldCoords.length) {\n        draggingState.setOrigin(worldCoords);\n      }\n\n      draggingState = null;\n      publicAPI.setInteractionState(InteractionState.Select);\n      model._apiSpecificRenderWindow.setCursor('pointer');\n      model.widgetState.deactivate();\n      model._interactor.cancelAnimation(publicAPI);\n      publicAPI.invokeEndInteractionEvent();\n      model._widgetManager.enablePicking();\n    }\n  };\n\n  publicAPI.handleRightButtonPress = (eventData: any) => {\n    if (\n      shouldIgnoreEvent(eventData) ||\n      publicAPI.getInteractionState() !== InteractionState.Select ||\n      !model.activeState\n    ) {\n      return macro.VOID;\n    }\n    publicAPI.invokeRightClickEvent(eventData);\n    return macro.EVENT_ABORT;\n  };\n\n  publicAPI.grabFocus = () => {\n    throw new Error('grabFocus is not implemented');\n  };\n\n  publicAPI.loseFocus = () => {\n    throw new Error('loseFocus is not implemented');\n  };\n}\n","import macro from '@kitware/vtk.js/macros';\nimport vtkWidgetState from '@kitware/vtk.js/Widgets/Core/WidgetState';\nimport visibleMixin from '@kitware/vtk.js/Widgets/Core/StateBuilder/visibleMixin';\nimport scale1Mixin from '@kitware/vtk.js/Widgets/Core/StateBuilder/scale1Mixin';\n\nconst PIXEL_SIZE = 20;\n\nfunction watchStore(publicAPI, store, getter, cmp) {\n  let cached = getter();\n  const unsubscribe = store.$subscribe(() => {\n    const val = getter();\n    if (cmp ? cmp(cached, val) : cached !== val) {\n      cached = val;\n      publicAPI.modified();\n    }\n  });\n\n  const originalDelete = publicAPI.delete;\n  publicAPI.delete = () => {\n    unsubscribe();\n    originalDelete();\n  };\n}\n\nfunction _createPointState(\n  publicAPI,\n  model,\n  { id, store, key, visible = true }\n) {\n  Object.assign(model, {\n    id,\n    _store: store,\n    key,\n  });\n  vtkWidgetState.extend(publicAPI, model, {});\n  visibleMixin.extend(publicAPI, model, { visible });\n  scale1Mixin.extend(publicAPI, model, { scale1: PIXEL_SIZE });\n\n  const getRuler = () => {\n    return model._store.rulerByID[model.id];\n  };\n\n  const updateRuler = (patch) => model._store.updateRuler(model.id, patch);\n\n  publicAPI.getOrigin = () => {\n    return getRuler()?.[model.key];\n  };\n\n  publicAPI.setOrigin = (xyz) => {\n    updateRuler({\n      [model.key]: xyz,\n    });\n    publicAPI.modified();\n  };\n\n  watchStore(publicAPI, model._store, () => getRuler()?.[model.key]);\n}\n\nconst createPointState = macro.newInstance(\n  _createPointState,\n  'vtkRulerWidgetStatePoint'\n);\n\nexport default createPointState;\n","import macro from '@kitware/vtk.js/macros';\nimport vtkWidgetState from '@kitware/vtk.js/Widgets/Core/WidgetState';\nimport bounds from '@kitware/vtk.js/Widgets/Core/StateBuilder/boundsMixin';\n\nimport createPointState from './pointState';\n\nexport const PointsLabel = 'points';\n\nfunction watchState(publicAPI: any, state: any, callback: () => {}) {\n  let subscription = state.onModified(callback);\n  const originalDelete = publicAPI.delete;\n  publicAPI.delete = () => {\n    subscription.unsubscribe();\n    subscription = null;\n    originalDelete();\n  };\n}\n\nfunction vtkRulerWidgetState(publicAPI: any, model: any) {\n  const firstPoint = createPointState({\n    id: model.id,\n    store: model._store,\n    key: 'firstPoint',\n    visible: true,\n  });\n  const secondPoint = createPointState({\n    id: model.id,\n    store: model._store,\n    key: 'secondPoint',\n    visible: true,\n  });\n\n  watchState(publicAPI, firstPoint, () => publicAPI.modified());\n  watchState(publicAPI, secondPoint, () => publicAPI.modified());\n\n  model.labels = {\n    [PointsLabel]: [firstPoint, secondPoint],\n  };\n\n  publicAPI.getFirstPoint = () => firstPoint;\n  publicAPI.getSecondPoint = () => secondPoint;\n}\n\nconst defaultValues = (initialValues: any) => ({\n  isPlaced: false,\n  ...initialValues,\n});\n\nfunction _createRulerWidgetState(\n  publicAPI: any,\n  model: any,\n  initialValues: any\n) {\n  Object.assign(model, defaultValues(initialValues));\n  vtkWidgetState.extend(publicAPI, model, initialValues);\n  bounds.extend(publicAPI, model);\n\n  macro.get(publicAPI, model, ['id']);\n  macro.setGet(publicAPI, model, ['isPlaced']);\n  macro.moveToProtected(publicAPI, model, ['store']);\n\n  vtkRulerWidgetState(publicAPI, model);\n}\n\nconst createRulerWidgetState = macro.newInstance(\n  _createRulerWidgetState,\n  'vtkRulerWidgetState'\n);\n\nexport default createRulerWidgetState;\n","import macro from '@kitware/vtk.js/macro';\nimport vtkAbstractWidgetFactory from '@kitware/vtk.js/Widgets/Core/AbstractWidgetFactory';\nimport vtkPlanePointManipulator from '@kitware/vtk.js/Widgets/Manipulators/PlaneManipulator';\nimport vtkSphereHandleRepresentation from '@kitware/vtk.js/Widgets/Representations/SphereHandleRepresentation';\nimport { distance2BetweenPoints } from '@kitware/vtk.js/Common/Core/Math';\n\nimport widgetBehavior from './behavior';\nimport stateGenerator, { PointsLabel } from './state';\n\nexport { InteractionState } from './behavior';\n\n// ----------------------------------------------------------------------------\n// Factory\n// ----------------------------------------------------------------------------\n\nfunction vtkRulerWidget(publicAPI, model) {\n  model.classHierarchy.push('vtkRulerWidget');\n\n  // --- Widget Requirement ---------------------------------------------------\n\n  publicAPI.getRepresentationsForViewType = () => [\n    {\n      builder: vtkSphereHandleRepresentation,\n      labels: [PointsLabel],\n      initialValues: {\n        scaleInPixels: true,\n      },\n    },\n  ];\n\n  publicAPI.getLength = () => {\n    const first = model.widgetState.getFirstPoint().getOrigin();\n    const second = model.widgetState.getSecondPoint().getOrigin();\n    if (!first || !second) {\n      return 0;\n    }\n    return Math.sqrt(distance2BetweenPoints(first, second));\n  };\n\n  // Default manipulator\n  model.manipulator = vtkPlanePointManipulator.newInstance();\n}\n\n// ----------------------------------------------------------------------------\n\nconst DEFAULT_VALUES = {};\n\n// ----------------------------------------------------------------------------\n\nexport function extend(publicAPI, model, initialValues = {}) {\n  Object.assign(model, DEFAULT_VALUES, initialValues);\n\n  vtkAbstractWidgetFactory.extend(publicAPI, model, {\n    ...initialValues,\n    behavior: widgetBehavior,\n    widgetState: stateGenerator(initialValues),\n  });\n  macro.get(publicAPI, model, ['manipulator']);\n\n  vtkRulerWidget(publicAPI, model);\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(extend, 'vtkRulerWidget');\n\n// ----------------------------------------------------------------------------\n\nexport default { newInstance, extend };\n","import type { Vector3 } from '@kitware/vtk.js/types';\nimport vtkPlaneManipulator from '@kitware/vtk.js/Widgets/Manipulators/PlaneManipulator';\nimport { vec3 } from 'gl-matrix';\nimport { ImageMetadata } from '../types/image';\nimport { LPSAxisDir } from '../types/lps';\nimport { getLPSAxisFromDir } from './lps';\n\nexport function updatePlaneManipulatorFor2DView(\n  manipulator: vtkPlaneManipulator,\n  viewDir: LPSAxisDir,\n  slice: number,\n  imageMetadata: ImageMetadata\n) {\n  const { lpsOrientation } = imageMetadata;\n  const axis = lpsOrientation[getLPSAxisFromDir(viewDir)];\n\n  const normal: vec3 = lpsOrientation[viewDir];\n  const origin: vec3 = [0, 0, 0];\n  origin[axis] = slice;\n\n  vec3.transformMat4(origin, origin, imageMetadata.indexToWorld);\n\n  manipulator.setUserNormal(normal as Vector3);\n  manipulator.setUserOrigin(origin as Vector3);\n}\n\nexport function createPlaneManipulatorFor2DView(\n  viewDir: LPSAxisDir,\n  slice: number,\n  imageMetadata: ImageMetadata\n) {\n  const manipulator = vtkPlaneManipulator.newInstance();\n  updatePlaneManipulatorFor2DView(manipulator, viewDir, slice, imageMetadata);\n  return manipulator;\n}\n","<template>\n  <g>\n    <line\n      v-if=\"first && second\"\n      :x1=\"first.x\"\n      :y1=\"first.y\"\n      :x2=\"second.x\"\n      :y2=\"second.y\"\n      :stroke=\"color\"\n      stroke-width=\"1\"\n    />\n    <!-- radius is related to the vtkRulerWidget scale, specified in state -->\n    <circle\n      v-if=\"first\"\n      :cx=\"first.x\"\n      :cy=\"first.y\"\n      :stroke=\"color\"\n      stroke-width=\"1\"\n      fill=\"transparent\"\n      :r=\"10 / devicePixelRatio\"\n    />\n    <circle\n      v-if=\"second\"\n      :cx=\"second.x\"\n      :cy=\"second.y\"\n      :stroke=\"color\"\n      stroke-width=\"1\"\n      fill=\"transparent\"\n      :r=\"10 / devicePixelRatio\"\n      class=\"handle\"\n    />\n    <text\n      v-if=\"second\"\n      :x=\"second.x\"\n      :y=\"second.y\"\n      :dx=\"textdx\"\n      :dy=\"textdy\"\n      :text-anchor=\"anchor\"\n      stroke-width=\"0.75\"\n      stroke=\"black\"\n      fill=\"white\"\n      :font-size=\"`${textSize}px`\"\n      font-weight=\"bold\"\n    >\n      {{ rulerLength }}\n    </text>\n  </g>\n</template>\n\n<script lang=\"ts\">\nimport { useResizeObserver } from '@/src/composables/useResizeObserver';\nimport { useVTKCallback } from '@/src/composables/useVTKCallback';\nimport { ToolContainer } from '@/src/constants';\nimport { useViewStore } from '@/src/store/views';\nimport { worldToSVG } from '@/src/utils/vtk-helpers';\nimport vtkLPSView2DProxy from '@/src/vtk/LPSView2DProxy';\nimport type { Vector3 } from '@kitware/vtk.js/types';\nimport {\n  PropType,\n  computed,\n  defineComponent,\n  toRefs,\n  unref,\n  ref,\n  watch,\n  inject,\n} from 'vue';\n\ntype SVGPoint = {\n  x: number;\n  y: number;\n};\n\nexport default defineComponent({\n  props: {\n    point1: Array as PropType<Array<number>>,\n    point2: Array as PropType<Array<number>>,\n    color: String,\n    length: Number,\n    viewId: {\n      type: String,\n      required: true,\n    },\n    textOffset: {\n      type: Number,\n      default: 8,\n    },\n    textSize: {\n      type: Number,\n      default: 14,\n    },\n  },\n  setup(props) {\n    const {\n      viewId: viewID,\n      point1,\n      point2,\n      textOffset,\n      length,\n    } = toRefs(props);\n    const firstPoint = ref<SVGPoint | null>();\n    const secondPoint = ref<SVGPoint | null>();\n\n    const viewStore = useViewStore();\n\n    const viewProxy = computed(\n      () => viewStore.getViewProxy<vtkLPSView2DProxy>(viewID.value)!\n    );\n\n    const updatePoints = () => {\n      const viewRenderer = viewProxy.value.getRenderer();\n      const pt1 = unref(point1) as Vector3 | undefined;\n      const pt2 = unref(point2) as Vector3 | undefined;\n      if (pt1) {\n        const point2D = worldToSVG(pt1, viewRenderer);\n        if (point2D) {\n          firstPoint.value = {\n            x: point2D[0],\n            y: point2D[1],\n          };\n        }\n      } else {\n        firstPoint.value = null;\n      }\n\n      if (pt2) {\n        const point2D = worldToSVG(pt2, viewRenderer);\n        if (point2D) {\n          secondPoint.value = {\n            x: point2D[0],\n            y: point2D[1],\n          };\n        }\n      } else {\n        secondPoint.value = null;\n      }\n    };\n\n    const cameraOnModified = useVTKCallback(\n      computed(() => viewProxy.value.getCamera().onModified)\n    );\n    cameraOnModified(updatePoints);\n\n    watch([viewProxy, point1, point2], updatePoints, {\n      deep: true,\n      immediate: true,\n    });\n\n    const textProperties = computed(() => {\n      const first = unref(firstPoint);\n      const second = unref(secondPoint);\n      const offset = textOffset.value;\n      if (!first || !second) {\n        return null;\n      }\n      if (second.x > first.x) {\n        return { dx: offset, dy: -offset, anchor: 'start' };\n      }\n      return { dx: -offset, dy: -offset, anchor: 'end' };\n    });\n\n    // --- resize --- //\n\n    const containerEl = inject(ToolContainer)!;\n\n    useResizeObserver(containerEl, () => {\n      updatePoints();\n    });\n\n    return {\n      devicePixelRatio,\n      textdx: computed(() => textProperties.value?.dx ?? 0),\n      textdy: computed(() => textProperties.value?.dy ?? 0),\n      anchor: computed(() => textProperties.value?.anchor ?? 'start'),\n      first: firstPoint,\n      second: secondPoint,\n      rulerLength: computed(() => length?.value?.toFixed(2) ?? ''),\n    };\n  },\n});\n</script>\n\n<style scoped>\n.handle {\n  cursor: pointer;\n}\n</style>\n","<template>\n  <g>\n    <line\n      v-if=\"first && second\"\n      :x1=\"first.x\"\n      :y1=\"first.y\"\n      :x2=\"second.x\"\n      :y2=\"second.y\"\n      :stroke=\"color\"\n      stroke-width=\"1\"\n    />\n    <!-- radius is related to the vtkRulerWidget scale, specified in state -->\n    <circle\n      v-if=\"first\"\n      :cx=\"first.x\"\n      :cy=\"first.y\"\n      :stroke=\"color\"\n      stroke-width=\"1\"\n      fill=\"transparent\"\n      :r=\"10 / devicePixelRatio\"\n    />\n    <circle\n      v-if=\"second\"\n      :cx=\"second.x\"\n      :cy=\"second.y\"\n      :stroke=\"color\"\n      stroke-width=\"1\"\n      fill=\"transparent\"\n      :r=\"10 / devicePixelRatio\"\n      class=\"handle\"\n    />\n    <text\n      v-if=\"second\"\n      :x=\"second.x\"\n      :y=\"second.y\"\n      :dx=\"textdx\"\n      :dy=\"textdy\"\n      :text-anchor=\"anchor\"\n      stroke-width=\"0.75\"\n      stroke=\"black\"\n      fill=\"white\"\n      :font-size=\"`${textSize}px`\"\n      font-weight=\"bold\"\n    >\n      {{ rulerLength }}\n    </text>\n  </g>\n</template>\n\n<script lang=\"ts\">\nimport { useResizeObserver } from '@/src/composables/useResizeObserver';\nimport { useVTKCallback } from '@/src/composables/useVTKCallback';\nimport { ToolContainer } from '@/src/constants';\nimport { useViewStore } from '@/src/store/views';\nimport { worldToSVG } from '@/src/utils/vtk-helpers';\nimport vtkLPSView2DProxy from '@/src/vtk/LPSView2DProxy';\nimport type { Vector3 } from '@kitware/vtk.js/types';\nimport {\n  PropType,\n  computed,\n  defineComponent,\n  toRefs,\n  unref,\n  ref,\n  watch,\n  inject,\n} from 'vue';\n\ntype SVGPoint = {\n  x: number;\n  y: number;\n};\n\nexport default defineComponent({\n  props: {\n    point1: Array as PropType<Array<number>>,\n    point2: Array as PropType<Array<number>>,\n    color: String,\n    length: Number,\n    viewId: {\n      type: String,\n      required: true,\n    },\n    textOffset: {\n      type: Number,\n      default: 8,\n    },\n    textSize: {\n      type: Number,\n      default: 14,\n    },\n  },\n  setup(props) {\n    const {\n      viewId: viewID,\n      point1,\n      point2,\n      textOffset,\n      length,\n    } = toRefs(props);\n    const firstPoint = ref<SVGPoint | null>();\n    const secondPoint = ref<SVGPoint | null>();\n\n    const viewStore = useViewStore();\n\n    const viewProxy = computed(\n      () => viewStore.getViewProxy<vtkLPSView2DProxy>(viewID.value)!\n    );\n\n    const updatePoints = () => {\n      const viewRenderer = viewProxy.value.getRenderer();\n      const pt1 = unref(point1) as Vector3 | undefined;\n      const pt2 = unref(point2) as Vector3 | undefined;\n      if (pt1) {\n        const point2D = worldToSVG(pt1, viewRenderer);\n        if (point2D) {\n          firstPoint.value = {\n            x: point2D[0],\n            y: point2D[1],\n          };\n        }\n      } else {\n        firstPoint.value = null;\n      }\n\n      if (pt2) {\n        const point2D = worldToSVG(pt2, viewRenderer);\n        if (point2D) {\n          secondPoint.value = {\n            x: point2D[0],\n            y: point2D[1],\n          };\n        }\n      } else {\n        secondPoint.value = null;\n      }\n    };\n\n    const cameraOnModified = useVTKCallback(\n      computed(() => viewProxy.value.getCamera().onModified)\n    );\n    cameraOnModified(updatePoints);\n\n    watch([viewProxy, point1, point2], updatePoints, {\n      deep: true,\n      immediate: true,\n    });\n\n    const textProperties = computed(() => {\n      const first = unref(firstPoint);\n      const second = unref(secondPoint);\n      const offset = textOffset.value;\n      if (!first || !second) {\n        return null;\n      }\n      if (second.x > first.x) {\n        return { dx: offset, dy: -offset, anchor: 'start' };\n      }\n      return { dx: -offset, dy: -offset, anchor: 'end' };\n    });\n\n    // --- resize --- //\n\n    const containerEl = inject(ToolContainer)!;\n\n    useResizeObserver(containerEl, () => {\n      updatePoints();\n    });\n\n    return {\n      devicePixelRatio,\n      textdx: computed(() => textProperties.value?.dx ?? 0),\n      textdy: computed(() => textProperties.value?.dy ?? 0),\n      anchor: computed(() => textProperties.value?.anchor ?? 'start'),\n      first: firstPoint,\n      second: secondPoint,\n      rulerLength: computed(() => length?.value?.toFixed(2) ?? ''),\n    };\n  },\n});\n</script>\n\n<style scoped>\n.handle {\n  cursor: pointer;\n}\n</style>\n","<script lang=\"ts\">\nimport vtkRulerWidget, {\n  InteractionState,\n  vtkRulerViewWidget,\n  vtkRulerWidgetPointState,\n} from '@/src/vtk/RulerWidget';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport {\n  computed,\n  defineComponent,\n  onBeforeUnmount,\n  onMounted,\n  onUnmounted,\n  PropType,\n  Ref,\n  ref,\n  toRefs,\n  watch,\n  watchEffect,\n} from 'vue';\nimport vtkPlaneManipulator from '@kitware/vtk.js/Widgets/Manipulators/PlaneManipulator';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { updatePlaneManipulatorFor2DView } from '@/src/utils/manipulators';\nimport type { vtkSubscription } from '@kitware/vtk.js/interfaces';\nimport { getCSSCoordinatesFromEvent } from '@/src/utils/vtk-helpers';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport { useRulerStore } from '@/src/store/tools/rulers';\nimport { useVTKCallback } from '@/src/composables/useVTKCallback';\nimport RulerSVG2D from '@/src/components/tools/ruler/RulerSVG2D.vue';\nimport { watchOnce } from '@vueuse/core';\n\nexport default defineComponent({\n  name: 'RulerWidget2D',\n  emits: ['placed', 'contextmenu'],\n  props: {\n    rulerId: {\n      type: String,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n    viewId: {\n      type: String,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    currentSlice: {\n      type: Number,\n      required: true,\n    },\n    isPlacing: {\n      type: Boolean,\n      default: false,\n    },\n  },\n  components: {\n    RulerSVG2D,\n  },\n  setup(props, { emit }) {\n    const { rulerId, widgetManager, viewDirection, currentSlice, isPlacing } =\n      toRefs(props);\n\n    const rulerStore = useRulerStore();\n    const ruler = computed(() => rulerStore.rulerByID[rulerId.value]);\n    const { currentImageID, currentImageMetadata } = useCurrentImage();\n\n    const widgetFactory = vtkRulerWidget.newInstance({\n      id: rulerId.value,\n      store: rulerStore,\n      isPlaced: !isPlacing.value,\n    });\n    const widget = ref<vtkRulerViewWidget | null>(null);\n\n    onMounted(() => {\n      widget.value = widgetManager.value.addWidget(\n        widgetFactory\n      ) as vtkRulerViewWidget;\n    });\n\n    onUnmounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      widgetManager.value.removeWidget(widget.value);\n      widget.value.delete();\n      widgetFactory.delete();\n    });\n\n    watch(\n      [isPlacing, widget],\n      ([placing, widget_]) => {\n        if (placing && widget_) {\n          widget_.setInteractionState(InteractionState.PlacingFirst);\n        }\n      },\n      { immediate: true }\n    );\n\n    // --- reset on slice/image changes --- //\n\n    watch([currentSlice, currentImageID, widget], () => {\n      const isPlaced = widget.value?.getWidgetState().getIsPlaced();\n      if (widget.value && !isPlaced) {\n        widget.value.resetInteractions();\n        widget.value.setInteractionState(InteractionState.PlacingFirst);\n      }\n    });\n\n    // --- placed event --- //\n\n    const onPlacedEvent = useVTKCallback(\n      computed(() => widget.value?.onPlacedEvent)\n    );\n\n    onPlacedEvent(() => {\n      emit('placed');\n    });\n\n    // --- right click handling --- //\n\n    let rightClickSub: vtkSubscription | null = null;\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      rightClickSub = widget.value.onRightClickEvent((eventData) => {\n        const coords = getCSSCoordinatesFromEvent(eventData);\n        if (coords) {\n          emit('contextmenu', coords);\n        }\n      });\n    });\n\n    onBeforeUnmount(() => {\n      if (rightClickSub) {\n        rightClickSub.unsubscribe();\n        rightClickSub = null;\n      }\n    });\n\n    // --- manipulator --- //\n\n    const manipulator = vtkPlaneManipulator.newInstance();\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      widget.value.setManipulator(manipulator);\n    });\n\n    watchEffect(() => {\n      updatePlaneManipulatorFor2DView(\n        manipulator,\n        viewDirection.value,\n        ruler.value?.slice ?? currentSlice.value,\n        currentImageMetadata.value\n      );\n    });\n\n    // --- visibility --- //\n\n    // toggles the pickability of the ruler handles,\n    // since the 3D ruler parts are visually hidden.\n    watch(\n      () => !!widget.value && ruler.value?.slice === currentSlice.value,\n      (visible) => {\n        widget.value?.setVisibility(visible);\n      },\n      { immediate: true }\n    );\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      // hide handle visibility, but not picking visibility\n      widget.value.setHandleVisibility(false);\n      widgetManager.value.renderWidgets();\n    });\n\n    // --- handle pick visibility --- //\n\n    const usePointVisibility = (\n      pointState: Ref<vtkRulerWidgetPointState | undefined>\n    ) => {\n      const visible = ref(false);\n      const updateVisibility = () => {\n        if (!pointState.value) return;\n        visible.value = pointState.value.getVisible();\n      };\n\n      const onModified = useVTKCallback(\n        computed(() => pointState.value?.onModified)\n      );\n      onModified(() => updateVisibility());\n\n      watchOnce(pointState, () => updateVisibility());\n\n      return visible;\n    };\n\n    const firstPointVisible = usePointVisibility(\n      computed(() => widget.value?.getWidgetState().getFirstPoint())\n    );\n    const secondPointVisible = usePointVisibility(\n      computed(() => widget.value?.getWidgetState().getSecondPoint())\n    );\n\n    return {\n      ruler,\n      firstPoint: computed(() => {\n        return firstPointVisible.value ? ruler.value.firstPoint : undefined;\n      }),\n      secondPoint: computed(() => {\n        return secondPointVisible.value ? ruler.value.secondPoint : undefined;\n      }),\n      length: computed(() => rulerStore.lengthByID[ruler.value.id]),\n    };\n  },\n});\n</script>\n\n<template>\n  <RulerSVG2D\n    v-show=\"currentSlice === ruler.slice\"\n    :view-id=\"viewId\"\n    :point1=\"firstPoint\"\n    :point2=\"secondPoint\"\n    :color=\"ruler.color\"\n    :length=\"length\"\n  />\n</template>\n","<script lang=\"ts\">\nimport vtkRulerWidget, {\n  InteractionState,\n  vtkRulerViewWidget,\n  vtkRulerWidgetPointState,\n} from '@/src/vtk/RulerWidget';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport {\n  computed,\n  defineComponent,\n  onBeforeUnmount,\n  onMounted,\n  onUnmounted,\n  PropType,\n  Ref,\n  ref,\n  toRefs,\n  watch,\n  watchEffect,\n} from 'vue';\nimport vtkPlaneManipulator from '@kitware/vtk.js/Widgets/Manipulators/PlaneManipulator';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { updatePlaneManipulatorFor2DView } from '@/src/utils/manipulators';\nimport type { vtkSubscription } from '@kitware/vtk.js/interfaces';\nimport { getCSSCoordinatesFromEvent } from '@/src/utils/vtk-helpers';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport { useRulerStore } from '@/src/store/tools/rulers';\nimport { useVTKCallback } from '@/src/composables/useVTKCallback';\nimport RulerSVG2D from '@/src/components/tools/ruler/RulerSVG2D.vue';\nimport { watchOnce } from '@vueuse/core';\n\nexport default defineComponent({\n  name: 'RulerWidget2D',\n  emits: ['placed', 'contextmenu'],\n  props: {\n    rulerId: {\n      type: String,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n    viewId: {\n      type: String,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    currentSlice: {\n      type: Number,\n      required: true,\n    },\n    isPlacing: {\n      type: Boolean,\n      default: false,\n    },\n  },\n  components: {\n    RulerSVG2D,\n  },\n  setup(props, { emit }) {\n    const { rulerId, widgetManager, viewDirection, currentSlice, isPlacing } =\n      toRefs(props);\n\n    const rulerStore = useRulerStore();\n    const ruler = computed(() => rulerStore.rulerByID[rulerId.value]);\n    const { currentImageID, currentImageMetadata } = useCurrentImage();\n\n    const widgetFactory = vtkRulerWidget.newInstance({\n      id: rulerId.value,\n      store: rulerStore,\n      isPlaced: !isPlacing.value,\n    });\n    const widget = ref<vtkRulerViewWidget | null>(null);\n\n    onMounted(() => {\n      widget.value = widgetManager.value.addWidget(\n        widgetFactory\n      ) as vtkRulerViewWidget;\n    });\n\n    onUnmounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      widgetManager.value.removeWidget(widget.value);\n      widget.value.delete();\n      widgetFactory.delete();\n    });\n\n    watch(\n      [isPlacing, widget],\n      ([placing, widget_]) => {\n        if (placing && widget_) {\n          widget_.setInteractionState(InteractionState.PlacingFirst);\n        }\n      },\n      { immediate: true }\n    );\n\n    // --- reset on slice/image changes --- //\n\n    watch([currentSlice, currentImageID, widget], () => {\n      const isPlaced = widget.value?.getWidgetState().getIsPlaced();\n      if (widget.value && !isPlaced) {\n        widget.value.resetInteractions();\n        widget.value.setInteractionState(InteractionState.PlacingFirst);\n      }\n    });\n\n    // --- placed event --- //\n\n    const onPlacedEvent = useVTKCallback(\n      computed(() => widget.value?.onPlacedEvent)\n    );\n\n    onPlacedEvent(() => {\n      emit('placed');\n    });\n\n    // --- right click handling --- //\n\n    let rightClickSub: vtkSubscription | null = null;\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      rightClickSub = widget.value.onRightClickEvent((eventData) => {\n        const coords = getCSSCoordinatesFromEvent(eventData);\n        if (coords) {\n          emit('contextmenu', coords);\n        }\n      });\n    });\n\n    onBeforeUnmount(() => {\n      if (rightClickSub) {\n        rightClickSub.unsubscribe();\n        rightClickSub = null;\n      }\n    });\n\n    // --- manipulator --- //\n\n    const manipulator = vtkPlaneManipulator.newInstance();\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      widget.value.setManipulator(manipulator);\n    });\n\n    watchEffect(() => {\n      updatePlaneManipulatorFor2DView(\n        manipulator,\n        viewDirection.value,\n        ruler.value?.slice ?? currentSlice.value,\n        currentImageMetadata.value\n      );\n    });\n\n    // --- visibility --- //\n\n    // toggles the pickability of the ruler handles,\n    // since the 3D ruler parts are visually hidden.\n    watch(\n      () => !!widget.value && ruler.value?.slice === currentSlice.value,\n      (visible) => {\n        widget.value?.setVisibility(visible);\n      },\n      { immediate: true }\n    );\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      // hide handle visibility, but not picking visibility\n      widget.value.setHandleVisibility(false);\n      widgetManager.value.renderWidgets();\n    });\n\n    // --- handle pick visibility --- //\n\n    const usePointVisibility = (\n      pointState: Ref<vtkRulerWidgetPointState | undefined>\n    ) => {\n      const visible = ref(false);\n      const updateVisibility = () => {\n        if (!pointState.value) return;\n        visible.value = pointState.value.getVisible();\n      };\n\n      const onModified = useVTKCallback(\n        computed(() => pointState.value?.onModified)\n      );\n      onModified(() => updateVisibility());\n\n      watchOnce(pointState, () => updateVisibility());\n\n      return visible;\n    };\n\n    const firstPointVisible = usePointVisibility(\n      computed(() => widget.value?.getWidgetState().getFirstPoint())\n    );\n    const secondPointVisible = usePointVisibility(\n      computed(() => widget.value?.getWidgetState().getSecondPoint())\n    );\n\n    return {\n      ruler,\n      firstPoint: computed(() => {\n        return firstPointVisible.value ? ruler.value.firstPoint : undefined;\n      }),\n      secondPoint: computed(() => {\n        return secondPointVisible.value ? ruler.value.secondPoint : undefined;\n      }),\n      length: computed(() => rulerStore.lengthByID[ruler.value.id]),\n    };\n  },\n});\n</script>\n\n<template>\n  <RulerSVG2D\n    v-show=\"currentSlice === ruler.slice\"\n    :view-id=\"viewId\"\n    :point1=\"firstPoint\"\n    :point2=\"secondPoint\"\n    :color=\"ruler.color\"\n    :length=\"length\"\n  />\n</template>\n","<template>\n  <div class=\"overlay-no-events\">\n    <svg class=\"overlay-no-events\">\n      <RulerWidget2D\n        v-for=\"ruler in rulers\"\n        :key=\"ruler.id\"\n        :ruler-id=\"ruler.id\"\n        :is-placing=\"ruler.id === placingRulerID\"\n        :current-slice=\"currentSlice\"\n        :view-id=\"viewId\"\n        :view-direction=\"viewDirection\"\n        :widget-manager=\"widgetManager\"\n        @contextmenu=\"openContextMenu(ruler.id, $event)\"\n        @placed=\"onRulerPlaced\"\n      />\n    </svg>\n    <v-menu\n      v-model=\"contextMenu.show\"\n      class=\"position-absolute\"\n      :style=\"{\n        top: `${contextMenu.y}px`,\n        left: `${contextMenu.x}px`,\n      }\"\n      close-on-click\n      close-on-content-click\n    >\n      <v-list density=\"compact\">\n        <v-list-item @click=\"deleteRulerFromContextMenu\">\n          <v-list-item-title>Delete</v-list-item-title>\n        </v-list-item>\n      </v-list>\n    </v-menu>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport {\n  computed,\n  defineComponent,\n  onUnmounted,\n  PropType,\n  reactive,\n  ref,\n  toRefs,\n  watch,\n} from 'vue';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useToolStore } from '@/src/store/tools';\nimport { Tools } from '@/src/store/tools/types';\nimport { useRulerStore } from '@/src/store/tools/rulers';\nimport { getLPSAxisFromDir } from '@/src/utils/lps';\nimport RulerWidget2D from '@/src/components/tools/ruler/RulerWidget2D.vue';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport type { Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport { storeToRefs } from 'pinia';\nimport {\n  FrameOfReference,\n  frameOfReferenceToImageSliceAndAxis,\n} from '@/src/utils/frameOfReference';\nimport { Ruler } from '@/src/types/ruler';\nimport { vec3 } from 'gl-matrix';\n\nexport default defineComponent({\n  name: 'RulerTool',\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n    currentSlice: {\n      type: Number,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n  },\n  components: {\n    RulerWidget2D,\n  },\n  setup(props) {\n    const { viewDirection, currentSlice } = toRefs(props);\n    const toolStore = useToolStore();\n    const rulerStore = useRulerStore();\n    const { rulers, activeLabel } = storeToRefs(rulerStore);\n\n    const { currentImageID, currentImageMetadata } = useCurrentImage();\n    const isToolActive = computed(() => toolStore.currentTool === Tools.Ruler);\n    const viewAxis = computed(() => getLPSAxisFromDir(viewDirection.value));\n\n    const placingRulerID = ref<string | null>(null);\n\n    // --- active ruler management --- //\n\n    watch(\n      placingRulerID,\n      (id, prevId) => {\n        if (prevId != null) {\n          rulerStore.updateRuler(prevId, { placing: false });\n        }\n        if (id != null) {\n          rulerStore.updateRuler(id, { placing: true });\n        }\n      },\n      { immediate: true }\n    );\n\n    watch(\n      [isToolActive, currentImageID] as const,\n      ([active, imageID]) => {\n        if (placingRulerID.value != null) {\n          rulerStore.removeRuler(placingRulerID.value);\n          placingRulerID.value = null;\n        }\n        if (active && imageID) {\n          placingRulerID.value = rulerStore.addRuler({\n            imageID,\n            placing: true,\n          });\n        }\n      },\n      { immediate: true }\n    );\n\n    watch(\n      [activeLabel, placingRulerID],\n      ([label, placingTool]) => {\n        if (placingTool != null) {\n          rulerStore.updateRuler(placingTool, {\n            label,\n            ...(label && rulerStore.labels[label]),\n          });\n        }\n      },\n      { immediate: true }\n    );\n\n    onUnmounted(() => {\n      if (placingRulerID.value != null) {\n        rulerStore.removeRuler(placingRulerID.value);\n        placingRulerID.value = null;\n      }\n    });\n\n    const onRulerPlaced = () => {\n      if (currentImageID.value) {\n        placingRulerID.value = rulerStore.addRuler({\n          imageID: currentImageID.value,\n          placing: true,\n        });\n      }\n    };\n\n    // --- updating active ruler frame --- //\n\n    // TODO useCurrentFrameOfReference(viewDirection)\n    const getCurrentFrameOfReference = (): FrameOfReference => {\n      const { lpsOrientation, indexToWorld } = currentImageMetadata.value;\n      const planeNormal = lpsOrientation[viewDirection.value] as Vector3;\n\n      const lpsIdx = lpsOrientation[viewAxis.value];\n      const planeOrigin: Vector3 = [0, 0, 0];\n      planeOrigin[lpsIdx] = currentSlice.value;\n      // convert index pt to world pt\n      vec3.transformMat4(planeOrigin, planeOrigin, indexToWorld);\n\n      return {\n        planeNormal,\n        planeOrigin,\n      };\n    };\n\n    // update active ruler's frame + slice, since the\n    // active ruler is not finalized.\n    watch(\n      [currentSlice, placingRulerID] as const,\n      ([slice, rulerID]) => {\n        if (!rulerID) return;\n        rulerStore.updateRuler(rulerID, {\n          frameOfReference: getCurrentFrameOfReference(),\n          slice,\n        });\n      },\n      { immediate: true }\n    );\n\n    // --- context menu --- //\n\n    const contextMenu = reactive({\n      show: false,\n      x: 0,\n      y: 0,\n      forRulerID: '',\n    });\n\n    const openContextMenu = (rulerID: string, displayXY: Vector2) => {\n      [contextMenu.x, contextMenu.y] = displayXY;\n      contextMenu.show = true;\n      contextMenu.forRulerID = rulerID;\n    };\n\n    const deleteRulerFromContextMenu = () => {\n      rulerStore.removeRuler(contextMenu.forRulerID);\n    };\n\n    // --- ruler data --- //\n\n    // does the ruler's frame of reference match\n    // the view's axis\n    const doesRulerFrameMatchViewAxis = (ruler: Partial<Ruler>) => {\n      if (!ruler.frameOfReference) return false;\n      const rulerAxis = frameOfReferenceToImageSliceAndAxis(\n        ruler.frameOfReference,\n        currentImageMetadata.value,\n        {\n          allowOutOfBoundsSlice: true,\n        }\n      );\n      return !!rulerAxis && rulerAxis.axis === viewAxis.value;\n    };\n\n    const currentRulers = computed(() => {\n      const { lengthByID } = rulerStore;\n      const curImageID = currentImageID.value;\n\n      const rulerData = rulers.value\n        .filter((ruler) => {\n          // only show rulers for the current image\n          // and current view axis\n          return (\n            ruler.imageID === curImageID && doesRulerFrameMatchViewAxis(ruler)\n          );\n        })\n        .map((ruler) => {\n          return {\n            ...ruler,\n            length: lengthByID[ruler.id],\n          };\n        });\n\n      return rulerData;\n    });\n\n    return {\n      rulers: currentRulers,\n      placingRulerID,\n      contextMenu,\n      openContextMenu,\n      deleteRulerFromContextMenu,\n      onRulerPlaced,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","<template>\n  <div class=\"overlay-no-events\">\n    <svg class=\"overlay-no-events\">\n      <RulerWidget2D\n        v-for=\"ruler in rulers\"\n        :key=\"ruler.id\"\n        :ruler-id=\"ruler.id\"\n        :is-placing=\"ruler.id === placingRulerID\"\n        :current-slice=\"currentSlice\"\n        :view-id=\"viewId\"\n        :view-direction=\"viewDirection\"\n        :widget-manager=\"widgetManager\"\n        @contextmenu=\"openContextMenu(ruler.id, $event)\"\n        @placed=\"onRulerPlaced\"\n      />\n    </svg>\n    <v-menu\n      v-model=\"contextMenu.show\"\n      class=\"position-absolute\"\n      :style=\"{\n        top: `${contextMenu.y}px`,\n        left: `${contextMenu.x}px`,\n      }\"\n      close-on-click\n      close-on-content-click\n    >\n      <v-list density=\"compact\">\n        <v-list-item @click=\"deleteRulerFromContextMenu\">\n          <v-list-item-title>Delete</v-list-item-title>\n        </v-list-item>\n      </v-list>\n    </v-menu>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport {\n  computed,\n  defineComponent,\n  onUnmounted,\n  PropType,\n  reactive,\n  ref,\n  toRefs,\n  watch,\n} from 'vue';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useToolStore } from '@/src/store/tools';\nimport { Tools } from '@/src/store/tools/types';\nimport { useRulerStore } from '@/src/store/tools/rulers';\nimport { getLPSAxisFromDir } from '@/src/utils/lps';\nimport RulerWidget2D from '@/src/components/tools/ruler/RulerWidget2D.vue';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport type { Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport { storeToRefs } from 'pinia';\nimport {\n  FrameOfReference,\n  frameOfReferenceToImageSliceAndAxis,\n} from '@/src/utils/frameOfReference';\nimport { Ruler } from '@/src/types/ruler';\nimport { vec3 } from 'gl-matrix';\n\nexport default defineComponent({\n  name: 'RulerTool',\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n    currentSlice: {\n      type: Number,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n  },\n  components: {\n    RulerWidget2D,\n  },\n  setup(props) {\n    const { viewDirection, currentSlice } = toRefs(props);\n    const toolStore = useToolStore();\n    const rulerStore = useRulerStore();\n    const { rulers, activeLabel } = storeToRefs(rulerStore);\n\n    const { currentImageID, currentImageMetadata } = useCurrentImage();\n    const isToolActive = computed(() => toolStore.currentTool === Tools.Ruler);\n    const viewAxis = computed(() => getLPSAxisFromDir(viewDirection.value));\n\n    const placingRulerID = ref<string | null>(null);\n\n    // --- active ruler management --- //\n\n    watch(\n      placingRulerID,\n      (id, prevId) => {\n        if (prevId != null) {\n          rulerStore.updateRuler(prevId, { placing: false });\n        }\n        if (id != null) {\n          rulerStore.updateRuler(id, { placing: true });\n        }\n      },\n      { immediate: true }\n    );\n\n    watch(\n      [isToolActive, currentImageID] as const,\n      ([active, imageID]) => {\n        if (placingRulerID.value != null) {\n          rulerStore.removeRuler(placingRulerID.value);\n          placingRulerID.value = null;\n        }\n        if (active && imageID) {\n          placingRulerID.value = rulerStore.addRuler({\n            imageID,\n            placing: true,\n          });\n        }\n      },\n      { immediate: true }\n    );\n\n    watch(\n      [activeLabel, placingRulerID],\n      ([label, placingTool]) => {\n        if (placingTool != null) {\n          rulerStore.updateRuler(placingTool, {\n            label,\n            ...(label && rulerStore.labels[label]),\n          });\n        }\n      },\n      { immediate: true }\n    );\n\n    onUnmounted(() => {\n      if (placingRulerID.value != null) {\n        rulerStore.removeRuler(placingRulerID.value);\n        placingRulerID.value = null;\n      }\n    });\n\n    const onRulerPlaced = () => {\n      if (currentImageID.value) {\n        placingRulerID.value = rulerStore.addRuler({\n          imageID: currentImageID.value,\n          placing: true,\n        });\n      }\n    };\n\n    // --- updating active ruler frame --- //\n\n    // TODO useCurrentFrameOfReference(viewDirection)\n    const getCurrentFrameOfReference = (): FrameOfReference => {\n      const { lpsOrientation, indexToWorld } = currentImageMetadata.value;\n      const planeNormal = lpsOrientation[viewDirection.value] as Vector3;\n\n      const lpsIdx = lpsOrientation[viewAxis.value];\n      const planeOrigin: Vector3 = [0, 0, 0];\n      planeOrigin[lpsIdx] = currentSlice.value;\n      // convert index pt to world pt\n      vec3.transformMat4(planeOrigin, planeOrigin, indexToWorld);\n\n      return {\n        planeNormal,\n        planeOrigin,\n      };\n    };\n\n    // update active ruler's frame + slice, since the\n    // active ruler is not finalized.\n    watch(\n      [currentSlice, placingRulerID] as const,\n      ([slice, rulerID]) => {\n        if (!rulerID) return;\n        rulerStore.updateRuler(rulerID, {\n          frameOfReference: getCurrentFrameOfReference(),\n          slice,\n        });\n      },\n      { immediate: true }\n    );\n\n    // --- context menu --- //\n\n    const contextMenu = reactive({\n      show: false,\n      x: 0,\n      y: 0,\n      forRulerID: '',\n    });\n\n    const openContextMenu = (rulerID: string, displayXY: Vector2) => {\n      [contextMenu.x, contextMenu.y] = displayXY;\n      contextMenu.show = true;\n      contextMenu.forRulerID = rulerID;\n    };\n\n    const deleteRulerFromContextMenu = () => {\n      rulerStore.removeRuler(contextMenu.forRulerID);\n    };\n\n    // --- ruler data --- //\n\n    // does the ruler's frame of reference match\n    // the view's axis\n    const doesRulerFrameMatchViewAxis = (ruler: Partial<Ruler>) => {\n      if (!ruler.frameOfReference) return false;\n      const rulerAxis = frameOfReferenceToImageSliceAndAxis(\n        ruler.frameOfReference,\n        currentImageMetadata.value,\n        {\n          allowOutOfBoundsSlice: true,\n        }\n      );\n      return !!rulerAxis && rulerAxis.axis === viewAxis.value;\n    };\n\n    const currentRulers = computed(() => {\n      const { lengthByID } = rulerStore;\n      const curImageID = currentImageID.value;\n\n      const rulerData = rulers.value\n        .filter((ruler) => {\n          // only show rulers for the current image\n          // and current view axis\n          return (\n            ruler.imageID === curImageID && doesRulerFrameMatchViewAxis(ruler)\n          );\n        })\n        .map((ruler) => {\n          return {\n            ...ruler,\n            length: lengthByID[ruler.id],\n          };\n        });\n\n      return rulerData;\n    });\n\n    return {\n      rulers: currentRulers,\n      placingRulerID,\n      contextMenu,\n      openContextMenu,\n      deleteRulerFromContextMenu,\n      onRulerPlaced,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","import macro from '@kitware/vtk.js/macro';\n\nimport vtkRulerWidget from '../RulerWidget';\n\nexport { InteractionState } from '../RulerWidget/behavior';\n// ----------------------------------------------------------------------------\n// Factory\n// ----------------------------------------------------------------------------\n\nfunction vtkRectangleWidget(publicAPI, model) {\n  model.classHierarchy.push('vtkRectangleWidget');\n}\n\n// ----------------------------------------------------------------------------\n\nconst DEFAULT_VALUES = {};\n\n// ----------------------------------------------------------------------------\n\nexport function extend(publicAPI, model, initialValues = {}) {\n  Object.assign(model, DEFAULT_VALUES, initialValues);\n\n  const { store: toolStore, ...rest } = initialValues;\n\n  const rulerStore = {\n    ...toolStore,\n    rulerByID: toolStore.toolByID,\n    updateRuler: toolStore.updateTool,\n  };\n\n  vtkRulerWidget.extend(publicAPI, model, { store: rulerStore, ...rest });\n\n  vtkRectangleWidget(publicAPI, model);\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(extend, 'vtkRectangleWidget');\n\n// ----------------------------------------------------------------------------\n\nexport default { newInstance, extend };\n","<template>\n  <g>\n    <rect\n      :x=\"rectangle.x\"\n      :y=\"rectangle.y\"\n      :width=\"rectangle.width\"\n      :height=\"rectangle.height\"\n      :stroke=\"color\"\n      stroke-width=\"1\"\n      :fill=\"fillColor\"\n    />\n    <!-- radius is related to the vtkRectangleWidget scale, specified in state -->\n    <circle\n      v-if=\"first\"\n      :cx=\"first.x\"\n      :cy=\"first.y\"\n      :stroke=\"color\"\n      stroke-width=\"1\"\n      fill=\"transparent\"\n      :r=\"10 / devicePixelRatio\"\n    />\n    <circle\n      v-if=\"second\"\n      :cx=\"second.x\"\n      :cy=\"second.y\"\n      :stroke=\"color\"\n      stroke-width=\"1\"\n      fill=\"transparent\"\n      :r=\"10 / devicePixelRatio\"\n    />\n  </g>\n</template>\n\n<script lang=\"ts\">\nimport { useResizeObserver } from '@/src/composables/useResizeObserver';\nimport { useVTKCallback } from '@/src/composables/useVTKCallback';\nimport { ToolContainer } from '@/src/constants';\nimport { useViewStore } from '@/src/store/views';\nimport { worldToSVG } from '@/src/utils/vtk-helpers';\nimport vtkLPSView2DProxy from '@/src/vtk/LPSView2DProxy';\nimport type { Vector3 } from '@kitware/vtk.js/types';\nimport {\n  PropType,\n  computed,\n  defineComponent,\n  toRefs,\n  unref,\n  ref,\n  watch,\n  inject,\n} from 'vue';\n\ntype SVGPoint = {\n  x: number;\n  y: number;\n};\n\nexport default defineComponent({\n  props: {\n    point1: Array as PropType<Array<number>>,\n    point2: Array as PropType<Array<number>>,\n    color: String,\n    fillColor: String,\n    viewId: {\n      type: String,\n      required: true,\n    },\n  },\n  setup(props) {\n    const { viewId: viewID, point1, point2 } = toRefs(props);\n    const firstPoint = ref<SVGPoint | null>();\n    const secondPoint = ref<SVGPoint | null>();\n\n    const viewStore = useViewStore();\n\n    const viewProxy = computed(\n      () => viewStore.getViewProxy<vtkLPSView2DProxy>(viewID.value)!\n    );\n\n    const updatePoints = () => {\n      const viewRenderer = viewProxy.value.getRenderer();\n      const pt1 = unref(point1) as Vector3 | undefined;\n      const pt2 = unref(point2) as Vector3 | undefined;\n      if (pt1) {\n        const point2D = worldToSVG(pt1, viewRenderer);\n        if (point2D) {\n          firstPoint.value = {\n            x: point2D[0],\n            y: point2D[1],\n          };\n        }\n      } else {\n        firstPoint.value = null;\n      }\n\n      if (pt2) {\n        const point2D = worldToSVG(pt2, viewRenderer);\n        if (point2D) {\n          secondPoint.value = {\n            x: point2D[0],\n            y: point2D[1],\n          };\n        }\n      } else {\n        secondPoint.value = null;\n      }\n    };\n\n    const rectangle = computed(() => {\n      const [firstX, firstY] = [\n        firstPoint.value?.x ?? 0,\n        firstPoint.value?.y ?? 0,\n      ];\n      const [secondX, secondY] = [\n        secondPoint.value?.x ?? firstX,\n        secondPoint.value?.y ?? firstY,\n      ];\n      return {\n        x: Math.min(firstX, secondX),\n        y: Math.min(firstY, secondY),\n        width: Math.abs(firstX - secondX),\n        height: Math.abs(firstY - secondY),\n      };\n    });\n\n    const cameraOnModified = useVTKCallback(\n      computed(() => viewProxy.value.getCamera().onModified)\n    );\n    cameraOnModified(updatePoints);\n\n    watch([viewProxy, point1, point2], updatePoints, {\n      deep: true,\n      immediate: true,\n    });\n\n    // --- resize --- //\n\n    const containerEl = inject(ToolContainer)!;\n\n    useResizeObserver(containerEl, () => {\n      updatePoints();\n    });\n\n    return {\n      devicePixelRatio,\n      first: firstPoint,\n      second: secondPoint,\n      rectangle,\n    };\n  },\n});\n</script>\n","<template>\n  <g>\n    <rect\n      :x=\"rectangle.x\"\n      :y=\"rectangle.y\"\n      :width=\"rectangle.width\"\n      :height=\"rectangle.height\"\n      :stroke=\"color\"\n      stroke-width=\"1\"\n      :fill=\"fillColor\"\n    />\n    <!-- radius is related to the vtkRectangleWidget scale, specified in state -->\n    <circle\n      v-if=\"first\"\n      :cx=\"first.x\"\n      :cy=\"first.y\"\n      :stroke=\"color\"\n      stroke-width=\"1\"\n      fill=\"transparent\"\n      :r=\"10 / devicePixelRatio\"\n    />\n    <circle\n      v-if=\"second\"\n      :cx=\"second.x\"\n      :cy=\"second.y\"\n      :stroke=\"color\"\n      stroke-width=\"1\"\n      fill=\"transparent\"\n      :r=\"10 / devicePixelRatio\"\n    />\n  </g>\n</template>\n\n<script lang=\"ts\">\nimport { useResizeObserver } from '@/src/composables/useResizeObserver';\nimport { useVTKCallback } from '@/src/composables/useVTKCallback';\nimport { ToolContainer } from '@/src/constants';\nimport { useViewStore } from '@/src/store/views';\nimport { worldToSVG } from '@/src/utils/vtk-helpers';\nimport vtkLPSView2DProxy from '@/src/vtk/LPSView2DProxy';\nimport type { Vector3 } from '@kitware/vtk.js/types';\nimport {\n  PropType,\n  computed,\n  defineComponent,\n  toRefs,\n  unref,\n  ref,\n  watch,\n  inject,\n} from 'vue';\n\ntype SVGPoint = {\n  x: number;\n  y: number;\n};\n\nexport default defineComponent({\n  props: {\n    point1: Array as PropType<Array<number>>,\n    point2: Array as PropType<Array<number>>,\n    color: String,\n    fillColor: String,\n    viewId: {\n      type: String,\n      required: true,\n    },\n  },\n  setup(props) {\n    const { viewId: viewID, point1, point2 } = toRefs(props);\n    const firstPoint = ref<SVGPoint | null>();\n    const secondPoint = ref<SVGPoint | null>();\n\n    const viewStore = useViewStore();\n\n    const viewProxy = computed(\n      () => viewStore.getViewProxy<vtkLPSView2DProxy>(viewID.value)!\n    );\n\n    const updatePoints = () => {\n      const viewRenderer = viewProxy.value.getRenderer();\n      const pt1 = unref(point1) as Vector3 | undefined;\n      const pt2 = unref(point2) as Vector3 | undefined;\n      if (pt1) {\n        const point2D = worldToSVG(pt1, viewRenderer);\n        if (point2D) {\n          firstPoint.value = {\n            x: point2D[0],\n            y: point2D[1],\n          };\n        }\n      } else {\n        firstPoint.value = null;\n      }\n\n      if (pt2) {\n        const point2D = worldToSVG(pt2, viewRenderer);\n        if (point2D) {\n          secondPoint.value = {\n            x: point2D[0],\n            y: point2D[1],\n          };\n        }\n      } else {\n        secondPoint.value = null;\n      }\n    };\n\n    const rectangle = computed(() => {\n      const [firstX, firstY] = [\n        firstPoint.value?.x ?? 0,\n        firstPoint.value?.y ?? 0,\n      ];\n      const [secondX, secondY] = [\n        secondPoint.value?.x ?? firstX,\n        secondPoint.value?.y ?? firstY,\n      ];\n      return {\n        x: Math.min(firstX, secondX),\n        y: Math.min(firstY, secondY),\n        width: Math.abs(firstX - secondX),\n        height: Math.abs(firstY - secondY),\n      };\n    });\n\n    const cameraOnModified = useVTKCallback(\n      computed(() => viewProxy.value.getCamera().onModified)\n    );\n    cameraOnModified(updatePoints);\n\n    watch([viewProxy, point1, point2], updatePoints, {\n      deep: true,\n      immediate: true,\n    });\n\n    // --- resize --- //\n\n    const containerEl = inject(ToolContainer)!;\n\n    useResizeObserver(containerEl, () => {\n      updatePoints();\n    });\n\n    return {\n      devicePixelRatio,\n      first: firstPoint,\n      second: secondPoint,\n      rectangle,\n    };\n  },\n});\n</script>\n","<script lang=\"ts\">\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport {\n  computed,\n  defineComponent,\n  onBeforeUnmount,\n  onMounted,\n  onUnmounted,\n  PropType,\n  Ref,\n  ref,\n  toRefs,\n  watch,\n  watchEffect,\n} from 'vue';\nimport vtkPlaneManipulator from '@kitware/vtk.js/Widgets/Manipulators/PlaneManipulator';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { updatePlaneManipulatorFor2DView } from '@/src/utils/manipulators';\nimport type { vtkSubscription } from '@kitware/vtk.js/interfaces';\nimport { getCSSCoordinatesFromEvent } from '@/src/utils/vtk-helpers';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport { useVTKCallback } from '@/src/composables/useVTKCallback';\nimport { useRectangleStore } from '@/src/store/tools/rectangles';\nimport vtkRectangleWidget, {\n  vtkRectangleViewWidget,\n  InteractionState,\n} from '@/src/vtk/RectangleWidget';\nimport RectangleSVG2D from '@/src/components/tools/rectangle/RectangleSVG2D.vue';\nimport { vtkRulerWidgetPointState } from '@/src/vtk/RulerWidget';\nimport { watchOnce } from '@vueuse/core';\nimport { RectangleID } from '@/src/types/rectangle';\n\nconst useStore = useRectangleStore;\nconst vtkWidgetFactory = vtkRectangleWidget;\ntype WidgetView = vtkRectangleViewWidget;\ntype vtkWidgetPointState = vtkRulerWidgetPointState;\ntype ToolID = RectangleID;\nconst SVG2DComponent = RectangleSVG2D;\n\nexport default defineComponent({\n  name: 'RectangleWidget2D',\n  emits: ['placed', 'contextmenu'],\n  props: {\n    toolId: {\n      type: String,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n    viewId: {\n      type: String,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    currentSlice: {\n      type: Number,\n      required: true,\n    },\n    isPlacing: {\n      type: Boolean,\n      default: false,\n    },\n  },\n  components: {\n    SVG2DComponent,\n  },\n  setup(props, { emit }) {\n    const {\n      toolId: stringToolId,\n      widgetManager,\n      viewDirection,\n      currentSlice,\n      isPlacing,\n    } = toRefs(props);\n    const toolId = ref(stringToolId.value) as Ref<ToolID>;\n\n    const toolStore = useStore();\n    const tool = computed(() => toolStore.toolByID[toolId.value]);\n    const { currentImageID, currentImageMetadata } = useCurrentImage();\n\n    const widgetFactory = vtkWidgetFactory.newInstance({\n      id: toolId.value,\n      store: toolStore,\n      isPlaced: !isPlacing.value,\n    });\n    const widget = ref<WidgetView | null>(null);\n\n    onMounted(() => {\n      widget.value = widgetManager.value.addWidget(widgetFactory) as WidgetView;\n    });\n\n    onUnmounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      widgetManager.value.removeWidget(widget.value);\n      widget.value.delete();\n      widgetFactory.delete();\n    });\n\n    watch(\n      [isPlacing, widget],\n      ([placing, widget_]) => {\n        if (placing && widget_) {\n          widget_.setInteractionState(InteractionState.PlacingFirst);\n        }\n      },\n      { immediate: true }\n    );\n\n    // --- reset on slice/image changes --- //\n\n    watch([currentSlice, currentImageID, widget], () => {\n      const isPlaced = widget.value?.getWidgetState().getIsPlaced();\n      if (widget.value && !isPlaced) {\n        widget.value.resetInteractions();\n        widget.value.setInteractionState(InteractionState.PlacingFirst);\n      }\n    });\n\n    const onPlacedEvent = useVTKCallback(\n      computed(() => widget.value?.onPlacedEvent)\n    );\n\n    onPlacedEvent(() => {\n      emit('placed');\n    });\n\n    // --- right click handling --- //\n\n    let rightClickSub: vtkSubscription | null = null;\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      rightClickSub = widget.value.onRightClickEvent((eventData) => {\n        const coords = getCSSCoordinatesFromEvent(eventData);\n        if (coords) {\n          emit('contextmenu', coords);\n        }\n      });\n    });\n\n    onBeforeUnmount(() => {\n      if (rightClickSub) {\n        rightClickSub.unsubscribe();\n        rightClickSub = null;\n      }\n    });\n\n    // --- manipulator --- //\n\n    const manipulator = vtkPlaneManipulator.newInstance();\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      widget.value.setManipulator(manipulator);\n    });\n\n    watchEffect(() => {\n      updatePlaneManipulatorFor2DView(\n        manipulator,\n        viewDirection.value,\n        tool.value?.slice ?? currentSlice.value,\n        currentImageMetadata.value\n      );\n    });\n\n    // --- visibility --- //\n\n    // toggles the pickability of the tool handles,\n    // since the 3D tool parts are visually hidden.\n    watch(\n      () => !!widget.value && tool.value?.slice === currentSlice.value,\n      (visible) => {\n        widget.value?.setVisibility(visible);\n      },\n      { immediate: true }\n    );\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      // hide handle visibility, but not picking visibility\n      widget.value.setHandleVisibility(false);\n      widgetManager.value.renderWidgets();\n    });\n\n    // --- handle pick visibility --- //\n    const usePointVisibility = (\n      pointState: Ref<vtkWidgetPointState | undefined>\n    ) => {\n      const visible = ref(false);\n      const updateVisibility = () => {\n        if (!pointState.value) return;\n        visible.value = pointState.value.getVisible();\n      };\n      const onModified = useVTKCallback(\n        computed(() => pointState.value?.onModified)\n      );\n      onModified(() => updateVisibility());\n      watchOnce(pointState, () => updateVisibility());\n      return visible;\n    };\n\n    const firstPointVisible = usePointVisibility(\n      computed(() => widget.value?.getWidgetState().getFirstPoint())\n    );\n    const secondPointVisible = usePointVisibility(\n      computed(() => widget.value?.getWidgetState().getSecondPoint())\n    );\n\n    return {\n      tool,\n      firstPoint: computed(() => {\n        return firstPointVisible.value ? tool.value.firstPoint : undefined;\n      }),\n      secondPoint: computed(() => {\n        return secondPointVisible.value ? tool.value.secondPoint : undefined;\n      }),\n    };\n  },\n});\n</script>\n\n<template>\n  <SVG2DComponent\n    v-show=\"currentSlice === tool.slice\"\n    :view-id=\"viewId\"\n    :point1=\"firstPoint\"\n    :point2=\"secondPoint\"\n    :color=\"tool.color\"\n    :fill-color=\"tool.fillColor\"\n  />\n</template>\n","<script lang=\"ts\">\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport {\n  computed,\n  defineComponent,\n  onBeforeUnmount,\n  onMounted,\n  onUnmounted,\n  PropType,\n  Ref,\n  ref,\n  toRefs,\n  watch,\n  watchEffect,\n} from 'vue';\nimport vtkPlaneManipulator from '@kitware/vtk.js/Widgets/Manipulators/PlaneManipulator';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { updatePlaneManipulatorFor2DView } from '@/src/utils/manipulators';\nimport type { vtkSubscription } from '@kitware/vtk.js/interfaces';\nimport { getCSSCoordinatesFromEvent } from '@/src/utils/vtk-helpers';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport { useVTKCallback } from '@/src/composables/useVTKCallback';\nimport { useRectangleStore } from '@/src/store/tools/rectangles';\nimport vtkRectangleWidget, {\n  vtkRectangleViewWidget,\n  InteractionState,\n} from '@/src/vtk/RectangleWidget';\nimport RectangleSVG2D from '@/src/components/tools/rectangle/RectangleSVG2D.vue';\nimport { vtkRulerWidgetPointState } from '@/src/vtk/RulerWidget';\nimport { watchOnce } from '@vueuse/core';\nimport { RectangleID } from '@/src/types/rectangle';\n\nconst useStore = useRectangleStore;\nconst vtkWidgetFactory = vtkRectangleWidget;\ntype WidgetView = vtkRectangleViewWidget;\ntype vtkWidgetPointState = vtkRulerWidgetPointState;\ntype ToolID = RectangleID;\nconst SVG2DComponent = RectangleSVG2D;\n\nexport default defineComponent({\n  name: 'RectangleWidget2D',\n  emits: ['placed', 'contextmenu'],\n  props: {\n    toolId: {\n      type: String,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n    viewId: {\n      type: String,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    currentSlice: {\n      type: Number,\n      required: true,\n    },\n    isPlacing: {\n      type: Boolean,\n      default: false,\n    },\n  },\n  components: {\n    SVG2DComponent,\n  },\n  setup(props, { emit }) {\n    const {\n      toolId: stringToolId,\n      widgetManager,\n      viewDirection,\n      currentSlice,\n      isPlacing,\n    } = toRefs(props);\n    const toolId = ref(stringToolId.value) as Ref<ToolID>;\n\n    const toolStore = useStore();\n    const tool = computed(() => toolStore.toolByID[toolId.value]);\n    const { currentImageID, currentImageMetadata } = useCurrentImage();\n\n    const widgetFactory = vtkWidgetFactory.newInstance({\n      id: toolId.value,\n      store: toolStore,\n      isPlaced: !isPlacing.value,\n    });\n    const widget = ref<WidgetView | null>(null);\n\n    onMounted(() => {\n      widget.value = widgetManager.value.addWidget(widgetFactory) as WidgetView;\n    });\n\n    onUnmounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      widgetManager.value.removeWidget(widget.value);\n      widget.value.delete();\n      widgetFactory.delete();\n    });\n\n    watch(\n      [isPlacing, widget],\n      ([placing, widget_]) => {\n        if (placing && widget_) {\n          widget_.setInteractionState(InteractionState.PlacingFirst);\n        }\n      },\n      { immediate: true }\n    );\n\n    // --- reset on slice/image changes --- //\n\n    watch([currentSlice, currentImageID, widget], () => {\n      const isPlaced = widget.value?.getWidgetState().getIsPlaced();\n      if (widget.value && !isPlaced) {\n        widget.value.resetInteractions();\n        widget.value.setInteractionState(InteractionState.PlacingFirst);\n      }\n    });\n\n    const onPlacedEvent = useVTKCallback(\n      computed(() => widget.value?.onPlacedEvent)\n    );\n\n    onPlacedEvent(() => {\n      emit('placed');\n    });\n\n    // --- right click handling --- //\n\n    let rightClickSub: vtkSubscription | null = null;\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      rightClickSub = widget.value.onRightClickEvent((eventData) => {\n        const coords = getCSSCoordinatesFromEvent(eventData);\n        if (coords) {\n          emit('contextmenu', coords);\n        }\n      });\n    });\n\n    onBeforeUnmount(() => {\n      if (rightClickSub) {\n        rightClickSub.unsubscribe();\n        rightClickSub = null;\n      }\n    });\n\n    // --- manipulator --- //\n\n    const manipulator = vtkPlaneManipulator.newInstance();\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      widget.value.setManipulator(manipulator);\n    });\n\n    watchEffect(() => {\n      updatePlaneManipulatorFor2DView(\n        manipulator,\n        viewDirection.value,\n        tool.value?.slice ?? currentSlice.value,\n        currentImageMetadata.value\n      );\n    });\n\n    // --- visibility --- //\n\n    // toggles the pickability of the tool handles,\n    // since the 3D tool parts are visually hidden.\n    watch(\n      () => !!widget.value && tool.value?.slice === currentSlice.value,\n      (visible) => {\n        widget.value?.setVisibility(visible);\n      },\n      { immediate: true }\n    );\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      // hide handle visibility, but not picking visibility\n      widget.value.setHandleVisibility(false);\n      widgetManager.value.renderWidgets();\n    });\n\n    // --- handle pick visibility --- //\n    const usePointVisibility = (\n      pointState: Ref<vtkWidgetPointState | undefined>\n    ) => {\n      const visible = ref(false);\n      const updateVisibility = () => {\n        if (!pointState.value) return;\n        visible.value = pointState.value.getVisible();\n      };\n      const onModified = useVTKCallback(\n        computed(() => pointState.value?.onModified)\n      );\n      onModified(() => updateVisibility());\n      watchOnce(pointState, () => updateVisibility());\n      return visible;\n    };\n\n    const firstPointVisible = usePointVisibility(\n      computed(() => widget.value?.getWidgetState().getFirstPoint())\n    );\n    const secondPointVisible = usePointVisibility(\n      computed(() => widget.value?.getWidgetState().getSecondPoint())\n    );\n\n    return {\n      tool,\n      firstPoint: computed(() => {\n        return firstPointVisible.value ? tool.value.firstPoint : undefined;\n      }),\n      secondPoint: computed(() => {\n        return secondPointVisible.value ? tool.value.secondPoint : undefined;\n      }),\n    };\n  },\n});\n</script>\n\n<template>\n  <SVG2DComponent\n    v-show=\"currentSlice === tool.slice\"\n    :view-id=\"viewId\"\n    :point1=\"firstPoint\"\n    :point2=\"secondPoint\"\n    :color=\"tool.color\"\n    :fill-color=\"tool.fillColor\"\n  />\n</template>\n","<template>\n  <div class=\"overlay-no-events\">\n    <svg class=\"overlay-no-events\">\n      <RectangleWidget2D\n        v-for=\"tool in tools\"\n        :key=\"tool.id\"\n        :tool-id=\"tool.id\"\n        :is-placing=\"tool.id === placingToolID\"\n        :current-slice=\"currentSlice\"\n        :view-id=\"viewId\"\n        :view-direction=\"viewDirection\"\n        :widget-manager=\"widgetManager\"\n        @contextmenu=\"openContextMenu(tool.id, $event)\"\n        @placed=\"onToolPlaced\"\n      />\n    </svg>\n    <v-menu\n      v-model=\"contextMenu.show\"\n      class=\"position-absolute\"\n      :style=\"{\n        top: `${contextMenu.y}px`,\n        left: `${contextMenu.x}px`,\n      }\"\n      close-on-click\n      close-on-content-click\n    >\n      <v-list density=\"compact\">\n        <v-list-item @click=\"deleteToolFromContextMenu\">\n          <v-list-item-title>Delete</v-list-item-title>\n        </v-list-item>\n      </v-list>\n    </v-menu>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport {\n  computed,\n  defineComponent,\n  onUnmounted,\n  PropType,\n  reactive,\n  ref,\n  toRefs,\n  watch,\n} from 'vue';\nimport { storeToRefs } from 'pinia';\nimport { vec3 } from 'gl-matrix';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useToolStore } from '@/src/store/tools';\nimport { Tools } from '@/src/store/tools/types';\nimport { getLPSAxisFromDir } from '@/src/utils/lps';\nimport RectangleWidget2D from '@/src/components/tools/rectangle/RectangleWidget2D.vue';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport type { Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport {\n  FrameOfReference,\n  frameOfReferenceToImageSliceAndAxis,\n} from '@/src/utils/frameOfReference';\nimport { useRectangleStore } from '@/src/store/tools/rectangles';\nimport { Rectangle, RectangleID } from '@/src/types/rectangle';\n\ntype ToolID = RectangleID;\ntype Tool = Rectangle;\nconst useActiveToolStore = useRectangleStore;\n\nexport default defineComponent({\n  name: 'RectangleTool',\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n    currentSlice: {\n      type: Number,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n  },\n  components: {\n    RectangleWidget2D,\n  },\n  setup(props) {\n    const { viewDirection, currentSlice } = toRefs(props);\n    const toolStore = useToolStore();\n    const activeToolStore = useActiveToolStore();\n    const { tools, activeLabel } = storeToRefs(activeToolStore);\n\n    const { currentImageID, currentImageMetadata } = useCurrentImage();\n    const isToolActive = computed(\n      () => toolStore.currentTool === Tools.Rectangle\n    );\n    const viewAxis = computed(() => getLPSAxisFromDir(viewDirection.value));\n\n    const placingToolID = ref<RectangleID | null>(null);\n\n    // --- active tool management --- //\n\n    watch(\n      placingToolID,\n      (id, prevId) => {\n        if (prevId != null) {\n          activeToolStore.updateTool(prevId, { placing: false });\n        }\n        if (id != null) {\n          activeToolStore.updateTool(id, { placing: true });\n        }\n      },\n      { immediate: true }\n    );\n\n    watch(\n      [isToolActive, currentImageID] as const,\n      ([active, imageID]) => {\n        if (placingToolID.value != null) {\n          activeToolStore.removeTool(placingToolID.value);\n          placingToolID.value = null;\n        }\n        if (active && imageID) {\n          placingToolID.value = activeToolStore.addTool({\n            imageID,\n            placing: true,\n          });\n        }\n      },\n      { immediate: true }\n    );\n\n    watch(\n      [activeLabel, placingToolID],\n      ([label, placingTool]) => {\n        if (placingTool != null) {\n          activeToolStore.updateTool(placingTool, {\n            label,\n            ...(label && activeToolStore.labels[label]),\n          });\n        }\n      },\n      { immediate: true }\n    );\n\n    onUnmounted(() => {\n      if (placingToolID.value != null) {\n        activeToolStore.removeTool(placingToolID.value);\n        placingToolID.value = null;\n      }\n    });\n\n    const onToolPlaced = () => {\n      if (currentImageID.value) {\n        placingToolID.value = activeToolStore.addTool({\n          imageID: currentImageID.value,\n          placing: true,\n        });\n      }\n    };\n\n    // --- updating active tool frame --- //\n\n    // TODO useCurrentFrameOfReference(viewDirection)\n    const getCurrentFrameOfReference = (): FrameOfReference => {\n      const { lpsOrientation, indexToWorld } = currentImageMetadata.value;\n      const planeNormal = lpsOrientation[viewDirection.value] as Vector3;\n      const lpsIdx = lpsOrientation[viewAxis.value];\n      const planeOrigin: Vector3 = [0, 0, 0];\n      planeOrigin[lpsIdx] = currentSlice.value;\n      // convert index pt to world pt\n      vec3.transformMat4(planeOrigin, planeOrigin, indexToWorld);\n      return {\n        planeNormal,\n        planeOrigin,\n      };\n    };\n    // update active ruler's frame + slice, since the\n    // active ruler is not finalized.\n    watch(\n      [currentSlice, placingToolID] as const,\n      ([slice, toolID]) => {\n        if (!toolID) return;\n        activeToolStore.updateTool(toolID, {\n          frameOfReference: getCurrentFrameOfReference(),\n          slice,\n        });\n      },\n      { immediate: true }\n    );\n\n    // --- context menu --- //\n\n    const contextMenu = reactive({\n      show: false,\n      x: 0,\n      y: 0,\n      forToolID: '' as ToolID,\n    });\n\n    const openContextMenu = (toolID: ToolID, displayXY: Vector2) => {\n      [contextMenu.x, contextMenu.y] = displayXY;\n      contextMenu.show = true;\n      contextMenu.forToolID = toolID;\n    };\n\n    const deleteToolFromContextMenu = () => {\n      activeToolStore.removeTool(contextMenu.forToolID);\n    };\n\n    // --- tool data --- //\n\n    // does the tools's frame of reference match\n    // the view's axis\n    const doesToolFrameMatchViewAxis = (tool: Partial<Tool>) => {\n      if (!tool.frameOfReference) return false;\n      const toolAxis = frameOfReferenceToImageSliceAndAxis(\n        tool.frameOfReference,\n        currentImageMetadata.value,\n        {\n          allowOutOfBoundsSlice: true,\n        }\n      );\n      return !!toolAxis && toolAxis.axis === viewAxis.value;\n    };\n\n    const currentTools = computed(() => {\n      const curImageID = currentImageID.value;\n\n      return tools.value.filter((tool) => {\n        // only show tools for the current image\n        // and current view axis\n        return tool.imageID === curImageID && doesToolFrameMatchViewAxis(tool);\n      });\n    });\n\n    return {\n      tools: currentTools,\n      placingToolID,\n      contextMenu,\n      openContextMenu,\n      deleteToolFromContextMenu,\n      onToolPlaced,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","<template>\n  <div class=\"overlay-no-events\">\n    <svg class=\"overlay-no-events\">\n      <RectangleWidget2D\n        v-for=\"tool in tools\"\n        :key=\"tool.id\"\n        :tool-id=\"tool.id\"\n        :is-placing=\"tool.id === placingToolID\"\n        :current-slice=\"currentSlice\"\n        :view-id=\"viewId\"\n        :view-direction=\"viewDirection\"\n        :widget-manager=\"widgetManager\"\n        @contextmenu=\"openContextMenu(tool.id, $event)\"\n        @placed=\"onToolPlaced\"\n      />\n    </svg>\n    <v-menu\n      v-model=\"contextMenu.show\"\n      class=\"position-absolute\"\n      :style=\"{\n        top: `${contextMenu.y}px`,\n        left: `${contextMenu.x}px`,\n      }\"\n      close-on-click\n      close-on-content-click\n    >\n      <v-list density=\"compact\">\n        <v-list-item @click=\"deleteToolFromContextMenu\">\n          <v-list-item-title>Delete</v-list-item-title>\n        </v-list-item>\n      </v-list>\n    </v-menu>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport {\n  computed,\n  defineComponent,\n  onUnmounted,\n  PropType,\n  reactive,\n  ref,\n  toRefs,\n  watch,\n} from 'vue';\nimport { storeToRefs } from 'pinia';\nimport { vec3 } from 'gl-matrix';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useToolStore } from '@/src/store/tools';\nimport { Tools } from '@/src/store/tools/types';\nimport { getLPSAxisFromDir } from '@/src/utils/lps';\nimport RectangleWidget2D from '@/src/components/tools/rectangle/RectangleWidget2D.vue';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport type { Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport {\n  FrameOfReference,\n  frameOfReferenceToImageSliceAndAxis,\n} from '@/src/utils/frameOfReference';\nimport { useRectangleStore } from '@/src/store/tools/rectangles';\nimport { Rectangle, RectangleID } from '@/src/types/rectangle';\n\ntype ToolID = RectangleID;\ntype Tool = Rectangle;\nconst useActiveToolStore = useRectangleStore;\n\nexport default defineComponent({\n  name: 'RectangleTool',\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n    currentSlice: {\n      type: Number,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n  },\n  components: {\n    RectangleWidget2D,\n  },\n  setup(props) {\n    const { viewDirection, currentSlice } = toRefs(props);\n    const toolStore = useToolStore();\n    const activeToolStore = useActiveToolStore();\n    const { tools, activeLabel } = storeToRefs(activeToolStore);\n\n    const { currentImageID, currentImageMetadata } = useCurrentImage();\n    const isToolActive = computed(\n      () => toolStore.currentTool === Tools.Rectangle\n    );\n    const viewAxis = computed(() => getLPSAxisFromDir(viewDirection.value));\n\n    const placingToolID = ref<RectangleID | null>(null);\n\n    // --- active tool management --- //\n\n    watch(\n      placingToolID,\n      (id, prevId) => {\n        if (prevId != null) {\n          activeToolStore.updateTool(prevId, { placing: false });\n        }\n        if (id != null) {\n          activeToolStore.updateTool(id, { placing: true });\n        }\n      },\n      { immediate: true }\n    );\n\n    watch(\n      [isToolActive, currentImageID] as const,\n      ([active, imageID]) => {\n        if (placingToolID.value != null) {\n          activeToolStore.removeTool(placingToolID.value);\n          placingToolID.value = null;\n        }\n        if (active && imageID) {\n          placingToolID.value = activeToolStore.addTool({\n            imageID,\n            placing: true,\n          });\n        }\n      },\n      { immediate: true }\n    );\n\n    watch(\n      [activeLabel, placingToolID],\n      ([label, placingTool]) => {\n        if (placingTool != null) {\n          activeToolStore.updateTool(placingTool, {\n            label,\n            ...(label && activeToolStore.labels[label]),\n          });\n        }\n      },\n      { immediate: true }\n    );\n\n    onUnmounted(() => {\n      if (placingToolID.value != null) {\n        activeToolStore.removeTool(placingToolID.value);\n        placingToolID.value = null;\n      }\n    });\n\n    const onToolPlaced = () => {\n      if (currentImageID.value) {\n        placingToolID.value = activeToolStore.addTool({\n          imageID: currentImageID.value,\n          placing: true,\n        });\n      }\n    };\n\n    // --- updating active tool frame --- //\n\n    // TODO useCurrentFrameOfReference(viewDirection)\n    const getCurrentFrameOfReference = (): FrameOfReference => {\n      const { lpsOrientation, indexToWorld } = currentImageMetadata.value;\n      const planeNormal = lpsOrientation[viewDirection.value] as Vector3;\n      const lpsIdx = lpsOrientation[viewAxis.value];\n      const planeOrigin: Vector3 = [0, 0, 0];\n      planeOrigin[lpsIdx] = currentSlice.value;\n      // convert index pt to world pt\n      vec3.transformMat4(planeOrigin, planeOrigin, indexToWorld);\n      return {\n        planeNormal,\n        planeOrigin,\n      };\n    };\n    // update active ruler's frame + slice, since the\n    // active ruler is not finalized.\n    watch(\n      [currentSlice, placingToolID] as const,\n      ([slice, toolID]) => {\n        if (!toolID) return;\n        activeToolStore.updateTool(toolID, {\n          frameOfReference: getCurrentFrameOfReference(),\n          slice,\n        });\n      },\n      { immediate: true }\n    );\n\n    // --- context menu --- //\n\n    const contextMenu = reactive({\n      show: false,\n      x: 0,\n      y: 0,\n      forToolID: '' as ToolID,\n    });\n\n    const openContextMenu = (toolID: ToolID, displayXY: Vector2) => {\n      [contextMenu.x, contextMenu.y] = displayXY;\n      contextMenu.show = true;\n      contextMenu.forToolID = toolID;\n    };\n\n    const deleteToolFromContextMenu = () => {\n      activeToolStore.removeTool(contextMenu.forToolID);\n    };\n\n    // --- tool data --- //\n\n    // does the tools's frame of reference match\n    // the view's axis\n    const doesToolFrameMatchViewAxis = (tool: Partial<Tool>) => {\n      if (!tool.frameOfReference) return false;\n      const toolAxis = frameOfReferenceToImageSliceAndAxis(\n        tool.frameOfReference,\n        currentImageMetadata.value,\n        {\n          allowOutOfBoundsSlice: true,\n        }\n      );\n      return !!toolAxis && toolAxis.axis === viewAxis.value;\n    };\n\n    const currentTools = computed(() => {\n      const curImageID = currentImageID.value;\n\n      return tools.value.filter((tool) => {\n        // only show tools for the current image\n        // and current view axis\n        return tool.imageID === curImageID && doesToolFrameMatchViewAxis(tool);\n      });\n    });\n\n    return {\n      tools: currentTools,\n      placingToolID,\n      contextMenu,\n      openContextMenu,\n      deleteToolFromContextMenu,\n      onToolPlaced,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","import macro from '@kitware/vtk.js/macros';\nimport vtkActor from '@kitware/vtk.js/Rendering/Core/Actor';\nimport vtkMapper from '@kitware/vtk.js/Rendering/Core/Mapper';\nimport vtkWidgetRepresentation from '@kitware/vtk.js/Widgets/Representations/WidgetRepresentation';\nimport vtkPolyData from '@kitware/vtk.js/Common/DataModel/PolyData';\nimport { RenderingTypes } from '@kitware/vtk.js/Widgets/Core/WidgetManager/Constants';\nimport { vec2, vec3 } from 'gl-matrix';\nimport { transform2dTo3d } from '@/src/core/contours/referencePlane';\n\nconst PICKING_LINE_WIDTH = 32;\nconst DEFAULT_LINE_WIDTH = 2;\nconst SELECTED_LINE_WIDTH = 4;\n\nfunction vtkContourRepresentation(publicAPI, model) {\n  // Set our className\n  model.classHierarchy.push('vtkContourRepresentation');\n\n  model._polyData = vtkPolyData.newInstance({ mtime: 0 });\n  model._pdPoints = null;\n  model._pdLines = null;\n\n  model._pipelines = {\n    lines: {\n      source: publicAPI,\n      mapper: vtkMapper.newInstance(),\n      actor: vtkActor.newInstance({ parentProp: publicAPI }),\n    },\n  };\n\n  model._pipelines.lines.actor.getProperty().setLineWidth(2);\n  vtkWidgetRepresentation.connectPipeline(model._pipelines.lines);\n  publicAPI.addActor(model._pipelines.lines.actor);\n\n  publicAPI.getRepresentationStates = (input = model.inputData[0]) => input;\n\n  function allocatePolyDataArrays(contour) {\n    // reminder: polyLine is a flattened array of 2D points\n    const polyLine = contour.getPolyLine();\n    const refPlane = contour.getReferencePlane();\n    const numPoints = contour.getPolyLineLength();\n    const finalized = contour.getFinalized();\n    const closedAddition = finalized ? 1 : 0;\n\n    if (!polyLine || !refPlane) return;\n\n    if (model._pdPoints?.length !== numPoints * 3) {\n      model._pdPoints = new Float32Array(numPoints * 3);\n    }\n    if (model._pdLines?.length !== numPoints + 1) {\n      model._pdLines = new Float32Array(numPoints + 1 + closedAddition);\n    }\n\n    let ptOffset = 0;\n    let cellOffset = 0;\n\n    model._pdLines[cellOffset++] = numPoints + closedAddition;\n\n    const pt2d = vec2.create();\n    const pt3d = vec3.create();\n    for (let i = 0; i < polyLine.length; ) {\n      model._pdLines[cellOffset++] = ptOffset / 3;\n\n      vec3.set(pt2d, polyLine[i++], polyLine[i++]);\n      transform2dTo3d(pt2d, refPlane, pt3d);\n\n      /* eslint-disable prefer-destructuring */\n      model._pdPoints[ptOffset++] = pt3d[0];\n      model._pdPoints[ptOffset++] = pt3d[1];\n      model._pdPoints[ptOffset++] = pt3d[2];\n      /* eslint-enable prefer-destructuring */\n    }\n\n    if (finalized) {\n      model._pdLines[cellOffset] = 0;\n    }\n  }\n\n  let width = DEFAULT_LINE_WIDTH;\n\n  publicAPI.requestData = (inData, outData) => {\n    const contour = publicAPI.getRepresentationStates(inData[0]);\n\n    allocatePolyDataArrays(contour);\n\n    if (model._pdPoints && model._pdLines) {\n      model._polyData.getPoints().setData(model._pdPoints);\n      model._polyData.getLines().setData(model._pdLines);\n\n      model._polyData.getPoints().modified();\n      model._polyData.modified();\n    }\n\n    width = contour.getSelected() ? SELECTED_LINE_WIDTH : DEFAULT_LINE_WIDTH;\n    model._pipelines.lines.actor.getProperty().setLineWidth(width);\n    model._pipelines.lines.actor.getProperty().setColor(contour.getColor());\n\n    outData[0] = model._polyData;\n  };\n\n  /**\n   * When mousing over the line, if behavior != CONTEXT,\n   * returns the parent state.\n   * @param {object} prop\n   * @param {number} compositeID\n   * @returns {object}\n   */\n  publicAPI.getSelectedState = () => {\n    return model.inputData[0];\n  };\n\n  const { updateActorVisibility } = publicAPI;\n  publicAPI.updateActorVisibility = (\n    renderingType = RenderingTypes.FRONT_BUFFER,\n    ctxVisible = true,\n    handleVisible = true\n  ) => {\n    if (renderingType === RenderingTypes.PICKING_BUFFER) {\n      model._pipelines.lines.actor\n        .getProperty()\n        .setLineWidth(PICKING_LINE_WIDTH);\n    } else {\n      model._pipelines.lines.actor.getProperty().setLineWidth(width);\n    }\n    updateActorVisibility(renderingType, ctxVisible, handleVisible);\n  };\n}\n\n// ----------------------------------------------------------------------------\n// Object factory\n// ----------------------------------------------------------------------------\n\nconst DEFAULT_VALUES = {};\n\n// ----------------------------------------------------------------------------\n\nexport function extend(publicAPI, model, initialValues = {}) {\n  const newDefault = { ...DEFAULT_VALUES, ...initialValues };\n  vtkWidgetRepresentation.extend(publicAPI, model, newDefault);\n\n  vtkContourRepresentation(publicAPI, model);\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(\n  extend,\n  'vtkContourRepresentation'\n);\n\n// ----------------------------------------------------------------------------\n\nexport default { newInstance, extend };\n","import { Vector3 } from '@kitware/vtk.js/types';\nimport { vec3 } from 'gl-matrix';\n\nexport enum Mode {\n  Select = 'Select',\n  Freehand = 'Freehand',\n  Nudge = 'Nudge',\n  PointPlacing = 'PointPlacing',\n  Threshold = 'Threshold',\n}\n\nexport const InteractionState = {\n  Idle: 'Idle',\n  Moving: 'Moving',\n  FreehandDrawing: 'FreehandDrawing',\n  Nudging: 'Nudging',\n  PointPlacing: 'PointPlacing',\n  Thresholding: 'Thresholding',\n};\n\nexport function ignoreKey(e: any) {\n  return e.altKey || e.controlKey || e.shiftKey;\n}\n\nexport function getEventWorldPosition(model: any, callData: any) {\n  const pos = model.manipulator.handleEvent(\n    callData,\n    model._apiSpecificRenderWindow\n  );\n  return pos?.length === 3 ? pos : null;\n}\n\nexport function pickOrthogonalVector(vector: Vector3) {\n  // if there is a zero component, skip it.\n  const skipIndex = vector.findIndex((v) => v === 0) ?? 0;\n  const orthogonal = vec3.create();\n  // one possible orthogonal vector for [a,b,c] is [b,-a,0].\n  // We compute one such vector ignoring the min index, since it can be zero.\n  const c1Idx = (skipIndex + 1) % 3;\n  const c2Idx = (skipIndex + 2) % 3;\n  orthogonal[c1Idx] = vector[c2Idx];\n  orthogonal[c2Idx] = -vector[c1Idx];\n  return orthogonal;\n}\n\n/**\n * Creates an orthogonal axes from a given vector.\n * @param vector\n * @returns\n */\nexport function createOrthogonalAxes(vector: Vector3) {\n  const up = pickOrthogonalVector(vector);\n  const right = vec3.create();\n  vec3.cross(right, vector, up);\n  return { up, right };\n}\n","import { Vector2 } from '@kitware/vtk.js/types';\nimport { vec2 } from 'gl-matrix';\nimport bspline from 'b-spline';\n\nexport interface InterpolationOptions {\n  degree?: number;\n  interPointSpacing?: number;\n  closed?: boolean;\n  clamped?: boolean;\n  dt?: number;\n}\n\n/**\n * @param {number[]} points A flattened array of 2D coords.\n * @param options\n */\nexport function interpolateCurve(\n  points: number[],\n  options?: InterpolationOptions\n) {\n  const degree = options?.degree ?? 2;\n  const interPointSpacing = options?.interPointSpacing ?? 0.1;\n  const closed = options?.closed ?? false;\n  const clamped = options?.clamped ?? false;\n\n  const numOriginalPoints = points.length / 3;\n\n  const closedCurve: Vector2[] = [];\n  const prevPt = vec2.create();\n  let arcLength = 0;\n  for (let i = 0; i < points.length; i += 2) {\n    const pt = [points[i], points[i + 1]] as Vector2;\n    closedCurve.push(pt);\n\n    if (i > 0) {\n      arcLength += vec2.dist(prevPt, pt);\n    }\n    vec2.copy(prevPt, pt);\n  }\n\n  if (closed) {\n    closedCurve.push(...closedCurve.slice(0, degree + 1));\n  }\n\n  let knots: number[] | undefined;\n\n  if (clamped) {\n    knots = [];\n    const npts = closedCurve.length;\n    for (let i = 0; i < npts + degree + 1; i++) {\n      knots.push(i);\n    }\n  }\n\n  const remapT = !clamped && closed ? 1 - 1 / (numOriginalPoints + 1) : 1;\n  const dt = options?.dt ?? interPointSpacing / arcLength;\n  // TODO float32array?\n  const out: number[] = [];\n\n  for (let t = 0; t < 1; t += dt) {\n    const ipt = bspline(t * remapT, degree, closedCurve, knots);\n    out.push(ipt[0], ipt[1]);\n  }\n\n  return out;\n}\n","import macro from '@kitware/vtk.js/macros';\nimport {\n  getEventWorldPosition,\n  ignoreKey,\n  InteractionState,\n  Mode,\n} from './common';\nimport { interpolateCurve } from '../interpolation';\n\nexport default function freehandBehavior(publicAPI: any, model: any) {\n  const original = { ...publicAPI };\n\n  function isActiveMode() {\n    return publicAPI.getMode() === Mode.Freehand;\n  }\n\n  function resetModeInteraction() {\n    publicAPI.setInteractionState(InteractionState.Idle);\n    model._interactor.cancelAnimation(publicAPI);\n    publicAPI.invokeEndInteractionEvent();\n  }\n\n  publicAPI.resetInteractionState = () => {\n    if (isActiveMode() && !publicAPI.isInteractionIdle()) {\n      model.widgetState.clearPolyLine();\n      resetModeInteraction();\n    }\n    original.resetInteractionState();\n  };\n\n  publicAPI.handleLeftButtonPress = (callData: any) => {\n    if (original.handleLeftButtonPress?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (!isActiveMode() || !model.manipulator || ignoreKey(callData)) {\n      return macro.VOID;\n    }\n\n    // do not modify a finalized contour\n    if (model.widgetState.getFinalized()) {\n      return macro.VOID;\n    }\n\n    // This contour widget is passive, so if another widget\n    // is active, we don't do anything.\n    const activeWidget = model._widgetManager.getActiveWidget();\n    if (activeWidget && activeWidget !== publicAPI) {\n      return macro.VOID;\n    }\n\n    const worldCoords = getEventWorldPosition(model, callData);\n    if (!worldCoords) {\n      return macro.VOID;\n    }\n\n    publicAPI.setInteractionState(InteractionState.FreehandDrawing);\n    model.widgetState.clearPolyLine();\n    model.widgetState.add3dPointToPolyLine(worldCoords);\n\n    model._interactor.requestAnimation(publicAPI);\n    publicAPI.invokeStartInteractionEvent();\n    return macro.EVENT_ABORT;\n  };\n\n  publicAPI.handleMouseMove = (callData: any) => {\n    if (original.handleMouseMove?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (\n      !isActiveMode() ||\n      publicAPI.getInteractionState() !== InteractionState.FreehandDrawing ||\n      ignoreKey(callData)\n    ) {\n      return macro.VOID;\n    }\n\n    const coord = getEventWorldPosition(model, callData);\n    if (coord) {\n      model.widgetState.add3dPointToPolyLine(coord);\n      publicAPI.invokeInteractionEvent();\n    }\n\n    return macro.EVENT_ABORT;\n  };\n\n  publicAPI.handleLeftButtonRelease = (callData: any) => {\n    if (original.handleLeftButtonRelease?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (\n      !isActiveMode() ||\n      publicAPI.getInteractionState() !== InteractionState.FreehandDrawing ||\n      ignoreKey(callData)\n    ) {\n      return macro.VOID;\n    }\n\n    const coord = getEventWorldPosition(model, callData);\n    if (coord) {\n      model.widgetState.add3dPointToPolyLine(coord);\n    }\n\n    // interpolate curve\n    const newCurve = interpolateCurve(model.widgetState.getPolyLine(), {\n      degree: 2,\n      interPointSpacing: 0.01,\n      closed: true,\n      clamped: false,\n    });\n    model.widgetState.setPolyLine(newCurve);\n\n    model.widgetState.setFinalized(true);\n    resetModeInteraction();\n    return macro.EVENT_ABORT;\n  };\n}\n","import { vec2 } from 'gl-matrix';\nimport { Maybe } from '@/src/types';\nimport macro from '@kitware/vtk.js/macros';\nimport { Vector2 } from '@kitware/vtk.js/types';\nimport { transform3dTo2d } from '@/src/core/contours/referencePlane';\nimport {\n  InteractionState,\n  Mode,\n  getEventWorldPosition,\n  ignoreKey,\n} from './common';\n\nconst DeselectIgnoreModes = new Set([Mode.Nudge]);\n\nexport default function selectBehavior(publicAPI: any, model: any) {\n  const original = { ...publicAPI };\n\n  let moveOrigin: Vector2 = [0, 0];\n  let origPolyLine: Maybe<number[]> = null;\n\n  macro.event(publicAPI, model, 'SelectedEvent');\n\n  const delta = vec2.create();\n\n  function translateContour(to: Vector2) {\n    if (!origPolyLine) return;\n\n    vec2.sub(delta, to, moveOrigin);\n    const polyLine = model.widgetState.getPolyLine();\n    for (let i = 0; i < polyLine.length; i += 2) {\n      polyLine[i] = origPolyLine[i] + delta[0];\n      polyLine[i + 1] = origPolyLine[i + 1] + delta[1];\n    }\n    model.widgetState.modified();\n  }\n\n  function resetModeInteraction() {\n    publicAPI.setInteractionState(InteractionState.Idle);\n    model._interactor.cancelAnimation(publicAPI);\n    publicAPI.invokeEndInteractionEvent();\n  }\n\n  publicAPI.resetInteractionState = () => {\n    if (publicAPI.getInteractionState() === InteractionState.Moving) {\n      resetModeInteraction();\n    }\n    original.resetInteractionState();\n  };\n\n  publicAPI.handleLeftButtonPress = (callData: any) => {\n    if (original.handleLeftButtonPress?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (ignoreKey(callData)) {\n      return macro.VOID;\n    }\n\n    if (model._widgetManager.getActiveWidget() !== publicAPI) {\n      if (!DeselectIgnoreModes.has(publicAPI.getMode())) {\n        // deselect, since we clicked on something other than the widget\n        publicAPI.invokeSelectedEvent(false);\n      }\n      return macro.VOID;\n    }\n\n    publicAPI.invokeSelectedEvent(true);\n\n    const worldCoords = getEventWorldPosition(model, callData);\n    if (!worldCoords) {\n      return macro.EVENT_ABORT;\n    }\n\n    moveOrigin = transform3dTo2d(\n      worldCoords,\n      model.widgetState.getReferencePlane()\n    );\n    origPolyLine = [...model.widgetState.getPolyLine()];\n\n    // also enable the ability to move the contour\n    publicAPI.setInteractionState(InteractionState.Moving);\n    model._interactor.requestAnimation(publicAPI);\n    publicAPI.invokeStartInteractionEvent();\n\n    return macro.EVENT_ABORT;\n  };\n\n  publicAPI.handleMouseMove = (callData: any) => {\n    if (original.handleMouseMove?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (\n      !publicAPI.isSelected() ||\n      publicAPI.getInteractionState() !== InteractionState.Moving ||\n      ignoreKey(callData)\n    ) {\n      return macro.VOID;\n    }\n\n    const coord = getEventWorldPosition(model, callData);\n    if (coord) {\n      translateContour(\n        transform3dTo2d(coord, model.widgetState.getReferencePlane())\n      );\n      publicAPI.invokeInteractionEvent();\n    }\n\n    return macro.EVENT_ABORT;\n  };\n\n  publicAPI.handleLeftButtonRelease = (callData: any) => {\n    if (original.handleLeftButtonRelease?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (\n      publicAPI.getInteractionState() !== InteractionState.Moving ||\n      ignoreKey(callData)\n    ) {\n      return macro.VOID;\n    }\n\n    const coord = getEventWorldPosition(model, callData);\n    if (coord) {\n      translateContour(\n        transform3dTo2d(coord, model.widgetState.getReferencePlane())\n      );\n    }\n\n    resetModeInteraction();\n    return macro.EVENT_ABORT;\n  };\n}\n","import { Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport { vec2, vec3 } from 'gl-matrix';\nimport {\n  ReferencePlane,\n  transform2dTo3d,\n  transform3dTo2d,\n} from './referencePlane';\n\nexport interface NudgeCircle {\n  center: Vector3;\n  radius: number;\n}\n\n/**\n * Addition in the ring of integers modulo N.\n * @param a\n * @param b\n * @param n\n * @returns\n */\nfunction addModuloN(a: number, b: number, n: number) {\n  return (a + b) % n;\n}\n\n/* eslint-disable no-param-reassign */\nfunction calcMidpoint(out: vec2, v1: vec2, v2: vec2) {\n  out[0] = (v1[0] + v2[0]) / 2;\n  out[1] = (v1[1] + v2[1]) / 2;\n}\n/* eslint-enable no-param-reassign */\n\n/**\n * Nudges a contour with a circle of a given radius.\n *\n * Points that are inside the circle get nudged to the circle's border.\n *\n * @param {number[]} points 2D points in flattened array\n * @param {NudgeCircle} nudgeCircle nudging circle in 3D\n * @param refPlane reference plane\n */\nfunction nudgePoints(\n  points: number[],\n  nudgeCircle: NudgeCircle,\n  refPlane: ReferencePlane\n) {\n  const { radius, center } = nudgeCircle;\n  const nudgeRadius2 = radius ** 2;\n  const nudgeVec = vec3.create();\n  const point: Vector3 = [0, 0, 0];\n  const pt2d: Vector2 = [0, 0];\n  for (let i = 0; i < points.length; i += 2) {\n    vec2.set(pt2d, points[i], points[i + 1]);\n    transform2dTo3d(pt2d, refPlane, point);\n\n    const dist2 = vec3.sqrDist(point, center);\n    if (dist2 >= nudgeRadius2) {\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    vec3.sub(nudgeVec, point, center);\n    vec3.scale(nudgeVec, nudgeVec, Math.sqrt(nudgeRadius2 / dist2));\n    vec3.add(point, center, nudgeVec);\n\n    transform3dTo2d(point, refPlane, pt2d);\n\n    /* eslint-disable */\n    points[i] = pt2d[0];\n    points[i + 1] = pt2d[1];\n    /* eslint-enable */\n  }\n}\n\n/**\n * Adjusts contour points to stay within a desired spacing range.\n * @param points\n * @param minPointSpacing\n * @param maxPointSpacing\n * @returns\n */\nfunction adjustPoints(\n  points: number[],\n  minPointSpacing: number,\n  maxPointSpacing: number\n) {\n  if (points.length < 2) return;\n\n  const minSpacing2 = minPointSpacing ** 2;\n  const maxSpacing2 = maxPointSpacing ** 2;\n\n  const curVec = vec2.create();\n  const nextVec = vec2.create();\n  const midpoint = vec2.create();\n  const intermediate = vec2.create();\n\n  let curIdx = 0;\n  let crossed = false;\n  let stop = false;\n  do {\n    let newIdx = curIdx;\n    const nextIdx = addModuloN(curIdx, 2, points.length);\n\n    vec2.set(curVec, points[curIdx], points[curIdx + 1]);\n    vec2.set(nextVec, points[nextIdx], points[nextIdx + 1]);\n\n    const dist2 = vec2.sqrDist(curVec, nextVec);\n\n    if (dist2 < minSpacing2) {\n      // merge cur and next at the midpoint\n      // TODO what to do if every point is closer than minPointSpacing?\n      // It's possible to collapse into a singular point.\n      calcMidpoint(midpoint, curVec, nextVec);\n      points.splice(nextIdx, 2);\n      points.splice(curIdx, 2);\n      points.splice(curIdx, 0, ...midpoint);\n    } else if (dist2 > maxSpacing2) {\n      // insert new points\n      const numNewPoints = Math.ceil(Math.sqrt(dist2 / maxSpacing2));\n      const tdelta = 1 / (numNewPoints + 1);\n      const newPoints = [];\n      for (let t = tdelta; t < 1; t += tdelta) {\n        vec2.lerp(intermediate, curVec, nextVec, t);\n        newPoints.push(...intermediate);\n      }\n      // TODO nudge new points\n      points.splice(nextIdx, 0, ...newPoints);\n      // continue processing at nextVec\n      newIdx = addModuloN(curIdx, newPoints.length + 2, points.length);\n    } else {\n      newIdx = addModuloN(curIdx, 2, points.length);\n    }\n\n    // We handle the [last point, first point] segment by stopping\n    // after we've processed one more segment after crossing.\n    stop = crossed;\n    crossed = newIdx < curIdx;\n    curIdx = newIdx;\n  } while (!stop);\n}\n\n/**\n * Nudges a contour.\n * @param contour\n * @param nudgeCircle\n * @param minPointSpacing\n * @param maxPointSpacing\n */\nexport function nudgeContour(\n  contour: number[],\n  nudgeCircle: NudgeCircle,\n  referencePlane: ReferencePlane,\n  minPointSpacing = 0.0001,\n  maxPointSpacing = 0.1\n) {\n  nudgePoints(contour, nudgeCircle, referencePlane);\n  adjustPoints(contour, minPointSpacing, maxPointSpacing);\n  // TODO handle intersections\n}\n\n/**\n * Finds the closest point along the contour.\n * @param contour\n * @param point\n * @returns the index of the 2-tuple in the provided contour\n */\nexport function closestPointAlongContour(contour: number[], point: Vector2) {\n  let closestIndex = 0;\n  let bestDist2 = Infinity;\n  const vec = vec2.create();\n  for (let i = 0; i < contour.length; i += 2) {\n    vec2.set(vec, contour[i], contour[i + 1]);\n    const d2 = vec2.sqrDist(vec, point);\n    if (d2 < bestDist2) {\n      closestIndex = i;\n      bestDist2 = d2;\n    }\n  }\n\n  return closestIndex;\n}\n","import macro from '@kitware/vtk.js/macros';\nimport { Vector3 } from '@kitware/vtk.js/types';\nimport {\n  closestPointAlongContour,\n  nudgeContour,\n} from '@/src/core/contours/nudge';\nimport {\n  transform2dTo3d,\n  transform3dTo2d,\n} from '@/src/core/contours/referencePlane';\nimport { vec3 } from 'gl-matrix';\nimport {\n  InteractionState,\n  Mode,\n  getEventWorldPosition,\n  ignoreKey,\n} from './common';\nimport { ContourWidgetState } from '..';\n\n// Determines the gap between the nudge circle and the contour.\nconst RADIUS_GAP_PERCENT = 0.95;\n\ninterface Model {\n  _radius: number;\n  widgetState: ContourWidgetState;\n\n  [name: string]: any;\n}\n\nexport default function nudgeBehavior(publicAPI: any, model: Model) {\n  const original = { ...publicAPI };\n\n  model._radius = 1;\n\n  function isActiveMode() {\n    return publicAPI.getMode() === Mode.Nudge;\n  }\n\n  function doNudge(center: Vector3) {\n    const polyLine = model.widgetState.getPolyLine();\n    const refPlane = model.widgetState.getReferencePlane();\n    nudgeContour(polyLine, { center, radius: model._radius }, refPlane);\n    model.widgetState.modified();\n  }\n\n  function resetModeInteraction() {\n    const circleContextState = publicAPI.getWidgetState().getCircleContext();\n    circleContextState.setVisible(false);\n\n    publicAPI.setInteractionState(InteractionState.Idle);\n    model._interactor.cancelAnimation(publicAPI);\n    publicAPI.invokeEndInteractionEvent();\n  }\n\n  publicAPI.resetInteractionState = () => {\n    if (isActiveMode() && !publicAPI.isInteractionIdle()) {\n      resetModeInteraction();\n    }\n    original.resetInteractionState();\n  };\n\n  publicAPI.handleLeftButtonPress = (callData: any) => {\n    if (original.handleLeftButtonPress?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (\n      !isActiveMode() ||\n      !publicAPI.isSelected() ||\n      !model.manipulator ||\n      ignoreKey(callData)\n    ) {\n      return macro.VOID;\n    }\n\n    // This contour widget is passive, so if another widget\n    // is active, we don't do anything.\n    const activeWidget = model._widgetManager.getActiveWidget();\n    if (activeWidget && activeWidget !== publicAPI) {\n      return macro.VOID;\n    }\n\n    const worldCoords = getEventWorldPosition(model, callData);\n    if (!worldCoords) {\n      return macro.VOID;\n    }\n\n    // set the radius\n    const { widgetState } = model;\n    const polyLine = widgetState.getPolyLine();\n    const refPlane = widgetState.getReferencePlane();\n    const closestPtIndex = closestPointAlongContour(\n      polyLine,\n      transform3dTo2d(worldCoords, refPlane)\n    );\n\n    const distance = vec3.dist(\n      worldCoords,\n      transform2dTo3d(\n        [polyLine[closestPtIndex], polyLine[closestPtIndex + 1]],\n        refPlane\n      )\n    );\n    model._radius = distance * RADIUS_GAP_PERCENT;\n\n    // setup the nudge circle visualization\n    const normal = model.manipulator.getNormal();\n    const up = model._renderer.getActiveCamera().getViewUp();\n    const horiz = vec3.create();\n    vec3.cross(horiz, up, normal);\n\n    const circleContextState = widgetState.getCircleContext();\n    circleContextState.setDirection(normal);\n    circleContextState.setUp(up);\n    circleContextState.setRight(horiz);\n    circleContextState.setOrigin(worldCoords);\n    circleContextState.setScale3([model._radius, model._radius, 1]);\n    circleContextState.setVisible(true);\n\n    publicAPI.setInteractionState(InteractionState.Nudging);\n\n    model._interactor.requestAnimation(publicAPI);\n    publicAPI.invokeStartInteractionEvent();\n    return macro.EVENT_ABORT;\n  };\n\n  publicAPI.handleMouseMove = (callData: any) => {\n    if (original.handleMouseMove?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (\n      !isActiveMode() ||\n      !publicAPI.isSelected() ||\n      publicAPI.getInteractionState() !== InteractionState.Nudging ||\n      ignoreKey(callData)\n    ) {\n      return macro.VOID;\n    }\n\n    const coord = getEventWorldPosition(model, callData);\n    if (coord) {\n      publicAPI.getWidgetState().getCircleContext().setOrigin(coord);\n      doNudge(coord);\n      publicAPI.invokeInteractionEvent();\n    }\n\n    return macro.EVENT_ABORT;\n  };\n\n  publicAPI.handleLeftButtonRelease = (callData: any) => {\n    if (original.handleLeftButtonRelease?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (\n      !isActiveMode() ||\n      !publicAPI.isSelected() ||\n      publicAPI.getInteractionState() !== InteractionState.Nudging ||\n      ignoreKey(callData)\n    ) {\n      return macro.VOID;\n    }\n\n    const coord = getEventWorldPosition(model, callData);\n    if (coord) {\n      doNudge(coord);\n    }\n\n    resetModeInteraction();\n\n    return macro.EVENT_ABORT;\n  };\n}\n","import macro from '@kitware/vtk.js/macros';\nimport { Vector2 } from '@kitware/vtk.js/types';\nimport { transform3dTo2d } from '@/src/core/contours/referencePlane';\nimport {\n  getEventWorldPosition,\n  ignoreKey,\n  InteractionState,\n  Mode,\n} from './common';\nimport { interpolateCurve } from '../interpolation';\n\nexport default function pointPlacingBehavior(publicAPI: any, model: any) {\n  const original = { ...publicAPI };\n\n  function isActiveMode() {\n    return publicAPI.getMode() === Mode.PointPlacing;\n  }\n\n  function resetModeInteraction() {\n    model._widgetManager.releaseFocus();\n    publicAPI.setInteractionState(InteractionState.Idle);\n    model._interactor.cancelAnimation(publicAPI);\n    publicAPI.invokeEndInteractionEvent();\n  }\n\n  function updateLastPoint(coord: Vector2) {\n    const polyLine = model.widgetState.getPolyLine();\n    // assumes polyLine.length >= 2\n    const last = polyLine.length - 1;\n    /* eslint-disable prefer-destructuring */\n    polyLine[last - 1] = coord[0];\n    polyLine[last] = coord[1];\n    /* eslint-enable prefer-destructuring */\n    model.widgetState.modified();\n  }\n\n  function dropLastPoint() {\n    const polyLine = model.widgetState.getPolyLine();\n    polyLine.splice(-2, 2);\n    model.widgetState.modified();\n  }\n\n  publicAPI.resetInteractionState = () => {\n    if (isActiveMode() && !publicAPI.isInteractionIdle()) {\n      model.widgetState.clearPolyLine();\n      resetModeInteraction();\n    }\n    original.resetInteractionState();\n  };\n\n  publicAPI.handleLeftButtonPress = (callData: any) => {\n    if (original.handleLeftButtonPress?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (!isActiveMode() || !model.manipulator || ignoreKey(callData)) {\n      return macro.VOID;\n    }\n\n    // do not modify a finalized contour\n    if (model.widgetState.getFinalized()) {\n      return macro.VOID;\n    }\n\n    // This contour widget is passive, so if another widget\n    // is active, we don't do anything.\n    const activeWidget = model._widgetManager.getActiveWidget();\n    if (activeWidget && activeWidget !== publicAPI) {\n      return macro.VOID;\n    }\n\n    const worldCoords = getEventWorldPosition(model, callData);\n    if (!worldCoords) {\n      return macro.VOID;\n    }\n\n    const point2d = transform3dTo2d(\n      worldCoords,\n      model.widgetState.getReferencePlane()\n    );\n\n    // we are placing a new point!\n    if (publicAPI.getInteractionState() === InteractionState.PointPlacing) {\n      updateLastPoint(point2d);\n      model.widgetState.add2dPointToPolyLine(point2d);\n\n      publicAPI.invokeInteractionEvent();\n    } else {\n      // starting a new contour\n      model._widgetManager.grabFocus(publicAPI);\n\n      publicAPI.setInteractionState(InteractionState.PointPlacing);\n      model.widgetState.setFinalized(false);\n      model.widgetState.clearPolyLine();\n      model.widgetState.add2dPointToPolyLine(point2d);\n\n      // add a second point, since the last point is used as the cursor handle\n      model.widgetState.add2dPointToPolyLine(point2d);\n\n      model._interactor.requestAnimation(publicAPI);\n      publicAPI.invokeStartInteractionEvent();\n    }\n\n    return macro.EVENT_ABORT;\n  };\n\n  publicAPI.handleMouseMove = (callData: any) => {\n    if (original.handleMouseMove?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (\n      !isActiveMode() ||\n      publicAPI.getInteractionState() !== InteractionState.PointPlacing ||\n      ignoreKey(callData)\n    ) {\n      return macro.VOID;\n    }\n\n    const coord = getEventWorldPosition(model, callData);\n    if (coord) {\n      const point2d = transform3dTo2d(\n        coord,\n        model.widgetState.getReferencePlane()\n      );\n      updateLastPoint(point2d);\n      publicAPI.invokeInteractionEvent();\n    }\n\n    return macro.EVENT_ABORT;\n  };\n\n  publicAPI.handleRightButtonPress = (callData: any) => {\n    if (original.handleRightButtonPress?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (\n      !isActiveMode() ||\n      publicAPI.getInteractionState() !== InteractionState.PointPlacing ||\n      ignoreKey(callData)\n    ) {\n      return macro.VOID;\n    }\n\n    dropLastPoint();\n\n    if (model.widgetState.getPolyLineLength() <= 2) {\n      model.widgetState.clearPolyLine();\n    } else {\n      // interpolate curve\n      const newCurve = interpolateCurve(model.widgetState.getPolyLine(), {\n        degree: 2,\n        interPointSpacing: 0.01,\n        closed: true,\n        clamped: false,\n      });\n      model.widgetState.setPolyLine(newCurve);\n      model.widgetState.setFinalized(true);\n    }\n\n    resetModeInteraction();\n    return macro.EVENT_ABORT;\n  };\n}\n","/* eslint-disable prefer-destructuring */\n\nimport macro from '@kitware/vtk.js/macros';\nimport vtkPolyData from '@kitware/vtk.js/Common/DataModel/PolyData';\nimport vtkEdgeLocator from '@kitware/vtk.js/Common/DataModel/EdgeLocator';\n\nimport vtkCaseTable from '@kitware/vtk.js/Filters/General/ImageMarchingSquares/caseTable';\n\nconst { vtkErrorMacro } = macro;\n\n/**\n * Modified vtkImageMarchingSquares from vtk.js.\n */\n\n// ----------------------------------------------------------------------------\n// vtkImageMarchingSquares methods\n// ----------------------------------------------------------------------------\n\nfunction vtkImageMarchingSquares(publicAPI, model) {\n  // Set our className\n  model.classHierarchy.push('vtkImageMarchingSquares');\n\n  publicAPI.getContourValues = () => model.contourValues;\n  publicAPI.setContourValues = (cValues) => {\n    model.contourValues = cValues;\n    publicAPI.modified();\n  };\n\n  const ids = [];\n  const pixelScalars = [];\n  const pixelPts = [];\n  const edgeLocator = vtkEdgeLocator.newInstance();\n\n  // Retrieve scalars and pixel coordinates. i-j-k is origin of pixel.\n  publicAPI.getPixelScalars = (i, j, k, slice, dims, origin, spacing, s) => {\n    // First get the indices for the pixel\n    // i,j,k is the smallest index of the examined quad\n    ids[0] = k * slice + j * dims[0] + i; // i, j, k\n    ids[1] = ids[0] + 1; // i+1, j, k\n    ids[2] = ids[0] + dims[0]; // i, j+1, k\n    ids[3] = ids[2] + 1; // i+1, j+1, k\n\n    // Invariants based on the looping pattern:\n    // i in [-1, dims[0])\n    // j in [-1, dims[1])\n    const iInBounds = i >= 0;\n    const jInBounds = j >= 0;\n    const i1InBounds = i + 1 < dims[0];\n    const j1InBounds = j + 1 < dims[1];\n\n    // TODO configurable background color\n    pixelScalars[0] = iInBounds && jInBounds ? s[ids[0]] : 0;\n    pixelScalars[1] = i1InBounds && jInBounds ? s[ids[1]] : 0;\n    pixelScalars[2] = iInBounds && j1InBounds ? s[ids[2]] : 0;\n    pixelScalars[3] = i1InBounds && j1InBounds ? s[ids[3]] : 0;\n  };\n\n  // Retrieve pixel coordinates. i-j-k is origin of pixel.\n  publicAPI.getPixelPoints = (i, j, k, dims, origin, spacing) => {\n    // (i,i+1),(j,j+1),(k,k+1) - i varies fastest; then j; then k\n    pixelPts[0] = origin[0] + i * spacing[0]; // 0\n    pixelPts[1] = origin[1] + j * spacing[1];\n\n    pixelPts[2] = pixelPts[0] + spacing[0]; // 1\n    pixelPts[3] = pixelPts[1];\n\n    pixelPts[4] = pixelPts[0]; // 2\n    pixelPts[5] = pixelPts[1] + spacing[1];\n\n    pixelPts[6] = pixelPts[2]; // 3\n    pixelPts[7] = pixelPts[5];\n  };\n\n  publicAPI.produceLines = (\n    cVal,\n    i,\n    j,\n    k,\n    slice,\n    dims,\n    origin,\n    spacing,\n    scalars,\n    points,\n    lines\n  ) => {\n    const CASE_MASK = [1, 2, 8, 4]; // case table is actually for quad\n    const xyz = [];\n    let pId;\n\n    publicAPI.getPixelScalars(i, j, k, slice, dims, origin, spacing, scalars);\n\n    let index = 0;\n    for (let idx = 0; idx < 4; idx++) {\n      if (pixelScalars[idx] >= cVal) {\n        index |= CASE_MASK[idx]; // eslint-disable-line no-bitwise\n      }\n    }\n\n    const pixelLines = vtkCaseTable.getCase(index);\n    if (pixelLines[0] < 0) {\n      return; // don't get the pixel coordinates, nothing to do\n    }\n\n    publicAPI.getPixelPoints(i, j, k, dims, origin, spacing);\n\n    const z = origin[2] + k * spacing[2];\n    for (let idx = 0; pixelLines[idx] >= 0; idx += 2) {\n      lines.push(2);\n      for (let eid = 0; eid < 2; eid++) {\n        const edgeVerts = vtkCaseTable.getEdge(pixelLines[idx + eid]);\n        pId = undefined;\n        if (model.mergePoints) {\n          pId = edgeLocator.isInsertedEdge(\n            ids[edgeVerts[0]],\n            ids[edgeVerts[1]]\n          )?.value;\n        }\n        if (pId === undefined) {\n          // CHANGE: hard-code to 0.5, ignoring interpolation.\n          const t = 0.5;\n\n          const x0Offset = edgeVerts[0] * 2;\n          const x00 = pixelPts[x0Offset];\n          const x01 = pixelPts[x0Offset + 1];\n          const x1Offset = edgeVerts[1] * 2;\n          const x10 = pixelPts[x1Offset];\n          const x11 = pixelPts[x1Offset + 1];\n\n          xyz[0] = x00 + t * (x10 - x00);\n          xyz[1] = x01 + t * (x11 - x01);\n          pId = points.length / 3;\n          points.push(xyz[0], xyz[1], z);\n\n          if (model.mergePoints) {\n            edgeLocator.insertEdge(ids[edgeVerts[0]], ids[edgeVerts[1]], pId);\n          }\n        }\n        lines.push(pId);\n      }\n    }\n  };\n\n  publicAPI.requestData = (inData, outData) => {\n    // implement requestData\n    const input = inData[0];\n\n    if (!input) {\n      vtkErrorMacro('Invalid or missing input');\n      return;\n    }\n\n    // Retrieve output and volume data\n    const origin = input.getOrigin();\n    const spacing = input.getSpacing();\n    const dims = input.getDimensions();\n    const s = input.getPointData().getScalars().getData();\n\n    // Points - dynamic array\n    const pBuffer = [];\n\n    // Cells - dynamic array\n    const lBuffer = [];\n\n    // Ensure slice is valid\n    const slice = dims[0] * dims[1];\n    let k = Math.round(model.slice);\n    if (k >= dims[2]) {\n      k = 0;\n    }\n\n    // Loop over all contour values, and then pixels, determine case and process\n    for (let cv = 0; cv < model.contourValues.length; ++cv) {\n      // Handle the image border by adding a 1 pixel border\n      // of background color.\n      // getPixelScalars handles the out-of-bounds pixel accesses.\n      for (let j = -1; j < dims[1]; ++j) {\n        for (let i = -1; i < dims[0]; ++i) {\n          publicAPI.produceLines(\n            model.contourValues[cv],\n            i,\n            j,\n            k,\n            slice,\n            dims,\n            origin,\n            spacing,\n            s,\n            pBuffer,\n            lBuffer\n          );\n        }\n      }\n      edgeLocator.initialize();\n    }\n\n    // Update output\n    const polydata = vtkPolyData.newInstance();\n    polydata.getPoints().setData(new Float32Array(pBuffer), 3);\n    polydata.getLines().setData(new Uint32Array(lBuffer));\n    outData[0] = polydata;\n  };\n}\n\n// ----------------------------------------------------------------------------\n// Object factory\n// ----------------------------------------------------------------------------\n\nconst DEFAULT_VALUES = {\n  contourValues: [],\n  slice: 0,\n  mergePoints: false,\n};\n\n// ----------------------------------------------------------------------------\n\nexport function extend(publicAPI, model, initialValues = {}) {\n  Object.assign(model, DEFAULT_VALUES, initialValues);\n\n  // Make this a VTK object\n  macro.obj(publicAPI, model);\n\n  // Also make it an algorithm with one input and one output\n  macro.algo(publicAPI, model, 1, 1);\n\n  macro.setGet(publicAPI, model, ['slice', 'mergePoints']);\n\n  // Object specific methods\n  macro.algo(publicAPI, model, 1, 1);\n  vtkImageMarchingSquares(publicAPI, model);\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(extend, 'vtkImageMarchingSquares');\n\n// ----------------------------------------------------------------------------\n\nexport default { newInstance, extend };\n","import vtkDataArray from '@kitware/vtk.js/Common/Core/DataArray';\nimport vtkImageData from '@kitware/vtk.js/Common/DataModel/ImageData';\nimport vtkPolyData from '@kitware/vtk.js/Common/DataModel/PolyData';\nimport { Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport { mat4, vec2, vec3 } from 'gl-matrix';\nimport vtkImageMarchingSquares from '@/src/vtk/ImageMarchingSquares';\n\nexport type BinaryMask = Uint8Array;\n\ntype SliceAxis = 0 | 1 | 2;\n\nexport const FILLED = 2;\nexport const VISITED = 1;\nexport const EMPTY = 0;\n\nfunction getSliceDimensions(\n  baseDimensions: Vector3,\n  sliceAxis: SliceAxis\n): Vector2 {\n  const sliceDims = [...baseDimensions];\n  sliceDims.splice(sliceAxis, 1);\n  return sliceDims as Vector2;\n}\n\nexport function createBinaryMask(\n  baseImage: vtkImageData,\n  sliceAxis: SliceAxis\n): vtkImageData {\n  const [iDim, jDim] = getSliceDimensions(baseImage.getDimensions(), sliceAxis);\n  const pixels = new Uint8Array(iDim * jDim);\n  const dataArray = vtkDataArray.newInstance({\n    values: pixels,\n    numberOfComponents: 1,\n  });\n  const image = vtkImageData.newInstance();\n  image.setDimensions([iDim, jDim, 1]);\n  image.getPointData().setScalars(dataArray);\n  return image;\n}\n\nexport function ijToIjk(\n  ij: Vector2,\n  sliceAxis: SliceAxis,\n  slice: number\n): Vector3 {\n  const ijk = [...ij];\n  ijk.splice(sliceAxis, 0, slice);\n  return ijk as Vector3;\n}\n\nexport function ijkToIj(ijk: Vector3, sliceAxis: SliceAxis): Vector2 {\n  const ij = [...ijk];\n  ij.splice(sliceAxis, 1);\n  return ij as Vector2;\n}\n\nexport function directDistance2D(pt1: Vector2, pt2: Vector2) {\n  return vec2.dist(pt1, pt2);\n}\n\nexport function manhattanDistance2D(pt1: Vector2, pt2: Vector2) {\n  return Math.abs(pt1[0] - pt2[0]) + Math.abs(pt1[1] - pt2[1]);\n}\n\n/**\n * Creates a get/set pixel accessor for a contiguous image array.\n *\n * Coordinates must be IJK integral coordinates.\n *\n * No bounds check is done.\n * @param dims\n * @returns\n */\nfunction createImagePixelAccessor(image: vtkImageData, dims = 3) {\n  if (dims > 3) {\n    throw new Error('Cannot support dim > 3');\n  }\n\n  const pixels = image.getPointData().getScalars().getData();\n\n  const [iDim, jDim, kDim] = image.getDimensions();\n  const ijSkip = dims === 3 ? iDim * jDim : 0;\n  const iSkip = dims >= 2 ? iDim : 0;\n\n  return {\n    get: (coord: number[]) => {\n      const i = coord[0] ?? 0;\n      const j = coord[1] ?? 0;\n      const k = coord[2] ?? 0;\n      return pixels[k * ijSkip + j * iSkip + i];\n    },\n    set: (coord: number[], value: number) => {\n      const i = coord[0] ?? 0;\n      const j = coord[1] ?? 0;\n      const k = coord[2] ?? 0;\n      pixels[k * ijSkip + j * iSkip + i] = value;\n    },\n    inBounds: (coord: number[]) => {\n      const i = coord[0] ?? 0;\n      const j = coord[1] ?? 0;\n      const k = coord[2] ?? 0;\n      return i >= 0 && i < iDim && j >= 0 && j < jDim && k >= 0 && k < kDim;\n    },\n    fill: (value: number) => {\n      pixels.fill(value);\n    },\n  };\n}\n\n/**\n * Thresholds an image.\n *\n * Produced mask image will have three values:\n * - EMPTY (0): background\n * - VISITED (1): background (outside of threshold), but was visited.\n * - FILLED (2): foreground, part of threshold.\n * @param baseImage\n * @param sliceAxis 0 | 1 | 2\n * @param slice IJK slice as integer\n * @param maskImage\n * @param seedPoint IJK integral coordinates\n * @param thresholdRadius\n * @param maxDistance\n */\nexport function thresholdSlice(\n  baseImage: vtkImageData,\n  sliceAxis: SliceAxis,\n  slice: number,\n  maskImage: vtkImageData,\n  seedPoint: Vector3,\n  thresholdRadius: number,\n  maxDistance: number,\n  distanceFunction = directDistance2D\n) {\n  const basePixels = createImagePixelAccessor(baseImage, 3);\n  const maskPixels = createImagePixelAccessor(maskImage, 2);\n  const seedPointIj = ijkToIj(seedPoint, sliceAxis);\n  const seedValue = basePixels.get(seedPoint);\n  const minValue = seedValue - thresholdRadius;\n  const maxValue = seedValue + thresholdRadius;\n\n  maskPixels.fill(EMPTY);\n\n  const queue = [seedPointIj];\n  while (queue.length) {\n    const ij = queue.shift()!;\n\n    if (\n      !maskPixels.inBounds(ij) ||\n      maskPixels.get(ij) !== 0 ||\n      distanceFunction(seedPointIj, ij) > maxDistance\n    ) {\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    // visited\n    maskPixels.set(ij, VISITED);\n\n    const ijk = ijToIjk(ij, sliceAxis, slice);\n    const pixel = basePixels.get(ijk);\n\n    if (pixel < minValue || pixel > maxValue) {\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    // masked\n    maskPixels.set(ij, FILLED);\n\n    const [i, j] = ij;\n    for (let di = -1; di <= 1; di++) {\n      for (let dj = -1; dj <= 1; dj++) {\n        // 4 neighbor results in fewer spurious contours\n        if ((!di && dj) || (di && !dj)) {\n          queue.push([i + di, j + dj]);\n        }\n      }\n    }\n  }\n}\n\nexport function maskToBoundaryLines(mask: vtkImageData) {\n  const msquares = vtkImageMarchingSquares.newInstance({ mergePoints: true });\n  msquares.setContourValues([FILLED]);\n  msquares.setInputData(mask);\n  return msquares.getOutputData() as vtkPolyData;\n}\n\nconst SliceAxisTransforms: Record<0 | 1 | 2, mat4> = {\n  0: mat4.fromValues(0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1),\n  1: mat4.fromValues(1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1),\n  2: mat4.fromValues(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1),\n};\n\nexport function transformPolyDataToSlice(\n  pd: vtkPolyData,\n  slice: number,\n  ijkSliceAxis: 0 | 1 | 2,\n  indexToWorld: mat4\n) {\n  const points = pd.getPoints().getData();\n  const transform = mat4.create();\n  // points start on k=0 plane\n  mat4.fromTranslation(transform, [0, 0, slice]);\n  // rotate to correct slice axis\n  mat4.mul(transform, SliceAxisTransforms[ijkSliceAxis], transform);\n  mat4.mul(transform, indexToWorld, transform);\n\n  const pt = vec3.create();\n  for (let i = 0; i < points.length; i += 3) {\n    vec3.set(pt, points[i], points[i + 1], points[i + 2]);\n    vec3.transformMat4(pt, pt, transform);\n    [points[i], points[i + 1], points[i + 2]] = pt;\n  }\n}\n","/* eslint-disable prefer-destructuring */\n/* eslint-disable no-continue */\nimport vtkPolyData from '@kitware/vtk.js/Common/DataModel/PolyData';\nimport { vtkAlgorithm, vtkObject } from '@kitware/vtk.js/interfaces';\nimport macro from '@kitware/vtk.js/macro';\nimport { Vector2 } from '@kitware/vtk.js/types';\nimport hull from 'hull.js';\n\ninterface CellPoints {\n  cellType: number;\n  cellPointIds: number[] | null;\n}\n\nenum Dir {\n  Forward = 1,\n  Backward = -1,\n}\n\ninterface ParameterizedPoint {\n  t: number;\n  ptId: number;\n}\n\ninterface vtkContourLoopExtraction extends vtkObject, vtkAlgorithm {\n  getConvexHull(): boolean;\n  setConvexHull(ch: boolean): boolean;\n  setMergeContours(merge: boolean): boolean;\n  getMergeContours(): boolean;\n  extractContours(input: vtkPolyData, output: vtkPolyData): void;\n  computeConvexHull(input: vtkPolyData, output: vtkPolyData): void;\n  requestData(inData: [vtkPolyData], outData: [vtkPolyData]): void;\n  traverseLoop(\n    pd: vtkPolyData,\n    dir: Dir,\n    startLineId: number,\n    startPtId: number,\n    loopPoints: ParameterizedPoint[]\n  ): number;\n}\n\ninterface Model {\n  [key: string]: any;\n}\n\n/**\n * Implementation taken from vtkContourLoopExtraction.cxx in the VTK project.\n *\n * Added the mergeContours flag.\n */\nfunction vtkContourLoopExtractionCtor(\n  publicAPI: vtkContourLoopExtraction,\n  model: Model\n) {\n  model.classHierarchy.push('vtkContourLoopExtraction');\n\n  const visited = new Set<number>();\n\n  publicAPI.traverseLoop = (pd, dir, startLineId, startPtId, loopPoints) => {\n    let lineId = startLineId;\n    let lastPtId = startPtId;\n    let terminated = false;\n    let numInserted = 0;\n\n    while (!terminated) {\n      const { cellPointIds } = pd.getCellPoints(lineId) as CellPoints;\n      if (!cellPointIds) continue;\n\n      lastPtId =\n        cellPointIds[0] !== lastPtId ? cellPointIds[0] : cellPointIds[1];\n      numInserted++;\n\n      // parametric point value\n      const t = dir * numInserted;\n      loopPoints.push({ t, ptId: lastPtId });\n\n      const lineCell = pd.getPointCells(lastPtId) as unknown as number[];\n\n      if (lineCell.length !== 2 || lastPtId === startPtId) {\n        // looped\n        return lastPtId;\n      }\n\n      if (lineCell.length === 2) {\n        // continue along loop\n        lineId = lineCell[0] !== lineId ? lineCell[0] : lineCell[1];\n        visited.add(lineId);\n      } else {\n        // empty or invalid cell\n        terminated = true;\n      }\n    }\n\n    return lastPtId;\n  };\n\n  publicAPI.computeConvexHull = (input, output) => {\n    const inPoints = input.getPoints().getData();\n\n    const hullInputPoints: Array<Vector2> = [];\n    for (let i = 0; i < inPoints.length; i += 3) {\n      hullInputPoints.push([inPoints[i], inPoints[i + 1]]);\n    }\n\n    const convexHullPoints = hull(hullInputPoints, Infinity);\n\n    // @ts-ignore\n    const outPoints = new inPoints.constructor(convexHullPoints.length * 3);\n    const outLines = new Uint32Array(1 + convexHullPoints.length + 1);\n    outLines[0] = convexHullPoints.length;\n\n    for (let i = 0, outIdx = 0; i < convexHullPoints.length; i++, outIdx += 3) {\n      const pt = convexHullPoints[i] as number[];\n      outPoints[outIdx] = pt[0];\n      outPoints[outIdx + 1] = pt[1];\n      outPoints[outIdx + 2] = 0;\n      outLines[i + 1] = i;\n    }\n\n    // close loop\n    outLines[outLines.length - 1] = outLines[1];\n\n    output.getPoints().setData(outPoints);\n    output.getLines().setData(outLines);\n  };\n\n  publicAPI.extractContours = (input, output) => {\n    const loops: Array<ParameterizedPoint[]> = [];\n    visited.clear();\n\n    const inLines = input.getLines();\n    output.getPoints().setData(Float32Array.from(input.getPoints().getData()));\n\n    // TODO skip if cached input mtime hasn't changed.\n    // iterate over input lines\n    for (let li = 0; li < inLines.getNumberOfCells(); li++) {\n      if (visited.has(li)) {\n        continue;\n      }\n\n      const { cellPointIds } = input.getCellPoints(li) as CellPoints;\n      if (!cellPointIds) {\n        continue;\n      }\n\n      visited.add(li);\n      const startPtId = cellPointIds[0];\n\n      const loopPoints = [];\n      loopPoints.push({ t: 0, ptId: startPtId });\n\n      const endPtId = publicAPI.traverseLoop(\n        input,\n        Dir.Forward,\n        li,\n        startPtId,\n        loopPoints\n      );\n\n      if (startPtId !== endPtId) {\n        // didn't find a loop. Go other direction to see where we end up\n        publicAPI.traverseLoop(input, Dir.Backward, li, startPtId, loopPoints);\n        loopPoints.sort((a, b) => (a.t < b.t ? -1 : 1));\n        // make closed contour\n        if (\n          loopPoints.length &&\n          loopPoints[0].ptId !== loopPoints.at(-1)?.ptId\n        ) {\n          loopPoints.push({ ...loopPoints.at(-1)! });\n        }\n      }\n\n      if (loopPoints.length) {\n        loops.push(loopPoints);\n      }\n    }\n\n    // clear output lines\n    const outLines = output.getLines();\n    outLines.resize(0);\n\n    if (publicAPI.getMergeContours() && loops.length) {\n      let largestIndex = 0;\n      let longestLoop = 0;\n      loops.forEach((loop, index) => {\n        if (loop.length > longestLoop) {\n          largestIndex = index;\n          longestLoop = loop.length;\n        }\n      });\n      outLines.insertNextCell(loops[largestIndex].map((pt) => pt.ptId));\n    } else {\n      loops.forEach((loop) => {\n        outLines.insertNextCell(loop.map((pt) => pt.ptId));\n      });\n    }\n  };\n\n  publicAPI.requestData = (inData, outData) => {\n    const [input] = inData;\n\n    if (!outData[0]) {\n      outData[0] = vtkPolyData.newInstance();\n    }\n    const [output] = outData;\n\n    if (publicAPI.getConvexHull()) {\n      publicAPI.computeConvexHull(input, output);\n    } else {\n      publicAPI.extractContours(input, output);\n    }\n\n    output.modified();\n  };\n}\n\n// ----------------------------------------------------------------------------\n\nconst DEFAULT_VALUES = {\n  mergeContours: false,\n  convexHull: false,\n};\n\n// ----------------------------------------------------------------------------\n\nexport function extend(publicAPI: object, model: object, initialValues = {}) {\n  Object.assign(model, DEFAULT_VALUES, initialValues);\n\n  macro.obj(publicAPI, model);\n  macro.algo(publicAPI, model, 1, 1);\n  macro.setGet(publicAPI, model, ['mergeContours', 'convexHull']);\n\n  vtkContourLoopExtractionCtor(publicAPI as vtkContourLoopExtraction, model);\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(\n  extend,\n  'vtkContourLoopExtraction'\n);\n\n// ----------------------------------------------------------------------------\n\nconst vtkContourLoopExtraction: {\n  newInstance: typeof newInstance;\n  extend: typeof extend;\n} = { newInstance, extend };\n\nexport default vtkContourLoopExtraction;\n","import {\n  ReferencePlane,\n  createReferencePlane,\n  transform2dTo3d,\n} from '@/src/core/contours/referencePlane';\nimport vtkPolyData from '@kitware/vtk.js/Common/DataModel/PolyData';\nimport { vtkAlgorithm, vtkObject } from '@kitware/vtk.js/interfaces';\nimport macro from '@kitware/vtk.js/macro';\nimport { TypedArray, Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport { vec2 } from 'gl-matrix';\n\ninterface vtkTransformPolyDataToPlane extends vtkObject, vtkAlgorithm {\n  setRefPlane(plane: ReferencePlane): boolean;\n  getRefPlane(): ReferencePlane;\n  requestData(inData: [vtkPolyData], outData: [vtkPolyData]): void;\n}\n\ninterface Model {\n  [key: string]: any;\n}\n\ntype TypedArrayConstructor =\n  | Int8ArrayConstructor\n  | Uint8ArrayConstructor\n  | Uint8ClampedArrayConstructor\n  | Int16ArrayConstructor\n  | Uint16ArrayConstructor\n  | Int32ArrayConstructor\n  | Uint32ArrayConstructor\n  | Float32ArrayConstructor\n  | Float64ArrayConstructor;\n\nfunction cloneArray(arr: number[] | TypedArray) {\n  if (Array.isArray(arr)) {\n    return [...arr];\n  }\n  return (arr.constructor as TypedArrayConstructor).from(arr);\n}\n\n/**\n * Input polydata is expected to have points on the (x,y,0) plane.\n */\nfunction vtkTransformPolyDataToPlaneCtor(\n  publicAPI: vtkTransformPolyDataToPlane,\n  model: Model\n) {\n  model.classHierarchy.push('vtkTransformPolyDataToPlane');\n\n  publicAPI.requestData = (inData, outData) => {\n    const refPlane = publicAPI.getRefPlane() ?? createReferencePlane();\n\n    const [inPd] = inData;\n\n    if (!outData[0]) {\n      outData[0] = vtkPolyData.newInstance();\n    }\n    const [output] = outData;\n\n    const outPoints = Float32Array.from(inPd.getPoints().getData());\n    output.getPoints().setData(outPoints);\n\n    const pt2d: Vector2 = [0, 0];\n    const pt3d: Vector3 = [0, 0, 0];\n    for (let i = 0; i < outPoints.length; i += 3) {\n      vec2.set(pt2d, outPoints[i], outPoints[i + 1]);\n      transform2dTo3d(pt2d, refPlane, pt3d);\n      /* eslint-disable prefer-destructuring */\n      outPoints[i] = pt3d[0];\n      outPoints[i + 1] = pt3d[1];\n      outPoints[i + 2] = pt3d[2];\n      /* eslint-enable prefer-destructuring */\n    }\n\n    const inLines = inPd.getLines().getData();\n    output.getLines().setData(cloneArray(inLines));\n\n    output.modified();\n  };\n}\n\n// ----------------------------------------------------------------------------\n\nconst DEFAULT_VALUES = {\n  refPlane: null,\n};\n\n// ----------------------------------------------------------------------------\n\nexport function extend(publicAPI: object, model: object, initialValues = {}) {\n  Object.assign(model, DEFAULT_VALUES, initialValues);\n\n  macro.obj(publicAPI, model);\n  macro.algo(publicAPI, model, 1, 1);\n  macro.setGet(publicAPI, model, ['refPlane']);\n\n  vtkTransformPolyDataToPlaneCtor(\n    publicAPI as vtkTransformPolyDataToPlane,\n    model\n  );\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(\n  extend,\n  'vtkTransformPolyDataToPlane'\n);\n\n// ----------------------------------------------------------------------------\n\nconst vtkTransformPolyDataToPlane: {\n  newInstance: typeof newInstance;\n  extend: typeof extend;\n} = { newInstance, extend };\n\nexport default vtkTransformPolyDataToPlane;\n","import { vec3 } from 'gl-matrix';\nimport macro from '@kitware/vtk.js/macros';\nimport vtkImageData from '@kitware/vtk.js/Common/DataModel/ImageData';\nimport { roundVector } from '@kitware/vtk.js/Common/Core/Math';\nimport { Maybe } from '@/src/types';\nimport { Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport {\n  createBinaryMask,\n  ijkToIj,\n  maskToBoundaryLines,\n  thresholdSlice,\n} from '@/src/core/contours/threshold';\nimport vtkActor from '@kitware/vtk.js/Rendering/Core/Actor';\nimport vtkMapper from '@kitware/vtk.js/Rendering/Core/Mapper';\nimport vtkPolyData from '@kitware/vtk.js/Common/DataModel/PolyData';\nimport vtkProperty from '@kitware/vtk.js/Rendering/Core/Property';\nimport vtkContourLoopExtraction from '@/src/vtk/ContourLoopExtraction';\nimport {\n  getEventWorldPosition,\n  ignoreKey,\n  InteractionState,\n  Mode,\n} from './common';\nimport { ContourWidgetState } from '..';\nimport vtkTransformPolyDataToPlane from '../../TransformPolyDataToPlane';\n\nconst MERGE_CONTOURS_KEY = 'm';\nconst CONVEX_HULL_CONTOURS_KEY = 'c';\nconst THRESHOLD_LINE_WIDTH = 2;\n\ninterface Model {\n  imageData: Maybe<vtkImageData>;\n  sliceAxis: 0 | 1 | 2;\n  slice: number;\n  maskBoundaryLines: vtkPolyData;\n  // point ids refer to points from maskBoundaryLines\n  loops: vtkPolyData;\n  contourLoopExtraction: vtkContourLoopExtraction;\n  transformPolyData: vtkTransformPolyDataToPlane;\n  mergeContours: boolean;\n  doConvexHull: boolean;\n  contour: {\n    actor: vtkActor;\n    mapper: vtkMapper;\n    property: vtkProperty;\n  };\n  widgetState: ContourWidgetState;\n\n  [name: string]: any;\n}\n\nfunction createActorPipeline() {\n  const actor = vtkActor.newInstance();\n  const mapper = vtkMapper.newInstance();\n  const property = actor.getProperty();\n  actor.setMapper(mapper);\n  return { actor, mapper, property };\n}\n\nexport default function thresholdBehavior(publicAPI: any, model: Model) {\n  const original = { ...publicAPI };\n\n  model.imageData = null;\n  model.sliceAxis = 0;\n  model.slice = 0;\n  model.loops = vtkPolyData.newInstance();\n  model.maskBoundaryLines = vtkPolyData.newInstance();\n  model.mergeContours = false;\n  model.doConvexHull = false;\n\n  model.contour = createActorPipeline();\n  model.contour.property.setLineWidth(THRESHOLD_LINE_WIDTH);\n\n  model.contourLoopExtraction = vtkContourLoopExtraction.newInstance();\n  model.transformPolyData = vtkTransformPolyDataToPlane.newInstance();\n\n  /**\n   * contourExtraction produces 2D loops.\n   *\n   * transformPolyData produces 3D loops from contourExtraction.\n   */\n\n  model.transformPolyData.setInputConnection(\n    model.contourLoopExtraction.getOutputPort()\n  );\n\n  function resetVisualizingContour() {\n    model.contour.mapper.setInputData(vtkPolyData.newInstance());\n  }\n\n  function addVisualizingContour() {\n    model._renderer?.addActor(model.contour.actor);\n  }\n\n  function removeVisualizingContour() {\n    model._renderer?.removeActor(model.contour.actor);\n  }\n\n  function commitCurrentContours() {\n    const store = model.widgetState.getStore();\n\n    // get current contour info\n    const id = model.widgetState.getId();\n    const drawingContour = store.toolByID[id];\n\n    const loops2d = model.contourLoopExtraction.getOutputData();\n    const loopCells = loops2d.getLines();\n    const loopPoints = loops2d.getPoints();\n    const maxCellLoc = loopCells.getData().length;\n\n    const coord = [0, 0, 0];\n    for (let loc = 0; loc < maxCellLoc; ) {\n      const loop = loopCells.getCell(loc) as unknown as number[];\n      loc += loop.length + 1;\n\n      const polyLine: number[] = [];\n      let { length } = loop;\n      // break closed contours\n      if (loop[0] === loop.at(-1)) {\n        length--;\n      }\n\n      for (let j = 0; j < length; j++) {\n        loopPoints.getPoint(loop[j], coord);\n        polyLine.push(coord[0], coord[1]);\n      }\n\n      store.addTool({\n        ...drawingContour,\n        polyLine,\n      });\n    }\n  }\n\n  // set initial empty contour data\n  resetVisualizingContour();\n\n  // cache these in the event setThresholdingParameters is called\n  // while thresholding.\n  let curImageData: Maybe<vtkImageData> = null;\n  let maskImage: Maybe<vtkImageData> = null;\n  let curSliceAxis: 0 | 1 | 2 = 0;\n  let curSlice: number = 0;\n  let startPointWorld: Vector3 = [0, 0, 0];\n  let startPointIjk: Vector3 = [0, 0, 0];\n  let startPointIj: Vector2 = [0, 0];\n\n  function renderCurrentContours() {\n    if (!curImageData) {\n      return;\n    }\n\n    model.transformPolyData.setRefPlane(model.widgetState.getReferencePlane());\n    const pd = model.transformPolyData.getOutputData();\n    model.contour.mapper.setInputData(pd);\n    model.contour.mapper.modified();\n  }\n\n  function isActiveMode() {\n    return publicAPI.getMode() === Mode.Threshold;\n  }\n\n  function resetModeInteraction() {\n    removeVisualizingContour();\n    resetVisualizingContour();\n\n    const circleContextState = publicAPI.getWidgetState().getCircleContext();\n    circleContextState.setVisible(false);\n\n    // Do not set this widget to be finalized, as we commit all contours separately.\n    // Reason: thresholding can generate more than one contour.\n\n    model._widgetManager.releaseFocus();\n    publicAPI.setInteractionState(InteractionState.Idle);\n    model._interactor.cancelAnimation(publicAPI);\n    publicAPI.invokeEndInteractionEvent();\n  }\n\n  publicAPI.resetInteractionState = () => {\n    if (isActiveMode() && !publicAPI.isInteractionIdle()) {\n      resetModeInteraction();\n    }\n\n    original.resetInteractionState();\n  };\n\n  publicAPI.setThresholdingImageSlice = (\n    imageData: vtkImageData,\n    sliceAxis: 0 | 1 | 2,\n    slice: number\n  ) => {\n    model.imageData = imageData;\n    model.sliceAxis = sliceAxis;\n    model.slice = Math.round(slice);\n  };\n\n  publicAPI.handleKeyPress = (callData: any) => {\n    if (original.handleKeyPress?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (\n      !isActiveMode() ||\n      !model.manipulator ||\n      ignoreKey(callData) ||\n      model.widgetState.getFinalized() ||\n      publicAPI.getInteractionState() !== InteractionState.Thresholding\n    ) {\n      return macro.VOID;\n    }\n\n    let needsRender = false;\n\n    if (callData.key === MERGE_CONTOURS_KEY) {\n      model.mergeContours = !model.mergeContours;\n      model.contourLoopExtraction.setMergeContours(model.mergeContours);\n      needsRender = true;\n    } else if (callData.key === CONVEX_HULL_CONTOURS_KEY) {\n      model.doConvexHull = !model.doConvexHull;\n      model.contourLoopExtraction.setConvexHull(model.doConvexHull);\n      needsRender = true;\n    }\n\n    if (needsRender) {\n      renderCurrentContours();\n      publicAPI.invokeInteractionEvent();\n      return macro.EVENT_ABORT;\n    }\n\n    return macro.VOID;\n  };\n\n  publicAPI.handleLeftButtonPress = (callData: any) => {\n    if (original.handleLeftButtonPress?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (!isActiveMode() || !model.manipulator || ignoreKey(callData)) {\n      return macro.VOID;\n    }\n\n    if (!model.imageData || model.sliceAxis == null || model.slice == null) {\n      return macro.VOID;\n    }\n\n    curImageData = model.imageData;\n    curSliceAxis = model.sliceAxis;\n    curSlice = model.slice;\n    maskImage = createBinaryMask(curImageData!, curSliceAxis);\n\n    // do not modify a finalized contour\n    if (model.widgetState.getFinalized()) {\n      return macro.VOID;\n    }\n\n    // This contour widget is passive, so if another widget\n    // is active, we don't do anything.\n    const activeWidget = model._widgetManager.getActiveWidget();\n    if (activeWidget && activeWidget !== publicAPI) {\n      return macro.VOID;\n    }\n\n    const worldCoords = getEventWorldPosition(model, callData);\n    if (!worldCoords) {\n      return macro.VOID;\n    }\n\n    addVisualizingContour();\n\n    // reset mergeContours\n    model.mergeContours = false;\n\n    const indexCoords = model.imageData.worldToIndex(worldCoords) as Vector3;\n    startPointWorld = worldCoords;\n    startPointIjk = roundVector(indexCoords);\n    startPointIj = ijkToIj(startPointIjk, curSliceAxis);\n\n    model._widgetManager.grabFocus(publicAPI);\n    publicAPI.setInteractionState(InteractionState.Thresholding);\n    model.widgetState.setFinalized(false);\n    model.widgetState.clearPolyLine();\n\n    model._interactor.requestAnimation(publicAPI);\n    publicAPI.invokeStartInteractionEvent();\n\n    return macro.EVENT_ABORT;\n  };\n\n  publicAPI.handleMouseMove = (callData: any) => {\n    if (original.handleMouseMove?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (\n      !isActiveMode() ||\n      publicAPI.getInteractionState() !== InteractionState.Thresholding ||\n      ignoreKey(callData)\n    ) {\n      return macro.VOID;\n    }\n\n    if (!curImageData) {\n      return macro.VOID;\n    }\n\n    const coord = roundVector(\n      curImageData.worldToIndex(\n        getEventWorldPosition(model, callData)\n      ) as Vector3\n    );\n    if (coord && curImageData && maskImage) {\n      const ijCoord = ijkToIj(coord, curSliceAxis);\n      const maxDistance = Math.abs(ijCoord[0] - startPointIj[0]);\n      const threshRadius = Math.abs(ijCoord[1] - startPointIj[1]);\n\n      const ijkDims = curImageData.getDimensions();\n      const ijDims = ijkToIj(ijkDims, curSliceAxis);\n      const diag = Math.sqrt(ijDims[0] ** 2 + ijkDims[1] ** 2);\n      const range = curImageData.getPointData().getScalars().getRange();\n      const rangeWidth = range[1] - range[0];\n      const adjustedThreshold =\n        (Math.min(threshRadius, diag) / diag) * rangeWidth;\n\n      thresholdSlice(\n        curImageData,\n        curSliceAxis,\n        curSlice,\n        maskImage,\n        startPointIjk,\n        adjustedThreshold,\n        maxDistance\n      );\n\n      model.maskBoundaryLines = maskToBoundaryLines(maskImage);\n\n      // required for contour loop extraction\n      model.maskBoundaryLines.buildLinks();\n\n      // loops are in 2D space\n      model.contourLoopExtraction.setInputData(model.maskBoundaryLines);\n\n      renderCurrentContours();\n\n      // draw circle context\n      const normal = model.manipulator.getNormal();\n      const up = model._renderer.getActiveCamera().getViewUp();\n      const horiz = vec3.create();\n      vec3.cross(horiz, up, normal);\n\n      const circleContextState = model.widgetState.getCircleContext();\n      circleContextState.setDirection(normal);\n      circleContextState.setUp(up);\n      circleContextState.setRight(horiz);\n      circleContextState.setOrigin(startPointWorld);\n      circleContextState.setScale3([maxDistance, threshRadius, 1]);\n      circleContextState.setVisible(true);\n\n      publicAPI.invokeInteractionEvent();\n    }\n\n    return macro.EVENT_ABORT;\n  };\n\n  publicAPI.handleLeftButtonRelease = (callData: any) => {\n    if (original.handleLeftButtonRelease?.(callData) === macro.EVENT_ABORT) {\n      return macro.EVENT_ABORT;\n    }\n\n    if (\n      !isActiveMode() ||\n      publicAPI.getInteractionState() !== InteractionState.Thresholding ||\n      ignoreKey(callData)\n    ) {\n      return macro.VOID;\n    }\n\n    commitCurrentContours();\n    resetModeInteraction();\n\n    return macro.EVENT_ABORT;\n  };\n}\n","import macro from '@kitware/vtk.js/macros';\nimport freehandBehavior from './behavior/freehand';\nimport { InteractionState, ignoreKey } from './behavior/common';\nimport selectBehavior from './behavior/select';\nimport nudgeBehavior from './behavior/nudge';\nimport pointPlacingBehavior from './behavior/pointPlacing';\nimport thresholdBehavior from './behavior/threshold';\n\nexport default function widgetBehavior(publicAPI: any, model: any) {\n  model.classHierarchy.push('vtkContourWidgetProp');\n\n  model.interactionState = InteractionState.Idle;\n  model.mode = null;\n\n  macro.event(publicAPI, model, 'RightClickEvent');\n\n  // support setting per-view widget manipulators\n  macro.setGet(publicAPI, model, ['manipulator']);\n  macro.setGet(publicAPI, model, ['mode']);\n  macro.setGet(publicAPI, model, ['interactionState']);\n\n  publicAPI.setDisplayCallback = (callback: () => {}) =>\n    model.representations[0].setDisplayCallback(callback);\n\n  publicAPI.isInteractionIdle = () => {\n    return publicAPI.getInteractionState() === InteractionState.Idle;\n  };\n\n  publicAPI.resetInteractionState = () => {\n    publicAPI.setInteractionState(InteractionState.Idle);\n  };\n\n  publicAPI.isSelected = () => {\n    return model.widgetState.getSelected();\n  };\n\n  publicAPI.handleRightButtonPress = (eventData: any) => {\n    if (\n      ignoreKey(eventData) ||\n      model._widgetManager.getActiveWidget() !== publicAPI\n    ) {\n      return macro.VOID;\n    }\n    publicAPI.invokeRightClickEvent(eventData);\n    return macro.EVENT_ABORT;\n  };\n\n  // select should be first so that contour selection works\n  selectBehavior(publicAPI, model);\n  freehandBehavior(publicAPI, model);\n  pointPlacingBehavior(publicAPI, model);\n  nudgeBehavior(publicAPI, model);\n  thresholdBehavior(publicAPI, model);\n}\n","/**\n * Converts an RGBA tuple to a hex string with alpha.\n *\n * Adds the prefix '#'.\n *\n * @param rgba a 4-tuple with components ranging from 0-255.\n */\nexport function rgbaToHexa(rgba: number[]) {\n  const hexa = rgba.map((comp) => `0${comp.toString(16)}`.slice(-2));\n  return `#${hexa.join('')}`;\n}\n\n/**\n * Parses a hex color with optional alpha channel.\n *\n * Returns an RGBA array with components scaled to [0,255].\n *\n * @param hexa a hexa color in the format \"[#]RRGGBB[AA]\"\n */\nexport function hexaToRGBA(hexa: string) {\n  const values = hexa.startsWith('#') ? hexa.substring(1) : hexa;\n  const rgba = [0, 0, 0, 255];\n  const length = Math.min(4, values.length / 2);\n  for (let i = 0; i < length; i++) {\n    rgba[i] = Number.parseInt(values.substring(2 * i, 2 * i + 2), 16);\n  }\n  return rgba;\n}\n","import { toRaw } from 'vue';\nimport macro from '@kitware/vtk.js/macros';\nimport vtkWidgetState from '@kitware/vtk.js/Widgets/Core/WidgetState';\nimport bounds from '@kitware/vtk.js/Widgets/Core/StateBuilder/boundsMixin';\nimport scale3 from '@kitware/vtk.js/Widgets/Core/StateBuilder/scale3Mixin';\nimport visible from '@kitware/vtk.js/Widgets/Core/StateBuilder/visibleMixin';\nimport origin from '@kitware/vtk.js/Widgets/Core/StateBuilder/originMixin';\nimport orientation from '@kitware/vtk.js/Widgets/Core/StateBuilder/orientationMixin';\nimport { vec2 } from 'gl-matrix';\nimport { transform3dTo2d } from '@/src/core/contours/referencePlane';\nimport { hexaToRGBA } from '@/src/utils/color';\n\nfunction createCircleContextState(publicAPI, model, initialValues) {\n  vtkWidgetState.extend(publicAPI, model, initialValues);\n  scale3.extend(publicAPI, model, initialValues);\n  visible.extend(publicAPI, model, initialValues);\n  orientation.extend(publicAPI, model, initialValues);\n  origin.extend(publicAPI, model, initialValues);\n}\n\nconst newCircleContextStateInstance = macro.newInstance(\n  createCircleContextState,\n  'vtkCircleContextContourWidgetState'\n);\n\nfunction vtkContourWidgetState(publicAPI, model) {\n  model.classHierarchy.push('vtkContourWidgetState');\n\n  model._circleContextState = newCircleContextStateInstance();\n  publicAPI.bindState(model._circleContextState, ['circleContext']);\n\n  publicAPI.getCircleContext = () => model._circleContextState;\n\n  function getContour() {\n    return model._store.toolByID[model.id];\n  }\n\n  // Avoid proxy access/tracking on polyline reference\n  publicAPI.getPolyLine = () => toRaw(getContour()?.polyLine);\n  publicAPI.getReferencePlane = () => getContour()?.referencePlane;\n\n  publicAPI.getPolyLineLength = () => {\n    const pl = getContour()?.polyLine;\n    return pl ? pl.length / 2 : 0;\n  };\n\n  const point2d = vec2.create();\n\n  /**\n   * @param {Vector3} coord\n   */\n  publicAPI.add3dPointToPolyLine = (coord) => {\n    const pl = publicAPI.getPolyLine();\n    const refPlane = publicAPI.getReferencePlane();\n    if (!pl || !refPlane) return;\n\n    transform3dTo2d(coord, refPlane, point2d);\n    publicAPI.add2dPointToPolyLine(point2d);\n  };\n\n  /**\n   * @param {Vector2} coord\n   */\n  publicAPI.add2dPointToPolyLine = (coord) => {\n    const pl = publicAPI.getPolyLine();\n    if (!pl) return;\n\n    pl.push(...coord);\n    publicAPI.modified();\n  };\n\n  publicAPI.clearPolyLine = () => {\n    const pl = publicAPI.getPolyLine();\n    if (!pl) return;\n\n    pl.length = 0;\n    publicAPI.modified();\n  };\n\n  /**\n   * Takes a polyline comprised of 2D points in the contour's frame of reference.\n   * @param polyLine\n   */\n  publicAPI.setPolyLine = (polyLine) => {\n    const contour = getContour();\n    if (!contour) return;\n\n    contour.polyLine = polyLine;\n    publicAPI.modified();\n  };\n\n  publicAPI.getColor = () => {\n    const label = getContour()?.label;\n    if (label) {\n      // color components needs to be in [0,1]\n      return hexaToRGBA(model._store.labels[label].color).map((c) => c / 255);\n    }\n    return null;\n  };\n}\n\nconst defaultValues = (initialValues) => ({\n  finalized: false,\n  selected: false,\n  ...initialValues,\n});\n\nfunction createContourState(publicAPI, model, initialValues) {\n  Object.assign(model, defaultValues(initialValues));\n  vtkWidgetState.extend(publicAPI, model, initialValues);\n  bounds.extend(publicAPI, model);\n\n  macro.get(publicAPI, model, ['id']);\n  macro.setGet(publicAPI, model, ['finalized', 'selected']);\n  macro.moveToProtected(publicAPI, model, ['store']);\n  macro.get(publicAPI, model, ['_store']);\n\n  if (!model.id) {\n    throw new Error('No ID provided!');\n  }\n\n  if (!model._store) {\n    throw new Error('No store provided!');\n  }\n\n  vtkContourWidgetState(publicAPI, model);\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(\n  createContourState,\n  'vtkContourWidgetState'\n);\n\n// ----------------------------------------------------------------------------\n\nexport default function generateState(initialValues) {\n  return newInstance(initialValues);\n}\n","import macro from '@kitware/vtk.js/macros';\nimport vtkAbstractWidgetFactory from '@kitware/vtk.js/Widgets/Core/AbstractWidgetFactory';\nimport vtkPlanePointManipulator from '@kitware/vtk.js/Widgets/Manipulators/PlaneManipulator';\nimport vtkCircleContextRepresentation from '@kitware/vtk.js/Widgets/Representations/CircleContextRepresentation';\nimport { ViewTypes } from '@kitware/vtk.js/Widgets/Core/WidgetManager/Constants';\n\nimport vtkContourRepresentation from './representation';\nimport widgetBehavior from './behavior';\nimport generateState from './state';\n\n// ----------------------------------------------------------------------------\n// Factory\n// ----------------------------------------------------------------------------\n\nfunction vtkContourWidget(publicAPI, model) {\n  model.classHierarchy.push('vtkContourWidget');\n\n  // --- Widget Requirement ---------------------------------------------------\n\n  publicAPI.getRepresentationsForViewType = (viewType) => {\n    switch (viewType) {\n      case ViewTypes.DEFAULT:\n      case ViewTypes.GEOMETRY:\n      case ViewTypes.SLICE:\n      case ViewTypes.VOLUME:\n      default:\n        return [\n          {\n            builder: vtkContourRepresentation,\n          },\n          {\n            builder: vtkCircleContextRepresentation,\n            labels: ['circleContext'],\n          },\n        ];\n    }\n  };\n\n  // --------------------------------------------------------------------------\n  // initialization\n  // --------------------------------------------------------------------------\n\n  // Default manipulator\n  publicAPI.setManipulator(\n    model.manipulator || vtkPlanePointManipulator.newInstance()\n  );\n}\n\n// ----------------------------------------------------------------------------\n\nconst defaultValues = (initialValues) => ({\n  manipulator: null,\n  behavior: widgetBehavior,\n  widgetState: generateState(initialValues),\n  ...initialValues,\n});\n\n// ----------------------------------------------------------------------------\n\nexport function extend(publicAPI, model, initialValues = {}) {\n  Object.assign(model, defaultValues(initialValues));\n\n  vtkAbstractWidgetFactory.extend(publicAPI, model, initialValues);\n  macro.setGet(publicAPI, model, ['manipulator']);\n  macro.event(publicAPI, model, 'finalized');\n\n  vtkContourWidget(publicAPI, model);\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(extend, 'vtkContourWidget');\n\n// ----------------------------------------------------------------------------\n\nexport default { newInstance, extend };\n","<script lang=\"ts\">\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useVTKCallback } from '@/src/composables/useVTKCallback';\nimport useContourStore, { ContourToolMode } from '@/src/store/tools/contours';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport { updatePlaneManipulatorFor2DView } from '@/src/utils/manipulators';\nimport { getCSSCoordinatesFromEvent } from '@/src/utils/vtk-helpers';\nimport vtkContourWidget, {\n  vtkContourViewWidget,\n} from '@/src/vtk/ContourWidget';\nimport { Mode } from '@/src/vtk/ContourWidget/behavior/common';\nimport vtkLPSView2DProxy from '@/src/vtk/LPSView2DProxy';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport vtkPlaneManipulator from '@kitware/vtk.js/Widgets/Manipulators/PlaneManipulator';\nimport type { vtkSubscription } from '@kitware/vtk.js/interfaces';\nimport {\n  PropType,\n  defineComponent,\n  toRefs,\n  computed,\n  ref,\n  onMounted,\n  onUnmounted,\n  watch,\n  watchEffect,\n  onBeforeUnmount,\n} from 'vue';\nimport { getLPSAxisFromDir } from '@/src/utils/lps';\nimport { ContourID } from '@/src/types/contour';\n\nconst ModeMap: Record<ContourToolMode, Mode> = {\n  [ContourToolMode.Select]: Mode.Select,\n  [ContourToolMode.FreehandDraw]: Mode.Freehand,\n  [ContourToolMode.CircleNudge]: Mode.Nudge,\n  [ContourToolMode.PointPlacing]: Mode.PointPlacing,\n  [ContourToolMode.Threshold]: Mode.Threshold,\n};\n\nexport default defineComponent({\n  name: 'ContourWidget2D',\n  emits: ['finalize', 'select', 'contextmenu'],\n  props: {\n    contourId: {\n      type: String as unknown as PropType<ContourID>,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n    viewId: {\n      type: String,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    currentSlice: {\n      type: Number,\n      required: true,\n    },\n    drawing: {\n      type: Boolean,\n      default: false,\n    },\n    selected: {\n      type: Boolean,\n      default: false,\n    },\n    mode: {\n      type: String as PropType<ContourToolMode>,\n      required: true,\n    },\n  },\n  setup(props, { emit }) {\n    const {\n      viewId,\n      contourId,\n      widgetManager,\n      viewDirection,\n      currentSlice,\n      drawing,\n      selected: isSelected,\n      mode,\n    } = toRefs(props);\n\n    const store = useContourStore();\n    const contour = computed(() => store.toolByID[contourId.value]);\n    const { currentImageData, currentImageID, currentImageMetadata } =\n      useCurrentImage();\n\n    const viewProxy = computed<vtkLPSView2DProxy | null>(() => {\n      return store.$proxies.getView(viewId.value);\n    });\n\n    const widgetFactory = vtkContourWidget.newInstance({\n      id: contourId.value,\n      store,\n      finalized: !drawing.value,\n    });\n    const widget = ref<vtkContourViewWidget | null>(null);\n    const widgetState = computed(() => widget.value?.getWidgetState());\n\n    onMounted(() => {\n      widget.value = widgetManager.value.addWidget(\n        widgetFactory\n      ) as vtkContourViewWidget;\n    });\n\n    onUnmounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      widgetManager.value.removeWidget(widget.value);\n      widget.value.delete();\n      widgetFactory.delete();\n    });\n\n    // --- mode --- //\n\n    watchEffect(() => {\n      const widgetMode = ModeMap[mode.value];\n      widget.value?.setMode(widgetMode);\n    });\n\n    // --- reset cases --- //\n\n    watch([currentSlice, currentImageID, widget], () => {\n      widget.value?.resetInteractionState();\n    });\n\n    onBeforeUnmount(() => {\n      // ensure we reset any existing interaction state prior to unmounting\n      widget.value?.resetInteractionState();\n    });\n\n    // --- event handling --- //\n\n    const onEndInteractionEvent = useVTKCallback(\n      computed(() => widget.value?.onEndInteractionEvent)\n    );\n\n    onEndInteractionEvent(() => {\n      if (widget.value?.getWidgetState().getFinalized()) {\n        emit('finalize');\n      }\n    });\n\n    // --- selection --- //\n\n    const onSelectedEvent = useVTKCallback(\n      computed(() => widget.value?.onSelectedEvent)\n    );\n\n    onSelectedEvent((selected) => {\n      emit('select', selected);\n    });\n\n    // update widget state's selection state if selected prop changes\n    watchEffect(() => {\n      widgetState.value?.setSelected(isSelected.value);\n      // renders any visual cues when selecting\n      viewProxy.value?.renderLater();\n    });\n\n    // --- right click handling --- //\n\n    let rightClickSub: vtkSubscription | null = null;\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      rightClickSub = widget.value.onRightClickEvent((eventData) => {\n        const coords = getCSSCoordinatesFromEvent(eventData);\n        if (coords) {\n          emit('contextmenu', coords);\n        }\n      });\n    });\n\n    onBeforeUnmount(() => {\n      if (rightClickSub) {\n        rightClickSub.unsubscribe();\n        rightClickSub = null;\n      }\n    });\n\n    // --- manipulator --- //\n\n    const manipulator = vtkPlaneManipulator.newInstance();\n\n    onMounted(() => {\n      widget.value?.setManipulator(manipulator);\n    });\n\n    watchEffect(() => {\n      updatePlaneManipulatorFor2DView(\n        manipulator,\n        viewDirection.value,\n        currentSlice.value,\n        currentImageMetadata.value\n      );\n    });\n\n    // --- visibility --- //\n\n    watch(\n      () =>\n        !!viewProxy.value &&\n        !!widget.value &&\n        contour.value?.slice === currentSlice.value,\n      (visible) => {\n        widget.value?.setVisibility(visible);\n      },\n      { immediate: true }\n    );\n\n    onMounted(() => {\n      if (!widget.value) {\n        return;\n      }\n      // hide handle visibility, but not picking visibility\n      widget.value.setHandleVisibility(false);\n      // render picking buffer\n      widgetManager.value.renderWidgets();\n      // render front buffer\n      viewProxy.value?.renderLater();\n    });\n\n    // --- rendering --- //\n\n    // widgetState.getColor() is backed by contourStore.\n    // Whenever the color changes, update the widget state\n    // mtime and render the new color.\n    watch(\n      () => widget.value?.getWidgetState().getColor(),\n      () => {\n        widget.value?.getWidgetState().modified();\n        viewProxy.value?.renderLater();\n      }\n    );\n\n    // --- set widget data --- //\n\n    const viewAxisIndex = computed(() => {\n      return currentImageMetadata.value.lpsOrientation[\n        getLPSAxisFromDir(viewDirection.value)\n      ];\n    });\n\n    watchEffect(() => {\n      const imageData = currentImageData.value;\n      const sliceAxis = viewAxisIndex.value;\n      const slice = currentSlice.value;\n      if (widget.value && imageData) {\n        widget.value.setThresholdingImageSlice(imageData, sliceAxis, slice);\n      }\n    });\n\n    return () => null;\n  },\n});\n</script>\n","<script lang=\"ts\">\nimport { onKeyDown } from '@vueuse/core';\nimport { Maybe } from '@/src/types';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useToolStore } from '@/src/store/tools';\nimport useContourStore, { ContourToolMode } from '@/src/store/tools/contours';\nimport { Tools } from '@/src/store/tools/types';\nimport { useViewStore } from '@/src/store/views';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport { frameOfReferenceToImageSliceAndAxis } from '@/src/utils/frameOfReference';\nimport { getLPSAxisFromDir } from '@/src/utils/lps';\nimport type { Vector2 } from '@kitware/vtk.js/types';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport {\n  computed,\n  defineComponent,\n  ref,\n  toRefs,\n  watch,\n  PropType,\n  onUnmounted,\n  reactive,\n} from 'vue';\nimport { storeToRefs } from 'pinia';\nimport {\n  ReferencePlane,\n  referencePlaneToFrame,\n  getReferencePlaneFromSlice,\n} from '@/src/core/contours/referencePlane';\nimport type { ContourID } from '@/src/types/contour';\nimport ContourWidget2D from './contour/ContourWidget2D.vue';\n\nconst AutoAddDrawingContourModes = new Set([\n  ContourToolMode.FreehandDraw,\n  ContourToolMode.PointPlacing,\n  ContourToolMode.Threshold,\n]);\n\nfunction fequals(a: number, b: number, eps = 1e-6) {\n  return Math.abs(a - b) < eps;\n}\n\nexport default defineComponent({\n  components: { ContourWidget2D },\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n    currentSlice: {\n      type: Number,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n  },\n  setup(props) {\n    const { viewId, viewDirection, currentSlice } = toRefs(props);\n    const toolStore = useToolStore();\n    const contourStore = useContourStore();\n    const { currentImageID, currentImageMetadata } = useCurrentImage();\n    const viewAxis = computed(() => getLPSAxisFromDir(viewDirection.value));\n    const { mode: toolMode, selectedContourID } = storeToRefs(contourStore);\n\n    const drawingContourID = ref<Maybe<ContourID>>(null);\n\n    const isToolActive = computed(\n      () => toolStore.currentTool === Tools.Contour\n    );\n    const viewType = computed(() => {\n      const viewStore = useViewStore();\n      return viewStore.viewSpecs[viewId.value].viewType;\n    });\n\n    type IsContourInCurrentViewOptions = {\n      checkImageID?: boolean;\n      checkSlice?: boolean;\n    };\n\n    const isContourInCurrentView = (\n      contourId: ContourID,\n      opts?: IsContourInCurrentViewOptions\n    ) => {\n      const { toolByID } = contourStore;\n      if (!(contourId in toolByID)) return false;\n\n      const { referencePlane, imageID } = toolByID[contourId];\n\n      const frameOfReference = referencePlaneToFrame(referencePlane);\n      const axisAndSlice = frameOfReferenceToImageSliceAndAxis(\n        frameOfReference,\n        currentImageMetadata.value,\n        {\n          allowOutOfBoundsSlice: true,\n        }\n      );\n      if (!axisAndSlice) return false;\n\n      const checkImageID = opts?.checkImageID ?? false;\n      const checkSlice = opts?.checkSlice ?? false;\n      const { axis, slice } = axisAndSlice;\n      return (\n        axis === viewAxis.value &&\n        (!checkImageID || imageID === currentImageID.value) &&\n        (!checkSlice || fequals(slice, currentSlice.value))\n      );\n    };\n\n    const contours = computed(() => {\n      return contourStore.toolIDs\n        .filter((id) => {\n          // only show contours for the current image and view axis\n          return isContourInCurrentView(id, { checkImageID: true });\n        })\n        .map((id) => contourStore.toolByID[id])\n        .filter(Boolean);\n    });\n\n    // --- active/drawing contour management -- //\n\n    const commitDrawingContour = () => {\n      drawingContourID.value = null;\n    };\n\n    const addDrawingContour = () => {\n      if (currentImageID.value && !drawingContourID.value) {\n        drawingContourID.value = contourStore.addTool({\n          imageID: currentImageID.value,\n        });\n      }\n    };\n\n    const clearDrawingContour = () => {\n      if (drawingContourID.value != null) {\n        contourStore.removeTool(drawingContourID.value);\n        drawingContourID.value = null;\n      }\n    };\n\n    // update the drawing contour's label to the active label\n    const { activeLabel } = storeToRefs(contourStore);\n\n    watch(\n      [activeLabel, drawingContourID],\n      ([label, contourID]) => {\n        if (contourID) {\n          contourStore.updateTool(contourID, {\n            label,\n          });\n        }\n      },\n      { immediate: true }\n    );\n\n    watch(\n      [isToolActive, currentImageID],\n      ([active, imageID]) => {\n        clearDrawingContour();\n        if (active && imageID) {\n          addDrawingContour();\n        }\n      },\n      { immediate: true }\n    );\n\n    watch(\n      toolMode,\n      (mode) => {\n        clearDrawingContour();\n        if (AutoAddDrawingContourModes.has(mode)) {\n          addDrawingContour();\n        }\n      },\n      { immediate: true }\n    );\n\n    onUnmounted(() => {\n      clearDrawingContour();\n    });\n\n    const onContourFinalized = () => {\n      commitDrawingContour();\n      addDrawingContour();\n    };\n\n    // --- updating active/drawing contour frame --- //\n\n    function getCurrentReferencePlane(): ReferencePlane {\n      const { lpsOrientation, indexToWorld } = currentImageMetadata.value;\n      const sliceAxis = lpsOrientation[viewAxis.value];\n      return getReferencePlaneFromSlice(\n        indexToWorld,\n        currentSlice.value,\n        sliceAxis\n      );\n    }\n\n    // update active/drawing contour's frame + slice, since the\n    // active/drawing contour is not finalized.\n    watch(\n      [currentSlice, drawingContourID] as const,\n      ([slice, contourID]) => {\n        if (!contourID) return;\n        contourStore.updateTool(contourID, {\n          slice,\n          referencePlane: getCurrentReferencePlane(),\n        });\n      },\n      { immediate: true }\n    );\n\n    // --- selected contour --- //\n\n    const onContourSelected = (id: ContourID, selected: boolean) => {\n      if (selected) {\n        contourStore.selectContour(id);\n      } else if (id === selectedContourID.value) {\n        contourStore.selectContour(null);\n      }\n    };\n\n    watch([currentSlice, currentImageID], () => {\n      const selected = selectedContourID.value;\n      if (!selected) return;\n\n      if (\n        isContourInCurrentView(selected, {\n          checkImageID: true,\n          checkSlice: true,\n        })\n      ) {\n        contourStore.selectContour(null);\n      }\n    });\n\n    onKeyDown(['Delete', 'Backspace'], (ev) => {\n      ev.preventDefault();\n      if (selectedContourID.value) {\n        contourStore.removeTool(selectedContourID.value);\n      }\n    });\n\n    // --- context menu --- //\n\n    const contextMenu = reactive({\n      visible: false,\n      x: 0,\n      y: 0,\n      id: '' as ContourID,\n    });\n\n    const onContextMenu = (id: ContourID, displayXY: Vector2) => {\n      [contextMenu.x, contextMenu.y] = displayXY;\n      contextMenu.visible = true;\n      contextMenu.id = id;\n    };\n\n    const deleteFromContextMenu = () => {\n      contourStore.removeTool(contextMenu.id);\n    };\n\n    const contextMenuLabels = computed(() => {\n      const { id: contourID } = contextMenu;\n      if (!(contourID in contourStore.toolByID)) {\n        return [];\n      }\n\n      const contour = contourStore.toolByID[contourID];\n      return Object.entries(contourStore.labels).map(([labelID, label]) => ({\n        id: labelID,\n        name: label.labelName,\n        isCurrent: contour.label === labelID,\n      }));\n    });\n\n    const setLabelFromContextMenu = (label: string) => {\n      contourStore.updateTool(contextMenu.id, { label });\n    };\n\n    // --- //\n\n    return {\n      isToolActive,\n      is2D: computed(() => viewType.value === '2D'),\n      contours,\n      drawingContourID,\n      selectedContourID,\n      toolMode: computed(() =>\n        isToolActive.value ? toolMode.value : ContourToolMode.Select\n      ),\n      contextMenu,\n      contextMenuLabels,\n      onContourFinalized,\n      onContourSelected,\n      onContextMenu,\n      deleteFromContextMenu,\n      setLabelFromContextMenu,\n    };\n  },\n});\n</script>\n\n<template>\n  <div v-if=\"is2D\" class=\"overlay-no-events\">\n    <ContourWidget2D\n      v-for=\"contour in contours\"\n      :key=\"contour.id\"\n      :view-id=\"viewId\"\n      :current-slice=\"currentSlice\"\n      :contour-id=\"contour.id\"\n      :view-direction=\"viewDirection\"\n      :widget-manager=\"widgetManager\"\n      :drawing=\"drawingContourID === contour.id\"\n      :mode=\"toolMode\"\n      :selected=\"selectedContourID === contour.id\"\n      @finalize=\"onContourFinalized\"\n      @select=\"onContourSelected(contour.id, $event)\"\n      @contextmenu=\"onContextMenu(contour.id, $event)\"\n    />\n    <v-menu\n      v-model=\"contextMenu.visible\"\n      :style=\"{\n        position: 'absolute',\n        top: `${contextMenu.y}px`,\n        left: `${contextMenu.x}px`,\n      }\"\n      close-on-click\n      close-on-content-click\n    >\n      <v-list dense>\n        <v-list-item @click.stop>\n          <v-list-item-title\n            class=\"d-flex flex-row align-center justify-space-betwen\"\n          >\n            <span>Change label to...</span>\n            <v-icon>mdi-chevron-right</v-icon>\n          </v-list-item-title>\n          <v-menu open-on-hover activator=\"parent\" location=\"end\">\n            <v-list dense>\n              <v-list-item v-for=\"(label, idx) in contextMenuLabels\" :key=\"idx\">\n                <v-radio\n                  :label=\"label.name\"\n                  :model-value=\"label.isCurrent\"\n                  @click=\"setLabelFromContextMenu(label.id)\"\n                >\n                </v-radio>\n              </v-list-item>\n            </v-list>\n          </v-menu>\n        </v-list-item>\n        <v-list-item @click=\"deleteFromContextMenu\">\n          <v-list-item-title>Delete</v-list-item-title>\n        </v-list-item>\n      </v-list>\n    </v-menu>\n  </div>\n</template>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","<script lang=\"ts\">\nimport { onKeyDown } from '@vueuse/core';\nimport { Maybe } from '@/src/types';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useToolStore } from '@/src/store/tools';\nimport useContourStore, { ContourToolMode } from '@/src/store/tools/contours';\nimport { Tools } from '@/src/store/tools/types';\nimport { useViewStore } from '@/src/store/views';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport { frameOfReferenceToImageSliceAndAxis } from '@/src/utils/frameOfReference';\nimport { getLPSAxisFromDir } from '@/src/utils/lps';\nimport type { Vector2 } from '@kitware/vtk.js/types';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport {\n  computed,\n  defineComponent,\n  ref,\n  toRefs,\n  watch,\n  PropType,\n  onUnmounted,\n  reactive,\n} from 'vue';\nimport { storeToRefs } from 'pinia';\nimport {\n  ReferencePlane,\n  referencePlaneToFrame,\n  getReferencePlaneFromSlice,\n} from '@/src/core/contours/referencePlane';\nimport type { ContourID } from '@/src/types/contour';\nimport ContourWidget2D from './contour/ContourWidget2D.vue';\n\nconst AutoAddDrawingContourModes = new Set([\n  ContourToolMode.FreehandDraw,\n  ContourToolMode.PointPlacing,\n  ContourToolMode.Threshold,\n]);\n\nfunction fequals(a: number, b: number, eps = 1e-6) {\n  return Math.abs(a - b) < eps;\n}\n\nexport default defineComponent({\n  components: { ContourWidget2D },\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n    currentSlice: {\n      type: Number,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n  },\n  setup(props) {\n    const { viewId, viewDirection, currentSlice } = toRefs(props);\n    const toolStore = useToolStore();\n    const contourStore = useContourStore();\n    const { currentImageID, currentImageMetadata } = useCurrentImage();\n    const viewAxis = computed(() => getLPSAxisFromDir(viewDirection.value));\n    const { mode: toolMode, selectedContourID } = storeToRefs(contourStore);\n\n    const drawingContourID = ref<Maybe<ContourID>>(null);\n\n    const isToolActive = computed(\n      () => toolStore.currentTool === Tools.Contour\n    );\n    const viewType = computed(() => {\n      const viewStore = useViewStore();\n      return viewStore.viewSpecs[viewId.value].viewType;\n    });\n\n    type IsContourInCurrentViewOptions = {\n      checkImageID?: boolean;\n      checkSlice?: boolean;\n    };\n\n    const isContourInCurrentView = (\n      contourId: ContourID,\n      opts?: IsContourInCurrentViewOptions\n    ) => {\n      const { toolByID } = contourStore;\n      if (!(contourId in toolByID)) return false;\n\n      const { referencePlane, imageID } = toolByID[contourId];\n\n      const frameOfReference = referencePlaneToFrame(referencePlane);\n      const axisAndSlice = frameOfReferenceToImageSliceAndAxis(\n        frameOfReference,\n        currentImageMetadata.value,\n        {\n          allowOutOfBoundsSlice: true,\n        }\n      );\n      if (!axisAndSlice) return false;\n\n      const checkImageID = opts?.checkImageID ?? false;\n      const checkSlice = opts?.checkSlice ?? false;\n      const { axis, slice } = axisAndSlice;\n      return (\n        axis === viewAxis.value &&\n        (!checkImageID || imageID === currentImageID.value) &&\n        (!checkSlice || fequals(slice, currentSlice.value))\n      );\n    };\n\n    const contours = computed(() => {\n      return contourStore.toolIDs\n        .filter((id) => {\n          // only show contours for the current image and view axis\n          return isContourInCurrentView(id, { checkImageID: true });\n        })\n        .map((id) => contourStore.toolByID[id])\n        .filter(Boolean);\n    });\n\n    // --- active/drawing contour management -- //\n\n    const commitDrawingContour = () => {\n      drawingContourID.value = null;\n    };\n\n    const addDrawingContour = () => {\n      if (currentImageID.value && !drawingContourID.value) {\n        drawingContourID.value = contourStore.addTool({\n          imageID: currentImageID.value,\n        });\n      }\n    };\n\n    const clearDrawingContour = () => {\n      if (drawingContourID.value != null) {\n        contourStore.removeTool(drawingContourID.value);\n        drawingContourID.value = null;\n      }\n    };\n\n    // update the drawing contour's label to the active label\n    const { activeLabel } = storeToRefs(contourStore);\n\n    watch(\n      [activeLabel, drawingContourID],\n      ([label, contourID]) => {\n        if (contourID) {\n          contourStore.updateTool(contourID, {\n            label,\n          });\n        }\n      },\n      { immediate: true }\n    );\n\n    watch(\n      [isToolActive, currentImageID],\n      ([active, imageID]) => {\n        clearDrawingContour();\n        if (active && imageID) {\n          addDrawingContour();\n        }\n      },\n      { immediate: true }\n    );\n\n    watch(\n      toolMode,\n      (mode) => {\n        clearDrawingContour();\n        if (AutoAddDrawingContourModes.has(mode)) {\n          addDrawingContour();\n        }\n      },\n      { immediate: true }\n    );\n\n    onUnmounted(() => {\n      clearDrawingContour();\n    });\n\n    const onContourFinalized = () => {\n      commitDrawingContour();\n      addDrawingContour();\n    };\n\n    // --- updating active/drawing contour frame --- //\n\n    function getCurrentReferencePlane(): ReferencePlane {\n      const { lpsOrientation, indexToWorld } = currentImageMetadata.value;\n      const sliceAxis = lpsOrientation[viewAxis.value];\n      return getReferencePlaneFromSlice(\n        indexToWorld,\n        currentSlice.value,\n        sliceAxis\n      );\n    }\n\n    // update active/drawing contour's frame + slice, since the\n    // active/drawing contour is not finalized.\n    watch(\n      [currentSlice, drawingContourID] as const,\n      ([slice, contourID]) => {\n        if (!contourID) return;\n        contourStore.updateTool(contourID, {\n          slice,\n          referencePlane: getCurrentReferencePlane(),\n        });\n      },\n      { immediate: true }\n    );\n\n    // --- selected contour --- //\n\n    const onContourSelected = (id: ContourID, selected: boolean) => {\n      if (selected) {\n        contourStore.selectContour(id);\n      } else if (id === selectedContourID.value) {\n        contourStore.selectContour(null);\n      }\n    };\n\n    watch([currentSlice, currentImageID], () => {\n      const selected = selectedContourID.value;\n      if (!selected) return;\n\n      if (\n        isContourInCurrentView(selected, {\n          checkImageID: true,\n          checkSlice: true,\n        })\n      ) {\n        contourStore.selectContour(null);\n      }\n    });\n\n    onKeyDown(['Delete', 'Backspace'], (ev) => {\n      ev.preventDefault();\n      if (selectedContourID.value) {\n        contourStore.removeTool(selectedContourID.value);\n      }\n    });\n\n    // --- context menu --- //\n\n    const contextMenu = reactive({\n      visible: false,\n      x: 0,\n      y: 0,\n      id: '' as ContourID,\n    });\n\n    const onContextMenu = (id: ContourID, displayXY: Vector2) => {\n      [contextMenu.x, contextMenu.y] = displayXY;\n      contextMenu.visible = true;\n      contextMenu.id = id;\n    };\n\n    const deleteFromContextMenu = () => {\n      contourStore.removeTool(contextMenu.id);\n    };\n\n    const contextMenuLabels = computed(() => {\n      const { id: contourID } = contextMenu;\n      if (!(contourID in contourStore.toolByID)) {\n        return [];\n      }\n\n      const contour = contourStore.toolByID[contourID];\n      return Object.entries(contourStore.labels).map(([labelID, label]) => ({\n        id: labelID,\n        name: label.labelName,\n        isCurrent: contour.label === labelID,\n      }));\n    });\n\n    const setLabelFromContextMenu = (label: string) => {\n      contourStore.updateTool(contextMenu.id, { label });\n    };\n\n    // --- //\n\n    return {\n      isToolActive,\n      is2D: computed(() => viewType.value === '2D'),\n      contours,\n      drawingContourID,\n      selectedContourID,\n      toolMode: computed(() =>\n        isToolActive.value ? toolMode.value : ContourToolMode.Select\n      ),\n      contextMenu,\n      contextMenuLabels,\n      onContourFinalized,\n      onContourSelected,\n      onContextMenu,\n      deleteFromContextMenu,\n      setLabelFromContextMenu,\n    };\n  },\n});\n</script>\n\n<template>\n  <div v-if=\"is2D\" class=\"overlay-no-events\">\n    <ContourWidget2D\n      v-for=\"contour in contours\"\n      :key=\"contour.id\"\n      :view-id=\"viewId\"\n      :current-slice=\"currentSlice\"\n      :contour-id=\"contour.id\"\n      :view-direction=\"viewDirection\"\n      :widget-manager=\"widgetManager\"\n      :drawing=\"drawingContourID === contour.id\"\n      :mode=\"toolMode\"\n      :selected=\"selectedContourID === contour.id\"\n      @finalize=\"onContourFinalized\"\n      @select=\"onContourSelected(contour.id, $event)\"\n      @contextmenu=\"onContextMenu(contour.id, $event)\"\n    />\n    <v-menu\n      v-model=\"contextMenu.visible\"\n      :style=\"{\n        position: 'absolute',\n        top: `${contextMenu.y}px`,\n        left: `${contextMenu.x}px`,\n      }\"\n      close-on-click\n      close-on-content-click\n    >\n      <v-list dense>\n        <v-list-item @click.stop>\n          <v-list-item-title\n            class=\"d-flex flex-row align-center justify-space-betwen\"\n          >\n            <span>Change label to...</span>\n            <v-icon>mdi-chevron-right</v-icon>\n          </v-list-item-title>\n          <v-menu open-on-hover activator=\"parent\" location=\"end\">\n            <v-list dense>\n              <v-list-item v-for=\"(label, idx) in contextMenuLabels\" :key=\"idx\">\n                <v-radio\n                  :label=\"label.name\"\n                  :model-value=\"label.isCurrent\"\n                  @click=\"setLabelFromContextMenu(label.id)\"\n                >\n                </v-radio>\n              </v-list-item>\n            </v-list>\n          </v-menu>\n        </v-list-item>\n        <v-list-item @click=\"deleteFromContextMenu\">\n          <v-list-item-title>Delete</v-list-item-title>\n        </v-list-item>\n      </v-list>\n    </v-menu>\n  </div>\n</template>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","<script lang=\"ts\">\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport {\n  computed,\n  defineComponent,\n  onBeforeUnmount,\n  onMounted,\n  onUnmounted,\n  PropType,\n  ref,\n  toRefs,\n  watchEffect,\n} from 'vue';\nimport vtkPlaneManipulator from '@kitware/vtk.js/Widgets/Manipulators/PlaneManipulator';\nimport { getLPSAxisFromDir } from '@/src/utils/lps';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { updatePlaneManipulatorFor2DView } from '@/src/utils/manipulators';\nimport type { vtkSubscription } from '@kitware/vtk.js/interfaces';\nimport { usePaintToolStore } from '@/src/store/tools/paint';\nimport { vtkPaintViewWidget } from '@/src/vtk/PaintWidget';\nimport { useViewStore } from '@/src/store/views';\nimport { PaintWidgetState } from '@/src/vtk/PaintWidget/state';\nimport { vec3 } from 'gl-matrix';\nimport { manageVTKSubscription } from '@/src/composables/manageVTKSubscription';\nimport { LPSAxisDir } from '@/src/types/lps';\n\nexport default defineComponent({\n  name: 'PaintWidget2D',\n  props: {\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n    viewId: {\n      type: String,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    slice: {\n      type: Number,\n      required: true,\n    },\n  },\n  setup(props) {\n    const {\n      widgetManager: widgetManagerRef,\n      viewDirection,\n      slice,\n      viewId: viewID,\n    } = toRefs(props);\n\n    const paintStore = usePaintToolStore();\n    const factory = paintStore.getWidgetFactory();\n\n    const viewStore = useViewStore();\n    const viewProxyRef = computed(() => viewStore.getViewProxy(viewID.value));\n\n    const widgetRef = ref<vtkPaintViewWidget>();\n\n    const { currentImageMetadata } = useCurrentImage();\n    const viewAxis = computed(() => getLPSAxisFromDir(viewDirection.value));\n    const viewAxisIndex = computed(\n      () => currentImageMetadata.value.lpsOrientation[viewAxis.value]\n    );\n\n    const worldPointToIndex = (worldPoint: vec3) => {\n      const { worldToIndex } = currentImageMetadata.value;\n      const indexPoint = vec3.create();\n      vec3.transformMat4(indexPoint, worldPoint, worldToIndex);\n      return indexPoint;\n    };\n\n    onMounted(() => {\n      const widgetManager = widgetManagerRef.value;\n      widgetRef.value = widgetManager.addWidget(factory) as vtkPaintViewWidget;\n\n      if (!widgetRef.value) {\n        throw new Error('[PaintWidget2D] failed to create view widget');\n      }\n    });\n\n    // --- widget representation config --- //\n\n    watchEffect(() => {\n      const widget = widgetRef.value!;\n      const metadata = currentImageMetadata.value;\n      const slicingIndex = metadata.lpsOrientation[viewAxis.value];\n      if (widget) {\n        widget.setSlicingIndex(slicingIndex);\n        widget.setIndexToWorld(metadata.indexToWorld);\n        widget.setWorldToIndex(metadata.worldToIndex);\n      }\n    });\n\n    // --- interaction --- //\n\n    const subs: vtkSubscription[] = [];\n\n    onMounted(() => {\n      const widget = widgetRef.value!;\n\n      subs.push(\n        widget.onStartInteractionEvent(() => {\n          // start stroke\n          const state = widget.getWidgetState() as PaintWidgetState;\n          // StartInteraction cannot occur if origin is null.\n          const indexPoint = worldPointToIndex(state.getBrush().getOrigin()!);\n          paintStore.startStroke(indexPoint, viewAxisIndex.value);\n        }),\n        widget.onInteractionEvent(() => {\n          // register stroke\n          const state = widget.getWidgetState() as PaintWidgetState;\n          const indexPoint = worldPointToIndex(state.getBrush().getOrigin()!);\n          paintStore.placeStrokePoint(indexPoint, viewAxisIndex.value);\n        }),\n        widget.onEndInteractionEvent(() => {\n          // end stroke\n          const state = widget.getWidgetState() as PaintWidgetState;\n          const indexPoint = worldPointToIndex(state.getBrush().getOrigin()!);\n          paintStore.endStroke(indexPoint, viewAxisIndex.value);\n        })\n      );\n    });\n\n    onUnmounted(() => {\n      while (subs.length) {\n        subs.pop()!.unsubscribe();\n      }\n    });\n\n    // --- manipulator --- //\n\n    const manipulator = vtkPlaneManipulator.newInstance();\n\n    onMounted(() => {\n      widgetRef.value!.setManipulator(manipulator);\n    });\n\n    watchEffect(() => {\n      updatePlaneManipulatorFor2DView(\n        manipulator,\n        viewDirection.value,\n        slice.value,\n        currentImageMetadata.value\n      );\n    });\n\n    // --- visibility --- //\n\n    onMounted(() => {\n      widgetRef.value!.setVisibility(false);\n    });\n\n    manageVTKSubscription(\n      viewProxyRef.value!.getInteractor().onMouseEnter(() => {\n        const widget = widgetRef.value;\n        if (widget) {\n          paintStore.setSliceAxis(viewAxisIndex.value);\n          widget.setVisibility(true);\n        }\n      })\n    );\n\n    manageVTKSubscription(\n      viewProxyRef.value!.getInteractor().onMouseLeave(() => {\n        const widget = widgetRef.value;\n        if (widget) {\n          widget.setVisibility(false);\n        }\n      })\n    );\n\n    // --- focus and rendering --- //\n\n    onMounted(() => {\n      const widgetManager = widgetManagerRef.value;\n      widgetManager.renderWidgets();\n      widgetManager.grabFocus(widgetRef.value!);\n    });\n\n    onBeforeUnmount(() => {\n      widgetManagerRef.value.removeWidget(widgetRef.value!);\n      widgetManagerRef.value.releaseFocus();\n    });\n\n    return () => null;\n  },\n});\n</script>\n","<template>\n  <div class=\"overlay-no-events\">\n    <PaintWidget2D\n      v-if=\"active\"\n      :slice=\"slice\"\n      :view-id=\"viewId\"\n      :view-direction=\"viewDirection\"\n      :widget-manager=\"widgetManager\"\n    />\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { computed, defineComponent, PropType } from 'vue';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport { usePaintToolStore } from '@/src/store/tools/paint';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport PaintWidget2D from './paint/PaintWidget2D.vue';\n\nexport default defineComponent({\n  name: 'PaintTool',\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n    slice: {\n      type: Number,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n  },\n  components: {\n    PaintWidget2D,\n  },\n  setup() {\n    const paintStore = usePaintToolStore();\n    const active = computed(() => paintStore.isActive);\n\n    return {\n      active,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","<template>\n  <div class=\"overlay-no-events\">\n    <PaintWidget2D\n      v-if=\"active\"\n      :slice=\"slice\"\n      :view-id=\"viewId\"\n      :view-direction=\"viewDirection\"\n      :widget-manager=\"widgetManager\"\n    />\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { computed, defineComponent, PropType } from 'vue';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport { usePaintToolStore } from '@/src/store/tools/paint';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport PaintWidget2D from './paint/PaintWidget2D.vue';\n\nexport default defineComponent({\n  name: 'PaintTool',\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n    slice: {\n      type: Number,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n  },\n  components: {\n    PaintWidget2D,\n  },\n  setup() {\n    const paintStore = usePaintToolStore();\n    const active = computed(() => paintStore.isActive);\n\n    return {\n      active,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","import vtkAbstractRepresentationProxy from '@kitware/vtk.js/Proxy/Core/AbstractRepresentationProxy';\nimport { computed, Ref, watch } from 'vue';\nimport { useViewStore } from '../store/views';\nimport { vtkLPSViewProxy } from '../types/vtk-types';\nimport { arrayEquals } from '../utils';\n\ninterface Scene {\n  baseImage?: Ref<string | null>;\n  labelmaps?: Ref<string[]>;\n  layers?: Ref<string[]>;\n  models?: Ref<string[]>;\n}\n\ntype RepProxy = vtkAbstractRepresentationProxy;\n\nexport function useSceneBuilder<\n  BaseImageType extends RepProxy = RepProxy,\n  LabelMapType extends RepProxy = RepProxy,\n  LayerType extends RepProxy = RepProxy,\n  ModelType extends RepProxy = RepProxy\n>(viewID: Ref<string>, sceneIDs: Scene) {\n  const viewStore = useViewStore();\n  const viewProxy = computed(() =>\n    viewStore.getViewProxy<vtkLPSViewProxy>(viewID.value)\n  );\n\n  const baseImageRep = computed(() => {\n    const imageID = sceneIDs.baseImage?.value;\n    if (!imageID) return null;\n\n    return viewStore.getDataRepresentationForView<BaseImageType>(\n      imageID,\n      viewID.value\n    );\n  });\n\n  const labelmapReps = computed(() => {\n    const labelmapIDs = sceneIDs.labelmaps?.value ?? [];\n    return labelmapIDs\n      .map((id) =>\n        viewStore.getDataRepresentationForView<LabelMapType>(id, viewID.value)\n      )\n      .filter(Boolean) as LabelMapType[];\n  });\n\n  const layerReps = computed(\n    () =>\n      (sceneIDs.layers?.value ?? [])\n        .map((id) =>\n          viewStore.getDataRepresentationForView<LayerType>(id, viewID.value)\n        )\n        .filter(Boolean) as LayerType[]\n  );\n\n  const modelReps = computed(() => {\n    const modelIDs = sceneIDs.models?.value ?? [];\n    return modelIDs\n      .map((id) =>\n        viewStore.getDataRepresentationForView<ModelType>(id, viewID.value)\n      )\n      .filter(Boolean) as ModelType[];\n  });\n\n  type SceneObject = BaseImageType | LabelMapType | LayerType | ModelType;\n\n  const allRepresentations = computed<SceneObject[]>(() => {\n    return [\n      baseImageRep.value,\n      ...labelmapReps.value,\n      ...layerReps.value,\n      ...modelReps.value,\n    ].filter(Boolean) as SceneObject[];\n  });\n\n  watch(\n    [viewProxy, allRepresentations],\n    ([view, reps], [, oldReps]) => {\n      if (!view) {\n        throw new Error('[useSceneBuilder] No view available');\n      }\n\n      if (oldReps && arrayEquals(reps, oldReps)) {\n        return;\n      }\n\n      view.removeAllRepresentations();\n      reps.forEach((rep) => {\n        view.addRepresentation(rep);\n      });\n\n      // TODO not sure why I need this, but might as well keep\n      // the renderer up to date.\n      // For reference, this doesn't get invoked when resetting the\n      // camera with a supplied bounds, so we manually invoke it here.\n      view.getRenderer().computeVisiblePropBounds();\n      view.renderLater();\n    },\n    { immediate: true }\n  );\n\n  return { baseImageRep, labelmapReps, layerReps, modelReps };\n}\n","import { manageVTKSubscription } from '@src/composables/manageVTKSubscription';\nimport { Ref } from 'vue';\nimport { CameraConfig } from '../store/view-configs/types';\nimport { vtkLPSViewProxy } from '../types/vtk-types';\nimport useViewCameraStore from '../store/view-configs/camera';\n\nexport function usePersistCameraConfig(\n  viewID: Ref<string>,\n  dataID: Ref<string | null>,\n  viewProxy: Ref<vtkLPSViewProxy>,\n  ...toPersist: (keyof CameraConfig)[]\n) {\n  const viewCameraStore = useViewCameraStore();\n  let persistCameraConfig = true;\n\n  // We setup this list of functions to avoid if and indexOf in the onModified\n  // call.\n  const persist: (() => void)[] = [];\n\n  if (toPersist.indexOf('position') > -1) {\n    persist.push(() => {\n      if (dataID.value !== null && persistCameraConfig) {\n        viewCameraStore.updateConfig(viewID.value, dataID.value, {\n          position: viewProxy.value.getCamera().getPosition(),\n        });\n      }\n    });\n  }\n  if (toPersist.indexOf('viewUp') > -1) {\n    persist.push(() => {\n      if (dataID.value !== null && persistCameraConfig) {\n        viewCameraStore.updateConfig(viewID.value, dataID.value, {\n          viewUp: viewProxy.value.getCamera().getViewUp(),\n        });\n      }\n    });\n  }\n  if (toPersist.indexOf('focalPoint') > -1) {\n    persist.push(() => {\n      if (dataID.value !== null && persistCameraConfig) {\n        viewCameraStore.updateConfig(viewID.value, dataID.value, {\n          focalPoint: viewProxy.value.getCamera().getFocalPoint(),\n        });\n      }\n    });\n  }\n  if (toPersist.indexOf('directionOfProjection') > -1) {\n    persist.push(() => {\n      if (dataID.value !== null && persistCameraConfig) {\n        viewCameraStore.updateConfig(viewID.value, dataID.value, {\n          directionOfProjection: viewProxy.value\n            .getCamera()\n            .getDirectionOfProjection(),\n        });\n      }\n    });\n  }\n  if (toPersist.indexOf('parallelScale') > -1) {\n    persist.push(() => {\n      if (dataID.value !== null && persistCameraConfig) {\n        viewCameraStore.updateConfig(viewID.value, dataID.value, {\n          parallelScale: viewProxy.value.getCamera().getParallelScale(),\n        });\n      }\n    });\n  }\n\n  manageVTKSubscription(\n    viewProxy.value.getCamera().onModified(() => {\n      persist.forEach((persistFunc) => persistFunc());\n    })\n  );\n\n  function blockPersistingCameraConfig(func: () => void) {\n    persistCameraConfig = false;\n    try {\n      func();\n    } finally {\n      persistCameraConfig = true;\n    }\n  }\n\n  function restoreCameraConfig(cameraConfig: CameraConfig) {\n    blockPersistingCameraConfig(() => {\n      toPersist.forEach((key: keyof CameraConfig) => {\n        // Parallel scale\n        if (key === 'parallelScale' && cameraConfig.parallelScale) {\n          viewProxy.value\n            .getCamera()\n            .setParallelScale(cameraConfig.parallelScale);\n        }\n        // Position\n        else if (key === 'position' && cameraConfig.position) {\n          const { position } = cameraConfig;\n          viewProxy.value\n            .getCamera()\n            .setPosition(position[0], position[1], position[2]);\n        }\n        // Focal point\n        else if (key === 'focalPoint' && cameraConfig.focalPoint) {\n          const { focalPoint } = cameraConfig;\n          viewProxy.value\n            .getCamera()\n            .setFocalPoint(focalPoint[0], focalPoint[1], focalPoint[2]);\n          viewProxy.value\n            .getInteractorStyle2D()\n            .setCenterOfRotation([...focalPoint]);\n          viewProxy.value\n            .getInteractorStyle3D()\n            .setCenterOfRotation([...focalPoint]);\n        }\n        // Direction of projection\n        else if (\n          key === 'directionOfProjection' &&\n          cameraConfig.directionOfProjection\n        ) {\n          const { directionOfProjection } = cameraConfig;\n          viewProxy.value\n            .getCamera()\n            .setDirectionOfProjection(\n              directionOfProjection[0],\n              directionOfProjection[1],\n              directionOfProjection[2]\n            );\n        }\n        // View up\n        else if (key === 'viewUp' && cameraConfig.viewUp) {\n          const { viewUp } = cameraConfig;\n          viewProxy.value\n            .getCamera()\n            .setViewUp(viewUp[0], viewUp[1], viewUp[2]);\n        }\n      });\n    });\n  }\n\n  return { restoreCameraConfig };\n}\n","<script lang=\"ts\">\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport {\n  defineComponent,\n  onBeforeUnmount,\n  onMounted,\n  PropType,\n  ref,\n  toRefs,\n  watchEffect,\n} from 'vue';\nimport vtkPlaneManipulator from '@kitware/vtk.js/Widgets/Manipulators/PlaneManipulator';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { updatePlaneManipulatorFor2DView } from '@/src/utils/manipulators';\nimport { vtkCrosshairsViewWidget } from '@/src/vtk/CrosshairsWidget';\nimport { useCrosshairsToolStore } from '@/src/store/tools/crosshairs';\n\nexport default defineComponent({\n  name: 'CrosshairsWidget2D',\n  props: {\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n    viewId: {\n      type: String,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    slice: {\n      type: Number,\n      required: true,\n    },\n  },\n  setup(props) {\n    const {\n      widgetManager: widgetManagerRef,\n      viewDirection,\n      slice,\n    } = toRefs(props);\n\n    const crosshairsStore = useCrosshairsToolStore();\n    const factory = crosshairsStore.getWidgetFactory();\n\n    const widgetRef = ref<vtkCrosshairsViewWidget>();\n\n    const { currentImageMetadata } = useCurrentImage();\n    onMounted(() => {\n      const widgetManager = widgetManagerRef.value;\n      widgetRef.value = widgetManager.addWidget(\n        factory\n      ) as vtkCrosshairsViewWidget;\n\n      if (!widgetRef.value) {\n        throw new Error('[PaintWidget2D] failed to create view widget');\n      }\n    });\n\n    // --- manipulator --- //\n\n    const manipulator = vtkPlaneManipulator.newInstance();\n\n    onMounted(() => {\n      widgetRef.value!.setManipulator(manipulator);\n    });\n\n    watchEffect(() => {\n      updatePlaneManipulatorFor2DView(\n        manipulator,\n        viewDirection.value,\n        slice.value,\n        currentImageMetadata.value\n      );\n    });\n\n    // --- visibility --- //\n\n    onMounted(() => {\n      widgetRef.value!.setVisibility(true);\n    });\n\n    // --- focus and rendering --- //\n\n    onMounted(() => {\n      const widgetManager = widgetManagerRef.value;\n      widgetManager.renderWidgets();\n    });\n\n    onBeforeUnmount(() => {\n      widgetManagerRef.value.removeWidget(widgetRef.value!);\n    });\n\n    return () => null;\n  },\n});\n</script>\n","<template>\n  <g>\n    <line\n      v-if=\"x != null && y != null\"\n      :x1=\"x\"\n      y1=\"0%\"\n      :x2=\"x\"\n      :y2=\"y - 8\"\n      stroke=\"yellow\"\n      stroke-width=\"1\"\n    />\n    <line\n      v-if=\"x != null && y != null\"\n      :x1=\"x\"\n      :y1=\"y + 8\"\n      :x2=\"x\"\n      y2=\"100%\"\n      stroke=\"yellow\"\n      stroke-width=\"1\"\n    />\n    <line\n      v-if=\"x != null && y != null\"\n      x1=\"0%\"\n      :y1=\"y\"\n      :x2=\"x - 8\"\n      :y2=\"y\"\n      stroke=\"yellow\"\n      stroke-width=\"1\"\n    />\n    <line\n      v-if=\"x != null && y != null\"\n      :x1=\"x + 8\"\n      :y1=\"y\"\n      x2=\"100%\"\n      :y2=\"y\"\n      stroke=\"yellow\"\n      stroke-width=\"1\"\n    />\n  </g>\n</template>\n\n<script lang=\"ts\">\nimport { useResizeObserver } from '@/src/composables/useResizeObserver';\nimport { useVTKCallback } from '@/src/composables/useVTKCallback';\nimport { ToolContainer } from '@/src/constants';\nimport { useViewStore } from '@/src/store/views';\nimport { worldToSVG } from '@/src/utils/vtk-helpers';\nimport vtkLPSView2DProxy from '@/src/vtk/LPSView2DProxy';\nimport type { Vector3 } from '@kitware/vtk.js/types';\nimport {\n  PropType,\n  defineComponent,\n  toRefs,\n  unref,\n  ref,\n  watchEffect,\n  computed,\n  inject,\n} from 'vue';\n\ntype SVGPoint = {\n  x: number;\n  y: number;\n};\n\nexport default defineComponent({\n  props: {\n    position: Array as PropType<Array<number>>,\n    viewId: {\n      type: String,\n      required: true,\n    },\n  },\n  setup(props) {\n    const { viewId: viewID, position } = toRefs(props);\n    const position2D = ref<SVGPoint>();\n\n    const viewStore = useViewStore();\n\n    const viewProxy = computed(\n      () => viewStore.getViewProxy<vtkLPSView2DProxy>(viewID.value)!\n    );\n\n    const updatePoints = () => {\n      const viewRenderer = viewProxy.value.getRenderer();\n      const pt = unref(position) as Vector3 | undefined;\n      if (pt) {\n        const point2D = worldToSVG(pt, viewRenderer);\n        if (point2D) {\n          position2D.value = {\n            x: point2D[0],\n            y: point2D[1],\n          };\n        }\n      }\n    };\n\n    const cameraOnModified = useVTKCallback(\n      computed(() => viewProxy.value.getCamera().onModified)\n    );\n    cameraOnModified(updatePoints);\n\n    watchEffect(updatePoints);\n\n    // --- resize --- //\n\n    const containerEl = inject(ToolContainer)!;\n\n    useResizeObserver(containerEl, () => {\n      updatePoints();\n    });\n\n    return {\n      devicePixelRatio,\n      x: computed(() => position2D.value?.x),\n      y: computed(() => position2D.value?.y),\n    };\n  },\n});\n</script>\n\n<style scoped>\n.handle {\n  cursor: pointer;\n}\n</style>\n","<template>\n  <g>\n    <line\n      v-if=\"x != null && y != null\"\n      :x1=\"x\"\n      y1=\"0%\"\n      :x2=\"x\"\n      :y2=\"y - 8\"\n      stroke=\"yellow\"\n      stroke-width=\"1\"\n    />\n    <line\n      v-if=\"x != null && y != null\"\n      :x1=\"x\"\n      :y1=\"y + 8\"\n      :x2=\"x\"\n      y2=\"100%\"\n      stroke=\"yellow\"\n      stroke-width=\"1\"\n    />\n    <line\n      v-if=\"x != null && y != null\"\n      x1=\"0%\"\n      :y1=\"y\"\n      :x2=\"x - 8\"\n      :y2=\"y\"\n      stroke=\"yellow\"\n      stroke-width=\"1\"\n    />\n    <line\n      v-if=\"x != null && y != null\"\n      :x1=\"x + 8\"\n      :y1=\"y\"\n      x2=\"100%\"\n      :y2=\"y\"\n      stroke=\"yellow\"\n      stroke-width=\"1\"\n    />\n  </g>\n</template>\n\n<script lang=\"ts\">\nimport { useResizeObserver } from '@/src/composables/useResizeObserver';\nimport { useVTKCallback } from '@/src/composables/useVTKCallback';\nimport { ToolContainer } from '@/src/constants';\nimport { useViewStore } from '@/src/store/views';\nimport { worldToSVG } from '@/src/utils/vtk-helpers';\nimport vtkLPSView2DProxy from '@/src/vtk/LPSView2DProxy';\nimport type { Vector3 } from '@kitware/vtk.js/types';\nimport {\n  PropType,\n  defineComponent,\n  toRefs,\n  unref,\n  ref,\n  watchEffect,\n  computed,\n  inject,\n} from 'vue';\n\ntype SVGPoint = {\n  x: number;\n  y: number;\n};\n\nexport default defineComponent({\n  props: {\n    position: Array as PropType<Array<number>>,\n    viewId: {\n      type: String,\n      required: true,\n    },\n  },\n  setup(props) {\n    const { viewId: viewID, position } = toRefs(props);\n    const position2D = ref<SVGPoint>();\n\n    const viewStore = useViewStore();\n\n    const viewProxy = computed(\n      () => viewStore.getViewProxy<vtkLPSView2DProxy>(viewID.value)!\n    );\n\n    const updatePoints = () => {\n      const viewRenderer = viewProxy.value.getRenderer();\n      const pt = unref(position) as Vector3 | undefined;\n      if (pt) {\n        const point2D = worldToSVG(pt, viewRenderer);\n        if (point2D) {\n          position2D.value = {\n            x: point2D[0],\n            y: point2D[1],\n          };\n        }\n      }\n    };\n\n    const cameraOnModified = useVTKCallback(\n      computed(() => viewProxy.value.getCamera().onModified)\n    );\n    cameraOnModified(updatePoints);\n\n    watchEffect(updatePoints);\n\n    // --- resize --- //\n\n    const containerEl = inject(ToolContainer)!;\n\n    useResizeObserver(containerEl, () => {\n      updatePoints();\n    });\n\n    return {\n      devicePixelRatio,\n      x: computed(() => position2D.value?.x),\n      y: computed(() => position2D.value?.y),\n    };\n  },\n});\n</script>\n\n<style scoped>\n.handle {\n  cursor: pointer;\n}\n</style>\n","<template>\n  <div v-if=\"active\" class=\"overlay-no-events\">\n    <svg class=\"overlay-no-events\">\n      <CrosshairSVG2D\n        v-show=\"isVisible\"\n        :view-id=\"viewId\"\n        :position=\"position\"\n      />\n    </svg>\n    <CrosshairsWidget2D\n      :slice=\"slice\"\n      :view-id=\"viewId\"\n      :view-direction=\"viewDirection\"\n      :widget-manager=\"widgetManager\"\n    />\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { storeToRefs } from 'pinia';\nimport { computed, defineComponent, PropType, toRefs } from 'vue';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport { getLPSAxisFromDir } from '@/src/utils/lps';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport { useToolStore } from '@/src/store/tools';\nimport { Tools } from '@/src/store/tools/types';\nimport { useCrosshairsToolStore } from '@/src/store/tools/crosshairs';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { clampValue } from '@/src/utils';\nimport CrosshairsWidget2D from './crosshairs/CrosshairsWidget2D.vue';\nimport CrosshairSVG2D from './crosshairs/CrosshairSVG2D.vue';\n\nexport default defineComponent({\n  name: 'CrosshairsTool',\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n    slice: {\n      type: Number,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n  },\n  components: {\n    CrosshairsWidget2D,\n    CrosshairSVG2D,\n  },\n  setup(props) {\n    const { viewDirection, slice } = toRefs(props);\n\n    const toolStore = useToolStore();\n    const { position, imagePosition } = storeToRefs(useCrosshairsToolStore());\n\n    const { currentImageMetadata } = useCurrentImage();\n    const active = computed(() => toolStore.currentTool === Tools.Crosshairs);\n    const isVisible = computed(() => {\n      const { lpsOrientation, dimensions } = currentImageMetadata.value;\n      const axis = getLPSAxisFromDir(viewDirection.value);\n      const index = lpsOrientation[axis];\n      // Since the image rectangle is inflated by 0.5,\n      // clamp to the allowed range for the slice.\n      const crosshairsSlice = clampValue(\n        imagePosition.value[index],\n        0,\n        dimensions[index] - 1\n      );\n      return Math.round(crosshairsSlice) === slice.value;\n    });\n\n    return {\n      active,\n      position,\n      isVisible,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","<template>\n  <div v-if=\"active\" class=\"overlay-no-events\">\n    <svg class=\"overlay-no-events\">\n      <CrosshairSVG2D\n        v-show=\"isVisible\"\n        :view-id=\"viewId\"\n        :position=\"position\"\n      />\n    </svg>\n    <CrosshairsWidget2D\n      :slice=\"slice\"\n      :view-id=\"viewId\"\n      :view-direction=\"viewDirection\"\n      :widget-manager=\"widgetManager\"\n    />\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { storeToRefs } from 'pinia';\nimport { computed, defineComponent, PropType, toRefs } from 'vue';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport { getLPSAxisFromDir } from '@/src/utils/lps';\nimport { LPSAxisDir } from '@/src/types/lps';\nimport { useToolStore } from '@/src/store/tools';\nimport { Tools } from '@/src/store/tools/types';\nimport { useCrosshairsToolStore } from '@/src/store/tools/crosshairs';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { clampValue } from '@/src/utils';\nimport CrosshairsWidget2D from './crosshairs/CrosshairsWidget2D.vue';\nimport CrosshairSVG2D from './crosshairs/CrosshairSVG2D.vue';\n\nexport default defineComponent({\n  name: 'CrosshairsTool',\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n    slice: {\n      type: Number,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    widgetManager: {\n      type: Object as PropType<vtkWidgetManager>,\n      required: true,\n    },\n  },\n  components: {\n    CrosshairsWidget2D,\n    CrosshairSVG2D,\n  },\n  setup(props) {\n    const { viewDirection, slice } = toRefs(props);\n\n    const toolStore = useToolStore();\n    const { position, imagePosition } = storeToRefs(useCrosshairsToolStore());\n\n    const { currentImageMetadata } = useCurrentImage();\n    const active = computed(() => toolStore.currentTool === Tools.Crosshairs);\n    const isVisible = computed(() => {\n      const { lpsOrientation, dimensions } = currentImageMetadata.value;\n      const axis = getLPSAxisFromDir(viewDirection.value);\n      const index = lpsOrientation[axis];\n      // Since the image rectangle is inflated by 0.5,\n      // clamp to the allowed range for the slice.\n      const crosshairsSlice = clampValue(\n        imagePosition.value[index],\n        0,\n        dimensions[index] - 1\n      );\n      return Math.round(crosshairsSlice) === slice.value;\n    });\n\n    return {\n      active,\n      position,\n      isVisible,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","import type { vtkObject } from '@kitware/vtk.js/interfaces';\nimport { VtkProxy } from '@kitware/vtk.js/macros';\nimport vtkAbstractRepresentationProxy from '@kitware/vtk.js/Proxy/Core/AbstractRepresentationProxy';\nimport vtkProxyManager from '@kitware/vtk.js/Proxy/Core/ProxyManager';\nimport vtkSourceProxy from '@kitware/vtk.js/Proxy/Core/SourceProxy';\nimport vtkViewProxy from '@kitware/vtk.js/Proxy/Core/ViewProxy';\n\n// mapped in proxy.js\nexport enum ViewProxyType {\n  Volume = 'View3D',\n  Slice = 'View2D',\n}\n\n/**\n * Wrapper around the vtkProxyManager, since we don't need some of\n * its complexities.\n */\nexport default class ProxyWrapper {\n  private viewProxies: Map<string, vtkViewProxy>;\n  private dataProxies: Map<string, vtkSourceProxy<vtkObject>>;\n  private proxyManager: vtkProxyManager;\n\n  constructor(proxyManager: vtkProxyManager) {\n    this.viewProxies = new Map();\n    this.dataProxies = new Map();\n    this.proxyManager = proxyManager;\n  }\n\n  delete() {\n    const deleteProxy = (proxy: VtkProxy) =>\n      this.proxyManager.deleteProxy(proxy);\n\n    this.viewProxies.forEach(deleteProxy);\n    this.dataProxies.forEach(deleteProxy);\n  }\n\n  createView(id: string, type: ViewProxyType) {\n    if (this.viewProxies.has(id)) {\n      throw new Error('Cannot create a view with the same ID');\n    }\n\n    const proxy = this.proxyManager.createProxy<vtkViewProxy>('Views', type, {\n      name: type,\n    });\n\n    this.viewProxies.set(id, proxy);\n    return proxy;\n  }\n\n  getView<T extends vtkViewProxy>(id: string) {\n    return <T | null>this.viewProxies.get(id);\n  }\n\n  removeView(id: string) {\n    const proxy = this.viewProxies.get(id);\n    if (proxy) {\n      this.proxyManager.deleteProxy(proxy);\n      this.viewProxies.delete(id);\n    }\n  }\n\n  addData<T extends vtkObject>(id: string, data: T) {\n    if (this.dataProxies.has(id)) {\n      return;\n    }\n    const proxy = this.proxyManager.createProxy<vtkSourceProxy<T>>(\n      'Sources',\n      'TrivialProducer'\n    );\n    proxy.setInputData(data);\n    this.dataProxies.set(id, proxy);\n  }\n\n  getData<T extends vtkObject>(id: string) {\n    return <vtkSourceProxy<T> | null>(this.dataProxies.get(id) ?? null);\n  }\n\n  updateData<T extends vtkObject>(id: string, data: T) {\n    const proxy = this.dataProxies.get(id);\n    if (!proxy) {\n      return;\n    }\n    proxy.setInputData(data);\n  }\n\n  deleteData(id: string) {\n    const proxy = this.dataProxies.get(id);\n    this.dataProxies.delete(id);\n    if (proxy) this.proxyManager.deleteProxy(proxy);\n    else throw new Error('Did not find proxy for ID');\n  }\n\n  getDataRepresentationForView<T extends vtkAbstractRepresentationProxy>(\n    dataID: string,\n    viewID: string\n  ): T | null {\n    const dataProxy = this.dataProxies.get(dataID);\n    const viewProxy = this.viewProxies.get(viewID);\n    if (!dataProxy || !viewProxy) {\n      return null;\n    }\n\n    return this.proxyManager.getRepresentation(dataProxy, viewProxy);\n  }\n}\n","import vtkViewProxy from '@kitware/vtk.js/Proxy/Core/ViewProxy';\nimport { computed, ref, unref, watch } from 'vue';\nimport { MaybeRef } from '@vueuse/core';\nimport { ViewProxyType } from '../core/proxies';\nimport { useViewStore } from '../store/views';\nimport { useVTKCallback } from './useVTKCallback';\n\nexport function useViewProxy<T extends vtkViewProxy = vtkViewProxy>(\n  id: MaybeRef<string>,\n  type: MaybeRef<ViewProxyType>\n) {\n  const viewStore = useViewStore();\n\n  const container = ref<HTMLElement | null>(null);\n\n  const setContainer = (el: HTMLElement | null | undefined) => {\n    container.value = el ?? null;\n  };\n\n  const viewProxy = computed<T>(() =>\n    viewStore.createOrGetViewProxy(unref(id), unref(type))\n  );\n\n  watch(viewProxy, (curViewProxy, oldViewProxy) => {\n    oldViewProxy.setContainer(null);\n    curViewProxy.setContainer(container.value);\n  });\n\n  watch(container, (curContainer) => {\n    viewProxy.value.setContainer(curContainer);\n    // setContainer doesn't call modified\n    viewProxy.value.modified();\n  });\n\n  return {\n    viewProxy,\n    setContainer,\n  };\n}\n\nfunction onViewProxyModified<T extends vtkViewProxy = vtkViewProxy>(\n  viewProxy: MaybeRef<T>,\n  callback: () => void\n) {\n  const onModified = useVTKCallback(\n    computed(() => unref(viewProxy).onModified)\n  );\n  onModified(callback);\n}\n\nfunction useMountedViewProxy<T extends vtkViewProxy = vtkViewProxy>(\n  viewProxy: MaybeRef<T>\n) {\n  const mounted = ref(false);\n\n  const updateMounted = () => {\n    mounted.value = !!unref(viewProxy).getContainer();\n  };\n\n  updateMounted();\n\n  onViewProxyModified(viewProxy, updateMounted);\n\n  return mounted;\n}\n\nexport function useViewProxyMounted<T extends vtkViewProxy = vtkViewProxy>(\n  viewProxy: MaybeRef<T>,\n  callback: () => void\n) {\n  const mounted = useMountedViewProxy(viewProxy);\n\n  watch(\n    mounted,\n    (m) => {\n      if (m) callback();\n    },\n    { immediate: true }\n  );\n}\n\nexport function useViewProxyUnmounted<T extends vtkViewProxy = vtkViewProxy>(\n  viewProxy: MaybeRef<T>,\n  callback: () => void\n) {\n  const mounted = useMountedViewProxy(viewProxy);\n\n  watch(\n    mounted,\n    (m, prev) => {\n      if (prev && !m) callback();\n    },\n    { immediate: true }\n  );\n}\n","import vtkViewProxy from '@kitware/vtk.js/Proxy/Core/ViewProxy';\nimport vtkWidgetManager from '@kitware/vtk.js/Widgets/Core/WidgetManager';\nimport { CaptureOn } from '@kitware/vtk.js/Widgets/Core/WidgetManager/Constants';\nimport { computed, onUnmounted, Ref, watch } from 'vue';\nimport { useViewProxyMounted, useViewProxyUnmounted } from './useViewProxy';\n\nexport function useWidgetManager(viewProxy: Ref<vtkViewProxy>) {\n  const widgetManager = computed(() => {\n    const wm = vtkWidgetManager.newInstance({\n      pickingEnabled: false,\n      useSvgLayer: false,\n      captureOn: CaptureOn.MOUSE_MOVE,\n    });\n    return wm;\n  });\n\n  useViewProxyMounted(viewProxy, () => {\n    widgetManager.value.setRenderer(viewProxy.value.getRenderer());\n    widgetManager.value.enablePicking();\n  });\n\n  useViewProxyUnmounted(viewProxy, () => {\n    widgetManager.value.disablePicking();\n  });\n\n  watch(widgetManager, (curWM, oldWM) => {\n    if (curWM) {\n      curWM.setRenderer(viewProxy.value.getRenderer());\n      curWM.enablePicking();\n    }\n    if (oldWM) {\n      oldWM.delete();\n    }\n  });\n\n  onUnmounted(() => {\n    widgetManager.value.delete();\n  });\n\n  return { widgetManager };\n}\n","import type { Vector3 } from '@kitware/vtk.js/types';\nimport { computed, unref } from 'vue';\nimport { MaybeRef } from '@vueuse/core';\nimport { getLPSAxisFromDir } from '../utils/lps';\nimport { useCurrentImage } from './useCurrentImage';\nimport useViewSliceStore from '../store/view-configs/slicing';\n\n/**\n * Returns information about the current slice.\n *\n * axisName: the name of the axis\n * axisIndex: corresponding index in an LPS coordinate array\n * number: slice value\n * planeNormal: slice plane normal\n * planeOrigin: slice plane origin\n * @param viewID\n */\nexport function useCurrentSlice(viewID: MaybeRef<string | null>) {\n  const viewSliceStore = useViewSliceStore();\n  const { currentImageMetadata, currentImageID } = useCurrentImage();\n  return computed(() => {\n    const config = viewSliceStore.getConfig(\n      unref(viewID),\n      currentImageID.value\n    );\n    if (!config) {\n      return null;\n    }\n\n    const { lpsOrientation } = currentImageMetadata.value;\n    const axis = getLPSAxisFromDir(config.axisDirection);\n    const planeOrigin = [0, 0, 0] as Vector3;\n    planeOrigin[lpsOrientation[axis]] = config.slice;\n    return {\n      axisName: axis,\n      axisIndex: lpsOrientation[axis],\n      number: config.slice,\n      planeNormal: lpsOrientation[config.axisDirection] as Vector3,\n      planeOrigin,\n    };\n  });\n}\n","import vtkOpenGLRenderWindow from '@kitware/vtk.js/Rendering/OpenGL/RenderWindow';\nimport vtkRenderer from '@kitware/vtk.js/Rendering/Core/Renderer';\nimport type { Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport { computed, ref, unref, watchEffect } from 'vue';\nimport { MaybeRef, useResizeObserver } from '@vueuse/core';\nimport { vec3 } from 'gl-matrix';\nimport { useVTKCallback } from './useVTKCallback';\nimport { computeWorldToDisplay } from '../utils/vtk-helpers';\n\ntype MaybeCoords = Vector3 | vec3 | null | undefined;\ntype MaybeMultiCoords = Vector3[] | vec3[] | null | undefined;\ntype MaybeRenderer = vtkRenderer | null | undefined;\n\n/**\n * Returns a reactive vtkOpenGLRenderWindow container ref.\n *\n * @param view\n * @returns\n */\nexport function useVTKViewContainer(\n  view: MaybeRef<vtkOpenGLRenderWindow | null | undefined>\n) {\n  const container = ref<HTMLElement | null>(null);\n\n  const update = () => {\n    container.value = unref(view)?.getContainer() ?? null;\n  };\n\n  const onModified = useVTKCallback(computed(() => unref(view)?.onModified));\n  onModified(update);\n  update();\n\n  return container;\n}\n\n/**\n * Transforms a list of world coordinates into display coordinates.\n *\n * @param worldCoords\n * @param renderer\n * @returns\n */\nexport function useVTKMultiWorldToDisplay(\n  worldCoords: MaybeRef<MaybeMultiCoords>,\n  renderer: MaybeRef<MaybeRenderer>\n) {\n  const displayCoords = ref<Vector2[]>([]);\n  const view = computed(\n    () =>\n      unref(renderer)\n        ?.getRenderWindow()\n        ?.getViews()?.[0] as vtkOpenGLRenderWindow\n  );\n  const container = useVTKViewContainer(view);\n\n  const update = () => {\n    const coords = unref(worldCoords);\n    const ren = unref(renderer);\n\n    if (coords == null || !ren) {\n      return;\n    }\n\n    displayCoords.value = coords.map((xyz) => {\n      const disp = computeWorldToDisplay(xyz as Vector3, ren)!;\n      // convert from canvas space to display space\n      return [\n        disp[0] / devicePixelRatio,\n        disp[1] / devicePixelRatio,\n      ] as Vector2;\n    }) as Vector2[];\n  };\n\n  const cameraOnModified = useVTKCallback(\n    computed(() => unref(renderer)?.getActiveCamera().onModified)\n  );\n\n  useResizeObserver(container, update);\n  watchEffect(update);\n  cameraOnModified(update);\n  update();\n\n  return displayCoords;\n}\n\n/**\n * Transforms a single world coordinate into a display coordinate.\n *\n * @param worldCoords\n * @param renderer\n * @returns\n */\nexport function useVTKWorldToDisplay(\n  worldCoords: MaybeRef<MaybeCoords>,\n  renderer: MaybeRef<MaybeRenderer>\n) {\n  const manyCoords = computed(() => {\n    const c = unref(worldCoords);\n    if (c != null) {\n      return [c];\n    }\n    return null;\n  });\n\n  const displayCoords = useVTKMultiWorldToDisplay(manyCoords, renderer);\n  return computed(() => {\n    if (displayCoords.value.length === 1) {\n      return displayCoords.value[0];\n    }\n    return null;\n  });\n}\n\n/**\n * Transforms a list of world coordinates into SVG coordinates.\n *\n * @param worldCoords\n * @param renderer\n * @returns\n */\nexport function useVTKMultiWorldToSVG(\n  worldCoords: MaybeRef<MaybeMultiCoords>,\n  renderer: MaybeRef<MaybeRenderer>\n) {\n  const displayCoords = useVTKMultiWorldToDisplay(worldCoords, renderer);\n  const svgCoords = computed(() => {\n    const disp = displayCoords.value;\n    const ren = unref(renderer);\n    const view = ren?.getRenderWindow()?.getViews()?.[0];\n    if (ren && view) {\n      const [, height] = view.getViewportSize(ren);\n      return disp.map((xy) => {\n        // flip Y axis\n        return [xy[0], height / devicePixelRatio - xy[1]];\n      });\n    }\n    return null;\n  });\n\n  return svgCoords;\n}\n","<script lang=\"ts\">\nimport { defineComponent, PropType, ref } from 'vue';\nimport { CropLine } from './types';\n\nexport default defineComponent({\n  props: {\n    line: {\n      required: true,\n      type: Object as PropType<CropLine<number[]>>,\n    },\n    clickWidth: {\n      default: 20,\n      type: Number,\n    },\n    outOfBounds: {\n      default: false,\n      type: Boolean,\n    },\n  },\n  setup() {\n    const cursor = ref('grab');\n    const grabLineEl = ref<Element | null>(null);\n    const focusWidth = ref(0);\n\n    const onPointer = (down: boolean, ev: PointerEvent) => {\n      if (down) {\n        grabLineEl.value?.setPointerCapture(ev.pointerId);\n      } else {\n        grabLineEl.value?.releasePointerCapture(ev.pointerId);\n      }\n      cursor.value = down ? 'grabbing' : 'grab';\n    };\n\n    const onHover = (hover: boolean) => {\n      focusWidth.value = hover ? 2 : 0;\n    };\n\n    return {\n      onPointer,\n      onHover,\n      cursor,\n      grabLineEl,\n      focusWidth,\n    };\n  },\n});\n</script>\n\n<template>\n  <g>\n    <line\n      :x1=\"line.startEdge[0]\"\n      :y1=\"line.startEdge[1]\"\n      :x2=\"line.startCrop[0]\"\n      :y2=\"line.startCrop[1]\"\n      :stroke-width=\"2 + focusWidth\"\n      stroke-dasharray=\"6\"\n      stroke-linecap=\"square\"\n      stroke=\"rgba(200, 255, 0, 0.5)\"\n    />\n    <line\n      :x1=\"line.startCrop[0]\"\n      :y1=\"line.startCrop[1]\"\n      :x2=\"line.endCrop[0]\"\n      :y2=\"line.endCrop[1]\"\n      :stroke-width=\"2 + focusWidth\"\n      :stroke-dasharray=\"outOfBounds ? 6 : 'none'\"\n      stroke-linecap=\"butt\"\n      stroke=\"rgb(200, 255, 0)\"\n    />\n    <line\n      :x1=\"line.endCrop[0]\"\n      :y1=\"line.endCrop[1]\"\n      :x2=\"line.endEdge[0]\"\n      :y2=\"line.endEdge[1]\"\n      :stroke-width=\"2 + focusWidth\"\n      stroke-dasharray=\"6\"\n      stroke-linecap=\"square\"\n      stroke=\"rgba(200, 255, 0, 0.5)\"\n    />\n    <!-- the listener hitbox -->\n    <line\n      ref=\"grabLineEl\"\n      class=\"pointer-events-all\"\n      :style=\"{ cursor }\"\n      @pointerenter=\"onHover(true)\"\n      @pointerleave=\"onHover(false)\"\n      @pointerdown=\"onPointer(true, $event)\"\n      @pointerup=\"onPointer(false, $event)\"\n      :x1=\"line.startEdge[0]\"\n      :y1=\"line.startEdge[1]\"\n      :x2=\"line.endEdge[0]\"\n      :y2=\"line.endEdge[1]\"\n      fill=\"none\"\n      stroke-opacity=\"0\"\n      stroke-dasharray=\"none\"\n      :stroke-width=\"Number($attrs['stroke-width'] || 0) + clickWidth || 0\"\n      v-bind=\"$attrs\"\n    />\n  </g>\n</template>\n\n<style scoped src=\"@/src/components/styles/utils.css\"></style>\n","<script lang=\"ts\">\nimport { defineComponent, PropType, ref } from 'vue';\nimport { CropLine } from './types';\n\nexport default defineComponent({\n  props: {\n    line: {\n      required: true,\n      type: Object as PropType<CropLine<number[]>>,\n    },\n    clickWidth: {\n      default: 20,\n      type: Number,\n    },\n    outOfBounds: {\n      default: false,\n      type: Boolean,\n    },\n  },\n  setup() {\n    const cursor = ref('grab');\n    const grabLineEl = ref<Element | null>(null);\n    const focusWidth = ref(0);\n\n    const onPointer = (down: boolean, ev: PointerEvent) => {\n      if (down) {\n        grabLineEl.value?.setPointerCapture(ev.pointerId);\n      } else {\n        grabLineEl.value?.releasePointerCapture(ev.pointerId);\n      }\n      cursor.value = down ? 'grabbing' : 'grab';\n    };\n\n    const onHover = (hover: boolean) => {\n      focusWidth.value = hover ? 2 : 0;\n    };\n\n    return {\n      onPointer,\n      onHover,\n      cursor,\n      grabLineEl,\n      focusWidth,\n    };\n  },\n});\n</script>\n\n<template>\n  <g>\n    <line\n      :x1=\"line.startEdge[0]\"\n      :y1=\"line.startEdge[1]\"\n      :x2=\"line.startCrop[0]\"\n      :y2=\"line.startCrop[1]\"\n      :stroke-width=\"2 + focusWidth\"\n      stroke-dasharray=\"6\"\n      stroke-linecap=\"square\"\n      stroke=\"rgba(200, 255, 0, 0.5)\"\n    />\n    <line\n      :x1=\"line.startCrop[0]\"\n      :y1=\"line.startCrop[1]\"\n      :x2=\"line.endCrop[0]\"\n      :y2=\"line.endCrop[1]\"\n      :stroke-width=\"2 + focusWidth\"\n      :stroke-dasharray=\"outOfBounds ? 6 : 'none'\"\n      stroke-linecap=\"butt\"\n      stroke=\"rgb(200, 255, 0)\"\n    />\n    <line\n      :x1=\"line.endCrop[0]\"\n      :y1=\"line.endCrop[1]\"\n      :x2=\"line.endEdge[0]\"\n      :y2=\"line.endEdge[1]\"\n      :stroke-width=\"2 + focusWidth\"\n      stroke-dasharray=\"6\"\n      stroke-linecap=\"square\"\n      stroke=\"rgba(200, 255, 0, 0.5)\"\n    />\n    <!-- the listener hitbox -->\n    <line\n      ref=\"grabLineEl\"\n      class=\"pointer-events-all\"\n      :style=\"{ cursor }\"\n      @pointerenter=\"onHover(true)\"\n      @pointerleave=\"onHover(false)\"\n      @pointerdown=\"onPointer(true, $event)\"\n      @pointerup=\"onPointer(false, $event)\"\n      :x1=\"line.startEdge[0]\"\n      :y1=\"line.startEdge[1]\"\n      :x2=\"line.endEdge[0]\"\n      :y2=\"line.endEdge[1]\"\n      fill=\"none\"\n      stroke-opacity=\"0\"\n      stroke-dasharray=\"none\"\n      :stroke-width=\"Number($attrs['stroke-width'] || 0) + clickWidth || 0\"\n      v-bind=\"$attrs\"\n    />\n  </g>\n</template>\n\n<style scoped src=\"@/src/components/styles/utils.css\"></style>\n","<script lang=\"ts\">\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useCurrentSlice } from '@/src/composables/useCurrentSlice';\nimport { useVTKMultiWorldToSVG } from '@/src/composables/useVTKWorldToDisplay';\nimport { ImageMetadata } from '@/src/types/image';\nimport { useCropStore } from '@/src/store/tools/crop';\nimport { useViewStore } from '@/src/store/views';\nimport { LPSAxis, LPSBounds, LPSPoint } from '@/src/types/lps';\nimport { createLPSBounds, createLPSPoint, LPSAxes } from '@/src/utils/lps';\nimport { intersectMouseEventWithPlane } from '@/src/utils/vtk-helpers';\nimport vtkLPSView2DProxy from '@/src/vtk/LPSView2DProxy';\nimport vtkRenderer from '@kitware/vtk.js/Rendering/Core/Renderer';\nimport type { Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport {\n  computed,\n  ComputedRef,\n  DeepReadonly,\n  defineComponent,\n  ref,\n  Ref,\n  toRefs,\n} from 'vue';\nimport { vec3 } from 'gl-matrix';\nimport Crop2DLineHandle from './Crop2DLineHandle.vue';\nimport { CropLines } from './types';\n\nfunction computeCropLines(\n  viewID: Ref<string | null>,\n  cropAxis: Ref<LPSAxis | null>,\n  cropPlanes: DeepReadonly<Ref<Record<LPSAxis, number[]>>>,\n  boundary: Ref<Record<LPSAxis, number[]>>\n): ComputedRef<CropLines<LPSPoint> | null> {\n  const currentSlice = useCurrentSlice(viewID);\n\n  return computed(() => {\n    // pre-check reactivity\n    const viewIDVal = viewID.value;\n    const cropAxisVal = cropAxis.value;\n    const cropPlanesVal = cropPlanes.value;\n    const boundaryVal = boundary.value;\n    const sliceInfo = currentSlice.value;\n\n    if (!viewIDVal || !cropAxisVal || !sliceInfo) {\n      return null;\n    }\n\n    const sliceAxis = sliceInfo.axisName;\n    const [perpAxis] = LPSAxes.filter(\n      (ax) => ax !== cropAxisVal && ax !== sliceAxis\n    );\n    const cropRange = cropPlanesVal[cropAxisVal];\n    const perpRange = cropPlanesVal[perpAxis];\n    const perpBoundary = boundaryVal[perpAxis];\n\n    const sliceCropRange = cropPlanesVal[sliceAxis];\n    const slice = sliceInfo.number;\n    const outOfBounds = slice < sliceCropRange[0] || sliceCropRange[1] < slice;\n\n    const getLineSegments = (index: number) => {\n      const startEdge = createLPSPoint();\n      const startCrop = createLPSPoint();\n      const endCrop = createLPSPoint();\n      const endEdge = createLPSPoint();\n\n      startEdge[cropAxisVal] = cropRange[index];\n      startCrop[cropAxisVal] = cropRange[index];\n      endCrop[cropAxisVal] = cropRange[index];\n      endEdge[cropAxisVal] = cropRange[index];\n\n      [startEdge[perpAxis], endEdge[perpAxis]] = perpBoundary;\n      [startCrop[perpAxis], endCrop[perpAxis]] = perpRange;\n\n      return { startEdge, startCrop, endCrop, endEdge };\n    };\n\n    return {\n      lowerLine: getLineSegments(0),\n      upperLine: getLineSegments(1),\n      outOfBounds,\n    };\n  });\n}\n\nfunction cropLinesToSVGDisplay(\n  cropLines: Ref<CropLines<LPSPoint> | null>,\n  imageMetadata: Ref<ImageMetadata>,\n  renderer: Ref<vtkRenderer>\n): ComputedRef<CropLines<number[]> | null> {\n  // gather points\n  const worldPoints = computed(() => {\n    const lines = cropLines.value;\n    const { lpsOrientation, indexToWorld } = imageMetadata.value;\n    if (!lines) {\n      return null;\n    }\n    return [\n      lines.lowerLine.startEdge,\n      lines.lowerLine.startCrop,\n      lines.lowerLine.endCrop,\n      lines.lowerLine.endEdge,\n      lines.upperLine.startEdge,\n      lines.upperLine.startCrop,\n      lines.upperLine.endCrop,\n      lines.upperLine.endEdge,\n    ].map((indexLPSPoint) => {\n      const indexPt = [0, 0, 0] as vec3;\n      indexPt[lpsOrientation.Sagittal] = indexLPSPoint.Sagittal;\n      indexPt[lpsOrientation.Coronal] = indexLPSPoint.Coronal;\n      indexPt[lpsOrientation.Axial] = indexLPSPoint.Axial;\n\n      const out = [0, 0, 0] as vec3;\n      vec3.transformMat4(out, indexPt, indexToWorld);\n      return out as Vector3;\n    });\n  });\n\n  // transform points to svg\n  const svgPoints = useVTKMultiWorldToSVG(worldPoints, renderer);\n\n  // create a new CropLines with SVG points\n  return computed(() => {\n    const lines = cropLines.value;\n    const points = svgPoints.value;\n    if (!lines || !points?.length) {\n      return null;\n    }\n\n    return {\n      lowerLine: {\n        startEdge: points[0],\n        startCrop: points[1],\n        endCrop: points[2],\n        endEdge: points[3],\n      },\n      upperLine: {\n        startEdge: points[4],\n        startCrop: points[5],\n        endCrop: points[6],\n        endEdge: points[7],\n      },\n      outOfBounds: lines.outOfBounds,\n    };\n  });\n}\n\nfunction useDragging({\n  mouseEventToLPSPoint,\n  getCropEdgePos,\n  setCropEdgePos,\n}: {\n  mouseEventToLPSPoint: (ev: PointerEvent) => LPSPoint | null;\n  getCropEdgePos: (axis: LPSAxis, lowerUpper: 0 | 1) => number;\n  setCropEdgePos: (axis: LPSAxis, lowerUpper: 0 | 1, pos: number) => void;\n}) {\n  const activeAxis = ref<LPSAxis | null>();\n  const activeEdge = ref<0 | 1 | null>();\n  const initialPointerIndex = ref<LPSPoint>(createLPSPoint());\n  const initialCrop = ref<number>(0);\n\n  const onPointerDown = (\n    ax: LPSAxis,\n    selectedCropEdge: 0 | 1,\n    ev: PointerEvent\n  ) => {\n    // ev -> world -> index -> LPSPoint -> save as starting index\n    // save the starting axis edge value\n    const initialPoint = mouseEventToLPSPoint(ev);\n    if (!initialPoint) return;\n\n    initialPointerIndex.value = initialPoint;\n    initialCrop.value = getCropEdgePos(ax, selectedCropEdge);\n    activeAxis.value = ax;\n    activeEdge.value = selectedCropEdge;\n  };\n\n  const onPointerMove = (ev: PointerEvent) => {\n    if (activeAxis.value == null || activeEdge.value == null) {\n      return;\n    }\n    const axis = activeAxis.value;\n\n    const point = mouseEventToLPSPoint(ev);\n    if (!point) return;\n\n    // calc delta along ax from starting pos via startingIndex\n    // apply delta to starting axis edge value\n    const delta = point[axis] - initialPointerIndex.value[axis];\n    setCropEdgePos(axis, activeEdge.value, initialCrop.value + delta);\n  };\n\n  const onPointerUp = () => {\n    activeAxis.value = null;\n    activeEdge.value = null;\n  };\n\n  return {\n    onPointerDown,\n    onPointerMove,\n    onPointerUp,\n  };\n}\n\nexport default defineComponent({\n  props: {\n    viewId: {\n      required: true,\n      type: String,\n    },\n  },\n  components: {\n    Crop2DLineHandle,\n  },\n  setup(props) {\n    const { viewId: viewID } = toRefs(props);\n\n    const viewStore = useViewStore();\n    const viewProxy = computed(\n      () => viewStore.getViewProxy<vtkLPSView2DProxy>(viewID.value)!\n    );\n    const renderer = computed(() => viewProxy.value?.getRenderer());\n\n    const {\n      currentImageExtent: imageExtent,\n      currentImageID,\n      currentImageMetadata,\n    } = useCurrentImage();\n    const currentSlice = useCurrentSlice(viewID);\n    const currentSlicingAxis = computed(\n      () => currentSlice.value?.axisName ?? null\n    );\n\n    const cropStore = useCropStore();\n    const cropPlanes = computed((): DeepReadonly<LPSBounds> => {\n      const imageID = currentImageID.value;\n      if (imageID && imageID in cropStore.croppingByImageID) {\n        return cropStore.croppingByImageID[imageID];\n      }\n      return createLPSBounds();\n    });\n\n    const inPlaneAxes = computed(() =>\n      LPSAxes.filter(\n        (ax) => currentSlicingAxis.value && ax !== currentSlicingAxis.value\n      )\n    );\n    const ax1 = computed(() => inPlaneAxes.value[0] ?? null);\n    const ax2 = computed(() => inPlaneAxes.value[1] ?? null);\n\n    // crop lines in image space\n    const ax1Lines = computeCropLines(viewID, ax1, cropPlanes, imageExtent);\n    const ax2Lines = computeCropLines(viewID, ax2, cropPlanes, imageExtent);\n\n    // crop lines in display space\n    const ax1SVGLines = cropLinesToSVGDisplay(\n      ax1Lines,\n      currentImageMetadata,\n      renderer\n    );\n    const ax2SVGLines = cropLinesToSVGDisplay(\n      ax2Lines,\n      currentImageMetadata,\n      renderer\n    );\n\n    const { onPointerDown, onPointerMove, onPointerUp } = useDragging({\n      mouseEventToLPSPoint(ev: PointerEvent) {\n        const ren = renderer.value;\n        if (!ren) return null;\n\n        const sliceInfo = currentSlice.value;\n        if (!sliceInfo) return null;\n\n        const { lpsOrientation, worldToIndex } = currentImageMetadata.value;\n        const coord = intersectMouseEventWithPlane(\n          ev,\n          ren,\n          sliceInfo.planeOrigin,\n          sliceInfo.planeNormal\n        );\n        if (!coord) return null;\n\n        // convert from world to index\n        vec3.transformMat4(coord, coord, worldToIndex);\n\n        const point = createLPSPoint();\n        point.Sagittal = coord[lpsOrientation.Sagittal];\n        point.Coronal = coord[lpsOrientation.Coronal];\n        point.Axial = coord[lpsOrientation.Axial];\n\n        return point;\n      },\n      getCropEdgePos(axis: LPSAxis, lowerUpper: 0 | 1) {\n        return cropPlanes.value[axis][lowerUpper];\n      },\n      setCropEdgePos(axis: LPSAxis, lowerUpper: 0 | 1, pos: number) {\n        if (!currentImageID.value) return;\n\n        // enforce cropping edge bounds\n        const planes = cropPlanes.value;\n        const [lower, upper] = planes[axis];\n        const [min, max] = imageExtent.value[axis];\n        const newPlanes: Vector2 = [lower, upper];\n        if (lowerUpper === 0) {\n          newPlanes[0] = Math.max(min, Math.min(pos, upper));\n        } else if (lowerUpper === 1) {\n          newPlanes[1] = Math.max(lower, Math.min(pos, max));\n        }\n\n        cropStore.setCroppingForAxis(currentImageID.value, axis, newPlanes);\n      },\n    });\n\n    return {\n      ax1: computed(() => ({\n        name: ax1.value,\n        lines: ax1SVGLines.value,\n      })),\n      ax2: computed(() => ({\n        name: ax2.value,\n        lines: ax2SVGLines.value,\n      })),\n      onPointerDown,\n      onPointerMove,\n      onPointerUp,\n    };\n  },\n});\n</script>\n\n<template>\n  <g>\n    <template v-if=\"ax1.lines != null\">\n      <crop-2D-line-handle\n        :line=\"ax1.lines.lowerLine\"\n        :out-of-bounds=\"ax1.lines.outOfBounds\"\n        @pointerdown=\"onPointerDown(ax1.name, 0, $event)\"\n        @pointermove=\"onPointerMove\"\n        @pointerup=\"onPointerUp\"\n      />\n      <crop-2D-line-handle\n        :line=\"ax1.lines.upperLine\"\n        :out-of-bounds=\"ax1.lines.outOfBounds\"\n        @pointerdown=\"onPointerDown(ax1.name, 1, $event)\"\n        @pointermove=\"onPointerMove\"\n        @pointerup=\"onPointerUp\"\n      />\n    </template>\n    <template v-if=\"ax2.lines != null\">\n      <crop-2D-line-handle\n        :line=\"ax2.lines.lowerLine\"\n        :out-of-bounds=\"ax2.lines.outOfBounds\"\n        @pointerdown=\"onPointerDown(ax2.name, 0, $event)\"\n        @pointermove=\"onPointerMove\"\n        @pointerup=\"onPointerUp\"\n      />\n      <crop-2D-line-handle\n        :line=\"ax2.lines.upperLine\"\n        :out-of-bounds=\"ax2.lines.outOfBounds\"\n        @pointerdown=\"onPointerDown(ax2.name, 1, $event)\"\n        @pointermove=\"onPointerMove\"\n        @pointerup=\"onPointerUp\"\n      />\n    </template>\n  </g>\n</template>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","<script lang=\"ts\">\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useCurrentSlice } from '@/src/composables/useCurrentSlice';\nimport { useVTKMultiWorldToSVG } from '@/src/composables/useVTKWorldToDisplay';\nimport { ImageMetadata } from '@/src/types/image';\nimport { useCropStore } from '@/src/store/tools/crop';\nimport { useViewStore } from '@/src/store/views';\nimport { LPSAxis, LPSBounds, LPSPoint } from '@/src/types/lps';\nimport { createLPSBounds, createLPSPoint, LPSAxes } from '@/src/utils/lps';\nimport { intersectMouseEventWithPlane } from '@/src/utils/vtk-helpers';\nimport vtkLPSView2DProxy from '@/src/vtk/LPSView2DProxy';\nimport vtkRenderer from '@kitware/vtk.js/Rendering/Core/Renderer';\nimport type { Vector2, Vector3 } from '@kitware/vtk.js/types';\nimport {\n  computed,\n  ComputedRef,\n  DeepReadonly,\n  defineComponent,\n  ref,\n  Ref,\n  toRefs,\n} from 'vue';\nimport { vec3 } from 'gl-matrix';\nimport Crop2DLineHandle from './Crop2DLineHandle.vue';\nimport { CropLines } from './types';\n\nfunction computeCropLines(\n  viewID: Ref<string | null>,\n  cropAxis: Ref<LPSAxis | null>,\n  cropPlanes: DeepReadonly<Ref<Record<LPSAxis, number[]>>>,\n  boundary: Ref<Record<LPSAxis, number[]>>\n): ComputedRef<CropLines<LPSPoint> | null> {\n  const currentSlice = useCurrentSlice(viewID);\n\n  return computed(() => {\n    // pre-check reactivity\n    const viewIDVal = viewID.value;\n    const cropAxisVal = cropAxis.value;\n    const cropPlanesVal = cropPlanes.value;\n    const boundaryVal = boundary.value;\n    const sliceInfo = currentSlice.value;\n\n    if (!viewIDVal || !cropAxisVal || !sliceInfo) {\n      return null;\n    }\n\n    const sliceAxis = sliceInfo.axisName;\n    const [perpAxis] = LPSAxes.filter(\n      (ax) => ax !== cropAxisVal && ax !== sliceAxis\n    );\n    const cropRange = cropPlanesVal[cropAxisVal];\n    const perpRange = cropPlanesVal[perpAxis];\n    const perpBoundary = boundaryVal[perpAxis];\n\n    const sliceCropRange = cropPlanesVal[sliceAxis];\n    const slice = sliceInfo.number;\n    const outOfBounds = slice < sliceCropRange[0] || sliceCropRange[1] < slice;\n\n    const getLineSegments = (index: number) => {\n      const startEdge = createLPSPoint();\n      const startCrop = createLPSPoint();\n      const endCrop = createLPSPoint();\n      const endEdge = createLPSPoint();\n\n      startEdge[cropAxisVal] = cropRange[index];\n      startCrop[cropAxisVal] = cropRange[index];\n      endCrop[cropAxisVal] = cropRange[index];\n      endEdge[cropAxisVal] = cropRange[index];\n\n      [startEdge[perpAxis], endEdge[perpAxis]] = perpBoundary;\n      [startCrop[perpAxis], endCrop[perpAxis]] = perpRange;\n\n      return { startEdge, startCrop, endCrop, endEdge };\n    };\n\n    return {\n      lowerLine: getLineSegments(0),\n      upperLine: getLineSegments(1),\n      outOfBounds,\n    };\n  });\n}\n\nfunction cropLinesToSVGDisplay(\n  cropLines: Ref<CropLines<LPSPoint> | null>,\n  imageMetadata: Ref<ImageMetadata>,\n  renderer: Ref<vtkRenderer>\n): ComputedRef<CropLines<number[]> | null> {\n  // gather points\n  const worldPoints = computed(() => {\n    const lines = cropLines.value;\n    const { lpsOrientation, indexToWorld } = imageMetadata.value;\n    if (!lines) {\n      return null;\n    }\n    return [\n      lines.lowerLine.startEdge,\n      lines.lowerLine.startCrop,\n      lines.lowerLine.endCrop,\n      lines.lowerLine.endEdge,\n      lines.upperLine.startEdge,\n      lines.upperLine.startCrop,\n      lines.upperLine.endCrop,\n      lines.upperLine.endEdge,\n    ].map((indexLPSPoint) => {\n      const indexPt = [0, 0, 0] as vec3;\n      indexPt[lpsOrientation.Sagittal] = indexLPSPoint.Sagittal;\n      indexPt[lpsOrientation.Coronal] = indexLPSPoint.Coronal;\n      indexPt[lpsOrientation.Axial] = indexLPSPoint.Axial;\n\n      const out = [0, 0, 0] as vec3;\n      vec3.transformMat4(out, indexPt, indexToWorld);\n      return out as Vector3;\n    });\n  });\n\n  // transform points to svg\n  const svgPoints = useVTKMultiWorldToSVG(worldPoints, renderer);\n\n  // create a new CropLines with SVG points\n  return computed(() => {\n    const lines = cropLines.value;\n    const points = svgPoints.value;\n    if (!lines || !points?.length) {\n      return null;\n    }\n\n    return {\n      lowerLine: {\n        startEdge: points[0],\n        startCrop: points[1],\n        endCrop: points[2],\n        endEdge: points[3],\n      },\n      upperLine: {\n        startEdge: points[4],\n        startCrop: points[5],\n        endCrop: points[6],\n        endEdge: points[7],\n      },\n      outOfBounds: lines.outOfBounds,\n    };\n  });\n}\n\nfunction useDragging({\n  mouseEventToLPSPoint,\n  getCropEdgePos,\n  setCropEdgePos,\n}: {\n  mouseEventToLPSPoint: (ev: PointerEvent) => LPSPoint | null;\n  getCropEdgePos: (axis: LPSAxis, lowerUpper: 0 | 1) => number;\n  setCropEdgePos: (axis: LPSAxis, lowerUpper: 0 | 1, pos: number) => void;\n}) {\n  const activeAxis = ref<LPSAxis | null>();\n  const activeEdge = ref<0 | 1 | null>();\n  const initialPointerIndex = ref<LPSPoint>(createLPSPoint());\n  const initialCrop = ref<number>(0);\n\n  const onPointerDown = (\n    ax: LPSAxis,\n    selectedCropEdge: 0 | 1,\n    ev: PointerEvent\n  ) => {\n    // ev -> world -> index -> LPSPoint -> save as starting index\n    // save the starting axis edge value\n    const initialPoint = mouseEventToLPSPoint(ev);\n    if (!initialPoint) return;\n\n    initialPointerIndex.value = initialPoint;\n    initialCrop.value = getCropEdgePos(ax, selectedCropEdge);\n    activeAxis.value = ax;\n    activeEdge.value = selectedCropEdge;\n  };\n\n  const onPointerMove = (ev: PointerEvent) => {\n    if (activeAxis.value == null || activeEdge.value == null) {\n      return;\n    }\n    const axis = activeAxis.value;\n\n    const point = mouseEventToLPSPoint(ev);\n    if (!point) return;\n\n    // calc delta along ax from starting pos via startingIndex\n    // apply delta to starting axis edge value\n    const delta = point[axis] - initialPointerIndex.value[axis];\n    setCropEdgePos(axis, activeEdge.value, initialCrop.value + delta);\n  };\n\n  const onPointerUp = () => {\n    activeAxis.value = null;\n    activeEdge.value = null;\n  };\n\n  return {\n    onPointerDown,\n    onPointerMove,\n    onPointerUp,\n  };\n}\n\nexport default defineComponent({\n  props: {\n    viewId: {\n      required: true,\n      type: String,\n    },\n  },\n  components: {\n    Crop2DLineHandle,\n  },\n  setup(props) {\n    const { viewId: viewID } = toRefs(props);\n\n    const viewStore = useViewStore();\n    const viewProxy = computed(\n      () => viewStore.getViewProxy<vtkLPSView2DProxy>(viewID.value)!\n    );\n    const renderer = computed(() => viewProxy.value?.getRenderer());\n\n    const {\n      currentImageExtent: imageExtent,\n      currentImageID,\n      currentImageMetadata,\n    } = useCurrentImage();\n    const currentSlice = useCurrentSlice(viewID);\n    const currentSlicingAxis = computed(\n      () => currentSlice.value?.axisName ?? null\n    );\n\n    const cropStore = useCropStore();\n    const cropPlanes = computed((): DeepReadonly<LPSBounds> => {\n      const imageID = currentImageID.value;\n      if (imageID && imageID in cropStore.croppingByImageID) {\n        return cropStore.croppingByImageID[imageID];\n      }\n      return createLPSBounds();\n    });\n\n    const inPlaneAxes = computed(() =>\n      LPSAxes.filter(\n        (ax) => currentSlicingAxis.value && ax !== currentSlicingAxis.value\n      )\n    );\n    const ax1 = computed(() => inPlaneAxes.value[0] ?? null);\n    const ax2 = computed(() => inPlaneAxes.value[1] ?? null);\n\n    // crop lines in image space\n    const ax1Lines = computeCropLines(viewID, ax1, cropPlanes, imageExtent);\n    const ax2Lines = computeCropLines(viewID, ax2, cropPlanes, imageExtent);\n\n    // crop lines in display space\n    const ax1SVGLines = cropLinesToSVGDisplay(\n      ax1Lines,\n      currentImageMetadata,\n      renderer\n    );\n    const ax2SVGLines = cropLinesToSVGDisplay(\n      ax2Lines,\n      currentImageMetadata,\n      renderer\n    );\n\n    const { onPointerDown, onPointerMove, onPointerUp } = useDragging({\n      mouseEventToLPSPoint(ev: PointerEvent) {\n        const ren = renderer.value;\n        if (!ren) return null;\n\n        const sliceInfo = currentSlice.value;\n        if (!sliceInfo) return null;\n\n        const { lpsOrientation, worldToIndex } = currentImageMetadata.value;\n        const coord = intersectMouseEventWithPlane(\n          ev,\n          ren,\n          sliceInfo.planeOrigin,\n          sliceInfo.planeNormal\n        );\n        if (!coord) return null;\n\n        // convert from world to index\n        vec3.transformMat4(coord, coord, worldToIndex);\n\n        const point = createLPSPoint();\n        point.Sagittal = coord[lpsOrientation.Sagittal];\n        point.Coronal = coord[lpsOrientation.Coronal];\n        point.Axial = coord[lpsOrientation.Axial];\n\n        return point;\n      },\n      getCropEdgePos(axis: LPSAxis, lowerUpper: 0 | 1) {\n        return cropPlanes.value[axis][lowerUpper];\n      },\n      setCropEdgePos(axis: LPSAxis, lowerUpper: 0 | 1, pos: number) {\n        if (!currentImageID.value) return;\n\n        // enforce cropping edge bounds\n        const planes = cropPlanes.value;\n        const [lower, upper] = planes[axis];\n        const [min, max] = imageExtent.value[axis];\n        const newPlanes: Vector2 = [lower, upper];\n        if (lowerUpper === 0) {\n          newPlanes[0] = Math.max(min, Math.min(pos, upper));\n        } else if (lowerUpper === 1) {\n          newPlanes[1] = Math.max(lower, Math.min(pos, max));\n        }\n\n        cropStore.setCroppingForAxis(currentImageID.value, axis, newPlanes);\n      },\n    });\n\n    return {\n      ax1: computed(() => ({\n        name: ax1.value,\n        lines: ax1SVGLines.value,\n      })),\n      ax2: computed(() => ({\n        name: ax2.value,\n        lines: ax2SVGLines.value,\n      })),\n      onPointerDown,\n      onPointerMove,\n      onPointerUp,\n    };\n  },\n});\n</script>\n\n<template>\n  <g>\n    <template v-if=\"ax1.lines != null\">\n      <crop-2D-line-handle\n        :line=\"ax1.lines.lowerLine\"\n        :out-of-bounds=\"ax1.lines.outOfBounds\"\n        @pointerdown=\"onPointerDown(ax1.name, 0, $event)\"\n        @pointermove=\"onPointerMove\"\n        @pointerup=\"onPointerUp\"\n      />\n      <crop-2D-line-handle\n        :line=\"ax1.lines.upperLine\"\n        :out-of-bounds=\"ax1.lines.outOfBounds\"\n        @pointerdown=\"onPointerDown(ax1.name, 1, $event)\"\n        @pointermove=\"onPointerMove\"\n        @pointerup=\"onPointerUp\"\n      />\n    </template>\n    <template v-if=\"ax2.lines != null\">\n      <crop-2D-line-handle\n        :line=\"ax2.lines.lowerLine\"\n        :out-of-bounds=\"ax2.lines.outOfBounds\"\n        @pointerdown=\"onPointerDown(ax2.name, 0, $event)\"\n        @pointermove=\"onPointerMove\"\n        @pointerup=\"onPointerUp\"\n      />\n      <crop-2D-line-handle\n        :line=\"ax2.lines.upperLine\"\n        :out-of-bounds=\"ax2.lines.outOfBounds\"\n        @pointerdown=\"onPointerDown(ax2.name, 1, $event)\"\n        @pointermove=\"onPointerMove\"\n        @pointerup=\"onPointerUp\"\n      />\n    </template>\n  </g>\n</template>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","<script lang=\"ts\">\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useVTKCallback } from '@/src/composables/useVTKCallback';\nimport { VTKThreeViewWidgetManager } from '@/src/constants';\nimport { useCropStore } from '@/src/store/tools/crop';\nimport { LPSCroppingPlanes } from '@/src/types/crop';\nimport { useViewStore } from '@/src/store/views';\nimport { arrayEquals } from '@/src/utils';\nimport { getAxisBounds, LPSAxes } from '@/src/utils/lps';\nimport vtkLPSView3DProxy from '@/src/vtk/LPSView3DProxy';\nimport type { Bounds } from '@kitware/vtk.js/types';\nimport vtkImageCroppingWidget, {\n  ImageCroppingWidgetState,\n  vtkImageCroppingViewWidget,\n} from '@kitware/vtk.js/Widgets/Widgets3D/ImageCroppingWidget';\nimport {\n  computed,\n  DeepReadonly,\n  defineComponent,\n  inject,\n  onBeforeUnmount,\n  ref,\n  toRefs,\n  watch,\n} from 'vue';\nimport { useViewProxyMounted } from '@/src/composables/useViewProxy';\n\nfunction isValidCroppingPlanes(planes: LPSCroppingPlanes) {\n  return (\n    planes.Sagittal[0] <= planes.Sagittal[1] &&\n    planes.Coronal[0] <= planes.Coronal[1] &&\n    planes.Axial[0] <= planes.Axial[1]\n  );\n}\n\nfunction lpsPlanesEqual(a: LPSCroppingPlanes, b: LPSCroppingPlanes) {\n  return (\n    a.Axial[0] === b.Axial[0] &&\n    a.Axial[1] === b.Axial[1] &&\n    a.Sagittal[0] === b.Sagittal[0] &&\n    a.Sagittal[1] === b.Sagittal[1] &&\n    a.Coronal[0] === b.Coronal[0] &&\n    a.Coronal[1] === b.Coronal[1]\n  );\n}\n\nexport default defineComponent({\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n  },\n\n  setup(props) {\n    const { viewId: viewID } = toRefs(props);\n\n    const widgetManager = inject(VTKThreeViewWidgetManager);\n    if (!widgetManager) {\n      throw new Error('Crop3D component cannot access the 2D widget manager.');\n    }\n\n    const viewStore = useViewStore();\n    const viewProxy = computed(\n      () => viewStore.getViewProxy<vtkLPSView3DProxy>(viewID.value)!\n    );\n\n    const cropStore = useCropStore();\n    const { currentImageID, currentImageMetadata } = useCurrentImage();\n    const croppingPlanes = computed(() => {\n      const imageID = currentImageID.value;\n      if (imageID && imageID in cropStore.croppingByImageID) {\n        return cropStore.croppingByImageID[imageID];\n      }\n      return null;\n    });\n\n    const factory = vtkImageCroppingWidget.newInstance();\n    const state = factory.getWidgetState() as ImageCroppingWidgetState;\n\n    factory.setEdgeHandlesEnabled(false);\n    factory.setFaceHandlesEnabled(true);\n    factory.setCornerHandlesEnabled(true);\n\n    const widget = ref<vtkImageCroppingViewWidget>();\n\n    watch(widgetManager, (wm, oldWm) => {\n      if (oldWm) {\n        oldWm.removeWidget(factory);\n      }\n      if (wm) {\n        widget.value = wm.addWidget(factory) as vtkImageCroppingViewWidget;\n      }\n    });\n\n    useViewProxyMounted(viewProxy, () => {\n      if (widgetManager.value) {\n        widget.value = widgetManager.value.addWidget(\n          factory\n        ) as vtkImageCroppingViewWidget;\n\n        // update representation to not be as 3D\n        widget.value.getRepresentations().forEach((rep) => {\n          rep.getActors().forEach((actor) => {\n            actor.getProperty().setAmbient(1);\n          });\n        });\n\n        // show widget\n        viewProxy.value.renderLater();\n      }\n    });\n\n    onBeforeUnmount(() => {\n      if (widgetManager.value) {\n        widgetManager.value.removeWidget(factory);\n      }\n    });\n\n    watch(\n      currentImageMetadata,\n      (metadata) => {\n        state.setWorldToIndexT(metadata.worldToIndex);\n        state.setIndexToWorldT(metadata.indexToWorld);\n        state.placeWidget(metadata.worldBounds);\n      },\n      { immediate: true }\n    );\n\n    const applyPlanes = (lpsPlanes: DeepReadonly<LPSCroppingPlanes>) => {\n      const { lpsOrientation: dirs } = currentImageMetadata.value;\n      // LPSCroppingPlanes -> Bounds\n      const planes = [0, 0, 0, 0, 0, 0] as Bounds;\n      LPSAxes.forEach((axis) => {\n        [planes[dirs[axis] * 2], planes[dirs[axis] * 2 + 1]] = lpsPlanes[axis];\n      });\n\n      // prevent infinite loops\n      if (!arrayEquals(planes, state.getCroppingPlanes().getPlanes())) {\n        state.getCroppingPlanes().setPlanes(planes);\n        viewProxy.value.renderLater();\n      }\n    };\n\n    watch(\n      croppingPlanes,\n      (lpsPlanes) => {\n        if (lpsPlanes) {\n          applyPlanes(lpsPlanes);\n        }\n      },\n      { immediate: true }\n    );\n\n    const onPlanesUpdated = useVTKCallback(\n      state.getCroppingPlanes().onModified\n    );\n\n    onPlanesUpdated(() => {\n      const imageID = currentImageID.value;\n      if (!imageID) return;\n\n      // Bounds -> LPSCroppingPlanes\n      const planes = state.getCroppingPlanes().getPlanes();\n      const { lpsOrientation } = currentImageMetadata.value;\n      const lpsPlanes: LPSCroppingPlanes = {\n        Sagittal: getAxisBounds(planes, 'Sagittal', lpsOrientation),\n        Coronal: getAxisBounds(planes, 'Coronal', lpsOrientation),\n        Axial: getAxisBounds(planes, 'Axial', lpsOrientation),\n      };\n\n      // avoid updates if equal\n      const planesFromStore = croppingPlanes.value;\n      if (\n        planesFromStore &&\n        lpsPlanesEqual(lpsPlanes, planesFromStore as LPSCroppingPlanes)\n      ) {\n        return;\n      }\n\n      if (isValidCroppingPlanes(lpsPlanes)) {\n        cropStore.setCropping(imageID, lpsPlanes);\n      } else if (planesFromStore) {\n        applyPlanes(planesFromStore);\n      }\n    });\n\n    return () => null;\n  },\n});\n</script>\n","<script lang=\"ts\">\nimport { useViewStore } from '@/src/store/views';\nimport { computed, defineComponent, toRefs, watch } from 'vue';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useCropStore } from '@/src/store/tools/crop';\nimport { useToolStore } from '@/src/store/tools';\nimport { Tools } from '@/src/store/tools/types';\nimport Crop2D from './crop/Crop2D.vue';\nimport Crop3D from './crop/Crop3D.vue';\n\nexport default defineComponent({\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n  },\n  components: {\n    Crop2D,\n    Crop3D,\n  },\n  setup(props) {\n    const { viewId: viewID } = toRefs(props);\n\n    const { currentImageID } = useCurrentImage();\n    const cropStore = useCropStore();\n    const toolStore = useToolStore();\n\n    const active = computed(() => toolStore.currentTool === Tools.Crop);\n\n    watch(\n      currentImageID,\n      (imageID) => {\n        if (imageID && !(imageID in cropStore.croppingByImageID)) {\n          cropStore.resetCropping(imageID);\n        }\n      },\n      { immediate: true }\n    );\n\n    const viewType = computed(() => {\n      const viewStore = useViewStore();\n      return viewStore.viewSpecs[viewID.value].viewType;\n    });\n\n    return {\n      active,\n      viewType,\n    };\n  },\n});\n</script>\n\n<template>\n  <svg class=\"overlay-no-events\">\n    <crop-2D v-if=\"active && viewType === '2D'\" :view-id=\"viewId\" />\n    <crop-3D v-if=\"active && viewType === '3D'\" :view-id=\"viewId\" />\n  </svg>\n</template>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","<script lang=\"ts\">\nimport { useViewStore } from '@/src/store/views';\nimport { computed, defineComponent, toRefs, watch } from 'vue';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useCropStore } from '@/src/store/tools/crop';\nimport { useToolStore } from '@/src/store/tools';\nimport { Tools } from '@/src/store/tools/types';\nimport Crop2D from './crop/Crop2D.vue';\nimport Crop3D from './crop/Crop3D.vue';\n\nexport default defineComponent({\n  props: {\n    viewId: {\n      type: String,\n      required: true,\n    },\n  },\n  components: {\n    Crop2D,\n    Crop3D,\n  },\n  setup(props) {\n    const { viewId: viewID } = toRefs(props);\n\n    const { currentImageID } = useCurrentImage();\n    const cropStore = useCropStore();\n    const toolStore = useToolStore();\n\n    const active = computed(() => toolStore.currentTool === Tools.Crop);\n\n    watch(\n      currentImageID,\n      (imageID) => {\n        if (imageID && !(imageID in cropStore.croppingByImageID)) {\n          cropStore.resetCropping(imageID);\n        }\n      },\n      { immediate: true }\n    );\n\n    const viewType = computed(() => {\n      const viewStore = useViewStore();\n      return viewStore.viewSpecs[viewID.value].viewType;\n    });\n\n    return {\n      active,\n      viewType,\n    };\n  },\n});\n</script>\n\n<template>\n  <svg class=\"overlay-no-events\">\n    <crop-2D v-if=\"active && viewType === '2D'\" :view-id=\"viewId\" />\n    <crop-3D v-if=\"active && viewType === '3D'\" :view-id=\"viewId\" />\n  </svg>\n</template>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n","import { inject } from 'vue';\nimport vtkProxyManager from '@kitware/vtk.js/Proxy/Core/ProxyManager';\n\nconst defaultKey = 'ProxyManager';\n\nexport function withProxyManager(cb: (pxm: vtkProxyManager) => void) {\n  const pxm = inject<vtkProxyManager>('ProxyManager');\n  return pxm ? cb(pxm) : null;\n}\n\nexport function useProxyManager(key = defaultKey) {\n  return inject<vtkProxyManager>(key ?? defaultKey);\n}\n","<template>\n  <div\n    class=\"vtk-container-wrapper\"\n    tabindex=\"0\"\n    @pointerenter=\"hover = true\"\n    @pointerleave=\"hover = false\"\n    @focusin=\"hover = true\"\n    @focusout=\"hover = false\"\n  >\n    <div class=\"vtk-gutter\">\n      <v-btn dark icon size=\"medium\" variant=\"text\" @click=\"enableResizeToFit\">\n        <v-icon size=\"medium\" class=\"py-1\">mdi-camera-flip-outline</v-icon>\n        <v-tooltip\n          location=\"right\"\n          activator=\"parent\"\n          transition=\"slide-x-transition\"\n        >\n          Reset Camera\n        </v-tooltip>\n      </v-btn>\n      <slice-slider\n        class=\"slice-slider\"\n        :slice=\"currentSlice\"\n        :min=\"sliceMin\"\n        :max=\"sliceMax\"\n        :step=\"1\"\n        :handle-height=\"20\"\n        @input=\"setSlice\"\n      />\n    </div>\n    <div class=\"vtk-container\" :class=\"active ? 'active' : ''\">\n      <div class=\"vtk-sub-container\">\n        <div class=\"vtk-view\" ref=\"vtkContainerRef\" />\n      </div>\n      <div class=\"overlay-no-events tool-layer\" ref=\"toolContainer\">\n        <pan-tool :view-id=\"viewID\" />\n        <zoom-tool :view-id=\"viewID\" />\n        <slice-scroll-tool :view-id=\"viewID\" />\n        <window-level-tool :view-id=\"viewID\" />\n        <contour-tool\n          :view-id=\"viewID\"\n          :widget-manager=\"widgetManager\"\n          :view-direction=\"viewDirection\"\n          :current-slice=\"currentSlice\"\n        />\n        <ruler-tool\n          :view-id=\"viewID\"\n          :widget-manager=\"widgetManager\"\n          :view-direction=\"viewDirection\"\n          :current-slice=\"currentSlice\"\n        />\n        <rectangle-tool\n          :view-id=\"viewID\"\n          :widget-manager=\"widgetManager\"\n          :view-direction=\"viewDirection\"\n          :current-slice=\"currentSlice\"\n        />\n        <paint-tool\n          :view-id=\"viewID\"\n          :view-direction=\"viewDirection\"\n          :widget-manager=\"widgetManager\"\n          :slice=\"currentSlice\"\n        />\n        <crosshairs-tool\n          :view-id=\"viewID\"\n          :view-direction=\"viewDirection\"\n          :widget-manager=\"widgetManager\"\n          :slice=\"currentSlice\"\n        />\n        <crop-tool :view-id=\"viewID\" />\n      </div>\n      <view-overlay-grid class=\"overlay-no-events view-annotations\">\n        <template v-slot:top-center>\n          <div class=\"annotation-cell\">\n            <span>{{ topLabel }}</span>\n          </div>\n        </template>\n        <template v-slot:middle-left>\n          <div class=\"annotation-cell\">\n            <span>{{ leftLabel }}</span>\n          </div>\n        </template>\n        <template v-slot:bottom-left>\n          <div class=\"annotation-cell\">\n            <div>Slice: {{ currentSlice + 1 }}/{{ sliceMax + 1 }}</div>\n            <div\n              v-if=\"\n                typeof windowWidth === 'number' &&\n                typeof windowLevel === 'number'\n              \"\n            >\n              W/L: {{ windowWidth.toFixed(2) }} / {{ windowLevel.toFixed(2) }}\n            </div>\n          </div>\n        </template>\n        <template v-slot:top-right>\n          <div class=\"annotation-cell\">\n            <v-menu\n              open-on-hover\n              location=\"bottom left\"\n              left\n              nudge-left=\"10\"\n              dark\n              v-if=\"dicomInfo !== null\"\n              max-width=\"300px\"\n            >\n              <template v-slot:activator=\"{ props }\">\n                <v-icon\n                  v-bind=\"props\"\n                  dark\n                  size=\"x-large\"\n                  class=\"pointer-events-all hover-info\"\n                >\n                  mdi-information\n                </v-icon>\n              </template>\n              <v-list class=\"bg-grey-darken-3\">\n                <v-list-item>\n                  <v-list-item-title class=\"font-weight-bold\">\n                    PATIENT / CASE\n                  </v-list-item-title>\n                  <v-divider />\n                  <v-list-item-title>\n                    ID: {{ dicomInfo.patientID }}\n                  </v-list-item-title>\n                </v-list-item>\n                <v-list-item>\n                  <v-list-item-title class=\"font-weight-bold\">\n                    STUDY\n                  </v-list-item-title>\n                  <v-divider />\n                  <v-list-item-title>\n                    ID: {{ dicomInfo.studyID }}\n                  </v-list-item-title>\n                  <v-list-item-title>\n                    {{ dicomInfo.studyDescription }}\n                  </v-list-item-title>\n                </v-list-item>\n                <v-list-item>\n                  <v-list-item-title class=\"font-weight-bold\">\n                    SERIES\n                  </v-list-item-title>\n                  <v-divider />\n                  <v-list-item-title>\n                    Series #: {{ dicomInfo.seriesNumber }}\n                  </v-list-item-title>\n                  <v-list-item-title>\n                    {{ dicomInfo.seriesDescription }}\n                  </v-list-item-title>\n                </v-list-item>\n              </v-list>\n            </v-menu>\n          </div>\n        </template>\n      </view-overlay-grid>\n      <transition name=\"loading\">\n        <div v-if=\"isImageLoading\" class=\"overlay-no-events loading\">\n          <div>Loading the image</div>\n          <div>\n            <v-progress-circular indeterminate color=\"blue\" />\n          </div>\n        </div>\n      </transition>\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport {\n  computed,\n  defineComponent,\n  onBeforeMount,\n  onBeforeUnmount,\n  onMounted,\n  PropType,\n  provide,\n  ref,\n  toRefs,\n  watch,\n  watchEffect,\n} from 'vue';\nimport { vec3 } from 'gl-matrix';\nimport { onKeyStroke } from '@vueuse/core';\n\nimport { useResizeToFit } from '@src/composables/useResizeToFit';\nimport vtkLPSView2DProxy from '@src/vtk/LPSView2DProxy';\nimport vtkIJKSliceRepresentationProxy from '@src/vtk/IJKSliceRepresentationProxy';\nimport vtkPiecewiseFunctionProxy from '@kitware/vtk.js/Proxy/Core/PiecewiseFunctionProxy';\nimport { Mode as LookupTableProxyMode } from '@kitware/vtk.js/Proxy/Core/LookupTableProxy';\nimport { manageVTKSubscription } from '@src/composables/manageVTKSubscription';\nimport SliceSlider from '@src/components/SliceSlider.vue';\nimport ViewOverlayGrid from '@src/components/ViewOverlayGrid.vue';\nimport { useResizeObserver } from '../composables/useResizeObserver';\nimport { useOrientationLabels } from '../composables/useOrientationLabels';\nimport { getLPSAxisFromDir } from '../utils/lps';\nimport { useCurrentImage } from '../composables/useCurrentImage';\nimport { useCameraOrientation } from '../composables/useCameraOrientation';\nimport WindowLevelTool from './tools/WindowLevelTool.vue';\nimport SliceScrollTool from './tools/SliceScrollTool.vue';\nimport PanTool from './tools/PanTool.vue';\nimport ZoomTool from './tools/ZoomTool.vue';\nimport RulerTool from './tools/RulerTool.vue';\nimport RectangleTool from './tools/RectangleTool.vue';\nimport ContourTool from './tools/ContourTool.vue';\nimport PaintTool from './tools/PaintTool.vue';\nimport { useSceneBuilder } from '../composables/useSceneBuilder';\nimport { useDICOMStore } from '../store/datasets-dicom';\nimport { useLabelmapStore } from '../store/datasets-labelmaps';\nimport vtkLabelMapSliceRepProxy from '../vtk/LabelMapSliceRepProxy';\nimport { usePaintToolStore } from '../store/tools/paint';\nimport useWindowingStore from '../store/view-configs/windowing';\nimport { usePersistCameraConfig } from '../composables/usePersistCameraConfig';\nimport CrosshairsTool from './tools/CrosshairsTool.vue';\nimport { LPSAxisDir } from '../types/lps';\nimport { ViewProxyType } from '../core/proxies';\nimport { useViewProxy } from '../composables/useViewProxy';\nimport { useWidgetManager } from '../composables/useWidgetManager';\nimport useViewSliceStore, {\n  defaultSliceConfig,\n} from '../store/view-configs/slicing';\nimport CropTool from './tools/CropTool.vue';\nimport { ToolContainer, VTKTwoViewWidgetManager } from '../constants';\nimport { useProxyManager } from '../composables/proxyManager';\nimport { getShiftedOpacityFromPreset } from '../utils/vtk-helpers';\nimport { useLayersStore } from '../store/datasets-layers';\nimport { useViewCameraStore } from '../store/view-configs/camera';\nimport useLayerColoringStore from '../store/view-configs/layers';\n\nconst SLICE_OFFSET_KEYS: Record<string, number> = {\n  ArrowLeft: -1,\n  ArrowRight: 1,\n  ArrowUp: -1,\n  ArrowDown: 1,\n} as const;\n\nexport default defineComponent({\n  name: 'VtkTwoView',\n  props: {\n    id: {\n      type: String,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    viewUp: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n  },\n  components: {\n    SliceSlider,\n    ViewOverlayGrid,\n    WindowLevelTool,\n    SliceScrollTool,\n    PanTool,\n    ZoomTool,\n    RulerTool,\n    RectangleTool,\n    PaintTool,\n    CrosshairsTool,\n    CropTool,\n    ContourTool,\n  },\n  setup(props) {\n    const windowingStore = useWindowingStore();\n    const viewSliceStore = useViewSliceStore();\n    const viewCameraStore = useViewCameraStore();\n    const layerColoringStore = useLayerColoringStore();\n    const paintStore = usePaintToolStore();\n\n    const { id: viewID, viewDirection, viewUp } = toRefs(props);\n\n    const vtkContainerRef = ref<HTMLElement>();\n\n    const viewAxis = computed(() => getLPSAxisFromDir(viewDirection.value));\n\n    // --- computed vars --- //\n\n    const {\n      currentImageData: curImageData,\n      currentImageID: curImageID,\n      currentImageMetadata: curImageMetadata,\n      isImageLoading,\n      currentLayers,\n    } = useCurrentImage();\n\n    const dicomStore = useDICOMStore();\n\n    const sliceConfigDefaults = defaultSliceConfig();\n    const sliceConfig = computed(() =>\n      viewSliceStore.getConfig(viewID.value, curImageID.value)\n    );\n    const currentSlice = computed(\n      () => sliceConfig.value?.slice ?? sliceConfigDefaults.slice\n    );\n    const sliceMin = computed(\n      () => sliceConfig.value?.min ?? sliceConfigDefaults.min\n    );\n    const sliceMax = computed(\n      () => sliceConfig.value?.max ?? sliceConfigDefaults.max\n    );\n\n    const wlConfig = computed({\n      get: () => windowingStore.getConfig(viewID.value, curImageID.value),\n      set: (newValue) => {\n        const imageID = curImageID.value;\n        if (imageID !== null && newValue != null) {\n          windowingStore.updateConfig(viewID.value, imageID, newValue);\n        }\n      },\n    });\n\n    const windowWidth = computed(() => wlConfig.value?.width);\n    const windowLevel = computed(() => wlConfig.value?.level);\n    const dicomInfo = computed(() => {\n      if (\n        curImageID.value !== null &&\n        curImageID.value in dicomStore.imageIDToVolumeKey\n      ) {\n        const volumeKey = dicomStore.imageIDToVolumeKey[curImageID.value];\n        const volumeInfo = dicomStore.volumeInfo[volumeKey];\n        const studyKey = dicomStore.volumeStudy[volumeKey];\n        const studyInfo = dicomStore.studyInfo[studyKey];\n        const patientKey = dicomStore.studyPatient[studyKey];\n        const patientInfo = dicomStore.patientInfo[patientKey];\n\n        const patientID = patientInfo.PatientID;\n        const studyID = studyInfo.StudyID;\n        const studyDescription = studyInfo.StudyDescription;\n        const seriesNumber = volumeInfo.SeriesNumber;\n        const seriesDescription = volumeInfo.SeriesDescription;\n\n        return {\n          patientID,\n          studyID,\n          studyDescription,\n          seriesNumber,\n          seriesDescription,\n        };\n      }\n\n      return null;\n    });\n\n    const sliceDomain = computed(() => {\n      const { lpsOrientation, dimensions } = curImageMetadata.value;\n      const ijkIndex = lpsOrientation[viewAxis.value];\n      const dimMax = dimensions[ijkIndex];\n\n      return {\n        min: 0,\n        max: dimMax - 1,\n      };\n    });\n\n    // --- setters --- //\n\n    const setSlice = (slice: number) => {\n      if (curImageID.value !== null) {\n        viewSliceStore.updateConfig(viewID.value, curImageID.value, {\n          slice,\n        });\n      }\n    };\n\n    // --- view proxy setup --- //\n\n    const { viewProxy, setContainer: setViewProxyContainer } =\n      useViewProxy<vtkLPSView2DProxy>(viewID, ViewProxyType.Slice);\n\n    onBeforeMount(() => {\n      // do this before mount, as the ManipulatorTools run onMounted\n      // before this component does.\n      viewProxy.value.getInteractorStyle2D().removeAllManipulators();\n    });\n\n    onMounted(() => {\n      setViewProxyContainer(vtkContainerRef.value);\n      viewProxy.value.setOrientationAxesVisibility(false);\n    });\n\n    onBeforeUnmount(() => {\n      setViewProxyContainer(null);\n    });\n\n    // --- Slicing setup --- //\n\n    watchEffect(() => {\n      const ijkIndex = curImageMetadata.value.lpsOrientation[viewAxis.value];\n      viewProxy.value.setSlicingMode('IJK'[ijkIndex]);\n    });\n\n    watch(\n      [viewID, curImageID, viewDirection],\n      ([viewID_, imageID, viewDir]) => {\n        if (!imageID || sliceConfig.value != null) {\n          return;\n        }\n\n        viewSliceStore.updateConfig(viewID_, imageID, {\n          ...sliceDomain.value,\n          axisDirection: viewDir,\n        });\n        viewSliceStore.resetSlice(viewID_, imageID);\n      },\n      { immediate: true }\n    );\n\n    // --- arrows change slice --- //\n\n    const hover = ref(false);\n    const onKeyDown = (event: KeyboardEvent) => {\n      if (!curImageID.value || !hover.value) return;\n\n      const sliceOffset = SLICE_OFFSET_KEYS[event.key] ?? 0;\n      if (sliceOffset) {\n        viewSliceStore.updateConfig(viewID.value, curImageID.value, {\n          slice: currentSlice.value + sliceOffset,\n        });\n\n        event.stopPropagation();\n      }\n    };\n    onKeyStroke(Object.keys(SLICE_OFFSET_KEYS), onKeyDown);\n\n    // --- resizing --- //\n\n    useResizeObserver(vtkContainerRef, () => viewProxy.value.resize());\n\n    // Used by SVG tool widgets for resizeCallback\n    const toolContainer = ref<HTMLElement>();\n    provide(ToolContainer, toolContainer);\n\n    // --- widget manager --- //\n\n    const { widgetManager } = useWidgetManager(viewProxy);\n    provide(VTKTwoViewWidgetManager, widgetManager);\n\n    // --- window/level setup --- //\n\n    watch(\n      curImageData,\n      (imageData) => {\n        if (curImageID.value == null || wlConfig.value != null || !imageData) {\n          return;\n        }\n\n        // TODO listen to changes in point data\n        const range = imageData.getPointData().getScalars().getRange();\n        windowingStore.updateConfig(viewID.value, curImageID.value, {\n          min: range[0],\n          max: range[1],\n        });\n        windowingStore.resetWindowLevel(viewID.value, curImageID.value);\n      },\n      {\n        immediate: true,\n      }\n    );\n\n    // --- scene setup --- //\n\n    const labelmapStore = useLabelmapStore();\n\n    const labelmapIDs = computed(() => {\n      return labelmapStore.idList.filter(\n        (id) => labelmapStore.parentImage[id] === curImageID.value\n      );\n    });\n\n    const layerIDs = computed(() => currentLayers.value.map(({ id }) => id));\n\n    const { baseImageRep, labelmapReps, layerReps } = useSceneBuilder<\n      vtkIJKSliceRepresentationProxy,\n      vtkLabelMapSliceRepProxy,\n      vtkIJKSliceRepresentationProxy\n    >(viewID, {\n      baseImage: curImageID,\n      labelmaps: labelmapIDs,\n      layers: layerIDs,\n    });\n\n    // --- camera setup --- //\n\n    const { cameraDirVec, cameraUpVec } = useCameraOrientation(\n      viewDirection,\n      viewUp,\n      curImageMetadata\n    );\n    const { resizeToFit, ignoreResizeToFitTracking, resetResizeToFitTracking } =\n      useResizeToFit(viewProxy.value.getCamera(), false);\n\n    const resizeToFitScene = () =>\n      ignoreResizeToFitTracking(() => {\n        // resize to fit\n        const lookAxis =\n          curImageMetadata.value.lpsOrientation[\n            getLPSAxisFromDir(viewDirection.value)\n          ];\n        const upAxis =\n          curImageMetadata.value.lpsOrientation[\n            getLPSAxisFromDir(viewUp.value)\n          ];\n        const dimsWithSpacing = curImageMetadata.value.dimensions.map(\n          (d, i) => d * curImageMetadata.value.spacing[i]\n        );\n        viewProxy.value.resizeToFit(lookAxis, upAxis, dimsWithSpacing);\n        resetResizeToFitTracking();\n      });\n\n    const resetCamera = () => {\n      const bounds = curImageMetadata.value.worldBounds;\n      const center = [\n        (bounds[0] + bounds[1]) / 2,\n        (bounds[2] + bounds[3]) / 2,\n        (bounds[4] + bounds[5]) / 2,\n      ] as vec3;\n\n      // do not track resizeToFit state\n      ignoreResizeToFitTracking(() => {\n        viewProxy.value.updateCamera(\n          cameraDirVec.value,\n          cameraUpVec.value,\n          center\n        );\n        viewProxy.value.resetCamera(bounds);\n      });\n\n      resizeToFitScene();\n\n      viewProxy.value.renderLater();\n    };\n\n    manageVTKSubscription(\n      viewProxy.value.onResize(() => {\n        if (resizeToFit.value) {\n          resizeToFitScene();\n        }\n      })\n    );\n\n    // if we re-enable resizeToFit, reset the camera\n    watch(resizeToFit, () => {\n      if (resizeToFit.value) {\n        resetCamera();\n      }\n    });\n\n    const { restoreCameraConfig } = usePersistCameraConfig(\n      viewID,\n      curImageID,\n      viewProxy,\n      'parallelScale',\n      'position',\n      'focalPoint',\n      'viewUp'\n    );\n\n    watch(\n      [curImageID, cameraDirVec, cameraUpVec],\n      () => {\n        const cameraConfig = viewCameraStore.getConfig(\n          viewID.value,\n          curImageID.value\n        );\n\n        // If we have a saved camera configuration restore it\n        if (cameraConfig) {\n          restoreCameraConfig(cameraConfig);\n\n          viewProxy.value.getRenderer().resetCameraClippingRange();\n          viewProxy.value.renderLater();\n\n          // Prevent resize\n          resizeToFit.value = false;\n        } else if (resizeToFit.value) {\n          resetCamera();\n        } else {\n          // this will trigger a resetCamera() call\n          resizeToFit.value = true;\n        }\n      },\n      { immediate: true, deep: true }\n    );\n\n    // --- viewport orientation/camera labels --- //\n\n    const { top: topLabel, left: leftLabel } = useOrientationLabels(viewProxy);\n\n    // --- apply windowing and slice configs --- //\n\n    watchEffect(() => {\n      if (sliceConfig.value == null || wlConfig.value == null) {\n        return;\n      }\n\n      const { slice } = sliceConfig.value;\n      const { width, level } = wlConfig.value;\n      const rep = baseImageRep.value;\n      if (rep) {\n        rep.setSlice(slice);\n        rep.setWindowWidth(width);\n        rep.setWindowLevel(level);\n      }\n      [...layerReps.value, ...labelmapReps.value].forEach((lRep) => {\n        lRep.setSlice(slice);\n      });\n\n      viewProxy.value.renderLater();\n    });\n\n    // --- apply labelmap opacity --- //\n\n    watchEffect(() => {\n      const { labelmapOpacity } = paintStore;\n      labelmapReps.value.forEach((lmRep) => {\n        lmRep.setOpacity(labelmapOpacity);\n      });\n    });\n\n    // --- layers setup --- //\n\n    const layersConfigs = computed(() =>\n      layerIDs.value.map((id) => layerColoringStore.getConfig(viewID.value, id))\n    );\n\n    const layersStore = useLayersStore();\n    watch(\n      [viewID, currentLayers],\n      () => {\n        currentLayers.value.forEach(({ id }, layerIndex) => {\n          const image = layersStore.layerImages[id];\n          const layerConfig = layersConfigs.value[layerIndex];\n          if (image && !layerConfig) {\n            layerColoringStore.resetToDefault(viewID.value, id, image);\n          }\n        });\n      },\n      { immediate: true }\n    );\n\n    // --- layer coloring --- //\n\n    const proxyManager = useProxyManager()!;\n\n    const colorBys = computed(() =>\n      layersConfigs.value.map((config) => config?.colorBy)\n    );\n    const transferFunctions = computed(() =>\n      layersConfigs.value.map((config) => config?.transferFunction)\n    );\n    const opacityFunctions = computed(() =>\n      layersConfigs.value.map((config) => config?.opacityFunction)\n    );\n    const blendConfigs = computed(() =>\n      layersConfigs.value.map((config) => config?.blendConfig)\n    );\n\n    watch(\n      [layerReps, colorBys, transferFunctions, opacityFunctions, blendConfigs],\n      () => {\n        layerReps.value\n          .map(\n            (layerRep, idx) =>\n              [\n                layerRep,\n                colorBys.value[idx],\n                transferFunctions.value[idx],\n                opacityFunctions.value[idx],\n                blendConfigs.value[idx],\n              ] as const\n          )\n          .forEach(\n            ([\n              rep,\n              colorBy,\n              transferFunction,\n              opacityFunction,\n              blendConfig,\n            ]) => {\n              if (\n                !colorBy ||\n                !transferFunction ||\n                !opacityFunction ||\n                !blendConfig\n              ) {\n                return;\n              }\n\n              const { arrayName, location } = colorBy;\n              const ctFunc = transferFunction;\n              const opFunc = opacityFunction;\n\n              const lut = proxyManager.getLookupTable(arrayName);\n              lut.setMode(LookupTableProxyMode.Preset);\n              lut.setPresetName(ctFunc.preset);\n              lut.setDataRange(...ctFunc.mappingRange);\n\n              const pwf = proxyManager.getPiecewiseFunction(arrayName);\n              pwf.setMode(opFunc.mode);\n              pwf.setDataRange(...opFunc.mappingRange);\n\n              switch (opFunc.mode) {\n                case vtkPiecewiseFunctionProxy.Mode.Gaussians:\n                  pwf.setGaussians(opFunc.gaussians);\n                  break;\n                case vtkPiecewiseFunctionProxy.Mode.Points: {\n                  const opacityPoints = getShiftedOpacityFromPreset(\n                    opFunc.preset,\n                    opFunc.mappingRange,\n                    opFunc.shift\n                  );\n                  if (opacityPoints) {\n                    pwf.setPoints(opacityPoints);\n                  }\n                  break;\n                }\n                case vtkPiecewiseFunctionProxy.Mode.Nodes:\n                  pwf.setNodes(opFunc.nodes);\n                  break;\n                default:\n              }\n\n              // control color range manually\n              rep.setRescaleOnColorBy(false);\n              rep.setColorBy(arrayName, location);\n              rep.setOpacity(blendConfig.opacity);\n\n              // Need to trigger a render for when we are restoring from a state file\n              viewProxy.value.renderLater();\n            }\n          );\n      },\n      { immediate: true, deep: true }\n    );\n\n    return {\n      vtkContainerRef,\n      toolContainer,\n      viewID,\n      viewProxy,\n      viewAxis,\n      active: true,\n      currentSlice,\n      sliceMin,\n      sliceMax,\n      windowWidth,\n      windowLevel,\n      topLabel,\n      leftLabel,\n      isImageLoading,\n      setSlice,\n      widgetManager,\n      dicomInfo,\n      enableResizeToFit() {\n        resizeToFit.value = true;\n      },\n      hover,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n<style scoped src=\"@/src/components/styles/utils.css\"></style>\n<style scoped>\n.hover-info {\n  width: 32px;\n  height: 32px;\n  cursor: pointer;\n}\n</style>\n","<template>\n  <div\n    class=\"vtk-container-wrapper\"\n    tabindex=\"0\"\n    @pointerenter=\"hover = true\"\n    @pointerleave=\"hover = false\"\n    @focusin=\"hover = true\"\n    @focusout=\"hover = false\"\n  >\n    <div class=\"vtk-gutter\">\n      <v-btn dark icon size=\"medium\" variant=\"text\" @click=\"enableResizeToFit\">\n        <v-icon size=\"medium\" class=\"py-1\">mdi-camera-flip-outline</v-icon>\n        <v-tooltip\n          location=\"right\"\n          activator=\"parent\"\n          transition=\"slide-x-transition\"\n        >\n          Reset Camera\n        </v-tooltip>\n      </v-btn>\n      <slice-slider\n        class=\"slice-slider\"\n        :slice=\"currentSlice\"\n        :min=\"sliceMin\"\n        :max=\"sliceMax\"\n        :step=\"1\"\n        :handle-height=\"20\"\n        @input=\"setSlice\"\n      />\n    </div>\n    <div class=\"vtk-container\" :class=\"active ? 'active' : ''\">\n      <div class=\"vtk-sub-container\">\n        <div class=\"vtk-view\" ref=\"vtkContainerRef\" />\n      </div>\n      <div class=\"overlay-no-events tool-layer\" ref=\"toolContainer\">\n        <pan-tool :view-id=\"viewID\" />\n        <zoom-tool :view-id=\"viewID\" />\n        <slice-scroll-tool :view-id=\"viewID\" />\n        <window-level-tool :view-id=\"viewID\" />\n        <contour-tool\n          :view-id=\"viewID\"\n          :widget-manager=\"widgetManager\"\n          :view-direction=\"viewDirection\"\n          :current-slice=\"currentSlice\"\n        />\n        <ruler-tool\n          :view-id=\"viewID\"\n          :widget-manager=\"widgetManager\"\n          :view-direction=\"viewDirection\"\n          :current-slice=\"currentSlice\"\n        />\n        <rectangle-tool\n          :view-id=\"viewID\"\n          :widget-manager=\"widgetManager\"\n          :view-direction=\"viewDirection\"\n          :current-slice=\"currentSlice\"\n        />\n        <paint-tool\n          :view-id=\"viewID\"\n          :view-direction=\"viewDirection\"\n          :widget-manager=\"widgetManager\"\n          :slice=\"currentSlice\"\n        />\n        <crosshairs-tool\n          :view-id=\"viewID\"\n          :view-direction=\"viewDirection\"\n          :widget-manager=\"widgetManager\"\n          :slice=\"currentSlice\"\n        />\n        <crop-tool :view-id=\"viewID\" />\n      </div>\n      <view-overlay-grid class=\"overlay-no-events view-annotations\">\n        <template v-slot:top-center>\n          <div class=\"annotation-cell\">\n            <span>{{ topLabel }}</span>\n          </div>\n        </template>\n        <template v-slot:middle-left>\n          <div class=\"annotation-cell\">\n            <span>{{ leftLabel }}</span>\n          </div>\n        </template>\n        <template v-slot:bottom-left>\n          <div class=\"annotation-cell\">\n            <div>Slice: {{ currentSlice + 1 }}/{{ sliceMax + 1 }}</div>\n            <div\n              v-if=\"\n                typeof windowWidth === 'number' &&\n                typeof windowLevel === 'number'\n              \"\n            >\n              W/L: {{ windowWidth.toFixed(2) }} / {{ windowLevel.toFixed(2) }}\n            </div>\n          </div>\n        </template>\n        <template v-slot:top-right>\n          <div class=\"annotation-cell\">\n            <v-menu\n              open-on-hover\n              location=\"bottom left\"\n              left\n              nudge-left=\"10\"\n              dark\n              v-if=\"dicomInfo !== null\"\n              max-width=\"300px\"\n            >\n              <template v-slot:activator=\"{ props }\">\n                <v-icon\n                  v-bind=\"props\"\n                  dark\n                  size=\"x-large\"\n                  class=\"pointer-events-all hover-info\"\n                >\n                  mdi-information\n                </v-icon>\n              </template>\n              <v-list class=\"bg-grey-darken-3\">\n                <v-list-item>\n                  <v-list-item-title class=\"font-weight-bold\">\n                    PATIENT / CASE\n                  </v-list-item-title>\n                  <v-divider />\n                  <v-list-item-title>\n                    ID: {{ dicomInfo.patientID }}\n                  </v-list-item-title>\n                </v-list-item>\n                <v-list-item>\n                  <v-list-item-title class=\"font-weight-bold\">\n                    STUDY\n                  </v-list-item-title>\n                  <v-divider />\n                  <v-list-item-title>\n                    ID: {{ dicomInfo.studyID }}\n                  </v-list-item-title>\n                  <v-list-item-title>\n                    {{ dicomInfo.studyDescription }}\n                  </v-list-item-title>\n                </v-list-item>\n                <v-list-item>\n                  <v-list-item-title class=\"font-weight-bold\">\n                    SERIES\n                  </v-list-item-title>\n                  <v-divider />\n                  <v-list-item-title>\n                    Series #: {{ dicomInfo.seriesNumber }}\n                  </v-list-item-title>\n                  <v-list-item-title>\n                    {{ dicomInfo.seriesDescription }}\n                  </v-list-item-title>\n                </v-list-item>\n              </v-list>\n            </v-menu>\n          </div>\n        </template>\n      </view-overlay-grid>\n      <transition name=\"loading\">\n        <div v-if=\"isImageLoading\" class=\"overlay-no-events loading\">\n          <div>Loading the image</div>\n          <div>\n            <v-progress-circular indeterminate color=\"blue\" />\n          </div>\n        </div>\n      </transition>\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport {\n  computed,\n  defineComponent,\n  onBeforeMount,\n  onBeforeUnmount,\n  onMounted,\n  PropType,\n  provide,\n  ref,\n  toRefs,\n  watch,\n  watchEffect,\n} from 'vue';\nimport { vec3 } from 'gl-matrix';\nimport { onKeyStroke } from '@vueuse/core';\n\nimport { useResizeToFit } from '@src/composables/useResizeToFit';\nimport vtkLPSView2DProxy from '@src/vtk/LPSView2DProxy';\nimport vtkIJKSliceRepresentationProxy from '@src/vtk/IJKSliceRepresentationProxy';\nimport vtkPiecewiseFunctionProxy from '@kitware/vtk.js/Proxy/Core/PiecewiseFunctionProxy';\nimport { Mode as LookupTableProxyMode } from '@kitware/vtk.js/Proxy/Core/LookupTableProxy';\nimport { manageVTKSubscription } from '@src/composables/manageVTKSubscription';\nimport SliceSlider from '@src/components/SliceSlider.vue';\nimport ViewOverlayGrid from '@src/components/ViewOverlayGrid.vue';\nimport { useResizeObserver } from '../composables/useResizeObserver';\nimport { useOrientationLabels } from '../composables/useOrientationLabels';\nimport { getLPSAxisFromDir } from '../utils/lps';\nimport { useCurrentImage } from '../composables/useCurrentImage';\nimport { useCameraOrientation } from '../composables/useCameraOrientation';\nimport WindowLevelTool from './tools/WindowLevelTool.vue';\nimport SliceScrollTool from './tools/SliceScrollTool.vue';\nimport PanTool from './tools/PanTool.vue';\nimport ZoomTool from './tools/ZoomTool.vue';\nimport RulerTool from './tools/RulerTool.vue';\nimport RectangleTool from './tools/RectangleTool.vue';\nimport ContourTool from './tools/ContourTool.vue';\nimport PaintTool from './tools/PaintTool.vue';\nimport { useSceneBuilder } from '../composables/useSceneBuilder';\nimport { useDICOMStore } from '../store/datasets-dicom';\nimport { useLabelmapStore } from '../store/datasets-labelmaps';\nimport vtkLabelMapSliceRepProxy from '../vtk/LabelMapSliceRepProxy';\nimport { usePaintToolStore } from '../store/tools/paint';\nimport useWindowingStore from '../store/view-configs/windowing';\nimport { usePersistCameraConfig } from '../composables/usePersistCameraConfig';\nimport CrosshairsTool from './tools/CrosshairsTool.vue';\nimport { LPSAxisDir } from '../types/lps';\nimport { ViewProxyType } from '../core/proxies';\nimport { useViewProxy } from '../composables/useViewProxy';\nimport { useWidgetManager } from '../composables/useWidgetManager';\nimport useViewSliceStore, {\n  defaultSliceConfig,\n} from '../store/view-configs/slicing';\nimport CropTool from './tools/CropTool.vue';\nimport { ToolContainer, VTKTwoViewWidgetManager } from '../constants';\nimport { useProxyManager } from '../composables/proxyManager';\nimport { getShiftedOpacityFromPreset } from '../utils/vtk-helpers';\nimport { useLayersStore } from '../store/datasets-layers';\nimport { useViewCameraStore } from '../store/view-configs/camera';\nimport useLayerColoringStore from '../store/view-configs/layers';\n\nconst SLICE_OFFSET_KEYS: Record<string, number> = {\n  ArrowLeft: -1,\n  ArrowRight: 1,\n  ArrowUp: -1,\n  ArrowDown: 1,\n} as const;\n\nexport default defineComponent({\n  name: 'VtkTwoView',\n  props: {\n    id: {\n      type: String,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    viewUp: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n  },\n  components: {\n    SliceSlider,\n    ViewOverlayGrid,\n    WindowLevelTool,\n    SliceScrollTool,\n    PanTool,\n    ZoomTool,\n    RulerTool,\n    RectangleTool,\n    PaintTool,\n    CrosshairsTool,\n    CropTool,\n    ContourTool,\n  },\n  setup(props) {\n    const windowingStore = useWindowingStore();\n    const viewSliceStore = useViewSliceStore();\n    const viewCameraStore = useViewCameraStore();\n    const layerColoringStore = useLayerColoringStore();\n    const paintStore = usePaintToolStore();\n\n    const { id: viewID, viewDirection, viewUp } = toRefs(props);\n\n    const vtkContainerRef = ref<HTMLElement>();\n\n    const viewAxis = computed(() => getLPSAxisFromDir(viewDirection.value));\n\n    // --- computed vars --- //\n\n    const {\n      currentImageData: curImageData,\n      currentImageID: curImageID,\n      currentImageMetadata: curImageMetadata,\n      isImageLoading,\n      currentLayers,\n    } = useCurrentImage();\n\n    const dicomStore = useDICOMStore();\n\n    const sliceConfigDefaults = defaultSliceConfig();\n    const sliceConfig = computed(() =>\n      viewSliceStore.getConfig(viewID.value, curImageID.value)\n    );\n    const currentSlice = computed(\n      () => sliceConfig.value?.slice ?? sliceConfigDefaults.slice\n    );\n    const sliceMin = computed(\n      () => sliceConfig.value?.min ?? sliceConfigDefaults.min\n    );\n    const sliceMax = computed(\n      () => sliceConfig.value?.max ?? sliceConfigDefaults.max\n    );\n\n    const wlConfig = computed({\n      get: () => windowingStore.getConfig(viewID.value, curImageID.value),\n      set: (newValue) => {\n        const imageID = curImageID.value;\n        if (imageID !== null && newValue != null) {\n          windowingStore.updateConfig(viewID.value, imageID, newValue);\n        }\n      },\n    });\n\n    const windowWidth = computed(() => wlConfig.value?.width);\n    const windowLevel = computed(() => wlConfig.value?.level);\n    const dicomInfo = computed(() => {\n      if (\n        curImageID.value !== null &&\n        curImageID.value in dicomStore.imageIDToVolumeKey\n      ) {\n        const volumeKey = dicomStore.imageIDToVolumeKey[curImageID.value];\n        const volumeInfo = dicomStore.volumeInfo[volumeKey];\n        const studyKey = dicomStore.volumeStudy[volumeKey];\n        const studyInfo = dicomStore.studyInfo[studyKey];\n        const patientKey = dicomStore.studyPatient[studyKey];\n        const patientInfo = dicomStore.patientInfo[patientKey];\n\n        const patientID = patientInfo.PatientID;\n        const studyID = studyInfo.StudyID;\n        const studyDescription = studyInfo.StudyDescription;\n        const seriesNumber = volumeInfo.SeriesNumber;\n        const seriesDescription = volumeInfo.SeriesDescription;\n\n        return {\n          patientID,\n          studyID,\n          studyDescription,\n          seriesNumber,\n          seriesDescription,\n        };\n      }\n\n      return null;\n    });\n\n    const sliceDomain = computed(() => {\n      const { lpsOrientation, dimensions } = curImageMetadata.value;\n      const ijkIndex = lpsOrientation[viewAxis.value];\n      const dimMax = dimensions[ijkIndex];\n\n      return {\n        min: 0,\n        max: dimMax - 1,\n      };\n    });\n\n    // --- setters --- //\n\n    const setSlice = (slice: number) => {\n      if (curImageID.value !== null) {\n        viewSliceStore.updateConfig(viewID.value, curImageID.value, {\n          slice,\n        });\n      }\n    };\n\n    // --- view proxy setup --- //\n\n    const { viewProxy, setContainer: setViewProxyContainer } =\n      useViewProxy<vtkLPSView2DProxy>(viewID, ViewProxyType.Slice);\n\n    onBeforeMount(() => {\n      // do this before mount, as the ManipulatorTools run onMounted\n      // before this component does.\n      viewProxy.value.getInteractorStyle2D().removeAllManipulators();\n    });\n\n    onMounted(() => {\n      setViewProxyContainer(vtkContainerRef.value);\n      viewProxy.value.setOrientationAxesVisibility(false);\n    });\n\n    onBeforeUnmount(() => {\n      setViewProxyContainer(null);\n    });\n\n    // --- Slicing setup --- //\n\n    watchEffect(() => {\n      const ijkIndex = curImageMetadata.value.lpsOrientation[viewAxis.value];\n      viewProxy.value.setSlicingMode('IJK'[ijkIndex]);\n    });\n\n    watch(\n      [viewID, curImageID, viewDirection],\n      ([viewID_, imageID, viewDir]) => {\n        if (!imageID || sliceConfig.value != null) {\n          return;\n        }\n\n        viewSliceStore.updateConfig(viewID_, imageID, {\n          ...sliceDomain.value,\n          axisDirection: viewDir,\n        });\n        viewSliceStore.resetSlice(viewID_, imageID);\n      },\n      { immediate: true }\n    );\n\n    // --- arrows change slice --- //\n\n    const hover = ref(false);\n    const onKeyDown = (event: KeyboardEvent) => {\n      if (!curImageID.value || !hover.value) return;\n\n      const sliceOffset = SLICE_OFFSET_KEYS[event.key] ?? 0;\n      if (sliceOffset) {\n        viewSliceStore.updateConfig(viewID.value, curImageID.value, {\n          slice: currentSlice.value + sliceOffset,\n        });\n\n        event.stopPropagation();\n      }\n    };\n    onKeyStroke(Object.keys(SLICE_OFFSET_KEYS), onKeyDown);\n\n    // --- resizing --- //\n\n    useResizeObserver(vtkContainerRef, () => viewProxy.value.resize());\n\n    // Used by SVG tool widgets for resizeCallback\n    const toolContainer = ref<HTMLElement>();\n    provide(ToolContainer, toolContainer);\n\n    // --- widget manager --- //\n\n    const { widgetManager } = useWidgetManager(viewProxy);\n    provide(VTKTwoViewWidgetManager, widgetManager);\n\n    // --- window/level setup --- //\n\n    watch(\n      curImageData,\n      (imageData) => {\n        if (curImageID.value == null || wlConfig.value != null || !imageData) {\n          return;\n        }\n\n        // TODO listen to changes in point data\n        const range = imageData.getPointData().getScalars().getRange();\n        windowingStore.updateConfig(viewID.value, curImageID.value, {\n          min: range[0],\n          max: range[1],\n        });\n        windowingStore.resetWindowLevel(viewID.value, curImageID.value);\n      },\n      {\n        immediate: true,\n      }\n    );\n\n    // --- scene setup --- //\n\n    const labelmapStore = useLabelmapStore();\n\n    const labelmapIDs = computed(() => {\n      return labelmapStore.idList.filter(\n        (id) => labelmapStore.parentImage[id] === curImageID.value\n      );\n    });\n\n    const layerIDs = computed(() => currentLayers.value.map(({ id }) => id));\n\n    const { baseImageRep, labelmapReps, layerReps } = useSceneBuilder<\n      vtkIJKSliceRepresentationProxy,\n      vtkLabelMapSliceRepProxy,\n      vtkIJKSliceRepresentationProxy\n    >(viewID, {\n      baseImage: curImageID,\n      labelmaps: labelmapIDs,\n      layers: layerIDs,\n    });\n\n    // --- camera setup --- //\n\n    const { cameraDirVec, cameraUpVec } = useCameraOrientation(\n      viewDirection,\n      viewUp,\n      curImageMetadata\n    );\n    const { resizeToFit, ignoreResizeToFitTracking, resetResizeToFitTracking } =\n      useResizeToFit(viewProxy.value.getCamera(), false);\n\n    const resizeToFitScene = () =>\n      ignoreResizeToFitTracking(() => {\n        // resize to fit\n        const lookAxis =\n          curImageMetadata.value.lpsOrientation[\n            getLPSAxisFromDir(viewDirection.value)\n          ];\n        const upAxis =\n          curImageMetadata.value.lpsOrientation[\n            getLPSAxisFromDir(viewUp.value)\n          ];\n        const dimsWithSpacing = curImageMetadata.value.dimensions.map(\n          (d, i) => d * curImageMetadata.value.spacing[i]\n        );\n        viewProxy.value.resizeToFit(lookAxis, upAxis, dimsWithSpacing);\n        resetResizeToFitTracking();\n      });\n\n    const resetCamera = () => {\n      const bounds = curImageMetadata.value.worldBounds;\n      const center = [\n        (bounds[0] + bounds[1]) / 2,\n        (bounds[2] + bounds[3]) / 2,\n        (bounds[4] + bounds[5]) / 2,\n      ] as vec3;\n\n      // do not track resizeToFit state\n      ignoreResizeToFitTracking(() => {\n        viewProxy.value.updateCamera(\n          cameraDirVec.value,\n          cameraUpVec.value,\n          center\n        );\n        viewProxy.value.resetCamera(bounds);\n      });\n\n      resizeToFitScene();\n\n      viewProxy.value.renderLater();\n    };\n\n    manageVTKSubscription(\n      viewProxy.value.onResize(() => {\n        if (resizeToFit.value) {\n          resizeToFitScene();\n        }\n      })\n    );\n\n    // if we re-enable resizeToFit, reset the camera\n    watch(resizeToFit, () => {\n      if (resizeToFit.value) {\n        resetCamera();\n      }\n    });\n\n    const { restoreCameraConfig } = usePersistCameraConfig(\n      viewID,\n      curImageID,\n      viewProxy,\n      'parallelScale',\n      'position',\n      'focalPoint',\n      'viewUp'\n    );\n\n    watch(\n      [curImageID, cameraDirVec, cameraUpVec],\n      () => {\n        const cameraConfig = viewCameraStore.getConfig(\n          viewID.value,\n          curImageID.value\n        );\n\n        // If we have a saved camera configuration restore it\n        if (cameraConfig) {\n          restoreCameraConfig(cameraConfig);\n\n          viewProxy.value.getRenderer().resetCameraClippingRange();\n          viewProxy.value.renderLater();\n\n          // Prevent resize\n          resizeToFit.value = false;\n        } else if (resizeToFit.value) {\n          resetCamera();\n        } else {\n          // this will trigger a resetCamera() call\n          resizeToFit.value = true;\n        }\n      },\n      { immediate: true, deep: true }\n    );\n\n    // --- viewport orientation/camera labels --- //\n\n    const { top: topLabel, left: leftLabel } = useOrientationLabels(viewProxy);\n\n    // --- apply windowing and slice configs --- //\n\n    watchEffect(() => {\n      if (sliceConfig.value == null || wlConfig.value == null) {\n        return;\n      }\n\n      const { slice } = sliceConfig.value;\n      const { width, level } = wlConfig.value;\n      const rep = baseImageRep.value;\n      if (rep) {\n        rep.setSlice(slice);\n        rep.setWindowWidth(width);\n        rep.setWindowLevel(level);\n      }\n      [...layerReps.value, ...labelmapReps.value].forEach((lRep) => {\n        lRep.setSlice(slice);\n      });\n\n      viewProxy.value.renderLater();\n    });\n\n    // --- apply labelmap opacity --- //\n\n    watchEffect(() => {\n      const { labelmapOpacity } = paintStore;\n      labelmapReps.value.forEach((lmRep) => {\n        lmRep.setOpacity(labelmapOpacity);\n      });\n    });\n\n    // --- layers setup --- //\n\n    const layersConfigs = computed(() =>\n      layerIDs.value.map((id) => layerColoringStore.getConfig(viewID.value, id))\n    );\n\n    const layersStore = useLayersStore();\n    watch(\n      [viewID, currentLayers],\n      () => {\n        currentLayers.value.forEach(({ id }, layerIndex) => {\n          const image = layersStore.layerImages[id];\n          const layerConfig = layersConfigs.value[layerIndex];\n          if (image && !layerConfig) {\n            layerColoringStore.resetToDefault(viewID.value, id, image);\n          }\n        });\n      },\n      { immediate: true }\n    );\n\n    // --- layer coloring --- //\n\n    const proxyManager = useProxyManager()!;\n\n    const colorBys = computed(() =>\n      layersConfigs.value.map((config) => config?.colorBy)\n    );\n    const transferFunctions = computed(() =>\n      layersConfigs.value.map((config) => config?.transferFunction)\n    );\n    const opacityFunctions = computed(() =>\n      layersConfigs.value.map((config) => config?.opacityFunction)\n    );\n    const blendConfigs = computed(() =>\n      layersConfigs.value.map((config) => config?.blendConfig)\n    );\n\n    watch(\n      [layerReps, colorBys, transferFunctions, opacityFunctions, blendConfigs],\n      () => {\n        layerReps.value\n          .map(\n            (layerRep, idx) =>\n              [\n                layerRep,\n                colorBys.value[idx],\n                transferFunctions.value[idx],\n                opacityFunctions.value[idx],\n                blendConfigs.value[idx],\n              ] as const\n          )\n          .forEach(\n            ([\n              rep,\n              colorBy,\n              transferFunction,\n              opacityFunction,\n              blendConfig,\n            ]) => {\n              if (\n                !colorBy ||\n                !transferFunction ||\n                !opacityFunction ||\n                !blendConfig\n              ) {\n                return;\n              }\n\n              const { arrayName, location } = colorBy;\n              const ctFunc = transferFunction;\n              const opFunc = opacityFunction;\n\n              const lut = proxyManager.getLookupTable(arrayName);\n              lut.setMode(LookupTableProxyMode.Preset);\n              lut.setPresetName(ctFunc.preset);\n              lut.setDataRange(...ctFunc.mappingRange);\n\n              const pwf = proxyManager.getPiecewiseFunction(arrayName);\n              pwf.setMode(opFunc.mode);\n              pwf.setDataRange(...opFunc.mappingRange);\n\n              switch (opFunc.mode) {\n                case vtkPiecewiseFunctionProxy.Mode.Gaussians:\n                  pwf.setGaussians(opFunc.gaussians);\n                  break;\n                case vtkPiecewiseFunctionProxy.Mode.Points: {\n                  const opacityPoints = getShiftedOpacityFromPreset(\n                    opFunc.preset,\n                    opFunc.mappingRange,\n                    opFunc.shift\n                  );\n                  if (opacityPoints) {\n                    pwf.setPoints(opacityPoints);\n                  }\n                  break;\n                }\n                case vtkPiecewiseFunctionProxy.Mode.Nodes:\n                  pwf.setNodes(opFunc.nodes);\n                  break;\n                default:\n              }\n\n              // control color range manually\n              rep.setRescaleOnColorBy(false);\n              rep.setColorBy(arrayName, location);\n              rep.setOpacity(blendConfig.opacity);\n\n              // Need to trigger a render for when we are restoring from a state file\n              viewProxy.value.renderLater();\n            }\n          );\n      },\n      { immediate: true, deep: true }\n    );\n\n    return {\n      vtkContainerRef,\n      toolContainer,\n      viewID,\n      viewProxy,\n      viewAxis,\n      active: true,\n      currentSlice,\n      sliceMin,\n      sliceMax,\n      windowWidth,\n      windowLevel,\n      topLabel,\n      leftLabel,\n      isImageLoading,\n      setSlice,\n      widgetManager,\n      dicomInfo,\n      enableResizeToFit() {\n        resizeToFit.value = true;\n      },\n      hover,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n<style scoped src=\"@/src/components/styles/utils.css\"></style>\n<style scoped>\n.hover-info {\n  width: 32px;\n  height: 32px;\n  cursor: pointer;\n}\n</style>\n","import vtkViewProxy from '@kitware/vtk.js/Proxy/Core/ViewProxy';\nimport { computed, ref, unref } from 'vue';\nimport { MaybeRef } from '@vueuse/core';\nimport { useVTKCallback } from './useVTKCallback';\n\nexport function isViewAnimating(viewProxy: MaybeRef<vtkViewProxy>) {\n  const isAnimating = ref(false);\n\n  const onStartAnimation = useVTKCallback(\n    computed(() => unref(viewProxy).getInteractor().onStartAnimation)\n  );\n  const onEndAnimation = useVTKCallback(\n    computed(() => unref(viewProxy).getInteractor().onEndAnimation)\n  );\n\n  onStartAnimation(() => {\n    isAnimating.value = true;\n  });\n\n  onEndAnimation(() => {\n    isAnimating.value = false;\n  });\n\n  return isAnimating;\n}\n","<template>\n  <div class=\"vtk-container-wrapper vtk-three-container\">\n    <div class=\"vtk-container\" :class=\"active ? 'active' : ''\">\n      <div class=\"vtk-sub-container\">\n        <div class=\"vtk-view\" ref=\"vtkContainerRef\" />\n      </div>\n      <div class=\"overlay-no-events tool-layer\">\n        <crop-tool :view-id=\"viewID\" />\n        <pan-tool :view-id=\"viewID\" />\n      </div>\n      <view-overlay-grid class=\"overlay-no-events view-annotations\">\n        <template v-slot:top-left>\n          <div class=\"annotation-cell\">\n            <v-btn\n              class=\"pointer-events-all\"\n              dark\n              icon\n              size=\"medium\"\n              variant=\"text\"\n              @click=\"resetCamera\"\n            >\n              <v-icon size=\"medium\" class=\"py-1\">\n                mdi-camera-flip-outline\n              </v-icon>\n              <v-tooltip\n                location=\"right\"\n                activator=\"parent\"\n                transition=\"slide-x-transition\"\n              >\n                Reset Camera\n              </v-tooltip>\n            </v-btn>\n            <span class=\"ml-3\">{{ topLeftLabel }}</span>\n          </div>\n        </template>\n      </view-overlay-grid>\n      <transition name=\"loading\">\n        <div v-if=\"isImageLoading\" class=\"overlay-no-events loading\">\n          <div>Loading the image</div>\n          <div>\n            <v-progress-circular indeterminate color=\"blue\" />\n          </div>\n        </div>\n      </transition>\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport {\n  computed,\n  defineComponent,\n  onBeforeUnmount,\n  onMounted,\n  PropType,\n  provide,\n  ref,\n  toRefs,\n  watch,\n  Ref,\n  nextTick,\n} from 'vue';\nimport { computedWithControl } from '@vueuse/core';\nimport { vec3 } from 'gl-matrix';\n\nimport vtkVolumeRepresentationProxy from '@kitware/vtk.js/Proxy/Representations/VolumeRepresentationProxy';\nimport { Mode as LookupTableProxyMode } from '@kitware/vtk.js/Proxy/Core/LookupTableProxy';\nimport vtkPiecewiseFunctionProxy from '@kitware/vtk.js/Proxy/Core/PiecewiseFunctionProxy';\nimport vtkVolumeMapper from '@kitware/vtk.js/Rendering/Core/VolumeMapper';\nimport vtkImageData from '@kitware/vtk.js/Common/DataModel/ImageData';\nimport { getDiagonalLength } from '@kitware/vtk.js/Common/DataModel/BoundingBox';\nimport type { Vector3 } from '@kitware/vtk.js/types';\n\nimport { useProxyManager } from '@/src/composables/proxyManager';\nimport ViewOverlayGrid from '@src/components/ViewOverlayGrid.vue';\nimport { useResizeObserver } from '../composables/useResizeObserver';\nimport { useCurrentImage } from '../composables/useCurrentImage';\nimport { useCameraOrientation } from '../composables/useCameraOrientation';\nimport vtkLPSView3DProxy from '../vtk/LPSView3DProxy';\nimport { useSceneBuilder } from '../composables/useSceneBuilder';\nimport { usePersistCameraConfig } from '../composables/usePersistCameraConfig';\nimport { useModelStore } from '../store/datasets-models';\nimport { LPSAxisDir } from '../types/lps';\nimport { useViewProxy } from '../composables/useViewProxy';\nimport { ViewProxyType } from '../core/proxies';\nimport { VolumeColorConfig } from '../store/view-configs/types';\nimport useVolumeColoringStore, {\n  DEFAULT_AMBIENT,\n  DEFAULT_DIFFUSE,\n  DEFAULT_SPECULAR,\n} from '../store/view-configs/volume-coloring';\nimport { getShiftedOpacityFromPreset } from '../utils/vtk-helpers';\nimport CropTool from './tools/CropTool.vue';\nimport PanTool from './tools/PanTool.vue';\nimport { useWidgetManager } from '../composables/useWidgetManager';\nimport { VTKThreeViewWidgetManager } from '../constants';\nimport { useCropStore, croppingPlanesEqual } from '../store/tools/crop';\nimport { isViewAnimating } from '../composables/isViewAnimating';\nimport { ColoringConfig } from '../types/views';\nimport useViewCameraStore from '../store/view-configs/camera';\nimport { Maybe } from '../types';\n\nfunction useCvrEffect(\n  config: Ref<Maybe<VolumeColorConfig>>,\n  imageRep: Ref<vtkVolumeRepresentationProxy | null>,\n  viewProxy: Ref<vtkLPSView3DProxy>\n) {\n  const cvrParams = computed(() => config.value?.cvr);\n  const repMapper = computedWithControl(\n    imageRep,\n    () => imageRep.value?.getMapper() as vtkVolumeMapper | undefined\n  );\n  const image = computedWithControl(\n    imageRep,\n    () => imageRep.value?.getInputDataSet() as vtkImageData | null | undefined\n  );\n  const volume = computedWithControl(\n    imageRep,\n    () => imageRep.value?.getVolumes()[0]\n  );\n  const renderer = computed(() => viewProxy.value.getRenderer());\n  const isAnimating = isViewAnimating(viewProxy);\n  const cvrEnabled = computed(() => {\n    const enabled = !!cvrParams.value?.enabled;\n    const animating = isAnimating.value;\n    return enabled && !animating;\n  });\n\n  const requestRender = () => {\n    if (!isAnimating.value) {\n      viewProxy.value.renderLater();\n    }\n  };\n\n  // lights\n  const volumeCenter = computed(() => {\n    if (!volume.value) return null;\n    const volumeBounds = volume.value.getBounds();\n    return [\n      (volumeBounds[0] + volumeBounds[1]) / 2,\n      (volumeBounds[2] + volumeBounds[3]) / 2,\n      (volumeBounds[4] + volumeBounds[5]) / 2,\n    ] as Vector3;\n  });\n  const lightFollowsCamera = computed(\n    () => cvrParams.value?.lightFollowsCamera ?? true\n  );\n\n  watch(\n    [volumeCenter, renderer, cvrEnabled, lightFollowsCamera],\n    ([center, ren, enabled, lightFollowsCamera_]) => {\n      if (!center) return;\n\n      if (ren.getLights().length === 0) {\n        ren.createLight();\n      }\n      const light = ren.getLights()[0];\n      if (enabled) {\n        light.setFocalPoint(...center);\n        light.setColor(1, 1, 1);\n        light.setIntensity(1);\n        light.setConeAngle(90);\n        light.setPositional(true);\n        ren.setTwoSidedLighting(false);\n        if (lightFollowsCamera_) {\n          light.setLightTypeToHeadLight();\n          ren.updateLightsGeometryToFollowCamera();\n        } else {\n          light.setLightTypeToSceneLight();\n        }\n      } else {\n        light.setPositional(false);\n      }\n\n      requestRender();\n    },\n    { immediate: true }\n  );\n\n  // sampling distance\n  const volumeQuality = computed(() => cvrParams.value?.volumeQuality);\n\n  watch(\n    [volume, image, repMapper, volumeQuality, cvrEnabled, isAnimating],\n    ([volume_, image_, mapper, volumeQuality_, enabled, animating]) => {\n      if (!volume_ || !mapper || volumeQuality_ == null || !image_) return;\n\n      if (animating) {\n        mapper.setSampleDistance(0.75);\n        mapper.setMaximumSamplesPerRay(1000);\n        mapper.setGlobalIlluminationReach(0);\n        mapper.setComputeNormalFromOpacity(false);\n      } else {\n        const dims = image_.getDimensions();\n        const spacing = image_.getSpacing();\n        const spatialDiagonal = vec3.length(\n          vec3.fromValues(\n            dims[0] * spacing[0],\n            dims[1] * spacing[1],\n            dims[2] * spacing[2]\n          )\n        );\n\n        // Use the average spacing for sampling by default\n        let sampleDistance = spacing.reduce((a, b) => a + b) / 3.0;\n        // Adjust the volume sampling by the quality slider value\n        sampleDistance /= volumeQuality_ > 1 ? 0.5 * volumeQuality_ ** 2 : 1.0;\n        const samplesPerRay = spatialDiagonal / sampleDistance + 1;\n        mapper.setMaximumSamplesPerRay(samplesPerRay);\n        mapper.setSampleDistance(sampleDistance);\n        // Adjust the global illumination reach by volume quality slider\n        mapper.setGlobalIlluminationReach(enabled ? 0.25 * volumeQuality_ : 0);\n        mapper.setComputeNormalFromOpacity(!enabled && volumeQuality_ > 2);\n      }\n\n      requestRender();\n    },\n    { immediate: true }\n  );\n\n  // volume properties\n  const ambient = computed(() => cvrParams.value?.ambient ?? 0);\n  const diffuse = computed(() => cvrParams.value?.diffuse ?? 0);\n  const specular = computed(() => cvrParams.value?.specular ?? 0);\n\n  watch(\n    [volume, image, ambient, diffuse, specular, cvrEnabled],\n    ([volume_, image_, ambient_, diffuse_, specular_, enabled]) => {\n      if (!volume_ || !image_) return;\n\n      const property = volume_.getProperty();\n      property.setScalarOpacityUnitDistance(\n        0,\n        (0.5 * getDiagonalLength(image_.getBounds())) /\n          Math.max(...image_.getDimensions())\n      );\n\n      property.setShade(true);\n      property.setUseGradientOpacity(0, !enabled);\n      property.setGradientOpacityMinimumValue(0, 0.0);\n      const dataRange = image_.getPointData().getScalars().getRange();\n      property.setGradientOpacityMaximumValue(\n        0,\n        (dataRange[1] - dataRange[0]) * 0.01\n      );\n      property.setGradientOpacityMinimumOpacity(0, 0.0);\n      property.setGradientOpacityMinimumOpacity(0, 1.0);\n\n      // do not toggle these parameters when animating\n      property.setAmbient(enabled ? ambient_ : DEFAULT_AMBIENT);\n      property.setDiffuse(enabled ? diffuse_ : DEFAULT_DIFFUSE);\n      property.setSpecular(enabled ? specular_ : DEFAULT_SPECULAR);\n\n      requestRender();\n    },\n    { immediate: true }\n  );\n\n  // volumetric scattering blending\n  const useVolumetricScatteringBlending = computed(\n    () => cvrParams.value?.useVolumetricScatteringBlending ?? false\n  );\n  const volumetricScatteringBlending = computed(\n    () => cvrParams.value?.volumetricScatteringBlending ?? 0\n  );\n\n  watch(\n    [\n      useVolumetricScatteringBlending,\n      volumetricScatteringBlending,\n      repMapper,\n      cvrEnabled,\n    ],\n    ([useVsb, vsb, mapper, enabled]) => {\n      if (!mapper) return;\n\n      if (enabled && useVsb) {\n        mapper.setVolumetricScatteringBlending(vsb);\n      } else {\n        mapper.setVolumetricScatteringBlending(0);\n      }\n\n      requestRender();\n    },\n    { immediate: true }\n  );\n\n  // local ambient occlusion\n  const useLocalAmbientOcclusion = computed(\n    () => cvrParams.value?.useLocalAmbientOcclusion ?? false\n  );\n  const laoKernelSize = computed(() => cvrParams.value?.laoKernelSize ?? 0);\n  const laoKernelRadius = computed(() => cvrParams.value?.laoKernelRadius ?? 0);\n\n  watch(\n    [\n      useLocalAmbientOcclusion,\n      laoKernelSize,\n      laoKernelRadius,\n      repMapper,\n      cvrEnabled,\n    ],\n    ([useLao, kernelSize, kernelRadius, mapper, enabled]) => {\n      if (!mapper) return;\n\n      if (enabled && useLao) {\n        mapper.setLocalAmbientOcclusion(true);\n        mapper.setLAOKernelSize(kernelSize);\n        mapper.setLAOKernelRadius(kernelRadius);\n      } else {\n        mapper.setLocalAmbientOcclusion(false);\n        mapper.setLAOKernelSize(0);\n        mapper.setLAOKernelRadius(0);\n      }\n\n      requestRender();\n    },\n    { immediate: true }\n  );\n}\n\nfunction useColoringEffect(\n  config: Ref<Maybe<ColoringConfig>>,\n  imageRep: Ref<vtkVolumeRepresentationProxy | null>,\n  viewProxy: Ref<vtkLPSView3DProxy>\n) {\n  const colorBy = computed(() => config.value?.colorBy);\n  const colorTransferFunction = computed(() => config.value?.transferFunction);\n  const opacityFunction = computed(() => config.value?.opacityFunction);\n\n  const proxyManager = useProxyManager();\n\n  watch(\n    [imageRep, colorBy, colorTransferFunction, opacityFunction],\n    ([rep, colorBy_, colorFunc, opacityFunc]) => {\n      if (!rep || !colorBy_ || !colorFunc || !opacityFunc || !proxyManager) {\n        return;\n      }\n\n      const { arrayName, location } = colorBy_;\n\n      const lut = proxyManager.getLookupTable(arrayName);\n      lut.setMode(LookupTableProxyMode.Preset);\n      lut.setPresetName(colorFunc.preset);\n      lut.setDataRange(...colorFunc.mappingRange);\n\n      const pwf = proxyManager.getPiecewiseFunction(arrayName);\n      pwf.setMode(opacityFunc.mode);\n      pwf.setDataRange(...opacityFunc.mappingRange);\n\n      switch (opacityFunc.mode) {\n        case vtkPiecewiseFunctionProxy.Mode.Gaussians:\n          pwf.setGaussians(opacityFunc.gaussians);\n          break;\n        case vtkPiecewiseFunctionProxy.Mode.Points: {\n          const opacityPoints = getShiftedOpacityFromPreset(\n            opacityFunc.preset,\n            opacityFunc.mappingRange,\n            opacityFunc.shift\n          );\n          if (opacityPoints) {\n            pwf.setPoints(opacityPoints);\n          }\n          break;\n        }\n        case vtkPiecewiseFunctionProxy.Mode.Nodes:\n          pwf.setNodes(opacityFunc.nodes);\n          break;\n        default:\n      }\n\n      if (rep) {\n        // control color range manually\n        rep.setRescaleOnColorBy(false);\n        rep.setColorBy(arrayName, location);\n      }\n\n      // Need to trigger a render for when we are restoring from a state file\n      viewProxy.value.renderLater();\n    },\n    { immediate: true }\n  );\n}\n\nexport default defineComponent({\n  props: {\n    id: {\n      type: String,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    viewUp: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n  },\n  components: {\n    ViewOverlayGrid,\n    CropTool,\n    PanTool,\n  },\n  setup(props) {\n    const modelStore = useModelStore();\n    const volumeColoringStore = useVolumeColoringStore();\n    const viewCameraStore = useViewCameraStore();\n\n    const { id: viewID, viewDirection, viewUp } = toRefs(props);\n\n    const vtkContainerRef = ref<HTMLElement>();\n\n    // --- computed vars --- //\n\n    const {\n      currentImageID: curImageID,\n      currentImageMetadata: curImageMetadata,\n      currentImageData,\n      isImageLoading,\n    } = useCurrentImage();\n\n    // --- view proxy setup --- //\n\n    const { viewProxy, setContainer: setViewProxyContainer } =\n      useViewProxy<vtkLPSView3DProxy>(viewID, ViewProxyType.Volume);\n\n    onMounted(() => {\n      viewProxy.value.setOrientationAxesVisibility(true);\n      viewProxy.value.setOrientationAxesType('cube');\n      viewProxy.value.setBackground([0, 0, 0, 0]);\n      setViewProxyContainer(vtkContainerRef.value);\n    });\n\n    onBeforeUnmount(() => {\n      setViewProxyContainer(null);\n      viewProxy.value.setContainer(null);\n    });\n\n    useResizeObserver(vtkContainerRef, () => viewProxy.value.resize());\n\n    // --- scene setup --- //\n\n    const { baseImageRep } = useSceneBuilder<vtkVolumeRepresentationProxy>(\n      viewID,\n      {\n        baseImage: curImageID,\n        models: computed(() => modelStore.idList),\n      }\n    );\n\n    // --- picking --- //\n\n    // disables picking for crop control and more\n    watch(\n      baseImageRep,\n      (rep) => {\n        if (rep) {\n          rep.getVolumes().forEach((volume) => volume.setPickable(false));\n        }\n      },\n      { immediate: true }\n    );\n\n    // --- widget manager --- //\n\n    const { widgetManager } = useWidgetManager(viewProxy);\n    provide(VTKThreeViewWidgetManager, widgetManager);\n\n    // --- camera setup --- //\n\n    const { cameraUpVec, cameraDirVec } = useCameraOrientation(\n      viewDirection,\n      viewUp,\n      curImageMetadata\n    );\n\n    const resetCamera = () => {\n      const bounds = curImageMetadata.value.worldBounds;\n      const center = [\n        (bounds[0] + bounds[1]) / 2,\n        (bounds[2] + bounds[3]) / 2,\n        (bounds[4] + bounds[5]) / 2,\n      ] as vec3;\n\n      viewProxy.value.updateCamera(\n        cameraDirVec.value,\n        cameraUpVec.value,\n        center\n      );\n      viewProxy.value.resetCamera();\n      viewProxy.value.renderLater();\n    };\n\n    watch(\n      [baseImageRep, cameraDirVec, cameraUpVec],\n      () => {\n        const cameraConfig = viewCameraStore.getConfig(\n          viewID.value,\n          curImageID.value\n        );\n\n        // We don't want to reset the camera if we have a config we are restoring\n        if (!cameraConfig) {\n          // nextTick ensures resetCamera gets called after\n          // useSceneBuilder refreshes the scene.\n          nextTick(resetCamera);\n        }\n      },\n      {\n        immediate: true,\n      }\n    );\n\n    const { restoreCameraConfig } = usePersistCameraConfig(\n      viewID,\n      curImageID,\n      viewProxy,\n      'position',\n      'focalPoint',\n      'directionOfProjection',\n      'viewUp'\n    );\n\n    watch(curImageID, () => {\n      // See if we have a camera configuration to restore\n      const cameraConfig = viewCameraStore.getConfig(\n        viewID.value,\n        curImageID.value\n      );\n\n      if (cameraConfig) {\n        restoreCameraConfig(cameraConfig);\n\n        viewProxy.value.getRenderer().resetCameraClippingRange();\n        viewProxy.value.renderLater();\n      }\n    });\n\n    // --- coloring setup --- //\n\n    const volumeColorConfig = computed(() =>\n      volumeColoringStore.getConfig(viewID.value, curImageID.value)\n    );\n\n    watch(\n      [viewID, curImageID],\n      () => {\n        if (\n          curImageID.value &&\n          currentImageData.value &&\n          !volumeColorConfig.value\n        ) {\n          volumeColoringStore.resetToDefaultColoring(\n            viewID.value,\n            curImageID.value,\n            currentImageData.value\n          );\n        }\n      },\n      { immediate: true }\n    );\n\n    // --- CVR parameters --- //\n\n    useCvrEffect(volumeColorConfig, baseImageRep, viewProxy);\n\n    // --- coloring --- //\n\n    useColoringEffect(volumeColorConfig, baseImageRep, viewProxy);\n\n    // --- cropping planes --- //\n\n    const cropStore = useCropStore();\n    const croppingPlanes = cropStore.getComputedVTKPlanes(curImageID);\n\n    watch(\n      croppingPlanes,\n      (planes, oldPlanes) => {\n        const mapper = baseImageRep.value?.getMapper();\n        if (\n          !mapper ||\n          !planes ||\n          (oldPlanes && croppingPlanesEqual(planes, oldPlanes))\n        )\n          return;\n\n        mapper.removeAllClippingPlanes();\n        planes.forEach((plane) => mapper.addClippingPlane(plane));\n        mapper.modified();\n        viewProxy.value.renderLater();\n      },\n      { immediate: true }\n    );\n\n    // --- template vars --- //\n\n    return {\n      vtkContainerRef,\n      viewID,\n      active: false,\n      topLeftLabel: computed(\n        () =>\n          volumeColorConfig.value?.transferFunction.preset.replace(/-/g, ' ') ??\n          ''\n      ),\n      isImageLoading,\n      resetCamera,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n<style scoped src=\"@/src/components/styles/utils.css\"></style>\n\n<style scoped>\n.vtk-three-container {\n  background-color: black;\n  grid-template-columns: auto;\n}\n</style>\n","<template>\n  <div class=\"vtk-container-wrapper vtk-three-container\">\n    <div class=\"vtk-container\" :class=\"active ? 'active' : ''\">\n      <div class=\"vtk-sub-container\">\n        <div class=\"vtk-view\" ref=\"vtkContainerRef\" />\n      </div>\n      <div class=\"overlay-no-events tool-layer\">\n        <crop-tool :view-id=\"viewID\" />\n        <pan-tool :view-id=\"viewID\" />\n      </div>\n      <view-overlay-grid class=\"overlay-no-events view-annotations\">\n        <template v-slot:top-left>\n          <div class=\"annotation-cell\">\n            <v-btn\n              class=\"pointer-events-all\"\n              dark\n              icon\n              size=\"medium\"\n              variant=\"text\"\n              @click=\"resetCamera\"\n            >\n              <v-icon size=\"medium\" class=\"py-1\">\n                mdi-camera-flip-outline\n              </v-icon>\n              <v-tooltip\n                location=\"right\"\n                activator=\"parent\"\n                transition=\"slide-x-transition\"\n              >\n                Reset Camera\n              </v-tooltip>\n            </v-btn>\n            <span class=\"ml-3\">{{ topLeftLabel }}</span>\n          </div>\n        </template>\n      </view-overlay-grid>\n      <transition name=\"loading\">\n        <div v-if=\"isImageLoading\" class=\"overlay-no-events loading\">\n          <div>Loading the image</div>\n          <div>\n            <v-progress-circular indeterminate color=\"blue\" />\n          </div>\n        </div>\n      </transition>\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport {\n  computed,\n  defineComponent,\n  onBeforeUnmount,\n  onMounted,\n  PropType,\n  provide,\n  ref,\n  toRefs,\n  watch,\n  Ref,\n  nextTick,\n} from 'vue';\nimport { computedWithControl } from '@vueuse/core';\nimport { vec3 } from 'gl-matrix';\n\nimport vtkVolumeRepresentationProxy from '@kitware/vtk.js/Proxy/Representations/VolumeRepresentationProxy';\nimport { Mode as LookupTableProxyMode } from '@kitware/vtk.js/Proxy/Core/LookupTableProxy';\nimport vtkPiecewiseFunctionProxy from '@kitware/vtk.js/Proxy/Core/PiecewiseFunctionProxy';\nimport vtkVolumeMapper from '@kitware/vtk.js/Rendering/Core/VolumeMapper';\nimport vtkImageData from '@kitware/vtk.js/Common/DataModel/ImageData';\nimport { getDiagonalLength } from '@kitware/vtk.js/Common/DataModel/BoundingBox';\nimport type { Vector3 } from '@kitware/vtk.js/types';\n\nimport { useProxyManager } from '@/src/composables/proxyManager';\nimport ViewOverlayGrid from '@src/components/ViewOverlayGrid.vue';\nimport { useResizeObserver } from '../composables/useResizeObserver';\nimport { useCurrentImage } from '../composables/useCurrentImage';\nimport { useCameraOrientation } from '../composables/useCameraOrientation';\nimport vtkLPSView3DProxy from '../vtk/LPSView3DProxy';\nimport { useSceneBuilder } from '../composables/useSceneBuilder';\nimport { usePersistCameraConfig } from '../composables/usePersistCameraConfig';\nimport { useModelStore } from '../store/datasets-models';\nimport { LPSAxisDir } from '../types/lps';\nimport { useViewProxy } from '../composables/useViewProxy';\nimport { ViewProxyType } from '../core/proxies';\nimport { VolumeColorConfig } from '../store/view-configs/types';\nimport useVolumeColoringStore, {\n  DEFAULT_AMBIENT,\n  DEFAULT_DIFFUSE,\n  DEFAULT_SPECULAR,\n} from '../store/view-configs/volume-coloring';\nimport { getShiftedOpacityFromPreset } from '../utils/vtk-helpers';\nimport CropTool from './tools/CropTool.vue';\nimport PanTool from './tools/PanTool.vue';\nimport { useWidgetManager } from '../composables/useWidgetManager';\nimport { VTKThreeViewWidgetManager } from '../constants';\nimport { useCropStore, croppingPlanesEqual } from '../store/tools/crop';\nimport { isViewAnimating } from '../composables/isViewAnimating';\nimport { ColoringConfig } from '../types/views';\nimport useViewCameraStore from '../store/view-configs/camera';\nimport { Maybe } from '../types';\n\nfunction useCvrEffect(\n  config: Ref<Maybe<VolumeColorConfig>>,\n  imageRep: Ref<vtkVolumeRepresentationProxy | null>,\n  viewProxy: Ref<vtkLPSView3DProxy>\n) {\n  const cvrParams = computed(() => config.value?.cvr);\n  const repMapper = computedWithControl(\n    imageRep,\n    () => imageRep.value?.getMapper() as vtkVolumeMapper | undefined\n  );\n  const image = computedWithControl(\n    imageRep,\n    () => imageRep.value?.getInputDataSet() as vtkImageData | null | undefined\n  );\n  const volume = computedWithControl(\n    imageRep,\n    () => imageRep.value?.getVolumes()[0]\n  );\n  const renderer = computed(() => viewProxy.value.getRenderer());\n  const isAnimating = isViewAnimating(viewProxy);\n  const cvrEnabled = computed(() => {\n    const enabled = !!cvrParams.value?.enabled;\n    const animating = isAnimating.value;\n    return enabled && !animating;\n  });\n\n  const requestRender = () => {\n    if (!isAnimating.value) {\n      viewProxy.value.renderLater();\n    }\n  };\n\n  // lights\n  const volumeCenter = computed(() => {\n    if (!volume.value) return null;\n    const volumeBounds = volume.value.getBounds();\n    return [\n      (volumeBounds[0] + volumeBounds[1]) / 2,\n      (volumeBounds[2] + volumeBounds[3]) / 2,\n      (volumeBounds[4] + volumeBounds[5]) / 2,\n    ] as Vector3;\n  });\n  const lightFollowsCamera = computed(\n    () => cvrParams.value?.lightFollowsCamera ?? true\n  );\n\n  watch(\n    [volumeCenter, renderer, cvrEnabled, lightFollowsCamera],\n    ([center, ren, enabled, lightFollowsCamera_]) => {\n      if (!center) return;\n\n      if (ren.getLights().length === 0) {\n        ren.createLight();\n      }\n      const light = ren.getLights()[0];\n      if (enabled) {\n        light.setFocalPoint(...center);\n        light.setColor(1, 1, 1);\n        light.setIntensity(1);\n        light.setConeAngle(90);\n        light.setPositional(true);\n        ren.setTwoSidedLighting(false);\n        if (lightFollowsCamera_) {\n          light.setLightTypeToHeadLight();\n          ren.updateLightsGeometryToFollowCamera();\n        } else {\n          light.setLightTypeToSceneLight();\n        }\n      } else {\n        light.setPositional(false);\n      }\n\n      requestRender();\n    },\n    { immediate: true }\n  );\n\n  // sampling distance\n  const volumeQuality = computed(() => cvrParams.value?.volumeQuality);\n\n  watch(\n    [volume, image, repMapper, volumeQuality, cvrEnabled, isAnimating],\n    ([volume_, image_, mapper, volumeQuality_, enabled, animating]) => {\n      if (!volume_ || !mapper || volumeQuality_ == null || !image_) return;\n\n      if (animating) {\n        mapper.setSampleDistance(0.75);\n        mapper.setMaximumSamplesPerRay(1000);\n        mapper.setGlobalIlluminationReach(0);\n        mapper.setComputeNormalFromOpacity(false);\n      } else {\n        const dims = image_.getDimensions();\n        const spacing = image_.getSpacing();\n        const spatialDiagonal = vec3.length(\n          vec3.fromValues(\n            dims[0] * spacing[0],\n            dims[1] * spacing[1],\n            dims[2] * spacing[2]\n          )\n        );\n\n        // Use the average spacing for sampling by default\n        let sampleDistance = spacing.reduce((a, b) => a + b) / 3.0;\n        // Adjust the volume sampling by the quality slider value\n        sampleDistance /= volumeQuality_ > 1 ? 0.5 * volumeQuality_ ** 2 : 1.0;\n        const samplesPerRay = spatialDiagonal / sampleDistance + 1;\n        mapper.setMaximumSamplesPerRay(samplesPerRay);\n        mapper.setSampleDistance(sampleDistance);\n        // Adjust the global illumination reach by volume quality slider\n        mapper.setGlobalIlluminationReach(enabled ? 0.25 * volumeQuality_ : 0);\n        mapper.setComputeNormalFromOpacity(!enabled && volumeQuality_ > 2);\n      }\n\n      requestRender();\n    },\n    { immediate: true }\n  );\n\n  // volume properties\n  const ambient = computed(() => cvrParams.value?.ambient ?? 0);\n  const diffuse = computed(() => cvrParams.value?.diffuse ?? 0);\n  const specular = computed(() => cvrParams.value?.specular ?? 0);\n\n  watch(\n    [volume, image, ambient, diffuse, specular, cvrEnabled],\n    ([volume_, image_, ambient_, diffuse_, specular_, enabled]) => {\n      if (!volume_ || !image_) return;\n\n      const property = volume_.getProperty();\n      property.setScalarOpacityUnitDistance(\n        0,\n        (0.5 * getDiagonalLength(image_.getBounds())) /\n          Math.max(...image_.getDimensions())\n      );\n\n      property.setShade(true);\n      property.setUseGradientOpacity(0, !enabled);\n      property.setGradientOpacityMinimumValue(0, 0.0);\n      const dataRange = image_.getPointData().getScalars().getRange();\n      property.setGradientOpacityMaximumValue(\n        0,\n        (dataRange[1] - dataRange[0]) * 0.01\n      );\n      property.setGradientOpacityMinimumOpacity(0, 0.0);\n      property.setGradientOpacityMinimumOpacity(0, 1.0);\n\n      // do not toggle these parameters when animating\n      property.setAmbient(enabled ? ambient_ : DEFAULT_AMBIENT);\n      property.setDiffuse(enabled ? diffuse_ : DEFAULT_DIFFUSE);\n      property.setSpecular(enabled ? specular_ : DEFAULT_SPECULAR);\n\n      requestRender();\n    },\n    { immediate: true }\n  );\n\n  // volumetric scattering blending\n  const useVolumetricScatteringBlending = computed(\n    () => cvrParams.value?.useVolumetricScatteringBlending ?? false\n  );\n  const volumetricScatteringBlending = computed(\n    () => cvrParams.value?.volumetricScatteringBlending ?? 0\n  );\n\n  watch(\n    [\n      useVolumetricScatteringBlending,\n      volumetricScatteringBlending,\n      repMapper,\n      cvrEnabled,\n    ],\n    ([useVsb, vsb, mapper, enabled]) => {\n      if (!mapper) return;\n\n      if (enabled && useVsb) {\n        mapper.setVolumetricScatteringBlending(vsb);\n      } else {\n        mapper.setVolumetricScatteringBlending(0);\n      }\n\n      requestRender();\n    },\n    { immediate: true }\n  );\n\n  // local ambient occlusion\n  const useLocalAmbientOcclusion = computed(\n    () => cvrParams.value?.useLocalAmbientOcclusion ?? false\n  );\n  const laoKernelSize = computed(() => cvrParams.value?.laoKernelSize ?? 0);\n  const laoKernelRadius = computed(() => cvrParams.value?.laoKernelRadius ?? 0);\n\n  watch(\n    [\n      useLocalAmbientOcclusion,\n      laoKernelSize,\n      laoKernelRadius,\n      repMapper,\n      cvrEnabled,\n    ],\n    ([useLao, kernelSize, kernelRadius, mapper, enabled]) => {\n      if (!mapper) return;\n\n      if (enabled && useLao) {\n        mapper.setLocalAmbientOcclusion(true);\n        mapper.setLAOKernelSize(kernelSize);\n        mapper.setLAOKernelRadius(kernelRadius);\n      } else {\n        mapper.setLocalAmbientOcclusion(false);\n        mapper.setLAOKernelSize(0);\n        mapper.setLAOKernelRadius(0);\n      }\n\n      requestRender();\n    },\n    { immediate: true }\n  );\n}\n\nfunction useColoringEffect(\n  config: Ref<Maybe<ColoringConfig>>,\n  imageRep: Ref<vtkVolumeRepresentationProxy | null>,\n  viewProxy: Ref<vtkLPSView3DProxy>\n) {\n  const colorBy = computed(() => config.value?.colorBy);\n  const colorTransferFunction = computed(() => config.value?.transferFunction);\n  const opacityFunction = computed(() => config.value?.opacityFunction);\n\n  const proxyManager = useProxyManager();\n\n  watch(\n    [imageRep, colorBy, colorTransferFunction, opacityFunction],\n    ([rep, colorBy_, colorFunc, opacityFunc]) => {\n      if (!rep || !colorBy_ || !colorFunc || !opacityFunc || !proxyManager) {\n        return;\n      }\n\n      const { arrayName, location } = colorBy_;\n\n      const lut = proxyManager.getLookupTable(arrayName);\n      lut.setMode(LookupTableProxyMode.Preset);\n      lut.setPresetName(colorFunc.preset);\n      lut.setDataRange(...colorFunc.mappingRange);\n\n      const pwf = proxyManager.getPiecewiseFunction(arrayName);\n      pwf.setMode(opacityFunc.mode);\n      pwf.setDataRange(...opacityFunc.mappingRange);\n\n      switch (opacityFunc.mode) {\n        case vtkPiecewiseFunctionProxy.Mode.Gaussians:\n          pwf.setGaussians(opacityFunc.gaussians);\n          break;\n        case vtkPiecewiseFunctionProxy.Mode.Points: {\n          const opacityPoints = getShiftedOpacityFromPreset(\n            opacityFunc.preset,\n            opacityFunc.mappingRange,\n            opacityFunc.shift\n          );\n          if (opacityPoints) {\n            pwf.setPoints(opacityPoints);\n          }\n          break;\n        }\n        case vtkPiecewiseFunctionProxy.Mode.Nodes:\n          pwf.setNodes(opacityFunc.nodes);\n          break;\n        default:\n      }\n\n      if (rep) {\n        // control color range manually\n        rep.setRescaleOnColorBy(false);\n        rep.setColorBy(arrayName, location);\n      }\n\n      // Need to trigger a render for when we are restoring from a state file\n      viewProxy.value.renderLater();\n    },\n    { immediate: true }\n  );\n}\n\nexport default defineComponent({\n  props: {\n    id: {\n      type: String,\n      required: true,\n    },\n    viewDirection: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n    viewUp: {\n      type: String as PropType<LPSAxisDir>,\n      required: true,\n    },\n  },\n  components: {\n    ViewOverlayGrid,\n    CropTool,\n    PanTool,\n  },\n  setup(props) {\n    const modelStore = useModelStore();\n    const volumeColoringStore = useVolumeColoringStore();\n    const viewCameraStore = useViewCameraStore();\n\n    const { id: viewID, viewDirection, viewUp } = toRefs(props);\n\n    const vtkContainerRef = ref<HTMLElement>();\n\n    // --- computed vars --- //\n\n    const {\n      currentImageID: curImageID,\n      currentImageMetadata: curImageMetadata,\n      currentImageData,\n      isImageLoading,\n    } = useCurrentImage();\n\n    // --- view proxy setup --- //\n\n    const { viewProxy, setContainer: setViewProxyContainer } =\n      useViewProxy<vtkLPSView3DProxy>(viewID, ViewProxyType.Volume);\n\n    onMounted(() => {\n      viewProxy.value.setOrientationAxesVisibility(true);\n      viewProxy.value.setOrientationAxesType('cube');\n      viewProxy.value.setBackground([0, 0, 0, 0]);\n      setViewProxyContainer(vtkContainerRef.value);\n    });\n\n    onBeforeUnmount(() => {\n      setViewProxyContainer(null);\n      viewProxy.value.setContainer(null);\n    });\n\n    useResizeObserver(vtkContainerRef, () => viewProxy.value.resize());\n\n    // --- scene setup --- //\n\n    const { baseImageRep } = useSceneBuilder<vtkVolumeRepresentationProxy>(\n      viewID,\n      {\n        baseImage: curImageID,\n        models: computed(() => modelStore.idList),\n      }\n    );\n\n    // --- picking --- //\n\n    // disables picking for crop control and more\n    watch(\n      baseImageRep,\n      (rep) => {\n        if (rep) {\n          rep.getVolumes().forEach((volume) => volume.setPickable(false));\n        }\n      },\n      { immediate: true }\n    );\n\n    // --- widget manager --- //\n\n    const { widgetManager } = useWidgetManager(viewProxy);\n    provide(VTKThreeViewWidgetManager, widgetManager);\n\n    // --- camera setup --- //\n\n    const { cameraUpVec, cameraDirVec } = useCameraOrientation(\n      viewDirection,\n      viewUp,\n      curImageMetadata\n    );\n\n    const resetCamera = () => {\n      const bounds = curImageMetadata.value.worldBounds;\n      const center = [\n        (bounds[0] + bounds[1]) / 2,\n        (bounds[2] + bounds[3]) / 2,\n        (bounds[4] + bounds[5]) / 2,\n      ] as vec3;\n\n      viewProxy.value.updateCamera(\n        cameraDirVec.value,\n        cameraUpVec.value,\n        center\n      );\n      viewProxy.value.resetCamera();\n      viewProxy.value.renderLater();\n    };\n\n    watch(\n      [baseImageRep, cameraDirVec, cameraUpVec],\n      () => {\n        const cameraConfig = viewCameraStore.getConfig(\n          viewID.value,\n          curImageID.value\n        );\n\n        // We don't want to reset the camera if we have a config we are restoring\n        if (!cameraConfig) {\n          // nextTick ensures resetCamera gets called after\n          // useSceneBuilder refreshes the scene.\n          nextTick(resetCamera);\n        }\n      },\n      {\n        immediate: true,\n      }\n    );\n\n    const { restoreCameraConfig } = usePersistCameraConfig(\n      viewID,\n      curImageID,\n      viewProxy,\n      'position',\n      'focalPoint',\n      'directionOfProjection',\n      'viewUp'\n    );\n\n    watch(curImageID, () => {\n      // See if we have a camera configuration to restore\n      const cameraConfig = viewCameraStore.getConfig(\n        viewID.value,\n        curImageID.value\n      );\n\n      if (cameraConfig) {\n        restoreCameraConfig(cameraConfig);\n\n        viewProxy.value.getRenderer().resetCameraClippingRange();\n        viewProxy.value.renderLater();\n      }\n    });\n\n    // --- coloring setup --- //\n\n    const volumeColorConfig = computed(() =>\n      volumeColoringStore.getConfig(viewID.value, curImageID.value)\n    );\n\n    watch(\n      [viewID, curImageID],\n      () => {\n        if (\n          curImageID.value &&\n          currentImageData.value &&\n          !volumeColorConfig.value\n        ) {\n          volumeColoringStore.resetToDefaultColoring(\n            viewID.value,\n            curImageID.value,\n            currentImageData.value\n          );\n        }\n      },\n      { immediate: true }\n    );\n\n    // --- CVR parameters --- //\n\n    useCvrEffect(volumeColorConfig, baseImageRep, viewProxy);\n\n    // --- coloring --- //\n\n    useColoringEffect(volumeColorConfig, baseImageRep, viewProxy);\n\n    // --- cropping planes --- //\n\n    const cropStore = useCropStore();\n    const croppingPlanes = cropStore.getComputedVTKPlanes(curImageID);\n\n    watch(\n      croppingPlanes,\n      (planes, oldPlanes) => {\n        const mapper = baseImageRep.value?.getMapper();\n        if (\n          !mapper ||\n          !planes ||\n          (oldPlanes && croppingPlanesEqual(planes, oldPlanes))\n        )\n          return;\n\n        mapper.removeAllClippingPlanes();\n        planes.forEach((plane) => mapper.addClippingPlane(plane));\n        mapper.modified();\n        viewProxy.value.renderLater();\n      },\n      { immediate: true }\n    );\n\n    // --- template vars --- //\n\n    return {\n      vtkContainerRef,\n      viewID,\n      active: false,\n      topLeftLabel: computed(\n        () =>\n          volumeColorConfig.value?.transferFunction.preset.replace(/-/g, ' ') ??\n          ''\n      ),\n      isImageLoading,\n      resetCamera,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/vtk-view.css\"></style>\n<style scoped src=\"@/src/components/styles/utils.css\"></style>\n\n<style scoped>\n.vtk-three-container {\n  background-color: black;\n  grid-template-columns: auto;\n}\n</style>\n","<template>\n  <div class=\"layout-container flex-equal\" :class=\"flexFlow\">\n    <div v-for=\"(item, i) in items\" :key=\"i\" class=\"d-flex flex-equal\">\n      <layout-grid v-if=\"item.type === 'layout'\" :layout=\"item\" />\n      <div v-else class=\"layout-item\">\n        <component\n          :is=\"item.component\"\n          :key=\"item.id\"\n          :id=\"item.id\"\n          v-bind=\"item.props\"\n        />\n      </div>\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { Component, computed, defineComponent, PropType, toRefs } from 'vue';\nimport { storeToRefs } from 'pinia';\nimport VtkTwoView from './VtkTwoView.vue';\nimport VtkThreeView from './VtkThreeView.vue';\nimport { Layout, LayoutDirection } from '../types/layout';\nimport { useViewStore } from '../store/views';\nimport { ViewType } from '../types/views';\n\nconst TYPE_TO_COMPONENT: Record<ViewType, Component> = {\n  '2D': VtkTwoView,\n  '3D': VtkThreeView,\n};\n\nexport default defineComponent({\n  name: 'LayoutGrid',\n  props: {\n    layout: {\n      type: Object as PropType<Layout>,\n      required: true,\n    },\n  },\n  setup(props) {\n    const { layout } = toRefs(props);\n    const viewStore = useViewStore();\n    const { viewSpecs } = storeToRefs(viewStore);\n\n    const flexFlow = computed(() => {\n      return layout.value.direction === LayoutDirection.H\n        ? 'flex-column'\n        : 'flex-row';\n    });\n\n    const items = computed(() => {\n      const viewIDToSpecs = viewSpecs.value;\n      return layout.value.items.map((item) => {\n        if (typeof item === 'string') {\n          const spec = viewIDToSpecs[item];\n          return {\n            type: 'view',\n            id: item,\n            component: TYPE_TO_COMPONENT[spec.viewType],\n            props: spec.props,\n          };\n        }\n        return {\n          type: 'layout',\n          ...item,\n        };\n      });\n    });\n\n    return {\n      items,\n      flexFlow,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/utils.css\"></style>\n\n<style scoped>\n.layout-container {\n  display: flex;\n  flex-direction: column;\n}\n\n.layout-item {\n  display: flex;\n  flex: 1;\n  border: 1px solid #222;\n}\n</style>\n","<template>\n  <div class=\"layout-container flex-equal\" :class=\"flexFlow\">\n    <div v-for=\"(item, i) in items\" :key=\"i\" class=\"d-flex flex-equal\">\n      <layout-grid v-if=\"item.type === 'layout'\" :layout=\"item\" />\n      <div v-else class=\"layout-item\">\n        <component\n          :is=\"item.component\"\n          :key=\"item.id\"\n          :id=\"item.id\"\n          v-bind=\"item.props\"\n        />\n      </div>\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { Component, computed, defineComponent, PropType, toRefs } from 'vue';\nimport { storeToRefs } from 'pinia';\nimport VtkTwoView from './VtkTwoView.vue';\nimport VtkThreeView from './VtkThreeView.vue';\nimport { Layout, LayoutDirection } from '../types/layout';\nimport { useViewStore } from '../store/views';\nimport { ViewType } from '../types/views';\n\nconst TYPE_TO_COMPONENT: Record<ViewType, Component> = {\n  '2D': VtkTwoView,\n  '3D': VtkThreeView,\n};\n\nexport default defineComponent({\n  name: 'LayoutGrid',\n  props: {\n    layout: {\n      type: Object as PropType<Layout>,\n      required: true,\n    },\n  },\n  setup(props) {\n    const { layout } = toRefs(props);\n    const viewStore = useViewStore();\n    const { viewSpecs } = storeToRefs(viewStore);\n\n    const flexFlow = computed(() => {\n      return layout.value.direction === LayoutDirection.H\n        ? 'flex-column'\n        : 'flex-row';\n    });\n\n    const items = computed(() => {\n      const viewIDToSpecs = viewSpecs.value;\n      return layout.value.items.map((item) => {\n        if (typeof item === 'string') {\n          const spec = viewIDToSpecs[item];\n          return {\n            type: 'view',\n            id: item,\n            component: TYPE_TO_COMPONENT[spec.viewType],\n            props: spec.props,\n          };\n        }\n        return {\n          type: 'layout',\n          ...item,\n        };\n      });\n    });\n\n    return {\n      items,\n      flexFlow,\n    };\n  },\n});\n</script>\n\n<style scoped src=\"@/src/components/styles/utils.css\"></style>\n\n<style scoped>\n.layout-container {\n  display: flex;\n  flex-direction: column;\n}\n\n.layout-item {\n  display: flex;\n  flex: 1;\n  border: 1px solid #222;\n}\n</style>\n","<script setup>\nimport { toRefs, computed } from 'vue';\n\n/**\n * This differs from v-overlay:\n * - smaller API\n * - does not hide unless disabled\n * - requires parent el to have position != static\n * - uses CSS theme vars\n */\n\nconst props = defineProps({\n  disabled: {\n    type: Boolean,\n    default: false,\n  },\n  /**\n   * Must be a vuetify color\n   */\n  color: {\n    type: String,\n    default: '',\n  },\n  opacity: {\n    type: Number,\n    default: 0.2,\n  },\n  zIndex: {\n    type: Number,\n    default: 10,\n  },\n});\n\nconst { disabled, color, opacity, zIndex } = toRefs(props);\n\nconst colorAsStyle = computed(() =>\n  color.value && color.value.startsWith('#') ? color.value : ''\n);\nconst colorAsClass = computed(() =>\n  color.value && !colorAsStyle.value ? `bg-${color.value}` : ''\n);\n\nconst scrimClasses = computed(() => {\n  const classes = {\n    'persistent-overlay-scrim': true,\n    'persistent-overlay-scrim-themed': color.value.length === 0,\n  };\n  if (colorAsClass.value) {\n    classes[colorAsClass.value] = true;\n  }\n  return classes;\n});\n\nconst scrimStyles = computed(() => {\n  const styles = {\n    opacity: opacity.value,\n  };\n  if (colorAsStyle.value) {\n    styles['background-color'] = colorAsStyle.value;\n  }\n  return styles;\n});\n\nconst containerStyles = computed(() => {\n  const styles = {\n    zIndex: zIndex.value,\n  };\n  return styles;\n});\n</script>\n\n<template>\n  <div v-if=\"!disabled\" class=\"persistent-overlay\" :style=\"containerStyles\">\n    <div :class=\"scrimClasses\" :style=\"scrimStyles\" />\n    <slot />\n  </div>\n</template>\n\n<style scoped>\n.persistent-overlay {\n  position: absolute;\n  top: 0;\n  height: 100%;\n  width: 100%;\n}\n\n.persistent-overlay-scrim {\n  position: absolute;\n  top: 0;\n  height: 100%;\n  width: 100%;\n  z-index: -100;\n}\n\n.persistent-overlay-scrim-themed {\n  background-color: rgb(var(--v-theme-background));\n}\n</style>\n","<template>\n  <v-hover v-slot=\"{ isHovering, props }\">\n    <v-card\n      :disabled=\"disabled\"\n      variant=\"outlined\"\n      :ripple=\"!disabled\"\n      :class=\"{\n        'image-list-card-hover': !disabled && isHovering,\n        'image-list-card-active': !disabled && active,\n      }\"\n      v-bind=\"{ ...props, ...$attrs }\"\n    >\n      <v-container :title=\"htmlTitle\">\n        <v-row no-gutters class=\"flex-nowrap\">\n          <v-col v-if=\"selectable\" cols=\"1\" class=\"d-flex align-center\">\n            <v-checkbox\n              @click.stop\n              :key=\"id\"\n              density=\"compact\"\n              :disabled=\"disabled\"\n              :value=\"inputValue\"\n              :model-value=\"modelValue\"\n              @update:model-value=\"$emit('update:model-value', $event)\"\n            />\n          </v-col>\n          <v-col\n            cols=\"4\"\n            class=\"image-container flex-grow-0\"\n            :style=\"{ maxWidth: `${imageSize}px` }\"\n          >\n            <v-img\n              contain\n              :height=\"`${imageSize}px`\"\n              :width=\"`${imageSize}px`\"\n              :src=\"imageUrl\"\n            />\n            <persistent-overlay :disabled=\"!$slots['image-overlay']\">\n              <slot name=\"image-overlay\" />\n            </persistent-overlay>\n          </v-col>\n          <v-col :cols=\"selectable ? 7 : 8\">\n            <div class=\"ml-2\">\n              <slot></slot>\n            </div>\n          </v-col>\n        </v-row>\n      </v-container>\n    </v-card>\n  </v-hover>\n</template>\n\n<style scoped>\n.image-list-card-active {\n  background-color: rgb(var(--v-theme-selection-bg-color));\n  border-color: rgb(var(--v-theme-selection-border-color));\n}\n\n.image-container {\n  position: relative;\n  margin-left: 8px;\n  margin-right: 8px;\n}\n</style>\n\n<script lang=\"ts\">\nimport { defineComponent } from 'vue';\nimport PersistentOverlay from './PersistentOverlay.vue';\n\nexport default defineComponent({\n  name: 'ImageListCard',\n  props: {\n    active: Boolean,\n    imageSize: {\n      type: Number,\n      default: 80,\n    },\n    imageUrl: {\n      type: String,\n    },\n    selectable: {\n      type: Boolean,\n      default: false,\n    },\n    id: String,\n    modelValue: Array,\n    inputValue: String,\n    disabled: Boolean,\n    htmlTitle: String,\n  },\n  components: { PersistentOverlay },\n});\n</script>\n","<template>\n  <v-hover v-slot=\"{ isHovering, props }\">\n    <v-card\n      :disabled=\"disabled\"\n      variant=\"outlined\"\n      :ripple=\"!disabled\"\n      :class=\"{\n        'image-list-card-hover': !disabled && isHovering,\n        'image-list-card-active': !disabled && active,\n      }\"\n      v-bind=\"{ ...props, ...$attrs }\"\n    >\n      <v-container :title=\"htmlTitle\">\n        <v-row no-gutters class=\"flex-nowrap\">\n          <v-col v-if=\"selectable\" cols=\"1\" class=\"d-flex align-center\">\n            <v-checkbox\n              @click.stop\n              :key=\"id\"\n              density=\"compact\"\n              :disabled=\"disabled\"\n              :value=\"inputValue\"\n              :model-value=\"modelValue\"\n              @update:model-value=\"$emit('update:model-value', $event)\"\n            />\n          </v-col>\n          <v-col\n            cols=\"4\"\n            class=\"image-container flex-grow-0\"\n            :style=\"{ maxWidth: `${imageSize}px` }\"\n          >\n            <v-img\n              contain\n              :height=\"`${imageSize}px`\"\n              :width=\"`${imageSize}px`\"\n              :src=\"imageUrl\"\n            />\n            <persistent-overlay :disabled=\"!$slots['image-overlay']\">\n              <slot name=\"image-overlay\" />\n            </persistent-overlay>\n          </v-col>\n          <v-col :cols=\"selectable ? 7 : 8\">\n            <div class=\"ml-2\">\n              <slot></slot>\n            </div>\n          </v-col>\n        </v-row>\n      </v-container>\n    </v-card>\n  </v-hover>\n</template>\n\n<style scoped>\n.image-list-card-active {\n  background-color: rgb(var(--v-theme-selection-bg-color));\n  border-color: rgb(var(--v-theme-selection-border-color));\n}\n\n.image-container {\n  position: relative;\n  margin-left: 8px;\n  margin-right: 8px;\n}\n</style>\n\n<script lang=\"ts\">\nimport { defineComponent } from 'vue';\nimport PersistentOverlay from './PersistentOverlay.vue';\n\nexport default defineComponent({\n  name: 'ImageListCard',\n  props: {\n    active: Boolean,\n    imageSize: {\n      type: Number,\n      default: 80,\n    },\n    imageUrl: {\n      type: String,\n    },\n    selectable: {\n      type: Boolean,\n      default: false,\n    },\n    id: String,\n    modelValue: Array,\n    inputValue: String,\n    disabled: Boolean,\n    htmlTitle: String,\n  },\n  components: { PersistentOverlay },\n});\n</script>\n","<script lang=\"ts\">\nimport { defineComponent, reactive, computed } from 'vue';\nimport ImageListCard from '@/src/components/ImageListCard.vue';\nimport { useDatasetStore } from '@/src/store/datasets';\nimport {\n  convertSuccessResultToDataSelection,\n  importDataSources,\n} from '@/src/io/import/importDataSources';\nimport { remoteFileToDataSource } from '@/src/io/import/dataSource';\nimport { SAMPLE_DATA } from '../config';\nimport { useMessageStore } from '../store/messages';\nimport { SampleDataset } from '../types';\nimport { useImageStore } from '../store/datasets-images';\nimport { useDICOMStore } from '../store/datasets-dicom';\nimport { fetchFile } from '../utils/fetch';\n\nenum ProgressState {\n  Pending,\n  Error,\n  Done,\n}\n\ninterface Progress {\n  [name: string]: {\n    state: ProgressState;\n    progress: number;\n  };\n}\n\nexport default defineComponent({\n  components: {\n    ImageListCard,\n  },\n  setup() {\n    const datasetStore = useDatasetStore();\n    const status = reactive<{ progress: Progress }>({\n      progress: {},\n    });\n    // URL -> data ID\n    const loaded = reactive<{\n      urlToID: Record<string, string>;\n      idToURL: Record<string, string>;\n    }>({\n      urlToID: {},\n      idToURL: {},\n    });\n\n    const clearLoadedStatus = (id: string) => {\n      const url = loaded.idToURL[id];\n      if (url) {\n        delete loaded.idToURL[id];\n        delete loaded.urlToID[url];\n      }\n    };\n\n    const imageStore = useImageStore();\n    imageStore.$onAction(({ name, args, after }) => {\n      if (name === 'deleteData') {\n        after(() => {\n          const [id] = args;\n          clearLoadedStatus(id as string);\n        });\n      }\n    });\n\n    const dicomStore = useDICOMStore();\n    dicomStore.$onAction(({ name, args, after }) => {\n      if (name === 'deleteVolume') {\n        after(() => {\n          const [key] = args;\n          clearLoadedStatus(key as string);\n        });\n      }\n    });\n\n    async function downloadSample(sample: SampleDataset) {\n      const progress = (percent: number) => {\n        status.progress[sample.name] = {\n          state: ProgressState.Pending,\n          progress: percent * 100,\n        };\n      };\n      try {\n        progress(Infinity);\n\n        const sampleFile = await fetchFile(sample.url, sample.filename, {\n          progress,\n        });\n        status.progress[sample.name].state = ProgressState.Done;\n\n        const [loadResult] = await importDataSources([\n          remoteFileToDataSource(sampleFile, sample.url),\n        ]);\n\n        if (!loadResult) {\n          throw new Error('Did not receive a load result');\n        }\n        if (!loadResult.ok) {\n          throw loadResult.errors[0].cause;\n        }\n\n        const selection = convertSuccessResultToDataSelection(loadResult);\n        if (selection) {\n          const id =\n            selection.type === 'image' ? selection.dataID : selection.volumeKey;\n          loaded.idToURL[id] = sample.url;\n          loaded.urlToID[sample.url] = id;\n        }\n        datasetStore.setPrimarySelection(selection);\n      } catch (error) {\n        status.progress[sample.name].state = ProgressState.Error;\n        const messageStore = useMessageStore();\n        messageStore.addError('Failed to load sample data', error as Error);\n      } finally {\n        delete status.progress[sample.name];\n      }\n    }\n\n    const samples = computed(() =>\n      SAMPLE_DATA.map((sample) => {\n        const isDone =\n          status.progress[sample.name]?.state === ProgressState.Done;\n        const isError =\n          status.progress[sample.name]?.state === ProgressState.Error;\n        const isLoaded = !!loaded.urlToID[sample.url];\n        const progress =\n          isDone || isLoaded\n            ? 100\n            : Math.floor(status.progress[sample.name]?.progress);\n        return {\n          ...sample,\n          isDownloading: sample.name in status.progress,\n          isDone,\n          isError,\n          isLoaded,\n          indeterminate: progress === Infinity,\n          progress,\n        };\n      })\n    );\n\n    return {\n      samples,\n      downloadSample,\n    };\n  },\n});\n</script>\n\n<template>\n  <div>\n    <image-list-card\n      v-for=\"sample in samples\"\n      :disabled=\"sample.isDownloading || sample.isLoaded\"\n      :key=\"sample.name\"\n      :html-title=\"sample.name\"\n      :image-url=\"sample.image\"\n      :image-size=\"100\"\n      class=\"mb-1\"\n      @click=\"downloadSample(sample)\"\n    >\n      <div class=\"text-body-2 font-weight-bold text-no-wrap text-truncate\">\n        {{ sample.name }}\n      </div>\n      <div class=\"text-body-2 mt-2\">{{ sample.description }}</div>\n      <template #image-overlay v-if=\"sample.isDownloading || sample.isLoaded\">\n        <v-row class=\"fill-height ma-0 align-center justify-center\">\n          <v-progress-circular\n            class=\"sample-progress\"\n            color=\"white\"\n            :indeterminate=\"sample.indeterminate && !sample.isDone\"\n            :model-value=\"sample.progress\"\n          >\n            <v-icon v-if=\"sample.isDone || sample.isLoaded\" small color=\"white\">\n              mdi-check\n            </v-icon>\n            <v-icon v-else-if=\"sample.isError\" small color=\"white\">\n              mdi-alert-circle\n            </v-icon>\n            <span\n              v-else-if=\"!sample.indeterminate\"\n              class=\"text-caption text--white\"\n            >\n              {{ sample.progress }}\n            </span>\n          </v-progress-circular>\n        </v-row>\n      </template>\n    </image-list-card>\n  </div>\n</template>\n\n<style>\n/* The transition animation causes the progress bar to load slowly\n   when the value is updated rapidly. */\n.v-progress-circular__overlay {\n  transition: unset;\n}\n</style>\n\n<style scoped>\n.sample-progress {\n  background: rgba(0, 0, 0, 0.75);\n  border-radius: 16px;\n  box-shadow: 0 0 8px 8px rgba(0, 0, 0, 0.75);\n}\n</style>\n","<script lang=\"ts\">\nimport { defineComponent, reactive, computed } from 'vue';\nimport ImageListCard from '@/src/components/ImageListCard.vue';\nimport { useDatasetStore } from '@/src/store/datasets';\nimport {\n  convertSuccessResultToDataSelection,\n  importDataSources,\n} from '@/src/io/import/importDataSources';\nimport { remoteFileToDataSource } from '@/src/io/import/dataSource';\nimport { SAMPLE_DATA } from '../config';\nimport { useMessageStore } from '../store/messages';\nimport { SampleDataset } from '../types';\nimport { useImageStore } from '../store/datasets-images';\nimport { useDICOMStore } from '../store/datasets-dicom';\nimport { fetchFile } from '../utils/fetch';\n\nenum ProgressState {\n  Pending,\n  Error,\n  Done,\n}\n\ninterface Progress {\n  [name: string]: {\n    state: ProgressState;\n    progress: number;\n  };\n}\n\nexport default defineComponent({\n  components: {\n    ImageListCard,\n  },\n  setup() {\n    const datasetStore = useDatasetStore();\n    const status = reactive<{ progress: Progress }>({\n      progress: {},\n    });\n    // URL -> data ID\n    const loaded = reactive<{\n      urlToID: Record<string, string>;\n      idToURL: Record<string, string>;\n    }>({\n      urlToID: {},\n      idToURL: {},\n    });\n\n    const clearLoadedStatus = (id: string) => {\n      const url = loaded.idToURL[id];\n      if (url) {\n        delete loaded.idToURL[id];\n        delete loaded.urlToID[url];\n      }\n    };\n\n    const imageStore = useImageStore();\n    imageStore.$onAction(({ name, args, after }) => {\n      if (name === 'deleteData') {\n        after(() => {\n          const [id] = args;\n          clearLoadedStatus(id as string);\n        });\n      }\n    });\n\n    const dicomStore = useDICOMStore();\n    dicomStore.$onAction(({ name, args, after }) => {\n      if (name === 'deleteVolume') {\n        after(() => {\n          const [key] = args;\n          clearLoadedStatus(key as string);\n        });\n      }\n    });\n\n    async function downloadSample(sample: SampleDataset) {\n      const progress = (percent: number) => {\n        status.progress[sample.name] = {\n          state: ProgressState.Pending,\n          progress: percent * 100,\n        };\n      };\n      try {\n        progress(Infinity);\n\n        const sampleFile = await fetchFile(sample.url, sample.filename, {\n          progress,\n        });\n        status.progress[sample.name].state = ProgressState.Done;\n\n        const [loadResult] = await importDataSources([\n          remoteFileToDataSource(sampleFile, sample.url),\n        ]);\n\n        if (!loadResult) {\n          throw new Error('Did not receive a load result');\n        }\n        if (!loadResult.ok) {\n          throw loadResult.errors[0].cause;\n        }\n\n        const selection = convertSuccessResultToDataSelection(loadResult);\n        if (selection) {\n          const id =\n            selection.type === 'image' ? selection.dataID : selection.volumeKey;\n          loaded.idToURL[id] = sample.url;\n          loaded.urlToID[sample.url] = id;\n        }\n        datasetStore.setPrimarySelection(selection);\n      } catch (error) {\n        status.progress[sample.name].state = ProgressState.Error;\n        const messageStore = useMessageStore();\n        messageStore.addError('Failed to load sample data', error as Error);\n      } finally {\n        delete status.progress[sample.name];\n      }\n    }\n\n    const samples = computed(() =>\n      SAMPLE_DATA.map((sample) => {\n        const isDone =\n          status.progress[sample.name]?.state === ProgressState.Done;\n        const isError =\n          status.progress[sample.name]?.state === ProgressState.Error;\n        const isLoaded = !!loaded.urlToID[sample.url];\n        const progress =\n          isDone || isLoaded\n            ? 100\n            : Math.floor(status.progress[sample.name]?.progress);\n        return {\n          ...sample,\n          isDownloading: sample.name in status.progress,\n          isDone,\n          isError,\n          isLoaded,\n          indeterminate: progress === Infinity,\n          progress,\n        };\n      })\n    );\n\n    return {\n      samples,\n      downloadSample,\n    };\n  },\n});\n</script>\n\n<template>\n  <div>\n    <image-list-card\n      v-for=\"sample in samples\"\n      :disabled=\"sample.isDownloading || sample.isLoaded\"\n      :key=\"sample.name\"\n      :html-title=\"sample.name\"\n      :image-url=\"sample.image\"\n      :image-size=\"100\"\n      class=\"mb-1\"\n      @click=\"downloadSample(sample)\"\n    >\n      <div class=\"text-body-2 font-weight-bold text-no-wrap text-truncate\">\n        {{ sample.name }}\n      </div>\n      <div class=\"text-body-2 mt-2\">{{ sample.description }}</div>\n      <template #image-overlay v-if=\"sample.isDownloading || sample.isLoaded\">\n        <v-row class=\"fill-height ma-0 align-center justify-center\">\n          <v-progress-circular\n            class=\"sample-progress\"\n            color=\"white\"\n            :indeterminate=\"sample.indeterminate && !sample.isDone\"\n            :model-value=\"sample.progress\"\n          >\n            <v-icon v-if=\"sample.isDone || sample.isLoaded\" small color=\"white\">\n              mdi-check\n            </v-icon>\n            <v-icon v-else-if=\"sample.isError\" small color=\"white\">\n              mdi-alert-circle\n            </v-icon>\n            <span\n              v-else-if=\"!sample.indeterminate\"\n              class=\"text-caption text--white\"\n            >\n              {{ sample.progress }}\n            </span>\n          </v-progress-circular>\n        </v-row>\n      </template>\n    </image-list-card>\n  </div>\n</template>\n\n<style>\n/* The transition animation causes the progress bar to load slowly\n   when the value is updated rapidly. */\n.v-progress-circular__overlay {\n  transition: unset;\n}\n</style>\n\n<style scoped>\n.sample-progress {\n  background: rgba(0, 0, 0, 0.75);\n  border-radius: 16px;\n  box-shadow: 0 0 8px 8px rgba(0, 0, 0, 0.75);\n}\n</style>\n","import { defineStore } from 'pinia';\nimport {\n  ANONYMOUS_PATIENT,\n  ANONYMOUS_PATIENT_ID,\n  PatientInfo,\n  StudyInfo,\n  VolumeInfo,\n} from '../datasets-dicom';\nimport { pick, removeFromArray } from '../../utils';\nimport { Instance } from '../../core/dicom-web-api';\n\ninterface InstanceInfo {\n  SopInstanceUID: string;\n  InstanceNumber: string;\n  Rows: number;\n  Columns: number;\n}\n\ntype VolumeInfoForUi = Omit<VolumeInfo, 'layers'>;\n\ninterface State {\n  // volume invalidation information\n  needsRebuild: Record<string, boolean>;\n\n  // patientKey -> patient info\n  patientInfo: Record<string, PatientInfo>;\n  // patientKey -> array of studyKeys\n  patientStudies: Record<string, string[]>;\n\n  // studyKey -> study info\n  studyInfo: Record<string, StudyInfo>;\n  // studyKey -> array of volumeKeys\n  studyVolumes: Record<string, string[]>;\n\n  // volumeKey -> volume info\n  volumeInfo: Record<string, VolumeInfoForUi>;\n  // volumeKey -> array of instanceKeys\n  volumeInstances: Record<string, string[]>;\n\n  // instanceKey -> instance info\n  instanceInfo: Record<string, InstanceInfo>;\n\n  // parent pointers\n  // instanceKey -> volumeKey\n  instanceVolume: Record<string, string>;\n  // volumeKey -> studyKey\n  volumeStudy: Record<string, string>;\n  // studyKey -> patientKey\n  studyPatient: Record<string, string>;\n}\n\nexport const useDicomMetaStore = defineStore('dicom-meta', {\n  state: (): State => ({\n    patientInfo: {},\n    patientStudies: {},\n    studyInfo: {},\n    studyVolumes: {},\n    volumeInfo: {},\n    volumeInstances: {},\n    instanceInfo: {},\n    instanceVolume: {},\n    volumeStudy: {},\n    studyPatient: {},\n    needsRebuild: {},\n  }),\n  actions: {\n    async importMeta(info: Instance) {\n      const patient = {\n        PatientID: info.PatientID || ANONYMOUS_PATIENT_ID,\n        PatientName: info.PatientName || ANONYMOUS_PATIENT,\n        PatientBirthDate: info.PatientBirthDate || '',\n        PatientSex: info.PatientSex || '',\n      };\n\n      const study = pick(\n        info,\n        'StudyID',\n        'StudyInstanceUID',\n        'StudyDate',\n        'StudyTime',\n        'AccessionNumber',\n        'StudyDescription'\n      );\n\n      const volumeInfo = {\n        ...pick(\n          info,\n          'Modality',\n          'SeriesInstanceUID',\n          'SeriesNumber',\n          'SeriesDescription'\n        ),\n        NumberOfSlices: 0, // incremented later\n        VolumeID: info.SeriesInstanceUID,\n      };\n\n      const instanceInfo = {\n        ...pick(info, 'SopInstanceUID', 'InstanceNumber'),\n        Rows: Number.parseInt(info.Rows, 10),\n        Columns: Number.parseInt(info.Columns, 10),\n      };\n\n      this._updateDatabase(patient, study, volumeInfo, instanceInfo);\n    },\n\n    deleteVolume(volumeKey: string) {\n      if (volumeKey in this.volumeInfo) {\n        const studyKey = this.volumeStudy[volumeKey];\n        delete this.volumeInfo[volumeKey];\n        delete this.volumeStudy[volumeKey];\n\n        removeFromArray(this.studyVolumes[studyKey], volumeKey);\n        if (this.studyVolumes[studyKey].length === 0) {\n          this.deleteStudy(studyKey);\n        }\n      }\n    },\n\n    deleteStudy(studyKey: string) {\n      if (studyKey in this.studyInfo) {\n        const patientKey = this.studyPatient[studyKey];\n        delete this.studyInfo[studyKey];\n        delete this.studyPatient[studyKey];\n\n        delete this.studyVolumes[studyKey];\n\n        removeFromArray(this.patientStudies[patientKey], studyKey);\n        if (this.patientStudies[patientKey].length === 0) {\n          this.deletePatient(patientKey);\n        }\n      }\n    },\n\n    deletePatient(patientKey: string) {\n      if (patientKey in this.patientInfo) {\n        delete this.patientInfo[patientKey];\n\n        [...this.patientStudies[patientKey]].forEach((studyKey) =>\n          this.deleteStudy(studyKey)\n        );\n        delete this.patientStudies[patientKey];\n      }\n    },\n\n    _updateDatabase(\n      patient: PatientInfo,\n      study: StudyInfo,\n      volume: VolumeInfoForUi,\n      instance: InstanceInfo\n    ) {\n      const patientKey = patient.PatientID;\n      if (patientKey && !(patientKey in this.patientInfo)) {\n        this.patientInfo[patientKey] = patient;\n        this.patientStudies[patientKey] = [];\n      }\n\n      const studyKey = study.StudyInstanceUID;\n      if (studyKey && !(studyKey in this.studyInfo)) {\n        this.studyInfo[studyKey] = study;\n        this.studyVolumes[studyKey] = [];\n        this.studyPatient[studyKey] = patientKey;\n        this.patientStudies[patientKey].push(studyKey);\n      }\n\n      const volumeKey = volume.VolumeID;\n      if (volumeKey && !(volumeKey in this.volumeInfo)) {\n        this.volumeInfo[volumeKey] = volume;\n        this.volumeInstances[volumeKey] = [];\n        this.volumeStudy[volumeKey] = studyKey;\n        this.studyVolumes[studyKey].push(volumeKey);\n      }\n\n      const instanceKey = instance.SopInstanceUID;\n      if (instanceKey && !(instanceKey in this.instanceInfo)) {\n        this.instanceInfo[instanceKey] = instance;\n        this.instanceVolume[instanceKey] = volumeKey;\n        this.volumeInstances[volumeKey].push(instanceKey);\n\n        this.volumeInfo[volumeKey].NumberOfSlices += 1;\n      }\n\n      // Clean orphaned patients. Anonymous Patient loses its only study\n      // when slices are loaded with full DICOM tags. Study was anonymous\n      // because url deep linked into a study\n      Object.entries(this.patientStudies).forEach(([key, studies]) => {\n        if (studies.length === 0) {\n          this.deletePatient(key);\n        }\n      });\n    },\n  },\n});\n","import { cleanUndefined } from '@/src/utils';\nimport { api } from 'dicomweb-client-typed';\n\nexport interface FetchStudyOptions {\n  studyInstanceUID: string;\n}\n\nexport interface FetchSeriesOptions extends FetchStudyOptions {\n  seriesInstanceUID: string;\n}\n\nexport interface FetchInstanceOptions extends FetchSeriesOptions {\n  sopInstanceUID: string;\n}\n\nconst tags = {\n  PatientID: '00100020',\n  PatientName: '00100010',\n  PatientBirthDate: '00100030',\n  PatientSex: '00100040',\n\n  StudyID: '00200010',\n  StudyInstanceUID: '0020000D',\n  StudyName: '00100010',\n  StudyDate: '00080020',\n  StudyTime: '00080030',\n  AccessionNumber: '00080050',\n  StudyDescription: '00081030',\n\n  SeriesInstanceUID: '0020000E',\n  SeriesNumber: '00200011',\n  SeriesDescription: '0008103E',\n  Modality: '00080060',\n\n  SopInstanceUID: '00080018',\n  InstanceNumber: '00200013',\n\n  Rows: '00280010',\n  Columns: '00280011',\n};\n\nexport type Instance = typeof tags;\n\nfunction parseTag(value: any) {\n  const v = value?.Value?.[0];\n  const alpha = v?.Alphabetic;\n  if (alpha) return alpha;\n  return v;\n}\n\nfunction parseInstance(instance: any) {\n  const withNamedTags = Object.entries(tags).reduce(\n    (info, [key, tag]) => ({ ...info, [key]: parseTag(instance[tag]) }),\n    {}\n  );\n  return cleanUndefined(withNamedTags) as Instance;\n}\n\n// Create unique file names so loader utils work\nlet fileCounter = 0;\nfunction toFile(instance: ArrayBuffer) {\n  fileCounter++;\n  return new File([new Blob([instance])], `dicom-web.${fileCounter}.dcm`);\n}\n\nfunction makeClient(dicomWebRoot: string) {\n  return new api.DICOMwebClient({\n    url: dicomWebRoot,\n  });\n}\n\nexport async function searchForStudies(dicomWebRoot: string) {\n  const client = makeClient(dicomWebRoot);\n  const instances = await client.searchForStudies();\n  return instances.map(parseInstance);\n}\n\nexport async function retrieveStudyMetadata(\n  dicomWebRoot: string,\n  options: FetchStudyOptions\n) {\n  const client = makeClient(dicomWebRoot);\n  const instances = await client.searchForSeries(options);\n  return instances.map(parseInstance);\n}\n\nexport async function retrieveSeriesMetadata(\n  dicomWebRoot: string,\n  options: FetchSeriesOptions\n) {\n  const client = makeClient(dicomWebRoot);\n  const instances = await client.retrieveSeriesMetadata(options);\n  return instances.map(parseInstance);\n}\n\nexport async function fetchSeries(\n  dicomWebRoot: string,\n  options: FetchSeriesOptions,\n  progressCallback: (n: ProgressEvent) => void\n): Promise<File[]> {\n  const client = makeClient(dicomWebRoot);\n  const series = (await client.retrieveSeries({\n    ...options,\n    progressCallback,\n  })) as ArrayBuffer[];\n  return series.map(toFile);\n}\n\nexport async function fetchInstanceThumbnail(\n  dicomWebRoot: string,\n  instance: FetchInstanceOptions\n) {\n  const client = makeClient(dicomWebRoot);\n  const thumbnail = await client.retrieveInstanceRendered({\n    ...instance,\n    mediaTypes: [{ mediaType: 'image/jpeg' }],\n  });\n  const arrayBufferView = new Uint8Array(thumbnail);\n  const blob = new Blob([arrayBufferView], { type: 'image/jpeg' });\n  return URL.createObjectURL(blob);\n}\n\nconst LEVELS = ['series', 'studies'] as const;\n\n// takes a url like http://localhost:3000/dicom-web/studies/someid/series/anotherid\n// returns { host: 'http://localhost:3000/dicom-web', studies: 'someid', series: 'anotherid' }\nexport function parseUrl(deepDicomWebUrl: string) {\n  // remove trailing slash\n  const sansSlash = deepDicomWebUrl.replace(/\\/$/, '');\n\n  let paths = sansSlash.split('/');\n  const parentIDs = LEVELS.reduce((idObj, dicomLevel) => {\n    const [urlLevel, dicomID] = paths.slice(-2);\n    if (urlLevel === dicomLevel) {\n      paths = paths.slice(0, -2);\n      return { [dicomLevel]: dicomID, ...idObj };\n    }\n    return idObj;\n  }, {});\n\n  const pathsToSlice = Object.keys(parentIDs).length * 2;\n  const allPaths = sansSlash.split('/');\n  const host = allPaths.slice(0, allPaths.length - pathsToSlice).join('/');\n\n  return { host, ...parentIDs };\n}\n","import { computed, ref } from 'vue';\nimport { useLocalStorage, UrlParams } from '@vueuse/core';\nimport { defineStore } from 'pinia';\nimport vtkURLExtract from '@kitware/vtk.js/Common/Core/URLExtract';\n\nimport { omit, remapKeys } from '@/src/utils';\nimport { fileToDataSource } from '@/src/io/import/dataSource';\nimport {\n  convertSuccessResultToDataSelection,\n  importDataSources,\n} from '@/src/io/import/importDataSources';\nimport { useDatasetStore } from '../datasets';\nimport { useDICOMStore } from '../datasets-dicom';\nimport { useMessageStore } from '../messages';\nimport { useDicomMetaStore } from './dicom-meta-store';\nimport {\n  searchForStudies,\n  fetchSeries,\n  fetchInstanceThumbnail,\n  retrieveStudyMetadata,\n  retrieveSeriesMetadata,\n  parseUrl,\n} from '../../core/dicom-web-api';\n\nconst DICOM_WEB_URL_PARAM = 'dicomweb';\n\nexport type ProgressState = 'Remote' | 'Pending' | 'Error' | 'Done';\n\nexport interface VolumeProgress {\n  state: ProgressState;\n  loaded: number;\n  total: number;\n}\n\ninterface Progress {\n  [name: string]: VolumeProgress;\n}\n\nexport const isDownloadable = (progress?: VolumeProgress) =>\n  !progress || ['Pending', 'Done'].every((state) => state !== progress.state);\n\nconst fetchFunctions = {\n  host: searchForStudies,\n  studies: retrieveStudyMetadata,\n  series: retrieveSeriesMetadata,\n};\n\nconst levelToFetchKey = {\n  studies: 'studyInstanceUID',\n  series: 'seriesInstanceUID',\n};\n\nconst levelToMetaKey = {\n  studies: 'StudyInstanceUID',\n  series: 'SeriesInstanceUID',\n};\n\n/**\n * Collect DICOM data from DICOMWeb\n */\nexport const useDicomWebStore = defineStore('dicom-web', () => {\n  const { VITE_DICOM_WEB_NAME, VITE_DICOM_WEB_URL } = import.meta.env;\n  // GUI display name\n  const hostName = VITE_DICOM_WEB_NAME\n    ? ref(VITE_DICOM_WEB_NAME)\n    : useLocalStorage<string>('dicomWebHostName', '');\n\n  const host = useLocalStorage<string | null>('dicomWebHost', ''); // null if cleared by vuetify text input\n\n  // URL param overrides env var, which overrides local storage\n  const urlParams = vtkURLExtract.extractURLParameters() as UrlParams;\n  const dicomWebFromURLParam = urlParams[DICOM_WEB_URL_PARAM] as\n    | string\n    | undefined;\n  const hostConfig = dicomWebFromURLParam ?? VITE_DICOM_WEB_URL;\n  if (hostConfig) host.value = hostConfig;\n\n  // Remove trailing slash and pull study/series IDs from URL\n  const parsedURL = computed(() => parseUrl(host.value ?? ''));\n\n  const cleanHost = computed(() => parsedURL.value.host);\n  const isConfigured = computed(() => !!cleanHost.value);\n\n  const fetchVolumeThumbnail = async (volumeKey: string) => {\n    const dicoms = useDicomMetaStore();\n    const volumeInfo = dicoms.volumeInfo[volumeKey];\n    const middleSlice = Math.floor(volumeInfo.NumberOfSlices / 2);\n    const middleInstance = dicoms.volumeInstances[volumeKey]\n      .map((instanceKey) => dicoms.instanceInfo[instanceKey])\n      .sort(\n        ({ InstanceNumber: a }, { InstanceNumber: b }) => Number(a) - Number(b)\n      )[middleSlice];\n\n    const studyKey = dicoms.volumeStudy[volumeKey];\n    const studyInfo = dicoms.studyInfo[studyKey];\n    const instance = {\n      studyInstanceUID: studyInfo.StudyInstanceUID,\n      seriesInstanceUID: volumeInfo.SeriesInstanceUID,\n      sopInstanceUID: middleInstance.SopInstanceUID,\n    };\n    return fetchInstanceThumbnail(cleanHost.value, instance);\n  };\n\n  const fetchPatientMeta = async (patientKey: string) => {\n    const dicoms = useDicomMetaStore();\n    const series = await Promise.all(\n      dicoms.patientStudies[patientKey]\n        .map((studyKey) => dicoms.studyInfo[studyKey])\n        .map(async (studyMeta) => {\n          const seriesMetas = await retrieveStudyMetadata(cleanHost.value, {\n            studyInstanceUID: studyMeta.StudyInstanceUID,\n          });\n          return seriesMetas.map((seriesMeta) => ({\n            ...studyMeta,\n            ...seriesMeta,\n          }));\n        })\n    );\n    series.flat().forEach((instance) => dicoms.importMeta(instance));\n  };\n\n  const fetchVolumesMeta = async (volumeKeys: string[]) => {\n    const dicoms = useDicomMetaStore();\n    const series = await Promise.all(\n      volumeKeys.map(async (volumeKey) => {\n        const volumeMeta = dicoms.volumeInfo[volumeKey];\n        const studyMeta = dicoms.studyInfo[dicoms.volumeStudy[volumeKey]];\n        const instanceMetas = await retrieveSeriesMetadata(cleanHost.value, {\n          studyInstanceUID: studyMeta.StudyInstanceUID,\n          seriesInstanceUID: volumeMeta.SeriesInstanceUID,\n        });\n        return instanceMetas.map((instanceMeta) => ({\n          ...studyMeta,\n          ...volumeMeta,\n          ...instanceMeta,\n        }));\n      })\n    );\n    series.flat().forEach((instance) => dicoms.importMeta(instance));\n  };\n\n  const volumes = ref({} as Progress);\n\n  const downloadVolume = async (volumeKey: string) => {\n    const datasets = useDatasetStore();\n    const dicoms = useDicomMetaStore();\n\n    if (!isDownloadable(volumes.value[volumeKey])) return;\n\n    volumes.value[volumeKey] = {\n      ...volumes.value[volumeKey],\n      state: 'Pending',\n      loaded: 0,\n      total: 0,\n    };\n\n    const { SeriesInstanceUID: seriesInstanceUID } =\n      dicoms.volumeInfo[volumeKey];\n    const studyKey = dicoms.volumeStudy[volumeKey];\n    const { StudyInstanceUID: studyInstanceUID } = dicoms.studyInfo[studyKey];\n    const seriesInfo = { studyInstanceUID, seriesInstanceUID };\n\n    const progressCallback = ({ loaded, total }: ProgressEvent) => {\n      volumes.value[volumeKey] = {\n        ...volumes.value[volumeKey],\n        loaded,\n        total,\n      };\n    };\n\n    try {\n      const files = await fetchSeries(\n        cleanHost.value,\n        seriesInfo,\n        progressCallback\n      );\n\n      if (!files) {\n        throw new Error('Could not fetch series');\n      }\n\n      const [loadResult] = await importDataSources(files.map(fileToDataSource));\n      if (!loadResult) {\n        throw new Error('Did not receive a load result');\n      }\n\n      if (!loadResult.ok) {\n        throw loadResult.errors[0].cause;\n      }\n\n      const selection = convertSuccessResultToDataSelection(loadResult);\n      datasets.setPrimarySelection(selection);\n      volumes.value[volumeKey] = {\n        ...volumes.value[volumeKey],\n        state: 'Done',\n      };\n    } catch (error) {\n      const messageStore = useMessageStore();\n      messageStore.addError('Failed to load DICOM', error as Error);\n      volumes.value[volumeKey] = {\n        ...volumes.value[volumeKey],\n        state: 'Error',\n        loaded: 0,\n      };\n    }\n  };\n\n  const fetchError = ref<undefined | unknown>(undefined);\n  let hasFetchedPatients = false;\n  const fetchInitialDicoms = async () => {\n    hasFetchedPatients = true;\n    fetchError.value = undefined;\n    const dicoms = useDicomMetaStore();\n    dicoms.$reset();\n    if (!cleanHost.value) return;\n\n    const deepestLevel = Object.keys(\n      parsedURL.value\n    ).pop() as keyof typeof fetchFunctions; // at least host key guaranteed to exist\n\n    const fetchFunc = fetchFunctions[deepestLevel];\n    const urlIDs = omit(parsedURL.value, 'host');\n    const fetchOptions = remapKeys(urlIDs, levelToFetchKey);\n    try {\n      const fetchedMetas = await fetchFunc(\n        cleanHost.value,\n        fetchOptions as any\n      );\n\n      const urlMetaIDs = remapKeys(urlIDs, levelToMetaKey);\n\n      const fullMeta = fetchedMetas.map((fetchedMeta) => ({\n        ...urlMetaIDs,\n        ...fetchedMeta,\n      }));\n      fullMeta.forEach((instance) => dicoms.importMeta(instance));\n    } catch (error) {\n      fetchError.value = error;\n      console.error(error);\n    }\n\n    if (deepestLevel === 'series') {\n      const seriesID = Object.values(parsedURL.value).pop() as string;\n      downloadVolume(seriesID);\n    }\n  };\n\n  // Safe to call in ephemeral components' setup()\n  const fetchInitialDicomsOnce = () => {\n    if (!hasFetchedPatients) {\n      fetchInitialDicoms();\n    }\n  };\n\n  const message = computed(() => {\n    if (fetchError.value)\n      return `Error fetching DICOMWeb data: ${fetchError.value}`;\n    const dicoms = useDicomMetaStore();\n    if (Object.values(dicoms.patientInfo).length === 0)\n      return 'Found zero dicoms.';\n    return '';\n  });\n\n  const loadedDicoms = useDICOMStore();\n  loadedDicoms.$onAction(({ name, args, after }) => {\n    if (name !== 'deleteVolume') return;\n\n    after(() => {\n      const [loadedVolumeKey] = args;\n      const volumeKey = Object.keys(volumes.value).find((key) =>\n        loadedVolumeKey.startsWith(key)\n      );\n      if (volumeKey)\n        volumes.value[volumeKey] = {\n          ...volumes.value[volumeKey],\n          state: 'Remote',\n          loaded: 0,\n        };\n    });\n  });\n\n  return {\n    host,\n    isConfigured,\n    hostName,\n    message,\n    volumes,\n    fetchInitialDicoms,\n    fetchInitialDicomsOnce,\n    fetchPatientMeta,\n    fetchVolumesMeta,\n    fetchVolumeThumbnail,\n    downloadVolume,\n  };\n});\n","<script lang=\"ts\">\nimport {\n  defineComponent,\n  onMounted,\n  PropType,\n  provide,\n  ref,\n  toRefs,\n  watch,\n} from 'vue';\n\ntype EqualsTestFunc<T> = (a: T, b: T) => boolean;\n\nexport const ItemGroupProvider = Symbol('ItemGroup');\n\nexport interface ItemGroupProviderValue {\n  selectItem: (item: unknown) => void;\n  isSelected: (item: unknown) => boolean;\n}\n\nexport default defineComponent({\n  props: {\n    modelValue: null,\n    mandatory: Boolean,\n    equalsTest: Function as PropType<EqualsTestFunc<any>>,\n  },\n  setup(props, { emit, slots }) {\n    const { modelValue, mandatory, equalsTest } = toRefs(props);\n    const internalValue = ref<unknown>();\n\n    watch(modelValue, (v) => {\n      if (v !== internalValue.value) {\n        internalValue.value = v;\n      }\n    });\n\n    onMounted(() => {\n      internalValue.value = modelValue.value;\n    });\n\n    const selectItem = (item: unknown) => {\n      if (mandatory.value && !item) {\n        return;\n      }\n      internalValue.value = item;\n      emit('update:modelValue', internalValue.value);\n    };\n\n    const isSelected = (item: unknown) => {\n      if (internalValue.value == null) {\n        return false;\n      }\n\n      return equalsTest.value\n        ? equalsTest.value(item, internalValue.value)\n        : item === internalValue.value;\n    };\n\n    provide<ItemGroupProviderValue>(ItemGroupProvider, {\n      selectItem,\n      isSelected,\n    });\n\n    return () => slots.default?.();\n  },\n});\n</script>\n","<script lang=\"ts\">\nimport { inject, defineComponent, toRefs } from 'vue';\nimport { ItemGroupProvider, ItemGroupProviderValue } from './ItemGroup.vue';\n\nexport default defineComponent({\n  props: {\n    value: {\n      type: null,\n      required: true,\n    },\n  },\n  setup(props, { slots }) {\n    const { value } = toRefs(props);\n    const itemGroup = inject<ItemGroupProviderValue>(ItemGroupProvider);\n\n    if (!itemGroup) {\n      throw new Error('GroupableItem needs ItemGroup!');\n    }\n\n    const select = () => {\n      itemGroup.selectItem(value.value);\n    };\n\n    const toggle = () => {\n      if (!itemGroup) {\n        return;\n      }\n\n      itemGroup.selectItem(\n        itemGroup.isSelected(value.value) ? undefined : value.value\n      );\n    };\n\n    return () =>\n      slots.default?.({\n        active: itemGroup.isSelected(value.value),\n        select,\n        toggle,\n      });\n  },\n});\n</script>\n","export enum ThumbnailSlice {\n  First,\n  Middle,\n  Last,\n}\n","import vtkImageData from '@kitware/vtk.js/Common/DataModel/ImageData';\nimport type { TypedArray } from '@kitware/vtk.js/types';\nimport { ThumbnailSlice } from '.';\n\nfunction scalarImageToImageData(\n  values: TypedArray,\n  width: number,\n  height: number,\n  scaleMin: number,\n  scaleMax: number\n) {\n  const im = new ImageData(width, height);\n  const arr32 = new Uint32Array(im.data.buffer);\n  // scale to 1 unsigned byte\n  const factor = 255 / (scaleMax - scaleMin);\n  for (let i = 0; i < values.length; i += 1) {\n    const byte = Math.floor((values[i] - scaleMin) * factor);\n    // ABGR order\n    // eslint-disable-next-line no-bitwise\n    arr32[i] = (255 << 24) | (byte << 16) | (byte << 8) | byte;\n  }\n\n  return im;\n}\n\n/**\n * Generates a thumbnail given an image data.\n *\n * Assumption: image is comprised of single-component scalars\n */\nfunction generateThumbnail(\n  imageData: vtkImageData,\n  axis: 0 | 1 | 2 = 2,\n  whichSlice = ThumbnailSlice.Middle\n) {\n  const scalars = imageData.getPointData().getScalars();\n  const data = scalars.getData() as TypedArray;\n  const dataRange = scalars.getRange();\n  const dims = imageData.getDimensions();\n\n  // ThumbnailSlice.First\n  let slice = 0;\n  if (whichSlice === ThumbnailSlice.Middle) {\n    slice = Math.floor(dims[axis] / 2);\n  } else if (whichSlice === ThumbnailSlice.Last) {\n    slice = dims[axis] - 1;\n  }\n\n  let sliceData: TypedArray;\n  let width: number;\n  let height: number;\n\n  if (axis === 0) {\n    // work-around for typing data.constructor.\n    // data is not necessarily of type Uint8Array.\n    sliceData = new (<Uint8ArrayConstructor>data.constructor)(\n      dims[1] * dims[2]\n    );\n    [, width, height] = dims;\n    for (let k = 0; k < dims[2]; k++) {\n      for (let j = 0; j < dims[1]; j++) {\n        const index = slice + j * dims[0] + k * dims[0] * dims[1];\n        const offset = k * dims[1] + j;\n        sliceData[offset] = data[index];\n      }\n    }\n  } else if (axis === 1) {\n    sliceData = new (<Uint8ArrayConstructor>data.constructor)(\n      dims[0] * dims[2]\n    );\n    [width, , height] = dims;\n    for (let k = 0; k < dims[2]; k++) {\n      for (let i = 0; i < dims[0]; i++) {\n        const index = i + slice * dims[0] + k * dims[0] * dims[1];\n        const offset = k * dims[0] + i;\n        sliceData[offset] = data[index];\n      }\n    }\n  } else if (axis === 2) {\n    [width, height] = dims;\n    const skip = dims[0] * dims[1];\n    const sliceOffset = slice * skip;\n    sliceData = Array.isArray(data)\n      ? data.slice(sliceOffset, sliceOffset + skip)\n      : data.subarray(sliceOffset, sliceOffset + skip);\n  }\n\n  return scalarImageToImageData(\n    sliceData!,\n    width!,\n    height!,\n    dataRange[0],\n    dataRange[1]\n  );\n}\n\nexport function createVTKImageThumbnailer() {\n  const canvas = document.createElement('canvas');\n  const ctx = canvas.getContext('2d');\n\n  const resizeCanvas = document.createElement('canvas');\n  const resizeContext = resizeCanvas.getContext('2d');\n\n  if (!ctx || !resizeContext) {\n    throw new Error('[thumbnailer] Failed to create a 2D context');\n  }\n  return {\n    generate(\n      imageData: vtkImageData,\n      axis: 0 | 1 | 2 = 2,\n      whichSlice = ThumbnailSlice.Middle\n    ) {\n      return generateThumbnail(imageData, axis, whichSlice);\n    },\n    imageDataToDataURI(\n      im: ImageData,\n      resizeWidth: number,\n      resizeHeight: number\n    ) {\n      canvas.width = im.width;\n      canvas.height = im.height;\n      ctx.putImageData(im, 0, 0);\n\n      let { width, height } = im;\n      if (im.width > im.height) {\n        width = resizeWidth;\n        height *= resizeWidth / im.width;\n      } else {\n        height = resizeHeight;\n        width *= resizeHeight / im.height;\n      }\n\n      resizeCanvas.width = width;\n      resizeCanvas.height = height;\n      resizeContext.clearRect(0, 0, width, height);\n      resizeContext.scale(width / im.width, height / im.height);\n      resizeContext.drawImage(canvas, 0, 0);\n      // jpegs are smaller than pngs\n      return resizeCanvas.toDataURL('image/jpeg');\n    },\n  };\n}\n","import { computed, Ref, ref, watch, UnwrapRef } from 'vue';\n\nexport function useMultiSelection<T = string>(allItems: Ref<T[]>) {\n  const selected = ref<T[]>([]);\n  const selectedAll = ref(false);\n  const selectedSome = computed(() => selected.value.length > 0);\n\n  watch(selected, () => {\n    selectedAll.value =\n      selected.value.length > 0 &&\n      selected.value.length === allItems.value.length;\n  });\n\n  watch(selectedAll, (yn) => {\n    if (yn) {\n      selected.value = allItems.value as UnwrapRef<T[]>;\n    } else {\n      selected.value = [];\n    }\n  });\n\n  return { selected, selectedAll, selectedSome };\n}\n","<script lang=\"ts\">\nimport { computed, defineComponent, reactive, watch } from 'vue';\nimport ItemGroup from '@/src/components/ItemGroup.vue';\nimport GroupableItem from '@/src/components/GroupableItem.vue';\nimport ImageListCard from '@/src/components/ImageListCard.vue';\nimport { createVTKImageThumbnailer } from '@/src/core/thumbnailers/vtk-image';\nimport { useImageStore } from '../store/datasets-images';\nimport { useDICOMStore } from '../store/datasets-dicom';\nimport {\n  DataSelection,\n  ImageSelection,\n  selectionEquals,\n  useDatasetStore,\n} from '../store/datasets';\nimport { useMultiSelection } from '../composables/useMultiSelection';\nimport { useLayersStore } from '../store/datasets-layers';\n\nfunction imageCacheKey(dataID: string) {\n  return `image-${dataID}`;\n}\n\nexport default defineComponent({\n  components: {\n    ItemGroup,\n    GroupableItem,\n    ImageListCard,\n  },\n  setup() {\n    const imageStore = useImageStore();\n    const dicomStore = useDICOMStore();\n    const dataStore = useDatasetStore();\n    const layersStore = useLayersStore();\n\n    const primarySelection = computed(() => dataStore.primarySelection);\n\n    const nonDICOMImages = computed(() =>\n      imageStore.idList.filter((id) => !(id in dicomStore.imageIDToVolumeKey))\n    );\n\n    const images = computed(() => {\n      const { metadata } = imageStore;\n\n      const layerImages = layersStore\n        .getLayers(primarySelection.value)\n        .filter(({ selection }) => selection.type === 'image');\n      const layerImageIDs = layerImages.map(\n        ({ selection }) => (selection as ImageSelection).dataID\n      );\n      const loadedLayerImageIDs = layerImages\n        .filter(({ id }) => id in layersStore.layerImages)\n        .map(({ selection }) => (selection as ImageSelection).dataID);\n\n      const selectedImageID =\n        primarySelection.value?.type === 'image' &&\n        primarySelection.value?.dataID;\n\n      return nonDICOMImages.value.map((id) => {\n        const selectionKey = {\n          type: 'image',\n          dataID: id,\n        } as DataSelection;\n        const layerAdded = layerImageIDs.includes(id);\n        const layerLoaded = loadedLayerImageIDs.includes(id);\n        const loading = layerAdded && !layerLoaded;\n        const layerable = id !== selectedImageID && primarySelection.value;\n        return {\n          id,\n          cacheKey: imageCacheKey(id),\n          // for UI selection\n          selectionKey,\n          name: metadata[id].name,\n          dimensions: metadata[id].dimensions,\n          spacing: [...metadata[id].spacing].map((s) => s.toFixed(2)),\n          layerable,\n          loading,\n          layerIcon: layerAdded ? 'mdi-layers-minus' : 'mdi-layers-plus',\n          layerTooltip: layerAdded ? 'Remove Layer' : 'Add Layer',\n          layerHandler: () => {\n            if (!loading && layerable) {\n              if (layerAdded)\n                layersStore.deleteLayer(primarySelection.value, selectionKey);\n              else layersStore.addLayer(primarySelection.value, selectionKey);\n            }\n          },\n        };\n      });\n    });\n\n    // --- thumbnails --- //\n\n    type Thumbnail = {\n      imageURI: string;\n      aspectRatio: number;\n    };\n    const thumbnails = reactive<Record<string, Thumbnail>>({});\n    const thumbnailer = createVTKImageThumbnailer();\n\n    watch(\n      nonDICOMImages,\n      (imageIDs) => {\n        imageIDs.forEach(async (id) => {\n          const cacheKey = imageCacheKey(id);\n          if (!(cacheKey in thumbnails)) {\n            const imageData = imageStore.dataIndex[id];\n            const canvasIM = thumbnailer.generate(imageData);\n            const imageURI = thumbnailer.imageDataToDataURI(canvasIM, 100, 100);\n            const dims = imageData.getDimensions();\n            const aspectRatio = dims[0] / dims[1];\n            thumbnails[cacheKey] = { imageURI, aspectRatio };\n          }\n        });\n\n        // delete old thumbnails\n        const idLookup = new Set(imageIDs.map((id) => imageCacheKey(id)));\n        Object.keys(thumbnails).forEach((cacheKey) => {\n          if (!idLookup.has(cacheKey)) {\n            delete thumbnails[cacheKey];\n          }\n        });\n      },\n      { immediate: true, deep: true }\n    );\n\n    // --- selection --- //\n\n    const { selected, selectedAll, selectedSome } =\n      useMultiSelection(nonDICOMImages);\n\n    function removeSelection() {\n      selected.value.forEach((id) => {\n        imageStore.deleteData(id);\n      });\n      selected.value = [];\n    }\n\n    return {\n      selected,\n      selectedAll,\n      selectedSome,\n      removeSelection,\n      images,\n      thumbnails,\n      primarySelection,\n      selectionEquals,\n      setPrimarySelection: (sel: DataSelection) => {\n        dataStore.setPrimarySelection(sel);\n      },\n    };\n  },\n});\n</script>\n\n<template>\n  <div>\n    <div v-if=\"images.length === 0\" class=\"text-center\">No images loaded</div>\n    <v-container v-show=\"images.length\" class=\"pa-0\">\n      <v-row no-gutters justify=\"space-between\" align=\"center\" class=\"mb-1\">\n        <v-col cols=\"6\">\n          <v-checkbox\n            class=\"ml-3\"\n            :indeterminate=\"selectedSome && !selectedAll\"\n            label=\"Select All\"\n            v-model=\"selectedAll\"\n            density=\"compact\"\n            hide-details\n          />\n        </v-col>\n        <v-col cols=\"6\" align-self=\"center\" class=\"d-flex justify-end\">\n          <v-btn\n            icon\n            variant=\"text\"\n            :disabled=\"!selectedSome\"\n            @click.stop=\"removeSelection\"\n          >\n            <v-icon>mdi-delete</v-icon>\n            <v-tooltip\n              :disabled=\"!selectedSome\"\n              location=\"left\"\n              activator=\"parent\"\n            >\n              Delete selected\n            </v-tooltip>\n          </v-btn>\n        </v-col>\n      </v-row>\n    </v-container>\n    <item-group\n      :model-value=\"primarySelection\"\n      :equals-test=\"selectionEquals\"\n      @update:model-value=\"setPrimarySelection\"\n    >\n      <groupable-item\n        v-for=\"image in images\"\n        :key=\"image.id\"\n        v-slot=\"{ active, select }\"\n        :value=\"image.selectionKey\"\n      >\n        <image-list-card\n          v-model=\"selected\"\n          class=\"mt-1\"\n          selectable\n          :inputValue=\"image.id\"\n          :active=\"active\"\n          :html-title=\"image.name\"\n          :image-url=\"(thumbnails[image.cacheKey] || {}).imageURI || ''\"\n          :image-size=\"100\"\n          :id=\"image.id\"\n          @click=\"select\"\n        >\n          <div class=\"text-body-2 font-weight-bold text-no-wrap text-truncate\">\n            {{ image.name }}\n          </div>\n          <div class=\"text-caption\">\n            Dims: ({{ image.dimensions.join(', ') }})\n          </div>\n          <div class=\"text-caption\">\n            Spacing: ({{ image.spacing.join(', ') }})\n          </div>\n          <v-btn\n            icon\n            variant=\"text\"\n            :disabled=\"!image.layerable\"\n            :loading=\"image.loading\"\n            @click.stop=\"image.layerHandler()\"\n            class=\"mt-1\"\n          >\n            <v-icon :icon=\"image.layerIcon\" />\n            <v-tooltip location=\"top\" activator=\"parent\">\n              {{ image.layerTooltip }}\n            </v-tooltip>\n          </v-btn>\n        </image-list-card>\n      </groupable-item>\n    </item-group>\n  </div>\n</template>\n","<script lang=\"ts\">\nimport { computed, defineComponent, reactive, watch } from 'vue';\nimport ItemGroup from '@/src/components/ItemGroup.vue';\nimport GroupableItem from '@/src/components/GroupableItem.vue';\nimport ImageListCard from '@/src/components/ImageListCard.vue';\nimport { createVTKImageThumbnailer } from '@/src/core/thumbnailers/vtk-image';\nimport { useImageStore } from '../store/datasets-images';\nimport { useDICOMStore } from '../store/datasets-dicom';\nimport {\n  DataSelection,\n  ImageSelection,\n  selectionEquals,\n  useDatasetStore,\n} from '../store/datasets';\nimport { useMultiSelection } from '../composables/useMultiSelection';\nimport { useLayersStore } from '../store/datasets-layers';\n\nfunction imageCacheKey(dataID: string) {\n  return `image-${dataID}`;\n}\n\nexport default defineComponent({\n  components: {\n    ItemGroup,\n    GroupableItem,\n    ImageListCard,\n  },\n  setup() {\n    const imageStore = useImageStore();\n    const dicomStore = useDICOMStore();\n    const dataStore = useDatasetStore();\n    const layersStore = useLayersStore();\n\n    const primarySelection = computed(() => dataStore.primarySelection);\n\n    const nonDICOMImages = computed(() =>\n      imageStore.idList.filter((id) => !(id in dicomStore.imageIDToVolumeKey))\n    );\n\n    const images = computed(() => {\n      const { metadata } = imageStore;\n\n      const layerImages = layersStore\n        .getLayers(primarySelection.value)\n        .filter(({ selection }) => selection.type === 'image');\n      const layerImageIDs = layerImages.map(\n        ({ selection }) => (selection as ImageSelection).dataID\n      );\n      const loadedLayerImageIDs = layerImages\n        .filter(({ id }) => id in layersStore.layerImages)\n        .map(({ selection }) => (selection as ImageSelection).dataID);\n\n      const selectedImageID =\n        primarySelection.value?.type === 'image' &&\n        primarySelection.value?.dataID;\n\n      return nonDICOMImages.value.map((id) => {\n        const selectionKey = {\n          type: 'image',\n          dataID: id,\n        } as DataSelection;\n        const layerAdded = layerImageIDs.includes(id);\n        const layerLoaded = loadedLayerImageIDs.includes(id);\n        const loading = layerAdded && !layerLoaded;\n        const layerable = id !== selectedImageID && primarySelection.value;\n        return {\n          id,\n          cacheKey: imageCacheKey(id),\n          // for UI selection\n          selectionKey,\n          name: metadata[id].name,\n          dimensions: metadata[id].dimensions,\n          spacing: [...metadata[id].spacing].map((s) => s.toFixed(2)),\n          layerable,\n          loading,\n          layerIcon: layerAdded ? 'mdi-layers-minus' : 'mdi-layers-plus',\n          layerTooltip: layerAdded ? 'Remove Layer' : 'Add Layer',\n          layerHandler: () => {\n            if (!loading && layerable) {\n              if (layerAdded)\n                layersStore.deleteLayer(primarySelection.value, selectionKey);\n              else layersStore.addLayer(primarySelection.value, selectionKey);\n            }\n          },\n        };\n      });\n    });\n\n    // --- thumbnails --- //\n\n    type Thumbnail = {\n      imageURI: string;\n      aspectRatio: number;\n    };\n    const thumbnails = reactive<Record<string, Thumbnail>>({});\n    const thumbnailer = createVTKImageThumbnailer();\n\n    watch(\n      nonDICOMImages,\n      (imageIDs) => {\n        imageIDs.forEach(async (id) => {\n          const cacheKey = imageCacheKey(id);\n          if (!(cacheKey in thumbnails)) {\n            const imageData = imageStore.dataIndex[id];\n            const canvasIM = thumbnailer.generate(imageData);\n            const imageURI = thumbnailer.imageDataToDataURI(canvasIM, 100, 100);\n            const dims = imageData.getDimensions();\n            const aspectRatio = dims[0] / dims[1];\n            thumbnails[cacheKey] = { imageURI, aspectRatio };\n          }\n        });\n\n        // delete old thumbnails\n        const idLookup = new Set(imageIDs.map((id) => imageCacheKey(id)));\n        Object.keys(thumbnails).forEach((cacheKey) => {\n          if (!idLookup.has(cacheKey)) {\n            delete thumbnails[cacheKey];\n          }\n        });\n      },\n      { immediate: true, deep: true }\n    );\n\n    // --- selection --- //\n\n    const { selected, selectedAll, selectedSome } =\n      useMultiSelection(nonDICOMImages);\n\n    function removeSelection() {\n      selected.value.forEach((id) => {\n        imageStore.deleteData(id);\n      });\n      selected.value = [];\n    }\n\n    return {\n      selected,\n      selectedAll,\n      selectedSome,\n      removeSelection,\n      images,\n      thumbnails,\n      primarySelection,\n      selectionEquals,\n      setPrimarySelection: (sel: DataSelection) => {\n        dataStore.setPrimarySelection(sel);\n      },\n    };\n  },\n});\n</script>\n\n<template>\n  <div>\n    <div v-if=\"images.length === 0\" class=\"text-center\">No images loaded</div>\n    <v-container v-show=\"images.length\" class=\"pa-0\">\n      <v-row no-gutters justify=\"space-between\" align=\"center\" class=\"mb-1\">\n        <v-col cols=\"6\">\n          <v-checkbox\n            class=\"ml-3\"\n            :indeterminate=\"selectedSome && !selectedAll\"\n            label=\"Select All\"\n            v-model=\"selectedAll\"\n            density=\"compact\"\n            hide-details\n          />\n        </v-col>\n        <v-col cols=\"6\" align-self=\"center\" class=\"d-flex justify-end\">\n          <v-btn\n            icon\n            variant=\"text\"\n            :disabled=\"!selectedSome\"\n            @click.stop=\"removeSelection\"\n          >\n            <v-icon>mdi-delete</v-icon>\n            <v-tooltip\n              :disabled=\"!selectedSome\"\n              location=\"left\"\n              activator=\"parent\"\n            >\n              Delete selected\n            </v-tooltip>\n          </v-btn>\n        </v-col>\n      </v-row>\n    </v-container>\n    <item-group\n      :model-value=\"primarySelection\"\n      :equals-test=\"selectionEquals\"\n      @update:model-value=\"setPrimarySelection\"\n    >\n      <groupable-item\n        v-for=\"image in images\"\n        :key=\"image.id\"\n        v-slot=\"{ active, select }\"\n        :value=\"image.selectionKey\"\n      >\n        <image-list-card\n          v-model=\"selected\"\n          class=\"mt-1\"\n          selectable\n          :inputValue=\"image.id\"\n          :active=\"active\"\n          :html-title=\"image.name\"\n          :image-url=\"(thumbnails[image.cacheKey] || {}).imageURI || ''\"\n          :image-size=\"100\"\n          :id=\"image.id\"\n          @click=\"select\"\n        >\n          <div class=\"text-body-2 font-weight-bold text-no-wrap text-truncate\">\n            {{ image.name }}\n          </div>\n          <div class=\"text-caption\">\n            Dims: ({{ image.dimensions.join(', ') }})\n          </div>\n          <div class=\"text-caption\">\n            Spacing: ({{ image.spacing.join(', ') }})\n          </div>\n          <v-btn\n            icon\n            variant=\"text\"\n            :disabled=\"!image.layerable\"\n            :loading=\"image.loading\"\n            @click.stop=\"image.layerHandler()\"\n            class=\"mt-1\"\n          >\n            <v-icon :icon=\"image.layerIcon\" />\n            <v-tooltip location=\"top\" activator=\"parent\">\n              {{ image.layerTooltip }}\n            </v-tooltip>\n          </v-btn>\n        </image-list-card>\n      </groupable-item>\n    </item-group>\n  </div>\n</template>\n","<script lang=\"ts\">\nimport { computed, defineComponent, reactive, toRefs, watch } from 'vue';\nimport { Image } from 'itk-wasm';\nimport type { PropType } from 'vue';\nimport GroupableItem from '@/src/components/GroupableItem.vue';\nimport { useDICOMStore } from '../store/datasets-dicom';\nimport {\n  DataSelection,\n  DICOMSelection,\n  useDatasetStore,\n} from '../store/datasets';\nimport { useMultiSelection } from '../composables/useMultiSelection';\nimport { useMessageStore } from '../store/messages';\nimport { useLayersStore } from '../store/datasets-layers';\nimport PersistentOverlay from './PersistentOverlay.vue';\n\nconst canvas = document.createElement('canvas');\n\nfunction dicomCacheKey(volKey: string) {\n  return `dicom-${volKey}`;\n}\n\n// Assume itkImage type is Uint8Array\nfunction itkImageToURI(itkImage: Image) {\n  const [width, height] = itkImage.size;\n  const im = new ImageData(width, height);\n  const arr32 = new Uint32Array(im.data.buffer);\n  const itkBuf = itkImage.data;\n  if (!itkBuf) {\n    return '';\n  }\n\n  for (let i = 0; i < itkBuf.length; i += 1) {\n    const byte = itkBuf[i] as number;\n    // ABGR order\n    // eslint-disable-next-line no-bitwise\n    arr32[i] = (255 << 24) | (byte << 16) | (byte << 8) | byte;\n  }\n\n  canvas.width = width;\n  canvas.height = height;\n  const ctx = canvas.getContext('2d');\n  if (ctx) {\n    ctx.putImageData(im, 0, 0);\n    return canvas.toDataURL('image/png');\n  }\n  return '';\n}\n\nasync function generateDICOMThumbnail(\n  dicomStore: ReturnType<typeof useDICOMStore>,\n  volumeKey: string\n) {\n  if (volumeKey in dicomStore.volumeInfo) {\n    return (await dicomStore.getVolumeThumbnail(volumeKey)) as Image;\n  }\n  throw new Error('No matching volume key in dicomStore');\n}\n\nexport default defineComponent({\n  name: 'PatientStudyVolumeBrowser',\n  props: {\n    volumeKeys: {\n      type: Array as PropType<Array<string>>,\n      required: true,\n    },\n  },\n  components: {\n    GroupableItem,\n    PersistentOverlay,\n  },\n  setup(props) {\n    const { volumeKeys } = toRefs(props);\n    const dicomStore = useDICOMStore();\n    const datasetStore = useDatasetStore();\n    const layersStore = useLayersStore();\n\n    const volumes = computed(() => {\n      const { volumeInfo } = dicomStore;\n      const { primarySelection } = datasetStore;\n      const layerVolumes = layersStore\n        .getLayers(primarySelection)\n        .filter(({ selection }) => selection.type === 'dicom');\n      const layerVolumeKeys = layerVolumes.map(\n        ({ selection }) => (selection as DICOMSelection).volumeKey\n      );\n      const loadedLayerVolumeKeys = layerVolumes\n        .filter(({ id }) => id in layersStore.layerImages)\n        .map(({ selection }) => (selection as DICOMSelection).volumeKey);\n      const selectedVolumeKey =\n        primarySelection?.type === 'dicom' && primarySelection.volumeKey;\n\n      return volumeKeys.value.map((volumeKey) => {\n        const selectionKey = {\n          type: 'dicom',\n          volumeKey,\n        } as DataSelection;\n        const layerAdded = layerVolumeKeys.includes(volumeKey);\n        const layerLoaded = loadedLayerVolumeKeys.includes(volumeKey);\n        const loading = layerAdded && !layerLoaded;\n        const layerable = volumeKey !== selectedVolumeKey && primarySelection;\n        return {\n          key: volumeKey,\n          // for thumbnailing\n          cacheKey: dicomCacheKey(volumeKey),\n          info: volumeInfo[volumeKey],\n          // for UI selection\n          selectionKey,\n          layerable,\n          loading,\n          layerIcon: layerAdded ? 'mdi-layers-minus' : 'mdi-layers-plus',\n          layerTooltip: layerAdded ? 'Remove Layer' : 'Add Layer',\n          layerHandler: () => {\n            if (!loading && layerable) {\n              if (layerAdded)\n                layersStore.deleteLayer(primarySelection, selectionKey);\n              else layersStore.addLayer(primarySelection, selectionKey);\n            }\n          },\n        };\n      });\n    });\n\n    // --- thumbnails --- //\n\n    const thumbnailCache = reactive<Record<string, string>>({});\n\n    watch(\n      volumeKeys,\n      (keys) => {\n        keys.forEach(async (key) => {\n          const cacheKey = dicomCacheKey(key);\n          if (cacheKey in thumbnailCache) {\n            return;\n          }\n\n          try {\n            const thumb = await generateDICOMThumbnail(dicomStore, key);\n            if (thumb !== null) {\n              const encodedImage = itkImageToURI(thumb);\n              thumbnailCache[cacheKey] = encodedImage;\n            }\n          } catch (err) {\n            if (err instanceof Error) {\n              const messageStore = useMessageStore();\n              messageStore.addError('Failed to generate thumbnails', {\n                details: `${err}. More details can be found in the developer's console.`,\n              });\n            }\n          }\n        });\n\n        // deletion case\n        const lookup = new Set(keys.map((key) => dicomCacheKey(key)));\n        Object.keys(thumbnailCache).forEach((key) => {\n          if (!lookup.has(key)) {\n            delete thumbnailCache[key];\n          }\n        });\n      },\n      { immediate: true, deep: true }\n    );\n\n    // --- selection --- //\n\n    const { selected, selectedAll, selectedSome } =\n      useMultiSelection(volumeKeys);\n\n    const removeSelectedDICOMVolumes = () => {\n      selected.value.forEach(async (volumeKey) => {\n        dicomStore.deleteVolume(volumeKey);\n      });\n\n      selected.value = [];\n    };\n\n    return {\n      selected,\n      selectedAll,\n      selectedSome,\n      thumbnailCache,\n      volumes,\n      removeSelectedDICOMVolumes,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-container class=\"pa-0\">\n    <v-row no-gutters justify=\"space-between\">\n      <v-col cols=\"6\" align-self=\"center\">\n        <v-checkbox\n          class=\"ml-3 align-center justify-center\"\n          :indeterminate=\"selectedSome && !selectedAll\"\n          label=\"Select All\"\n          v-model=\"selectedAll\"\n          density=\"compact\"\n          hide-details\n        />\n      </v-col>\n      <v-col cols=\"6\" align-self=\"center\" class=\"d-flex justify-end mt-2\">\n        <v-btn\n          icon\n          variant=\"text\"\n          :disabled=\"!selectedSome\"\n          @click.stop=\"removeSelectedDICOMVolumes\"\n        >\n          <v-icon>mdi-delete</v-icon>\n          <v-tooltip location=\"left\" activator=\"parent\">\n            Delete selected\n          </v-tooltip>\n        </v-btn>\n      </v-col>\n    </v-row>\n    <v-row no-gutters>\n      <v-col>\n        <div class=\"my-2 volume-list\">\n          <groupable-item\n            v-for=\"volume in volumes\"\n            :key=\"volume.info.VolumeID\"\n            v-slot:default=\"{ active, select }\"\n            :value=\"volume.selectionKey\"\n          >\n            <v-card\n              variant=\"outlined\"\n              ripple\n              :class=\"{\n                'volume-card': true,\n                'mt-1': true,\n                'volume-card-active': active,\n              }\"\n              min-height=\"180px\"\n              min-width=\"180px\"\n              :html-title=\"volume.info.SeriesDescription\"\n              @click=\"select\"\n            >\n              <v-row no-gutters class=\"pa-0\" justify=\"center\">\n                <div class=\"thumbnail-container\">\n                  <v-img\n                    cover\n                    height=\"150\"\n                    width=\"150\"\n                    :src=\"(thumbnailCache || {})[volume.cacheKey] || ''\"\n                  >\n                    <template v-slot:placeholder>\n                      <v-row\n                        class=\"fill-height ma-0\"\n                        align=\"center\"\n                        justify=\"center\"\n                      >\n                        <v-progress-circular\n                          indeterminate\n                          color=\"grey-lighten-5\"\n                        />\n                      </v-row>\n                    </template>\n                    <persistent-overlay>\n                      <div class=\"d-flex flex-column fill-height\">\n                        <v-row no-gutters justify=\"end\" align-content=\"start\">\n                          <div class=\"layer-btn-container\">\n                            <v-btn\n                              :disabled=\"!volume.layerable\"\n                              :loading=\"volume.loading\"\n                              icon\n                              variant=\"plain\"\n                              density=\"compact\"\n                              @click.stop=\"volume.layerHandler\"\n                            >\n                              <v-icon :icon=\"volume.layerIcon\" />\n                              <v-tooltip location=\"top\" activator=\"parent\">\n                                {{ volume.layerTooltip }}\n                              </v-tooltip>\n                            </v-btn>\n                          </div>\n                          <v-checkbox\n                            :key=\"volume.info.VolumeID\"\n                            :value=\"volume.key\"\n                            v-model=\"selected\"\n                            @click.stop\n                            density=\"compact\"\n                            hide-details\n                            class=\"series-selector\"\n                          />\n                        </v-row>\n                        <v-spacer />\n                        <v-row no-gutters justify=\"start\" align=\"end\">\n                          <div class=\"mb-1 ml-1 text-caption\">\n                            [{{ volume.info.NumberOfSlices }}]\n                          </div>\n                        </v-row>\n                      </div>\n                    </persistent-overlay>\n                  </v-img>\n                </div>\n              </v-row>\n              <v-card-text\n                class=\"text--primary text-caption text-center series-desc mt-n3\"\n              >\n                <div class=\"text-ellipsis\">\n                  {{ volume.info.SeriesDescription || '(no description)' }}\n                </div>\n              </v-card-text>\n            </v-card>\n          </groupable-item>\n        </div>\n      </v-col>\n    </v-row>\n  </v-container>\n</template>\n\n<style scoped>\n.volume-list {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n  grid-auto-rows: 200px;\n  justify-content: center;\n}\n\n.volume-card {\n  padding: 8px;\n  cursor: pointer;\n}\n\n.volume-card-active {\n  background-color: rgb(var(--v-theme-selection-bg-color));\n  border-color: rgb(var(--v-theme-selection-border-color));\n}\n\n.series-desc {\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n}\n\n.series-selector {\n  max-width: 36px;\n}\n\n.thumbnail-container {\n  background-color: rgba(0, 0, 0, 0.1);\n  border-radius: 3px;\n}\n\n.layer-btn-container {\n  display: flex;\n  flex-flow: column;\n  justify-content: center;\n  height: var(--v-input-control-height);\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent, reactive, toRefs, watch } from 'vue';\nimport { Image } from 'itk-wasm';\nimport type { PropType } from 'vue';\nimport GroupableItem from '@/src/components/GroupableItem.vue';\nimport { useDICOMStore } from '../store/datasets-dicom';\nimport {\n  DataSelection,\n  DICOMSelection,\n  useDatasetStore,\n} from '../store/datasets';\nimport { useMultiSelection } from '../composables/useMultiSelection';\nimport { useMessageStore } from '../store/messages';\nimport { useLayersStore } from '../store/datasets-layers';\nimport PersistentOverlay from './PersistentOverlay.vue';\n\nconst canvas = document.createElement('canvas');\n\nfunction dicomCacheKey(volKey: string) {\n  return `dicom-${volKey}`;\n}\n\n// Assume itkImage type is Uint8Array\nfunction itkImageToURI(itkImage: Image) {\n  const [width, height] = itkImage.size;\n  const im = new ImageData(width, height);\n  const arr32 = new Uint32Array(im.data.buffer);\n  const itkBuf = itkImage.data;\n  if (!itkBuf) {\n    return '';\n  }\n\n  for (let i = 0; i < itkBuf.length; i += 1) {\n    const byte = itkBuf[i] as number;\n    // ABGR order\n    // eslint-disable-next-line no-bitwise\n    arr32[i] = (255 << 24) | (byte << 16) | (byte << 8) | byte;\n  }\n\n  canvas.width = width;\n  canvas.height = height;\n  const ctx = canvas.getContext('2d');\n  if (ctx) {\n    ctx.putImageData(im, 0, 0);\n    return canvas.toDataURL('image/png');\n  }\n  return '';\n}\n\nasync function generateDICOMThumbnail(\n  dicomStore: ReturnType<typeof useDICOMStore>,\n  volumeKey: string\n) {\n  if (volumeKey in dicomStore.volumeInfo) {\n    return (await dicomStore.getVolumeThumbnail(volumeKey)) as Image;\n  }\n  throw new Error('No matching volume key in dicomStore');\n}\n\nexport default defineComponent({\n  name: 'PatientStudyVolumeBrowser',\n  props: {\n    volumeKeys: {\n      type: Array as PropType<Array<string>>,\n      required: true,\n    },\n  },\n  components: {\n    GroupableItem,\n    PersistentOverlay,\n  },\n  setup(props) {\n    const { volumeKeys } = toRefs(props);\n    const dicomStore = useDICOMStore();\n    const datasetStore = useDatasetStore();\n    const layersStore = useLayersStore();\n\n    const volumes = computed(() => {\n      const { volumeInfo } = dicomStore;\n      const { primarySelection } = datasetStore;\n      const layerVolumes = layersStore\n        .getLayers(primarySelection)\n        .filter(({ selection }) => selection.type === 'dicom');\n      const layerVolumeKeys = layerVolumes.map(\n        ({ selection }) => (selection as DICOMSelection).volumeKey\n      );\n      const loadedLayerVolumeKeys = layerVolumes\n        .filter(({ id }) => id in layersStore.layerImages)\n        .map(({ selection }) => (selection as DICOMSelection).volumeKey);\n      const selectedVolumeKey =\n        primarySelection?.type === 'dicom' && primarySelection.volumeKey;\n\n      return volumeKeys.value.map((volumeKey) => {\n        const selectionKey = {\n          type: 'dicom',\n          volumeKey,\n        } as DataSelection;\n        const layerAdded = layerVolumeKeys.includes(volumeKey);\n        const layerLoaded = loadedLayerVolumeKeys.includes(volumeKey);\n        const loading = layerAdded && !layerLoaded;\n        const layerable = volumeKey !== selectedVolumeKey && primarySelection;\n        return {\n          key: volumeKey,\n          // for thumbnailing\n          cacheKey: dicomCacheKey(volumeKey),\n          info: volumeInfo[volumeKey],\n          // for UI selection\n          selectionKey,\n          layerable,\n          loading,\n          layerIcon: layerAdded ? 'mdi-layers-minus' : 'mdi-layers-plus',\n          layerTooltip: layerAdded ? 'Remove Layer' : 'Add Layer',\n          layerHandler: () => {\n            if (!loading && layerable) {\n              if (layerAdded)\n                layersStore.deleteLayer(primarySelection, selectionKey);\n              else layersStore.addLayer(primarySelection, selectionKey);\n            }\n          },\n        };\n      });\n    });\n\n    // --- thumbnails --- //\n\n    const thumbnailCache = reactive<Record<string, string>>({});\n\n    watch(\n      volumeKeys,\n      (keys) => {\n        keys.forEach(async (key) => {\n          const cacheKey = dicomCacheKey(key);\n          if (cacheKey in thumbnailCache) {\n            return;\n          }\n\n          try {\n            const thumb = await generateDICOMThumbnail(dicomStore, key);\n            if (thumb !== null) {\n              const encodedImage = itkImageToURI(thumb);\n              thumbnailCache[cacheKey] = encodedImage;\n            }\n          } catch (err) {\n            if (err instanceof Error) {\n              const messageStore = useMessageStore();\n              messageStore.addError('Failed to generate thumbnails', {\n                details: `${err}. More details can be found in the developer's console.`,\n              });\n            }\n          }\n        });\n\n        // deletion case\n        const lookup = new Set(keys.map((key) => dicomCacheKey(key)));\n        Object.keys(thumbnailCache).forEach((key) => {\n          if (!lookup.has(key)) {\n            delete thumbnailCache[key];\n          }\n        });\n      },\n      { immediate: true, deep: true }\n    );\n\n    // --- selection --- //\n\n    const { selected, selectedAll, selectedSome } =\n      useMultiSelection(volumeKeys);\n\n    const removeSelectedDICOMVolumes = () => {\n      selected.value.forEach(async (volumeKey) => {\n        dicomStore.deleteVolume(volumeKey);\n      });\n\n      selected.value = [];\n    };\n\n    return {\n      selected,\n      selectedAll,\n      selectedSome,\n      thumbnailCache,\n      volumes,\n      removeSelectedDICOMVolumes,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-container class=\"pa-0\">\n    <v-row no-gutters justify=\"space-between\">\n      <v-col cols=\"6\" align-self=\"center\">\n        <v-checkbox\n          class=\"ml-3 align-center justify-center\"\n          :indeterminate=\"selectedSome && !selectedAll\"\n          label=\"Select All\"\n          v-model=\"selectedAll\"\n          density=\"compact\"\n          hide-details\n        />\n      </v-col>\n      <v-col cols=\"6\" align-self=\"center\" class=\"d-flex justify-end mt-2\">\n        <v-btn\n          icon\n          variant=\"text\"\n          :disabled=\"!selectedSome\"\n          @click.stop=\"removeSelectedDICOMVolumes\"\n        >\n          <v-icon>mdi-delete</v-icon>\n          <v-tooltip location=\"left\" activator=\"parent\">\n            Delete selected\n          </v-tooltip>\n        </v-btn>\n      </v-col>\n    </v-row>\n    <v-row no-gutters>\n      <v-col>\n        <div class=\"my-2 volume-list\">\n          <groupable-item\n            v-for=\"volume in volumes\"\n            :key=\"volume.info.VolumeID\"\n            v-slot:default=\"{ active, select }\"\n            :value=\"volume.selectionKey\"\n          >\n            <v-card\n              variant=\"outlined\"\n              ripple\n              :class=\"{\n                'volume-card': true,\n                'mt-1': true,\n                'volume-card-active': active,\n              }\"\n              min-height=\"180px\"\n              min-width=\"180px\"\n              :html-title=\"volume.info.SeriesDescription\"\n              @click=\"select\"\n            >\n              <v-row no-gutters class=\"pa-0\" justify=\"center\">\n                <div class=\"thumbnail-container\">\n                  <v-img\n                    cover\n                    height=\"150\"\n                    width=\"150\"\n                    :src=\"(thumbnailCache || {})[volume.cacheKey] || ''\"\n                  >\n                    <template v-slot:placeholder>\n                      <v-row\n                        class=\"fill-height ma-0\"\n                        align=\"center\"\n                        justify=\"center\"\n                      >\n                        <v-progress-circular\n                          indeterminate\n                          color=\"grey-lighten-5\"\n                        />\n                      </v-row>\n                    </template>\n                    <persistent-overlay>\n                      <div class=\"d-flex flex-column fill-height\">\n                        <v-row no-gutters justify=\"end\" align-content=\"start\">\n                          <div class=\"layer-btn-container\">\n                            <v-btn\n                              :disabled=\"!volume.layerable\"\n                              :loading=\"volume.loading\"\n                              icon\n                              variant=\"plain\"\n                              density=\"compact\"\n                              @click.stop=\"volume.layerHandler\"\n                            >\n                              <v-icon :icon=\"volume.layerIcon\" />\n                              <v-tooltip location=\"top\" activator=\"parent\">\n                                {{ volume.layerTooltip }}\n                              </v-tooltip>\n                            </v-btn>\n                          </div>\n                          <v-checkbox\n                            :key=\"volume.info.VolumeID\"\n                            :value=\"volume.key\"\n                            v-model=\"selected\"\n                            @click.stop\n                            density=\"compact\"\n                            hide-details\n                            class=\"series-selector\"\n                          />\n                        </v-row>\n                        <v-spacer />\n                        <v-row no-gutters justify=\"start\" align=\"end\">\n                          <div class=\"mb-1 ml-1 text-caption\">\n                            [{{ volume.info.NumberOfSlices }}]\n                          </div>\n                        </v-row>\n                      </div>\n                    </persistent-overlay>\n                  </v-img>\n                </div>\n              </v-row>\n              <v-card-text\n                class=\"text--primary text-caption text-center series-desc mt-n3\"\n              >\n                <div class=\"text-ellipsis\">\n                  {{ volume.info.SeriesDescription || '(no description)' }}\n                </div>\n              </v-card-text>\n            </v-card>\n          </groupable-item>\n        </div>\n      </v-col>\n    </v-row>\n  </v-container>\n</template>\n\n<style scoped>\n.volume-list {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n  grid-auto-rows: 200px;\n  justify-content: center;\n}\n\n.volume-card {\n  padding: 8px;\n  cursor: pointer;\n}\n\n.volume-card-active {\n  background-color: rgb(var(--v-theme-selection-bg-color));\n  border-color: rgb(var(--v-theme-selection-border-color));\n}\n\n.series-desc {\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n}\n\n.series-selector {\n  max-width: 36px;\n}\n\n.thumbnail-container {\n  background-color: rgba(0, 0, 0, 0.1);\n  border-radius: 3px;\n}\n\n.layer-btn-container {\n  display: flex;\n  flex-flow: column;\n  justify-content: center;\n  height: var(--v-input-control-height);\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent, ref, toRefs, watch } from 'vue';\nimport type { Ref } from 'vue';\nimport ItemGroup from '@/src/components/ItemGroup.vue';\nimport { useDICOMStore } from '../store/datasets-dicom';\nimport {\n  DataSelection,\n  DICOMSelection,\n  selectionEquals,\n  useDatasetStore,\n} from '../store/datasets';\nimport { useMultiSelection } from '../composables/useMultiSelection';\nimport PatientStudyVolumeBrowser from './PatientStudyVolumeBrowser.vue';\n\nexport default defineComponent({\n  name: 'PatientBrowser',\n  props: {\n    patientKey: {\n      type: String,\n      required: true,\n    },\n  },\n  components: {\n    ItemGroup,\n    PatientStudyVolumeBrowser,\n  },\n  setup(props) {\n    const { patientKey } = toRefs(props);\n\n    const selectedSeries: Ref<DICOMSelection[]> = ref([]);\n\n    const dicomStore = useDICOMStore();\n    const dataStore = useDatasetStore();\n\n    const primarySelection = computed(() => dataStore.primarySelection);\n\n    const studies = computed(() => {\n      const selPatient = patientKey.value;\n      const { patientStudies, studyInfo, studyVolumes } = dicomStore;\n      return (patientStudies[selPatient] ?? []).map((studyKey) => {\n        const info = studyInfo[studyKey];\n        return {\n          ...info,\n          key: studyKey,\n          title:\n            info.StudyDescription || info.StudyDate || info.StudyInstanceUID,\n          volumeKeys: studyVolumes[studyKey].sort(),\n        };\n      });\n    });\n\n    const studyKeys = computed(() => studies.value.map((study) => study.key));\n    const panels = ref<string[]>([]);\n\n    watch(\n      studyKeys,\n      (keys) => {\n        panels.value = Array.from(new Set([...panels.value, ...keys]));\n      },\n      { immediate: true }\n    );\n\n    // --- selection --- //\n\n    const { selected, selectedAll, selectedSome } =\n      useMultiSelection(studyKeys);\n\n    const removeSelectedStudies = () => {\n      selected.value.forEach(async (study) => {\n        dicomStore.deleteStudy(study);\n      });\n      selected.value = [];\n\n      // Handle the case where we are deleting the selected study\n      // if (selected.value.indexOf(selectedStudy.value) !== -1) {\n      //   dataStore.setPrimarySelection(null);\n      // }\n    };\n\n    return {\n      selected,\n      selectedAll,\n      selectedSome,\n      selectedSeries,\n      primarySelection,\n      removeSelectedStudies,\n      studies,\n      selectionEquals,\n      setPrimarySelection: (sel: DataSelection) => {\n        dataStore.setPrimarySelection(sel);\n      },\n      panels,\n    };\n  },\n});\n</script>\n\n<template>\n  <item-group\n    :model-value=\"primarySelection\"\n    :equals-test=\"selectionEquals\"\n    @update:model-value=\"setPrimarySelection\"\n  >\n    <v-container class=\"pa-0\">\n      <v-row no-gutters justify=\"space-between\" class=\"mb-2\">\n        <v-col cols=\"6\" align-self=\"center\">\n          <v-checkbox\n            class=\"ml-3 align-center justify-center\"\n            :indeterminate=\"selectedSome && !selectedAll\"\n            label=\"Select All Studies\"\n            v-model=\"selectedAll\"\n            density=\"compact\"\n            hide-details\n          />\n        </v-col>\n        <v-col cols=\"6\" align-self=\"center\" class=\"d-flex justify-end mt-2\">\n          <v-btn\n            icon\n            variant=\"text\"\n            :disabled=\"!selectedSome\"\n            @click.stop=\"removeSelectedStudies\"\n          >\n            <v-icon>mdi-delete</v-icon>\n            <v-tooltip activator=\"parent\" location=\"left\">\n              Delete Selected\n            </v-tooltip>\n          </v-btn>\n        </v-col>\n      </v-row>\n    </v-container>\n    <v-expansion-panels\n      v-model=\"panels\"\n      id=\"patient-data-studies\"\n      accordion\n      multiple\n    >\n      <v-expansion-panel\n        v-for=\"study in studies\"\n        :key=\"study.StudyInstanceUID\"\n        :value=\"study.StudyInstanceUID\"\n        class=\"patient-data-study-panel\"\n      >\n        <v-expansion-panel-title\n          color=\"#1976fa0a\"\n          class=\"pl-3 no-select\"\n          :title=\"study.StudyDate\"\n        >\n          <div class=\"study-header\">\n            <div class=\"study-header-title\">\n              <v-checkbox\n                class=\"study-selector\"\n                density=\"compact\"\n                hide-details\n                :key=\"study.StudyInstanceUID\"\n                :value=\"study.StudyInstanceUID\"\n                v-model=\"selected\"\n                @click.stop\n              />\n              <v-icon>mdi-folder-table</v-icon>\n              <div class=\"ml-2 overflow-hidden text-no-wrap\">\n                <div class=\"text-subtitle-2 text-truncate\" :title=\"study.title\">\n                  {{ study.title }}\n                </div>\n                <div\n                  v-if=\"study.StudyDescription\"\n                  class=\"text-caption text-truncate\"\n                >\n                  {{ study.StudyDate }}\n                </div>\n              </div>\n            </div>\n\n            <div class=\"d-flex flex-column align-center justify-end mx-2\">\n              <div class=\"d-flex flex-row align-center mr-2\">\n                <v-icon small>mdi-folder-open</v-icon>\n                <span class=\"text-caption text--secondary text-no-wrap\">\n                  : {{ study.volumeKeys.length }}\n                </span>\n                <v-tooltip location=\"bottom\" activator=\"parent\">\n                  Total series in study\n                </v-tooltip>\n              </div>\n            </div>\n          </div>\n        </v-expansion-panel-title>\n        <v-expansion-panel-text>\n          <patient-study-volume-browser :volume-keys=\"study.volumeKeys\" />\n        </v-expansion-panel-text>\n      </v-expansion-panel>\n    </v-expansion-panels>\n  </item-group>\n</template>\n\n<style>\n#patient-data-studies .v-expansion-panel::before {\n  box-shadow: none;\n}\n</style>\n\n<style scoped>\n.study-header {\n  display: flex;\n  flex-flow: row;\n  align-items: center;\n  width: calc(100% - 24px);\n}\n\n.study-selector {\n  flex: 0 0 auto;\n}\n\n.study-header-title {\n  display: flex;\n  flex-flow: row;\n  align-items: center;\n  flex-grow: 1;\n  /* used to ensure that the text can truncate */\n  min-width: 0;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent, ref, toRefs, watch } from 'vue';\nimport type { Ref } from 'vue';\nimport ItemGroup from '@/src/components/ItemGroup.vue';\nimport { useDICOMStore } from '../store/datasets-dicom';\nimport {\n  DataSelection,\n  DICOMSelection,\n  selectionEquals,\n  useDatasetStore,\n} from '../store/datasets';\nimport { useMultiSelection } from '../composables/useMultiSelection';\nimport PatientStudyVolumeBrowser from './PatientStudyVolumeBrowser.vue';\n\nexport default defineComponent({\n  name: 'PatientBrowser',\n  props: {\n    patientKey: {\n      type: String,\n      required: true,\n    },\n  },\n  components: {\n    ItemGroup,\n    PatientStudyVolumeBrowser,\n  },\n  setup(props) {\n    const { patientKey } = toRefs(props);\n\n    const selectedSeries: Ref<DICOMSelection[]> = ref([]);\n\n    const dicomStore = useDICOMStore();\n    const dataStore = useDatasetStore();\n\n    const primarySelection = computed(() => dataStore.primarySelection);\n\n    const studies = computed(() => {\n      const selPatient = patientKey.value;\n      const { patientStudies, studyInfo, studyVolumes } = dicomStore;\n      return (patientStudies[selPatient] ?? []).map((studyKey) => {\n        const info = studyInfo[studyKey];\n        return {\n          ...info,\n          key: studyKey,\n          title:\n            info.StudyDescription || info.StudyDate || info.StudyInstanceUID,\n          volumeKeys: studyVolumes[studyKey].sort(),\n        };\n      });\n    });\n\n    const studyKeys = computed(() => studies.value.map((study) => study.key));\n    const panels = ref<string[]>([]);\n\n    watch(\n      studyKeys,\n      (keys) => {\n        panels.value = Array.from(new Set([...panels.value, ...keys]));\n      },\n      { immediate: true }\n    );\n\n    // --- selection --- //\n\n    const { selected, selectedAll, selectedSome } =\n      useMultiSelection(studyKeys);\n\n    const removeSelectedStudies = () => {\n      selected.value.forEach(async (study) => {\n        dicomStore.deleteStudy(study);\n      });\n      selected.value = [];\n\n      // Handle the case where we are deleting the selected study\n      // if (selected.value.indexOf(selectedStudy.value) !== -1) {\n      //   dataStore.setPrimarySelection(null);\n      // }\n    };\n\n    return {\n      selected,\n      selectedAll,\n      selectedSome,\n      selectedSeries,\n      primarySelection,\n      removeSelectedStudies,\n      studies,\n      selectionEquals,\n      setPrimarySelection: (sel: DataSelection) => {\n        dataStore.setPrimarySelection(sel);\n      },\n      panels,\n    };\n  },\n});\n</script>\n\n<template>\n  <item-group\n    :model-value=\"primarySelection\"\n    :equals-test=\"selectionEquals\"\n    @update:model-value=\"setPrimarySelection\"\n  >\n    <v-container class=\"pa-0\">\n      <v-row no-gutters justify=\"space-between\" class=\"mb-2\">\n        <v-col cols=\"6\" align-self=\"center\">\n          <v-checkbox\n            class=\"ml-3 align-center justify-center\"\n            :indeterminate=\"selectedSome && !selectedAll\"\n            label=\"Select All Studies\"\n            v-model=\"selectedAll\"\n            density=\"compact\"\n            hide-details\n          />\n        </v-col>\n        <v-col cols=\"6\" align-self=\"center\" class=\"d-flex justify-end mt-2\">\n          <v-btn\n            icon\n            variant=\"text\"\n            :disabled=\"!selectedSome\"\n            @click.stop=\"removeSelectedStudies\"\n          >\n            <v-icon>mdi-delete</v-icon>\n            <v-tooltip activator=\"parent\" location=\"left\">\n              Delete Selected\n            </v-tooltip>\n          </v-btn>\n        </v-col>\n      </v-row>\n    </v-container>\n    <v-expansion-panels\n      v-model=\"panels\"\n      id=\"patient-data-studies\"\n      accordion\n      multiple\n    >\n      <v-expansion-panel\n        v-for=\"study in studies\"\n        :key=\"study.StudyInstanceUID\"\n        :value=\"study.StudyInstanceUID\"\n        class=\"patient-data-study-panel\"\n      >\n        <v-expansion-panel-title\n          color=\"#1976fa0a\"\n          class=\"pl-3 no-select\"\n          :title=\"study.StudyDate\"\n        >\n          <div class=\"study-header\">\n            <div class=\"study-header-title\">\n              <v-checkbox\n                class=\"study-selector\"\n                density=\"compact\"\n                hide-details\n                :key=\"study.StudyInstanceUID\"\n                :value=\"study.StudyInstanceUID\"\n                v-model=\"selected\"\n                @click.stop\n              />\n              <v-icon>mdi-folder-table</v-icon>\n              <div class=\"ml-2 overflow-hidden text-no-wrap\">\n                <div class=\"text-subtitle-2 text-truncate\" :title=\"study.title\">\n                  {{ study.title }}\n                </div>\n                <div\n                  v-if=\"study.StudyDescription\"\n                  class=\"text-caption text-truncate\"\n                >\n                  {{ study.StudyDate }}\n                </div>\n              </div>\n            </div>\n\n            <div class=\"d-flex flex-column align-center justify-end mx-2\">\n              <div class=\"d-flex flex-row align-center mr-2\">\n                <v-icon small>mdi-folder-open</v-icon>\n                <span class=\"text-caption text--secondary text-no-wrap\">\n                  : {{ study.volumeKeys.length }}\n                </span>\n                <v-tooltip location=\"bottom\" activator=\"parent\">\n                  Total series in study\n                </v-tooltip>\n              </div>\n            </div>\n          </div>\n        </v-expansion-panel-title>\n        <v-expansion-panel-text>\n          <patient-study-volume-browser :volume-keys=\"study.volumeKeys\" />\n        </v-expansion-panel-text>\n      </v-expansion-panel>\n    </v-expansion-panels>\n  </item-group>\n</template>\n\n<style>\n#patient-data-studies .v-expansion-panel::before {\n  box-shadow: none;\n}\n</style>\n\n<style scoped>\n.study-header {\n  display: flex;\n  flex-flow: row;\n  align-items: center;\n  width: calc(100% - 24px);\n}\n\n.study-selector {\n  flex: 0 0 auto;\n}\n\n.study-header-title {\n  display: flex;\n  flex-flow: row;\n  align-items: center;\n  flex-grow: 1;\n  /* used to ensure that the text can truncate */\n  min-width: 0;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent, reactive, ref, toRefs, watch } from 'vue';\nimport type { PropType } from 'vue';\nimport { useDicomMetaStore } from '../../store/dicom-web/dicom-meta-store';\nimport {\n  useDicomWebStore,\n  isDownloadable,\n  VolumeProgress,\n} from '../../store/dicom-web/dicom-web-store';\nimport { formatBytes } from '../../utils';\nimport PersistentOverlay from '../PersistentOverlay.vue';\n\nconst percentDone = (progress: VolumeProgress): number => {\n  if (!progress || progress.total === 0) return 0;\n  const { total, loaded } = progress;\n  return Math.round((100 * loaded) / total);\n};\n\nexport default defineComponent({\n  name: 'StudyVolumeDicomWeb',\n  props: {\n    volumeKeys: {\n      type: Array as PropType<Array<string>>,\n      required: true,\n    },\n  },\n  components: { PersistentOverlay },\n  setup(props) {\n    const { volumeKeys } = toRefs(props);\n\n    const dicomStore = useDicomMetaStore();\n    const dicomWebStore = useDicomWebStore();\n\n    const isFetching = ref(true);\n    dicomWebStore.fetchVolumesMeta(volumeKeys.value).then(() => {\n      isFetching.value = false;\n    });\n\n    const volumes = computed(() => {\n      if (isFetching.value) return [];\n\n      const { volumeInfo, volumeInstances, instanceInfo } = dicomStore;\n      return volumeKeys.value.map((volumeKey) => {\n        const { Rows: rows, Columns: columns } =\n          instanceInfo[volumeInstances[volumeKey][0]];\n        const info = volumeInfo[volumeKey];\n        return {\n          key: volumeKey,\n          info,\n          widthHeightFrames: `${columns} x ${rows} x ${info.NumberOfSlices}`,\n          isDisabled: !isDownloadable(dicomWebStore.volumes[volumeKey]),\n          progress: {\n            ...dicomWebStore.volumes[volumeKey],\n            percent: percentDone(dicomWebStore.volumes[volumeKey]),\n          },\n        };\n      });\n    });\n\n    const thumbnailCache = reactive<Record<string, string>>({});\n\n    watch(\n      [volumeKeys, isFetching],\n      ([keys, guard]) => {\n        if (guard) return;\n\n        keys\n          .filter((key) => !(key in thumbnailCache))\n          .forEach(async (key) => {\n            const thumb = await dicomWebStore.fetchVolumeThumbnail(key);\n            if (thumb !== null) {\n              thumbnailCache[key] = thumb;\n            }\n          });\n      },\n      { immediate: true, deep: true }\n    );\n\n    function downloadDicom(volumeKey: string) {\n      dicomWebStore.downloadVolume(volumeKey);\n    }\n\n    return {\n      thumbnailCache,\n      volumes,\n      downloadDicom,\n      formatBytes,\n      isFetching,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-container class=\"pa-0\">\n    <v-row no-gutters>\n      <v-col>\n        <div class=\"my-2 volume-list\">\n          <v-progress-circular v-if=\"isFetching\" class=\"fetching\" indeterminate>\n          </v-progress-circular>\n\n          <v-card\n            v-for=\"volume in volumes\"\n            :key=\"volume.info.VolumeID\"\n            variant=\"outlined\"\n            class=\"volume-card mt-1\"\n            min-height=\"180px\"\n            min-width=\"180px\"\n            :html-title=\"volume.info.SeriesDescription\"\n            :disabled=\"volume.isDisabled\"\n            :ripple=\"!volume.isDisabled\"\n            @click=\"downloadDicom(volume.info.VolumeID)\"\n          >\n            <v-row no-gutters class=\"pa-0\" justify=\"center\">\n              <div class=\"thumbnail-container\">\n                <v-img\n                  cover\n                  height=\"150\"\n                  width=\"150\"\n                  :src=\"(thumbnailCache || {})[volume.key] || ''\"\n                >\n                  <persistent-overlay>\n                    <v-row no-gutters>\n                      <div class=\"mb-1 ml-1 text-caption\">\n                        {{ volume.widthHeightFrames }}\n                        <v-tooltip location=\"top\" activator=\"parent\">\n                          Width by height by frames\n                        </v-tooltip>\n                      </div>\n                    </v-row>\n                  </persistent-overlay>\n\n                  <persistent-overlay\n                    v-if=\"\n                      volume.progress &&\n                      volume.progress.state &&\n                      volume.progress.state !== 'Remote'\n                    \"\n                  >\n                    <div class=\"d-flex flex-column fill-height ma-0\">\n                      <v-row no-gutters justify=\"center\" align=\"end\">\n                        <v-progress-circular\n                          color=\"white\"\n                          :indeterminate=\"\n                            volume.progress.percent === 0 &&\n                            volume.progress.state !== 'Done'\n                          \"\n                          :model-value=\"volume.progress.percent\"\n                        >\n                          <v-icon\n                            v-if=\"volume.progress.state === 'Done'\"\n                            color=\"white\"\n                          >\n                            mdi-check\n                          </v-icon>\n                          <v-icon\n                            v-else-if=\"volume.progress.state === 'Error'\"\n                            color=\"white\"\n                          >\n                            mdi-alert-circle\n                          </v-icon>\n                          <span\n                            v-else-if=\"volume.progress.percent !== 0\"\n                            class=\"text-caption text--white\"\n                          >\n                            {{ volume.progress.percent }}\n                          </span>\n                        </v-progress-circular>\n                      </v-row>\n                      <v-row no-gutters justify=\"center\" align=\"end\">\n                        <div\n                          v-if=\"volume.progress.loaded !== 0\"\n                          class=\"mb-1 text-caption\"\n                        >\n                          {{ formatBytes(volume.progress.loaded) }}\n                        </div>\n                      </v-row>\n                    </div>\n                  </persistent-overlay>\n                </v-img>\n              </div>\n            </v-row>\n            <v-card-text\n              class=\"text--primary text-caption text-center series-desc mt-n3\"\n            >\n              <div class=\"text-ellipsis\">\n                {{ volume.info.SeriesDescription || '(no series description)' }}\n              </div>\n            </v-card-text>\n          </v-card>\n        </div>\n      </v-col>\n    </v-row>\n  </v-container>\n</template>\n\n<style scoped>\n.volume-list {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n  grid-auto-rows: 200px;\n  justify-content: center;\n}\n\n.volume-card {\n  padding: 8px;\n  cursor: pointer;\n}\n\n.series-desc {\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n}\n\n.thumbnail-container {\n  background-color: rgba(0, 0, 0, 0.1);\n  border-radius: 3px;\n}\n\n.fetching {\n  align-self: center;\n  justify-self: center;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent, reactive, ref, toRefs, watch } from 'vue';\nimport type { PropType } from 'vue';\nimport { useDicomMetaStore } from '../../store/dicom-web/dicom-meta-store';\nimport {\n  useDicomWebStore,\n  isDownloadable,\n  VolumeProgress,\n} from '../../store/dicom-web/dicom-web-store';\nimport { formatBytes } from '../../utils';\nimport PersistentOverlay from '../PersistentOverlay.vue';\n\nconst percentDone = (progress: VolumeProgress): number => {\n  if (!progress || progress.total === 0) return 0;\n  const { total, loaded } = progress;\n  return Math.round((100 * loaded) / total);\n};\n\nexport default defineComponent({\n  name: 'StudyVolumeDicomWeb',\n  props: {\n    volumeKeys: {\n      type: Array as PropType<Array<string>>,\n      required: true,\n    },\n  },\n  components: { PersistentOverlay },\n  setup(props) {\n    const { volumeKeys } = toRefs(props);\n\n    const dicomStore = useDicomMetaStore();\n    const dicomWebStore = useDicomWebStore();\n\n    const isFetching = ref(true);\n    dicomWebStore.fetchVolumesMeta(volumeKeys.value).then(() => {\n      isFetching.value = false;\n    });\n\n    const volumes = computed(() => {\n      if (isFetching.value) return [];\n\n      const { volumeInfo, volumeInstances, instanceInfo } = dicomStore;\n      return volumeKeys.value.map((volumeKey) => {\n        const { Rows: rows, Columns: columns } =\n          instanceInfo[volumeInstances[volumeKey][0]];\n        const info = volumeInfo[volumeKey];\n        return {\n          key: volumeKey,\n          info,\n          widthHeightFrames: `${columns} x ${rows} x ${info.NumberOfSlices}`,\n          isDisabled: !isDownloadable(dicomWebStore.volumes[volumeKey]),\n          progress: {\n            ...dicomWebStore.volumes[volumeKey],\n            percent: percentDone(dicomWebStore.volumes[volumeKey]),\n          },\n        };\n      });\n    });\n\n    const thumbnailCache = reactive<Record<string, string>>({});\n\n    watch(\n      [volumeKeys, isFetching],\n      ([keys, guard]) => {\n        if (guard) return;\n\n        keys\n          .filter((key) => !(key in thumbnailCache))\n          .forEach(async (key) => {\n            const thumb = await dicomWebStore.fetchVolumeThumbnail(key);\n            if (thumb !== null) {\n              thumbnailCache[key] = thumb;\n            }\n          });\n      },\n      { immediate: true, deep: true }\n    );\n\n    function downloadDicom(volumeKey: string) {\n      dicomWebStore.downloadVolume(volumeKey);\n    }\n\n    return {\n      thumbnailCache,\n      volumes,\n      downloadDicom,\n      formatBytes,\n      isFetching,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-container class=\"pa-0\">\n    <v-row no-gutters>\n      <v-col>\n        <div class=\"my-2 volume-list\">\n          <v-progress-circular v-if=\"isFetching\" class=\"fetching\" indeterminate>\n          </v-progress-circular>\n\n          <v-card\n            v-for=\"volume in volumes\"\n            :key=\"volume.info.VolumeID\"\n            variant=\"outlined\"\n            class=\"volume-card mt-1\"\n            min-height=\"180px\"\n            min-width=\"180px\"\n            :html-title=\"volume.info.SeriesDescription\"\n            :disabled=\"volume.isDisabled\"\n            :ripple=\"!volume.isDisabled\"\n            @click=\"downloadDicom(volume.info.VolumeID)\"\n          >\n            <v-row no-gutters class=\"pa-0\" justify=\"center\">\n              <div class=\"thumbnail-container\">\n                <v-img\n                  cover\n                  height=\"150\"\n                  width=\"150\"\n                  :src=\"(thumbnailCache || {})[volume.key] || ''\"\n                >\n                  <persistent-overlay>\n                    <v-row no-gutters>\n                      <div class=\"mb-1 ml-1 text-caption\">\n                        {{ volume.widthHeightFrames }}\n                        <v-tooltip location=\"top\" activator=\"parent\">\n                          Width by height by frames\n                        </v-tooltip>\n                      </div>\n                    </v-row>\n                  </persistent-overlay>\n\n                  <persistent-overlay\n                    v-if=\"\n                      volume.progress &&\n                      volume.progress.state &&\n                      volume.progress.state !== 'Remote'\n                    \"\n                  >\n                    <div class=\"d-flex flex-column fill-height ma-0\">\n                      <v-row no-gutters justify=\"center\" align=\"end\">\n                        <v-progress-circular\n                          color=\"white\"\n                          :indeterminate=\"\n                            volume.progress.percent === 0 &&\n                            volume.progress.state !== 'Done'\n                          \"\n                          :model-value=\"volume.progress.percent\"\n                        >\n                          <v-icon\n                            v-if=\"volume.progress.state === 'Done'\"\n                            color=\"white\"\n                          >\n                            mdi-check\n                          </v-icon>\n                          <v-icon\n                            v-else-if=\"volume.progress.state === 'Error'\"\n                            color=\"white\"\n                          >\n                            mdi-alert-circle\n                          </v-icon>\n                          <span\n                            v-else-if=\"volume.progress.percent !== 0\"\n                            class=\"text-caption text--white\"\n                          >\n                            {{ volume.progress.percent }}\n                          </span>\n                        </v-progress-circular>\n                      </v-row>\n                      <v-row no-gutters justify=\"center\" align=\"end\">\n                        <div\n                          v-if=\"volume.progress.loaded !== 0\"\n                          class=\"mb-1 text-caption\"\n                        >\n                          {{ formatBytes(volume.progress.loaded) }}\n                        </div>\n                      </v-row>\n                    </div>\n                  </persistent-overlay>\n                </v-img>\n              </div>\n            </v-row>\n            <v-card-text\n              class=\"text--primary text-caption text-center series-desc mt-n3\"\n            >\n              <div class=\"text-ellipsis\">\n                {{ volume.info.SeriesDescription || '(no series description)' }}\n              </div>\n            </v-card-text>\n          </v-card>\n        </div>\n      </v-col>\n    </v-row>\n  </v-container>\n</template>\n\n<style scoped>\n.volume-list {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n  grid-auto-rows: 200px;\n  justify-content: center;\n}\n\n.volume-card {\n  padding: 8px;\n  cursor: pointer;\n}\n\n.series-desc {\n  white-space: nowrap;\n  text-overflow: ellipsis;\n  overflow: hidden;\n}\n\n.thumbnail-container {\n  background-color: rgba(0, 0, 0, 0.1);\n  border-radius: 3px;\n}\n\n.fetching {\n  align-self: center;\n  justify-self: center;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent, ref, toRefs } from 'vue';\nimport { useDicomMetaStore } from '../../store/dicom-web/dicom-meta-store';\nimport { useDicomWebStore } from '../../store/dicom-web/dicom-web-store';\nimport StudyVolumeDicomWeb from './StudyVolumeDicomWeb.vue';\n\nexport default defineComponent({\n  name: 'PatientDetails',\n  props: {\n    patientKey: {\n      type: String,\n      required: true,\n    },\n  },\n  components: {\n    StudyVolumeDicomWeb,\n  },\n  setup(props) {\n    const { patientKey } = toRefs(props);\n    const dicomStore = useDicomMetaStore();\n    const dicomWebStore = useDicomWebStore();\n\n    const isFetching = ref(true);\n    dicomWebStore.fetchPatientMeta(patientKey.value).then(() => {\n      isFetching.value = false;\n    });\n\n    const studies = computed(() => {\n      const { patientStudies, studyInfo, studyVolumes } = dicomStore;\n      return patientStudies[patientKey.value].map((studyKey) => {\n        const info = studyInfo[studyKey];\n        return {\n          ...info,\n          key: studyKey,\n          title:\n            info.StudyDescription || info.StudyDate || info.StudyInstanceUID,\n          volumeKeys: studyVolumes[studyKey].sort(),\n        };\n      });\n    });\n\n    return {\n      studies,\n      isFetching,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-expansion-panels id=\"patient-data-studies\" accordion multiple>\n    <v-expansion-panel\n      v-for=\"study in studies\"\n      :key=\"study.StudyInstanceUID\"\n      class=\"patient-data-study-panel\"\n    >\n      <v-expansion-panel-title\n        color=\"#1976fa0a\"\n        class=\"pl-3 no-select\"\n        :title=\"study.StudyDate\"\n      >\n        <div class=\"study-header\">\n          <div class=\"study-header-title\">\n            <v-icon class=\"mb-2\">mdi-folder-table</v-icon>\n            <div class=\"ml-2 overflow-hidden text-no-wrap\">\n              <div class=\"text-subtitle-2 text-truncate\" :title=\"study.title\">\n                {{ study.title }}\n              </div>\n              <div\n                v-if=\"study.StudyDescription\"\n                class=\"text-caption text-truncate\"\n              >\n                {{ study.StudyDate }}\n              </div>\n            </div>\n          </div>\n\n          <div class=\"d-flex flex-column align-center justify-end mx-2\">\n            <div class=\"d-flex flex-row align-center mr-2\">\n              <v-progress-circular\n                v-if=\"isFetching\"\n                indeterminate\n                :size=\"20\"\n                :width=\"2\"\n                class=\"mr-2\"\n              >\n              </v-progress-circular>\n              <v-icon size=\"small\">mdi-folder-open</v-icon>\n              <span class=\"text-caption text--secondary text-no-wrap\">\n                : {{ study.volumeKeys.length }}\n              </span>\n              <v-tooltip location=\"bottom\" activator=\"parent\">\n                Total series in study\n              </v-tooltip>\n            </div>\n          </div>\n        </div>\n      </v-expansion-panel-title>\n      <v-expansion-panel-text>\n        <study-volume-dicom-web :volume-keys=\"study.volumeKeys\" />\n      </v-expansion-panel-text>\n    </v-expansion-panel>\n  </v-expansion-panels>\n</template>\n\n<style>\n#patient-data-studies .v-expansion-panel::before {\n  box-shadow: none;\n}\n</style>\n\n<style scoped>\n.study-header {\n  display: flex;\n  flex-flow: row;\n  align-items: center;\n  width: calc(100% - 24px);\n}\n\n.study-header-title {\n  display: flex;\n  flex-flow: row;\n  align-items: center;\n  flex-grow: 1;\n  /* used to ensure that the text can truncate */\n  min-width: 0;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent, ref, toRefs } from 'vue';\nimport { useDicomMetaStore } from '../../store/dicom-web/dicom-meta-store';\nimport { useDicomWebStore } from '../../store/dicom-web/dicom-web-store';\nimport StudyVolumeDicomWeb from './StudyVolumeDicomWeb.vue';\n\nexport default defineComponent({\n  name: 'PatientDetails',\n  props: {\n    patientKey: {\n      type: String,\n      required: true,\n    },\n  },\n  components: {\n    StudyVolumeDicomWeb,\n  },\n  setup(props) {\n    const { patientKey } = toRefs(props);\n    const dicomStore = useDicomMetaStore();\n    const dicomWebStore = useDicomWebStore();\n\n    const isFetching = ref(true);\n    dicomWebStore.fetchPatientMeta(patientKey.value).then(() => {\n      isFetching.value = false;\n    });\n\n    const studies = computed(() => {\n      const { patientStudies, studyInfo, studyVolumes } = dicomStore;\n      return patientStudies[patientKey.value].map((studyKey) => {\n        const info = studyInfo[studyKey];\n        return {\n          ...info,\n          key: studyKey,\n          title:\n            info.StudyDescription || info.StudyDate || info.StudyInstanceUID,\n          volumeKeys: studyVolumes[studyKey].sort(),\n        };\n      });\n    });\n\n    return {\n      studies,\n      isFetching,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-expansion-panels id=\"patient-data-studies\" accordion multiple>\n    <v-expansion-panel\n      v-for=\"study in studies\"\n      :key=\"study.StudyInstanceUID\"\n      class=\"patient-data-study-panel\"\n    >\n      <v-expansion-panel-title\n        color=\"#1976fa0a\"\n        class=\"pl-3 no-select\"\n        :title=\"study.StudyDate\"\n      >\n        <div class=\"study-header\">\n          <div class=\"study-header-title\">\n            <v-icon class=\"mb-2\">mdi-folder-table</v-icon>\n            <div class=\"ml-2 overflow-hidden text-no-wrap\">\n              <div class=\"text-subtitle-2 text-truncate\" :title=\"study.title\">\n                {{ study.title }}\n              </div>\n              <div\n                v-if=\"study.StudyDescription\"\n                class=\"text-caption text-truncate\"\n              >\n                {{ study.StudyDate }}\n              </div>\n            </div>\n          </div>\n\n          <div class=\"d-flex flex-column align-center justify-end mx-2\">\n            <div class=\"d-flex flex-row align-center mr-2\">\n              <v-progress-circular\n                v-if=\"isFetching\"\n                indeterminate\n                :size=\"20\"\n                :width=\"2\"\n                class=\"mr-2\"\n              >\n              </v-progress-circular>\n              <v-icon size=\"small\">mdi-folder-open</v-icon>\n              <span class=\"text-caption text--secondary text-no-wrap\">\n                : {{ study.volumeKeys.length }}\n              </span>\n              <v-tooltip location=\"bottom\" activator=\"parent\">\n                Total series in study\n              </v-tooltip>\n            </div>\n          </div>\n        </div>\n      </v-expansion-panel-title>\n      <v-expansion-panel-text>\n        <study-volume-dicom-web :volume-keys=\"study.volumeKeys\" />\n      </v-expansion-panel-text>\n    </v-expansion-panel>\n  </v-expansion-panels>\n</template>\n\n<style>\n#patient-data-studies .v-expansion-panel::before {\n  box-shadow: none;\n}\n</style>\n\n<style scoped>\n.study-header {\n  display: flex;\n  flex-flow: row;\n  align-items: center;\n  width: calc(100% - 24px);\n}\n\n.study-header-title {\n  display: flex;\n  flex-flow: row;\n  align-items: center;\n  flex-grow: 1;\n  /* used to ensure that the text can truncate */\n  min-width: 0;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent } from 'vue';\n\nimport { useDicomWebStore } from '@/src/store/dicom-web/dicom-web-store';\nimport { useDicomMetaStore } from '@/src/store/dicom-web/dicom-meta-store';\n\nimport PatientDetails from './PatientDetails.vue';\n\nexport default defineComponent({\n  components: {\n    PatientDetails,\n  },\n  setup() {\n    const dicomWeb = useDicomWebStore();\n    const dicomWebMeta = useDicomMetaStore();\n    dicomWeb.fetchInitialDicomsOnce();\n\n    const patients = computed(() =>\n      Object.values(dicomWebMeta.patientInfo)\n        .map((info) => ({\n          key: info.PatientID,\n          name: info.PatientName,\n        }))\n        .sort((a, b) => (a.name < b.name ? -1 : 1))\n    );\n\n    return {\n      patients,\n      dicomWeb,\n    };\n  },\n});\n</script>\n\n<template>\n  <p v-if=\"dicomWeb.message.length > 0\" class=\"error-message\">\n    {{ dicomWeb.message }}\n  </p>\n\n  <v-expansion-panels v-else-if=\"patients.length > 0\" multiple accordion>\n    <v-expansion-panel v-for=\"patient in patients\" :key=\"patient.key\">\n      <v-expansion-panel-title>\n        <div class=\"patient-header\">\n          <v-icon class=\"collection-header-icon\">mdi-account</v-icon>\n          <span class=\"patient-header-name\" :title=\"patient.name\">\n            {{ patient.name }}\n          </span>\n        </div>\n      </v-expansion-panel-title>\n      <v-expansion-panel-text>\n        <patient-details :patient-key=\"patient.key\" />\n      </v-expansion-panel-text>\n    </v-expansion-panel>\n  </v-expansion-panels>\n</template>\n\n<style scoped>\n.v-expansion-panel--active:not(:first-child):after {\n  opacity: 100;\n}\n\n.v-expansion-panel--active + .v-expansion-panel::after {\n  opacity: 100;\n}\n\n.error-message {\n  margin-top: 1em;\n  color: red;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent } from 'vue';\n\nimport { useDicomWebStore } from '@/src/store/dicom-web/dicom-web-store';\nimport { useDicomMetaStore } from '@/src/store/dicom-web/dicom-meta-store';\n\nimport PatientDetails from './PatientDetails.vue';\n\nexport default defineComponent({\n  components: {\n    PatientDetails,\n  },\n  setup() {\n    const dicomWeb = useDicomWebStore();\n    const dicomWebMeta = useDicomMetaStore();\n    dicomWeb.fetchInitialDicomsOnce();\n\n    const patients = computed(() =>\n      Object.values(dicomWebMeta.patientInfo)\n        .map((info) => ({\n          key: info.PatientID,\n          name: info.PatientName,\n        }))\n        .sort((a, b) => (a.name < b.name ? -1 : 1))\n    );\n\n    return {\n      patients,\n      dicomWeb,\n    };\n  },\n});\n</script>\n\n<template>\n  <p v-if=\"dicomWeb.message.length > 0\" class=\"error-message\">\n    {{ dicomWeb.message }}\n  </p>\n\n  <v-expansion-panels v-else-if=\"patients.length > 0\" multiple accordion>\n    <v-expansion-panel v-for=\"patient in patients\" :key=\"patient.key\">\n      <v-expansion-panel-title>\n        <div class=\"patient-header\">\n          <v-icon class=\"collection-header-icon\">mdi-account</v-icon>\n          <span class=\"patient-header-name\" :title=\"patient.name\">\n            {{ patient.name }}\n          </span>\n        </div>\n      </v-expansion-panel-title>\n      <v-expansion-panel-text>\n        <patient-details :patient-key=\"patient.key\" />\n      </v-expansion-panel-text>\n    </v-expansion-panel>\n  </v-expansion-panels>\n</template>\n\n<style scoped>\n.v-expansion-panel--active:not(:first-child):after {\n  opacity: 100;\n}\n\n.v-expansion-panel--active + .v-expansion-panel::after {\n  opacity: 100;\n}\n\n.error-message {\n  margin-top: 1em;\n  color: red;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent, ref, watch } from 'vue';\nimport SampleDataBrowser from './SampleDataBrowser.vue';\nimport { useDicomWebStore } from '../store/dicom-web/dicom-web-store';\nimport ImageDataBrowser from './ImageDataBrowser.vue';\nimport PatientBrowser from './PatientBrowser.vue';\nimport PatientList from './dicom-web/PatientList.vue';\nimport { useDICOMStore } from '../store/datasets-dicom';\nimport { useImageStore } from '../store/datasets-images';\nimport { removeFromArray } from '../utils';\n\nconst SAMPLE_DATA_KEY = 'sampleData';\nconst ANONYMOUS_DATA_KEY = 'anonymousData';\nconst DICOM_WEB_KEY = 'dicomWeb';\n\nexport default defineComponent({\n  name: 'DataBrowser',\n  components: {\n    SampleDataBrowser,\n    ImageDataBrowser,\n    PatientBrowser,\n    PatientList,\n  },\n  setup() {\n    const dicomStore = useDICOMStore();\n    const imageStore = useImageStore();\n    const dicomWeb = useDicomWebStore();\n\n    // TODO show patient ID in parens if there is a name conflict\n    const patients = computed(() =>\n      Object.entries(dicomStore.patientInfo)\n        .map(([key, info]) => ({\n          key,\n          name: info.PatientName,\n          info,\n        }))\n        .sort((a, b) => (a.name < b.name ? -1 : 1))\n    );\n\n    const hasAnonymousImages = computed(\n      () =>\n        imageStore.idList.filter((id) => !(id in dicomStore.imageIDToVolumeKey))\n          .length > 0\n    );\n\n    const panels = ref<string[]>([SAMPLE_DATA_KEY]);\n\n    watch(\n      [hasAnonymousImages, patients] as const,\n      ([showAnonymous, patients_]) => {\n        const showPatients = patients_.length > 0;\n        if (showAnonymous) {\n          panels.value.push(ANONYMOUS_DATA_KEY);\n        }\n        if (showPatients) {\n          panels.value.push(...patients_.map((patient) => patient.key));\n        }\n        if (showAnonymous || showPatients) {\n          removeFromArray(panels.value, SAMPLE_DATA_KEY);\n        }\n      }\n    );\n\n    return {\n      panels,\n      patients,\n      deletePatient: dicomStore.deletePatient,\n      hasAnonymousImages,\n      dicomWeb,\n      SAMPLE_DATA_KEY,\n      ANONYMOUS_DATA_KEY,\n      DICOM_WEB_KEY,\n    };\n  },\n});\n</script>\n\n<template>\n  <div id=\"data-module\" class=\"mx-1 fill-height\">\n    <div id=\"data-panels\">\n      <v-expansion-panels v-model=\"panels\" multiple variant=\"accordion\">\n        <v-expansion-panel\n          v-if=\"hasAnonymousImages\"\n          :value=\"ANONYMOUS_DATA_KEY\"\n        >\n          <v-expansion-panel-title>\n            <v-icon class=\"collection-header-icon\">mdi-image</v-icon>\n            <span>Anonymous</span>\n          </v-expansion-panel-title>\n          <v-expansion-panel-text>\n            <image-data-browser />\n          </v-expansion-panel-text>\n        </v-expansion-panel>\n\n        <v-expansion-panel\n          v-for=\"patient in patients\"\n          :key=\"patient.key\"\n          :value=\"patient.key\"\n        >\n          <v-expansion-panel-title>\n            <div class=\"patient-header\">\n              <v-icon class=\"collection-header-icon\">mdi-account</v-icon>\n              <span class=\"patient-header-name\" :title=\"patient.name\">\n                {{ patient.name }}\n              </span>\n              <v-spacer />\n              <v-menu offset-x>\n                <template v-slot:activator=\"{ props }\">\n                  <v-btn\n                    v-bind=\"props\"\n                    variant=\"text\"\n                    icon=\"mdi-dots-vertical\"\n                    size=\"small\"\n                    class=\"mr-3\"\n                    @click.stop\n                  />\n                </template>\n                <v-list density=\"compact\">\n                  <v-list-item @click.stop=\"deletePatient(patient.key)\">\n                    <v-list-item-title>Delete Patient</v-list-item-title>\n                  </v-list-item>\n                </v-list>\n              </v-menu>\n            </div>\n          </v-expansion-panel-title>\n          <v-expansion-panel-text>\n            <patient-browser :patient-key=\"patient.key\" />\n          </v-expansion-panel-text>\n        </v-expansion-panel>\n\n        <v-expansion-panel v-if=\"dicomWeb.isConfigured\" :value=\"DICOM_WEB_KEY\">\n          <v-expansion-panel-title>\n            <v-icon class=\"collection-header-icon\">mdi-cloud-download</v-icon>\n            <span class=\"text-truncate\">\n              {{ `${dicomWeb.hostName || dicomWeb.host} | DICOMWeb` }}\n            </span>\n          </v-expansion-panel-title>\n          <v-expansion-panel-text>\n            <patient-list />\n          </v-expansion-panel-text>\n        </v-expansion-panel>\n\n        <v-expansion-panel :value=\"SAMPLE_DATA_KEY\">\n          <v-expansion-panel-title>\n            <v-icon class=\"collection-header-icon\">mdi-card-bulleted</v-icon>\n            <span>Sample Data</span>\n          </v-expansion-panel-title>\n          <v-expansion-panel-text>\n            <sample-data-browser />\n          </v-expansion-panel-text>\n        </v-expansion-panel>\n      </v-expansion-panels>\n    </div>\n  </div>\n</template>\n\n<style scoped>\n#data-module {\n  display: flex;\n  flex-flow: column;\n}\n\n#data-panels {\n  flex: 2;\n  overflow-y: auto;\n}\n\n.collection-header-icon {\n  flex: 0;\n  margin-right: 16px;\n}\n\n.patient-header {\n  display: flex;\n  flex-flow: row;\n  align-items: center;\n  width: 100%;\n  /* 24px accomodates the open/close icon indicator */\n  max-width: calc(100% - 24px);\n}\n\n.patient-header-name {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent, ref, watch } from 'vue';\nimport SampleDataBrowser from './SampleDataBrowser.vue';\nimport { useDicomWebStore } from '../store/dicom-web/dicom-web-store';\nimport ImageDataBrowser from './ImageDataBrowser.vue';\nimport PatientBrowser from './PatientBrowser.vue';\nimport PatientList from './dicom-web/PatientList.vue';\nimport { useDICOMStore } from '../store/datasets-dicom';\nimport { useImageStore } from '../store/datasets-images';\nimport { removeFromArray } from '../utils';\n\nconst SAMPLE_DATA_KEY = 'sampleData';\nconst ANONYMOUS_DATA_KEY = 'anonymousData';\nconst DICOM_WEB_KEY = 'dicomWeb';\n\nexport default defineComponent({\n  name: 'DataBrowser',\n  components: {\n    SampleDataBrowser,\n    ImageDataBrowser,\n    PatientBrowser,\n    PatientList,\n  },\n  setup() {\n    const dicomStore = useDICOMStore();\n    const imageStore = useImageStore();\n    const dicomWeb = useDicomWebStore();\n\n    // TODO show patient ID in parens if there is a name conflict\n    const patients = computed(() =>\n      Object.entries(dicomStore.patientInfo)\n        .map(([key, info]) => ({\n          key,\n          name: info.PatientName,\n          info,\n        }))\n        .sort((a, b) => (a.name < b.name ? -1 : 1))\n    );\n\n    const hasAnonymousImages = computed(\n      () =>\n        imageStore.idList.filter((id) => !(id in dicomStore.imageIDToVolumeKey))\n          .length > 0\n    );\n\n    const panels = ref<string[]>([SAMPLE_DATA_KEY]);\n\n    watch(\n      [hasAnonymousImages, patients] as const,\n      ([showAnonymous, patients_]) => {\n        const showPatients = patients_.length > 0;\n        if (showAnonymous) {\n          panels.value.push(ANONYMOUS_DATA_KEY);\n        }\n        if (showPatients) {\n          panels.value.push(...patients_.map((patient) => patient.key));\n        }\n        if (showAnonymous || showPatients) {\n          removeFromArray(panels.value, SAMPLE_DATA_KEY);\n        }\n      }\n    );\n\n    return {\n      panels,\n      patients,\n      deletePatient: dicomStore.deletePatient,\n      hasAnonymousImages,\n      dicomWeb,\n      SAMPLE_DATA_KEY,\n      ANONYMOUS_DATA_KEY,\n      DICOM_WEB_KEY,\n    };\n  },\n});\n</script>\n\n<template>\n  <div id=\"data-module\" class=\"mx-1 fill-height\">\n    <div id=\"data-panels\">\n      <v-expansion-panels v-model=\"panels\" multiple variant=\"accordion\">\n        <v-expansion-panel\n          v-if=\"hasAnonymousImages\"\n          :value=\"ANONYMOUS_DATA_KEY\"\n        >\n          <v-expansion-panel-title>\n            <v-icon class=\"collection-header-icon\">mdi-image</v-icon>\n            <span>Anonymous</span>\n          </v-expansion-panel-title>\n          <v-expansion-panel-text>\n            <image-data-browser />\n          </v-expansion-panel-text>\n        </v-expansion-panel>\n\n        <v-expansion-panel\n          v-for=\"patient in patients\"\n          :key=\"patient.key\"\n          :value=\"patient.key\"\n        >\n          <v-expansion-panel-title>\n            <div class=\"patient-header\">\n              <v-icon class=\"collection-header-icon\">mdi-account</v-icon>\n              <span class=\"patient-header-name\" :title=\"patient.name\">\n                {{ patient.name }}\n              </span>\n              <v-spacer />\n              <v-menu offset-x>\n                <template v-slot:activator=\"{ props }\">\n                  <v-btn\n                    v-bind=\"props\"\n                    variant=\"text\"\n                    icon=\"mdi-dots-vertical\"\n                    size=\"small\"\n                    class=\"mr-3\"\n                    @click.stop\n                  />\n                </template>\n                <v-list density=\"compact\">\n                  <v-list-item @click.stop=\"deletePatient(patient.key)\">\n                    <v-list-item-title>Delete Patient</v-list-item-title>\n                  </v-list-item>\n                </v-list>\n              </v-menu>\n            </div>\n          </v-expansion-panel-title>\n          <v-expansion-panel-text>\n            <patient-browser :patient-key=\"patient.key\" />\n          </v-expansion-panel-text>\n        </v-expansion-panel>\n\n        <v-expansion-panel v-if=\"dicomWeb.isConfigured\" :value=\"DICOM_WEB_KEY\">\n          <v-expansion-panel-title>\n            <v-icon class=\"collection-header-icon\">mdi-cloud-download</v-icon>\n            <span class=\"text-truncate\">\n              {{ `${dicomWeb.hostName || dicomWeb.host} | DICOMWeb` }}\n            </span>\n          </v-expansion-panel-title>\n          <v-expansion-panel-text>\n            <patient-list />\n          </v-expansion-panel-text>\n        </v-expansion-panel>\n\n        <v-expansion-panel :value=\"SAMPLE_DATA_KEY\">\n          <v-expansion-panel-title>\n            <v-icon class=\"collection-header-icon\">mdi-card-bulleted</v-icon>\n            <span>Sample Data</span>\n          </v-expansion-panel-title>\n          <v-expansion-panel-text>\n            <sample-data-browser />\n          </v-expansion-panel-text>\n        </v-expansion-panel>\n      </v-expansion-panels>\n    </div>\n  </div>\n</template>\n\n<style scoped>\n#data-module {\n  display: flex;\n  flex-flow: column;\n}\n\n#data-panels {\n  flex: 2;\n  overflow-y: auto;\n}\n\n.collection-header-icon {\n  flex: 0;\n  margin-right: 16px;\n}\n\n.patient-header {\n  display: flex;\n  flex-flow: row;\n  align-items: center;\n  width: 100%;\n  /* 24px accomodates the open/close icon indicator */\n  max-width: calc(100% - 24px);\n}\n\n.patient-header-name {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent } from 'vue';\nimport { useCurrentImage } from '../composables/useCurrentImage';\nimport { useRulerStore } from '../store/tools/rulers';\n\nexport default defineComponent({\n  setup() {\n    const rulerStore = useRulerStore();\n    const { currentImageID } = useCurrentImage();\n\n    const rulers = computed(() => {\n      const imageID = currentImageID.value;\n      const { lengthByID } = rulerStore;\n      return rulerStore.rulers\n        .filter((ruler) => ruler.imageID === imageID && !ruler.placing)\n        .map((ruler) => ({\n          ...ruler,\n          length: lengthByID[ruler.id],\n        }));\n    });\n\n    function remove(id: string) {\n      rulerStore.removeRuler(id);\n    }\n\n    function jumpTo(id: string) {\n      rulerStore.jumpToRuler(id);\n    }\n\n    return {\n      rulers,\n      remove,\n      jumpTo,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-list-item v-for=\"ruler in rulers\" :key=\"ruler.id\" lines=\"two\">\n    <template #prepend>\n      <v-icon class=\"tool-icon\">mdi-ruler</v-icon>\n      <div class=\"color-dot mr-3\" :style=\"{ backgroundColor: ruler.color }\" />\n    </template>\n    <v-list-item-title v-bind=\"$attrs\">\n      {{ ruler.labelName }}\n    </v-list-item-title>\n    <v-list-item-subtitle>\n      <v-row>\n        <v-col\n          >Length:\n          <span class=\"value\">{{ ruler.length.toFixed(2) }}mm</span>\n        </v-col>\n        <v-col>ID: {{ ruler.id }}</v-col>\n      </v-row>\n    </v-list-item-subtitle>\n    <template #append>\n      <v-row>\n        <v-btn\n          class=\"mr-2\"\n          icon=\"mdi-target\"\n          variant=\"text\"\n          @click=\"jumpTo(ruler.id)\"\n        >\n          <v-icon>mdi-target</v-icon>\n          <v-tooltip location=\"top\" activator=\"parent\">\n            Reveal Slice\n          </v-tooltip>\n        </v-btn>\n        <v-btn icon=\"mdi-delete\" variant=\"text\" @click=\"remove(ruler.id)\">\n          <v-icon>mdi-delete</v-icon>\n          <v-tooltip location=\"top\" activator=\"parent\">Delete</v-tooltip>\n        </v-btn>\n      </v-row>\n    </template>\n  </v-list-item>\n</template>\n\n<style src=\"@/src/components/styles/utils.css\"></style>\n\n<style scoped>\n.empty-state {\n  text-align: center;\n}\n\n.color-dot {\n  width: 24px;\n  height: 24px;\n  background: yellow;\n  border-radius: 16px;\n}\n\n.tool-icon {\n  margin-inline-end: 12px;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent } from 'vue';\nimport { useCurrentImage } from '../composables/useCurrentImage';\nimport { useRulerStore } from '../store/tools/rulers';\n\nexport default defineComponent({\n  setup() {\n    const rulerStore = useRulerStore();\n    const { currentImageID } = useCurrentImage();\n\n    const rulers = computed(() => {\n      const imageID = currentImageID.value;\n      const { lengthByID } = rulerStore;\n      return rulerStore.rulers\n        .filter((ruler) => ruler.imageID === imageID && !ruler.placing)\n        .map((ruler) => ({\n          ...ruler,\n          length: lengthByID[ruler.id],\n        }));\n    });\n\n    function remove(id: string) {\n      rulerStore.removeRuler(id);\n    }\n\n    function jumpTo(id: string) {\n      rulerStore.jumpToRuler(id);\n    }\n\n    return {\n      rulers,\n      remove,\n      jumpTo,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-list-item v-for=\"ruler in rulers\" :key=\"ruler.id\" lines=\"two\">\n    <template #prepend>\n      <v-icon class=\"tool-icon\">mdi-ruler</v-icon>\n      <div class=\"color-dot mr-3\" :style=\"{ backgroundColor: ruler.color }\" />\n    </template>\n    <v-list-item-title v-bind=\"$attrs\">\n      {{ ruler.labelName }}\n    </v-list-item-title>\n    <v-list-item-subtitle>\n      <v-row>\n        <v-col\n          >Length:\n          <span class=\"value\">{{ ruler.length.toFixed(2) }}mm</span>\n        </v-col>\n        <v-col>ID: {{ ruler.id }}</v-col>\n      </v-row>\n    </v-list-item-subtitle>\n    <template #append>\n      <v-row>\n        <v-btn\n          class=\"mr-2\"\n          icon=\"mdi-target\"\n          variant=\"text\"\n          @click=\"jumpTo(ruler.id)\"\n        >\n          <v-icon>mdi-target</v-icon>\n          <v-tooltip location=\"top\" activator=\"parent\">\n            Reveal Slice\n          </v-tooltip>\n        </v-btn>\n        <v-btn icon=\"mdi-delete\" variant=\"text\" @click=\"remove(ruler.id)\">\n          <v-icon>mdi-delete</v-icon>\n          <v-tooltip location=\"top\" activator=\"parent\">Delete</v-tooltip>\n        </v-btn>\n      </v-row>\n    </template>\n  </v-list-item>\n</template>\n\n<style src=\"@/src/components/styles/utils.css\"></style>\n\n<style scoped>\n.empty-state {\n  text-align: center;\n}\n\n.color-dot {\n  width: 24px;\n  height: 24px;\n  background: yellow;\n  border-radius: 16px;\n}\n\n.tool-icon {\n  margin-inline-end: 12px;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent } from 'vue';\nimport { useCurrentImage } from '../composables/useCurrentImage';\nimport { useRectangleStore } from '../store/tools/rectangles';\nimport { RectangleID } from '../types/rectangle';\n\nexport default defineComponent({\n  setup() {\n    const rectStore = useRectangleStore();\n    const { currentImageID } = useCurrentImage();\n\n    const rects = computed(() =>\n      rectStore.tools.filter(\n        (rect) => !rect.placing && rect.imageID === currentImageID.value\n      )\n    );\n\n    function remove(id: RectangleID) {\n      rectStore.removeTool(id);\n    }\n\n    function jumpTo(id: RectangleID) {\n      rectStore.jumpToTool(id);\n    }\n\n    return {\n      rects,\n      remove,\n      jumpTo,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-list-item v-for=\"rect in rects\" :key=\"rect.id\" lines=\"two\">\n    <template #prepend>\n      <v-icon class=\"tool-icon\">mdi-vector-square</v-icon>\n      <div class=\"color-dot mr-3\" :style=\"{ backgroundColor: rect.color }\" />\n    </template>\n    <v-list-item-title v-bind=\"$attrs\">\n      {{ rect.labelName }}\n    </v-list-item-title>\n\n    <v-list-item-subtitle>\n      <v-row>\n        <v-col>ID: {{ rect.id }}</v-col>\n      </v-row>\n    </v-list-item-subtitle>\n    <template #append>\n      <v-row>\n        <v-btn\n          class=\"mr-2\"\n          icon=\"mdi-target\"\n          variant=\"text\"\n          @click=\"jumpTo(rect.id)\"\n        >\n          <v-icon>mdi-target</v-icon>\n          <v-tooltip location=\"top\" activator=\"parent\">\n            Reveal Slice\n          </v-tooltip>\n        </v-btn>\n        <v-btn icon=\"mdi-delete\" variant=\"text\" @click=\"remove(rect.id)\">\n          <v-icon>mdi-delete</v-icon>\n          <v-tooltip location=\"top\" activator=\"parent\">Delete</v-tooltip>\n        </v-btn>\n      </v-row>\n    </template>\n  </v-list-item>\n</template>\n\n<style src=\"@/src/components/styles/utils.css\"></style>\n\n<style scoped>\n.empty-state {\n  text-align: center;\n}\n\n.color-dot {\n  width: 24px;\n  height: 24px;\n  background: yellow;\n  border-radius: 16px;\n}\n\n.tool-icon {\n  margin-inline-end: 12px;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent } from 'vue';\nimport { useCurrentImage } from '../composables/useCurrentImage';\nimport { useRectangleStore } from '../store/tools/rectangles';\nimport { RectangleID } from '../types/rectangle';\n\nexport default defineComponent({\n  setup() {\n    const rectStore = useRectangleStore();\n    const { currentImageID } = useCurrentImage();\n\n    const rects = computed(() =>\n      rectStore.tools.filter(\n        (rect) => !rect.placing && rect.imageID === currentImageID.value\n      )\n    );\n\n    function remove(id: RectangleID) {\n      rectStore.removeTool(id);\n    }\n\n    function jumpTo(id: RectangleID) {\n      rectStore.jumpToTool(id);\n    }\n\n    return {\n      rects,\n      remove,\n      jumpTo,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-list-item v-for=\"rect in rects\" :key=\"rect.id\" lines=\"two\">\n    <template #prepend>\n      <v-icon class=\"tool-icon\">mdi-vector-square</v-icon>\n      <div class=\"color-dot mr-3\" :style=\"{ backgroundColor: rect.color }\" />\n    </template>\n    <v-list-item-title v-bind=\"$attrs\">\n      {{ rect.labelName }}\n    </v-list-item-title>\n\n    <v-list-item-subtitle>\n      <v-row>\n        <v-col>ID: {{ rect.id }}</v-col>\n      </v-row>\n    </v-list-item-subtitle>\n    <template #append>\n      <v-row>\n        <v-btn\n          class=\"mr-2\"\n          icon=\"mdi-target\"\n          variant=\"text\"\n          @click=\"jumpTo(rect.id)\"\n        >\n          <v-icon>mdi-target</v-icon>\n          <v-tooltip location=\"top\" activator=\"parent\">\n            Reveal Slice\n          </v-tooltip>\n        </v-btn>\n        <v-btn icon=\"mdi-delete\" variant=\"text\" @click=\"remove(rect.id)\">\n          <v-icon>mdi-delete</v-icon>\n          <v-tooltip location=\"top\" activator=\"parent\">Delete</v-tooltip>\n        </v-btn>\n      </v-row>\n    </template>\n  </v-list-item>\n</template>\n\n<style src=\"@/src/components/styles/utils.css\"></style>\n\n<style scoped>\n.empty-state {\n  text-align: center;\n}\n\n.color-dot {\n  width: 24px;\n  height: 24px;\n  background: yellow;\n  border-radius: 16px;\n}\n\n.tool-icon {\n  margin-inline-end: 12px;\n}\n</style>\n","<template>\n  <v-list density=\"compact\" v-if=\"labelmaps.length\">\n    <v-list-item v-for=\"lm in labelmaps\" :key=\"lm.id\" lines=\"two\">\n      <v-list-item-title>Labelmap (ID = {{ lm.id }})</v-list-item-title>\n    </v-list-item>\n  </v-list>\n</template>\n\n<style scoped>\n.empty-state {\n  text-align: center;\n}\n</style>\n\n<script lang=\"ts\">\nimport { computed, defineComponent } from 'vue';\nimport { useLabelmapStore } from '../store/datasets-labelmaps';\n\nexport default defineComponent({\n  name: 'LabelmapList',\n  setup() {\n    const labelmapStore = useLabelmapStore();\n\n    const labelmaps = computed(() =>\n      labelmapStore.idList.map((id) => ({ id }))\n    );\n\n    return {\n      labelmaps,\n    };\n  },\n});\n</script>\n","<template>\n  <v-list density=\"compact\" v-if=\"labelmaps.length\">\n    <v-list-item v-for=\"lm in labelmaps\" :key=\"lm.id\" lines=\"two\">\n      <v-list-item-title>Labelmap (ID = {{ lm.id }})</v-list-item-title>\n    </v-list-item>\n  </v-list>\n</template>\n\n<style scoped>\n.empty-state {\n  text-align: center;\n}\n</style>\n\n<script lang=\"ts\">\nimport { computed, defineComponent } from 'vue';\nimport { useLabelmapStore } from '../store/datasets-labelmaps';\n\nexport default defineComponent({\n  name: 'LabelmapList',\n  setup() {\n    const labelmapStore = useLabelmapStore();\n\n    const labelmaps = computed(() =>\n      labelmapStore.idList.map((id) => ({ id }))\n    );\n\n    return {\n      labelmaps,\n    };\n  },\n});\n</script>\n","<script setup lang=\"ts\">\nimport { computed, ref, watch } from 'vue';\nimport { LabelsStore } from '@/src/store/tools/useLabels';\nimport { AnnotationTool } from '../types/annotationTool';\nimport { standardizeColor } from '../utils';\n\nconst props = defineProps<{\n  label: string;\n  labelsStore: LabelsStore<AnnotationTool>;\n}>();\n\nconst label = computed(() => props.labelsStore.labels[props.label]);\n\nconst labelName = ref(label.value.labelName);\nwatch(labelName, (name) => {\n  props.labelsStore.updateLabel(props.label, { labelName: name });\n});\n\nconst colorLocal = ref(standardizeColor(label.value.color));\nwatch(colorLocal, (color) => {\n  props.labelsStore.updateLabel(props.label, { color });\n});\n\nconst emit = defineEmits(['close']);\nconst deleteLabel = () => {\n  emit('close');\n  props.labelsStore.deleteLabel(props.label);\n};\n</script>\n\n<template>\n  <v-card>\n    <v-card-title class=\"d-flex flex-row align-center\">\n      Edit Label\n      <v-spacer />\n      <v-btn\n        variant=\"text\"\n        density=\"compact\"\n        icon=\"mdi-close\"\n        @click=\"$emit('close')\"\n      />\n    </v-card-title>\n\n    <v-card-item>\n      <div class=\"d-flex flex-row\">\n        <div class=\"flex-grow-1 d-flex flex-column justify-space-between mr-4\">\n          <div>\n            <v-text-field\n              v-model=\"labelName\"\n              @keydown.stop.enter=\"$emit('close')\"\n              label=\"Name\"\n              class=\"flex-grow-0\"\n            />\n          </div>\n          <v-card-actions class=\"mb-2 px-0\">\n            <v-btn color=\"secondary\" variant=\"elevated\" @click=\"$emit('close')\">\n              Done\n            </v-btn>\n            <v-spacer />\n            <v-btn color=\"red\" variant=\"tonal\" @click=\"deleteLabel\">\n              Delete label\n            </v-btn>\n          </v-card-actions>\n        </div>\n        <v-color-picker v-model=\"colorLocal\" mode=\"rgb\" label=\"Color\" />\n      </div>\n    </v-card-item>\n  </v-card>\n</template>\n","<script setup lang=\"ts\">\nimport { computed, ref, watchEffect } from 'vue';\nimport { useDisplay } from 'vuetify';\nimport { LabelsStore } from '@/src/store/tools/useLabels';\nimport { AnnotationTool } from '@/src/types/annotationTool';\nimport { Maybe } from '@/src/types';\nimport LabelEditor from './LabelEditor.vue';\n\nconst props = defineProps<{\n  labelsStore: LabelsStore<AnnotationTool>;\n}>();\n\nconst labels = computed(() => Object.entries(props.labelsStore.labels));\n// item groups need an index, not a value\nconst activeLabelIndex = computed(() => {\n  return labels.value.findIndex(\n    ([name]) => name === props.labelsStore.activeLabel\n  );\n});\n\nconst editingLabel =\n  ref<Maybe<keyof typeof props.labelsStore.labels>>(undefined);\n\nconst createLabel = () => {\n  editingLabel.value = props.labelsStore.addLabel();\n};\n\nconst editDialog = ref(false);\nwatchEffect(() => {\n  editDialog.value = !!editingLabel.value;\n});\n\nconst display = useDisplay();\nconst mobile = computed(() => display.mobile.value);\n</script>\n\n<template>\n  <v-card class=\"pt-2\">\n    <v-card-subtitle>Labels</v-card-subtitle>\n    <v-container>\n      <v-item-group\n        :model-value=\"activeLabelIndex\"\n        selected-class=\"card-active\"\n        mandatory\n      >\n        <v-row dense>\n          <v-col\n            cols=\"6\"\n            v-for=\"[id, { labelName, color }] in labels\"\n            :key=\"id\"\n          >\n            <v-item v-slot=\"{ selectedClass, toggle }\">\n              <v-chip\n                variant=\"tonal\"\n                :class=\"['w-100 d-flex', selectedClass]\"\n                @click=\"\n                  () => {\n                    toggle();\n                    labelsStore.setActiveLabel(id);\n                  }\n                \"\n              >\n                <!-- dot container keeps overflowing name from squishing dot width  -->\n                <div class=\"dot-container mr-3\">\n                  <div class=\"color-dot\" :style=\"{ background: color }\" />\n                </div>\n                <span class=\"overflow-hidden\">{{ labelName }}</span>\n                <v-btn\n                  icon=\"mdi-pencil\"\n                  density=\"compact\"\n                  class=\"ml-auto\"\n                  variant=\"plain\"\n                  @click.stop=\"\n                    () => {\n                      editingLabel = id;\n                      editDialog = true;\n                    }\n                  \"\n                />\n              </v-chip>\n            </v-item>\n          </v-col>\n\n          <!-- Add Label button -->\n          <v-col cols=\"6\">\n            <v-chip variant=\"outlined\" class=\"w-100\" @click=\"createLabel\">\n              <v-icon class=\"mr-2\">mdi-plus</v-icon>\n              Add Label\n            </v-chip>\n          </v-col>\n        </v-row>\n      </v-item-group>\n    </v-container>\n  </v-card>\n\n  <v-dialog v-model=\"editDialog\" :width=\"mobile ? '100%' : '50%'\">\n    <LabelEditor\n      @close=\"editingLabel = undefined\"\n      v-if=\"editingLabel\"\n      :label=\"editingLabel\"\n      :labelsStore=\"labelsStore\"\n    />\n  </v-dialog>\n</template>\n\n<style scoped>\n.card-active {\n  background-color: rgb(var(--v-theme-selection-bg-color));\n  border-color: rgb(var(--v-theme-selection-border-color));\n}\n\n.color-dot {\n  width: 18px;\n  height: 18px;\n  border-radius: 16px;\n}\n.dot-container {\n  width: 18px;\n}\n</style>\n","<script setup lang=\"ts\">\nimport { useRectangleStore } from '@src/store/tools/rectangles';\nimport LabelControls from '@src/components/LabelControls.vue';\n\nconst activeToolStore = useRectangleStore();\n</script>\n\n<template>\n  <LabelControls :labels-store=\"activeToolStore\" />\n</template>\n","<script setup lang=\"ts\">\nimport { useRulerStore } from '@src/store/tools/rulers';\nimport LabelControls from '@src/components/LabelControls.vue';\n\nconst activeToolStore = useRulerStore();\n</script>\n\n<template>\n  <LabelControls :labels-store=\"activeToolStore\" />\n</template>\n","<script setup lang=\"ts\">\nimport ToolButton from '@/src/components/ToolButton.vue';\nimport useContourStore, { ContourToolMode } from '@/src/store/tools/contours';\nimport { storeToRefs } from 'pinia';\nimport LabelControls from '@/src/components/LabelControls.vue';\n\nconst contourStore = useContourStore();\nconst { mode } = storeToRefs(contourStore);\n\nfunction setMode(m: ContourToolMode) {\n  contourStore.setMode(m);\n}\n</script>\n\n<template>\n  <v-card dark>\n    <v-card-subtitle class=\"my-1\">Tools</v-card-subtitle>\n    <v-item-group\n      mandatory\n      selected-class=\"tool-btn-selected\"\n      :model-value=\"mode\"\n      @update:model-value=\"setMode\"\n    >\n      <v-item\n        v-slot=\"{ selectedClass, toggle }\"\n        :value=\"ContourToolMode.Select\"\n      >\n        <tool-button\n          size=\"40\"\n          icon=\"mdi-cursor-default\"\n          name=\"Select\"\n          :buttonClass=\"selectedClass || ''\"\n          @click=\"toggle\"\n        />\n      </v-item>\n      <v-item\n        v-slot=\"{ selectedClass, toggle }\"\n        :value=\"ContourToolMode.FreehandDraw\"\n      >\n        <tool-button\n          size=\"40\"\n          icon=\"mdi-draw\"\n          name=\"Freehand\"\n          :buttonClass=\"selectedClass || ''\"\n          @click=\"toggle\"\n        />\n      </v-item>\n      <v-item\n        v-slot=\"{ selectedClass, toggle }\"\n        :value=\"ContourToolMode.PointPlacing\"\n      >\n        <tool-button\n          size=\"40\"\n          icon=\"mdi-vector-polyline\"\n          name=\"Point Placing\"\n          :buttonClass=\"selectedClass || ''\"\n          @click=\"toggle\"\n        />\n      </v-item>\n      <v-item\n        v-slot=\"{ selectedClass, toggle }\"\n        :value=\"ContourToolMode.Threshold\"\n      >\n        <tool-button\n          size=\"40\"\n          icon=\"mdi-math-integral\"\n          name=\"Threshold\"\n          :buttonClass=\"selectedClass || ''\"\n          @click=\"toggle\"\n        />\n      </v-item>\n      <v-item\n        v-slot=\"{ selectedClass, toggle }\"\n        :value=\"ContourToolMode.CircleNudge\"\n      >\n        <tool-button\n          size=\"40\"\n          icon=\"mdi-circle-multiple-outline\"\n          name=\"Nudge\"\n          :buttonClass=\"selectedClass || ''\"\n          @click=\"toggle\"\n        />\n      </v-item>\n    </v-item-group>\n    <label-controls :labels-store=\"contourStore\" />\n  </v-card>\n</template>\n\n<style>\n.tool-btn-selected {\n  background-color: rgba(128, 128, 255, 0.7);\n}\n</style>\n","<script setup lang=\"ts\">\nimport { computed } from 'vue';\nimport { useToolStore } from '../store/tools';\nimport { Tools } from '../store/tools/types';\nimport RectangleControls from './RectangleControls.vue';\nimport RulerControls from './RulerControls.vue';\nimport ContourControls from './tools/contour/ContourControls.vue';\n\nconst toolStore = useToolStore();\n\nconst tools = new Map([\n  [Tools.Rectangle, { component: RectangleControls, label: 'Rectangle' }],\n  [Tools.Ruler, { component: RulerControls, label: 'Ruler' }],\n  [Tools.Contour, { component: ContourControls, label: 'Contour' }],\n]);\n\nconst tool = computed(() => tools.get(toolStore.currentTool));\n</script>\n\n<template>\n  <div v-if=\"tool\">\n    <div class=\"header\">{{ tool.label }}</div>\n    <div class=\"content\">\n      <component :is=\"tool.component\" />\n    </div>\n  </div>\n</template>\n\n<style scoped src=\"./styles/annotations.css\"></style>\n","<script lang=\"ts\">\nimport { defineComponent } from 'vue';\nimport MeasurementsRulerList from './MeasurementsRulerList.vue';\nimport MeasurementsRectangleList from './MeasurementsRectangleList.vue';\nimport LabelmapList from './LabelmapList.vue';\nimport ToolControls from './ToolControls.vue';\n\nexport default defineComponent({\n  components: {\n    MeasurementsRulerList,\n    MeasurementsRectangleList,\n    LabelmapList,\n    ToolControls,\n  },\n  setup() {},\n});\n</script>\n\n<template>\n  <div class=\"overflow-y-auto mx-2 fill-height\">\n    <tool-controls />\n    <div class=\"header\">Measurements</div>\n    <div class=\"content\">\n      <measurements-ruler-list />\n      <measurements-rectangle-list />\n    </div>\n    <div class=\"text-caption text-center empty-state\">No measurements</div>\n    <div class=\"header\">Labelmaps</div>\n    <div class=\"content\">\n      <labelmap-list />\n    </div>\n    <div class=\"text-caption text-center empty-state\">No labelmaps</div>\n  </div>\n</template>\n\n<style scoped>\n.annot-subheader {\n  margin: 8px 0;\n}\n\n.empty-state {\n  display: none;\n}\n\n.content:empty + .empty-state {\n  display: block;\n}\n</style>\n\n<style scoped src=\"./styles/annotations.css\"></style>\n","<script lang=\"ts\">\nimport { defineComponent } from 'vue';\nimport MeasurementsRulerList from './MeasurementsRulerList.vue';\nimport MeasurementsRectangleList from './MeasurementsRectangleList.vue';\nimport LabelmapList from './LabelmapList.vue';\nimport ToolControls from './ToolControls.vue';\n\nexport default defineComponent({\n  components: {\n    MeasurementsRulerList,\n    MeasurementsRectangleList,\n    LabelmapList,\n    ToolControls,\n  },\n  setup() {},\n});\n</script>\n\n<template>\n  <div class=\"overflow-y-auto mx-2 fill-height\">\n    <tool-controls />\n    <div class=\"header\">Measurements</div>\n    <div class=\"content\">\n      <measurements-ruler-list />\n      <measurements-rectangle-list />\n    </div>\n    <div class=\"text-caption text-center empty-state\">No measurements</div>\n    <div class=\"header\">Labelmaps</div>\n    <div class=\"content\">\n      <labelmap-list />\n    </div>\n    <div class=\"text-caption text-center empty-state\">No labelmaps</div>\n  </div>\n</template>\n\n<style scoped>\n.annot-subheader {\n  margin: 8px 0;\n}\n\n.empty-state {\n  display: none;\n}\n\n.content:empty + .empty-state {\n  display: block;\n}\n</style>\n\n<style scoped src=\"./styles/annotations.css\"></style>\n","<template>\n  <div class=\"fill-height d-flex flex-column\">\n    <div id=\"module-switcher\">\n      <v-tabs\n        id=\"module-switcher-tabs\"\n        v-model=\"selectedModuleIndex\"\n        icons-and-text\n        show-arrows\n      >\n        <v-tab v-for=\"item in Modules\" :key=\"item.name\">\n          <div class=\"tab-content\">\n            <span class=\"mb-0 mt-1 module-text\">{{ item.name }}</span>\n            <v-icon>mdi-{{ item.icon }}</v-icon>\n          </div>\n        </v-tab>\n      </v-tabs>\n    </div>\n    <div id=\"module-container\">\n      <v-window v-model=\"selectedModuleIndex\" touchless class=\"fill-height\">\n        <v-window-item\n          v-for=\"mod in Modules\"\n          :key=\"mod.name\"\n          class=\"fill-height\"\n        >\n          <component\n            :key=\"mod.name\"\n            v-show=\"Modules[selectedModuleIndex] === mod\"\n            :is=\"mod.component\"\n          />\n        </v-window-item>\n      </v-window>\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent, ref, watch } from 'vue';\n\nimport DataBrowser from './DataBrowser.vue';\nimport RenderingModule from './RenderingModule.vue';\nimport AnnotationsModule from './AnnotationsModule.vue';\nimport { useToolStore } from '../store/tools';\nimport { Tools } from '../store/tools/types';\n\nexport const Modules = [\n  {\n    name: 'Data',\n    icon: 'database',\n    component: DataBrowser,\n  },\n  {\n    name: 'Annotations',\n    icon: 'pencil',\n    component: AnnotationsModule,\n  },\n  // {\n  //   name: 'Rendering',\n  //   icon: 'cube',\n  //   component: RenderingModule,\n  // },\n  // {\n  //   name: 'AI',\n  //   icon: 'robot-outline',\n  //   component: null,\n  // },\n];\n\nconst autoSwitchToAnnotationsTools = [\n  Tools.Rectangle,\n  Tools.Ruler,\n  Tools.Contour,\n];\n\nexport default defineComponent({\n  name: 'ModulePanel',\n  setup() {\n    const selectedModuleIndex = ref(0);\n\n    const toolStore = useToolStore();\n    watch(\n      () => toolStore.currentTool,\n      (newTool) => {\n        if (autoSwitchToAnnotationsTools.includes(newTool))\n          selectedModuleIndex.value = 1;\n      }\n    );\n\n    return {\n      selectedModuleIndex,\n      Modules,\n    };\n  },\n});\n</script>\n\n<style scoped>\n#module-switcher {\n  display: relative;\n  flex: 0 2;\n  /* roughly match vuetify's dark/light transition */\n  transition: border-bottom 0.3s;\n  border-bottom: 2px solid rgb(var(--v-theme-on-surface-variant));\n}\n\n#close-btn {\n  position: absolute;\n  top: 1.5em;\n  left: 0.5em;\n  z-index: 10;\n}\n\n#module-container {\n  position: relative;\n  flex: 2;\n  overflow: auto;\n}\n\n.module-text {\n  font-size: 0.6rem;\n  white-space: pre;\n}\n\n.tab-content {\n  display: flex;\n  justify-content: flex-end;\n  flex-direction: column-reverse;\n  height: 100%;\n  align-items: center;\n}\n\n#module-switcher-tabs :deep(.v-slide-group__content) {\n  justify-content: center;\n}\n\n#module-switcher-tabs\n  :deep(.v-slide-group__prev.v-slide-group__prev--disabled) {\n  visibility: hidden;\n}\n\n#module-switcher-tabs\n  :deep(.v-slide-group__next.v-slide-group__next--disabled) {\n  visibility: hidden;\n}\n</style>\n","<template>\n  <div class=\"fill-height d-flex flex-column\">\n    <div id=\"module-switcher\">\n      <v-tabs\n        id=\"module-switcher-tabs\"\n        v-model=\"selectedModuleIndex\"\n        icons-and-text\n        show-arrows\n      >\n        <v-tab v-for=\"item in Modules\" :key=\"item.name\">\n          <div class=\"tab-content\">\n            <span class=\"mb-0 mt-1 module-text\">{{ item.name }}</span>\n            <v-icon>mdi-{{ item.icon }}</v-icon>\n          </div>\n        </v-tab>\n      </v-tabs>\n    </div>\n    <div id=\"module-container\">\n      <v-window v-model=\"selectedModuleIndex\" touchless class=\"fill-height\">\n        <v-window-item\n          v-for=\"mod in Modules\"\n          :key=\"mod.name\"\n          class=\"fill-height\"\n        >\n          <component\n            :key=\"mod.name\"\n            v-show=\"Modules[selectedModuleIndex] === mod\"\n            :is=\"mod.component\"\n          />\n        </v-window-item>\n      </v-window>\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent, ref, watch } from 'vue';\n\nimport DataBrowser from './DataBrowser.vue';\nimport RenderingModule from './RenderingModule.vue';\nimport AnnotationsModule from './AnnotationsModule.vue';\nimport { useToolStore } from '../store/tools';\nimport { Tools } from '../store/tools/types';\n\nexport const Modules = [\n  {\n    name: 'Data',\n    icon: 'database',\n    component: DataBrowser,\n  },\n  {\n    name: 'Annotations',\n    icon: 'pencil',\n    component: AnnotationsModule,\n  },\n  // {\n  //   name: 'Rendering',\n  //   icon: 'cube',\n  //   component: RenderingModule,\n  // },\n  // {\n  //   name: 'AI',\n  //   icon: 'robot-outline',\n  //   component: null,\n  // },\n];\n\nconst autoSwitchToAnnotationsTools = [\n  Tools.Rectangle,\n  Tools.Ruler,\n  Tools.Contour,\n];\n\nexport default defineComponent({\n  name: 'ModulePanel',\n  setup() {\n    const selectedModuleIndex = ref(0);\n\n    const toolStore = useToolStore();\n    watch(\n      () => toolStore.currentTool,\n      (newTool) => {\n        if (autoSwitchToAnnotationsTools.includes(newTool))\n          selectedModuleIndex.value = 1;\n      }\n    );\n\n    return {\n      selectedModuleIndex,\n      Modules,\n    };\n  },\n});\n</script>\n\n<style scoped>\n#module-switcher {\n  display: relative;\n  flex: 0 2;\n  /* roughly match vuetify's dark/light transition */\n  transition: border-bottom 0.3s;\n  border-bottom: 2px solid rgb(var(--v-theme-on-surface-variant));\n}\n\n#close-btn {\n  position: absolute;\n  top: 1.5em;\n  left: 0.5em;\n  z-index: 10;\n}\n\n#module-container {\n  position: relative;\n  flex: 2;\n  overflow: auto;\n}\n\n.module-text {\n  font-size: 0.6rem;\n  white-space: pre;\n}\n\n.tab-content {\n  display: flex;\n  justify-content: flex-end;\n  flex-direction: column-reverse;\n  height: 100%;\n  align-items: center;\n}\n\n#module-switcher-tabs :deep(.v-slide-group__content) {\n  justify-content: center;\n}\n\n#module-switcher-tabs\n  :deep(.v-slide-group__prev.v-slide-group__prev--disabled) {\n  visibility: hidden;\n}\n\n#module-switcher-tabs\n  :deep(.v-slide-group__next.v-slide-group__next--disabled) {\n  visibility: hidden;\n}\n</style>\n","<template>\n  <div\n    v-on:dragover.prevent=\"onDragOver\"\n    v-on:dragleave=\"onDragLeave\"\n    v-on:drop.prevent=\"onDrop\"\n    v-bind=\"$attrs\"\n  >\n    <slot :dragHover=\"dragHover\" />\n  </div>\n</template>\n\n<script>\nasync function readAllDirEntries(dirEntry) {\n  const reader = dirEntry.createReader();\n  const allEntries = [];\n  let entries = [];\n  do {\n    // eslint-disable-next-line no-await-in-loop\n    entries = await new Promise((resolve, reject) => {\n      reader.readEntries(resolve, reject);\n    });\n    allEntries.push(...entries);\n  } while (entries.length);\n  return allEntries;\n}\n\nasync function entryToFile(fileEntry) {\n  return new Promise((resolve, reject) => {\n    fileEntry.file(resolve, reject);\n  });\n}\n\nasync function readAllFiles(entries) {\n  const toProcess = [...entries];\n  const fileEntries = [];\n  while (toProcess.length) {\n    const entry = toProcess.shift();\n    if (entry.isFile) {\n      fileEntries.push(entry);\n    } else {\n      // eslint-disable-next-line no-await-in-loop\n      toProcess.push(...(await readAllDirEntries(entry)));\n    }\n  }\n  return Promise.all(fileEntries.map(entryToFile));\n}\n\nexport default {\n  name: 'DragAndDrop',\n  props: {\n    enabled: Boolean,\n  },\n  data() {\n    return {\n      dragHover: false,\n    };\n  },\n  methods: {\n    onDragOver(ev) {\n      if (this.enabled) {\n        ev.preventDefault();\n\n        const { types } = ev.dataTransfer;\n        if (\n          types && types instanceof Array\n            ? types.indexOf('Files') !== -1\n            : 'Files' in types\n        ) {\n          this.dragHover = true;\n          if (this.dragTimeout !== null) {\n            window.clearTimeout(this.dragTimeout);\n            this.dragTimeout = null;\n          }\n        }\n      }\n    },\n    onDragLeave() {\n      if (this.enabled) {\n        this.dragTimeout = window.setTimeout(() => {\n          this.dragHover = false;\n          this.dragTimeout = null;\n        }, 50);\n      }\n    },\n    async onDrop(ev) {\n      if (this.enabled) {\n        this.dragHover = false;\n        if (ev.dataTransfer.items) {\n          const entries = [...ev.dataTransfer.items].map((item) => {\n            const getAsEntry = item.webkitGetAsEntry || item.getAsEntry;\n            return getAsEntry.call(item);\n          });\n          const files = await readAllFiles(entries);\n          this.$emit('drop-files', files);\n        } else {\n          this.$emit('drop-files', Array.from(ev.dataTransfer.files));\n        }\n      }\n    },\n  },\n  created() {\n    // used to debounce dragover\n    this.dragTimeout = null;\n  },\n};\n</script>\n","<template svg>\n  <svg\n    width=\"362\"\n    height=\"46\"\n    viewBox=\"0 0 362 46\"\n    fill=\"none\"\n    xmlns=\"http://www.w3.org/2000/svg\"\n  >\n    <g clip-path=\"url(#clip0_137_135)\">\n      <path\n        d=\"M217.55 26.6132C217.498 26.6912 217.447 26.7951 217.37 26.8731C216.06 28.64 213.364 29.3676 210 28.8999C209.846 28.8739 209.692 28.8479 209.537 28.8219C207.509 28.4841 205.3 27.7306 203.092 26.6132C201.782 25.9377 200.472 25.1062 199.214 24.1447C197.853 23.1054 196.621 21.988 195.568 20.7928C193.898 18.9479 192.666 16.9991 191.87 15.1282C190.56 12.0361 190.56 9.28175 191.844 7.48883C193.154 5.7219 195.722 5.04631 198.932 5.54001C200.524 5.77387 202.27 6.31954 204.068 7.12505C205.84 7.93057 207.663 8.99592 209.435 10.3471C212.979 13.0235 215.649 16.2715 217.087 19.3377C218.474 22.2479 218.654 24.8463 217.55 26.6132Z\"\n        fill=\"#3EAE2B\"\n      />\n      <path\n        d=\"M217.55 26.6132C217.498 26.6912 217.447 26.7951 217.37 26.8731C216.06 28.64 213.364 29.3676 210 28.8998C209.846 28.8739 209.692 28.8479 209.537 28.8219C207.663 28.4321 205.506 27.7306 203.092 26.6132C201.782 25.9376 200.473 25.1061 199.214 24.1447C197.853 23.1054 196.621 21.988 195.568 20.7928C193 16.5054 193.539 11.1786 195.08 9.48961C196.954 7.41087 201.243 6.94315 207.945 11.4904C213.852 15.492 218.089 23.2613 217.55 26.6132Z\"\n        fill=\"black\"\n        fill-opacity=\"0.15\"\n      />\n      <path\n        d=\"M214.442 22.2479C214.442 22.7416 214.34 23.1833 214.16 23.5731C214.108 23.703 214.031 23.8329 213.929 23.9628C213.518 24.5345 212.85 24.8983 211.951 25.0801C211.053 25.262 209.974 25.2101 208.767 24.9762C206.353 24.5085 203.58 23.2353 201.14 21.4164C201.115 21.3904 201.063 21.3644 201.037 21.3384C198.675 19.5195 196.877 17.3109 195.876 15.2581C194.849 13.1534 194.772 11.3085 195.619 10.1652C196.441 9.02188 198.213 8.68409 200.498 9.1518C202.784 9.61952 205.429 10.8927 207.843 12.7376C210.257 14.5825 212.26 16.8172 213.415 18.9219C214.108 20.1431 214.442 21.2864 214.442 22.2479Z\"\n        fill=\"#3EAE2B\"\n      />\n      <path\n        d=\"M214.16 23.5731C214.108 23.7031 214.031 23.833 213.929 23.9629C213.518 24.5346 212.85 24.8983 211.951 25.0802C211.053 25.2621 209.974 25.2102 208.767 24.9763C206.353 24.5086 203.58 23.2353 201.14 21.4165C201.114 21.3905 201.063 21.3645 201.037 21.3385C198.187 18.4542 198.059 13.855 199.214 12.5558C200.524 11.3865 202.835 11.4125 207.072 14.2708C210.616 16.6873 213.877 21.1826 214.16 23.5731Z\"\n        fill=\"black\"\n        fill-opacity=\"0.15\"\n      />\n      <path\n        d=\"M210.616 21.4944C210.436 21.7282 210.128 21.8841 209.666 21.9621C209.204 22.0141 208.613 21.9881 207.92 21.8062C206.559 21.4684 204.915 20.6889 203.374 19.5196C201.834 18.3503 200.652 17.0251 199.985 15.8038C199.651 15.2062 199.471 14.6605 199.394 14.1928C199.343 13.7251 199.42 13.4133 199.599 13.1794C199.779 12.9456 200.062 12.7637 200.524 12.7117C200.96 12.6597 201.525 12.6857 202.193 12.8416C202.835 12.9975 203.58 13.2834 204.324 13.6731C205.069 14.0629 205.865 14.5566 206.61 15.1542C208.151 16.3235 209.383 17.6487 210.102 18.844C210.462 19.4416 210.667 19.9873 210.744 20.455C210.847 20.9487 210.77 21.2865 210.616 21.4944Z\"\n        fill=\"#3EAE2B\"\n      />\n      <path\n        d=\"M211.309 21.8061C211.078 22.4038 210.847 22.8455 210.462 23.3912C208.151 26.5093 203.323 26.951 199.933 24.3786C196.543 21.8061 195.67 16.999 197.956 13.8809C198.418 13.3093 198.752 12.9195 199.291 12.4778C199.188 12.5557 199.111 12.6337 199.034 12.7376C198.701 13.1794 198.624 13.725 198.701 14.2967C198.778 14.8683 199.009 15.5179 199.368 16.1675C200.087 17.4668 201.346 18.8959 202.963 20.1172C204.581 21.3384 206.302 22.1699 207.791 22.5077C208.536 22.6896 209.229 22.7416 209.794 22.6636C210.385 22.5857 210.898 22.3518 211.232 21.9101C211.258 21.9101 211.284 21.8581 211.309 21.8061Z\"\n        fill=\"#0068C7\"\n      />\n      <path\n        d=\"M214.879 24.0148C214.571 24.9502 213.441 26.6652 212.747 27.4447C209.101 32.3558 201.448 33.2132 195.953 29.0558C190.483 24.9762 189.482 16.6873 193.128 11.7502C193.693 10.9967 194.643 9.80143 195.465 9.09985C195.285 9.25576 195.105 9.43765 194.951 9.64552C193.821 11.1786 194.078 13.4132 195.131 15.6219C196.21 17.8565 198.136 20.1951 200.627 22.092C201.885 23.0534 203.22 23.8589 204.581 24.4825C205.942 25.1062 207.303 25.5739 208.562 25.8077C209.846 26.0676 211.027 26.1195 212.054 25.9117C213.081 25.7038 213.954 25.2621 214.545 24.4825C214.699 24.3266 214.802 24.1707 214.879 24.0148Z\"\n        fill=\"#0068C7\"\n      />\n      <path\n        d=\"M218.577 26.4054C218.012 27.9385 216.959 29.8353 215.495 31.5503C209.589 38.3582 199.368 39.6314 192.024 34.0448C184.705 28.5101 182.985 18.3503 187.787 10.633C188.865 8.89203 190.945 6.83928 192.178 5.95581C192.152 5.98179 191.459 6.6314 191.176 7.02116C189.61 9.15187 189.738 12.296 191.099 15.466C192.46 18.6881 195.08 22.066 198.701 24.8204C200.524 26.1975 202.424 27.2889 204.324 28.1204C206.225 28.9519 208.125 29.4716 209.871 29.7314C213.364 30.1991 216.445 29.5235 218.012 27.3928C218.243 27.081 218.448 26.7432 218.577 26.4054Z\"\n        fill=\"#0068C7\"\n      />\n      <path\n        d=\"M217.832 18.9739C216.317 15.7779 213.544 12.4259 209.923 9.67158C206.328 6.91725 202.424 5.22828 199.06 4.70859C197.853 4.5267 196.672 4.50072 195.619 4.63064C195.568 4.63064 195.516 4.63064 195.491 4.65662C195.337 4.68261 195.157 4.70859 195.003 4.73458C194.977 4.73458 194.951 4.73458 194.9 4.76056C194.797 4.78654 194.695 4.81253 194.618 4.83851C194.515 4.8645 194.438 4.89048 194.361 4.91647C194.284 4.94245 194.207 4.96843 194.13 4.99442C193.385 5.22828 192.717 5.59206 192.127 6.05977C191.767 6.31962 191.459 6.63143 191.176 7.02119C189.61 9.1519 189.738 12.296 191.099 15.4661C192.46 18.6881 195.08 22.0661 198.701 24.8204C200.524 26.1976 202.424 27.2889 204.324 28.1204C206.225 28.9519 208.125 29.4716 209.871 29.7314C213.364 30.1991 216.445 29.5236 218.012 27.3928C218.243 27.107 218.423 26.7692 218.577 26.4314C219.527 24.3527 219.116 21.6763 217.832 18.9739ZM217.55 26.6133C217.498 26.6913 217.447 26.7952 217.37 26.8732C216.06 28.6401 213.364 29.3676 210 28.8999C209.846 28.8739 209.692 28.848 209.537 28.822C207.509 28.4842 205.3 27.7306 203.092 26.6133C201.782 25.9377 200.473 25.1062 199.214 24.1448C197.853 23.1054 196.621 21.9881 195.568 20.7928C193.899 18.948 192.666 16.9991 191.87 15.1283C190.56 12.0362 190.56 9.28182 191.844 7.48891C193.154 5.72198 195.722 5.04639 198.932 5.54009C200.524 5.77395 202.27 6.31962 204.068 7.12513C205.84 7.93064 207.663 8.99599 209.435 10.3472C212.979 13.0236 215.649 16.2716 217.087 19.3377C218.474 22.248 218.654 24.8464 217.55 26.6133Z\"\n        fill=\"white\"\n      />\n      <path\n        d=\"M214.16 18.5061C212.953 16.2975 210.873 13.9589 208.382 12.062C205.891 10.1652 203.143 8.84 200.704 8.3463C198.88 7.95654 197.16 8.03449 195.927 8.78803C195.901 8.78803 195.876 8.81402 195.876 8.81402C195.876 8.81402 195.85 8.81402 195.85 8.84C195.799 8.86599 195.747 8.89197 195.722 8.94394C195.645 8.99591 195.568 9.07386 195.491 9.12583C195.311 9.28173 195.131 9.46362 194.977 9.6715C193.847 11.2046 194.104 13.4392 195.157 15.6479C196.235 17.8825 198.161 20.2211 200.652 22.118C201.911 23.0794 203.246 23.8849 204.607 24.5085C205.968 25.1321 207.329 25.5998 208.587 25.8337C209.871 26.0935 211.053 26.1455 212.08 25.9376C213.107 25.7298 213.98 25.288 214.571 24.5085C214.673 24.3786 214.776 24.2227 214.853 24.0668C215.675 22.5077 215.238 20.4809 214.16 18.5061ZM213.929 23.9628C213.518 24.5345 212.85 24.8983 211.951 25.0802C211.053 25.262 209.974 25.2101 208.767 24.9762C206.353 24.5085 203.58 23.2353 201.14 21.4164C198.726 19.5975 196.877 17.3369 195.876 15.2581C194.849 13.1534 194.772 11.3085 195.619 10.1652C196.441 9.02189 198.213 8.6841 200.498 9.15181C202.784 9.61953 205.429 10.8928 207.843 12.7376C210.256 14.5825 212.259 16.8172 213.415 18.9219C214.108 20.1691 214.442 21.3124 214.442 22.2739C214.442 22.9235 214.288 23.4951 213.929 23.9628Z\"\n        fill=\"white\"\n      />\n      <path\n        fill-rule=\"evenodd\"\n        clip-rule=\"evenodd\"\n        d=\"M211.515 20.351C211.412 19.7793 211.155 19.1297 210.77 18.4801C210 17.1809 208.716 15.7778 207.098 14.5565C205.506 13.3352 203.837 12.4778 202.398 12.14C201.679 11.9581 201.012 11.9061 200.447 11.9841C200.01 12.036 199.599 12.2179 199.291 12.4778C199.189 12.5557 199.111 12.6337 199.034 12.7376C198.701 13.1793 198.624 13.725 198.701 14.2967C198.778 14.8683 199.009 15.5179 199.368 16.1675C200.087 17.4667 201.346 18.8959 202.963 20.1171C204.581 21.3384 206.302 22.1699 207.791 22.5077C208.536 22.6896 209.229 22.7415 209.794 22.6636C210.385 22.5856 210.899 22.3518 211.232 21.91C211.258 21.8581 211.284 21.8321 211.309 21.7801C211.54 21.3904 211.592 20.8707 211.515 20.351ZM210.616 21.4943C210.436 21.7281 210.128 21.8841 209.666 21.962C209.204 22.014 208.613 21.988 207.92 21.8061C206.559 21.4683 204.915 20.6888 203.374 19.5195C201.834 18.3502 200.652 17.025 199.985 15.8037C199.651 15.2061 199.471 14.6604 199.394 14.1927C199.343 13.725 199.42 13.4132 199.599 13.1793C199.779 12.9455 200.062 12.7636 200.524 12.7116C200.96 12.6596 201.525 12.6856 202.193 12.8415C202.835 12.9974 203.58 13.2833 204.324 13.673C205.069 14.0628 205.865 14.5565 206.61 15.1541C208.151 16.3234 209.383 17.6486 210.102 18.8439C210.462 19.4415 210.667 19.9872 210.744 20.4549C210.847 20.9486 210.77 21.2864 210.616 21.4943Z\"\n        fill=\"white\"\n      />\n    </g>\n    <path\n      d=\"M246.292 9.76333H243.172L235.252 31.1633L227.372 9.76333H224.252L233.692 35.0433H236.852L246.292 9.76333ZM261.251 25.4033C261.251 29.8033 260.131 32.6033 255.691 32.6033C251.251 32.6033 250.091 29.8033 250.091 25.4033C250.091 21.0033 251.251 18.2033 255.691 18.2033C260.131 18.2033 261.251 21.0033 261.251 25.4033ZM255.691 35.3633C261.771 35.3633 264.171 31.2833 264.171 25.4033C264.171 19.4033 261.891 15.4433 255.691 15.4433C249.571 15.4433 247.171 19.5233 247.171 25.4033C247.171 31.4033 249.451 35.3633 255.691 35.3633ZM268.747 29.6833C268.747 33.8433 270.827 35.2833 273.587 35.2833C274.627 35.2833 275.427 35.1233 275.947 34.8833L275.547 32.2433C275.107 32.4433 274.507 32.5233 273.827 32.5233C272.467 32.5233 271.667 31.8833 271.667 29.2433V7.76333H268.747V29.6833Z\"\n      fill=\"#3EAE2B\"\n    />\n    <path\n      d=\"M299.261 9.76333H296.141L288.221 31.1633L280.341 9.76333H277.221L286.661 35.0433H289.821L299.261 9.76333ZM302.505 35.0433H305.425V15.7633H302.505V35.0433ZM302.065 9.16333C302.065 10.2033 302.905 11.0433 303.985 11.0433C305.025 11.0433 305.865 10.2033 305.865 9.16333C305.865 8.12333 305.025 7.24333 303.985 7.24333C302.905 7.24333 302.065 8.08333 302.065 9.16333ZM326.615 23.8833C326.615 18.2833 323.615 15.4433 318.535 15.4433C312.215 15.4433 310.175 19.8833 310.175 25.4433C310.175 32.2833 313.295 35.3633 319.455 35.3633C321.815 35.3633 324.095 34.8833 325.975 34.0433L325.535 31.2833C324.095 32.0433 321.735 32.6033 319.495 32.6033C315.495 32.6033 313.135 30.8033 313.135 26.7233V26.5633H326.295C326.535 25.7233 326.615 24.6833 326.615 23.8833ZM313.135 23.8433C313.135 19.6833 315.215 18.0433 318.455 18.0433C321.735 18.0433 323.815 19.7233 323.815 23.8433V24.0833H313.135V23.8433ZM332.648 15.7633H329.648L336.368 35.0433H339.368L344.608 20.2833L349.848 35.0433H352.848L359.568 15.7633H356.568L351.328 31.0833L346.088 15.7633H343.128L337.888 31.0833L332.648 15.7633Z\"\n      fill=\"#0068C7\"\n    />\n    <path\n      d=\"M8.87229 5.59206L0.781128 14.7137L2.74742 16.9885L13.3699 5.00647H10.1831C9.68593 5.00647 9.2113 5.20917 8.87229 5.59206Z\"\n      fill=\"#3EAE2B\"\n    />\n    <path\n      d=\"M15.0876 5.59206L3.85486 18.2497L5.82115 20.5245L19.5852 5.00647H16.3984C15.9012 5.00647 15.404 5.20917 15.0876 5.59206Z\"\n      fill=\"#3EAE2B\"\n    />\n    <path\n      d=\"M25.7778 5.00647H22.6137C22.1165 5.00647 21.6193 5.23169 21.2802 5.59206L6.90601 21.8083L19.879 36.8308C20.218 37.2137 20.6926 37.4389 21.2124 37.4389H24.3314L10.8386 21.8308L25.7778 5.00647Z\"\n      fill=\"#3EAE2B\"\n    />\n    <path\n      d=\"M12.059 37.4389L0.781128 24.3983V28.9479L7.60663 36.8307C7.94565 37.2136 8.42027 37.4389 8.94009 37.4389H12.059Z\"\n      fill=\"#0068C7\"\n    />\n    <path\n      d=\"M18.2065 37.4389L0.781128 17.2812V21.8308L13.7541 36.8308C14.0931 37.2137 14.5677 37.4389 15.0876 37.4389H18.2065Z\"\n      fill=\"#0068C7\"\n    />\n    <path\n      d=\"M31.2925 7.37134H34.2532V35.029H31.2925V7.37134ZM43.2936 15.4794H47.068L38.9316 24.7137L47.8816 35.0065H44.1073L35.1573 24.7137L43.2936 15.4794Z\"\n      fill=\"#0068C7\"\n    />\n    <path\n      d=\"M51.6786 6.85327C52.7408 6.85327 53.5996 7.75417 53.5996 8.79021C53.5996 9.84877 52.7408 10.7046 51.6786 10.7046C50.5711 10.7046 49.7349 9.84877 49.7349 8.79021C49.7349 7.70913 50.5937 6.85327 51.6786 6.85327ZM50.1869 15.4794H53.1476V35.0289H50.1869V15.4794Z\"\n      fill=\"#0068C7\"\n    />\n    <path\n      d=\"M57.6453 10.2091H60.606V15.4794H68.4486V18.2722H60.606V28.1596C60.606 31.5154 62.1203 32.5289 64.3804 32.5289C66.0077 32.5289 67.7253 32.1235 68.8554 31.6055L69.3074 34.3983C67.9965 34.9614 66.2111 35.3217 64.3804 35.3217C60.4252 35.3217 57.6227 33.4974 57.6227 28.137V10.2091H57.6453Z\"\n      fill=\"#0068C7\"\n    />\n    <path\n      d=\"M79.0032 31.0199L84.337 15.4794H87.343L92.6768 30.9974L97.988 15.4794H101.039L94.2137 35.0289H91.1625L85.8287 20.074L80.4949 35.0289H77.4437L70.6182 15.4794H73.6694L79.0032 31.0199Z\"\n      fill=\"#0068C7\"\n    />\n    <path\n      d=\"M117.109 34.2182C115.278 34.8713 112.385 35.3443 109.673 35.3443C104.949 35.3443 101.83 33.7677 101.83 29.3533C101.83 24.9839 104.972 23.3173 110.283 23.3173H114.148V21.4029C114.148 18.7227 112.272 17.8668 109.176 17.8668C106.893 17.8668 105.017 18.2722 103.797 18.7227L103.345 15.9975C104.927 15.547 106.915 15.1416 109.289 15.1416C113.764 15.1416 117.109 16.7632 117.109 21.6281V34.2182ZM114.148 25.6596H110.328C106.712 25.6596 104.791 26.5605 104.791 29.3083C104.791 32.056 106.712 32.7993 109.582 32.7993C111.006 32.7993 112.882 32.6416 114.148 32.2362V25.6596Z\"\n      fill=\"#0068C7\"\n    />\n    <path\n      d=\"M121.651 16.2902C122.962 15.6821 125.403 15.1866 127.799 15.1866C129.336 15.1866 130.647 15.3443 131.709 15.6821L131.144 18.4299C130.534 18.1821 129.313 17.9794 127.889 17.9794C126.217 17.9794 125.335 18.1821 124.635 18.4975V35.0065H121.674V16.2902H121.651Z\"\n      fill=\"#0068C7\"\n    />\n    <path\n      d=\"M148.931 26.4253H135.528V26.583C135.528 30.7271 137.924 32.5515 141.992 32.5515C144.275 32.5515 146.671 31.9884 148.14 31.2226L148.592 34.0154C146.671 34.8713 144.365 35.3442 141.97 35.3442C135.709 35.3442 132.522 32.2136 132.522 25.2992C132.522 19.6686 134.602 15.1641 141.02 15.1641C146.196 15.1641 149.247 18.0469 149.247 23.7226C149.247 24.5334 149.157 25.5695 148.931 26.4253ZM135.528 23.9253H146.399V23.6776C146.399 19.5109 144.275 17.7992 140.953 17.7992C137.653 17.7992 135.551 19.4659 135.551 23.6776V23.9253H135.528Z\"\n      fill=\"#0068C7\"\n    />\n    <line\n      x1=\"170.559\"\n      y1=\"0.935669\"\n      x2=\"170.559\"\n      y2=\"42.4279\"\n      stroke=\"#CACACA\"\n    />\n    <defs>\n      <clipPath id=\"clip0_137_135\">\n        <rect\n          width=\"34\"\n          height=\"33\"\n          fill=\"white\"\n          transform=\"translate(185.09 4.55261)\"\n        />\n      </clipPath>\n    </defs>\n  </svg>\n</template>\n\n<script>\nexport default {\n  name: 'volview-full-logo',\n};\n</script>\n","export default \"__VITE_ASSET__9d50cc74__\"","<template>\n  <v-card class=\"py-4\">\n    <v-btn\n      variant=\"text\"\n      class=\"close-button\"\n      icon=\"mdi-close\"\n      @click=\"$emit('close')\"\n    />\n    <v-card-title class=\"d-flex flex-row justify-center\">\n      <vol-view-full-logo />\n    </v-card-title>\n    <v-card-text>\n      <h2 class=\"mt-2\">About VolView</h2>\n      <v-divider class=\"mb-2\" />\n      <p class=\"float-right\">\n        <v-img\n          v-show=\"!mobile\"\n          src=\"../assets/KitwareHeadAndNeck.jpg\"\n          alt=\"Head and neck CT rendering\"\n          width=\"200px\"\n          class=\"ma-1\"\n          align=\"center\"\n        /><br />\n      </p>\n      <p>\n        <a\n          rel=\"noopener noreferrer\"\n          target=\"_blank\"\n          href=\"https://volview.kitware.com/\"\n        >\n          <span>VolView</span>\n        </a>\n        is an open-source web application developed at\n        <a\n          rel=\"noopener noreferrer\"\n          target=\"_blank\"\n          href=\"https://kitware.com/\"\n        >\n          <span>Kitware</span>\n        </a>\n        for visualizing and annotating medical images. It key features include:\n      </p>\n\n      <ul class=\"pl-6\">\n        <li>Fast: Drag-and-drop DICOM files for quick viewing</li>\n        <li>\n          Flexible: Designed to be easily integrated into existing systems\n        </li>\n        <li>\n          Beautiful: Cinematic volume rendering to generate high-quality 3D\n          visualizations\n        </li>\n        <li>\n          Friendly: Familiar radiological image visualization and annotation\n          tools\n        </li>\n        <li>\n          Secure: Your data stays on your machine. No cloud services or data\n          servers are used.\n        </li>\n      </ul>\n      <br />\n      VolView is freely available for research, educational, and commercial\n      applications. It is built using a variety of open-source toolks created by\n      Kitware, such as\n      <a\n        rel=\"noopener noreferrer\"\n        target=\"_blank\"\n        href=\"https://github.com/InsightSoftwareConsortium/itk-wasm/\"\n      >\n        <span>itk-wasm</span>\n      </a>\n      for DICOM I/O and image processing, and\n      <a\n        rel=\"noopener noreferrer\"\n        target=\"_blank\"\n        href=\"https://github.com/Kitware/vtk-js\"\n      >\n        <span>vtk.js</span>\n      </a>\n      for in-browser scientific visualization.\n      <br />\n      <br />\n      Want help customizing VolView or creating a new web-based visualization\n      application?\n      <a\n        rel-=\"noopener noreferrer\"\n        target=\"_blank\"\n        href=\"https://www.kitware.com/contact/project/\"\n        >Contact Kitware!</a\n      >\n      <h2 class=\"mt-2\">Useful Links</h2>\n      <v-divider class=\"mb-2\" />\n      <ul class=\"pl-6\">\n        <li>\n          <span>VolView source code repo: </span>\n          <a\n            rel=\"noopener noreferrer\"\n            target=\"_blank\"\n            href=\"https://github.com/Kitware/VolView\"\n          >\n            https://github.com/Kitware/VolView\n          </a>\n        </li>\n        <li>\n          <span>Community support forum: </span>\n          <a\n            rel=\"noopener noreferrer\"\n            target=\"_blank\"\n            href=\"https://discourse.vtk.org/c/web/volview/14\"\n          >\n            https://discourse.vtk.org/c/web/volview/14\n          </a>\n        </li>\n        <li>\n          <span>File an bug report or feature request: </span>\n          <a\n            rel=\"noopener noreferrer\"\n            target=\"_blank\"\n            href=\"https://github.com/Kitware/VolView/issues\"\n          >\n            https://github.com/Kitware/VolView/issues\n          </a>\n        </li>\n      </ul>\n      <h2>Version Info</h2>\n      <v-divider class=\"mb-2\" />\n      <ul class=\"pl-6\">\n        <li>\n          <div class=\"d-flex flex-flow align-center text-no-wrap\">\n            <span>VolView: </span>\n            <v-badge inline :content=\"versions.volview\" />\n          </div>\n        </li>\n        <li>\n          <div class=\"d-flex flex-flow align-center text-no-wrap\">\n            <span>vtk.js: </span>\n            <v-badge inline :content=\"versions['vtk.js']\" />\n          </div>\n        </li>\n        <li>\n          <div class=\"d-flex flex-flow align-center text-no-wrap\">\n            <span>itk-wasm: </span>\n            <v-badge inline :content=\"versions['itk-wasm']\" />\n          </div>\n        </li>\n      </ul>\n      <h2 class=\"mt-2\">Acknowledgments</h2>\n      <v-divider class=\"mb-2\" />\n      This work was funded, in part, by the NIH via NIBIB and NIGMS R01EB021396,\n      NIBIB R01EB014955, NCI R01CA220681, and NINDS R42NS086295\n      <br />\n      <br />\n      Sample data provided by the following sources:\n      <ul class=\"pl-6\">\n        <li>\n          PROSTATEx Challenge Data: Geert Litjens, Oscar Debats, Jelle Barentsz,\n          Nico Karssemeijer, and Henkjan Huisman. \"ProstateX Challenge data\",\n          The Cancer Imaging Archive (2017). DOI: 10.7937/K9TCIA.2017.MURS5CL\n          (<a\n            rel=\"noopener noreferrer\"\n            target=\"_blank\"\n            href=\"https://wiki.cancerimagingarchive.net/pages/viewpage.action?pageId=23691656\"\n            >TCIA</a\n          >)\n        </li>\n        <li>\n          MRA Head and Neck: Test case 98890234 from the \"Patient Contributed\n          Image Repository\" (<a\n            rel=\"noopener noreferrer\"\n            target=\"_blank\"\n            href=\"http://www.pcir.org/researchers/98890234_20030505_MR.html\"\n            >PCIR.org</a\n          >)\n        </li>\n        <li>\n          3D ultrasound of a fetus: Sample data from\n          <a\n            rel=\"noopener noreferrer\"\n            target=\"_blank\"\n            href=\"http://tomovision.comi\"\n            >tomovision.com</a\n          >\n        </li>\n      </ul>\n    </v-card-text>\n  </v-card>\n</template>\n\n<style scoped>\n.close-button {\n  position: absolute;\n  right: 12px;\n  top: 12px;\n}\n</style>\n\n<script>\n/* global __VERSIONS__ */\n\nimport { defineComponent } from 'vue';\nimport { useDisplay } from 'vuetify';\nimport VolViewFullLogo from './icons/VolViewFullLogo.vue';\n\nexport default defineComponent({\n  name: 'AboutBox',\n  components: {\n    VolViewFullLogo,\n  },\n  setup() {\n    const display = useDisplay();\n\n    return {\n      mobile: display.xs,\n      versions: {\n        volview: __VERSIONS__.volview,\n        'vtk.js': __VERSIONS__['vtk.js'],\n        'itk-wasm': __VERSIONS__['itk-wasm'],\n      },\n    };\n  },\n});\n</script>\n","<template>\n  <v-card width=\"350px\">\n    <v-container>\n      <!--\n      <v-row no-gutters align=\"center\">\n        <v-col>\n          <v-select\n            density=\"compact\"\n            outlined\n            hide-details\n            label=\"Select or create a labelmap\"\n          />\n        </v-col>\n      </v-row>\n      -->\n      <v-row no-gutters align=\"center\">\n        <v-col>\n          <v-slider\n            :model-value=\"brushSize\"\n            @update:model-value=\"setBrushSize\"\n            density=\"compact\"\n            hide-details\n            label=\"Size\"\n            min=\"1\"\n            max=\"50\"\n          >\n            <template v-slot:append>\n              <v-text-field\n                :model-value=\"brushSize\"\n                @input=\"setBrushSize\"\n                variant=\"underlined\"\n                class=\"mt-n1 pt-0\"\n                style=\"width: 40px\"\n                hide-details\n                type=\"number\"\n                min=\"1\"\n                max=\"50\"\n              />\n            </template>\n          </v-slider>\n        </v-col>\n      </v-row>\n      <v-row no-gutters align=\"center\">\n        <v-col>\n          <v-slider\n            :model-value=\"opacity\"\n            @update:model-value=\"setOpacity\"\n            density=\"compact\"\n            hide-details\n            label=\"Opacity\"\n            min=\"0\"\n            max=\"1\"\n            step=\"0.01\"\n          >\n            <template v-slot:append>\n              <v-text-field\n                :model-value=\"opacity\"\n                @input=\"setOpacity\"\n                variant=\"underlined\"\n                class=\"mt-n1 pt-0\"\n                style=\"width: 40px\"\n                hide-details\n                type=\"number\"\n                min=\"0\"\n                max=\"1\"\n                step=\"0.1\"\n              />\n            </template>\n          </v-slider>\n        </v-col>\n      </v-row>\n      <v-row no-gutters align=\"center\">\n        <v-col>\n          <v-color-picker\n            hide-canvas\n            hide-inputs\n            hide-mode-switch\n            hide-sliders\n            show-swatches\n            elevation=\"0\"\n            :swatches=\"swatches\"\n            :model-value=\"brushColor\"\n            @update:model-value=\"setBrushColor\"\n          />\n        </v-col>\n      </v-row>\n    </v-container>\n  </v-card>\n</template>\n\n<script lang=\"ts\">\nimport { computed, defineComponent } from 'vue';\nimport { LABELMAP_PALETTE } from '../config';\nimport { usePaintToolStore } from '../store/tools/paint';\nimport { rgbaToHexa } from '../utils/color';\n\n// generates both the swatches for v-color-picker and the color-to-value mapping\nfunction convertToSwatches(\n  palette: typeof LABELMAP_PALETTE,\n  width: number = 5\n) {\n  const hexToValue: Record<string, number> = {};\n  const swatches: string[][] = [];\n  const entries = Object.entries(palette);\n  while (entries.length) {\n    const [value, rgba] = entries.shift()!;\n    const hex = rgbaToHexa(rgba).toUpperCase();\n    hexToValue[hex] = Number(value);\n\n    let row = swatches[swatches.length - 1];\n    if (!row || row.length === width) {\n      row = [];\n      swatches.push(row);\n    }\n    row.push(hex);\n  }\n\n  return { hexToValue, swatches };\n}\n\nexport default defineComponent({\n  name: 'PaintControls',\n\n  setup() {\n    const paintStore = usePaintToolStore();\n\n    const { hexToValue, swatches } = convertToSwatches(LABELMAP_PALETTE, 3);\n    const brushColor = computed(() => {\n      const value = paintStore.brushValue;\n      if (value in LABELMAP_PALETTE) {\n        return rgbaToHexa(LABELMAP_PALETTE[value]);\n      }\n      return null;\n    });\n\n    const setBrushColor = (color: string) => {\n      const hexa = `${color}FF`.toUpperCase();\n      if (hexa in hexToValue) {\n        paintStore.setBrushValue(hexToValue[hexa]);\n      }\n    };\n\n    const brushSize = computed(() => paintStore.brushSize);\n    const setBrushSize = (size: number) => {\n      paintStore.setBrushSize(Number(size));\n    };\n\n    const opacity = computed(() => paintStore.labelmapOpacity);\n    const setOpacity = (op: number) => {\n      paintStore.setLabelmapOpacity(Number(op));\n    };\n\n    return {\n      brushSize,\n      setBrushSize,\n      swatches,\n      brushColor,\n      setBrushColor,\n      opacity,\n      setOpacity,\n    };\n  },\n});\n</script>\n\n<style scoped>\n.form-label {\n  color: rgba(0, 0, 0, 0.6);\n}\n\n.scrolled-radios {\n  max-height: 300px;\n  overflow: auto;\n  /* prevents hover circle from clipping left */\n  padding-left: 6px;\n}\n</style>\n","<template>\n  <v-card width=\"350px\">\n    <v-container>\n      <!--\n      <v-row no-gutters align=\"center\">\n        <v-col>\n          <v-select\n            density=\"compact\"\n            outlined\n            hide-details\n            label=\"Select or create a labelmap\"\n          />\n        </v-col>\n      </v-row>\n      -->\n      <v-row no-gutters align=\"center\">\n        <v-col>\n          <v-slider\n            :model-value=\"brushSize\"\n            @update:model-value=\"setBrushSize\"\n            density=\"compact\"\n            hide-details\n            label=\"Size\"\n            min=\"1\"\n            max=\"50\"\n          >\n            <template v-slot:append>\n              <v-text-field\n                :model-value=\"brushSize\"\n                @input=\"setBrushSize\"\n                variant=\"underlined\"\n                class=\"mt-n1 pt-0\"\n                style=\"width: 40px\"\n                hide-details\n                type=\"number\"\n                min=\"1\"\n                max=\"50\"\n              />\n            </template>\n          </v-slider>\n        </v-col>\n      </v-row>\n      <v-row no-gutters align=\"center\">\n        <v-col>\n          <v-slider\n            :model-value=\"opacity\"\n            @update:model-value=\"setOpacity\"\n            density=\"compact\"\n            hide-details\n            label=\"Opacity\"\n            min=\"0\"\n            max=\"1\"\n            step=\"0.01\"\n          >\n            <template v-slot:append>\n              <v-text-field\n                :model-value=\"opacity\"\n                @input=\"setOpacity\"\n                variant=\"underlined\"\n                class=\"mt-n1 pt-0\"\n                style=\"width: 40px\"\n                hide-details\n                type=\"number\"\n                min=\"0\"\n                max=\"1\"\n                step=\"0.1\"\n              />\n            </template>\n          </v-slider>\n        </v-col>\n      </v-row>\n      <v-row no-gutters align=\"center\">\n        <v-col>\n          <v-color-picker\n            hide-canvas\n            hide-inputs\n            hide-mode-switch\n            hide-sliders\n            show-swatches\n            elevation=\"0\"\n            :swatches=\"swatches\"\n            :model-value=\"brushColor\"\n            @update:model-value=\"setBrushColor\"\n          />\n        </v-col>\n      </v-row>\n    </v-container>\n  </v-card>\n</template>\n\n<script lang=\"ts\">\nimport { computed, defineComponent } from 'vue';\nimport { LABELMAP_PALETTE } from '../config';\nimport { usePaintToolStore } from '../store/tools/paint';\nimport { rgbaToHexa } from '../utils/color';\n\n// generates both the swatches for v-color-picker and the color-to-value mapping\nfunction convertToSwatches(\n  palette: typeof LABELMAP_PALETTE,\n  width: number = 5\n) {\n  const hexToValue: Record<string, number> = {};\n  const swatches: string[][] = [];\n  const entries = Object.entries(palette);\n  while (entries.length) {\n    const [value, rgba] = entries.shift()!;\n    const hex = rgbaToHexa(rgba).toUpperCase();\n    hexToValue[hex] = Number(value);\n\n    let row = swatches[swatches.length - 1];\n    if (!row || row.length === width) {\n      row = [];\n      swatches.push(row);\n    }\n    row.push(hex);\n  }\n\n  return { hexToValue, swatches };\n}\n\nexport default defineComponent({\n  name: 'PaintControls',\n\n  setup() {\n    const paintStore = usePaintToolStore();\n\n    const { hexToValue, swatches } = convertToSwatches(LABELMAP_PALETTE, 3);\n    const brushColor = computed(() => {\n      const value = paintStore.brushValue;\n      if (value in LABELMAP_PALETTE) {\n        return rgbaToHexa(LABELMAP_PALETTE[value]);\n      }\n      return null;\n    });\n\n    const setBrushColor = (color: string) => {\n      const hexa = `${color}FF`.toUpperCase();\n      if (hexa in hexToValue) {\n        paintStore.setBrushValue(hexToValue[hexa]);\n      }\n    };\n\n    const brushSize = computed(() => paintStore.brushSize);\n    const setBrushSize = (size: number) => {\n      paintStore.setBrushSize(Number(size));\n    };\n\n    const opacity = computed(() => paintStore.labelmapOpacity);\n    const setOpacity = (op: number) => {\n      paintStore.setLabelmapOpacity(Number(op));\n    };\n\n    return {\n      brushSize,\n      setBrushSize,\n      swatches,\n      brushColor,\n      setBrushColor,\n      opacity,\n      setOpacity,\n    };\n  },\n});\n</script>\n\n<style scoped>\n.form-label {\n  color: rgba(0, 0, 0, 0.6);\n}\n\n.scrolled-radios {\n  max-height: 300px;\n  overflow: auto;\n  /* prevents hover circle from clipping left */\n  padding-left: 6px;\n}\n</style>\n","<script lang=\"ts\">\nimport { watch, ref, computed, defineComponent } from 'vue';\nimport { useDisplay } from 'vuetify';\nimport ToolButton from './ToolButton.vue';\n\nexport default defineComponent({\n  name: 'MenuToolButton',\n  props: {\n    icon: { type: String, required: true },\n    name: { type: String, required: true },\n    size: { type: [Number, String], default: 40 },\n    active: Boolean,\n    disabled: Boolean,\n    mobileOnlyMenu: Boolean,\n  },\n  components: {\n    ToolButton,\n  },\n  setup(props) {\n    const display = useDisplay();\n\n    const showLeft = computed(() => !display.mobile.value);\n\n    const menuOn = ref(false);\n\n    const enableMenu = computed(\n      () => !props.mobileOnlyMenu || display.mobile.value\n    );\n\n    // Disable menu if mobile only\n    watch(menuOn, (on) => {\n      menuOn.value = on && enableMenu.value;\n    });\n\n    // Turn off menu if tool deselected\n    const active = computed(() => props.active);\n    watch(active, (on) => {\n      if (!on) {\n        menuOn.value = false;\n      }\n    });\n\n    return { showLeft, menuOn, enableMenu };\n  },\n});\n</script>\n\n<template>\n  <v-menu\n    no-click-animation\n    :close-on-content-click=\"false\"\n    v-model=\"menuOn\"\n    :location=\"showLeft ? 'left' : 'right'\"\n    class=\"overflow-auto\"\n  >\n    <template #activator=\"{ props }\">\n      <tool-button\n        :icon=\"icon\"\n        :name=\"name\"\n        :buttonClass=\"['tool-btn', active ? 'tool-btn-selected' : '']\"\n        :disabled=\"disabled\"\n        :size=\"size\"\n        @click=\"$emit('click')\"\n        v-bind=\"props\"\n      >\n        <v-icon\n          v-if=\"active && enableMenu\"\n          :class=\"[showLeft ? 'menu-more-left' : 'menu-more-right']\"\n          size=\"18\"\n        >\n          {{ showLeft ? 'mdi-menu-left' : 'mdi-menu-right' }}\n        </v-icon>\n      </tool-button>\n    </template>\n\n    <div class=\"menu-content elevation-24\">\n      <slot />\n    </div>\n  </v-menu>\n</template>\n\n<style scoped>\n.menu-more-left {\n  position: absolute;\n  left: -12%;\n}\n.menu-more-right {\n  position: absolute;\n  right: -12%;\n}\n\n.menu-content {\n  /* Show on top of button tooltip */\n  z-index: 1;\n}\n</style>\n","<script lang=\"ts\">\nimport { watch, ref, computed, defineComponent } from 'vue';\nimport { useDisplay } from 'vuetify';\nimport ToolButton from './ToolButton.vue';\n\nexport default defineComponent({\n  name: 'MenuToolButton',\n  props: {\n    icon: { type: String, required: true },\n    name: { type: String, required: true },\n    size: { type: [Number, String], default: 40 },\n    active: Boolean,\n    disabled: Boolean,\n    mobileOnlyMenu: Boolean,\n  },\n  components: {\n    ToolButton,\n  },\n  setup(props) {\n    const display = useDisplay();\n\n    const showLeft = computed(() => !display.mobile.value);\n\n    const menuOn = ref(false);\n\n    const enableMenu = computed(\n      () => !props.mobileOnlyMenu || display.mobile.value\n    );\n\n    // Disable menu if mobile only\n    watch(menuOn, (on) => {\n      menuOn.value = on && enableMenu.value;\n    });\n\n    // Turn off menu if tool deselected\n    const active = computed(() => props.active);\n    watch(active, (on) => {\n      if (!on) {\n        menuOn.value = false;\n      }\n    });\n\n    return { showLeft, menuOn, enableMenu };\n  },\n});\n</script>\n\n<template>\n  <v-menu\n    no-click-animation\n    :close-on-content-click=\"false\"\n    v-model=\"menuOn\"\n    :location=\"showLeft ? 'left' : 'right'\"\n    class=\"overflow-auto\"\n  >\n    <template #activator=\"{ props }\">\n      <tool-button\n        :icon=\"icon\"\n        :name=\"name\"\n        :buttonClass=\"['tool-btn', active ? 'tool-btn-selected' : '']\"\n        :disabled=\"disabled\"\n        :size=\"size\"\n        @click=\"$emit('click')\"\n        v-bind=\"props\"\n      >\n        <v-icon\n          v-if=\"active && enableMenu\"\n          :class=\"[showLeft ? 'menu-more-left' : 'menu-more-right']\"\n          size=\"18\"\n        >\n          {{ showLeft ? 'mdi-menu-left' : 'mdi-menu-right' }}\n        </v-icon>\n      </tool-button>\n    </template>\n\n    <div class=\"menu-content elevation-24\">\n      <slot />\n    </div>\n  </v-menu>\n</template>\n\n<style scoped>\n.menu-more-left {\n  position: absolute;\n  left: -12%;\n}\n.menu-more-right {\n  position: absolute;\n  right: -12%;\n}\n\n.menu-content {\n  /* Show on top of button tooltip */\n  z-index: 1;\n}\n</style>\n","<script lang=\"ts\">\nimport { defineComponent } from 'vue';\nimport ToolButton from '@/src/components/ToolButton.vue';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useCropStore } from '@/src/store/tools/crop';\n\nexport default defineComponent({\n  components: {\n    ToolButton,\n  },\n  setup() {\n    const { currentImageID } = useCurrentImage();\n    const cropStore = useCropStore();\n\n    const resetCrop = () => {\n      const imageID = currentImageID.value;\n      if (imageID) {\n        cropStore.resetCropping(imageID);\n      }\n    };\n\n    return {\n      resetCrop,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-card dark>\n    <tool-button\n      size=\"40\"\n      icon=\"mdi-restore\"\n      name=\"Reset Crop\"\n      @click=\"resetCrop\"\n    />\n  </v-card>\n</template>\n","<script lang=\"ts\">\nimport { defineComponent } from 'vue';\nimport ToolButton from '@/src/components/ToolButton.vue';\nimport { useCurrentImage } from '@/src/composables/useCurrentImage';\nimport { useCropStore } from '@/src/store/tools/crop';\n\nexport default defineComponent({\n  components: {\n    ToolButton,\n  },\n  setup() {\n    const { currentImageID } = useCurrentImage();\n    const cropStore = useCropStore();\n\n    const resetCrop = () => {\n      const imageID = currentImageID.value;\n      if (imageID) {\n        cropStore.resetCropping(imageID);\n      }\n    };\n\n    return {\n      resetCrop,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-card dark>\n    <tool-button\n      size=\"40\"\n      icon=\"mdi-restore\"\n      name=\"Reset Crop\"\n      @click=\"resetCrop\"\n    />\n  </v-card>\n</template>\n","<template>\n  <item-group\n    mandatory\n    :model-value=\"currentTool\"\n    @update:model-value=\"setCurrentTool($event)\"\n  >\n    <div class=\"my-1 tool-separator\" />\n    <groupable-item\n      v-slot:default=\"{ active, toggle }\"\n      :value=\"Tools.WindowLevel\"\n    >\n      <tool-button\n        icon=\"mdi-circle-half-full\"\n        name=\"Window & Level\"\n        :buttonClass=\"['tool-btn', active ? 'tool-btn-selected' : '']\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      />\n    </groupable-item>\n    <groupable-item v-slot:default=\"{ active, toggle }\" :value=\"Tools.Pan\">\n      <tool-button\n        icon=\"mdi-cursor-move\"\n        name=\"Pan\"\n        :buttonClass=\"['tool-btn', active ? 'tool-btn-selected' : '']\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      />\n    </groupable-item>\n    <groupable-item v-slot:default=\"{ active, toggle }\" :value=\"Tools.Zoom\">\n      <tool-button\n        icon=\"mdi-magnify-plus-outline\"\n        name=\"Zoom\"\n        :buttonClass=\"['tool-btn', active ? 'tool-btn-selected' : '']\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      />\n    </groupable-item>\n    <groupable-item\n      v-slot:default=\"{ active, toggle }\"\n      :value=\"Tools.Crosshairs\"\n    >\n      <tool-button\n        icon=\"mdi-crosshairs\"\n        name=\"Crosshairs\"\n        :buttonClass=\"['tool-btn', active ? 'tool-btn-selected' : '']\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      />\n    </groupable-item>\n    <div class=\"my-1 tool-separator\" />\n    <groupable-item v-slot:default=\"{ active, toggle }\" :value=\"Tools.Paint\">\n      <menu-tool-button\n        icon=\"mdi-brush\"\n        name=\"Paint\"\n        :active=\"active\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      >\n        <paint-controls />\n      </menu-tool-button>\n    </groupable-item>\n    <groupable-item\n      v-slot:default=\"{ active, toggle }\"\n      :value=\"Tools.Rectangle\"\n    >\n      <menu-tool-button\n        icon=\"mdi-vector-square\"\n        name=\"Rectangle\"\n        :mobileOnlyMenu=\"true\"\n        :active=\"active\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      >\n        <rectangle-controls />\n      </menu-tool-button>\n    </groupable-item>\n    <groupable-item v-slot:default=\"{ active, toggle }\" :value=\"Tools.Ruler\">\n      <menu-tool-button\n        icon=\"mdi-ruler\"\n        name=\"Ruler\"\n        :mobileOnlyMenu=\"true\"\n        :active=\"active\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      >\n        <ruler-controls />\n      </menu-tool-button>\n    </groupable-item>\n    <groupable-item v-slot:default=\"{ active, toggle }\" :value=\"Tools.Contour\">\n      <menu-tool-button\n        icon=\"mdi-shape-circle-plus\"\n        name=\"Contour\"\n        mobile-only-menu\n        :active=\"active\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      >\n        <contour-controls />\n      </menu-tool-button>\n    </groupable-item>\n    <div class=\"my-1 tool-separator\" />\n    <groupable-item v-slot:default=\"{ active, toggle }\" :value=\"Tools.Crop\">\n      <menu-tool-button\n        icon=\"mdi-crop\"\n        name=\"Crop\"\n        :active=\"active\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      >\n        <crop-controls />\n      </menu-tool-button>\n    </groupable-item>\n  </item-group>\n</template>\n\n<script lang=\"ts\">\nimport { computed, defineComponent, ref } from 'vue';\nimport { onKeyDown } from '@vueuse/core';\nimport { Tools } from '@/src/store/tools/types';\nimport ToolButton from './ToolButton.vue';\nimport ItemGroup from './ItemGroup.vue';\nimport GroupableItem from './GroupableItem.vue';\nimport { useDatasetStore } from '../store/datasets';\nimport { useToolStore } from '../store/tools';\nimport PaintControls from './PaintControls.vue';\nimport MenuToolButton from './MenuToolButton.vue';\nimport CropControls from './tools/crop/CropControls.vue';\nimport { useRectangleStore } from '../store/tools/rectangles';\nimport { useRulerStore } from '../store/tools/rulers';\nimport RulerControls from './RulerControls.vue';\nimport RectangleControls from './RectangleControls.vue';\nimport ContourControls from './tools/contour/ContourControls.vue';\n\nexport default defineComponent({\n  components: {\n    ToolButton,\n    MenuToolButton,\n    ItemGroup,\n    GroupableItem,\n    PaintControls,\n    CropControls,\n    RulerControls,\n    RectangleControls,\n    ContourControls,\n  },\n  setup() {\n    const dataStore = useDatasetStore();\n    const toolStore = useToolStore();\n\n    const noCurrentImage = computed(() => !dataStore.primaryDataset);\n    const currentTool = computed(() => toolStore.currentTool);\n\n    const rectangleStore = useRectangleStore();\n    const rulerStore = useRulerStore();\n\n    const paintMenu = ref(false);\n    const cropMenu = ref(false);\n\n    onKeyDown('Escape', () => {\n      paintMenu.value = false;\n      cropMenu.value = false;\n    });\n\n    return {\n      currentTool,\n      setCurrentTool: toolStore.setCurrentTool,\n      noCurrentImage,\n      Tools,\n      paintMenu,\n      cropMenu,\n      rectangleStore,\n      rulerStore,\n    };\n  },\n});\n</script>\n\n<style>\n.tool-btn-selected {\n  background-color: rgb(var(--v-theme-selection-bg-color));\n}\n</style>\n\n<style scoped>\n.menu-more {\n  position: absolute;\n  right: -10%;\n}\n\n.tool-separator {\n  width: 75%;\n  height: 1px;\n  border: none;\n  border-top: 1px solid rgb(112, 112, 112);\n}\n\n.popup-menu {\n  max-width: 400px; /* a little less than v-navigation-drawer in App.vue */\n}\n</style>\n","<template>\n  <item-group\n    mandatory\n    :model-value=\"currentTool\"\n    @update:model-value=\"setCurrentTool($event)\"\n  >\n    <div class=\"my-1 tool-separator\" />\n    <groupable-item\n      v-slot:default=\"{ active, toggle }\"\n      :value=\"Tools.WindowLevel\"\n    >\n      <tool-button\n        icon=\"mdi-circle-half-full\"\n        name=\"Window & Level\"\n        :buttonClass=\"['tool-btn', active ? 'tool-btn-selected' : '']\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      />\n    </groupable-item>\n    <groupable-item v-slot:default=\"{ active, toggle }\" :value=\"Tools.Pan\">\n      <tool-button\n        icon=\"mdi-cursor-move\"\n        name=\"Pan\"\n        :buttonClass=\"['tool-btn', active ? 'tool-btn-selected' : '']\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      />\n    </groupable-item>\n    <groupable-item v-slot:default=\"{ active, toggle }\" :value=\"Tools.Zoom\">\n      <tool-button\n        icon=\"mdi-magnify-plus-outline\"\n        name=\"Zoom\"\n        :buttonClass=\"['tool-btn', active ? 'tool-btn-selected' : '']\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      />\n    </groupable-item>\n    <groupable-item\n      v-slot:default=\"{ active, toggle }\"\n      :value=\"Tools.Crosshairs\"\n    >\n      <tool-button\n        icon=\"mdi-crosshairs\"\n        name=\"Crosshairs\"\n        :buttonClass=\"['tool-btn', active ? 'tool-btn-selected' : '']\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      />\n    </groupable-item>\n    <div class=\"my-1 tool-separator\" />\n    <groupable-item v-slot:default=\"{ active, toggle }\" :value=\"Tools.Paint\">\n      <menu-tool-button\n        icon=\"mdi-brush\"\n        name=\"Paint\"\n        :active=\"active\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      >\n        <paint-controls />\n      </menu-tool-button>\n    </groupable-item>\n    <groupable-item\n      v-slot:default=\"{ active, toggle }\"\n      :value=\"Tools.Rectangle\"\n    >\n      <menu-tool-button\n        icon=\"mdi-vector-square\"\n        name=\"Rectangle\"\n        :mobileOnlyMenu=\"true\"\n        :active=\"active\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      >\n        <rectangle-controls />\n      </menu-tool-button>\n    </groupable-item>\n    <groupable-item v-slot:default=\"{ active, toggle }\" :value=\"Tools.Ruler\">\n      <menu-tool-button\n        icon=\"mdi-ruler\"\n        name=\"Ruler\"\n        :mobileOnlyMenu=\"true\"\n        :active=\"active\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      >\n        <ruler-controls />\n      </menu-tool-button>\n    </groupable-item>\n    <groupable-item v-slot:default=\"{ active, toggle }\" :value=\"Tools.Contour\">\n      <menu-tool-button\n        icon=\"mdi-shape-circle-plus\"\n        name=\"Contour\"\n        mobile-only-menu\n        :active=\"active\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      >\n        <contour-controls />\n      </menu-tool-button>\n    </groupable-item>\n    <div class=\"my-1 tool-separator\" />\n    <groupable-item v-slot:default=\"{ active, toggle }\" :value=\"Tools.Crop\">\n      <menu-tool-button\n        icon=\"mdi-crop\"\n        name=\"Crop\"\n        :active=\"active\"\n        :disabled=\"noCurrentImage\"\n        @click=\"toggle\"\n      >\n        <crop-controls />\n      </menu-tool-button>\n    </groupable-item>\n  </item-group>\n</template>\n\n<script lang=\"ts\">\nimport { computed, defineComponent, ref } from 'vue';\nimport { onKeyDown } from '@vueuse/core';\nimport { Tools } from '@/src/store/tools/types';\nimport ToolButton from './ToolButton.vue';\nimport ItemGroup from './ItemGroup.vue';\nimport GroupableItem from './GroupableItem.vue';\nimport { useDatasetStore } from '../store/datasets';\nimport { useToolStore } from '../store/tools';\nimport PaintControls from './PaintControls.vue';\nimport MenuToolButton from './MenuToolButton.vue';\nimport CropControls from './tools/crop/CropControls.vue';\nimport { useRectangleStore } from '../store/tools/rectangles';\nimport { useRulerStore } from '../store/tools/rulers';\nimport RulerControls from './RulerControls.vue';\nimport RectangleControls from './RectangleControls.vue';\nimport ContourControls from './tools/contour/ContourControls.vue';\n\nexport default defineComponent({\n  components: {\n    ToolButton,\n    MenuToolButton,\n    ItemGroup,\n    GroupableItem,\n    PaintControls,\n    CropControls,\n    RulerControls,\n    RectangleControls,\n    ContourControls,\n  },\n  setup() {\n    const dataStore = useDatasetStore();\n    const toolStore = useToolStore();\n\n    const noCurrentImage = computed(() => !dataStore.primaryDataset);\n    const currentTool = computed(() => toolStore.currentTool);\n\n    const rectangleStore = useRectangleStore();\n    const rulerStore = useRulerStore();\n\n    const paintMenu = ref(false);\n    const cropMenu = ref(false);\n\n    onKeyDown('Escape', () => {\n      paintMenu.value = false;\n      cropMenu.value = false;\n    });\n\n    return {\n      currentTool,\n      setCurrentTool: toolStore.setCurrentTool,\n      noCurrentImage,\n      Tools,\n      paintMenu,\n      cropMenu,\n      rectangleStore,\n      rulerStore,\n    };\n  },\n});\n</script>\n\n<style>\n.tool-btn-selected {\n  background-color: rgb(var(--v-theme-selection-bg-color));\n}\n</style>\n\n<style scoped>\n.menu-more {\n  position: absolute;\n  right: -10%;\n}\n\n.tool-separator {\n  width: 75%;\n  height: 1px;\n  border: none;\n  border-top: 1px solid rgb(112, 112, 112);\n}\n\n.popup-menu {\n  max-width: 400px; /* a little less than v-navigation-drawer in App.vue */\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent, PropType, toRefs } from 'vue';\nimport { Message, MessageType } from '../store/messages';\n\nconst MessageTypeClass: Record<MessageType, string> = {\n  [MessageType.Error]: 'error',\n  [MessageType.Warning]: 'warn',\n  [MessageType.Info]: 'info',\n  [MessageType.Success]: '',\n};\n\nexport default defineComponent({\n  props: {\n    message: {\n      type: Object as PropType<Message>,\n      required: true,\n    },\n  },\n  setup(props) {\n    const { message } = toRefs(props);\n\n    const headerClass = computed(() => {\n      const type = MessageTypeClass[message.value.type];\n      if (type?.length) {\n        return `${type}-message`;\n      }\n      return '';\n    });\n\n    return {\n      headerClass,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-expansion-panel>\n    <v-expansion-panel-title :class=\"headerClass\">\n      <div class=\"header\">\n        <span>{{ message.title }}</span>\n        <v-btn\n          icon=\"mdi-delete\"\n          variant=\"text\"\n          size=\"small\"\n          class=\"mr-3\"\n          @click.stop=\"$emit('delete')\"\n        />\n      </div>\n    </v-expansion-panel-title>\n    <v-expansion-panel-text v-if=\"message.options.details\">\n      <div class=\"mt-4\">\n        <pre class=\"details\">{{ message.options.details }}</pre>\n      </div>\n    </v-expansion-panel-text>\n  </v-expansion-panel>\n</template>\n\n<style scoped>\n.error-message {\n  background-color: #ef5350;\n}\n\n.warn-message {\n  background-color: #ffa726;\n}\n\n.info-message {\n  background-color: #26c6da;\n}\n\n.header {\n  width: 100%;\n  display: flex;\n  flex-flow: row;\n  justify-content: space-between;\n  align-items: center;\n}\n\n.details {\n  white-space: break-spaces;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent, PropType, toRefs } from 'vue';\nimport { Message, MessageType } from '../store/messages';\n\nconst MessageTypeClass: Record<MessageType, string> = {\n  [MessageType.Error]: 'error',\n  [MessageType.Warning]: 'warn',\n  [MessageType.Info]: 'info',\n  [MessageType.Success]: '',\n};\n\nexport default defineComponent({\n  props: {\n    message: {\n      type: Object as PropType<Message>,\n      required: true,\n    },\n  },\n  setup(props) {\n    const { message } = toRefs(props);\n\n    const headerClass = computed(() => {\n      const type = MessageTypeClass[message.value.type];\n      if (type?.length) {\n        return `${type}-message`;\n      }\n      return '';\n    });\n\n    return {\n      headerClass,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-expansion-panel>\n    <v-expansion-panel-title :class=\"headerClass\">\n      <div class=\"header\">\n        <span>{{ message.title }}</span>\n        <v-btn\n          icon=\"mdi-delete\"\n          variant=\"text\"\n          size=\"small\"\n          class=\"mr-3\"\n          @click.stop=\"$emit('delete')\"\n        />\n      </div>\n    </v-expansion-panel-title>\n    <v-expansion-panel-text v-if=\"message.options.details\">\n      <div class=\"mt-4\">\n        <pre class=\"details\">{{ message.options.details }}</pre>\n      </div>\n    </v-expansion-panel-text>\n  </v-expansion-panel>\n</template>\n\n<style scoped>\n.error-message {\n  background-color: #ef5350;\n}\n\n.warn-message {\n  background-color: #ffa726;\n}\n\n.info-message {\n  background-color: #26c6da;\n}\n\n.header {\n  width: 100%;\n  display: flex;\n  flex-flow: row;\n  justify-content: space-between;\n  align-items: center;\n}\n\n.details {\n  white-space: break-spaces;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent, ref } from 'vue';\nimport { storeToRefs } from 'pinia';\nimport { MessageType, useMessageStore } from '../store/messages';\nimport MessageItem from './MessageItem.vue';\n\nexport default defineComponent({\n  components: {\n    MessageItem,\n  },\n  setup() {\n    const messageStore = useMessageStore();\n    const { messages } = storeToRefs(messageStore);\n\n    const showErrors = ref(true);\n    const showWarnings = ref(true);\n    const showInfo = ref(true);\n\n    const filteredMessages = computed(() => {\n      const show = {\n        errors: showErrors.value,\n        warnings: showWarnings.value,\n        info: showInfo.value,\n      };\n      return messages.value.filter(\n        (msg) =>\n          (msg.type === MessageType.Error && show.errors) ||\n          (msg.type === MessageType.Warning && show.warnings) ||\n          (msg.type === MessageType.Info && show.info)\n      );\n    });\n\n    function deleteItem(messageID: string) {\n      messageStore.clearOne(messageID);\n    }\n\n    return {\n      deleteItem,\n      clearAll: () => {\n        messageStore.clearAll();\n      },\n      showErrors,\n      showWarnings,\n      showInfo,\n      filteredMessages,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-card class=\"fill-height message-center\">\n    <v-card-title class=\"d-flex flex-row align-center\">\n      <span>Notifications</span>\n      <v-spacer />\n      <v-btn variant=\"text\" icon=\"mdi-close\" @click=\"$emit('close')\"></v-btn>\n    </v-card-title>\n    <v-card-text class=\"content-container pt-4\">\n      <div class=\"action-bar ma-2\">\n        <div class=\"filter-bar\">\n          <v-checkbox\n            v-model=\"showErrors\"\n            class=\"px-2\"\n            hide-details\n            label=\"Error\"\n          />\n          <v-checkbox\n            v-model=\"showWarnings\"\n            class=\"px-2\"\n            hide-details\n            label=\"Warning\"\n          />\n          <v-checkbox\n            v-model=\"showInfo\"\n            class=\"px-2\"\n            hide-details\n            label=\"Info\"\n          />\n        </div>\n        <v-btn color=\"secondary\" @click=\"clearAll\">\n          <v-icon class=\"mr-2\">mdi-delete</v-icon>\n          <span>Clear All</span>\n        </v-btn>\n      </div>\n      <div class=\"message-list ma-2\">\n        <v-expansion-panels variant=\"accordion\" multiple>\n          <message-item\n            v-for=\"msg in filteredMessages\"\n            :key=\"msg.id\"\n            :message=\"msg\"\n            @delete=\"deleteItem(msg.id)\"\n          />\n        </v-expansion-panels>\n        <template v-if=\"filteredMessages.length === 0\">\n          <div class=\"empty\">No notifications to display</div>\n        </template>\n      </div>\n    </v-card-text>\n  </v-card>\n</template>\n\n<style scoped>\n.message-center {\n  display: flex;\n  flex-flow: column;\n}\n\n.content-container {\n  display: flex;\n  flex-flow: column;\n  overflow: hidden;\n}\n\n.message-list {\n  overflow-y: auto;\n  scroll-behavior: smooth;\n}\n\n.action-bar {\n  display: flex;\n  flex-flow: row;\n  justify-content: space-between;\n  align-items: center;\n}\n\n.filter-bar {\n  display: flex;\n  flex-flow: row;\n  justify-content: space-between;\n}\n\n.empty {\n  text-align: center;\n  font-size: 1.4rem;\n  margin-top: 36px;\n  padding: 16px;\n}\n</style>\n","<script lang=\"ts\">\nimport { computed, defineComponent, ref } from 'vue';\nimport { storeToRefs } from 'pinia';\nimport { MessageType, useMessageStore } from '../store/messages';\nimport MessageItem from './MessageItem.vue';\n\nexport default defineComponent({\n  components: {\n    MessageItem,\n  },\n  setup() {\n    const messageStore = useMessageStore();\n    const { messages } = storeToRefs(messageStore);\n\n    const showErrors = ref(true);\n    const showWarnings = ref(true);\n    const showInfo = ref(true);\n\n    const filteredMessages = computed(() => {\n      const show = {\n        errors: showErrors.value,\n        warnings: showWarnings.value,\n        info: showInfo.value,\n      };\n      return messages.value.filter(\n        (msg) =>\n          (msg.type === MessageType.Error && show.errors) ||\n          (msg.type === MessageType.Warning && show.warnings) ||\n          (msg.type === MessageType.Info && show.info)\n      );\n    });\n\n    function deleteItem(messageID: string) {\n      messageStore.clearOne(messageID);\n    }\n\n    return {\n      deleteItem,\n      clearAll: () => {\n        messageStore.clearAll();\n      },\n      showErrors,\n      showWarnings,\n      showInfo,\n      filteredMessages,\n    };\n  },\n});\n</script>\n\n<template>\n  <v-card class=\"fill-height message-center\">\n    <v-card-title class=\"d-flex flex-row align-center\">\n      <span>Notifications</span>\n      <v-spacer />\n      <v-btn variant=\"text\" icon=\"mdi-close\" @click=\"$emit('close')\"></v-btn>\n    </v-card-title>\n    <v-card-text class=\"content-container pt-4\">\n      <div class=\"action-bar ma-2\">\n        <div class=\"filter-bar\">\n          <v-checkbox\n            v-model=\"showErrors\"\n            class=\"px-2\"\n            hide-details\n            label=\"Error\"\n          />\n          <v-checkbox\n            v-model=\"showWarnings\"\n            class=\"px-2\"\n            hide-details\n            label=\"Warning\"\n          />\n          <v-checkbox\n            v-model=\"showInfo\"\n            class=\"px-2\"\n            hide-details\n            label=\"Info\"\n          />\n        </div>\n        <v-btn color=\"secondary\" @click=\"clearAll\">\n          <v-icon class=\"mr-2\">mdi-delete</v-icon>\n          <span>Clear All</span>\n        </v-btn>\n      </div>\n      <div class=\"message-list ma-2\">\n        <v-expansion-panels variant=\"accordion\" multiple>\n          <message-item\n            v-for=\"msg in filteredMessages\"\n            :key=\"msg.id\"\n            :message=\"msg\"\n            @delete=\"deleteItem(msg.id)\"\n          />\n        </v-expansion-panels>\n        <template v-if=\"filteredMessages.length === 0\">\n          <div class=\"empty\">No notifications to display</div>\n        </template>\n      </div>\n    </v-card-text>\n  </v-card>\n</template>\n\n<style scoped>\n.message-center {\n  display: flex;\n  flex-flow: column;\n}\n\n.content-container {\n  display: flex;\n  flex-flow: column;\n  overflow: hidden;\n}\n\n.message-list {\n  overflow-y: auto;\n  scroll-behavior: smooth;\n}\n\n.action-bar {\n  display: flex;\n  flex-flow: row;\n  justify-content: space-between;\n  align-items: center;\n}\n\n.filter-bar {\n  display: flex;\n  flex-flow: row;\n  justify-content: space-between;\n}\n\n.empty {\n  text-align: center;\n  font-size: 1.4rem;\n  margin-top: 36px;\n  padding: 16px;\n}\n</style>\n","import { createToastInterface } from 'vue-toastification';\n\nconst toast = createToastInterface({\n  position: 'bottom-left',\n  timeout: 3000,\n  hideProgressBar: true,\n  maxToasts: 3,\n  transition: 'Vue-Toastification__fade',\n});\n\nexport const useToast = () => toast;\n","<template>\n  <div>\n    <span>{{ message }}</span>\n    &nbsp;\n    <button v-if=\"detailsButton\" class=\"button\">details</button>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent } from 'vue';\n\nexport default defineComponent({\n  props: {\n    message: String,\n    detailsButton: Boolean,\n  },\n});\n</script>\n\n<style scoped>\n.button {\n  background: rgba(0, 0, 0, 0.2);\n  padding: 4px 8px;\n  border-radius: 3px;\n  text-transform: capitalize;\n}\n</style>\n","<template>\n  <div>\n    <span>{{ message }}</span>\n    &nbsp;\n    <button v-if=\"detailsButton\" class=\"button\">details</button>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent } from 'vue';\n\nexport default defineComponent({\n  props: {\n    message: String,\n    detailsButton: Boolean,\n  },\n});\n</script>\n\n<style scoped>\n.button {\n  background: rgba(0, 0, 0, 0.2);\n  padding: 4px 8px;\n  border-radius: 3px;\n  text-transform: capitalize;\n}\n</style>\n","<script lang=\"ts\">\nimport { defineComponent, watch } from 'vue';\nimport { useToast } from '@/src/composables/useToast';\nimport { storeToRefs } from 'pinia';\nimport type { ToastID } from 'vue-toastification/dist/types/types';\nimport { Message, MessageType, useMessageStore } from '../store/messages';\nimport MessageNotificationContent from './MessageNotificationContent.vue';\n\nconst TIMEOUT = 5000;\n\nexport default defineComponent({\n  setup(props, { emit }) {\n    const messageStore = useMessageStore();\n    const { byID } = storeToRefs(messageStore);\n\n    const toasts = {} as Record<string, ToastID>;\n\n    const toast = useToast();\n    type ToastMethod =\n      | typeof toast.info\n      | typeof toast.success\n      | typeof toast.warning\n      | typeof toast.error;\n\n    const makeToastOptions = (msgID: string) => ({\n      timeout: byID.value[msgID].options.persist ? (false as const) : TIMEOUT,\n      closeOnClick: !byID.value[msgID].options.persist,\n      onClick: () => emit('open-notifications'),\n      onClose: () => {\n        delete toasts[msgID];\n      },\n    });\n\n    // remove toasts if the message is gone\n    watch(byID, (msgLookup) => {\n      Object.keys(toasts).forEach((msgID) => {\n        if (!(msgID in msgLookup)) {\n          toast.dismiss(toasts[msgID]);\n          delete toasts[msgID];\n        }\n      });\n    });\n\n    messageStore.$onAction(({ name, args, after }) => {\n      if (name === '_addMessage') {\n        const message = args[0] as Omit<Message, 'id'>;\n        after((msgID) => {\n          if (!msgID) {\n            return;\n          }\n\n          let toastMethod: ToastMethod = toast.info;\n          let showDetailsButton = false;\n\n          if (message.type === MessageType.Error) {\n            toastMethod = toast.error;\n            showDetailsButton = true;\n          } else if (message.type === MessageType.Warning) {\n            toastMethod = toast.warning;\n            showDetailsButton = true;\n          } else if (message.type === MessageType.Info) {\n            toastMethod = toast.info;\n          } else if (message.type === MessageType.Success) {\n            toastMethod = toast.success;\n          }\n\n          toasts[msgID] = toastMethod(\n            {\n              component: MessageNotificationContent,\n              props: {\n                message: message.title,\n                detailsButton: showDetailsButton,\n              },\n            },\n            makeToastOptions(msgID)\n          );\n        });\n      }\n    });\n\n    return () => null;\n  },\n});\n</script>\n","<script lang=\"ts\">\nimport { defineComponent, onMounted, onUnmounted, ref } from 'vue';\nimport { useDicomWebStore } from '../../store/dicom-web/dicom-web-store';\n\nexport default defineComponent({\n  setup() {\n    const dicomWeb = useDicomWebStore();\n\n    // If host changed while mounted, fetch metadata\n    const hostAtStart = ref<typeof dicomWeb.host>();\n    onMounted(() => {\n      hostAtStart.value = dicomWeb.host;\n    });\n    onUnmounted(() => {\n      // Re-fetch if address changed or an error message exists\n      if (hostAtStart.value !== dicomWeb.host || dicomWeb.message)\n        dicomWeb.fetchInitialDicoms();\n    });\n\n    return {\n      dicomWeb,\n    };\n  },\n});\n</script>\n\n<template>\n  <div>\n    <h3 class=\"mb-4\">DICOMWeb</h3>\n    <v-text-field\n      v-model=\"dicomWeb.hostName\"\n      class=\"server-param\"\n      label=\"Host Display Name\"\n      clearable\n    />\n    <v-text-field\n      v-model=\"dicomWeb.host\"\n      class=\"server-param\"\n      label=\"Host Address\"\n      clearable\n    />\n  </div>\n</template>\n","<script lang=\"ts\">\nimport { defineComponent, onMounted, onUnmounted, ref } from 'vue';\nimport { useDicomWebStore } from '../../store/dicom-web/dicom-web-store';\n\nexport default defineComponent({\n  setup() {\n    const dicomWeb = useDicomWebStore();\n\n    // If host changed while mounted, fetch metadata\n    const hostAtStart = ref<typeof dicomWeb.host>();\n    onMounted(() => {\n      hostAtStart.value = dicomWeb.host;\n    });\n    onUnmounted(() => {\n      // Re-fetch if address changed or an error message exists\n      if (hostAtStart.value !== dicomWeb.host || dicomWeb.message)\n        dicomWeb.fetchInitialDicoms();\n    });\n\n    return {\n      dicomWeb,\n    };\n  },\n});\n</script>\n\n<template>\n  <div>\n    <h3 class=\"mb-4\">DICOMWeb</h3>\n    <v-text-field\n      v-model=\"dicomWeb.hostName\"\n      class=\"server-param\"\n      label=\"Host Display Name\"\n      clearable\n    />\n    <v-text-field\n      v-model=\"dicomWeb.host\"\n      class=\"server-param\"\n      label=\"Host Address\"\n      clearable\n    />\n  </div>\n</template>\n","import * as Sentry from '@sentry/vue';\nimport { useLocalStorage } from '@vueuse/core';\nimport { defineStore } from 'pinia';\nimport { App, ref, watch } from 'vue';\n\nconst { VITE_SENTRY_DSN } = import.meta.env;\n\nexport const LOCAL_STORAGE_KEY = 'error-reporting-off';\n\nexport const errorReportingConfigured = !!VITE_SENTRY_DSN;\n\nexport const init = (app: App<Element>) => {\n  const sentryOff = localStorage.getItem(LOCAL_STORAGE_KEY);\n  if (sentryOff !== 'true' && errorReportingConfigured)\n    Sentry.init({\n      app,\n      dsn: VITE_SENTRY_DSN,\n      integrations: [new Sentry.Replay()],\n      // Performance Monitoring\n      tracesSampleRate: 0.1, // Capture 10% of the transactions\n      // Session Replay\n      replaysSessionSampleRate: 0.1, // This sets the sample rate at 10%. You may want to change it to 100% while in development and then sample at a lower rate in production.\n      replaysOnErrorSampleRate: 1.0, // If you're not already sampling the entire session, change the sample rate to 100% when sampling sessions where errors occur.\n    });\n};\n\nconst disable = () => {\n  Sentry.close(200);\n};\n\nexport const useErrorReporting = defineStore('error-reporting', () => {\n  const disableReportingStorage = useLocalStorage(LOCAL_STORAGE_KEY, 'false');\n\n  const disableReporting = ref(disableReportingStorage.value === 'true');\n\n  // sync boolean to local storage\n  watch(disableReporting, () => {\n    disableReportingStorage.value = String(disableReporting.value);\n    if (disableReporting.value) disable();\n  });\n\n  return { disableReporting };\n});\n","<template>\n  <v-card>\n    <v-card-title class=\"d-flex flex-row align-center\">\n      Settings\n      <v-spacer />\n      <v-btn\n        variant=\"text\"\n        density=\"compact\"\n        icon=\"mdi-close\"\n        @click=\"$emit('close')\"\n      />\n    </v-card-title>\n    <v-card-text>\n      <v-switch label=\"Dark Theme\" v-model=\"dark\"></v-switch>\n\n      <v-switch\n        v-if=\"errorReportingConfigured\"\n        label=\"Disable Error Reporting\"\n        v-model=\"disableReporting\"\n      ></v-switch>\n\n      <v-divider class=\"mt-2 mb-6\"></v-divider>\n      <dicom-web-settings />\n    </v-card-text>\n  </v-card>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent, ref, watch } from 'vue';\nimport { useTheme } from 'vuetify';\nimport { useLocalStorage } from '@vueuse/core';\n\nimport DicomWebSettings from './dicom-web/DicomWebSettings.vue';\nimport { DarkTheme, LightTheme, ThemeStorageKey } from '../constants';\nimport {\n  useErrorReporting,\n  errorReportingConfigured,\n} from '../utils/errorReporting';\n\nexport default defineComponent({\n  setup() {\n    const theme = useTheme();\n    const store = useLocalStorage(ThemeStorageKey, theme.global.name.value);\n    const dark = ref(theme.global.name.value === DarkTheme);\n\n    watch(dark, (isDark) => {\n      theme.global.name.value = isDark ? DarkTheme : LightTheme;\n      store.value = theme.global.name.value;\n    });\n\n    const errorReportingStore = useErrorReporting();\n    const disableReporting = ref(errorReportingStore.disableReporting);\n    watch(disableReporting, (disable) => {\n      errorReportingStore.disableReporting = disable;\n    });\n\n    return {\n      dark,\n      disableReporting,\n      errorReportingConfigured,\n    };\n  },\n  components: {\n    DicomWebSettings,\n  },\n});\n</script>\n","<template>\n  <v-card>\n    <v-card-title class=\"d-flex flex-row align-center\">\n      Settings\n      <v-spacer />\n      <v-btn\n        variant=\"text\"\n        density=\"compact\"\n        icon=\"mdi-close\"\n        @click=\"$emit('close')\"\n      />\n    </v-card-title>\n    <v-card-text>\n      <v-switch label=\"Dark Theme\" v-model=\"dark\"></v-switch>\n\n      <v-switch\n        v-if=\"errorReportingConfigured\"\n        label=\"Disable Error Reporting\"\n        v-model=\"disableReporting\"\n      ></v-switch>\n\n      <v-divider class=\"mt-2 mb-6\"></v-divider>\n      <dicom-web-settings />\n    </v-card-text>\n  </v-card>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent, ref, watch } from 'vue';\nimport { useTheme } from 'vuetify';\nimport { useLocalStorage } from '@vueuse/core';\n\nimport DicomWebSettings from './dicom-web/DicomWebSettings.vue';\nimport { DarkTheme, LightTheme, ThemeStorageKey } from '../constants';\nimport {\n  useErrorReporting,\n  errorReportingConfigured,\n} from '../utils/errorReporting';\n\nexport default defineComponent({\n  setup() {\n    const theme = useTheme();\n    const store = useLocalStorage(ThemeStorageKey, theme.global.name.value);\n    const dark = ref(theme.global.name.value === DarkTheme);\n\n    watch(dark, (isDark) => {\n      theme.global.name.value = isDark ? DarkTheme : LightTheme;\n      store.value = theme.global.name.value;\n    });\n\n    const errorReportingStore = useErrorReporting();\n    const disableReporting = ref(errorReportingStore.disableReporting);\n    watch(disableReporting, (disable) => {\n      errorReportingStore.disableReporting = disable;\n    });\n\n    return {\n      dark,\n      disableReporting,\n      errorReportingConfigured,\n    };\n  },\n  components: {\n    DicomWebSettings,\n  },\n});\n</script>\n","<template svg>\n  <svg\n    width=\"178\"\n    height=\"41\"\n    viewBox=\"0 0 178 41\"\n    fill=\"none\"\n    xmlns=\"http://www.w3.org/2000/svg\"\n  >\n    <g clip-path=\"url(#clip0_137_151)\">\n      <path\n        d=\"M33.2403 22.3722C33.189 22.4501 33.1376 22.554 33.0606 22.632C31.7509 24.3989 29.0545 25.1265 25.6905 24.6588C25.5364 24.6328 25.3823 24.6068 25.2282 24.5808C23.1995 24.243 20.9911 23.4895 18.7826 22.3722C17.4729 21.6966 16.1633 20.8651 14.905 19.9037C13.5439 18.8643 12.3113 17.747 11.2584 16.5517C9.58926 14.7068 8.35663 12.758 7.56056 10.8871C6.25089 7.79499 6.25089 5.04066 7.53488 3.24774C8.84455 1.48082 11.4125 0.805225 14.6225 1.29893C16.2146 1.53278 17.9609 2.07845 19.7584 2.88396C21.5303 3.68948 23.3536 4.75483 25.1255 6.10601C28.6693 8.78239 31.34 12.0304 32.7781 15.0966C34.1648 18.0068 34.3445 20.6052 33.2403 22.3722Z\"\n        fill=\"#3EAE2B\"\n      />\n      <path\n        d=\"M33.2404 22.3721C33.189 22.4501 33.1377 22.554 33.0606 22.632C31.7509 24.3989 29.0546 25.1265 25.6905 24.6588C25.5364 24.6328 25.3824 24.6068 25.2283 24.5808C23.3537 24.191 21.1966 23.4895 18.7827 22.3721C17.473 21.6966 16.1633 20.8651 14.905 19.9036C13.544 18.8643 12.3114 17.7469 11.2585 16.5517C8.69052 12.2643 9.2298 6.9375 10.7706 5.24852C12.6452 3.16978 16.9337 2.70206 23.6361 7.24931C29.5425 11.2509 33.7796 19.0202 33.2404 22.3721Z\"\n        fill=\"black\"\n        fill-opacity=\"0.15\"\n      />\n      <path\n        d=\"M30.1331 18.0068C30.1331 18.5005 30.0304 18.9422 29.8506 19.332C29.7993 19.4619 29.7222 19.5918 29.6195 19.7217C29.2086 20.2934 28.541 20.6572 27.6422 20.8391C26.7434 21.021 25.6648 20.969 24.4579 20.7351C22.044 20.2674 19.2706 18.9942 16.831 17.1753C16.8053 17.1493 16.7539 17.1233 16.7283 17.0973C14.3657 15.2784 12.5681 13.0698 11.5666 11.017C10.5394 8.91229 10.4624 7.06741 11.3098 5.9241C12.1316 4.78079 13.9035 4.443 16.189 4.91071C18.4745 5.37843 21.1195 6.65166 23.5334 8.49654C25.9473 10.3414 27.9503 12.5761 29.1059 14.6808C29.7993 15.9021 30.1331 17.0454 30.1331 18.0068Z\"\n        fill=\"#3EAE2B\"\n      />\n      <path\n        d=\"M29.8506 19.3321C29.7992 19.462 29.7222 19.5919 29.6195 19.7218C29.2086 20.2935 28.5409 20.6573 27.6421 20.8391C26.7433 21.021 25.6648 20.9691 24.4578 20.7352C22.0439 20.2675 19.2705 18.9943 16.831 17.1754C16.8053 17.1494 16.7539 17.1234 16.7282 17.0974C13.8778 14.2132 13.7494 9.61394 14.905 8.31473C16.2146 7.14544 18.5258 7.17142 22.763 10.0297C26.3068 12.4462 29.5681 16.9415 29.8506 19.3321Z\"\n        fill=\"black\"\n        fill-opacity=\"0.15\"\n      />\n      <path\n        d=\"M26.3068 17.2533C26.1271 17.4871 25.8189 17.6431 25.3567 17.721C24.8944 17.773 24.3038 17.747 23.6105 17.5651C22.2494 17.2273 20.6059 16.4478 19.0651 15.2785C17.5243 14.1092 16.3431 12.784 15.6754 11.5627C15.3416 10.9651 15.1618 10.4194 15.0848 9.95171C15.0334 9.484 15.1105 9.17219 15.2902 8.93833C15.47 8.70447 15.7524 8.52258 16.2147 8.47061C16.6512 8.41864 17.2162 8.44463 17.8839 8.60053C18.5259 8.75644 19.2706 9.04227 20.0153 9.43203C20.76 9.82179 21.5561 10.3155 22.3008 10.9131C23.8416 12.0824 25.0742 13.4076 25.7932 14.6029C26.1528 15.2005 26.3582 15.7462 26.4352 16.2139C26.5379 16.7076 26.4609 17.0454 26.3068 17.2533Z\"\n        fill=\"#3EAE2B\"\n      />\n      <path\n        d=\"M27.0001 17.565C26.769 18.1627 26.5379 18.6044 26.1527 19.1501C23.8415 22.2682 19.0137 22.7099 15.624 20.1375C12.2343 17.565 11.3612 12.758 13.6467 9.63984C14.1089 9.06819 14.4427 8.67843 14.982 8.23669C14.8793 8.31465 14.8022 8.3926 14.7252 8.49654C14.3914 8.93827 14.3143 9.48394 14.3914 10.0556C14.4684 10.6272 14.6995 11.2769 15.059 11.9265C15.7781 13.2257 17.0364 14.6548 18.6542 15.8761C20.272 17.0973 21.9926 17.9288 23.482 18.2666C24.2267 18.4485 24.9201 18.5005 25.485 18.4225C26.0757 18.3446 26.5893 18.1107 26.9231 17.669C26.9488 17.669 26.9745 17.617 27.0001 17.565Z\"\n        fill=\"#0068C7\"\n      />\n      <path\n        d=\"M30.5696 19.7737C30.2615 20.7092 29.1316 22.4241 28.4382 23.2036C24.7917 28.1147 17.1391 28.9722 11.6436 24.8147C6.17386 20.7351 5.17235 12.4462 8.81888 7.50916C9.38383 6.75562 10.334 5.56034 11.1557 4.85876C10.976 5.01467 10.7962 5.19656 10.6421 5.40443C9.51223 6.93751 9.76903 9.17215 10.8219 11.3808C11.9004 13.6155 13.8264 15.954 16.3174 17.8509C17.5757 18.8123 18.911 19.6178 20.272 20.2414C21.6331 20.8651 22.9941 21.3328 24.2524 21.5666C25.5364 21.8265 26.7177 21.8784 27.7449 21.6706C28.7721 21.4627 29.6452 21.021 30.2358 20.2414C30.3899 20.0855 30.4926 19.9296 30.5696 19.7737Z\"\n        fill=\"#0068C7\"\n      />\n      <path\n        d=\"M34.2675 22.1643C33.7025 23.6974 32.6497 25.5942 31.1859 27.3092C25.2796 34.1171 15.059 35.3903 7.71463 29.8037C0.395901 24.2691 -1.32464 14.1092 3.47747 6.39189C4.55602 4.65094 6.63608 2.59819 7.86871 1.71472C7.84303 1.74071 7.14968 2.39031 6.8672 2.78008C5.30074 4.91078 5.42913 8.05488 6.79016 11.225C8.15119 14.447 10.7705 17.825 14.3914 20.5793C16.2146 21.9565 18.1149 23.0478 20.0152 23.8793C21.9155 24.7108 23.8158 25.2305 25.5621 25.4903C29.0545 25.958 32.1361 25.2824 33.7026 23.1517C33.9337 22.8399 34.1391 22.5021 34.2675 22.1643Z\"\n        fill=\"#0068C7\"\n      />\n      <path\n        d=\"M33.5228 14.7329C32.0077 11.5368 29.2343 8.18483 25.6135 5.4305C22.0183 2.67616 18.115 0.987188 14.7509 0.467503C13.544 0.285613 12.3627 0.259629 11.3098 0.38955C11.2585 0.38955 11.2071 0.38955 11.1814 0.415535C11.0274 0.441519 10.8476 0.467503 10.6935 0.493487C10.6679 0.493487 10.6422 0.493487 10.5908 0.519472C10.4881 0.545456 10.3854 0.57144 10.3083 0.597424C10.2056 0.623409 10.1286 0.649393 10.0515 0.675377C9.9745 0.701361 9.89746 0.727346 9.82042 0.75333C9.07571 0.987188 8.40803 1.35097 7.8174 1.81868C7.45788 2.07853 7.14973 2.39034 6.86725 2.7801C5.30078 4.91081 5.42918 8.0549 6.79021 11.225C8.15124 14.447 10.7706 17.825 14.3914 20.5793C16.2147 21.9565 18.115 23.0478 20.0153 23.8793C21.9156 24.7108 23.8159 25.2305 25.5621 25.4903C29.0546 25.9581 32.1361 25.2825 33.7026 23.1518C33.9337 22.8659 34.1135 22.5281 34.2675 22.1903C35.2177 20.1116 34.8068 17.4352 33.5228 14.7329ZM33.2404 22.3722C33.189 22.4502 33.1376 22.5541 33.0606 22.6321C31.7509 24.399 29.0546 25.1266 25.6905 24.6588C25.5364 24.6329 25.3824 24.6069 25.2283 24.5809C23.1996 24.2431 20.9911 23.4895 18.7827 22.3722C17.473 21.6966 16.1633 20.8651 14.905 19.9037C13.544 18.8644 12.3114 17.747 11.2585 16.5518C9.5893 14.7069 8.35667 12.7581 7.5606 10.8872C6.25093 7.79506 6.25093 5.04073 7.53492 3.24782C8.84459 1.48089 11.4126 0.805298 14.6225 1.299C16.2147 1.53286 17.9609 2.07853 19.7585 2.88404C21.5304 3.68955 23.3537 4.7549 25.1256 6.10609C28.6694 8.78246 31.3401 12.0305 32.7781 15.0966C34.1648 18.0069 34.3446 20.6053 33.2404 22.3722Z\"\n        fill=\"white\"\n      />\n      <path\n        d=\"M29.8506 14.2651C28.6436 12.0564 26.5636 9.71781 24.0726 7.82096C21.5817 5.92411 18.834 4.59891 16.3944 4.10521C14.5711 3.71545 12.8506 3.7934 11.618 4.54694C11.5923 4.54694 11.5666 4.57293 11.5666 4.57293C11.5666 4.57293 11.5409 4.57293 11.5409 4.59891C11.4896 4.6249 11.4382 4.65088 11.4125 4.70285C11.3355 4.75482 11.2584 4.83277 11.1814 4.88474C11.0016 5.04065 10.8219 5.22254 10.6678 5.43041C9.5379 6.96348 9.79469 9.19813 10.8476 11.4068C11.9261 13.6414 13.8521 15.98 16.343 17.8769C17.6013 18.8383 18.9367 19.6438 20.2977 20.2674C21.6587 20.891 23.0198 21.3588 24.2781 21.5926C25.5621 21.8525 26.7433 21.9044 27.7705 21.6966C28.7977 21.4887 29.6708 21.0469 30.2615 20.2674C30.3642 20.1375 30.4669 19.9816 30.5439 19.8257C31.3657 18.2666 30.9291 16.2399 29.8506 14.2651ZM29.6195 19.7217C29.2086 20.2934 28.5409 20.6572 27.6421 20.8391C26.7433 21.021 25.6648 20.969 24.4578 20.7351C22.0439 20.2674 19.2705 18.9942 16.8309 17.1753C14.4171 15.3564 12.5681 13.0958 11.5666 11.017C10.5394 8.9123 10.4624 7.06742 11.3098 5.92411C12.1316 4.7808 13.9035 4.44301 16.189 4.91072C18.4745 5.37844 21.1195 6.65167 23.5334 8.49655C25.9473 10.3414 27.9503 12.5761 29.1059 14.6808C29.7992 15.928 30.1331 17.0714 30.1331 18.0328C30.1331 18.6824 29.979 19.254 29.6195 19.7217Z\"\n        fill=\"white\"\n      />\n      <path\n        fill-rule=\"evenodd\"\n        clip-rule=\"evenodd\"\n        d=\"M27.2056 16.1099C27.1029 15.5382 26.8461 14.8886 26.4609 14.239C25.6905 12.9398 24.4065 11.5367 22.7887 10.3154C21.1965 9.09415 19.5274 8.23667 18.0893 7.89887C17.3703 7.71698 16.7026 7.66501 16.1376 7.74296C15.7011 7.79493 15.2902 7.97682 14.982 8.23667C14.8793 8.31462 14.8023 8.39257 14.7252 8.49651C14.3914 8.93824 14.3144 9.48391 14.3914 10.0556C14.4684 10.6272 14.6996 11.2768 15.0591 11.9264C15.7781 13.2256 17.0364 14.6548 18.6542 15.876C20.2721 17.0973 21.9926 17.9288 23.482 18.2666C24.2268 18.4485 24.9201 18.5004 25.4851 18.4225C26.0757 18.3445 26.5893 18.1107 26.9231 17.6689C26.9488 17.617 26.9745 17.591 27.0002 17.539C27.2313 17.1493 27.2826 16.6296 27.2056 16.1099ZM26.3068 17.2532C26.1271 17.4871 25.8189 17.643 25.3567 17.7209C24.8944 17.7729 24.3038 17.7469 23.6104 17.565C22.2494 17.2272 20.6059 16.4477 19.0651 15.2784C17.5243 14.1091 16.3431 12.7839 15.6754 11.5626C15.3416 10.965 15.1618 10.4193 15.0848 9.95163C15.0334 9.48391 15.1104 9.1721 15.2902 8.93824C15.47 8.70438 15.7524 8.52249 16.2147 8.47052C16.6512 8.41855 17.2162 8.44454 17.8839 8.60044C18.5259 8.75635 19.2706 9.04218 20.0153 9.43194C20.76 9.8217 21.5561 10.3154 22.3008 10.913C23.8416 12.0823 25.0742 13.4075 25.7932 14.6028C26.1527 15.2004 26.3582 15.7461 26.4352 16.2138C26.5379 16.7075 26.4609 17.0453 26.3068 17.2532Z\"\n        fill=\"white\"\n      />\n    </g>\n    <path\n      d=\"M61.9829 5.52224H58.8629L50.9429 26.9222L43.0629 5.52224H39.9429L49.3829 30.8022H52.5429L61.9829 5.52224ZM76.9417 21.1622C76.9417 25.5622 75.8217 28.3622 71.3817 28.3622C66.9417 28.3622 65.7817 25.5622 65.7817 21.1622C65.7817 16.7622 66.9417 13.9622 71.3817 13.9622C75.8217 13.9622 76.9417 16.7622 76.9417 21.1622ZM71.3817 31.1222C77.4617 31.1222 79.8617 27.0422 79.8617 21.1622C79.8617 15.1622 77.5817 11.2022 71.3817 11.2022C65.2617 11.2022 62.8617 15.2822 62.8617 21.1622C62.8617 27.1622 65.1417 31.1222 71.3817 31.1222ZM84.4373 25.4422C84.4373 29.6022 86.5173 31.0422 89.2773 31.0422C90.3173 31.0422 91.1173 30.8822 91.6373 30.6422L91.2373 28.0022C90.7973 28.2022 90.1973 28.2822 89.5173 28.2822C88.1573 28.2822 87.3573 27.6422 87.3573 25.0022V3.52224H84.4373V25.4422Z\"\n      fill=\"#3EAE2B\"\n    />\n    <path\n      d=\"M114.952 5.52224H111.832L103.912 26.9222L96.0317 5.52224H92.9117L102.352 30.8022H105.512L114.952 5.52224ZM118.196 30.8022H121.116V11.5222H118.196V30.8022ZM117.756 4.92225C117.756 5.96224 118.596 6.80225 119.676 6.80225C120.716 6.80225 121.556 5.96224 121.556 4.92225C121.556 3.88224 120.716 3.00224 119.676 3.00224C118.596 3.00224 117.756 3.84225 117.756 4.92225ZM142.306 19.6422C142.306 14.0422 139.306 11.2022 134.226 11.2022C127.906 11.2022 125.866 15.6422 125.866 21.2022C125.866 28.0422 128.986 31.1222 135.146 31.1222C137.506 31.1222 139.786 30.6422 141.666 29.8022L141.226 27.0422C139.786 27.8022 137.426 28.3622 135.186 28.3622C131.186 28.3622 128.826 26.5622 128.826 22.4822V22.3222H141.986C142.226 21.4822 142.306 20.4422 142.306 19.6422ZM128.826 19.6022C128.826 15.4422 130.906 13.8022 134.146 13.8022C137.426 13.8022 139.506 15.4822 139.506 19.6022V19.8422H128.826V19.6022ZM148.339 11.5222H145.339L152.059 30.8022H155.059L160.299 16.0422L165.539 30.8022H168.539L175.259 11.5222H172.259L167.019 26.8422L161.779 11.5222H158.819L153.579 26.8422L148.339 11.5222Z\"\n      fill=\"#0068C7\"\n    />\n    <defs>\n      <clipPath id=\"clip0_137_151\">\n        <rect\n          width=\"34\"\n          height=\"33\"\n          fill=\"white\"\n          transform=\"translate(0.781128 0.311523)\"\n        />\n      </clipPath>\n    </defs>\n  </svg>\n</template>\n","<template>\n  <v-card>\n    <v-card-title class=\"d-flex flex-row align-center\">\n      Saving Session State\n      <v-spacer />\n      <v-btn variant=\"text\" icon=\"mdi-close\" @click=\"$emit('close')\" />\n    </v-card-title>\n    <v-card-text>\n      <v-form v-model=\"valid\" @submit.prevent=\"saveSession\">\n        <v-text-field\n          v-model=\"fileName\"\n          hint=\"The filename to use for the session state file.\"\n          label=\"Session State Filename\"\n          :rules=\"[validFileName]\"\n          required\n        />\n      </v-form>\n    </v-card-text>\n    <v-card-actions>\n      <v-spacer />\n      <v-btn\n        :loading=\"saving\"\n        color=\"secondary\"\n        @click=\"saveSession\"\n        :disabled=\"!valid\"\n      >\n        <v-icon class=\"mr-2\">mdi-content-save-all</v-icon>\n        <span>Save</span>\n      </v-btn>\n    </v-card-actions>\n  </v-card>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent, onMounted, ref } from 'vue';\nimport { saveAs } from 'file-saver';\n\nimport { serialize } from '../io/state-file';\n\nconst DEFAULT_FILENAME = 'session.volview.zip';\n\nexport default defineComponent({\n  setup(_, { emit }) {\n    const fileName = ref('');\n    const valid = ref(true);\n    const saving = ref(false);\n\n    async function saveSession() {\n      if (fileName.value.trim().length >= 0) {\n        saving.value = true;\n        try {\n          const blob = await serialize();\n          saveAs(blob, fileName.value);\n          emit('close');\n        } finally {\n          saving.value = false;\n        }\n      }\n    }\n\n    onMounted(() => {\n      fileName.value = DEFAULT_FILENAME;\n    });\n\n    function validFileName(name: string) {\n      return name.trim().length > 0 || 'Required';\n    }\n\n    return {\n      saving,\n      saveSession,\n      fileName,\n      validFileName,\n      valid,\n    };\n  },\n});\n</script>\n","<template>\n  <v-card>\n    <v-card-title class=\"d-flex flex-row align-center\">\n      Saving Session State\n      <v-spacer />\n      <v-btn variant=\"text\" icon=\"mdi-close\" @click=\"$emit('close')\" />\n    </v-card-title>\n    <v-card-text>\n      <v-form v-model=\"valid\" @submit.prevent=\"saveSession\">\n        <v-text-field\n          v-model=\"fileName\"\n          hint=\"The filename to use for the session state file.\"\n          label=\"Session State Filename\"\n          :rules=\"[validFileName]\"\n          required\n        />\n      </v-form>\n    </v-card-text>\n    <v-card-actions>\n      <v-spacer />\n      <v-btn\n        :loading=\"saving\"\n        color=\"secondary\"\n        @click=\"saveSession\"\n        :disabled=\"!valid\"\n      >\n        <v-icon class=\"mr-2\">mdi-content-save-all</v-icon>\n        <span>Save</span>\n      </v-btn>\n    </v-card-actions>\n  </v-card>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent, onMounted, ref } from 'vue';\nimport { saveAs } from 'file-saver';\n\nimport { serialize } from '../io/state-file';\n\nconst DEFAULT_FILENAME = 'session.volview.zip';\n\nexport default defineComponent({\n  setup(_, { emit }) {\n    const fileName = ref('');\n    const valid = ref(true);\n    const saving = ref(false);\n\n    async function saveSession() {\n      if (fileName.value.trim().length >= 0) {\n        saving.value = true;\n        try {\n          const blob = await serialize();\n          saveAs(blob, fileName.value);\n          emit('close');\n        } finally {\n          saving.value = false;\n        }\n      }\n    }\n\n    onMounted(() => {\n      fileName.value = DEFAULT_FILENAME;\n    });\n\n    function validFileName(name: string) {\n      return name.trim().length > 0 || 'Required';\n    }\n\n    return {\n      saving,\n      saveSession,\n      fileName,\n      validFileName,\n      valid,\n    };\n  },\n});\n</script>\n","import { onBeforeUnmount, onMounted } from 'vue';\nimport { useMessageStore } from '../store/messages';\n\nexport function useGlobalErrorHook() {\n  const messageStore = useMessageStore();\n\n  const onError = (event: ErrorEvent) => {\n    messageStore.addError('Application error (click for details)', event.error);\n  };\n\n  onMounted(() => {\n    window.addEventListener('error', onError);\n  });\n\n  onBeforeUnmount(() => {\n    window.removeEventListener('error', onError);\n  });\n}\n","import type { vtkSubscription } from '@kitware/vtk.js/interfaces';\nimport { VtkProxy } from '@kitware/vtk.js/macros';\nimport { onBeforeUnmount } from 'vue';\nimport { withProxyManager } from './proxyManager';\n\nexport enum ProxyManagerEvent {\n  ProxyCreated,\n  ProxyModified,\n  ProxyDeleted,\n  ProxyRegistrationChange,\n}\n\nexport function onProxyManagerEvent(\n  event: ProxyManagerEvent,\n  cb: (proxyID: string, obj: VtkProxy | null) => void\n) {\n  const subs: vtkSubscription[] = [];\n\n  withProxyManager((proxyManager) => {\n    const proxySubs = Object.create(null);\n\n    subs.push(\n      proxyManager.onProxyRegistrationChange((info) => {\n        const { action, proxyId, proxy } = info;\n        if (action === 'register') {\n          if (event === ProxyManagerEvent.ProxyCreated) {\n            cb(proxyId, proxy);\n          }\n          if (event === ProxyManagerEvent.ProxyModified) {\n            proxySubs[proxyId] = proxy.onModified(() => cb(proxyId, proxy));\n          }\n        } else if (action === 'unregister') {\n          if (proxyId in proxySubs) {\n            proxySubs[proxyId].unsubscribe();\n            delete proxySubs[proxyId];\n          }\n          if (event === ProxyManagerEvent.ProxyDeleted) {\n            cb(proxyId, null);\n          }\n        }\n      })\n    );\n  });\n\n  onBeforeUnmount(() => {\n    while (subs.length) {\n      subs.pop()!.unsubscribe();\n    }\n  });\n}\n","import vtkViewProxy from '@kitware/vtk.js/Proxy/Core/ViewProxy';\nimport { useEventListener, useThrottleFn } from '@vueuse/core';\nimport { Messages } from '../constants';\nimport { useMessageStore } from '../store/messages';\nimport { onProxyManagerEvent, ProxyManagerEvent } from './onProxyManagerEvent';\n\nexport function useWebGLWatchdog() {\n  const watchdogs = new Map<string, () => void>();\n\n  const reportError = useThrottleFn(() => {\n    const messageStore = useMessageStore();\n    messageStore.addError(Messages.WebGLLost.title, Messages.WebGLLost.details);\n  }, 100);\n\n  onProxyManagerEvent(ProxyManagerEvent.ProxyCreated, (id, obj) => {\n    if (!obj || !obj.isA('vtkViewProxy')) return;\n    const view = obj as vtkViewProxy;\n    // TODO getCanvas() typing\n    const canvas = view\n      .getRenderWindow()\n      .getViews()[0]\n      .getCanvas() as HTMLCanvasElement;\n\n    const cleanup = useEventListener(canvas, 'webglcontextlost', reportError);\n    watchdogs.set(id, cleanup);\n  });\n\n  onProxyManagerEvent(ProxyManagerEvent.ProxyDeleted, (id) => {\n    if (watchdogs.has(id)) {\n      watchdogs.get(id)!();\n      watchdogs.delete(id);\n    }\n  });\n}\n","import { TYPE } from 'vue-toastification';\nimport { useToast } from '@/src/composables/useToast';\nimport { ToastID } from 'vue-toastification/dist/types/types';\nimport { useMessageStore } from '../store/messages';\n\nexport function useAppLoadingNotifications() {\n  const toast = useToast();\n  const messageStore = useMessageStore();\n\n  let loadingCount = 0;\n  let toastID: ToastID | null = null;\n  let error: Error | null = null;\n\n  const resetState = () => {\n    loadingCount = 0;\n    toastID = null;\n    error = null;\n  };\n\n  const _setError = (err: Error) => {\n    error = err;\n  };\n\n  const startLoading = () => {\n    loadingCount++;\n    if (toastID === null) {\n      toastID = toast.info('Loading datasets...', {\n        timeout: false,\n        closeButton: false,\n        closeOnClick: false,\n      });\n    }\n  };\n\n  const stopLoading = () => {\n    loadingCount--;\n    if (loadingCount === 0 && toastID !== null) {\n      if (error) {\n        toast.dismiss(toastID);\n        messageStore.addError('Some files failed to load', error);\n      } else {\n        toast.update(toastID, {\n          content: 'Datasets loaded!',\n          options: {\n            type: TYPE.SUCCESS,\n            timeout: 3000,\n            closeButton: 'button',\n            closeOnClick: true,\n          },\n        });\n      }\n      resetState();\n    }\n  };\n\n  /**\n   * Notifies of loading status until all function calls return.\n   * @param fn function to call\n   * @returns whatever fn returns.\n   */\n  const runAsLoading = async (fn: (setError: typeof _setError) => void) => {\n    startLoading();\n    try {\n      return await fn(_setError);\n    } finally {\n      stopLoading();\n    }\n  };\n\n  return {\n    runAsLoading,\n  };\n}\n","import { onKeyDown } from '@vueuse/core';\n\nimport { DECREMENT_LABEL_KEY, INCREMENT_LABEL_KEY } from '../config';\nimport { useToolStore } from '../store/tools';\nimport { Tools } from '../store/tools/types';\nimport { useRectangleStore } from '../store/tools/rectangles';\nimport { useRulerStore } from '../store/tools/rulers';\n\nconst applyLabelOffset = (offset: number) => {\n  const toolToStore = {\n    [Tools.Rectangle]: useRectangleStore(),\n    [Tools.Ruler]: useRulerStore(),\n  };\n  const toolStore = useToolStore();\n\n  // @ts-ignore - map may not have all keys of tools\n  const activeToolStore = toolToStore[toolStore.currentTool];\n  if (!activeToolStore) return;\n\n  const labels = Object.entries(activeToolStore.labels);\n  const activeLabelIndex = labels.findIndex(\n    ([name]) => name === activeToolStore.activeLabel\n  );\n\n  const [nextLabel] = labels.at((activeLabelIndex + offset) % labels.length)!;\n  activeToolStore.setActiveLabel(nextLabel);\n};\n\nexport function useKeyboardShortcuts() {\n  onKeyDown(DECREMENT_LABEL_KEY, () => applyLabelOffset(-1));\n  onKeyDown(INCREMENT_LABEL_KEY, () => applyLabelOffset(1));\n}\n","<template>\r\n  <div\r\n    style=\"\r\n      padding: 10px;\r\n      display: flex;\r\n      flex-direction: column;\r\n      align-items: center;\r\n      justify-content: center;\r\n    \"\r\n  >\r\n    <h2 style=\"margin-left: 2%\">DEMO PROTOTYOPE FROM VolView</h2>\r\n    <h4 style=\"margin-left: 2%\">Montreal, Aug, 2023</h4>\r\n  </div>\r\n  <div class=\"viewers-tools-container\">\r\n    <VtkTwoView\r\n      key=\"sagitalv\"\r\n      id=\"Sagittal\"\r\n      viewDirection=\"Posterior\"\r\n      viewUp=\"Superior\"\r\n    />\r\n\r\n    <div class=\"tool-strip\">\r\n      <ToolStrip />\r\n    </div>\r\n\r\n    <VtkTwoView\r\n      key=\"sagitalv\"\r\n      id=\"Coronal\"\r\n      viewDirection=\"Right\"\r\n      viewUp=\"Superior\"\r\n    />\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport ToolStrip from './ToolStrip.vue';\r\n\r\nimport VtkTwoView from './VtkTwoView.vue';\r\n\r\nexport default {\r\n  components: {\r\n    ToolStrip,\r\n    VtkTwoView,\r\n  },\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n.viewers-tools-container {\r\n  display: flex;\r\n  padding: 5px;\r\n  gap: 50px;\r\n  background: rgba(0, 0, 0, 0.1);\r\n  border-radius: 11px;\r\n  border: 1px solid #00ddff;\r\n}\r\n\r\n.tool-strip {\r\n  display: flex;\r\n  flex-direction: column;\r\n\r\n  gap: 20px;\r\n  padding-top: 70px;\r\n  padding-bottom: 70px;\r\n}\r\n</style>\r\n","<template>\n  <drag-and-drop enabled @drop-files=\"openFiles\" id=\"app-container\">\n    <template v-slot=\"{ dragHover }\">\n      <v-app>\n        <!-- <v-app-bar app clipped-left :height=\"48\">\n          <v-btn\n            v-if=\"mobile\"\n            icon=\"mdi-menu\"\n            @click=\"leftSideBar = !leftSideBar\"\n          />\n          <v-toolbar-title class=\"d-flex flex-row align-center mt-3\">\n            <vol-view-logo v-if=\"mobile\" />\n            <vol-view-full-logo v-else />\n          </v-toolbar-title>\n          <v-btn\n            variant=\"text\"\n            icon=\"mdi-help-circle-outline\"\n            :rounded=\"0\"\n            class=\"toolbar-button\"\n            @click=\"aboutBoxDialog = !aboutBoxDialog\"\n          />\n        </v-app-bar> -->\n        <v-navigation-drawer\n          v-model=\"leftSideBar\"\n          app\n          clipped\n          touchless\n          width=\"450\"\n          id=\"left-nav\"\n        >\n          <module-panel @close=\"leftSideBar = false\" />\n        </v-navigation-drawer>\n\n        <v-main id=\"content-main\">\n          <div class=\"fill-height d-flex flex-row flex-grow-1\">\n            <!-- <div\n              id=\"tools-strip\"\n              class=\"bg-grey-darken-4 d-flex flex-column align-center\"\n            >\n              <tool-button\n                size=\"40\"\n                icon=\"mdi-folder-open\"\n                name=\"Open files\"\n                @click=\"userPromptFiles\"\n              />\n              <tool-button\n                size=\"40\"\n                icon=\"mdi-content-save-all\"\n                name=\"Save session\"\n                :loading=\"saveHappening\"\n                @click=\"handleSave\"\n              />\n              <div class=\"my-1 tool-separator\" />\n              <v-menu location=\"right\" :close-on-content-click=\"false\">\n                <template v-slot:activator=\"{ props }\">\n                  <div>\n                    <tool-button\n                      v-bind=\"props\"\n                      size=\"40\"\n                      icon=\"mdi-view-dashboard\"\n                      name=\"Layouts\"\n                    />\n                  </div>\n                </template>\n                <v-card>\n                  <v-card-text>\n                    <v-radio-group\n                      v-model=\"layoutName\"\n                      class=\"mt-0\"\n                      hide-details\n                    >\n                      <v-radio\n                        v-for=\"(value, key) in Layouts\"\n                        :key=\"key\"\n                        :label=\"value.name\"\n                        :value=\"key\"\n                      />\n                    </v-radio-group>\n                  </v-card-text>\n                </v-card>\n              </v-menu>\n              <template v-if=\"hasData\">\n                <tool-strip />\n              </template>\n              <v-spacer />\n              <v-badge\n                offset-x=\"10\"\n                offset-y=\"10\"\n                :content=\"messageCount\"\n                :color=\"messageBadgeColor\"\n                :model-value=\"messageCount > 0\"\n              >\n                <tool-button\n                  size=\"40\"\n                  icon=\"mdi-bell-outline\"\n                  name=\"Notifications\"\n                  @click=\"messageDialog = true\"\n                />\n              </v-badge>\n              <tool-button\n                size=\"40\"\n                icon=\"mdi-cog\"\n                name=\"Settings\"\n                @click=\"settingsDialog = true\"\n              />\n            </div> -->\n            <div class=\"d-flex flex-column flex-grow-1\">\n              <div v-if=\"hasData\" style=\"width: 100%; height: 100%\">\n                <LayoutGridDemo />\n              </div>\n\n              <v-row\n                v-show=\"!hasData\"\n                no-gutters\n                align=\"center\"\n                class=\"clickable bg-grey-darken-3\"\n                @click=\"userPromptFiles\"\n              >\n                <v-col>\n                  <v-row justify=\"center\">\n                    <v-card\n                      flat\n                      dark\n                      color=\"transparent\"\n                      class=\"text-center headline\"\n                    >\n                      <div>\n                        <v-icon size=\"64\">mdi-folder-open</v-icon>\n                      </div>\n                      <div>Click to open local files.</div>\n                      <div class=\"mt-8\">\n                        <v-icon size=\"64\">mdi-arrow-down-bold</v-icon>\n                      </div>\n                      <div>Drag &amp; drop your DICOM files.</div>\n\n                      <div v-if=\"!saveUrl\" class=\"vertical-offset-margin\">\n                        <v-icon size=\"64\">mdi-cloud-off-outline</v-icon>\n                      </div>\n                      <div v-if=\"!saveUrl\">\n                        Secure: Image data never leaves your machine.\n                      </div>\n\n                      <div\n                        v-if=\"showErrorReporting\"\n                        class=\"vertical-offset-margin\"\n                      >\n                        Opt out of error reporting:\n                        <v-btn\n                          icon=\"mdi-cog\"\n                          @click.stop=\"settingsDialog = true\"\n                          density=\"comfortable\"\n                        />\n                      </div>\n                    </v-card>\n                  </v-row>\n                </v-col>\n              </v-row>\n            </div>\n          </div>\n        </v-main>\n\n        <v-dialog v-model=\"aboutBoxDialog\" :width=\"mobile ? '100%' : '80%'\">\n          <about-box @close=\"aboutBoxDialog = false\" />\n        </v-dialog>\n\n        <v-dialog\n          v-model=\"messageDialog\"\n          :width=\"mobile ? '100%' : '75%'\"\n          content-class=\"fill-height\"\n        >\n          <message-center @close=\"messageDialog = false\" />\n        </v-dialog>\n\n        <message-notifications @open-notifications=\"messageDialog = true\" />\n\n        <v-dialog v-model=\"settingsDialog\" :width=\"mobile ? '100%' : '50%'\">\n          <settings @close=\"settingsDialog = false\" v-if=\"settingsDialog\" />\n        </v-dialog>\n\n        <v-dialog v-model=\"saveDialog\" :width=\"mobile ? '100%' : '30%'\">\n          <save-session @close=\"saveDialog = false\" />\n        </v-dialog>\n      </v-app>\n      <persistent-overlay\n        :disabled=\"!dragHover\"\n        color=\"#000\"\n        :opacity=\"0.3\"\n        :z-index=\"2000\"\n        class=\"text-center\"\n      >\n        <div class=\"d-flex flex-column align-center justify-center h-100\">\n          <div class=\"dnd-prompt\">\n            <v-icon size=\"4.75rem\">mdi-download</v-icon>\n            <div class=\"text-h2 font-weight-bold\">Drop your files to open</div>\n          </div>\n        </div>\n      </persistent-overlay>\n    </template>\n  </drag-and-drop>\n</template>\n\n<script lang=\"ts\">\nimport {\n  computed,\n  defineComponent,\n  nextTick,\n  onMounted,\n  Ref,\n  ref,\n  watch,\n} from 'vue';\nimport { storeToRefs } from 'pinia';\nimport { UrlParams } from '@vueuse/core';\nimport vtkURLExtract from '@kitware/vtk.js/Common/Core/URLExtract';\nimport { URL } from 'whatwg-url';\nimport { useDisplay } from 'vuetify';\n\nimport { basename } from '@/src/utils/path';\nimport { useDatasetStore } from '@/src/store/datasets';\nimport { logError } from '@/src/utils/loggers';\nimport {\n  importDataSources,\n  ImportDataSourcesResult,\n  convertSuccessResultToDataSelection,\n} from '@/src/io/import/importDataSources';\nimport ToolButton from './ToolButton.vue';\nimport LayoutGrid from './LayoutGrid.vue';\nimport ModulePanel from './ModulePanel.vue';\nimport DragAndDrop from './DragAndDrop.vue';\nimport AboutBox from './AboutBox.vue';\nimport ToolStrip from './ToolStrip.vue';\nimport MessageCenter from './MessageCenter.vue';\nimport MessageNotifications from './MessageNotifications.vue';\nimport Settings from './Settings.vue';\nimport PersistentOverlay from './PersistentOverlay.vue';\nimport VolViewFullLogo from './icons/VolViewFullLogo.vue';\nimport VolViewLogo from './icons/VolViewLogo.vue';\nimport {\n  DataSource,\n  fileToDataSource,\n  getDataSourceName,\n  uriToDataSource,\n} from '../io/import/dataSource';\nimport { useImageStore } from '../store/datasets-images';\nimport { useViewStore } from '../store/views';\nimport { MessageType, useMessageStore } from '../store/messages';\nimport { Layouts } from '../config';\nimport { serialize } from '../io/state-file';\nimport SaveSession from './SaveSession.vue';\nimport { useGlobalErrorHook } from '../composables/useGlobalErrorHook';\nimport { useWebGLWatchdog } from '../composables/useWebGLWatchdog';\nimport { useAppLoadingNotifications } from '../composables/useAppLoadingNotifications';\nimport { partition, wrapInArray } from '../utils';\nimport { useKeyboardShortcuts } from '../composables/useKeyboardShortcuts';\nimport {\n  useErrorReporting,\n  errorReportingConfigured,\n} from '../utils/errorReporting';\n\nimport LayoutGridDemo from './LayoutGridDemo.vue';\n\nasync function loadFiles(\n  sources: DataSource[],\n  setError: (err: Error) => void\n) {\n  const dataStore = useDatasetStore();\n\n  let results: ImportDataSourcesResult[];\n  try {\n    results = await importDataSources(sources);\n  } catch (error) {\n    setError(error as Error);\n    return;\n  }\n\n  const [succeeded, errored] = partition((result) => result.ok, results);\n\n  if (!dataStore.primarySelection && succeeded.length) {\n    const selection = convertSuccessResultToDataSelection(succeeded[0]);\n    if (selection) {\n      dataStore.setPrimarySelection(selection);\n    }\n  }\n\n  if (errored.length) {\n    const errorMessages = errored.map((errResult) => {\n      // pick first error\n      const [firstError] = errResult.errors;\n      // pick innermost dataset that errored\n      const name = getDataSourceName(firstError.inputDataStackTrace[0]);\n      // log error for debugging\n      logError(firstError.cause);\n      return `- ${name}: ${firstError.message}`;\n    });\n    const failedError = new Error(\n      `These files failed to load:\\n${errorMessages.join('\\n')}`\n    );\n\n    setError(failedError);\n  }\n}\n\nasync function loadRemoteFilesFromURLParams(\n  params: UrlParams,\n  setError: (err: Error) => void\n) {\n  const urls = wrapInArray(params.urls);\n  const names = wrapInArray(params.names ?? []); // optional names should resolve to [] if params.names === undefined\n  const sources = urls.map((url, idx) =>\n    uriToDataSource(\n      url,\n      names[idx] || basename(new URL(url, window.location.href).pathname) || url\n    )\n  );\n\n  await loadFiles(sources, setError);\n}\n\nexport default defineComponent({\n  name: 'App',\n\n  components: {\n    ToolButton,\n    LayoutGrid,\n    DragAndDrop,\n    AboutBox,\n    ToolStrip,\n    ModulePanel,\n    MessageCenter,\n    MessageNotifications,\n    VolViewFullLogo,\n    VolViewLogo,\n    Settings,\n    SaveSession,\n    LayoutGridDemo,\n    PersistentOverlay,\n  },\n\n  setup() {\n    const imageStore = useImageStore();\n    const messageStore = useMessageStore();\n    const viewStore = useViewStore();\n\n    useGlobalErrorHook();\n    useWebGLWatchdog();\n    useKeyboardShortcuts();\n\n    const { runAsLoading } = useAppLoadingNotifications();\n\n    // --- layout --- //\n\n    const layoutName: Ref<string> = ref('Quad View');\n    const { layout: currentLayout } = storeToRefs(viewStore);\n\n    watch(\n      layoutName,\n      () => {\n        const layout = Layouts[layoutName.value] || [];\n        viewStore.setLayout(layout);\n      },\n      {\n        immediate: true,\n      }\n    );\n\n    watch(currentLayout, () => {\n      if (\n        currentLayout.value?.name &&\n        currentLayout.value.name !== layoutName.value\n      ) {\n        layoutName.value = currentLayout.value.name;\n      }\n    });\n\n    // --- file handling --- //\n\n    async function openFiles(files: FileList | null) {\n      console.log(files);\n      if (!files) {\n        return;\n      }\n\n      const dataSources = Array.from(files).map(fileToDataSource);\n      runAsLoading((setError) => loadFiles(dataSources, setError));\n    }\n\n    const fileEl = document.createElement('input');\n    fileEl.setAttribute('type', 'file');\n    fileEl.setAttribute('multiple', 'multiple');\n    fileEl.setAttribute('accept', '*');\n    fileEl.addEventListener('change', () => openFiles(fileEl.files));\n\n    // // Specify the default file path\n    // const defaultFilePath = 'path/to/your/default/file.txt';\n\n    // // Create a File object manually (for demonstration purposes)\n    // const defaultFile = new File([/* file content */], defaultFilePath);\n\n    // // Call openFiles with the default file\n    // openFiles(new FileList([defaultFile]));\n\n    function userPromptFiles() {\n      fileEl.value = '';\n      fileEl.click();\n    }\n\n    // --- parse URL -- //\n\n    const urlParams = vtkURLExtract.extractURLParameters() as UrlParams;\n\n    onMounted(() => {\n      if (!urlParams.urls) {\n        return;\n      }\n\n      // TODO remove this nextTick when we switch away from\n      // vue-toastification.\n      // We run in nextTick to ensure the library is mounted.\n      nextTick(() => {\n        runAsLoading((setError) =>\n          loadRemoteFilesFromURLParams(urlParams, setError)\n        );\n      });\n    });\n\n    // --- template vars --- //\n\n    const hasData = computed(() => imageStore.idList.length > 0);\n    const messageCount = computed(() => messageStore.importantMessages.length);\n    const messageBadgeColor = computed(() => {\n      if (\n        messageStore.importantMessages.find(\n          (msg) => msg.type === MessageType.Error\n        )\n      ) {\n        return 'error';\n      }\n      if (\n        messageStore.importantMessages.find(\n          (msg) => msg.type === MessageType.Warning\n        )\n      ) {\n        return 'warning';\n      }\n      return 'primary';\n    });\n\n    const saveDialog = ref(false);\n    const saveUrl =\n      import.meta.env.VITE_ENABLE_REMOTE_SAVE && (urlParams.save as string);\n    const saveHappening = ref(false);\n\n    const handleSave = async () => {\n      if (saveUrl) {\n        try {\n          saveHappening.value = true;\n\n          const blob = await serialize();\n          const saveResult = await fetch(saveUrl, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/zip',\n              'Content-Length': blob.size.toString(),\n            },\n            body: blob,\n          });\n\n          if (saveResult.ok) messageStore.addSuccess('Save Successful');\n          else messageStore.addError('Save Failed', 'Network response not OK');\n        } catch (error) {\n          messageStore.addError(\n            'Save Failed with error',\n            `Failed from: ${error}`\n          );\n        } finally {\n          saveHappening.value = false;\n        }\n      } else {\n        saveDialog.value = true;\n      }\n    };\n\n    const display = useDisplay();\n\n    const errorReportingStore = useErrorReporting();\n    const showErrorReporting = computed(() => {\n      return errorReportingConfigured && !errorReportingStore.disableReporting;\n    });\n\n    return {\n      aboutBoxDialog: ref(false),\n      messageDialog: ref(false),\n      settingsDialog: ref(false),\n      saveDialog,\n      handleSave,\n      saveHappening,\n      leftSideBar: ref(!display.mobile.value),\n      mobile: display.mobile,\n      messageCount,\n      messageBadgeColor,\n      layoutName,\n      currentLayout,\n      Layouts,\n      userPromptFiles,\n      openFiles,\n      hasData,\n      showErrorReporting,\n      saveUrl,\n    };\n  },\n});\n</script>\n\n<style>\n#content-main {\n  /* disable v-content transition when we resize our app drawer */\n  transition: initial;\n  width: 100%;\n  height: 100%;\n  position: fixed;\n}\n\n#left-nav {\n  border-right: 1px solid rgb(var(--v-theme-background));\n}\n\n#content-main > .v-content__wrap {\n  display: flex;\n}\n\n#module-switcher .v-input__prepend-inner {\n  /* better icon alignment */\n  margin-top: 15px;\n}\n\n.alert > .v-snack__wrapper {\n  /* transition background color */\n  transition: background-color 0.25s;\n}\n</style>\n\n<style src=\"@/src/components/styles/utils.css\"></style>\n\n<style scoped>\n#app-container {\n  width: 100%;\n  height: 100%;\n}\n\n#tools-strip {\n  border-left: 1px solid #212121;\n  flex: 0 0 40px;\n}\n\n.toolbar-button {\n  min-height: 100%; /* fill toolbar height */\n}\n\n.tool-separator {\n  width: 75%;\n  height: 1px;\n  border: none;\n  border-top: 1px solid rgb(112, 112, 112);\n}\n\n.vertical-offset-margin {\n  margin-top: 128px;\n}\n\n.dnd-prompt {\n  background: rgba(0, 0, 0, 0.4);\n  color: white;\n  border-radius: 8px;\n  box-shadow: 0px 0px 10px 5px rgba(0, 0, 0, 0.4);\n  padding: 64px;\n}\n</style>\n","<template>\n  <drag-and-drop enabled @drop-files=\"openFiles\" id=\"app-container\">\n    <template v-slot=\"{ dragHover }\">\n      <v-app>\n        <!-- <v-app-bar app clipped-left :height=\"48\">\n          <v-btn\n            v-if=\"mobile\"\n            icon=\"mdi-menu\"\n            @click=\"leftSideBar = !leftSideBar\"\n          />\n          <v-toolbar-title class=\"d-flex flex-row align-center mt-3\">\n            <vol-view-logo v-if=\"mobile\" />\n            <vol-view-full-logo v-else />\n          </v-toolbar-title>\n          <v-btn\n            variant=\"text\"\n            icon=\"mdi-help-circle-outline\"\n            :rounded=\"0\"\n            class=\"toolbar-button\"\n            @click=\"aboutBoxDialog = !aboutBoxDialog\"\n          />\n        </v-app-bar> -->\n        <v-navigation-drawer\n          v-model=\"leftSideBar\"\n          app\n          clipped\n          touchless\n          width=\"450\"\n          id=\"left-nav\"\n        >\n          <module-panel @close=\"leftSideBar = false\" />\n        </v-navigation-drawer>\n\n        <v-main id=\"content-main\">\n          <div class=\"fill-height d-flex flex-row flex-grow-1\">\n            <!-- <div\n              id=\"tools-strip\"\n              class=\"bg-grey-darken-4 d-flex flex-column align-center\"\n            >\n              <tool-button\n                size=\"40\"\n                icon=\"mdi-folder-open\"\n                name=\"Open files\"\n                @click=\"userPromptFiles\"\n              />\n              <tool-button\n                size=\"40\"\n                icon=\"mdi-content-save-all\"\n                name=\"Save session\"\n                :loading=\"saveHappening\"\n                @click=\"handleSave\"\n              />\n              <div class=\"my-1 tool-separator\" />\n              <v-menu location=\"right\" :close-on-content-click=\"false\">\n                <template v-slot:activator=\"{ props }\">\n                  <div>\n                    <tool-button\n                      v-bind=\"props\"\n                      size=\"40\"\n                      icon=\"mdi-view-dashboard\"\n                      name=\"Layouts\"\n                    />\n                  </div>\n                </template>\n                <v-card>\n                  <v-card-text>\n                    <v-radio-group\n                      v-model=\"layoutName\"\n                      class=\"mt-0\"\n                      hide-details\n                    >\n                      <v-radio\n                        v-for=\"(value, key) in Layouts\"\n                        :key=\"key\"\n                        :label=\"value.name\"\n                        :value=\"key\"\n                      />\n                    </v-radio-group>\n                  </v-card-text>\n                </v-card>\n              </v-menu>\n              <template v-if=\"hasData\">\n                <tool-strip />\n              </template>\n              <v-spacer />\n              <v-badge\n                offset-x=\"10\"\n                offset-y=\"10\"\n                :content=\"messageCount\"\n                :color=\"messageBadgeColor\"\n                :model-value=\"messageCount > 0\"\n              >\n                <tool-button\n                  size=\"40\"\n                  icon=\"mdi-bell-outline\"\n                  name=\"Notifications\"\n                  @click=\"messageDialog = true\"\n                />\n              </v-badge>\n              <tool-button\n                size=\"40\"\n                icon=\"mdi-cog\"\n                name=\"Settings\"\n                @click=\"settingsDialog = true\"\n              />\n            </div> -->\n            <div class=\"d-flex flex-column flex-grow-1\">\n              <div v-if=\"hasData\" style=\"width: 100%; height: 100%\">\n                <LayoutGridDemo />\n              </div>\n\n              <v-row\n                v-show=\"!hasData\"\n                no-gutters\n                align=\"center\"\n                class=\"clickable bg-grey-darken-3\"\n                @click=\"userPromptFiles\"\n              >\n                <v-col>\n                  <v-row justify=\"center\">\n                    <v-card\n                      flat\n                      dark\n                      color=\"transparent\"\n                      class=\"text-center headline\"\n                    >\n                      <div>\n                        <v-icon size=\"64\">mdi-folder-open</v-icon>\n                      </div>\n                      <div>Click to open local files.</div>\n                      <div class=\"mt-8\">\n                        <v-icon size=\"64\">mdi-arrow-down-bold</v-icon>\n                      </div>\n                      <div>Drag &amp; drop your DICOM files.</div>\n\n                      <div v-if=\"!saveUrl\" class=\"vertical-offset-margin\">\n                        <v-icon size=\"64\">mdi-cloud-off-outline</v-icon>\n                      </div>\n                      <div v-if=\"!saveUrl\">\n                        Secure: Image data never leaves your machine.\n                      </div>\n\n                      <div\n                        v-if=\"showErrorReporting\"\n                        class=\"vertical-offset-margin\"\n                      >\n                        Opt out of error reporting:\n                        <v-btn\n                          icon=\"mdi-cog\"\n                          @click.stop=\"settingsDialog = true\"\n                          density=\"comfortable\"\n                        />\n                      </div>\n                    </v-card>\n                  </v-row>\n                </v-col>\n              </v-row>\n            </div>\n          </div>\n        </v-main>\n\n        <v-dialog v-model=\"aboutBoxDialog\" :width=\"mobile ? '100%' : '80%'\">\n          <about-box @close=\"aboutBoxDialog = false\" />\n        </v-dialog>\n\n        <v-dialog\n          v-model=\"messageDialog\"\n          :width=\"mobile ? '100%' : '75%'\"\n          content-class=\"fill-height\"\n        >\n          <message-center @close=\"messageDialog = false\" />\n        </v-dialog>\n\n        <message-notifications @open-notifications=\"messageDialog = true\" />\n\n        <v-dialog v-model=\"settingsDialog\" :width=\"mobile ? '100%' : '50%'\">\n          <settings @close=\"settingsDialog = false\" v-if=\"settingsDialog\" />\n        </v-dialog>\n\n        <v-dialog v-model=\"saveDialog\" :width=\"mobile ? '100%' : '30%'\">\n          <save-session @close=\"saveDialog = false\" />\n        </v-dialog>\n      </v-app>\n      <persistent-overlay\n        :disabled=\"!dragHover\"\n        color=\"#000\"\n        :opacity=\"0.3\"\n        :z-index=\"2000\"\n        class=\"text-center\"\n      >\n        <div class=\"d-flex flex-column align-center justify-center h-100\">\n          <div class=\"dnd-prompt\">\n            <v-icon size=\"4.75rem\">mdi-download</v-icon>\n            <div class=\"text-h2 font-weight-bold\">Drop your files to open</div>\n          </div>\n        </div>\n      </persistent-overlay>\n    </template>\n  </drag-and-drop>\n</template>\n\n<script lang=\"ts\">\nimport {\n  computed,\n  defineComponent,\n  nextTick,\n  onMounted,\n  Ref,\n  ref,\n  watch,\n} from 'vue';\nimport { storeToRefs } from 'pinia';\nimport { UrlParams } from '@vueuse/core';\nimport vtkURLExtract from '@kitware/vtk.js/Common/Core/URLExtract';\nimport { URL } from 'whatwg-url';\nimport { useDisplay } from 'vuetify';\n\nimport { basename } from '@/src/utils/path';\nimport { useDatasetStore } from '@/src/store/datasets';\nimport { logError } from '@/src/utils/loggers';\nimport {\n  importDataSources,\n  ImportDataSourcesResult,\n  convertSuccessResultToDataSelection,\n} from '@/src/io/import/importDataSources';\nimport ToolButton from './ToolButton.vue';\nimport LayoutGrid from './LayoutGrid.vue';\nimport ModulePanel from './ModulePanel.vue';\nimport DragAndDrop from './DragAndDrop.vue';\nimport AboutBox from './AboutBox.vue';\nimport ToolStrip from './ToolStrip.vue';\nimport MessageCenter from './MessageCenter.vue';\nimport MessageNotifications from './MessageNotifications.vue';\nimport Settings from './Settings.vue';\nimport PersistentOverlay from './PersistentOverlay.vue';\nimport VolViewFullLogo from './icons/VolViewFullLogo.vue';\nimport VolViewLogo from './icons/VolViewLogo.vue';\nimport {\n  DataSource,\n  fileToDataSource,\n  getDataSourceName,\n  uriToDataSource,\n} from '../io/import/dataSource';\nimport { useImageStore } from '../store/datasets-images';\nimport { useViewStore } from '../store/views';\nimport { MessageType, useMessageStore } from '../store/messages';\nimport { Layouts } from '../config';\nimport { serialize } from '../io/state-file';\nimport SaveSession from './SaveSession.vue';\nimport { useGlobalErrorHook } from '../composables/useGlobalErrorHook';\nimport { useWebGLWatchdog } from '../composables/useWebGLWatchdog';\nimport { useAppLoadingNotifications } from '../composables/useAppLoadingNotifications';\nimport { partition, wrapInArray } from '../utils';\nimport { useKeyboardShortcuts } from '../composables/useKeyboardShortcuts';\nimport {\n  useErrorReporting,\n  errorReportingConfigured,\n} from '../utils/errorReporting';\n\nimport LayoutGridDemo from './LayoutGridDemo.vue';\n\nasync function loadFiles(\n  sources: DataSource[],\n  setError: (err: Error) => void\n) {\n  const dataStore = useDatasetStore();\n\n  let results: ImportDataSourcesResult[];\n  try {\n    results = await importDataSources(sources);\n  } catch (error) {\n    setError(error as Error);\n    return;\n  }\n\n  const [succeeded, errored] = partition((result) => result.ok, results);\n\n  if (!dataStore.primarySelection && succeeded.length) {\n    const selection = convertSuccessResultToDataSelection(succeeded[0]);\n    if (selection) {\n      dataStore.setPrimarySelection(selection);\n    }\n  }\n\n  if (errored.length) {\n    const errorMessages = errored.map((errResult) => {\n      // pick first error\n      const [firstError] = errResult.errors;\n      // pick innermost dataset that errored\n      const name = getDataSourceName(firstError.inputDataStackTrace[0]);\n      // log error for debugging\n      logError(firstError.cause);\n      return `- ${name}: ${firstError.message}`;\n    });\n    const failedError = new Error(\n      `These files failed to load:\\n${errorMessages.join('\\n')}`\n    );\n\n    setError(failedError);\n  }\n}\n\nasync function loadRemoteFilesFromURLParams(\n  params: UrlParams,\n  setError: (err: Error) => void\n) {\n  const urls = wrapInArray(params.urls);\n  const names = wrapInArray(params.names ?? []); // optional names should resolve to [] if params.names === undefined\n  const sources = urls.map((url, idx) =>\n    uriToDataSource(\n      url,\n      names[idx] || basename(new URL(url, window.location.href).pathname) || url\n    )\n  );\n\n  await loadFiles(sources, setError);\n}\n\nexport default defineComponent({\n  name: 'App',\n\n  components: {\n    ToolButton,\n    LayoutGrid,\n    DragAndDrop,\n    AboutBox,\n    ToolStrip,\n    ModulePanel,\n    MessageCenter,\n    MessageNotifications,\n    VolViewFullLogo,\n    VolViewLogo,\n    Settings,\n    SaveSession,\n    LayoutGridDemo,\n    PersistentOverlay,\n  },\n\n  setup() {\n    const imageStore = useImageStore();\n    const messageStore = useMessageStore();\n    const viewStore = useViewStore();\n\n    useGlobalErrorHook();\n    useWebGLWatchdog();\n    useKeyboardShortcuts();\n\n    const { runAsLoading } = useAppLoadingNotifications();\n\n    // --- layout --- //\n\n    const layoutName: Ref<string> = ref('Quad View');\n    const { layout: currentLayout } = storeToRefs(viewStore);\n\n    watch(\n      layoutName,\n      () => {\n        const layout = Layouts[layoutName.value] || [];\n        viewStore.setLayout(layout);\n      },\n      {\n        immediate: true,\n      }\n    );\n\n    watch(currentLayout, () => {\n      if (\n        currentLayout.value?.name &&\n        currentLayout.value.name !== layoutName.value\n      ) {\n        layoutName.value = currentLayout.value.name;\n      }\n    });\n\n    // --- file handling --- //\n\n    async function openFiles(files: FileList | null) {\n      console.log(files);\n      if (!files) {\n        return;\n      }\n\n      const dataSources = Array.from(files).map(fileToDataSource);\n      runAsLoading((setError) => loadFiles(dataSources, setError));\n    }\n\n    const fileEl = document.createElement('input');\n    fileEl.setAttribute('type', 'file');\n    fileEl.setAttribute('multiple', 'multiple');\n    fileEl.setAttribute('accept', '*');\n    fileEl.addEventListener('change', () => openFiles(fileEl.files));\n\n    // // Specify the default file path\n    // const defaultFilePath = 'path/to/your/default/file.txt';\n\n    // // Create a File object manually (for demonstration purposes)\n    // const defaultFile = new File([/* file content */], defaultFilePath);\n\n    // // Call openFiles with the default file\n    // openFiles(new FileList([defaultFile]));\n\n    function userPromptFiles() {\n      fileEl.value = '';\n      fileEl.click();\n    }\n\n    // --- parse URL -- //\n\n    const urlParams = vtkURLExtract.extractURLParameters() as UrlParams;\n\n    onMounted(() => {\n      if (!urlParams.urls) {\n        return;\n      }\n\n      // TODO remove this nextTick when we switch away from\n      // vue-toastification.\n      // We run in nextTick to ensure the library is mounted.\n      nextTick(() => {\n        runAsLoading((setError) =>\n          loadRemoteFilesFromURLParams(urlParams, setError)\n        );\n      });\n    });\n\n    // --- template vars --- //\n\n    const hasData = computed(() => imageStore.idList.length > 0);\n    const messageCount = computed(() => messageStore.importantMessages.length);\n    const messageBadgeColor = computed(() => {\n      if (\n        messageStore.importantMessages.find(\n          (msg) => msg.type === MessageType.Error\n        )\n      ) {\n        return 'error';\n      }\n      if (\n        messageStore.importantMessages.find(\n          (msg) => msg.type === MessageType.Warning\n        )\n      ) {\n        return 'warning';\n      }\n      return 'primary';\n    });\n\n    const saveDialog = ref(false);\n    const saveUrl =\n      import.meta.env.VITE_ENABLE_REMOTE_SAVE && (urlParams.save as string);\n    const saveHappening = ref(false);\n\n    const handleSave = async () => {\n      if (saveUrl) {\n        try {\n          saveHappening.value = true;\n\n          const blob = await serialize();\n          const saveResult = await fetch(saveUrl, {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/zip',\n              'Content-Length': blob.size.toString(),\n            },\n            body: blob,\n          });\n\n          if (saveResult.ok) messageStore.addSuccess('Save Successful');\n          else messageStore.addError('Save Failed', 'Network response not OK');\n        } catch (error) {\n          messageStore.addError(\n            'Save Failed with error',\n            `Failed from: ${error}`\n          );\n        } finally {\n          saveHappening.value = false;\n        }\n      } else {\n        saveDialog.value = true;\n      }\n    };\n\n    const display = useDisplay();\n\n    const errorReportingStore = useErrorReporting();\n    const showErrorReporting = computed(() => {\n      return errorReportingConfigured && !errorReportingStore.disableReporting;\n    });\n\n    return {\n      aboutBoxDialog: ref(false),\n      messageDialog: ref(false),\n      settingsDialog: ref(false),\n      saveDialog,\n      handleSave,\n      saveHappening,\n      leftSideBar: ref(!display.mobile.value),\n      mobile: display.mobile,\n      messageCount,\n      messageBadgeColor,\n      layoutName,\n      currentLayout,\n      Layouts,\n      userPromptFiles,\n      openFiles,\n      hasData,\n      showErrorReporting,\n      saveUrl,\n    };\n  },\n});\n</script>\n\n<style>\n#content-main {\n  /* disable v-content transition when we resize our app drawer */\n  transition: initial;\n  width: 100%;\n  height: 100%;\n  position: fixed;\n}\n\n#left-nav {\n  border-right: 1px solid rgb(var(--v-theme-background));\n}\n\n#content-main > .v-content__wrap {\n  display: flex;\n}\n\n#module-switcher .v-input__prepend-inner {\n  /* better icon alignment */\n  margin-top: 15px;\n}\n\n.alert > .v-snack__wrapper {\n  /* transition background color */\n  transition: background-color 0.25s;\n}\n</style>\n\n<style src=\"@/src/components/styles/utils.css\"></style>\n\n<style scoped>\n#app-container {\n  width: 100%;\n  height: 100%;\n}\n\n#tools-strip {\n  border-left: 1px solid #212121;\n  flex: 0 0 40px;\n}\n\n.toolbar-button {\n  min-height: 100%; /* fill toolbar height */\n}\n\n.tool-separator {\n  width: 75%;\n  height: 1px;\n  border: none;\n  border-top: 1px solid rgb(112, 112, 112);\n}\n\n.vertical-offset-margin {\n  margin-top: 128px;\n}\n\n.dnd-prompt {\n  background: rgba(0, 0, 0, 0.4);\n  color: white;\n  border-radius: 8px;\n  box-shadow: 0px 0px 10px 5px rgba(0, 0, 0, 0.4);\n  padding: 64px;\n}\n</style>\n","import { join } from '@/src/utils/path';\nimport {\n  runPipeline,\n  TextStream,\n  InterfaceTypes,\n  readDICOMTags,\n  readImageDICOMFileSeries,\n  Image,\n} from 'itk-wasm';\n\nexport interface TagSpec {\n  name: string;\n  tag: string;\n}\n\nexport type SpatialParameters = Pick<\n  Image,\n  'size' | 'spacing' | 'origin' | 'direction'\n>;\n\n// volume ID => file names\nexport type VolumesToFileNamesMap = Record<string, string[]>;\n\n// volume ID => files\nexport type VolumesToFilesMap = Record<string, File[]>;\n\n/**\n * Filenames must be sanitized prior to being passed into itk-wasm.\n *\n * In particular, forward slashes cause FS errors in itk-wasm.\n * @param name\n * @returns\n */\nfunction sanitizeFileName(name: string) {\n  return name.replace(/\\//g, '_');\n}\n\n/**\n * Returns a new File instance with a sanitized name.\n * @param file\n */\nfunction sanitizeFile(file: File) {\n  return new File([file], sanitizeFileName(file.name));\n}\n\nexport class DICOMIO {\n  private webWorker: any;\n  private initializeCheck: Promise<void> | null;\n\n  constructor() {\n    this.webWorker = null;\n    this.initializeCheck = null;\n  }\n\n  private async runTask(\n    module: string,\n    args: any[],\n    inputs: any[],\n    outputs: any[]\n  ) {\n    return runPipeline(\n      this.webWorker,\n      module,\n      args,\n      outputs,\n      inputs,\n      join(import.meta.env.BASE_URL, '/itk/pipelines'),\n      join(import.meta.env.BASE_URL, '/itk/pipeline.worker.js')\n    );\n  }\n\n  /**\n   * Helper that initializes the webworker.\n   *\n   * @async\n   * @throws Error initialization failed\n   */\n  async initialize() {\n    if (!this.initializeCheck) {\n      this.initializeCheck = new Promise<void>((resolve, reject) => {\n        this.runTask('dicom', [], [], [])\n          .then((result) => {\n            if (result.webWorker) {\n              this.webWorker = result.webWorker;\n            } else {\n              reject(new Error('Could not initialize webworker'));\n            }\n          })\n          .then(async () => {\n            // preload read-dicom-tags pipeline\n            try {\n              await readDICOMTags(this.webWorker, new File([], ''), null);\n            } catch {\n              // ignore\n            }\n            resolve();\n          })\n          .catch(reject);\n      });\n    }\n\n    return this.initializeCheck;\n  }\n\n  /**\n   * Categorize files\n   * @async\n   * @param {File[]} files\n   * @returns volumeID => file names mapping\n   */\n  async categorizeFiles(files: File[]): Promise<VolumesToFilesMap> {\n    await this.initialize();\n\n    const inputs = await Promise.all(\n      files.map(async (file, index) => {\n        const buffer = await file.arrayBuffer();\n        return {\n          type: InterfaceTypes.BinaryFile,\n          data: {\n            path: index.toString(), // make each file name unique\n            data: new Uint8Array(buffer),\n          },\n        };\n      })\n    );\n\n    const args = [\n      '--action',\n      'categorize',\n      '--memory-io',\n      '0',\n      '--files',\n      ...inputs.map((fd) => fd.data.path),\n    ];\n\n    const outputs = [{ type: InterfaceTypes.TextStream }];\n\n    const result = await this.runTask('dicom', args, inputs, outputs);\n\n    // File names are indexes into input files array\n    const volumeToFileIndexes = JSON.parse(\n      (result.outputs[0].data as TextStream).data\n    ) as VolumesToFileNamesMap;\n\n    const volumeToFiles = Object.fromEntries(\n      Object.entries(volumeToFileIndexes).map(([volumeKey, fileIndexes]) => [\n        volumeKey,\n        // file indexes to Files\n        fileIndexes.map((fileIndex) => files[parseInt(fileIndex, 10)]),\n      ])\n    );\n\n    return volumeToFiles;\n  }\n\n  /**\n   * Reads a list of tags out from a given file.\n   *\n   * @param {File} file\n   * @param {[]Tag} tags\n   */\n  async readTags<T extends TagSpec[]>(\n    file: File,\n    tags: T\n  ): Promise<Record<T[number]['name'], string>> {\n    const tagsArgs = tags.map((t) => t.tag);\n\n    const result = await readDICOMTags(\n      this.webWorker,\n      sanitizeFile(file),\n      tagsArgs\n    );\n    const tagValues = result.tags;\n\n    return tags.reduce((info, t) => {\n      const { tag, name } = t;\n      if (tagValues.has(tag)) {\n        return { ...info, [name]: tagValues.get(tag) };\n      }\n      return info;\n    }, {} as Record<T[number]['name'], string>);\n  }\n\n  /**\n   * Retrieves a slice of a volume.\n   * @async\n   * @param {File} file containing the slice\n   * @param {Boolean} asThumbnail cast image to unsigned char. Defaults to false.\n   * @returns ItkImage\n   */\n  async getVolumeSlice(file: File, asThumbnail: boolean = false) {\n    await this.initialize();\n\n    const buffer = await file.arrayBuffer();\n\n    const inputs = [\n      {\n        type: InterfaceTypes.BinaryFile,\n        data: {\n          path: sanitizeFileName(file.name),\n          data: new Uint8Array(buffer),\n        },\n      },\n    ];\n\n    const args = [\n      '--action',\n      'getSliceImage',\n      '--thumbnail',\n      asThumbnail.toString(),\n      '--file',\n      sanitizeFileName(file.name),\n      '--memory-io',\n      '0',\n    ];\n\n    const outputs = [{ type: InterfaceTypes.Image }];\n\n    const result = await this.runTask('dicom', args, inputs, outputs);\n\n    return result.outputs[0].data as Image;\n  }\n\n  async resample(fixed: SpatialParameters, moving: Image) {\n    await this.initialize();\n\n    const { size, spacing, origin, direction } = fixed;\n    const args = [\n      '--action',\n      'resample',\n      '0', // space for input image\n\n      '--size',\n      size.join(','),\n      '--spacing',\n      spacing.join(','),\n      '--origin',\n      origin.join(','),\n      '--direction',\n      direction.join(','),\n\n      '--memory-io',\n      '0',\n    ];\n\n    const inputs = [{ type: InterfaceTypes.Image, data: moving }];\n    const outputs = [{ type: InterfaceTypes.Image }];\n\n    const result = await this.runTask('dicom', args, inputs, outputs);\n    const image = result.outputs[0].data as Image;\n    return image;\n  }\n\n  /**\n   * Builds a volume for a set of files.\n   * @async\n   * @param {File[]} seriesFiles the set of files to build volume from\n   * @returns ItkImage\n   */\n  async buildImage(seriesFiles: File[]) {\n    await this.initialize();\n\n    const result = await readImageDICOMFileSeries(\n      seriesFiles.map((file) => sanitizeFile(file))\n    );\n\n    return result.image;\n  }\n}\n","import vtkITKImageReader from '@kitware/vtk.js/IO/Misc/ITKImageReader';\nimport { readImageArrayBuffer, extensionToImageIO } from 'itk-wasm';\nimport { FileReaderMap } from '.';\n\nimport { readFileAsArrayBuffer } from './io';\nimport { stlReader, vtiReader, vtpReader } from './vtk/async';\nimport { FILE_EXT_TO_MIME } from './mimeTypes';\n\nexport const ITK_IMAGE_MIME_TYPES = Array.from(\n  new Set(\n    Array.from(extensionToImageIO.keys()).map(\n      (ext) => FILE_EXT_TO_MIME[ext.toLowerCase()]\n    )\n  )\n);\n\nvtkITKImageReader.setReadImageArrayBufferFromITK(readImageArrayBuffer);\n\nasync function itkReader(file: File) {\n  const fileBuffer = await readFileAsArrayBuffer(file);\n\n  const reader = vtkITKImageReader.newInstance();\n  reader.setFileName(file.name);\n  try {\n    await reader.parseAsArrayBuffer(fileBuffer);\n  } catch (e) {\n    // itkreader doesn't give us a meaningful error\n    throw new Error('Failed to parse file');\n  }\n\n  return reader.getOutputData();\n}\n\n/**\n * Resets the file reader map to the default values.\n */\nexport function registerAllReaders(readerMap: FileReaderMap) {\n  readerMap.set('application/vnd.unknown.vti', vtiReader);\n  readerMap.set('application/vnd.unknown.vtp', vtpReader);\n  readerMap.set('model/stl', stlReader);\n\n  ITK_IMAGE_MIME_TYPES.forEach((mime) => {\n    readerMap.set(mime, itkReader);\n  });\n}\n","import { vec3 } from 'gl-matrix';\nimport macro from '@kitware/vtk.js/macro';\nimport vtkViewProxy from '@kitware/vtk.js/Proxy/Core/ViewProxy';\n\nexport function commonViewCustomizations(publicAPI, model) {\n  const delayedRender = macro.debounce(model.renderWindow.render, 5);\n\n  // override resize to avoid flickering from rendering later\n  publicAPI.resize = () => {\n    if (model.container) {\n      const dims = model.container.getBoundingClientRect();\n      if (dims.width === dims.height && dims.width === 0) {\n        return;\n      }\n      const devicePixelRatio = window.devicePixelRatio || 1;\n      const width = Math.max(10, Math.floor(devicePixelRatio * dims.width));\n      const height = Math.max(10, Math.floor(devicePixelRatio * dims.height));\n      model.renderWindow.getViews()[0].setSize(width, height);\n      publicAPI.invokeResize({ width, height });\n      publicAPI.render(true);\n    }\n  };\n\n  // override render to not reset camera\n  publicAPI.render = (blocking = true) => {\n    model.orientationWidget.updateMarkerOrientation();\n    if (blocking) {\n      model.renderWindow.render();\n    } else {\n      delayedRender();\n    }\n  };\n\n  // provide a renderLater impl that schedules for the next js task\n  let timeout = null;\n  publicAPI.renderLater = () => {\n    if (timeout != null) return;\n    timeout = setTimeout(() => {\n      publicAPI.render();\n      timeout = null;\n    }, 0);\n  };\n\n  // add helper function\n  publicAPI.removeAllRepresentations = () => {\n    model.representations.forEach((rep) => model.renderer.removeViewProp(rep));\n    model.representations.length = 0;\n  };\n\n  publicAPI.updateCamera = (directionOfProjection, viewUp, focalPoint) => {\n    const position = vec3.clone(focalPoint);\n    vec3.sub(position, position, directionOfProjection);\n    model.camera.setFocalPoint(...focalPoint);\n    model.camera.setPosition(...position);\n    model.camera.setDirectionOfProjection(...directionOfProjection);\n    model.camera.setViewUp(...viewUp);\n  };\n\n  // disable the built-in corner annotations\n  const { setContainer } = publicAPI;\n  publicAPI.setContainer = (el) => {\n    setContainer(el);\n    model.cornerAnnotation.setContainer(null);\n  };\n\n  const { resetCamera } = publicAPI;\n  publicAPI.resetCamera = (...args) => {\n    resetCamera(args);\n    model.renderer.updateLightsGeometryToFollowCamera();\n  };\n}\n\nfunction vtkLPSView3DProxy(publicAPI, model) {\n  model.classHierarchy.push('vtkLPSView3DProxy');\n  commonViewCustomizations(publicAPI, model);\n}\n\nexport function extend(publicAPI, model, initialValues = {}) {\n  Object.assign(model, initialValues);\n\n  vtkViewProxy.extend(publicAPI, model, initialValues);\n\n  vtkLPSView3DProxy(publicAPI, model);\n}\n\nexport const newInstance = macro.newInstance(extend, 'vtkLPSView3DProxy');\n\nexport default { newInstance, extend };\n","import macro from '@kitware/vtk.js/macro';\nimport vtkView2DProxy from '@kitware/vtk.js/Proxy/Core/View2DProxy';\n\nimport { commonViewCustomizations } from '@/src/vtk/LPSView3DProxy';\n\nfunction vtkLPSView2DProxy(publicAPI, model) {\n  model.classHierarchy.push('vtkLPSView2DProxy');\n  const superClass = { ...publicAPI };\n\n  commonViewCustomizations(publicAPI, model);\n\n  // override; we will set the manipulator ourselves\n  publicAPI.bindRepresentationToManipulator = () => {};\n\n  // override reset camera to /just/ reset the camera\n  publicAPI.resetCamera = (boundsToUse = null) => {\n    model.renderer.resetCamera(boundsToUse);\n  };\n\n  // override addRepresentation\n  publicAPI.addRepresentation = (rep) => {\n    if (!rep) {\n      return;\n    }\n    if (model.representations.indexOf(rep) === -1) {\n      model.representations.push(rep);\n      model.renderer.addViewProp(rep);\n    }\n\n    if (rep.setSlicingMode && model.slicingMode) {\n      rep.setSlicingMode(model.slicingMode);\n    }\n  };\n\n  publicAPI.setSlicingMode = (mode) => {\n    model.axis = 'IJK'.indexOf(mode);\n    if (superClass.setSlicingMode(mode) && mode) {\n      let count = model.representations.length;\n      while (count--) {\n        const rep = model.representations[count];\n        if (rep.setSlicingMode) {\n          rep.setSlicingMode(mode);\n        }\n      }\n    }\n  };\n\n  publicAPI.resizeToFit = (lookAxis, viewUpAxis, dims) => {\n    const [w, h] = model.renderWindow.getViews()[0].getSize();\n    let bw;\n    let bh;\n    if (lookAxis === 0 && viewUpAxis === 1) {\n      [, bh, bw] = dims;\n    } else if (lookAxis === 0 && viewUpAxis === 2) {\n      [, bw, bh] = dims;\n    } else if (lookAxis === 1 && viewUpAxis === 0) {\n      [bh, , bw] = dims;\n    } else if (lookAxis === 1 && viewUpAxis === 2) {\n      [bw, , bh] = dims;\n    } else if (lookAxis === 2 && viewUpAxis === 0) {\n      [bh, bw] = dims;\n    } else if (lookAxis === 2 && viewUpAxis === 1) {\n      [bw, bh] = dims;\n    }\n\n    const viewAspect = w / h;\n    const boundsAspect = bw / bh;\n    let scale = 0;\n    if (viewAspect >= boundsAspect) {\n      scale = bh / 2;\n    } else {\n      scale = bw / 2 / viewAspect;\n    }\n\n    model.camera.setParallelScale(scale);\n  };\n}\n\nconst DEFAULT_VALUES = {\n  slicingMode: null, // XYZIJK. Null means fallback to model.axis.\n};\n\nexport function extend(publicAPI, model, initialValues = {}) {\n  Object.assign(model, initialValues, DEFAULT_VALUES);\n\n  // slicing mode overrides axis\n  macro.setGet(publicAPI, model, ['slicingMode']);\n\n  vtkView2DProxy.extend(publicAPI, model, initialValues);\n\n  vtkLPSView2DProxy(publicAPI, model);\n}\n\nexport const newInstance = macro.newInstance(extend, 'vtkLPSView2DProxy');\n\nexport default { newInstance, extend };\n","import macro from '@kitware/vtk.js/macro';\n\nimport vtkSliceRepresentationProxy from '@kitware/vtk.js/Proxy/Representations/SliceRepresentationProxy';\n\nconst SLICE_MODE_MAP = {\n  X: 'I',\n  Y: 'J',\n  Z: 'K',\n  I: 'I',\n  J: 'J',\n  K: 'K',\n};\n\nfunction vtkIJKSliceRepresentationProxy(publicAPI, model) {\n  model.classHierarchy.push('vtkIJKSliceRepresentationProxy');\n\n  const superClass = { ...publicAPI };\n\n  // pretend XYZ slicing is actually just IJK.\n  publicAPI.setSlicingMode = (modeString) => {\n    return superClass.setSlicingMode(SLICE_MODE_MAP[modeString]);\n  };\n}\n\n// ----------------------------------------------------------------------------\n// Object factory\n// ----------------------------------------------------------------------------\n\nconst DEFAULT_VALUES = {};\n\n// ----------------------------------------------------------------------------\n\nexport function extend(publicAPI, model, initialValues = {}) {\n  Object.assign(model, DEFAULT_VALUES, initialValues);\n\n  // Object methods\n  vtkSliceRepresentationProxy.extend(publicAPI, model);\n\n  macro.proxyPropertyMapping(publicAPI, model, {\n    opacity: { modelKey: 'property', property: 'opacity' },\n  });\n\n  // Object specific methods\n  vtkIJKSliceRepresentationProxy(publicAPI, model);\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(\n  extend,\n  'vtkIJKSliceRepresentationProxy'\n);\n\n// ----------------------------------------------------------------------------\n\nexport default { newInstance, extend };\n","import macro from '@kitware/vtk.js/macro';\nimport vtkColorTransferFunction from '@kitware/vtk.js/Rendering/Core/ColorTransferFunction';\nimport vtkPiecewiseFunction from '@kitware/vtk.js/Common/DataModel/PiecewiseFunction';\nimport ImagePropertyConstants from '@kitware/vtk.js/Rendering/Core/ImageProperty/Constants';\n\nimport vtkIJKSliceRepresentationProxy from '../IJKSliceRepresentationProxy';\n\nconst { InterpolationType } = ImagePropertyConstants;\n\n// ----------------------------------------------------------------------------\n// vtkLabelMapSliceRepProxy methods\n// ----------------------------------------------------------------------------\n\nfunction vtkLabelMapSliceRepProxy(publicAPI, model) {\n  // Set our className\n  model.classHierarchy.push('vtkLabelMapSliceRepProxy');\n\n  let labelMapSub = null;\n\n  // needed for vtk.js >= 23.0.0\n  model.property.setUseLookupTableScalarRange(true);\n  model.property.setInterpolationType(InterpolationType.NEAREST);\n  model.mapper.setRelativeCoincidentTopologyPolygonOffsetParameters(-2, -2);\n\n  let cachedColorMap = null;\n\n  function updateTransferFunctions(labelmap) {\n    const colorMap = labelmap.getColorMap();\n    if (colorMap === cachedColorMap) {\n      return;\n    }\n    // Cache the colormap using ref equality. This will\n    // avoid updating the colormap unnecessarily.\n    cachedColorMap = colorMap;\n\n    const cfun = vtkColorTransferFunction.newInstance();\n    const ofun = vtkPiecewiseFunction.newInstance();\n\n    Object.keys(colorMap).forEach((label) => {\n      const l = Number(label);\n      cfun.addRGBPoint(l, ...colorMap[label].slice(0, 3).map((c) => c / 255));\n      ofun.addPoint(l, colorMap[label][3] / 255);\n    });\n\n    model.property.setRGBTransferFunction(cfun);\n    model.property.setScalarOpacity(ofun);\n  }\n\n  function setInputData(labelmap) {\n    if (labelMapSub) {\n      labelMapSub.unsubscribe();\n      labelMapSub = null;\n    }\n\n    if (labelmap) {\n      labelMapSub = labelmap.onModified(() =>\n        updateTransferFunctions(labelmap)\n      );\n      updateTransferFunctions(labelmap);\n    }\n  }\n\n  // override because we manage our own color/opacity functions\n  publicAPI.setColorBy = () => {};\n\n  publicAPI.delete = macro.chain(publicAPI.delete, () => {\n    if (labelMapSub) {\n      labelMapSub.unsubscribe();\n      labelMapSub = null;\n    }\n  });\n\n  // Keep things updated\n  model.sourceDependencies.push({ setInputData });\n}\n\n// ----------------------------------------------------------------------------\n// Object factory\n// ----------------------------------------------------------------------------\n\nconst DEFAULT_VALUES = {};\n\n// ----------------------------------------------------------------------------\n\nexport function extend(publicAPI, model, initialValues = {}) {\n  Object.assign(model, DEFAULT_VALUES, initialValues);\n\n  // Object methods\n  vtkIJKSliceRepresentationProxy.extend(publicAPI, model);\n\n  // Object specific methods\n  vtkLabelMapSliceRepProxy(publicAPI, model);\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(\n  extend,\n  'vtkLabelMapSliceRepProxy'\n);\n\n// ----------------------------------------------------------------------------\n\nexport default { newInstance, extend };\n","import vtkLookupTableProxy from '@kitware/vtk.js/Proxy/Core/LookupTableProxy';\nimport vtkPiecewiseFunctionProxy from '@kitware/vtk.js/Proxy/Core/PiecewiseFunctionProxy';\n\nimport vtkSourceProxy from '@kitware/vtk.js/Proxy/Core/SourceProxy';\n\nimport vtkVolumeRepresentationProxy from '@kitware/vtk.js/Proxy/Representations/VolumeRepresentationProxy';\nimport vtkGeometryRepresentationProxy from '@kitware/vtk.js/Proxy/Representations/GeometryRepresentationProxy';\n\nimport vtkLPSView3DProxy from '@/src/vtk/LPSView3DProxy';\nimport vtkLPSView2DProxy from '@/src/vtk/LPSView2DProxy';\nimport vtkIJKSliceRepresentationProxy from '@/src/vtk/IJKSliceRepresentationProxy';\nimport vtkLabelMapSliceRepProxy from '@/src/vtk/LabelMapSliceRepProxy';\n\nfunction createProxyDefinition(\n  classFactory,\n  ui = [],\n  links = [],\n  definitionOptions = {},\n  props = {}\n) {\n  return {\n    class: classFactory,\n    options: { links, ui, ...definitionOptions },\n    props,\n  };\n}\n\nfunction createDefaultView(classFactory, options = [], props = {}) {\n  return createProxyDefinition(classFactory, [], [], options, props);\n}\n\n// ----------------------------------------------------------------------------\n\nexport default {\n  definitions: {\n    Proxy: {\n      LookupTable: createProxyDefinition(vtkLookupTableProxy, [], [], {\n        presetName: 'Default (Cool to Warm)',\n      }),\n      PiecewiseFunction: createProxyDefinition(vtkPiecewiseFunctionProxy),\n    },\n    Sources: {\n      TrivialProducer: createProxyDefinition(vtkSourceProxy),\n    },\n    Representations: {\n      ImageSlice: createProxyDefinition(vtkIJKSliceRepresentationProxy),\n      LabelMapSlice: createProxyDefinition(vtkLabelMapSliceRepProxy),\n      Volume: createProxyDefinition(vtkVolumeRepresentationProxy),\n      Geometry: createProxyDefinition(vtkGeometryRepresentationProxy),\n    },\n    Views: {\n      View3D: createDefaultView(vtkLPSView3DProxy),\n      View2D: createDefaultView(vtkLPSView2DProxy),\n    },\n  },\n  representations: {\n    View3D: {\n      vtkImageData: { name: 'Volume' },\n      vtkPolyData: { name: 'Geometry' },\n    },\n    View2D: {\n      vtkImageData: { name: 'ImageSlice' },\n      vtkLabelMap: { name: 'LabelMapSlice' },\n    },\n  },\n};\n","import vtkPolyData from '@kitware/vtk.js/Common/DataModel/PolyData';\nimport vtkActor2D from '@kitware/vtk.js/Rendering/Core/Actor2D';\nimport vtkContextRepresentation from '@kitware/vtk.js/Widgets/Representations/ContextRepresentation';\nimport vtkWidgetRepresentation from '@kitware/vtk.js/Widgets/Representations/WidgetRepresentation';\nimport macro from '@kitware/vtk.js/macros';\nimport vtkMapper2D from '@kitware/vtk.js/Rendering/Core/Mapper2D';\nimport vtkCoordinate from '@kitware/vtk.js/Rendering/Core/Coordinate';\nimport { Coordinate } from '@kitware/vtk.js/Rendering/Core/Coordinate/Constants';\nimport { Representation } from '@kitware/vtk.js/Rendering/Core/Property/Constants';\nimport { DisplayLocation } from '@kitware/vtk.js/Rendering/Core/Property2D/Constants';\nimport { vec3 } from 'gl-matrix';\n\nfunction generateContour({ stencil, location, slicingIndex, indexToWorld }) {\n  const [xdim, ydim] = stencil.size;\n  const xoffset = Math.floor((xdim - 1) / 2);\n  const yoffset = Math.floor((ydim - 1) / 2);\n\n  // grid of corner points (top-left to bottom-right)\n  const gridxdim = xdim + 1;\n  const gridydim = ydim + 1;\n\n  const vertices = []; // arr of 3-tuples\n  const lines = []; // arr of 2-tuples of vertex indices\n\n  // maps grid x/y to vertex index\n  const vertexMap = {};\n  const getOrCreateVertexIndex = (x, y) => {\n    const key = `${x},${y}`;\n    if (key in vertexMap) {\n      return vertexMap[key];\n    }\n\n    const indexCoords = [...location].map((val) => Math.round(val));\n    if (slicingIndex === 0) {\n      indexCoords[1] += x - xoffset - 0.5;\n      indexCoords[2] += y - yoffset - 0.5;\n    } else if (slicingIndex === 1) {\n      indexCoords[0] += x - xoffset - 0.5;\n      indexCoords[2] += y - yoffset - 0.5;\n    } else if (slicingIndex === 2) {\n      indexCoords[0] += x - xoffset - 0.5;\n      indexCoords[1] += y - yoffset - 0.5;\n    }\n\n    // get the grid point x/y's actual vertex in world space\n    // since grid x/y represents the top-left of the actual pixel\n    // at x/y, the true continuous index value of the vertex\n    // is x-0.5/y-0.5.\n\n    const worldCoords = [];\n    vec3.transformMat4(worldCoords, indexCoords, indexToWorld);\n    vertices.push(worldCoords);\n\n    const index = vertices.length - 1;\n    vertexMap[key] = index;\n    return index;\n  };\n\n  const getStampPixelAt = (x, y) => {\n    if (x < 0 || x >= xdim) return 0;\n    if (y < 0 || y >= ydim) return 0;\n    return stencil.pixels[y * xdim + x] || 0;\n  };\n\n  for (let gy = 0; gy < gridydim; gy++) {\n    for (let gx = 0; gx < gridxdim; gx++) {\n      // evaluate point to see if it needs inclusion\n      // by looking at all 4 pixels that share this point\n      // as a corner.\n      // if all empty or all filled, the current point is\n      // not used in the contour.\n      const count =\n        getStampPixelAt(gx, gy) +\n        getStampPixelAt(gx - 1, gy) +\n        getStampPixelAt(gx, gy - 1) +\n        getStampPixelAt(gx - 1, gy - 1);\n\n      if (count > 0 && count < 4) {\n        const v0 = getOrCreateVertexIndex(gx, gy);\n\n        // now do line check. We look at the east and south lines.\n        // east first\n        if (getStampPixelAt(gx, gy) !== getStampPixelAt(gx, gy - 1)) {\n          const v1 = getOrCreateVertexIndex(gx + 1, gy);\n          lines.push([v0, v1]);\n        }\n        // south next\n        if (getStampPixelAt(gx, gy) !== getStampPixelAt(gx - 1, gy)) {\n          const v1 = getOrCreateVertexIndex(gx, gy + 1);\n          lines.push([v0, v1]);\n        }\n      }\n    }\n  }\n\n  return {\n    points: new Float32Array(vertices.flat()),\n    lines: new Uint16Array(lines.map(([v0, v1]) => [2, v0, v1]).flat()),\n  };\n}\n\nfunction vtkPaintBrushContextRepresentation(publicAPI, model) {\n  model.classHierarchy.push('vtkPaintBrushContextRepresentation');\n\n  model.internalPolyData = vtkPolyData.newInstance({ mtime: 0 });\n  model.internalArrays = {\n    points: model.internalPolyData.getPoints(),\n    lines: model.internalPolyData.getLines(),\n  };\n\n  model.pipelines = {\n    brush: {\n      source: publicAPI,\n      mapper: vtkMapper2D.newInstance({\n        transformCoordinate: vtkCoordinate.newInstance({\n          coordinateSystem: Coordinate.WORLD,\n        }),\n      }),\n      actor: vtkActor2D.newInstance({ pickable: false, parentProp: publicAPI }),\n    },\n  };\n\n  const actorProperty = model.pipelines.brush.actor.getProperty();\n  actorProperty.setLineWidth(2);\n  actorProperty.setColor([1, 0, 0]);\n  actorProperty.setDisplayLocation(DisplayLocation.FOREGROUND);\n  actorProperty.setRepresentation(Representation.SURFACE);\n\n  vtkWidgetRepresentation.connectPipeline(model.pipelines.brush);\n\n  publicAPI.addActor(model.pipelines.brush.actor);\n\n  publicAPI.requestData = (inData, outData) => {\n    const widgetState = inData[0];\n\n    const stencil = widgetState.getStencil();\n    const brush = widgetState.getBrush();\n    const { indexToWorld, worldToIndex } = model;\n\n    if (stencil && brush.getOrigin()) {\n      const location = [];\n      vec3.transformMat4(location, brush.getOrigin(), worldToIndex);\n\n      const contour = generateContour({\n        stencil,\n        location,\n        slicingIndex: model.slicingIndex,\n        indexToWorld,\n      });\n\n      const { points, lines } = model.internalArrays;\n      points.setData(contour.points);\n      lines.setData(contour.lines);\n\n      model.internalPolyData.modified();\n    }\n    outData[0] = model.internalPolyData;\n  };\n}\n\nconst DEFAULT_VALUES = {\n  defaultScale: 1,\n  drawBorder: false,\n  drawFace: true,\n  worldToIndex: null,\n  indexToWorld: null,\n  slicingIndex: 0,\n};\n\n// ----------------------------------------------------------------------------\n\nexport function extend(publicAPI, model, initialValues = {}) {\n  Object.assign(model, DEFAULT_VALUES, initialValues);\n  vtkContextRepresentation.extend(publicAPI, model, initialValues);\n  macro.setGet(publicAPI, model, [\n    'slicingIndex',\n    'indexToWorld',\n    'worldToIndex',\n  ]);\n  macro.get(publicAPI, model, ['mapper', 'actor']);\n  vtkPaintBrushContextRepresentation(publicAPI, model);\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(\n  extend,\n  'vtkPaintBrushContextRepresentation'\n);\n\nexport default { newInstance, extend };\n","import macro from '@kitware/vtk.js/macro';\n\nexport function shouldIgnoreEvent(e: any) {\n  return e.altKey || e.controlKey || e.shiftKey;\n}\n\nexport default function widgetBehavior(publicAPI: any, model: any) {\n  model.classHierarchy.push('vtkPaintWidgetProp');\n\n  // support setting per-view widget manipulators\n  macro.setGet(publicAPI, model, ['manipulator']);\n\n  let isPainting = false;\n\n  /**\n   * Starts painting\n   */\n  publicAPI.handleLeftButtonPress = (eventData: any) => {\n    if (!model.manipulator || shouldIgnoreEvent(eventData)) {\n      return macro.VOID;\n    }\n\n    const worldCoords = model.manipulator.handleEvent(\n      eventData,\n      model._apiSpecificRenderWindow\n    );\n\n    if (!worldCoords) {\n      return macro.VOID;\n    }\n\n    const brush = model.widgetState.getBrush();\n    brush.setOrigin(...worldCoords);\n\n    isPainting = true;\n    publicAPI.invokeStartInteractionEvent();\n    return macro.EVENT_ABORT;\n  };\n\n  /**\n   * Paints\n   */\n  publicAPI.handleMouseMove = (eventData: any) => {\n    if (shouldIgnoreEvent(eventData)) {\n      return macro.VOID;\n    }\n\n    const worldCoords = model.manipulator.handleEvent(\n      eventData,\n      model._apiSpecificRenderWindow\n    );\n\n    if (!worldCoords) {\n      return macro.VOID;\n    }\n\n    const brush = model.widgetState.getBrush();\n    brush.setOrigin(...worldCoords);\n\n    if (isPainting) {\n      publicAPI.invokeInteractionEvent();\n    }\n    return macro.EVENT_ABORT;\n  };\n\n  /**\n   * Finishes paint\n   */\n  publicAPI.handleLeftButtonRelease = (eventData: any) => {\n    if (!isPainting || shouldIgnoreEvent(eventData)) {\n      return macro.VOID;\n    }\n\n    isPainting = false;\n    publicAPI.invokeEndInteractionEvent();\n    return macro.EVENT_ABORT;\n  };\n\n  publicAPI.handleMouseWheel = () => {\n    if (isPainting) {\n      return macro.EVENT_ABORT;\n    }\n    return macro.VOID;\n  };\n\n  publicAPI.grabFocus = () => {\n    if (!model.hasFocus) {\n      model.hasFocus = true;\n      model._interactor.requestAnimation(publicAPI);\n    }\n  };\n\n  publicAPI.loseFocus = () => {\n    if (model.hasFocus) {\n      model._interactor.cancelAnimation(publicAPI);\n    }\n    model.hasFocus = false;\n    // model._widgetManager.enablePicking();\n    // model._interactor.render();\n  };\n}\n","import { IBrushStencil } from '@/src/core/tools/paint/brush';\nimport type { Vector3 } from '@kitware/vtk.js/types';\nimport vtkStateBuilder from '@kitware/vtk.js/Widgets/Core/StateBuilder';\nimport vtkWidgetState from '@kitware/vtk.js/Widgets/Core/WidgetState';\n\nexport interface PaintPointWidgetState extends vtkWidgetState {\n  setOrigin(origin: Vector3 | null): boolean;\n  getOrigin(): Vector3 | null;\n  setScale1(scale: number): boolean;\n  getScale1(): number;\n  setVisible(visible: boolean): boolean;\n  getVisible(): boolean;\n  setColor(color: number): boolean;\n  getColor(): number;\n}\n\nexport interface PaintWidgetState extends vtkWidgetState {\n  getBrush(): PaintPointWidgetState;\n  getStencil(): IBrushStencil;\n  setStencil(stencil: IBrushStencil): boolean;\n}\n\nexport default function generateState() {\n  return vtkStateBuilder\n    .createBuilder()\n    .addStateFromMixin({\n      labels: ['brush'],\n      name: 'brush',\n      mixins: ['origin', 'scale1', 'visible', 'color'],\n      initialValues: {\n        scale1: 1,\n        origin: null,\n        visible: true,\n      },\n    })\n    .addField({\n      name: 'stencil',\n      initialValue: null,\n    })\n    .build() as PaintWidgetState;\n}\n","import macro from '@kitware/vtk.js/macro';\nimport vtkAbstractWidgetFactory from '@kitware/vtk.js/Widgets/Core/AbstractWidgetFactory';\nimport vtkPlanePointManipulator from '@kitware/vtk.js/Widgets/Manipulators/PlaneManipulator';\nimport vtkPaintBrushContextRepresentation from '@/src/vtk/PaintBrushContextRepresentation';\n\nimport widgetBehavior from './behavior';\nimport stateGenerator from './state';\n\nexport { shouldIgnoreEvent } from './behavior';\n\n// ----------------------------------------------------------------------------\n// Factory\n// ----------------------------------------------------------------------------\n\nfunction vtkPaintWidget(publicAPI, model) {\n  model.classHierarchy.push('vtkPaintWidget');\n\n  model.methodsToLink = ['slicingIndex', 'indexToWorld', 'worldToIndex'];\n\n  publicAPI.getRepresentationsForViewType = () => [\n    {\n      builder: vtkPaintBrushContextRepresentation,\n      labels: ['brush'],\n    },\n  ];\n\n  // Default manipulator\n  model.manipulator = vtkPlanePointManipulator.newInstance();\n}\n\n// ----------------------------------------------------------------------------\n\nconst DEFAULT_VALUES = {};\n\n// ----------------------------------------------------------------------------\n\nexport function extend(publicAPI, model, initialValues = {}) {\n  Object.assign(model, DEFAULT_VALUES, initialValues);\n\n  vtkAbstractWidgetFactory.extend(publicAPI, model, {\n    ...initialValues,\n    behavior: widgetBehavior,\n    widgetState: stateGenerator(),\n  });\n  macro.get(publicAPI, model, ['manipulator']);\n\n  vtkPaintWidget(publicAPI, model);\n}\n\n// ----------------------------------------------------------------------------\n\nexport const newInstance = macro.newInstance(extend, 'vtkPaintWidget');\n\n// ----------------------------------------------------------------------------\n\nexport default { newInstance, extend };\n","import type { Vector2 } from '@kitware/vtk.js/types';\nimport { IBrushStencil, IPaintBrush } from './brush';\n\n// Adapted from http://members.chello.at/easyfilter/bresenham.html\nfunction rasterizeEllipse(xdiam: number, ydiam: number) {\n  const buffer = new Uint8Array(xdiam * ydiam);\n\n  const putPixel = (x: number, y: number) => {\n    buffer[x + y * xdiam] = 1;\n  };\n\n  const blitLine = (x0: number, x1: number, y: number) => {\n    const start = y * xdiam + x0;\n    const end = start + (x1 - x0 + 1);\n    buffer.fill(1, start, end);\n  };\n\n  let x0 = 0;\n  let y0 = 0;\n  let x1 = xdiam - 1;\n  let y1 = ydiam - 1;\n\n  let a = x1;\n  let b = y1;\n  // eslint-disable-next-line no-bitwise\n  const b1 = b & 1;\n  let dx = 4 * (1 - a) * b * b;\n  let dy = 4 * (b1 + 1) * a * a;\n  let err = dx + dy + b1 * a * a;\n  let e2 = 0;\n\n  y0 += Math.floor((b + 1) / 2);\n  y1 = y0 - b1;\n  a *= 8 * a;\n  b *= 8 * b;\n  do {\n    blitLine(x0, x1, y0);\n    blitLine(x0, x1, y1);\n    e2 = 2 * err;\n    if (e2 <= dy) {\n      y0++;\n      y1--;\n      dy += a;\n      err += dy;\n    }\n    if (e2 >= dx || 2 * err > dy) {\n      x0++;\n      x1--;\n      dx += b;\n      err += dx;\n    }\n  } while (x0 <= x1);\n  while (y0 - y1 < ydiam) {\n    putPixel(x0 - 1, y0);\n    putPixel(x1 + 1, y0++);\n    putPixel(x0 - 1, y1);\n    putPixel(x1 + 1, y1--);\n  }\n\n  return buffer;\n}\n\nexport default class EllipsePaintBrush implements IPaintBrush {\n  private size: number = 1;\n  private scale: Vector2 = [1, 1];\n  private cachedStencil!: IBrushStencil;\n\n  constructor() {\n    this.recomputeStencil();\n  }\n\n  setSize(size: number) {\n    this.size = Math.max(0, size);\n    this.recomputeStencil();\n  }\n\n  setScale(scale: Vector2) {\n    this.scale = scale;\n    this.recomputeStencil();\n  }\n\n  private recomputeStencil() {\n    const scaledSize = [\n      Math.ceil(this.size * this.scale[0]),\n      Math.ceil(this.size * this.scale[1]),\n    ] as Vector2;\n    this.cachedStencil = {\n      size: scaledSize,\n      pixels: rasterizeEllipse(scaledSize[0], scaledSize[1]),\n    };\n  }\n\n  getStencil() {\n    return this.cachedStencil;\n  }\n}\n","import vtkLabelMap from '@/src/vtk/LabelMap';\nimport vtkPaintWidget from '@/src/vtk/PaintWidget';\nimport type { Vector2 } from '@kitware/vtk.js/types';\nimport { vec3 } from 'gl-matrix';\nimport { IPaintBrush } from './brush';\nimport EllipsePaintBrush from './ellipse-brush';\n\nexport default class PaintTool {\n  readonly factory: vtkPaintWidget;\n  private brush: IPaintBrush;\n  private brushValue: number;\n\n  constructor() {\n    this.factory = vtkPaintWidget.newInstance();\n    this.brush = new EllipsePaintBrush();\n    this.brushValue = 1;\n  }\n\n  private updateWidgetStencil() {\n    // use unscaled stencil for paint outline\n    const stencil = this.brush.getStencil();\n    const widgetState = this.factory.getWidgetState();\n    widgetState.setStencil(stencil);\n  }\n\n  setBrushSize(size: number) {\n    this.brush.setSize(size);\n    this.updateWidgetStencil();\n  }\n\n  setBrushScale(scale: Vector2) {\n    this.brush.setScale(scale);\n    this.updateWidgetStencil();\n  }\n\n  setBrushValue(value: number) {\n    this.brushValue = value;\n  }\n\n  /**\n   * Adds paint to a labelmap.\n   *\n   * If endPoint is specified, then linearly interpolates the brush\n   * from the start to the end.\n   *\n   * Assumption: startPoint and endPoint are on the same slice axis.\n   *\n   * @param labelmap paint in this labelmap\n   * @param sliceAxis Which index-space axis to paint on (0, 1, or 2).\n   * @param startPoint start point\n   * @param endPoint ending point (optional)\n   */\n  paintLabelmap(\n    labelmap: vtkLabelMap,\n    sliceAxis: 0 | 1 | 2,\n    startPoint: vec3,\n    endPoint?: vec3\n  ) {\n    const stencil = this.brush.getStencil();\n\n    const start = [\n      // transforms + floating point errors can make zero values occasionally\n      // turn into really tiny negative values\n      ...startPoint.map((val) => Math.round(val)),\n    ];\n    // Assumption: startPoint and endPoint are on the same slice axis.\n    const ijkSlice = start[sliceAxis];\n    start.splice(sliceAxis, 1);\n\n    let end = [...start];\n    if (endPoint) {\n      end = [...endPoint.map((val) => Math.round(val))];\n      end.splice(sliceAxis, 1);\n    }\n\n    const labelmapPixels = labelmap.getPointData().getScalars().getData();\n    const labelmapDims = labelmap.getDimensions();\n    const jStride = labelmapDims[0];\n    const kStride = labelmapDims[0] * labelmapDims[1];\n\n    const isInBounds = (point: number[]) =>\n      point[0] >= 0 &&\n      point[1] >= 0 &&\n      point[2] >= 0 &&\n      point[0] < labelmapDims[0] &&\n      point[1] < labelmapDims[1] &&\n      point[2] < labelmapDims[2];\n\n    const { pixels, size } = stencil;\n    const centerX = Math.floor((size[0] - 1) / 2);\n    const centerY = Math.floor((size[1] - 1) / 2);\n\n    const point1 = [...start];\n    const point2 = [...end];\n    const rounded = [0, 0, 0];\n    const curPoint: number[] = [0, 0];\n    for (let y = 0; y < size[1]; y++) {\n      const ydelta = y - centerY;\n      const yoffset = y * size[0];\n      for (let x = 0; x < size[0]; x++) {\n        const xdelta = x - centerX;\n        const pixelOffset = yoffset + x;\n        if (pixels[pixelOffset]) {\n          point1[0] = start[0] + xdelta;\n          point1[1] = start[1] + ydelta;\n          point2[0] = end[0] + xdelta;\n          point2[1] = end[1] + ydelta;\n\n          // line between the two points\n          const dx = point2[0] - point1[0];\n          const dy = point2[1] - point1[1];\n          let steps = Math.abs(Math.abs(dx) > Math.abs(dy) ? dx : dy);\n          const incX = dx / steps;\n          const incY = dy / steps;\n          [curPoint[0], curPoint[1]] = point1;\n          while (steps-- >= 0) {\n            // add slice axis to make a proper 3D index\n            curPoint.splice(sliceAxis, 0, ijkSlice);\n            rounded[0] = Math.round(curPoint[0]);\n            rounded[1] = Math.round(curPoint[1]);\n            rounded[2] = Math.round(curPoint[2]);\n\n            if (isInBounds(rounded)) {\n              const offset =\n                rounded[0] + rounded[1] * jStride + rounded[2] * kStride;\n              labelmapPixels[offset] = this.brushValue;\n            }\n\n            // undo adding the slice axis value\n            curPoint.splice(sliceAxis, 1);\n\n            curPoint[0] += incX;\n            curPoint[1] += incY;\n          }\n        }\n      }\n    }\n\n    labelmap.modified();\n  }\n}\n","import { DICOMIO } from '../io/dicom';\nimport ProxyWrapper from './proxies';\nimport PaintTool from './tools/paint';\n\n/**\n * Pinia plugin for injecting tool services.\n */\nexport function CorePiniaProviderPlugin({\n  paint,\n  proxies,\n  dicomIO,\n}: {\n  paint?: PaintTool;\n  proxies?: ProxyWrapper;\n  dicomIO?: DICOMIO;\n} = {}) {\n  const dependencies = {\n    $paint: paint ?? new PaintTool(),\n    $proxies: proxies,\n    $dicomIO: dicomIO ?? new DICOMIO(),\n  };\n  return () => dependencies;\n}\n","/**\n * document.exitPointerLock is undefined on iOS.\n * - Tested on iOS Safari 15.6.1.\n */\nexport function patchExitPointerLock() {\n  const { exitPointerLock } = document;\n  document.exitPointerLock = () => {\n    try {\n      exitPointerLock?.call(document);\n    } catch (e) {\n      // ignore if undefined\n    }\n  };\n}\n","import 'vue-toastification/dist/index.css';\nimport 'vuetify/lib/styles/main.css';\nimport '@/src/global.css';\n\nimport '@kitware/vtk.js/Rendering/OpenGL/Profiles/Geometry';\nimport '@kitware/vtk.js/Rendering/OpenGL/Profiles/Volume';\nimport '@kitware/vtk.js/Rendering/OpenGL/Profiles/Glyph';\n\nimport { createApp } from 'vue';\nimport VueToast from 'vue-toastification';\nimport { createPinia } from 'pinia';\nimport vtkProxyManager from '@kitware/vtk.js/Proxy/Core/ProxyManager';\nimport vtkMapper from '@kitware/vtk.js/Rendering/Core/Mapper';\nimport vtkImageMapper from '@kitware/vtk.js/Rendering/Core/ImageMapper';\n\nimport App from './components/App.vue';\nimport vuetify from './plugins/vuetify';\nimport { DICOMIO } from './io/dicom';\nimport { FILE_READERS } from './io';\nimport { registerAllReaders } from './io/readers';\nimport proxyConfiguration from './vtk/proxy';\nimport { CorePiniaProviderPlugin } from './core/provider';\nimport ProxyWrapper from './core/proxies';\nimport { patchExitPointerLock } from './utils/hacks';\nimport { init as initErrorReporting } from './utils/errorReporting';\n\n// patches\npatchExitPointerLock();\n\n// Initialize global mapper topologies\n// polys and lines in the front\nvtkMapper.setResolveCoincidentTopologyToPolygonOffset();\nvtkMapper.setResolveCoincidentTopologyPolygonOffsetParameters(-3, -3);\nvtkMapper.setResolveCoincidentTopologyLineOffsetParameters(-3, -3);\n// image poly in the back\nvtkImageMapper.setResolveCoincidentTopologyToPolygonOffset();\nvtkImageMapper.setResolveCoincidentTopologyPolygonOffsetParameters(1, 1);\n\nregisterAllReaders(FILE_READERS);\n\nconst proxyManager = vtkProxyManager.newInstance({ proxyConfiguration });\n\nconst dicomIO = new DICOMIO();\ndicomIO.initialize();\n\nconst pinia = createPinia();\npinia.use(\n  CorePiniaProviderPlugin({\n    proxies: new ProxyWrapper(proxyManager),\n    dicomIO,\n  })\n);\n\nconst app = createApp(App);\n\ninitErrorReporting(app);\n\napp.provide('ProxyManager', proxyManager);\napp.use(pinia);\napp.use(VueToast);\napp.use(vuetify);\napp.mount('#app');\n"],"names":["dirname","path","p","basename","normalize","join","segments","identity","arg","defer","innerResolve","innerReject","resolve","value","reject","reason","res","rej","removeFromArray","arr","el","idx","clampValue","min","max","pick","obj","keys","o","k","partition","predicate","partitioned","val","partitionIndex","ensureDefault","key","records","default_","arrayEquals","a","b","i","arrayEqualsWithComparator","cmp","wrapInArray","maybeArray","formatBytes","bytes","decimals","dm","sizes","roundIfCloseToInteger","eps","EPSILON","rounded","hasKey","remapKeys","keyMap","omit","ensureError","cleanUndefined","cleaned","standardizeColor","color","ctx","START_ID","useIdStore","defineStore","id","LPSAxes","createLPSPoint","createLPSBounds","getAxisBounds","bounds","axis","directions","index","getLPSAxisFromDir","dir","defaultLPSDirections","vec3.fromValues","getLPSDirections","direction","availableCols","availableRows","lpsDirs","bestValue","bestValueLoc","removeIndices","col","colIdx","row","rowIdx","axisVector","vecSign","posVector","c","negVector","Tools","LayoutDirection","DatasetType","DatasetTypeNative","z","LPSAxisDir","Dataset","baseRemoteFileSchema","RemoteFile","LayoutDirectionNative","Layout","Vector3","WindowLevelConfig","SliceConfig","CameraConfig","ColorBy","PiecewiseGaussian","PiecewiseNode","OpacityGaussians","vtkPiecewiseFunctionProxy","OpacityPoints","OpacityNodes","OpacityFunction","ColorTransferFunction","CVRConfig","VolumeColorConfig","BlendConfig","LayersConfig","ViewConfig","ViewType","View","LabelMap","FrameOfReference","AnnotationTool","makeToolEntry","tool","Ruler","Rulers","Rectangle","Rectangles","Crosshairs","ToolsEnumNative","ToolsEnum","Paint","LPSCroppingPlanes","Cropping","ParentToLayers","ManifestSchema","fileToDataSource","file","uriToDataSource","uri","name","remoteFileToDataSource","isRemoteDataSource","ds","getDataSourceName","_a","sources","first","more","serializeDataSource","output","useFileStore","state","dataID","files","serializeData","stateFile","dataIDs","dataType","fileStore","zip","datasets","remoteFiles","remotes","toZip","dataPath","filePath","defaultImageMetadata","mat3.create","vec3.create","mat4.create","useImageStore","imageData","metadata","ANONYMOUS_PATIENT","ANONYMOUS_PATIENT_ID","imageCacheMultiKey","offset","asThumbnail","readDicomTags","dicomIO","useDICOMStore","allFiles","volumeToFiles","volumeKey","volumeDatasetFiles","source","tags","patient","study","volumeInfo","volume","patientKey","studyKey","imageStore","imageID","volumeKeys","sliceIndex","cacheKey","numSlices","volumeFiles","sliceFile","itkImage","NumberOfSlices","middleSlice","forceRebuild","image","vtkITKHelper","existingImageID","useModelStore","polyData","MessageType","MessageType2","useMessageStore","msg","title","opts","details","options","useErrorMessage","message","task","err","makeDICOMSelection","makeImageSelection","getImageID","selection","_exhaustiveCheck","getImage","images","dicoms","getDataID","findImageID","selectionEquals","s1","s2","useDatasetStore","modelStore","dicomStore","primarySelection","ref","primaryImageID","computed","primaryDataset","dataIndex","allDataIDs","getDataProxyByID","setPrimarySelection","sel","serialize","manifest","args","after","logError","error","cur","createPipelineError","input","cause","DoneSentinel","Pipeline","handlers","extraContext","nestedExecutions","execution","terminate","result","invokeHandler","data","doneInvoked","pipelineResult","endOfPipeline","context","out","innerExtra","promise","handler","thrown","ret","innerResults","succeededInner","failedInner","okResult","failedResult","errors","handleDicomFile","dataSource","extra","done","fileSrc","HTTPHandler","url","protocol","URL","progress","response","contentLength","reader","recv","readData","HANDLERS","canFetchUrl","h","fetchFile","cache","blob","fetchJSON","buffer","decoder","downloadUrl","execute","uriSrc","extractFilesFromZip","zipFile","JSZip","promises","paths","relPath","fileName","fileEntry","FILE_EXT_TO_MIME","FILE_EXTENSIONS","MIME_TYPES","ARCHIVE_FILE_TYPES","isArchive","extractArchive","entry","extractArchiveContents","archiveFile","contentsPromise","mapping","fullPath","path.join","extractArchiveTarget","archiveSrc","parent","archiveCache","archiveContents","targetName","path.normalize","targetFile","isAmazonS3Uri","getObjectPublicUrl","bucket","fetchObjectsWithPagination","prefix","onObjectAvailable","client","S3Client","request","paginate","continuationToken","listObjectsCmd","ListObjectsV2Command","extractBucketAndPrefixFromS3Uri","pathname","objectName","getObjectsFromS3","s3Uri","objPrefix","handleAmazonS3","isGoogleCloudStorageUri","extractBucketAndPrefixFromGsUri","getObjectEndpoint","objects","nextToken","page","getObjectsFromGsUri","gsUri","bucketName","handleGoogleCloudStorage","object","FILE_MAGIC_DB","HEAD_CHUNK","prefixEquals","target","getFileMimeFromMagic","head","chunk","mime","header","skip","getFileMimeType","fileType","supportedExt","ext","mimeFromMagic","retypeFile","type","readFileAs","fio","readFileAsArrayBuffer","FILE_READERS","importSingleFile","dataObject","RemoteResource","RemoteDataManifest","readRemoteManifestFile","manifestFile","ab","text","handleRemoteManifest","remote","vtkLabelMap","publicAPI","model","DEFAULT_VALUES","extend","initialValues","vtkImageData","macro","newInstance","vtkLabelMap$1","MRICardiacThumbnail","InitViewIDs","InitViewSpecs","DefaultViewSpec","Layouts","layouts","layout","LABELMAP_PALETTE","SAMPLE_DATA","TOOL_COLORS","RULER_LABEL_DEFAULTS","RECTANGLE_LABEL_DEFAULTS","DECREMENT_LABEL_KEY","INCREMENT_LABEL_KEY","DEFAULT_PRESET_BY_MODALITY","PromiseWorker","worker","transferables","wrappedMsg","deferred","ev","runAsyncVTKReader","readerName","vtk","runAsyncVTKWriter","writerName","dataSet","stlReader","vtiReader","vtpReader","vtiWriter","LabelmapArrayType","createLabelmapFromImage","points","labelmap","vtkDataArray","toLabelMap","useLabelmapStore","labelMaps","labelMap","labelPath","serializedData","stateFiles","dataIDMap","labelmapIDMap","labelMapObj","runWasm","pipeline","outputs","InterfaceTypes","numberOfWorkers","aImage","splits","splitsArg","tasks","split","taskArgs","num","inputs","imageSharedBufferOrCopy","workerPool","WorkerPool","runPipeline","results","imageSplits","r","pipelineOutput","stackImages","compareProps","compareImageSpaces","imageA","imageB","resample","fixed","moving","size","spacing","origin","assertNeverDataSelection","getID","toDataSelectionKey","toDataSelectionFromKey","useLayersStore","parentToLayers","layerImages","_addLayer","parentKey","parentImage","sourceImage","vtkBoundingBox","addLayer","deleteLayer","layers","layerToDelete","layer","getLayers","dataKey","getLayer","layerID","deleteSelection","deleteKey","layerStore","selectionKey","deserialize","remapSelection","parentToLayersSerialized","sourceSelectionKeys","sourceKey","getImageSpatialExtent","lpsOrientation","extent","useCurrentImage","dataStore","layersStore","currentImageID","volumeToImageID","currentImageMetadata","currentImageData","currentImageExtent","isImageLoading","currentLayers","clampRangeToBounds","range","convertCropBoundsToVTKPlane","cropBounds","lowerUpper","indexToWorld","orientation","axisIndex","vec3.transformMat4","neg","normal","vtkPlane","croppingPlanesEqual","a1","a2","p1","p2","vec3.equals","useCropStore","reactive","getComputedVTKPlanes","unref","clampCroppingPlanes","planes","lpsBounds","setCropping","setCroppingForAxis","resetCropping","tools","cropping","newImageID","readonly","generateState","vtkStateBuilder","clampPointToBounds","point","widgetBehavior","isDragging","ignoreKey","e","callData","worldCoordsOfPointer","handle","worldToIndex","indexCoordsOfPointer","worldOrigin","indexOrigin","vtkCrosshairsWidget","stateGenerator","viewType","ViewTypes","center","vtkPlanePointManipulator","vtkAbstractWidgetFactory","vtkCrosshairsWidget$1","patchDoubleKeyRecord","record","k1","k2","patch","deleteSecondKey","getDoubleKeyRecord","serializeViewConfigV2","viewConfigs","viewConfigStateKey","dataset","views","view","config","viewConfig","configForData","createViewConfigSerializer","defaultSliceConfig","useViewSliceStore","configs","getConfig","viewID","updateConfig","resetSlice","removeView","removeData","defaultWindowLevelConfig","useWindowingStore","syncAcrossViews","setSyncAcrossViews","yn","syncWindowLevel","srcViewID","srcDataID","resetWindowLevel","width","level","computeWorldToDisplay","xyz","renderer","_b","x","y","normalizeMouseEventPosition","canvas","scaleX","scaleY","intersectMouseEventWithPlane","position","intersectDisplayWithPlane","worldToSVG","coords","height","getCSSCoordinatesFromEvent","eventData","pokedRenderer","bbox","_c","getShiftedOpacityFromPreset","presetName","effectiveRange","shift","preset","vtkColorMaps","xmin","xmax","getOpacityFunctionFromPreset","getColorFunctionRangeFromPreset","AbsoluteRange","RGBPoints","registerPresets","presets","MedicalPresets","GroupedPresets","DEFAULT_PRESET","group","MODALITY_TO_PRESET","getPreset","Modality","defaultLayersConfig","useLayerColoringStore","createUpdateFunc","transform","update","updatedConfig","updateColorBy","updateColorTransferFunction","updateOpacityFunction","updateBlendConfig","setColorPreset","imageDataRange","ctRange","opFunc","resetToDefault","scalars","useViewCameraStore","DEFAULT_AMBIENT","DEFAULT_DIFFUSE","DEFAULT_SPECULAR","getPresetFromImageModality","volKey","defaultVolumeColorConfig","useVolumeColoringStore","updateCVRParameters","resetToDefaultColoring","useViewConfigStore","viewSliceStore","windowingStore","layerColoringStore","viewCameraStore","volumeColoringStore","newDataID","useViewStore","layoutsToProcess","item","viewConfigStore","spec","props","viewSpec","useCrosshairsToolStore","factory","widgetState","active","imagePosition","viewStore","currentViewIDs","getWidgetFactory","setPosition","pos","watch","indexPos","sliceConfig","slice","xDim","yDim","zDim","imageBounds","inflate","activateTool","deactivateTool","crosshairs","DEFAULT_BRUSH_SIZE","DEFAULT_BRUSH_VALUE","usePaintToolStore","activeLabelmapID","brushSize","brushValue","strokePoints","labelmapOpacity","isActive","activeLabelmap","selectOrCreateLabelmap","labelmapStore","found","parentID","setBrushSize","setBrushValue","setLabelmapOpacity","opacity","doPaintStroke","lastIndex","lastPoint","prevPoint","setSliceAxis","scale","startStroke","indexPoint","vec3.clone","placeStrokePoint","endStroke","paint","tmp","frameOfReferenceToImageSliceAndAxis","frame","epsilon","allowNonIntegralSlice","allowOutOfBoundsSlice","planeNormal","planeOrigin","dimensions","Left","Right","Posterior","Anterior","Superior","Inferior","labelDefault","useLabels","newLabelDefault","labels","activeLabel","setActiveLabel","addLabel","label","deleteLabel","labelIDs","updateLabel","defaultLabels","clearDefaultLabels","mergeLabel","clearDefault","labelName","sameLabelName","existingName","existingID","newLabels","makeAnnotationToolDefaults","useAnnotationTool","toolDefaults","initialLabels","toolIDs","toolByID","byID","makePropsFromLabel","labelProps","addTool","removeTool","updateTool","propsFromLabel","jumpToTool","toolID","toolImageFrame","relevantViewIDs","viewDir","rest","serialized","labelIDMap","newID","rulerDefaults","useRulerStore","rulerIDs","rulerByID","rulers","addRuler","updateRuler","removeRuler","jumpToRuler","serializeTool","deserializeTool","lengthByID","lengths","firstPoint","secondPoint","distance2BetweenPoints","rectangleDefaults","useRectangleStore","toolStoreProps","createReferencePlane","tmp3d","tmpMat3","transform2dTo3d","pt2d","refPlane","_out","vec3.set","invertMat4","m","minv","mat4.invert","getInverse","transform3dTo2d","pt3d","vec2.create","inv","vec2.set","referencePlaneToFrame","mat3.fromMat4","vec3.transformMat3","vec3.normalize","SliceAxisTransforms","mat4.fromValues","getReferencePlaneFromSlice","sliceAxis","t","mat4.fromTranslation","mat4.mul","ContourToolMode","makeContourDefaults","useContourStore","selectedContourID","mode","selectContour","setMode","toolMode","getStore","setupTool","store","teardownTool","useToolStore","rulerStore","rectangleStore","crosshairsStore","paintStore","cropStore","MANIFEST","MANIFEST_VERSION","datasetStore","labelStore","toolStore","isStateFile","typedFile","doneWithDataSource","updateFileMimeType","src","resolveUriSource","processParentIfNoFile","resolveArchiveMember","getDataSourcesForDataset","stateFileContents","inStateFile","restoreDatasets","datasetFiles","stateDatasetFiles","datasetFile","stateIDToStoreID","resolvePipeline","datasetDataSources","dicomSources","importResults","restoreStateFile","manifests","restOfStateFile","dataFile","selectedID","dataSelection","Color","Label","RulerLabel","RectangleLabel","Config","readConfigFile","configFile","applyConfig","labelsIfUndefined","toolLabels","handleConfig","convertSuccessResultToDataSelection","toMeaningfulErrorString","strThrown","unhandledResource","importDataSources","dataSources","middleware","extractArchiveTargetFromCache","importContext","dicomDataSource","dicomResult","_sfc_main","classSpec","_openBlock","_createBlock","_component_v_btn","_mergeProps","$options","_ctx","_createVNode","_component_v_icon","$props","_component_v_tooltip","_createElementVNode","_renderSlot","manageVTKSubscription","subscription","onUnmounted","useResizeToFit","camera","initialValue","resizeToFit","trackResizeToFit","cachedCameraInfo","parallelScale","ignoreResizeToFitTracking","cb","resetResizeToFitTracking","getYOffsetFromTransform","matStr","values","v","entries","handleStyles","newSlice","frac","_createElementBlock","_cache","$event","_hoisted_1","_normalizeStyle","useResizeObserver","targetElRef","callback","observer","targetEl","prevTarget","onBeforeUnmount","useVTKCallback","listener","cleanup","isRef","watchEffect","toOrderedLabels","vec","useOrientationLabels","top","left","bottom","right","updateAxes","vup","vdir","vright","vec3.cross","vbottom","vleft","useCameraOrientation","viewDirection","viewUp","imageMetadataRef","orientationMatrix","lpsDirections","cameraDirVec","cameraUpVec","computeStep","WindowLevelToolComponent","defineComponent","toRefs","viewProxy","windowConfigDefaults","wlConfig","wwRange","wlRange","vertVal","horizVal","rangeManipulator","vtkMouseRangeManipulator","curViewProxy","oldViewProxy","updateManipulator","vertRange","horizRange","WindowLevelTool","_sfc_main$Z","sliceConfigDefault","sliceRange","scrollVal","_sfc_main$Y","intStyle","manipulators","updateStyle","style","newManipulators","oldManipulators","newOptions","opt","curIntStyle","oldIntStyle","PanTool","toolOptions","MouseManipulatorTool","vtkMouseCameraTrackballPanManipulator","ZoomTool","vtkMouseCameraTrackballZoomToMouseManipulator","InteractionState","shouldIgnoreEvent","draggingState","coord","originalSetInteractionState","changed","activeWidget","worldCoords","intState","PIXEL_SIZE","watchStore","getter","cached","unsubscribe","originalDelete","_createPointState","visible","vtkWidgetState","visibleMixin","scale1Mixin","getRuler","createPointState","PointsLabel","watchState","vtkRulerWidgetState","defaultValues","_createRulerWidgetState","createRulerWidgetState","vtkRulerWidget","vtkSphereHandleRepresentation","second","vtkRulerWidget$1","updatePlaneManipulatorFor2DView","manipulator","imageMetadata","_sfc_main$X","point1","point2","textOffset","length","updatePoints","viewRenderer","pt1","pt2","point2D","textProperties","containerEl","inject","ToolContainer","_sfc_render","$setup","$data","_createCommentVNode","_hoisted_2","_hoisted_3","_sfc_main$W","RulerSVG2D","emit","rulerId","widgetManager","currentSlice","isPlacing","ruler","widgetFactory","widget","onMounted","placing","widget_","isPlaced","rightClickSub","vtkPlaneManipulator","usePointVisibility","pointState","updateVisibility","watchOnce","firstPointVisible","secondPointVisible","_withDirectives","_component_RulerSVG2D","_sfc_main$V","RulerWidget2D","storeToRefs","isToolActive","viewAxis","placingRulerID","prevId","placingTool","onRulerPlaced","getCurrentFrameOfReference","lpsIdx","rulerID","contextMenu","openContextMenu","displayXY","deleteRulerFromContextMenu","doesRulerFrameMatchViewAxis","rulerAxis","curImageID","_Fragment","_renderList","_component_RulerWidget2D","_withCtx","_component_v_list","_component_v_list_item","_component_v_list_item_title","vtkRectangleWidget","vtkRectangleWidget$1","_sfc_main$U","rectangle","firstX","firstY","secondX","secondY","_d","useStore","vtkWidgetFactory","SVG2DComponent","RectangleSVG2D","_sfc_main$T","stringToolId","toolId","_component_SVG2DComponent","_resolveComponent","useActiveToolStore","_sfc_main$S","RectangleWidget2D","activeToolStore","placingToolID","onToolPlaced","deleteToolFromContextMenu","doesToolFrameMatchViewAxis","toolAxis","_component_RectangleWidget2D","PICKING_LINE_WIDTH","DEFAULT_LINE_WIDTH","SELECTED_LINE_WIDTH","vtkContourRepresentation","vtkPolyData","vtkMapper","vtkActor","vtkWidgetRepresentation","allocatePolyDataArrays","contour","polyLine","numPoints","finalized","closedAddition","ptOffset","cellOffset","inData","outData","updateActorVisibility","renderingType","RenderingTypes","ctxVisible","handleVisible","newDefault","vtkContourRepresentation$1","Mode","getEventWorldPosition","interpolateCurve","degree","interPointSpacing","closed","clamped","numOriginalPoints","closedCurve","prevPt","arcLength","pt","vec2.dist","vec2.copy","knots","npts","remapT","dt","ipt","bspline","freehandBehavior","original","isActiveMode","resetModeInteraction","newCurve","DeselectIgnoreModes","selectBehavior","moveOrigin","origPolyLine","delta","translateContour","to","vec2.sub","addModuloN","calcMidpoint","v1","v2","nudgePoints","nudgeCircle","radius","nudgeRadius2","nudgeVec","dist2","vec3.sqrDist","vec3.sub","vec3.scale","vec3.add","adjustPoints","minPointSpacing","maxPointSpacing","minSpacing2","maxSpacing2","curVec","nextVec","midpoint","intermediate","curIdx","crossed","stop","newIdx","nextIdx","vec2.sqrDist","tdelta","newPoints","vec2.lerp","nudgeContour","referencePlane","closestPointAlongContour","closestIndex","bestDist2","d2","RADIUS_GAP_PERCENT","nudgeBehavior","doNudge","closestPtIndex","distance","vec3.dist","up","horiz","circleContextState","pointPlacingBehavior","updateLastPoint","last","dropLastPoint","point2d","vtkErrorMacro","vtkImageMarchingSquares","cValues","ids","pixelScalars","pixelPts","edgeLocator","vtkEdgeLocator","j","dims","s","iInBounds","jInBounds","i1InBounds","j1InBounds","cVal","lines","CASE_MASK","pId","pixelLines","vtkCaseTable","eid","edgeVerts","x0Offset","x00","x01","x1Offset","x10","x11","pBuffer","lBuffer","cv","polydata","vtkImageMarchingSquares$1","FILLED","VISITED","EMPTY","getSliceDimensions","baseDimensions","sliceDims","createBinaryMask","baseImage","iDim","jDim","pixels","dataArray","ijToIjk","ij","ijk","ijkToIj","directDistance2D","createImagePixelAccessor","kDim","ijSkip","iSkip","thresholdSlice","maskImage","seedPoint","thresholdRadius","maxDistance","distanceFunction","basePixels","maskPixels","seedPointIj","seedValue","minValue","maxValue","queue","pixel","di","dj","maskToBoundaryLines","mask","msquares","vtkContourLoopExtractionCtor","visited","pd","startLineId","startPtId","loopPoints","lineId","lastPtId","terminated","numInserted","cellPointIds","lineCell","inPoints","hullInputPoints","convexHullPoints","hull","outPoints","outLines","outIdx","loops","inLines","li","endPtId","largestIndex","longestLoop","loop","vtkContourLoopExtraction","cloneArray","vtkTransformPolyDataToPlaneCtor","inPd","vtkTransformPolyDataToPlane","MERGE_CONTOURS_KEY","CONVEX_HULL_CONTOURS_KEY","THRESHOLD_LINE_WIDTH","createActorPipeline","actor","mapper","property","thresholdBehavior","resetVisualizingContour","addVisualizingContour","removeVisualizingContour","commitCurrentContours","drawingContour","loops2d","loopCells","maxCellLoc","loc","curImageData","curSliceAxis","curSlice","startPointWorld","startPointIjk","startPointIj","renderCurrentContours","needsRender","indexCoords","roundVector","ijCoord","threshRadius","ijkDims","ijDims","diag","rangeWidth","adjustedThreshold","rgbaToHexa","rgba","comp","hexaToRGBA","hexa","createCircleContextState","scale3","newCircleContextStateInstance","vtkContourWidgetState","getContour","toRaw","pl","createContourState","vtkContourWidget","vtkCircleContextRepresentation","vtkContourWidget$1","ModeMap","_sfc_main$R","viewId","contourId","drawing","isSelected","widgetMode","selected","viewAxisIndex","AutoAddDrawingContourModes","fequals","_sfc_main$Q","ContourWidget2D","contourStore","drawingContourID","isContourInCurrentView","frameOfReference","axisAndSlice","checkImageID","checkSlice","contours","commitDrawingContour","addDrawingContour","clearDrawingContour","contourID","onContourFinalized","getCurrentReferencePlane","onContourSelected","onKeyDown","onContextMenu","deleteFromContextMenu","contextMenuLabels","labelID","setLabelFromContextMenu","_component_ContourWidget2D","_withModifiers","_component_v_menu","_component_v_radio","_sfc_main$P","widgetManagerRef","viewProxyRef","widgetRef","worldPointToIndex","worldPoint","slicingIndex","subs","_sfc_main$O","PaintWidget2D","_component_PaintWidget2D","useSceneBuilder","sceneIDs","baseImageRep","labelmapReps","layerReps","modelReps","allRepresentations","reps","oldReps","rep","usePersistCameraConfig","toPersist","persistCameraConfig","persist","persistFunc","blockPersistingCameraConfig","func","restoreCameraConfig","cameraConfig","focalPoint","directionOfProjection","_sfc_main$N","_sfc_main$M","position2D","_sfc_main$L","CrosshairsWidget2D","CrosshairSVG2D","isVisible","crosshairsSlice","_component_CrosshairsWidget2D","_component_CrosshairSVG2D","ViewProxyType","ProxyWrapper","proxyManager","deleteProxy","proxy","dataProxy","useViewProxy","container","setContainer","curContainer","onViewProxyModified","useMountedViewProxy","mounted","updateMounted","useViewProxyMounted","useViewProxyUnmounted","prev","useWidgetManager","vtkWidgetManager","CaptureOn","curWM","oldWM","useCurrentSlice","useVTKViewContainer","useVTKMultiWorldToDisplay","displayCoords","ren","disp","cameraOnModified","useVTKMultiWorldToSVG","xy","_sfc_main$K","cursor","grabLineEl","focusWidth","down","hover","computeCropLines","cropAxis","cropPlanes","boundary","viewIDVal","cropAxisVal","cropPlanesVal","boundaryVal","sliceInfo","perpAxis","ax","cropRange","perpRange","perpBoundary","sliceCropRange","outOfBounds","getLineSegments","startEdge","startCrop","endCrop","endEdge","cropLinesToSVGDisplay","cropLines","worldPoints","indexLPSPoint","indexPt","svgPoints","useDragging","mouseEventToLPSPoint","getCropEdgePos","setCropEdgePos","activeAxis","activeEdge","initialPointerIndex","initialCrop","selectedCropEdge","initialPoint","_sfc_main$J","Crop2DLineHandle","imageExtent","currentSlicingAxis","inPlaneAxes","ax1","ax2","ax1Lines","ax2Lines","ax1SVGLines","ax2SVGLines","onPointerDown","onPointerMove","onPointerUp","lower","upper","newPlanes","_component_crop_2D_line_handle","isValidCroppingPlanes","lpsPlanesEqual","_sfc_main$I","VTKThreeViewWidgetManager","croppingPlanes","vtkImageCroppingWidget","wm","oldWm","applyPlanes","lpsPlanes","dirs","planesFromStore","_sfc_main$H","Crop2D","Crop3D","_component_crop_3D","_component_crop_2D","defaultKey","withProxyManager","pxm","useProxyManager","SLICE_OFFSET_KEYS","_sfc_main$G","SliceSlider","ViewOverlayGrid","SliceScrollTool","RulerTool","RectangleTool","PaintTool","CrosshairsTool","CropTool","ContourTool","vtkContainerRef","curImageMetadata","sliceConfigDefaults","sliceMin","sliceMax","newValue","windowWidth","windowLevel","dicomInfo","studyInfo","patientID","studyID","studyDescription","seriesNumber","seriesDescription","sliceDomain","ijkIndex","setSlice","setViewProxyContainer","onBeforeMount","viewID_","event","sliceOffset","onKeyStroke","toolContainer","provide","VTKTwoViewWidgetManager","labelmapIDs","layerIDs","resizeToFitScene","lookAxis","upAxis","dimsWithSpacing","d","resetCamera","topLabel","leftLabel","lRep","lmRep","layersConfigs","layerIndex","layerConfig","colorBys","transferFunctions","opacityFunctions","blendConfigs","layerRep","colorBy","transferFunction","opacityFunction","blendConfig","arrayName","location","ctFunc","lut","LookupTableProxyMode","pwf","opacityPoints","_withScopeId","n","_pushScopeId","_popScopeId","_hoisted_4","_hoisted_5","_hoisted_7","_hoisted_10","_component_slice_slider","_normalizeClass","_component_pan_tool","_component_zoom_tool","_component_slice_scroll_tool","_component_window_level_tool","_component_contour_tool","_component_ruler_tool","_component_rectangle_tool","_component_paint_tool","_component_crosshairs_tool","_component_crop_tool","_component_view_overlay_grid","_hoisted_6","_toDisplayString","_hoisted_8","_hoisted_9","_component_v_divider","_Transition","_hoisted_11","_component_v_progress_circular","isViewAnimating","isAnimating","onStartAnimation","onEndAnimation","useCvrEffect","imageRep","cvrParams","repMapper","computedWithControl","cvrEnabled","enabled","animating","requestRender","volumeCenter","volumeBounds","lightFollowsCamera","lightFollowsCamera_","light","volumeQuality","volume_","image_","volumeQuality_","spatialDiagonal","vec3.length","sampleDistance","samplesPerRay","ambient","diffuse","specular","ambient_","diffuse_","specular_","getDiagonalLength","dataRange","useVolumetricScatteringBlending","volumetricScatteringBlending","useVsb","vsb","useLocalAmbientOcclusion","laoKernelSize","laoKernelRadius","useLao","kernelSize","kernelRadius","useColoringEffect","colorTransferFunction","colorBy_","colorFunc","opacityFunc","_sfc_main$F","nextTick","volumeColorConfig","oldPlanes","plane","TYPE_TO_COMPONENT","VtkTwoView","VtkThreeView","_sfc_main$E","viewSpecs","flexFlow","viewIDToSpecs","_component_layout_grid","_resolveDynamicComponent","disabled","zIndex","colorAsStyle","colorAsClass","scrimClasses","classes","scrimStyles","styles","containerStyles","_sfc_main$C","PersistentOverlay","_component_v_hover","isHovering","_component_v_card","_component_v_container","_component_v_row","_component_v_col","_component_v_checkbox","_component_v_img","_component_persistent_overlay","_sfc_main$B","ImageListCard","status","loaded","clearLoadedStatus","downloadSample","sample","percent","sampleFile","loadResult","isDone","isError","isLoaded","_component_image_list_card","_createSlots","useDicomMetaStore","info","instanceInfo","instance","instanceKey","studies","parseTag","alpha","parseInstance","withNamedTags","tag","fileCounter","toFile","makeClient","dicomWebRoot","api","searchForStudies","retrieveStudyMetadata","retrieveSeriesMetadata","fetchSeries","progressCallback","fetchInstanceThumbnail","thumbnail","arrayBufferView","LEVELS","parseUrl","deepDicomWebUrl","sansSlash","parentIDs","idObj","dicomLevel","urlLevel","dicomID","pathsToSlice","allPaths","DICOM_WEB_URL_PARAM","isDownloadable","fetchFunctions","levelToFetchKey","levelToMetaKey","useDicomWebStore","VITE_DICOM_WEB_NAME","VITE_DICOM_WEB_URL","hostName","useLocalStorage","host","hostConfig","vtkURLExtract","parsedURL","cleanHost","isConfigured","fetchVolumeThumbnail","middleInstance","fetchPatientMeta","studyMeta","seriesMeta","fetchVolumesMeta","volumeMeta","instanceMeta","volumes","downloadVolume","seriesInstanceUID","studyInstanceUID","seriesInfo","total","fetchError","hasFetchedPatients","fetchInitialDicoms","deepestLevel","fetchFunc","urlIDs","fetchOptions","fetchedMetas","urlMetaIDs","fetchedMeta","seriesID","fetchInitialDicomsOnce","loadedVolumeKey","ItemGroupProvider","_sfc_main$A","slots","modelValue","mandatory","equalsTest","internalValue","_sfc_main$z","itemGroup","select","toggle","ThumbnailSlice","ThumbnailSlice2","scalarImageToImageData","scaleMin","scaleMax","im","arr32","factor","byte","generateThumbnail","whichSlice","sliceData","createVTKImageThumbnailer","resizeCanvas","resizeContext","resizeWidth","resizeHeight","useMultiSelection","allItems","selectedAll","selectedSome","imageCacheKey","_sfc_main$y","ItemGroup","GroupableItem","nonDICOMImages","layerImageIDs","loadedLayerImageIDs","selectedImageID","layerAdded","layerLoaded","loading","layerable","thumbnails","thumbnailer","imageIDs","canvasIM","imageURI","aspectRatio","idLookup","removeSelection","_vShow","_component_item_group","_component_groupable_item","dicomCacheKey","itkImageToURI","itkBuf","generateDICOMThumbnail","_sfc_main$x","layerVolumes","layerVolumeKeys","loadedLayerVolumeKeys","selectedVolumeKey","thumbnailCache","thumb","encodedImage","lookup","_component_v_spacer","_component_v_card_text","_sfc_main$w","PatientStudyVolumeBrowser","selectedSeries","selPatient","patientStudies","studyVolumes","studyKeys","panels","_component_v_expansion_panel","_component_v_expansion_panel_title","_component_v_expansion_panel_text","_component_patient_study_volume_browser","percentDone","_sfc_main$v","dicomWebStore","isFetching","volumeInstances","rows","columns","guard","downloadDicom","_createTextVNode","_sfc_main$u","StudyVolumeDicomWeb","_component_v_expansion_panels","_component_study_volume_dicom_web","_sfc_main$t","PatientDetails","dicomWeb","dicomWebMeta","_component_patient_details","SAMPLE_DATA_KEY","ANONYMOUS_DATA_KEY","DICOM_WEB_KEY","_sfc_main$s","SampleDataBrowser","ImageDataBrowser","PatientBrowser","PatientList","patients","hasAnonymousImages","showAnonymous","patients_","showPatients","_component_patient_browser","_sfc_main$r","remove","jumpTo","_normalizeProps","_guardReactiveProps","_component_v_list_item_subtitle","_sfc_main$q","rectStore","rects","rect","_sfc_main$p","lm","colorLocal","activeLabelIndex","editingLabel","createLabel","editDialog","display","useDisplay","mobile","RectangleControls","RulerControls","ContourControls","_sfc_main$i","MeasurementsRulerList","MeasurementsRectangleList","LabelmapList","ToolControls","_component_tool_controls","_component_measurements_ruler_list","_component_measurements_rectangle_list","_component_labelmap_list","Modules","DataBrowser","AnnotationsModule","autoSwitchToAnnotationsTools","_sfc_main$h","selectedModuleIndex","newTool","_component_v_tabs","_component_v_window","mod","_component_v_window_item","readAllDirEntries","dirEntry","allEntries","entryToFile","readAllFiles","toProcess","fileEntries","types","_hoisted_19","_imports_0","VolViewFullLogo","_hoisted_12","_hoisted_14","_hoisted_15","_hoisted_16","_hoisted_17","_hoisted_18","_hoisted_20","_hoisted_21","_hoisted_22","_component_v_card_title","_component_vol_view_full_logo","_hoisted_13","_component_v_badge","_hoisted_23","_hoisted_24","_hoisted_25","convertToSwatches","palette","hexToValue","swatches","hex","_sfc_main$d","brushColor","setBrushColor","op","_component_v_slider","_component_v_text_field","_component_v_color_picker","_sfc_main$c","ToolButton","showLeft","menuOn","enableMenu","on","_component_tool_button","_sfc_main$b","_sfc_main$a","MenuToolButton","PaintControls","CropControls","noCurrentImage","currentTool","paintMenu","cropMenu","_component_menu_tool_button","MessageTypeClass","_sfc_main$9","_sfc_main$8","MessageItem","messageStore","messages","showErrors","showWarnings","showInfo","filteredMessages","show","deleteItem","messageID","_component_message_item","toast","createToastInterface","useToast","_sfc_main$7","TIMEOUT","_sfc_main$6","toasts","makeToastOptions","msgID","msgLookup","toastMethod","showDetailsButton","MessageNotificationContent","_sfc_main$5","hostAtStart","VITE_SENTRY_DSN","LOCAL_STORAGE_KEY","errorReportingConfigured","init","app","Sentry.init","Sentry.Replay","disable","Sentry.close","useErrorReporting","disableReportingStorage","disableReporting","_sfc_main$4","theme","useTheme","ThemeStorageKey","dark","DarkTheme","isDark","LightTheme","errorReportingStore","DicomWebSettings","_component_v_switch","DEFAULT_FILENAME","_sfc_main$2","_","valid","saving","saveSession","saveAs","validFileName","_component_v_form","_component_v_card_actions","useGlobalErrorHook","onError","ProxyManagerEvent","ProxyManagerEvent2","onProxyManagerEvent","proxySubs","action","proxyId","useWebGLWatchdog","watchdogs","reportError","useThrottleFn","Messages","useEventListener","useAppLoadingNotifications","loadingCount","toastID","resetState","_setError","startLoading","stopLoading","TYPE","fn","applyLabelOffset","toolToStore","nextLabel","useKeyboardShortcuts","ToolStrip","_component_VtkTwoView","_component_ToolStrip","loadFiles","setError","succeeded","errored","errorMessages","errResult","firstError","failedError","loadRemoteFilesFromURLParams","params","urls","names","LayoutGrid","DragAndDrop","AboutBox","ModulePanel","MessageCenter","MessageNotifications","VolViewLogo","Settings","SaveSession","LayoutGridDemo","runAsLoading","layoutName","currentLayout","openFiles","fileEl","userPromptFiles","urlParams","hasData","messageCount","messageBadgeColor","saveDialog","saveUrl","saveHappening","handleSave","showErrorReporting","_component_drag_and_drop","dragHover","_component_v_app","_component_v_navigation_drawer","_component_module_panel","_component_v_main","_component_about_box","_component_v_dialog","_component_message_center","_component_message_notifications","_component_settings","_component_save_session","sanitizeFileName","sanitizeFile","DICOMIO","module","readDICOMTags","fd","volumeToFileIndexes","fileIndexes","fileIndex","tagsArgs","tagValues","seriesFiles","readImageDICOMFileSeries","ITK_IMAGE_MIME_TYPES","extensionToImageIO","vtkITKImageReader","readImageArrayBuffer","itkReader","fileBuffer","registerAllReaders","readerMap","commonViewCustomizations","delayedRender","devicePixelRatio","blocking","timeout","vtkLPSView3DProxy","vtkViewProxy","vtkLPSView3DProxy$1","vtkLPSView2DProxy","superClass","boundsToUse","count","viewUpAxis","w","bw","bh","viewAspect","boundsAspect","vtkView2DProxy","vtkLPSView2DProxy$1","SLICE_MODE_MAP","vtkIJKSliceRepresentationProxy","modeString","vtkSliceRepresentationProxy","vtkIJKSliceRepresentationProxy$1","InterpolationType","ImagePropertyConstants","vtkLabelMapSliceRepProxy","labelMapSub","cachedColorMap","updateTransferFunctions","colorMap","cfun","vtkColorTransferFunction","ofun","vtkPiecewiseFunction","l","setInputData","vtkLabelMapSliceRepProxy$1","createProxyDefinition","classFactory","ui","links","definitionOptions","createDefaultView","proxyConfiguration","vtkLookupTableProxy","vtkSourceProxy","vtkVolumeRepresentationProxy","vtkGeometryRepresentationProxy","generateContour","stencil","xdim","ydim","xoffset","yoffset","gridxdim","gridydim","vertices","vertexMap","getOrCreateVertexIndex","getStampPixelAt","gy","gx","v0","vtkPaintBrushContextRepresentation","vtkMapper2D","vtkCoordinate","Coordinate","vtkActor2D","actorProperty","DisplayLocation","Representation","brush","vtkContextRepresentation","vtkPaintBrushContextRepresentation$1","isPainting","vtkPaintWidget","vtkPaintWidget$1","rasterizeEllipse","xdiam","ydiam","putPixel","blitLine","x0","x1","start","end","y0","y1","b1","dx","dy","e2","EllipsePaintBrush","scaledSize","startPoint","endPoint","ijkSlice","labelmapPixels","labelmapDims","jStride","kStride","isInBounds","centerX","centerY","curPoint","ydelta","xdelta","pixelOffset","steps","incX","incY","CorePiniaProviderPlugin","proxies","dependencies","patchExitPointerLock","exitPointerLock","vtkImageMapper","vtkProxyManager","pinia","createPinia","createApp","App","initErrorReporting","VueToast","vuetify"],"mappings":"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"}